# Comparing `tmp/scoamp-0.3.4-py3-none-any.whl.zip` & `tmp/scoamp-0.4.0a0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,22 +1,24 @@
-Zip file size: 23840 bytes, number of entries: 20
--rw-r--r--  2.0 unx       22 b- defN 23-Jul-12 07:02 scoamp/__init__.py
--rw-r--r--  2.0 unx     6668 b- defN 23-Jul-12 07:02 scoamp/api.py
--rw-r--r--  2.0 unx    10676 b- defN 23-Jul-12 07:02 scoamp/toolkit.py
--rw-r--r--  2.0 unx      486 b- defN 23-Jul-12 07:02 scoamp/commands/__init__.py
--rw-r--r--  2.0 unx     4687 b- defN 23-Jul-12 07:02 scoamp/commands/api.py
--rw-r--r--  2.0 unx     7581 b- defN 23-Jul-12 07:02 scoamp/commands/lfs.py
--rw-rw-rw-  2.0 unx     2135 b- defN 23-Jul-12 07:02 scoamp/schema/public-model-meta.json
--rw-r--r--  2.0 unx        0 b- defN 23-Jul-12 07:02 scoamp/utils/__init__.py
--rw-r--r--  2.0 unx     5080 b- defN 23-Jul-12 07:02 scoamp/utils/api_utils.py
--rw-r--r--  2.0 unx     1692 b- defN 23-Jul-12 07:02 scoamp/utils/error.py
--rw-r--r--  2.0 unx     5150 b- defN 23-Jul-12 07:02 scoamp/utils/helper.py
--rw-r--r--  2.0 unx      405 b- defN 23-Jul-12 07:02 scoamp/utils/logger.py
--rw-r--r--  2.0 unx        0 b- defN 23-Jul-12 07:02 tests/__init__.py
--rw-r--r--  2.0 unx     9110 b- defN 23-Jul-12 07:02 tests/test_utils_helper.py
--rw-rw-rw-  2.0 unx    11334 b- defN 23-Jul-12 07:02 scoamp-0.3.4.dist-info/LICENSE
--rw-r--r--  2.0 unx     1234 b- defN 23-Jul-12 07:02 scoamp-0.3.4.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Jul-12 07:02 scoamp-0.3.4.dist-info/WHEEL
--rw-r--r--  2.0 unx       48 b- defN 23-Jul-12 07:02 scoamp-0.3.4.dist-info/entry_points.txt
--rw-r--r--  2.0 unx       13 b- defN 23-Jul-12 07:02 scoamp-0.3.4.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     1577 b- defN 23-Jul-12 07:02 scoamp-0.3.4.dist-info/RECORD
-20 files, 67990 bytes uncompressed, 21288 bytes compressed:  68.7%
+Zip file size: 26473 bytes, number of entries: 22
+-rw-r--r--  2.0 unx       23 b- defN 23-Jul-13 11:33 scoamp/__init__.py
+-rw-r--r--  2.0 unx     7991 b- defN 23-Jul-14 11:03 scoamp/api.py
+-rw-r--r--  2.0 unx     2212 b- defN 23-Jul-13 12:34 scoamp/globals.py
+-rw-r--r--  2.0 unx    14506 b- defN 23-Jul-14 10:52 scoamp/toolkit.py
+-rw-r--r--  2.0 unx      486 b- defN 23-Jun-06 04:20 scoamp/commands/__init__.py
+-rw-r--r--  2.0 unx     4341 b- defN 23-Jul-14 11:06 scoamp/commands/api.py
+-rw-r--r--  2.0 unx     7581 b- defN 23-Jun-06 04:20 scoamp/commands/lfs.py
+-rw-r--r--  2.0 unx     2135 b- defN 23-Jun-06 04:20 scoamp/schema/public-model-meta.json
+-rw-r--r--  2.0 unx        0 b- defN 23-Jun-06 04:20 scoamp/utils/__init__.py
+-rw-r--r--  2.0 unx     5080 b- defN 23-Jun-27 08:29 scoamp/utils/api_utils.py
+-rw-r--r--  2.0 unx      501 b- defN 23-Jul-13 08:00 scoamp/utils/decrypt.py
+-rw-r--r--  2.0 unx     1763 b- defN 23-Jul-14 07:36 scoamp/utils/error.py
+-rw-r--r--  2.0 unx     5150 b- defN 23-Jul-13 07:42 scoamp/utils/helper.py
+-rw-r--r--  2.0 unx      405 b- defN 23-Jun-06 04:20 scoamp/utils/logger.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Jun-27 08:29 tests/__init__.py
+-rw-r--r--  2.0 unx     9110 b- defN 23-Jun-27 08:29 tests/test_utils_helper.py
+-rw-r--r--  2.0 unx    11334 b- defN 23-Jul-14 11:17 scoamp-0.4.0a0.dist-info/LICENSE
+-rw-r--r--  2.0 unx     1239 b- defN 23-Jul-14 11:17 scoamp-0.4.0a0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jul-14 11:17 scoamp-0.4.0a0.dist-info/WHEEL
+-rw-r--r--  2.0 unx       47 b- defN 23-Jul-14 11:17 scoamp-0.4.0a0.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx       13 b- defN 23-Jul-14 11:17 scoamp-0.4.0a0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     1742 b- defN 23-Jul-14 11:17 scoamp-0.4.0a0.dist-info/RECORD
+22 files, 75751 bytes uncompressed, 23665 bytes compressed:  68.8%
```

## zipnote {}

```diff
@@ -1,13 +1,16 @@
 Filename: scoamp/__init__.py
 Comment: 
 
 Filename: scoamp/api.py
 Comment: 
 
+Filename: scoamp/globals.py
+Comment: 
+
 Filename: scoamp/toolkit.py
 Comment: 
 
 Filename: scoamp/commands/__init__.py
 Comment: 
 
 Filename: scoamp/commands/api.py
@@ -21,14 +24,17 @@
 
 Filename: scoamp/utils/__init__.py
 Comment: 
 
 Filename: scoamp/utils/api_utils.py
 Comment: 
 
+Filename: scoamp/utils/decrypt.py
+Comment: 
+
 Filename: scoamp/utils/error.py
 Comment: 
 
 Filename: scoamp/utils/helper.py
 Comment: 
 
 Filename: scoamp/utils/logger.py
@@ -36,26 +42,26 @@
 
 Filename: tests/__init__.py
 Comment: 
 
 Filename: tests/test_utils_helper.py
 Comment: 
 
-Filename: scoamp-0.3.4.dist-info/LICENSE
+Filename: scoamp-0.4.0a0.dist-info/LICENSE
 Comment: 
 
-Filename: scoamp-0.3.4.dist-info/METADATA
+Filename: scoamp-0.4.0a0.dist-info/METADATA
 Comment: 
 
-Filename: scoamp-0.3.4.dist-info/WHEEL
+Filename: scoamp-0.4.0a0.dist-info/WHEEL
 Comment: 
 
-Filename: scoamp-0.3.4.dist-info/entry_points.txt
+Filename: scoamp-0.4.0a0.dist-info/entry_points.txt
 Comment: 
 
-Filename: scoamp-0.3.4.dist-info/top_level.txt
+Filename: scoamp-0.4.0a0.dist-info/top_level.txt
 Comment: 
 
-Filename: scoamp-0.3.4.dist-info/RECORD
+Filename: scoamp-0.4.0a0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## scoamp/__init__.py

```diff
@@ -1 +1 @@
-__version__ = '0.3.4'
+__version__ = '0.4.0a0'
```

## scoamp/api.py

```diff
@@ -1,13 +1,14 @@
 import json
 from typing import Dict, List, Optional, Union
 #from requests.adapters import Retry
 
-from scoamp.utils.api_utils import DEFAULT_ENDPOINT, PAGE_MAX, amp_api_path, make_request, get_user_agent, load_auth
-from scoamp.utils.error import amp_raise_for_status
+from scoamp.utils.api_utils import DEFAULT_ENDPOINT, PAGE_MAX, amp_api_path, make_request, get_user_agent
+from scoamp.utils.decrypt import decrypt_aes256gcm
+from scoamp.utils.error import amp_raise_for_status, ScoampBaseError
 
 class AmpApi:
     def __init__(
         self,
         access_key: Optional[str] = None,
         secret_key: Optional[str] = None,
         endpoint: Optional[str] = None,
@@ -49,22 +50,68 @@
         self.endpoint = endpoint
 
     def set_auth_info(self, access_key: str, secret_key: str):
         assert access_key and secret_key, "'access_key' and 'secret_key' should not be empty"
         self.ak = access_key
         self.sk = secret_key
 
+    def get_model_space_info(self, model_space_name: str) -> dict:
+        method = 'GET'
+        rmh_endpoint = self.endpoint.replace('amp', 'management')
+        url = rmh_endpoint + '/rmh/v1/resources'
+        params = {
+            'filter': f'resource_type="studio.amp.v1.modelSpace" AND name="{model_space_name}"',
+        }
+
+        resp = make_request(self.ak, self.sk, method, url, params=params, headers=self._amp_headers())
+        amp_raise_for_status(resp)
+
+        rj = resp.json()
+        if rj['total_size'] < 1:
+            return {}
+        else:
+            return rj['resources'][0]
+ 
+
     def get_user_info(self) -> dict:
         method = 'GET'
         url = self._amp_url('/v1/userSecret')
         params = {}
 
         resp = make_request(self.ak, self.sk, method, url, params=params, headers=self._amp_headers())
         amp_raise_for_status(resp)
         return resp.json()
+    
+    def get_user_gitinfo(self) -> dict:
+        method = 'GET'
+        url = self._amp_url('/v1/user/gitinfo')
+        params = {
+            'access_key': self.ak,
+        }
+
+        resp = make_request(self.ak, self.sk, method, url, params=params, headers=self._amp_headers())
+        amp_raise_for_status(resp)
+        r = resp.json()
+        enc_secret = r.pop('git_user_secret_encrypted')
+        r['git_user_secret'] = decrypt_aes256gcm(self.sk, enc_secret)
+        return r
+ 
+    def create_user_model(self, model_id: str, model_space_name: str) -> dict:
+        ms = self.get_model_space_info(model_space_name)
+        if not ms:
+            raise ScoampBaseError(f'invalid model space: {model_space_name}')
+        rid = ms['rid']
+
+        method = 'POST'
+        url = self._amp_url(f"/v1/{rid}/models/create")
+        json_body = {"name": model_id, "display_name": model_id}
+
+        resp = make_request(self.ak, self.sk, method, url, json=json_body, headers=self._amp_headers())
+        amp_raise_for_status(resp)
+        return resp.json()
 
     def list_user_models(self, n: int, s: Optional[str]) -> dict:
         if n == 0:
             return None
 
         method = 'GET'
         url = self._amp_url('/v1/modelSpaces/models')
@@ -154,27 +201,7 @@
         if resume_size:
             headers['Range'] = f'bytes={resume_size}-'
 
         resp = make_request(self.ak, self.sk, method, url, params=params, headers=headers,
                             stream=True, timeout=timeout)
         amp_raise_for_status(resp)
         return resp
-
-
-global_api = AmpApi()
-
-def set_endpoint(ep: str) -> None:
-    global_api.set_endpoint(ep)
-
-def set_auth_info(access_key: str, secret_key: str) -> None:
-    global_api.set_auth_info(access_key, secret_key)
-
-
-# try to load local cached auth info
-# TODO switch endpoint
-try:
-    auth = load_auth()
-    set_endpoint(auth.endpoint)
-    set_auth_info(auth.access_key, auth.secret_key)
-except:
-    ...
-
```

## scoamp/toolkit.py

```diff
@@ -1,21 +1,27 @@
 import os
 import io
 import re
 import tempfile
+import subprocess
 from functools import partial
 from contextlib import contextmanager
 from typing import Optional, Generator, BinaryIO, Union, List
 from pathlib import Path
 from filelock import FileLock
 from requests.adapters import Retry
 from tqdm import tqdm
+from urllib.parse import urlparse, urlunparse
 
-from scoamp.api import global_api as api
-from scoamp.utils.error import FileDownloadError
+from scoamp.globals import global_api as api
+from scoamp.globals import Environment
+from scoamp.utils.error import FileDownloadError, APIError
+from scoamp.utils.logger import get_logger
+
+logger = get_logger(__name__)
 
 def model_file_list(
     model_id: str,
     *,
     is_public: bool = False,
     revision: Optional[str] = None,
 ) -> list:
@@ -228,15 +234,15 @@
 
     An alternative would be to clone the repo but this requires git and git-lfs to be installed and properly
     configured. It is also not possible to filter which files to download when cloning a repository using git.
 
     Args:
         model_id (`str`):
             model_id
-        local_dir (`str` or `Path`, *optional*:
+        local_dir (`str` or `Path`, *optional*):
             the downloaded files will be placed under this directory
         is_public (`bool`, *optional*):
             whether public model, default to user model
         revision (`str`, *optional*):
             An optional Git revision id which can be a branch name, a tag, or a
             commit hash.
         force_download (`bool`, *optional*, defaults to `False`):
@@ -262,15 +268,15 @@
 
     </Tip>
     """
     if not model_id:
         raise ValueError('model_id shoud not be empty')
 
     if not local_dir:
-        raise ValueError('local_dir shoud not be specified')
+        raise ValueError('local_dir shoud be specified')
     local_dir_path = Path(local_dir).expanduser()
     if not local_dir_path.exists():
         raise ValueError(f"local directory '{local_dir}' not exists")
 
     if not ignore_patterns:
         ignore_patterns = []
     elif isinstance(ignore_patterns, str):
@@ -297,8 +303,103 @@
             is_public=is_public,
             revision=revision,
             local_dir=local_dir,
             force_download=force_download,
             resume_download=resume_download,
             remote_validate=False,
         )
-    return local_dir
+    return local_dir
+
+
+def create_and_upload_model(
+    model_id: str,
+    local_dir: str,
+    model_space_name: str,
+    allow_exist: bool = False,
+):
+    """Create a new model and upload files from local directory
+
+    `local_dir` should contains all the model files, and must not have a '.git' directory in it (not a git repo).
+    This method will use 'git' and 'git-lfs' to init the local dir, and push to remote server, then de-init by remove '.git'.
+
+    Args:
+        model_id (`str`):
+            model id/name
+        local_dir (`str` or `Path`, *optional*):
+            all model files should be placed under this directory
+        model_space_name (`str`):
+            model space name in AMP platform
+        allow_exist (`bool`):
+            if remote repo with given 'model_id' has been create before and no files uploaded yet, reuse it.
+
+    Returns:
+        remote repo path
+    """
+    if not local_dir:
+        raise ValueError('local_dir shoud be specified')
+    local_dir_path = Path(local_dir).expanduser().absolute()
+    if not local_dir_path.exists():
+        raise FileNotFoundError(f"local directory '{local_dir}' not exists")
+    
+    if len(os.listdir(local_dir_path)) == 0:
+        raise ValueError(f"local_dir '{local_dir}' is empty")
+    
+    # ensure local dir not a git repo
+    for fn in ['.git', '.gitattributes']:
+        if (local_dir_path / fn).exists():
+            raise FileExistsError(f"local dir should not contains '{fn}'")
+
+    # check git/lfs install
+    Environment.check_git_and_lfs()
+
+    # check whether model with given 'model_id' exists at amp
+    try:
+        model_info = api.get_user_model_info(model_id)
+        if not allow_exist:
+            raise ValueError(f"model id '{model_id}' has been exists at amp")
+        files = model_file_list(model_id)
+        # ensure has only one file, and must named '.gitattributes'
+        if len(files) != 1 or files[0]['path'] != '.gitattributes':
+            raise ValueError(f"invalid remote model repo '{model_id}': has more than one file")
+    except APIError as err:
+        if err.status_code != 404: raise
+        # create a new one
+        model_info = api.create_user_model(model_id, model_space_name)
+    git_url = model_info['repository_uri']
+    logger.info(f"remote model url: {git_url}")
+
+    # get git token
+    git_info = api.get_user_gitinfo()
+    git_user, git_secret = git_info['git_user_name'], git_info['git_user_secret']
+
+    # compose new git url with auth
+    parsed_url = urlparse(git_url)
+    authed_git_url = urlunparse((parsed_url.scheme, f'{git_user}:{git_secret}@{parsed_url.netloc}',
+                                 parsed_url.path, parsed_url.params, parsed_url.query, parsed_url.fragment))
+
+    with tempfile.TemporaryDirectory(prefix='scoamp') as tmp_git_dir_path:
+        logger.info('clone remote model...')
+        r = subprocess.run(f'git clone {authed_git_url} {tmp_git_dir_path}', shell=True, check=False, capture_output=True, encoding='utf-8')
+        if r.returncode:
+            raise RuntimeError(f'git clone remote model error: {r.stderr}')
+        
+        logger.info('upload local model to remote repo...')
+
+        shell_script = f"""
+        set -e
+        git config user.name 'scoamp-agent'
+        git config user.email 'scoamp-agent@sensecore.cn'
+        scoamp lfs setup .
+        git --work-tree {local_dir_path} add --no-all .
+        git commit -m 'add model files'
+        git push origin master
+        """
+
+        r = subprocess.run(
+            shell_script,
+            shell=True,
+            check=True,
+            cwd=tmp_git_dir_path,
+            capture_output=True
+        )
+
+    return git_url
```

## scoamp/commands/api.py

```diff
@@ -95,15 +95,14 @@
             'tags': tags,
             'create_time': m['create_time'],
             'update_time': m['update_time']
         })
 
     if simple:
         print(json.dumps(res, indent=2))
-        print(f"Count: {count}, Total: {total}")
     else:
         table = Table(title=f'Model Information({count}/{total})', show_lines=True, show_edge=True)
         for header in ('Name', 'ID', 'URL', 'Owner', 'Tags', 'Created', 'Updated'):
             table.add_column(header, style='cyan', overflow='fold')
         for r in res:
             table.add_row(r['display_name'], r['name'], r['repository_uri'], r['owner_name'],
                           ','.join(r['tags']), format_datetime(r['create_time']), format_datetime(r['update_time']),
@@ -112,28 +111,23 @@
         print(table)
 
 
 
 @app.command(help="command stub", hidden=True)
 @err_wrapper
 def stub(
-    model_id: str,
-    file_path: str,
-    local_dir: str,
-    revision: Optional[str] = None
     ):
     # load auth info from cache
     #auth = load_auth()
 
     # make request
     #from scoamp.api import set_auth_info, set_endpoint
     #set_endpoint(auth.endpoint)
     #set_auth_info(auth.access_key, auth.secret_key)
 
-    from scoamp.toolkit import model_file_download, model_file_list, snapshot_download
-    #r = model_file_download(model_id, file_path, local_dir=local_dir, resume_download=False, is_public=False, force_download=True)
-    #r = model_file_list(model_id, is_public=False)
-    ignore_patterns = []
-    r = snapshot_download(model_id, local_dir, is_public=True, revision=revision, ignore_patterns=ignore_patterns)
+    from scoamp.globals import global_api
+    space_name = 'xxxxx'
+    from scoamp.toolkit import create_and_upload_model
+    r = create_and_upload_model('test-0714-3', 'repo1', space_name, allow_exist=True)
     print(r)
```

## scoamp/utils/error.py

```diff
@@ -10,16 +10,18 @@
     pass
 
 class NotLoginError(ScoampBaseError):
     pass
 
 class APIError(ScoampBaseError):
     def __init__(self, resp, *args):
-        msg = f"Call AMP API Error(status={resp.status_code}, path={resp.url}):\n{resp.content.decode('utf-8')}"
+        msg = f"Call AMP API Error(status={resp.status_code}, url={resp.url}):\n{resp.content.decode('utf-8')}"
         super().__init__(msg, *args)
+        self.status_code = resp.status_code
+        self.url = resp.url
 
 class FileFormatError(ScoampBaseError):
     pass
 
 class SubprocessError(ScoampBaseError):
     pass
```

## Comparing `scoamp-0.3.4.dist-info/LICENSE` & `scoamp-0.4.0a0.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `scoamp-0.3.4.dist-info/METADATA` & `scoamp-0.4.0a0.dist-info/METADATA`

 * *Files 10% similar despite different names*

```diff
@@ -1,37 +1,34 @@
 Metadata-Version: 2.1
 Name: scoamp
-Version: 0.3.4
+Version: 0.4.0a0
 Summary: SenseCore AI Model Platform Command Line Tool
-Home-page: UNKNOWN
 Author: SenseTime, Inc.
 Author-email: hpan@sensetime.com
 License: Apache 2.0
 Keywords: machine-learning deep-learning models
-Platform: UNKNOWN
 Classifier: License :: OSI Approved :: Apache Software License
 Classifier: Operating System :: OS Independent
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3 :: Only
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
 Classifier: Programming Language :: Python :: 3.11
 Classifier: Topic :: Scientific/Engineering :: Artificial Intelligence
 Requires-Python: >=3.7.0
+License-File: LICENSE
 Requires-Dist: requests
 Requires-Dist: rich
 Requires-Dist: filelock
 Requires-Dist: tqdm
+Requires-Dist: pycryptodome
 Requires-Dist: typer (==0.7.0)
 Requires-Dist: click (>=8.0.0)
 Requires-Dist: jsonschema (>=3.2)
 Provides-Extra: testing
 Requires-Dist: pytest ; extra == 'testing'
 Requires-Dist: pytest-cov ; extra == 'testing'
 Requires-Dist: pytest-env ; extra == 'testing'
 Requires-Dist: pytest-xdist ; extra == 'testing'
 
-UNKNOWN
-
-
```

