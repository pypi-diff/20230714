# Comparing `tmp/ggml-python-0.0.7.tar.gz` & `tmp/ggml-python-0.0.8.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ggml-python-0.0.7.tar", last modified: Wed Nov  9 12:37:21 2022, max compression
+gzip compressed data, was "ggml-python-0.0.8.tar", last modified: Wed Nov  9 12:37:21 2022, max compression
```

## Comparing `ggml-python-0.0.7.tar` & `ggml-python-0.0.8.tar`

### file list

```diff
@@ -1,140 +1,267 @@
--rw-r--r--   0        0        0     2055 2022-11-09 12:37:21.000000 ggml-python-0.0.7/.github/workflows/test.yaml
--rw-r--r--   0        0        0     3146 2022-11-09 12:37:21.000000 ggml-python-0.0.7/.gitignore
--rw-r--r--   0        0        0       87 2022-11-09 12:37:21.000000 ggml-python-0.0.7/.gitmodules
--rw-r--r--   0        0        0      443 2022-11-09 12:37:21.000000 ggml-python-0.0.7/.readthedocs.yaml
--rw-r--r--   0        0        0      800 2022-11-09 12:37:21.000000 ggml-python-0.0.7/CMakeLists.txt
--rw-r--r--   0        0        0     1069 2022-11-09 12:37:21.000000 ggml-python-0.0.7/LICENSE.md
--rw-r--r--   0        0        0      958 2022-11-09 12:37:21.000000 ggml-python-0.0.7/Makefile
--rw-r--r--   0        0        0     3193 2022-11-09 12:37:21.000000 ggml-python-0.0.7/README.md
--rw-r--r--   0        0        0      150 2022-11-09 12:37:21.000000 ggml-python-0.0.7/docs/api-reference.md
--rw-r--r--   0        0        0     3315 2022-11-09 12:37:21.000000 ggml-python-0.0.7/docs/index.md
--rw-r--r--   0        0        0      604 2022-11-09 12:37:21.000000 ggml-python-0.0.7/examples/replit/README.md
--rw-r--r--   0        0        0    23481 2022-11-09 12:37:21.000000 ggml-python-0.0.7/examples/replit/app.py
--rw-r--r--   0        0        0    35939 2022-11-09 12:37:21.000000 ggml-python-0.0.7/examples/replit/main.py
--rwxr-xr-x   0        0        0      289 2022-11-09 12:37:21.000000 ggml-python-0.0.7/examples/replit/profile.sh
--rw-r--r--   0        0        0       21 2022-11-09 12:37:21.000000 ggml-python-0.0.7/examples/replit/profile.txt
--rw-r--r--   0        0        0       19 2022-11-09 12:37:21.000000 ggml-python-0.0.7/ggml/__init__.py
--rw-r--r--   0        0        0    33304 2022-11-09 12:37:21.000000 ggml-python-0.0.7/ggml/experimental.py
--rw-r--r--   0        0        0   127067 2022-11-09 12:37:21.000000 ggml-python-0.0.7/ggml/ggml.py
--rw-r--r--   0        0        0     2802 2022-11-09 12:37:21.000000 ggml-python-0.0.7/ggml/utils.py
--rw-r--r--   0        0        0      521 2022-11-09 12:37:21.000000 ggml-python-0.0.7/mkdocs.yml
--rw-r--r--   0        0        0     1269 2022-11-09 12:37:21.000000 ggml-python-0.0.7/pyproject.toml
--rw-r--r--   0        0        0        0 2022-11-09 12:37:21.000000 ggml-python-0.0.7/tests/__init__.py
--rw-r--r--   0        0        0      661 2022-11-09 12:37:21.000000 ggml-python-0.0.7/tests/test_experimental.py
--rw-r--r--   0        0        0     1490 2022-11-09 12:37:21.000000 ggml-python-0.0.7/tests/test_ggml.py
--rw-r--r--   0        0        0     1552 2022-11-09 12:37:21.000000 ggml-python-0.0.7/tests/test_ggml_cuda.py
--rw-r--r--   0        0        0      452 2022-11-09 12:37:21.000000 ggml-python-0.0.7/tests/test_utils.py
--rw-r--r--   0        0        0       39 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/.git
--rw-r--r--   0        0        0      865 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/.github/workflows/ci.yml
--rw-r--r--   0        0        0      191 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/.gitignore
--rw-r--r--   0        0        0     2630 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/CMakeLists.txt
--rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/LICENSE
--rw-r--r--   0        0        0     5281 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/README.md
--rw-r--r--   0        0        0     4385 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/build.zig
--rw-r--r--   0        0        0     2037 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/cmake/BuildTypes.cmake
--rw-r--r--   0        0        0      717 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/cmake/GitVars.cmake
--rw-r--r--   0        0        0      815 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/CMakeLists.txt
--rw-r--r--   0        0        0     8676 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/common-ggml.cpp
--rw-r--r--   0        0        0      410 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/common-ggml.h
--rw-r--r--   0        0        0    24038 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/common.cpp
--rw-r--r--   0        0        0     4445 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/common.h
--rw-r--r--   0        0        0      319 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/CMakeLists.txt
--rw-r--r--   0        0        0     5398 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/README.md
--rw-r--r--   0        0        0     3540 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    28935 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/main.cpp
--rw-r--r--   0        0        0     6032 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/quantize.cpp
--rw-r--r--   0        0        0   241358 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/dr_wav.h
--rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/CMakeLists.txt
--rw-r--r--   0        0        0     6370 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/README.md
--rw-r--r--   0        0        0     6319 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py
--rw-r--r--   0        0        0     4873 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py
--rw-r--r--   0        0        0     6436 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py
--rwxr-xr-x   0        0        0     1752 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/download-ggml-model.sh
--rwxr-xr-x   0        0        0     1117 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/download-model.sh
--rw-r--r--   0        0        0    29499 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/main.cpp
--rw-r--r--   0        0        0     5854 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-2/quantize.cpp
--rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-j/CMakeLists.txt
--rw-r--r--   0        0        0    11108 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-j/README.md
--rw-r--r--   0        0        0     5509 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py
--rwxr-xr-x   0        0        0     1728 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-j/download-ggml-model.sh
--rwxr-xr-x   0        0        0      571 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-j/download-model.sh
--rw-r--r--   0        0        0    25946 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-j/main.cpp
--rw-r--r--   0        0        0     5856 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-j/quantize.cpp
--rw-r--r--   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/CMakeLists.txt
--rw-r--r--   0        0        0     3948 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/README.md
--rw-r--r--   0        0        0     3296 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    28395 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/main.cpp
--rw-r--r--   0        0        0     5840 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/quantize.cpp
--rw-r--r--   0        0        0      857 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/CMakeLists.txt
--rw-r--r--   0        0        0     4104 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/README.md
--rw-r--r--   0        0        0     1491 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/convert-h5-to-ggml.py
--rw-r--r--   0        0        0     3431 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/main-cpu.cpp
--rw-r--r--   0        0        0     3423 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/main-mtl.cpp
--rw-r--r--   0        0        0      500 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/main-mtl.h
--rw-r--r--   0        0        0    21062 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/main-mtl.m
--rw-r--r--   0        0        0     9484 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/main.cpp
--rw-r--r--   0        0        0        2 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/web/.gitignore
--rw-r--r--   0        0        0     5597 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mnist/web/index.html
--rw-r--r--   0        0        0      303 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mpt/CMakeLists.txt
--rw-r--r--   0        0        0     4722 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mpt/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    38188 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mpt/main.cpp
--rw-r--r--   0        0        0     6096 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/mpt/quantize.cpp
--rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/dolly-v2.txt
--rw-r--r--   0        0        0       76 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/gpt-2-chinese.txt
--rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/gpt-2.txt
--rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/gpt-j.txt
--rw-r--r--   0        0        0       78 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/gpt-neox-japanese.txt
--rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/gpt-neox.txt
--rw-r--r--   0        0        0      174 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/polyglot-ko.txt
--rw-r--r--   0        0        0    10111 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/replit.txt
--rw-r--r--   0        0        0     9134 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/starcoder.txt
--rw-r--r--   0        0        0     5094 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/test-cases.txt
--rw-r--r--   0        0        0     3285 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/tokenize_huggingface.py
--rw-r--r--   0        0        0     8727 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/prompts/whisper.txt
--rw-r--r--   0        0        0      315 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/replit/CMakeLists.txt
--rw-r--r--   0        0        0     3364 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/replit/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    27951 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/replit/main.cpp
--rw-r--r--   0        0        0     5636 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/replit/quantize.cpp
--rw-r--r--   0        0        0      327 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/starcoder/CMakeLists.txt
--rw-r--r--   0        0        0     3831 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/starcoder/README.md
--rw-r--r--   0        0        0     7758 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/starcoder/convert-hf-to-ggml.py
--rw-r--r--   0        0        0    31853 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/starcoder/main.cpp
--rw-r--r--   0        0        0     5875 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/starcoder/quantize.cpp
--rw-r--r--   0        0        0      501 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/whisper/CMakeLists.txt
--rw-r--r--   0        0        0      718 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/whisper/README.md
--rw-r--r--   0        0        0     9441 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/whisper/convert-pt-to-ggml.py
--rw-r--r--   0        0        0    39190 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/whisper/main.cpp
--rw-r--r--   0        0        0     8145 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/whisper/quantize.cpp
--rw-r--r--   0        0        0   185322 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/whisper/whisper.cpp
--rw-r--r--   0        0        0    24087 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/examples/whisper/whisper.h
--rw-r--r--   0        0        0    52032 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/include/ggml/ggml.h
--rw-r--r--   0        0        0      126 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/requirements.txt
--rwxr-xr-x   0        0        0      512 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/scripts/sync-llama.sh
--rwxr-xr-x   0        0        0     1286 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/scripts/sync-whisper.sh
--rw-r--r--   0        0        0     8756 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/CMakeLists.txt
--rw-r--r--   0        0        0   112588 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/ggml-cuda.cu
--rw-r--r--   0        0        0     1513 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/ggml-cuda.h
--rw-r--r--   0        0        0     2615 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/ggml-metal.h
--rw-r--r--   0        0        0    49870 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/ggml-metal.m
--rw-r--r--   0        0        0    59655 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/ggml-metal.metal
--rw-r--r--   0        0        0    62020 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/ggml-opencl.cpp
--rw-r--r--   0        0        0      845 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/ggml-opencl.h
--rw-r--r--   0        0        0   624583 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/src/ggml.c
--rw-r--r--   0        0        0     9496 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/CMakeLists.txt
--rw-r--r--   0        0        0     6569 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-blas0.c
--rw-r--r--   0        0        0    40249 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-grad0.c
--rw-r--r--   0        0        0    10698 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-mul-mat0.c
--rw-r--r--   0        0        0     9003 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-mul-mat1.c
--rw-r--r--   0        0        0    91888 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-mul-mat2.c
--rw-r--r--   0        0        0     5616 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-opt.c
--rw-r--r--   0        0        0     5141 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-svd0.c
--rw-r--r--   0        0        0     3402 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-vec0.c
--rw-r--r--   0        0        0    21179 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-vec1.c
--rw-r--r--   0        0        0     7310 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test-vec2.c
--rw-r--r--   0        0        0     1237 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test0.c
--rw-r--r--   0        0        0     1480 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test0.zig
--rw-r--r--   0        0        0    15323 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test1.c
--rw-r--r--   0        0        0    17877 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test1.zig
--rw-r--r--   0        0        0     5931 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test2.c
--rw-r--r--   0        0        0     2843 2022-11-09 12:37:21.000000 ggml-python-0.0.7/vendor/ggml/tests/test3.c
--rw-r--r--   0        0        0     4522 2022-11-09 12:37:21.000000 ggml-python-0.0.7/PKG-INFO
+-rw-r--r--   0        0        0     2055 2022-11-09 12:37:21.000000 ggml-python-0.0.8/.github/workflows/test.yaml
+-rw-r--r--   0        0        0     3146 2022-11-09 12:37:21.000000 ggml-python-0.0.8/.gitignore
+-rw-r--r--   0        0        0       87 2022-11-09 12:37:21.000000 ggml-python-0.0.8/.gitmodules
+-rw-r--r--   0        0        0      443 2022-11-09 12:37:21.000000 ggml-python-0.0.8/.readthedocs.yaml
+-rw-r--r--   0        0        0      800 2022-11-09 12:37:21.000000 ggml-python-0.0.8/CMakeLists.txt
+-rw-r--r--   0        0        0     1069 2022-11-09 12:37:21.000000 ggml-python-0.0.8/LICENSE.md
+-rw-r--r--   0        0        0      958 2022-11-09 12:37:21.000000 ggml-python-0.0.8/Makefile
+-rw-r--r--   0        0        0     3429 2022-11-09 12:37:21.000000 ggml-python-0.0.8/README.md
+-rw-r--r--   0        0        0      107 2022-11-09 12:37:21.000000 ggml-python-0.0.8/docs/api-reference.md
+-rw-r--r--   0        0        0     3486 2022-11-09 12:37:21.000000 ggml-python-0.0.8/docs/index.md
+-rw-r--r--   0        0        0     1330 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/README.md
+-rw-r--r--   0        0        0     4527 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/convert-pt-to-ggml.py
+-rw-r--r--   0        0        0    31690 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/model.py
+-rw-r--r--   0        0        0      470 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/requirements.txt
+-rw-r--r--   0        0        0     7599 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/utils.py
+-rw-r--r--   0        0        0     1170 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/README.md
+-rw-r--r--   0        0        0    24959 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/app.py
+-rw-r--r--   0        0        0    39016 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/main.py
+-rw-r--r--   0        0        0    68226 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/recording.svg
+-rw-r--r--   0        0        0       72 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/requirements.txt
+-rwxr-xr-x   0        0        0      385 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/run_demo.sh
+-rwxr-xr-x   0        0        0      105 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/run_server.sh
+-rw-r--r--   0        0        0       19 2022-11-09 12:37:21.000000 ggml-python-0.0.8/ggml/__init__.py
+-rw-r--r--   0        0        0    33572 2022-11-09 12:37:21.000000 ggml-python-0.0.8/ggml/experimental.py
+-rw-r--r--   0        0        0   155356 2022-11-09 12:37:21.000000 ggml-python-0.0.8/ggml/ggml.py
+-rw-r--r--   0        0        0     4527 2022-11-09 12:37:21.000000 ggml-python-0.0.8/ggml/utils.py
+-rw-r--r--   0        0        0      950 2022-11-09 12:37:21.000000 ggml-python-0.0.8/mkdocs.yml
+-rw-r--r--   0        0        0     1291 2022-11-09 12:37:21.000000 ggml-python-0.0.8/pyproject.toml
+-rw-r--r--   0        0        0        0 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/__init__.py
+-rw-r--r--   0        0        0      661 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/test_experimental.py
+-rw-r--r--   0        0        0     3571 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/test_ggml.py
+-rw-r--r--   0        0        0     2940 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/test_ggml_cuda.py
+-rw-r--r--   0        0        0     1800 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/test_utils.py
+-rw-r--r--   0        0        0       39 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/.git
+-rw-r--r--   0        0        0      865 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/.github/workflows/ci.yml
+-rw-r--r--   0        0        0      191 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/.gitignore
+-rw-r--r--   0        0        0     2845 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/CMakeLists.txt
+-rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/LICENSE
+-rw-r--r--   0        0        0     5514 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/README.md
+-rw-r--r--   0        0        0     4251 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/build.zig
+-rw-r--r--   0        0        0     2037 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/cmake/BuildTypes.cmake
+-rw-r--r--   0        0        0      717 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/cmake/GitVars.cmake
+-rw-r--r--   0        0        0      815 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/CMakeLists.txt
+-rw-r--r--   0        0        0     8676 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/common-ggml.cpp
+-rw-r--r--   0        0        0      410 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/common-ggml.h
+-rw-r--r--   0        0        0    24799 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/common.cpp
+-rw-r--r--   0        0        0     4619 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/common.h
+-rw-r--r--   0        0        0      319 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/CMakeLists.txt
+-rw-r--r--   0        0        0     5398 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/README.md
+-rw-r--r--   0        0        0     3540 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    33342 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/main.cpp
+-rw-r--r--   0        0        0     6037 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/quantize.cpp
+-rw-r--r--   0        0        0   241358 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dr_wav.h
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/CMakeLists.txt
+-rw-r--r--   0        0        0     6370 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/README.md
+-rw-r--r--   0        0        0     6319 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py
+-rw-r--r--   0        0        0     4873 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py
+-rw-r--r--   0        0        0     6436 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1752 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/download-ggml-model.sh
+-rwxr-xr-x   0        0        0     1117 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/download-model.sh
+-rw-r--r--   0        0        0    29487 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/main.cpp
+-rw-r--r--   0        0        0     5859 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/quantize.cpp
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/CMakeLists.txt
+-rw-r--r--   0        0        0    11108 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/README.md
+-rw-r--r--   0        0        0     5509 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1728 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/download-ggml-model.sh
+-rwxr-xr-x   0        0        0      571 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/download-model.sh
+-rw-r--r--   0        0        0    25934 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/main.cpp
+-rw-r--r--   0        0        0     5861 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/quantize.cpp
+-rw-r--r--   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/CMakeLists.txt
+-rw-r--r--   0        0        0     3948 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/README.md
+-rw-r--r--   0        0        0     3296 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    28383 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/main.cpp
+-rw-r--r--   0        0        0     5845 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/quantize.cpp
+-rw-r--r--   0        0        0      857 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/CMakeLists.txt
+-rw-r--r--   0        0        0     4104 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/README.md
+-rw-r--r--   0        0        0     1491 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0     3423 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main-cpu.cpp
+-rw-r--r--   0        0        0     3417 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main-mtl.cpp
+-rw-r--r--   0        0        0      500 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main-mtl.h
+-rw-r--r--   0        0        0    21090 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main-mtl.m
+-rw-r--r--   0        0        0     9472 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main.cpp
+-rw-r--r--   0        0        0        2 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/web/.gitignore
+-rw-r--r--   0        0        0     5597 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/web/index.html
+-rw-r--r--   0        0        0      303 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/CMakeLists.txt
+-rw-r--r--   0        0        0      671 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/README.md
+-rwxr-xr-x   0        0        0     4948 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    38183 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/main.cpp
+-rw-r--r--   0        0        0     6101 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/quantize.cpp
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/dolly-v2.txt
+-rw-r--r--   0        0        0       76 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-2-chinese.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-2.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-j.txt
+-rw-r--r--   0        0        0       78 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-neox-japanese.txt
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-neox.txt
+-rw-r--r--   0        0        0      174 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/polyglot-ko.txt
+-rw-r--r--   0        0        0    10111 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/replit.txt
+-rw-r--r--   0        0        0     9134 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/starcoder.txt
+-rw-r--r--   0        0        0     5094 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/test-cases.txt
+-rw-r--r--   0        0        0     3285 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/tokenize_huggingface.py
+-rw-r--r--   0        0        0     8727 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/whisper.txt
+-rw-r--r--   0        0        0      315 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/replit/CMakeLists.txt
+-rw-r--r--   0        0        0     3364 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/replit/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    27974 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/replit/main.cpp
+-rw-r--r--   0        0        0     5641 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/replit/quantize.cpp
+-rw-r--r--   0        0        0      327 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/CMakeLists.txt
+-rw-r--r--   0        0        0     3831 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/README.md
+-rw-r--r--   0        0        0     7852 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/convert-hf-to-ggml.py
+-rw-r--r--   0        0        0    33059 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/main.cpp
+-rw-r--r--   0        0        0     5880 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/quantize.cpp
+-rw-r--r--   0        0        0      501 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/CMakeLists.txt
+-rw-r--r--   0        0        0      718 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/README.md
+-rw-r--r--   0        0        0     9441 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/convert-pt-to-ggml.py
+-rw-r--r--   0        0        0    40940 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/main.cpp
+-rw-r--r--   0        0        0     8150 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/quantize.cpp
+-rw-r--r--   0        0        0   189520 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/whisper.cpp
+-rw-r--r--   0        0        0    25668 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/whisper.h
+-rw-r--r--   0        0        0      241 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/ggml.pc.in
+-rw-r--r--   0        0        0    55052 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/include/ggml/ggml.h
+-rw-r--r--   0        0        0      126 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/requirements.txt
+-rwxr-xr-x   0        0        0      806 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/scripts/sync-llama.sh
+-rwxr-xr-x   0        0        0     1286 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/scripts/sync-whisper.sh
+-rw-r--r--   0        0        0     8982 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/CMakeLists.txt
+-rw-r--r--   0        0        0   134240 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-cuda.cu
+-rw-r--r--   0        0        0     1460 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-cuda.h
+-rw-r--r--   0        0        0     2769 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-metal.h
+-rw-r--r--   0        0        0    50140 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-metal.m
+-rw-r--r--   0        0        0    59655 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-metal.metal
+-rw-r--r--   0        0        0    68854 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-opencl.cpp
+-rw-r--r--   0        0        0      845 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-opencl.h
+-rw-r--r--   0        0        0   608566 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml.c
+-rw-r--r--   0        0        0     9736 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/CMakeLists.txt
+-rw-r--r--   0        0        0     6639 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-blas0.c
+-rw-r--r--   0        0        0    40350 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-grad0.c
+-rw-r--r--   0        0        0    10892 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat0.c
+-rw-r--r--   0        0        0     9003 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat1.c
+-rw-r--r--   0        0        0    91888 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat2.c
+-rw-r--r--   0        0        0     5728 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-opt.c
+-rw-r--r--   0        0        0     4434 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-pool.c
+-rw-r--r--   0        0        0     5614 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-quantize-fns.cpp
+-rw-r--r--   0        0        0    13999 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-quantize-perf.cpp
+-rw-r--r--   0        0        0     5141 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-svd0.c
+-rw-r--r--   0        0        0     3402 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-vec0.c
+-rw-r--r--   0        0        0    21179 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-vec1.c
+-rw-r--r--   0        0        0     7310 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-vec2.c
+-rw-r--r--   0        0        0     1237 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test0.c
+-rw-r--r--   0        0        0     1425 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test0.zig
+-rw-r--r--   0        0        0    15593 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test1.c
+-rw-r--r--   0        0        0    18066 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test1.zig
+-rw-r--r--   0        0        0     5931 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test2.c
+-rw-r--r--   0        0        0     5828 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test2.zig
+-rw-r--r--   0        0        0     2843 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test3.c
+-rw-r--r--   0        0        0     3278 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test3.zig
+-rw-r--r--   0        0        0       39 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/.git
+-rw-r--r--   0        0        0      865 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/.github/workflows/ci.yml
+-rw-r--r--   0        0        0      191 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/.gitignore
+-rw-r--r--   0        0        0     2630 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/CMakeLists.txt
+-rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/LICENSE
+-rw-r--r--   0        0        0     5281 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/README.md
+-rw-r--r--   0        0        0     4385 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/build.zig
+-rw-r--r--   0        0        0     2037 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/cmake/BuildTypes.cmake
+-rw-r--r--   0        0        0      717 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/cmake/GitVars.cmake
+-rw-r--r--   0        0        0      815 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/CMakeLists.txt
+-rw-r--r--   0        0        0     8676 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/common-ggml.cpp
+-rw-r--r--   0        0        0      410 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/common-ggml.h
+-rw-r--r--   0        0        0    24038 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/common.cpp
+-rw-r--r--   0        0        0     4445 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/common.h
+-rw-r--r--   0        0        0      319 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/CMakeLists.txt
+-rw-r--r--   0        0        0     5398 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/README.md
+-rw-r--r--   0        0        0     3540 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    28935 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/main.cpp
+-rw-r--r--   0        0        0     6032 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/quantize.cpp
+-rw-r--r--   0        0        0   241358 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dr_wav.h
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/CMakeLists.txt
+-rw-r--r--   0        0        0     6370 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/README.md
+-rw-r--r--   0        0        0     6319 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-cerebras-to-ggml.py
+-rw-r--r--   0        0        0     4873 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-ckpt-to-ggml.py
+-rw-r--r--   0        0        0     6436 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1752 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/download-ggml-model.sh
+-rwxr-xr-x   0        0        0     1117 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/download-model.sh
+-rw-r--r--   0        0        0    29499 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/main.cpp
+-rw-r--r--   0        0        0     5854 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/quantize.cpp
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/CMakeLists.txt
+-rw-r--r--   0        0        0    11108 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/README.md
+-rw-r--r--   0        0        0     5509 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1728 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/download-ggml-model.sh
+-rwxr-xr-x   0        0        0      571 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/download-model.sh
+-rw-r--r--   0        0        0    25946 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/main.cpp
+-rw-r--r--   0        0        0     5856 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/quantize.cpp
+-rw-r--r--   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/CMakeLists.txt
+-rw-r--r--   0        0        0     3948 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/README.md
+-rw-r--r--   0        0        0     3296 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    28395 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/main.cpp
+-rw-r--r--   0        0        0     5840 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/quantize.cpp
+-rw-r--r--   0        0        0      857 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/CMakeLists.txt
+-rw-r--r--   0        0        0     4104 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/README.md
+-rw-r--r--   0        0        0     1491 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0     3431 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-cpu.cpp
+-rw-r--r--   0        0        0     3423 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.cpp
+-rw-r--r--   0        0        0      500 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.h
+-rw-r--r--   0        0        0    21062 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.m
+-rw-r--r--   0        0        0     9484 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main.cpp
+-rw-r--r--   0        0        0        2 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/web/.gitignore
+-rw-r--r--   0        0        0     5597 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/web/index.html
+-rw-r--r--   0        0        0      303 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/CMakeLists.txt
+-rw-r--r--   0        0        0     4722 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    38188 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/main.cpp
+-rw-r--r--   0        0        0     6096 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/quantize.cpp
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/dolly-v2.txt
+-rw-r--r--   0        0        0       76 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-2-chinese.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-2.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-j.txt
+-rw-r--r--   0        0        0       78 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-neox-japanese.txt
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-neox.txt
+-rw-r--r--   0        0        0      174 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/polyglot-ko.txt
+-rw-r--r--   0        0        0    10111 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/replit.txt
+-rw-r--r--   0        0        0     9134 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/starcoder.txt
+-rw-r--r--   0        0        0     5094 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/test-cases.txt
+-rw-r--r--   0        0        0     3285 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/tokenize_huggingface.py
+-rw-r--r--   0        0        0     8727 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/whisper.txt
+-rw-r--r--   0        0        0      315 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/CMakeLists.txt
+-rw-r--r--   0        0        0     3364 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    27951 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/main.cpp
+-rw-r--r--   0        0        0     5636 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/quantize.cpp
+-rw-r--r--   0        0        0      327 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/CMakeLists.txt
+-rw-r--r--   0        0        0     3831 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/README.md
+-rw-r--r--   0        0        0     7758 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/convert-hf-to-ggml.py
+-rw-r--r--   0        0        0    31853 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/main.cpp
+-rw-r--r--   0        0        0     5875 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/quantize.cpp
+-rw-r--r--   0        0        0      501 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/CMakeLists.txt
+-rw-r--r--   0        0        0      718 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/README.md
+-rw-r--r--   0        0        0     9441 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/convert-pt-to-ggml.py
+-rw-r--r--   0        0        0    39190 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/main.cpp
+-rw-r--r--   0        0        0     8145 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/quantize.cpp
+-rw-r--r--   0        0        0   185322 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/whisper.cpp
+-rw-r--r--   0        0        0    24087 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/whisper.h
+-rw-r--r--   0        0        0    52032 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/include/ggml/ggml.h
+-rw-r--r--   0        0        0      126 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/requirements.txt
+-rwxr-xr-x   0        0        0      512 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/scripts/sync-llama.sh
+-rwxr-xr-x   0        0        0     1286 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/scripts/sync-whisper.sh
+-rw-r--r--   0        0        0     8756 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/CMakeLists.txt
+-rw-r--r--   0        0        0   120472 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-cuda.cu
+-rw-r--r--   0        0        0     1513 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-cuda.h
+-rw-r--r--   0        0        0     2615 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.h
+-rw-r--r--   0        0        0    49870 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.m
+-rw-r--r--   0        0        0    59655 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.metal
+-rw-r--r--   0        0        0    62020 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-opencl.cpp
+-rw-r--r--   0        0        0      845 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-opencl.h
+-rw-r--r--   0        0        0   624971 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml.c
+-rw-r--r--   0        0        0     9496 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/CMakeLists.txt
+-rw-r--r--   0        0        0     6569 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-blas0.c
+-rw-r--r--   0        0        0    40249 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-grad0.c
+-rw-r--r--   0        0        0    10698 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat0.c
+-rw-r--r--   0        0        0     9003 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat1.c
+-rw-r--r--   0        0        0    91888 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat2.c
+-rw-r--r--   0        0        0     5616 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-opt.c
+-rw-r--r--   0        0        0     5141 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-svd0.c
+-rw-r--r--   0        0        0     3402 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec0.c
+-rw-r--r--   0        0        0    21179 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec1.c
+-rw-r--r--   0        0        0     7310 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec2.c
+-rw-r--r--   0        0        0     1237 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test0.c
+-rw-r--r--   0        0        0     1480 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test0.zig
+-rw-r--r--   0        0        0    15323 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test1.c
+-rw-r--r--   0        0        0    17877 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test1.zig
+-rw-r--r--   0        0        0     5931 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test2.c
+-rw-r--r--   0        0        0     2843 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test3.c
+-rw-r--r--   0        0        0     4838 2022-11-09 12:37:21.000000 ggml-python-0.0.8/PKG-INFO
```

### Comparing `ggml-python-0.0.7/.github/workflows/test.yaml` & `ggml-python-0.0.8/.github/workflows/test.yaml`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/.gitignore` & `ggml-python-0.0.8/.gitignore`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/CMakeLists.txt` & `ggml-python-0.0.8/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/LICENSE.md` & `ggml-python-0.0.8/LICENSE.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/Makefile` & `ggml-python-0.0.8/Makefile`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/README.md` & `ggml-python-0.0.8/README.md`

 * *Files 14% similar despite different names*

```diff
@@ -8,14 +8,20 @@
 [![PyPI - Downloads](https://img.shields.io/pypi/dm/ggml-python)](https://pypi.org/project/ggml-python/)
 
 
 Python bindings for the [`ggml`](https://github.com/ggerganov/ggml) tensor library for machine learning.
 
 > **⚠️ This project is in a very early state and currently only offers the basic low-level bindings to ggml**
 
+# Documentation
+
+- [Getting Started](https://ggml-python.readthedocs.io/en/latest/)
+- [API Reference](https://ggml-python.readthedocs.io/en/latest/api-reference/)
+- [Examples](https://github.com/abetlen/ggml-python/tree/main/examples)
+
 # Installation
 
 
 Requirements
 - Python 3.7+
 - C compiler (gcc, clang, msvc, etc)
```

### Comparing `ggml-python-0.0.7/docs/index.md` & `ggml-python-0.0.8/docs/index.md`

 * *Files 5% similar despite different names*

```diff
@@ -98,14 +98,15 @@
 ## Next Steps
 
 To learn more about ggml-python, check out the following resources:
 
 - [API Reference](api-reference.md)
 - Examples
     - [Code Completion Server](https://github.com/abetlen/ggml-python/tree/main/examples/replit) - A code completion server using ggml-python and the replit-code-v1-3b model that you can drop into your editor as a local Github Copilot replacement.
+    - [CLIP Embeddings](https://github.com/abetlen/ggml-python/tree/main/examples/clip) - A simple example of using ggml-python to implement CLIP text / image embeddings.
 
 ## Development
 
 ```bash
 git clone https://github.com/abetlen/ggml-python.git
 cd ggml-python
 # (Optional) Create a virtual environment
```

### Comparing `ggml-python-0.0.7/examples/replit/app.py` & `ggml-python-0.0.8/examples/replit/app.py`

 * *Files 6% similar despite different names*

```diff
@@ -2,15 +2,25 @@
 
 import time
 import uuid
 import json
 import multiprocessing
 from functools import partial
 from threading import Lock
-from typing import Dict, List, Optional, Union, Iterator, AsyncIterator, Sequence
+from typing import (
+    Callable,
+    Dict,
+    List,
+    Optional,
+    Union,
+    Iterator,
+    AsyncIterator,
+    Sequence,
+)
+from os import environ
 
 from typing_extensions import TypedDict, Literal
 
 import numpy as np
 import numpy.typing as npt
 
 import anyio
@@ -61,16 +71,18 @@
     usage: CompletionUsage
 
 
 class OpenAIify:
     def __init__(
         self,
         model: ReplitModel,
+        cancel_callback: Optional[Callable[[], bool]] = None,
     ):
         self.model = model
+        self.cancel_callback = cancel_callback
 
     def tokenize(self, text: str) -> List[int]:
         return self.model.tokenize(text)
 
     def detokenize(self, tokens: List[int]) -> str:
         return self.model.detokenize(tokens)
 
@@ -136,14 +148,19 @@
             presence_penalty=presence_penalty,
         ):
             if token == self.eos_token():
                 text = self.detokenize(completion_tokens)
                 finish_reason = "stop"
                 break
 
+            if self.cancel_callback is not None and self.cancel_callback():
+                text = self.detokenize(completion_tokens)
+                finish_reason = "stop"
+                break
+
             completion_tokens.append(token)
 
             all_text = self.detokenize(completion_tokens)
             any_stop = [s for s in stop_sequences if s in all_text]
             if len(any_stop) > 0:
                 first_stop = any_stop[0]
                 text = all_text[: all_text.index(first_stop)]
@@ -520,33 +537,80 @@
     best_of: Optional[int] = 1
     logit_bias: Optional[Dict[str, float]] = Field(None)
     user: Optional[str] = Field(None)
 
     class Config:
         schema_extra = {
             "example": {
-                "prompt": "\n\n### Instructions:\nWhat is the capital of France?\n\n### Response:\n",
-                "stop": ["\n", "###"],
+                "prompt": "def fib(n):",
+                "stop": ["\n\n"],
+                "temperature": 0,
+                "max_tokens": 34,
             }
         }
 
 
-settings = Settings()  # type: ignore
-app = FastAPI()
+settings = Settings(model_file=environ.get("MODEL"))  # type: ignore
+app = FastAPI(
+    title="Code Completion API",
+    description="""
+## Editor Setup
+
+### VSCode
+
+Add the following to your `settings.json`:
+
+```json
+{
+    "github.copilot.advanced": {
+        "debug.testOverrideProxyUrl": "http://localhost:8000",
+        "debug.overrideProxyUrl": "http://localhost:8000"
+    }
+}
+```
+
+### Vim / Neovim
+
+Add the following to your vimrc or init.vim:
+
+```
+let g:copilot_proxy = 'localhost:8000'
+let g:copilot_strict_ssl = 0
+```
+""",
+)
+outer_lock = Lock()
+inner_lock = Lock()
+
 model = OpenAIify(
     ReplitModel.init_from_file(
         model_file=settings.model_file, n_gpu_layers=settings.n_gpu_layers
-    )
+    ),
+    # check if any other requests are pending in the same thread and cancel the stream if so
+    cancel_callback=lambda: outer_lock.locked(),
 )
-model_lock = Lock()
 
 
 def get_model():
-    with model_lock:
-        yield model
+    # NOTE: This double lock allows the currently streaming model to check
+    # if any other requests are pending in the same thread and cancel the
+    # stream if so.
+    outer_lock.acquire()
+    release_outer_lock = True
+    try:
+        inner_lock.acquire()
+        try:
+            outer_lock.release()
+            release_outer_lock = False
+            yield model
+        finally:
+            inner_lock.release()
+    finally:
+        if release_outer_lock:
+            outer_lock.release()
 
 
 # Used to support copilot.vim
 @app.get("/copilot_internal/v2/token")
 def get_copilot_token():
     content = {"token": "1", "expires_at": 2600000000, "refresh_in": 900}
     return dict(status_code=200, content=content)
```

### Comparing `ggml-python-0.0.7/examples/replit/main.py` & `ggml-python-0.0.8/examples/replit/main.py`

 * *Files 4% similar despite different names*

```diff
@@ -18,15 +18,15 @@
 from typing import Deque, Iterator, List, Optional, Sequence, Tuple, Dict
 
 import numpy as np
 import numpy.typing as npt
 
 import ggml
 
-from ggml.utils import to_numpy
+from ggml.utils import to_numpy, ggml_context_manager
 
 
 ## Generic Sampling Functions
 
 
 def sample(
     logits: npt.NDArray[np.float32],
@@ -165,45 +165,129 @@
 
     def __del__(self):
         if self._buffer is not None:
             ggml.ggml_cuda_host_free(self._buffer)
             self._buffer = None
 
 
+### Tokenizer
+
+
+class Tokenizer(abc.ABC):
+    @abc.abstractmethod
+    def tokenize(self, text: str) -> List[int]:
+        raise NotImplementedError
+
+    @abc.abstractmethod
+    def detokenize(self, tokens: List[int]) -> str:
+        raise NotImplementedError
+
+
+class ReplitTokenizer(Tokenizer):
+    def __init__(self, vocab: List[Tuple[int, str, float]]):
+        self.vocab = vocab
+        self.piece_map = {piece: (i, -score) for i, piece, score in self.vocab}
+        self.ws_symbol = b"\342\226\201"
+
+    def tokenize(self, text: str) -> List[int]:
+        normalized_text = text.replace(" ", self.ws_symbol.decode("utf-8"))
+        tokenized, _ = ReplitTokenizer.encode_word(normalized_text, self.piece_map)
+        return tokenized
+
+    def detokenize(self, tokens: List[int]) -> str:
+        text = "".join(self.vocab[token][1] for token in tokens)
+        detokenized = text.replace(self.ws_symbol.decode("utf-8"), " ")
+        return detokenized
+
+    @staticmethod
+    def encode_word(
+        word: str, model: Dict[str, Tuple[int, float]]
+    ) -> Tuple[List[int], float]:
+        len_word = len(word)
+        best_segmentation_starts = [-1] * (len_word + 1)
+        best_segmentation_scores = [math.inf] * (len_word + 1)
+        best_segmentation_starts[0], best_segmentation_scores[0] = 0, 0.0
+
+        for idx in range(len_word):
+            if best_segmentation_starts[idx] != -1:
+                end_idx = idx + 1
+                while end_idx <= len_word:
+                    token = word[idx:end_idx]
+                    if token in model:
+                        token_score = model[token][1]
+                        if (
+                            best_segmentation_scores[idx] + token_score
+                            < best_segmentation_scores[end_idx]
+                        ):
+                            best_segmentation_starts[end_idx] = idx
+                            best_segmentation_scores[end_idx] = (
+                                best_segmentation_scores[idx] + token_score
+                            )
+                    end_idx += 1
+
+        if best_segmentation_scores[-1] == math.inf:
+            return [], 0.0
+
+        tokens: Deque[int] = deque()
+        idx = len_word
+        while idx > 0:
+            start_idx = best_segmentation_starts[idx]
+            token = word[start_idx:idx]
+            token_id = model[token][0]
+            tokens.appendleft(token_id)
+            idx = start_idx
+
+        return list(tokens), best_segmentation_scores[-1]
+
+
+class ReplitSentencepieceTokenizer(Tokenizer):
+    def __init__(self, model_path: str):
+        import sentencepiece
+
+        self.tokenizer = sentencepiece.SentencePieceProcessor(model_file=model_path)
+
+    def tokenize(self, text: str) -> List[int]:
+        return self.tokenizer.encode(text)
+
+    def detokenize(self, tokens: List[int]) -> str:
+        return self.tokenizer.decode(tokens)
+
+
 ### Replit Model Definition
 
 
 class ReplitLayer:
     def __init__(self, wtype: int, n_embd: int, ctx: ggml.ggml_context_p):
-        self.ln_1_weight = ggml.ggml_new_tensor_1d(ctx, ggml.GGML_TYPE_F32, n_embd)
+        self.norm_1_weight = ggml.ggml_new_tensor_1d(ctx, ggml.GGML_TYPE_F32, n_embd)
         self.c_attn_wqkv_weight = ggml.ggml_new_tensor_2d(
             ctx, wtype, n_embd, 3 * n_embd
         )
         self.c_attn_out_proj_weight = ggml.ggml_new_tensor_2d(
             ctx, wtype, n_embd, n_embd
         )
-        self.ln_2_weight = ggml.ggml_new_tensor_1d(ctx, ggml.GGML_TYPE_F32, n_embd)
-        self.c_mlp_mlp_up_weight = ggml.ggml_new_tensor_2d(
+        self.norm_2_weight = ggml.ggml_new_tensor_1d(ctx, ggml.GGML_TYPE_F32, n_embd)
+        self.c_ffn_up_proj_weight = ggml.ggml_new_tensor_2d(
             ctx, wtype, n_embd, 4 * n_embd
         )
-        self.c_mlp_mlp_down_weight = ggml.ggml_new_tensor_2d(
+        self.c_ffn_down_proj_weight = ggml.ggml_new_tensor_2d(
             ctx, wtype, 4 * n_embd, n_embd
         )
 
 
 class ReplitModel:
     def __init__(
         self,
         d_model: int,
         max_seq_len: int,
         n_heads: int,
         n_layers: int,
         vocab_size: int,
         ftype: int,
         vocab: List[Tuple[int, str, float]],
+        tokenizer: Tokenizer,
         n_batch: int,
         n_threads: int,
         weights_buffer: ContextBuffer,
         ctx: ggml.ggml_context_p,
     ):
         self.d_model = d_model
         self.max_seq_len = max_seq_len
@@ -211,14 +295,15 @@
         self.n_layers = n_layers
         self.vocab_size = vocab_size
         self.ftype = ftype
         self.ctx = ctx
         self.layers: List[ReplitLayer] = []
         self.tensors: Dict[str, ggml.ggml_tensor_p] = {}
         self.vocab = vocab
+        self.tokenizer = tokenizer
         self.n_batch = n_batch
         self.n_threads = n_threads
         self.weights_buffer = weights_buffer
 
         n_layer = self.n_layers
         n_embd = self.d_model
         n_ctx = self.max_seq_len
@@ -234,17 +319,17 @@
         if ggml.GGML_USE_CUBLAS:
             self.memory_k.contents.backend = ggml.GGML_BACKEND_GPU
             ggml.ggml_cuda_transform_tensor(self.memory_k.contents.data, self.memory_k)
             self.memory_v.contents.backend = ggml.GGML_BACKEND_GPU
             ggml.ggml_cuda_transform_tensor(self.memory_v.contents.data, self.memory_v)
 
         self.wte_weight = ggml.ggml_new_tensor_2d(ctx, wtype, n_embd, n_vocab)
-        self.ln_f_weight = ggml.ggml_new_tensor_1d(ctx, ggml.GGML_TYPE_F32, n_embd)
+        self.norm_f_weight = ggml.ggml_new_tensor_1d(ctx, ggml.GGML_TYPE_F32, n_embd)
         self.tensors["transformer.wte.weight"] = self.wte_weight
-        self.tensors["transformer.norm_f.weight"] = self.ln_f_weight
+        self.tensors["transformer.norm_f.weight"] = self.norm_f_weight
 
         self.mem_per_token = 0
         if ggml.GGML_USE_CUBLAS:
             self.eval_buffer = CudaContextBuffer()
         else:
             self.eval_buffer = CpuContextBuffer()
 
@@ -252,35 +337,35 @@
             layer = ReplitLayer(
                 wtype=wtype,
                 n_embd=n_embd,
                 ctx=ctx,
             )
             self.layers.append(layer)
 
-            self.tensors[f"transformer.blocks.{i}.norm_1.weight"] = layer.ln_1_weight
+            self.tensors[f"transformer.blocks.{i}.norm_1.weight"] = layer.norm_1_weight
             self.tensors[
                 f"transformer.blocks.{i}.attn.Wqkv.weight"
             ] = layer.c_attn_wqkv_weight
             self.tensors[
                 f"transformer.blocks.{i}.attn.out_proj.weight"
             ] = layer.c_attn_out_proj_weight
-            self.tensors[f"transformer.blocks.{i}.norm_2.weight"] = layer.ln_2_weight
+            self.tensors[f"transformer.blocks.{i}.norm_2.weight"] = layer.norm_2_weight
             self.tensors[
                 f"transformer.blocks.{i}.ffn.up_proj.weight"
-            ] = layer.c_mlp_mlp_up_weight
+            ] = layer.c_ffn_up_proj_weight
             self.tensors[
                 f"transformer.blocks.{i}.ffn.down_proj.weight"
-            ] = layer.c_mlp_mlp_down_weight
+            ] = layer.c_ffn_down_proj_weight
 
         self.n_tokens = 0
         self.input_ids: npt.NDArray[np.intc] = np.ndarray(
             (self.max_seq_len), dtype=np.intc
         )
         self.scores: npt.NDArray[np.single] = np.ndarray(
-            (n_vocab, self.max_seq_len), dtype=np.single
+            (self.max_seq_len, n_vocab), dtype=np.single
         )
 
     def __del__(self):
         ggml.ggml_free(self.ctx)
 
         if ggml.GGML_USE_CUBLAS:
             for tensor in self.tensors.values():
@@ -289,145 +374,125 @@
             ggml.ggml_cuda_free_data(self.memory_k)
             ggml.ggml_cuda_free_data(self.memory_v)
 
     @staticmethod
     def encode_word(
         word: str, model: Dict[str, Tuple[int, float]]
     ) -> Tuple[List[int], float]:
-        best_segmentation_starts = [-1] * (len(word) + 1)
-        best_segmentation_starts[0] = 0
+        len_word = len(word)
+        best_segmentation_starts = [-1] * (len_word + 1)
+        best_segmentation_scores = [math.inf] * (len_word + 1)
+        best_segmentation_starts[0], best_segmentation_scores[0] = 0, 0.0
+
+        for idx in range(len_word):
+            if best_segmentation_starts[idx] != -1:
+                end_idx = idx + 1
+                while end_idx <= len_word:
+                    token = word[idx:end_idx]
+                    if token in model:
+                        token_score = model[token][1]
+                        if (
+                            best_segmentation_scores[idx] + token_score
+                            < best_segmentation_scores[end_idx]
+                        ):
+                            best_segmentation_starts[end_idx] = idx
+                            best_segmentation_scores[end_idx] = (
+                                best_segmentation_scores[idx] + token_score
+                            )
+                    end_idx += 1
 
-        best_segmentation_scores = [-math.inf] * (len(word) + 1)
-        best_segmentation_scores[0] = 1.0
-
-        for start_idx in range(len(word)):
-            best_score_at_start = best_segmentation_scores[start_idx]
-            for end_idx in range(start_idx + 1, len(word) + 1):
-                token = word[start_idx:end_idx]
-                if token in model and best_score_at_start != -math.inf:
-                    token_score = model[token][1]
-                    score = token_score + best_score_at_start
-                    if (
-                        best_segmentation_scores[end_idx] == -math.inf
-                        or best_segmentation_scores[end_idx] > score
-                    ):
-                        best_segmentation_starts[end_idx] = start_idx
-                        best_segmentation_scores[end_idx] = score
-
-        if best_segmentation_scores[-1] == -math.inf:
+        if best_segmentation_scores[-1] == math.inf:
             return [], 0.0
 
-        score = best_segmentation_scores[-1]
-        start = best_segmentation_starts[-1]
-        end = len(word)
-        tokens: Deque[int] = deque()
-        while start != 0:
-            token_id = model[word[start:end]][0]
+        tokens = deque()
+        idx = len_word
+        while idx > 0:
+            start_idx = best_segmentation_starts[idx]
+            token = word[start_idx:idx]
+            token_id = model[token][0]
             tokens.appendleft(token_id)
-            next_start = best_segmentation_starts[start]
-            end = start
-            start = next_start
-        token_id = model[word[start:end]][0]
-        tokens.appendleft(token_id)
-        return list(tokens), score
+            idx = start_idx
+
+        return list(tokens), best_segmentation_scores[-1]
 
     def tokenize(self, text: str) -> List[int]:
-        ws_symbol = b"\342\226\201"
-        piece_map = {piece: (i, -score) for i, piece, score in self.vocab}
-        normalized_text = text.replace(" ", ws_symbol.decode("utf-8"))
-        tokenized, _ = ReplitModel.encode_word(normalized_text, piece_map)
-        return tokenized
+        return self.tokenizer.tokenize(text)
 
     def detokenize(self, tokens: List[int]) -> str:
-        id_to_token = self.vocab
-        ws_symbol = b"\342\226\201"
-        text = "".join(id_to_token[token][1] for token in tokens)
-        detokenized = text.replace(ws_symbol.decode("utf-8"), " ")
-        return detokenized
+        return self.tokenizer.detokenize(tokens)
 
     def reset(self):
         self.n_tokens = 0
 
-    def _eval_internal(self, embd_inp: Sequence[int], n_past: int, n_threads: int):
-        N = len(embd_inp)
-
+    def _build_forward(
+        self,
+        ctx0: ggml.ggml_context_p,
+        n_tokens: int,
+        n_past: int,
+        n_threads: int,
+    ):
+        N = n_tokens
         n_embd = self.d_model
         n_layer = self.n_layers
         n_ctx = self.max_seq_len
         n_head = self.n_heads
-        n_vocab = self.vocab_size
 
         def offload_nop(tensor: ggml.ggml_tensor_p):
             pass
 
         offload_func_nr = offload_nop
         offload_func_kq = offload_nop
         offload_func_v = offload_nop
 
-        required_buffer_size = int(self.mem_per_token * N * 2.0)
-
-        if (
-            self.mem_per_token > 0
-            and self.eval_buffer.buffer_size < required_buffer_size
-        ):
-            self.eval_buffer.resize(required_buffer_size)
-
-        init_params = ggml.ggml_init_params(
-            mem_size=self.eval_buffer.buffer_size,
-            mem_buffer=self.eval_buffer.buffer,
-            no_alloc=False,
-        )
-        ctx0 = ggml.ggml_init(init_params)
         gf = ggml.ggml_cgraph(n_threads=n_threads)
 
         embd = ggml.ggml_new_tensor_1d(
             ctx0,
             ggml.GGML_TYPE_I32,
             N,
         )
         ggml.ggml_set_name(embd, b"embd")
-        to_numpy(embd)[:] = np.array(embd_inp, dtype=np.int32)
 
         inpL = ggml.ggml_get_rows(ctx0, self.wte_weight, embd)
 
         if ggml.GGML_USE_CUBLAS:
             offload_func_nr = ggml.ggml_cuda_assign_buffers_no_scratch
             offload_func_kq = ggml.ggml_cuda_assign_buffers_no_scratch
             offload_func_v = ggml.ggml_cuda_assign_buffers_no_scratch
 
+        # offload_func_nr(inpL)
+
         for il in range(n_layer):
             offload_func = offload_nop
 
             if ggml.GGML_USE_CUBLAS:
                 offload_func = ggml.ggml_cuda_assign_buffers_no_scratch
 
             # // lctx.use_buf(ctx0, 0)
 
             # // a = self.ln_1(x)
             cur = ggml.ggml_norm(ctx0, inpL)
             # offload_func(cur)
             ggml.ggml_set_name(cur, b"norm_0")
             cur = ggml.ggml_mul(
                 ctx0,
-                ggml.ggml_repeat(ctx0, self.layers[il].ln_1_weight, cur),
+                ggml.ggml_repeat(ctx0, self.layers[il].norm_1_weight, cur),
                 cur,
             )
-            offload_func(cur)
+            # offload_func(cur)
             ggml.ggml_set_name(cur, b"attention_norm_0")
 
             # // self-attention
             # //  b, _, past_key_value = self.attn(a, past_key_value=past_key_value,
             # //  attn_bias=attn_bias, attention_mask=attention_mask,
             # //  is_causal=is_causal)
 
             # // compute QKV
             cur = ggml.ggml_mul_mat(ctx0, self.layers[il].c_attn_wqkv_weight, cur)
-            if ggml.GGML_USE_CUBLAS:
-                cur = ggml.ggml_cont(ctx0, cur)  # NOTE: needed for CUDA
-                offload_func_kq(cur)
+            # offload_func_kq(cur)
             ggml.ggml_set_name(cur, b"tmpkqv")
 
             Qcur = ggml.ggml_view_2d(
                 ctx0,
                 cur,
                 n_embd,
                 N,
@@ -539,15 +604,15 @@
                 3,
             )
             # offload_func_kq(K)
             ggml.ggml_set_name(K, b"K")
 
             # // K * Q
             KQ = ggml.ggml_mul_mat(ctx0, K, Q)
-            offload_func_kq(KQ)
+            # offload_func_kq(KQ)
             ggml.ggml_set_name(KQ, b"KQ")
 
             # // KQ_scaled = KQ / sqrt(n_embd/n_head)
             KQ_scaled = ggml.ggml_scale(
                 ctx0,
                 KQ,
                 ggml.ggml_new_f32(
@@ -652,111 +717,133 @@
 
             # // projection
             cur = ggml.ggml_mul_mat(
                 ctx0,
                 self.layers[il].c_attn_out_proj_weight,
                 cur,
             )
-            offload_func_v(cur)
+            # offload_func_v(cur)
             ggml.ggml_set_name(cur, b"result_wo")
 
             # // lctx.use_buf(ctx0, 1)
 
             inpL = ggml.ggml_add(
                 ctx0,
                 inpL,
                 cur,
             )
-            offload_func(cur)
+            # offload_func(cur)
             ggml.ggml_set_name(cur, b"inpFF")
 
             # // m = self.ln_2(x)
             cur = ggml.ggml_norm(ctx0, inpL)
             # offload_func(cur)
             ggml.ggml_set_name(cur, b"norm_1")
             cur = ggml.ggml_mul(
                 ctx0,
-                ggml.ggml_repeat(ctx0, self.layers[il].ln_2_weight, cur),
+                ggml.ggml_repeat(ctx0, self.layers[il].norm_2_weight, cur),
                 cur,
             )
             # offload_func(cur)
             ggml.ggml_set_name(cur, b"norm")
 
             # // n = self.mlp(m)
             cur = ggml.ggml_mul_mat(
                 ctx0,
-                self.layers[il].c_mlp_mlp_up_weight,
+                self.layers[il].c_ffn_up_proj_weight,
                 cur,
             )
             # offload_func(cur)
             ggml.ggml_set_name(cur, b"result_mlp_up")
 
             # // GELU activation
-            cur = ggml.ggml_gelu(
+            cur = ggml.ggml_gelu_quick(
                 ctx0,
                 cur,
             )
             # offload_func(cur)
             ggml.ggml_set_name(cur, b"gelu")
             # // projection
             # // cur = proj_w*cur + proj_b
             cur = ggml.ggml_mul_mat(
                 ctx0,
-                self.layers[il].c_mlp_mlp_down_weight,
+                self.layers[il].c_ffn_down_proj_weight,
                 cur,
             )
-            offload_func(cur)
+            # offload_func(cur)
             ggml.ggml_set_name(cur, b"result_mlp_down")
 
             # // x = x + n
             inpL = ggml.ggml_add(
                 ctx0,
                 inpL,
                 cur,
             )
-            offload_func(cur)
+            # offload_func(cur)
             ggml.ggml_set_name(cur, b"inpFF_+_result_mlp_down")
 
         # // lctx.use_buf(ctx0, 0)
 
         # // norm
         inpL = ggml.ggml_norm(ctx0, inpL)
         # offload_func_nr(inpL)
         ggml.ggml_set_name(inpL, b"norm_f")
 
         # // inpL = ln_f_g*inpL
         inpL = ggml.ggml_mul(
             ctx0,
-            ggml.ggml_repeat(ctx0, self.ln_f_weight, inpL),
+            ggml.ggml_repeat(ctx0, self.norm_f_weight, inpL),
             inpL,
         )
+        # offload_func_nr(inpL)
         ggml.ggml_set_name(inpL, b"norm_f_mul")
 
         # // output embedding weight tied to input embedding
         inpL = ggml.ggml_mul_mat(
             ctx0,
             self.wte_weight,
             inpL,
         )
         ggml.ggml_set_name(inpL, b"result_output")
 
         # // lctx.use_buf(ctx0, -1)
 
         ggml.ggml_build_forward_expand(ctypes.pointer(gf), inpL)
-        ggml.ggml_graph_compute(ctx0, ctypes.pointer(gf))
 
-        embd_w = to_numpy(inpL).reshape(
-            n_vocab, -1
-        )  # .copy() # NOTE: likely wrong to not copy here
+        return gf
 
-        self.mem_per_token = int(ggml.ggml_used_mem(ctx0) / N)
-
-        ggml.ggml_free(ctx0)
+    def _eval_internal(self, embd_inp: Sequence[int], n_past: int, n_threads: int):
+        N = len(embd_inp)
+        n_vocab = self.vocab_size
+        required_buffer_size = int(self.mem_per_token * N * 2.0)
+        if (
+            self.mem_per_token > 0
+            and self.eval_buffer.buffer_size < required_buffer_size
+        ):
+            self.eval_buffer.resize(required_buffer_size)
 
-        return embd_w
+        init_params = ggml.ggml_init_params(
+            mem_size=self.eval_buffer.buffer_size,
+            mem_buffer=self.eval_buffer.buffer,
+            no_alloc=False,
+        )
+        with ggml_context_manager(init_params) as ctx0:
+            gf = self._build_forward(ctx0, len(embd_inp), n_past, n_threads)
+            embd = ggml.ggml_graph_get_tensor(ctypes.pointer(gf), b"embd")
+            assert embd is not None
+            inpL = ggml.ggml_graph_get_tensor(ctypes.pointer(gf), b"result_output")
+            assert inpL is not None
+            to_numpy(embd)[:] = np.array(embd_inp, dtype=np.int32)
+            ggml.ggml_graph_compute_with_ctx(ctx0, ctypes.pointer(gf), self.n_threads)
+            embd_w = to_numpy(inpL).reshape(
+                -1, n_vocab
+            )  # .copy() # NOTE: likely wrong to not copy here
+            if self.mem_per_token == 0:
+                self.mem_per_token = int(ggml.ggml_used_mem(ctx0) / N)
+            return embd_w
 
     def eval(self, tokens: Sequence[int]):
         if self.mem_per_token == 0:
             self._eval_internal([1, 2, 3, 4], n_past=0, n_threads=self.n_threads)
         n_ctx = self.max_seq_len
         for i in range(0, len(tokens), self.n_batch):
             batch = tokens[i : min(len(tokens), i + self.n_batch)]
@@ -765,18 +852,18 @@
                 batch,
                 n_past,
                 self.n_threads,
             )
             # Save tokens
             self.input_ids[self.n_tokens : self.n_tokens + len(batch)] = batch
             # Save logits
-            self.scores[:, self.n_tokens : self.n_tokens + len(batch)] = scores
+            self.scores[self.n_tokens : self.n_tokens + len(batch), :] = scores
             # Update token count
             self.n_tokens += len(batch)
-        return self.scores[:, : self.n_tokens]
+        return self.scores[: self.n_tokens, :]
 
     def generate(
         self,
         tokens: Sequence[int],
         top_p: float = 0.95,
         temperature: float = 0.80,
         frequency_penalty: float = 0.0,
@@ -796,15 +883,15 @@
                 self.n_tokens = longest_prefix
 
         if reset:
             self.reset()
 
         while True:
             scores = self.eval(tokens)
-            logits = scores[:, -1]
+            logits = scores[-1, :]
             token = sample(
                 logits,
                 top_p=top_p,
                 temperature=temperature,
                 frequency_penalty=frequency_penalty,
                 presence_penalty=presence_penalty,
             )
@@ -888,14 +975,15 @@
                 max_seq_len=max_seq_len,
                 n_heads=n_heads,
                 n_layers=n_layers,
                 vocab_size=vocab_size,
                 ftype=ftype,
                 # vocabulary
                 vocab=vocab,
+                tokenizer=ReplitTokenizer(vocab),
                 ctx=ctx,
                 n_batch=n_batch,
                 n_threads=n_threads,
                 weights_buffer=weights_buffer,
             )
 
             n_tensors = 0
@@ -936,23 +1024,24 @@
                     (ctypes.c_uint8 * ggml.ggml_nbytes(tensor)).from_address(
                         ggml.ggml_get_data(tensor)
                     )
                 )
                 if ggml.GGML_USE_CUBLAS and name.startswith("transformer.block"):
                     should_offload_suffix = [
                         # "norm_1.weight",
-                        "attn.Wqkv.weight",
-                        "attn.out_proj.weight",
+                        # "attn.Wqkv.weight",
+                        # "attn.out_proj.weight",
                         # "norm_2.weight",
-                        "ffn.up_proj.weight",
-                        "ffn.down_proj.weight",
+                        # "ffn.up_proj.weight",
+                        # "ffn.down_proj.weight",
                     ]
                     if any(name.endswith(s) for s in should_offload_suffix):
                         tensor.contents.backend = ggml.GGML_BACKEND_GPU
                         ggml.ggml_cuda_transform_tensor(tensor.contents.data, tensor)
+                if ggml.GGML_USE_CUBLAS and name.startswith("transformer.block"):
                     if (
                         name == "transformer.wte.weight"
                         or name == "transformer.norm_f.weight"
                     ):
                         tensor.contents.backend = ggml.GGML_BACKEND_GPU
                         ggml.ggml_cuda_transform_tensor(tensor.contents.data, tensor)
 
@@ -964,17 +1053,14 @@
             print(
                 "model size =",
                 total_size // (1024 * 1024),
                 "MB",
                 "num tensors =",
                 n_tensors,
             )
-
-        model.eval([1, 2, 3, 4])
-        print("mem_per_token =", model.mem_per_token)
         return model
 
     @staticmethod
     def compute_ctx_size(
         n_embd: int,
         n_layer: int,
         n_ctx: int,
@@ -1045,15 +1131,15 @@
         print(f"token[{i}] =", token_id)
 
     print()
     print(prompt, end="", flush=True)
     for _ in range(max_tokens):
         # eval
         scores = model.eval(tokens)
-        logits = scores[:, -1]
+        logits = scores[-1, :]
         # sample
         token_id = sample(
             logits,
             last_tokens=all_tokens,
             temperature=temperature,
             top_p=top_p,
             presence_penalty=presence_penalty,
```

### Comparing `ggml-python-0.0.7/ggml/experimental.py` & `ggml-python-0.0.8/ggml/experimental.py`

 * *Files 1% similar despite different names*

```diff
@@ -824,17 +824,15 @@
     @staticmethod
     def get_rows(a: Tensor, b: Tensor, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
         op = ggml.ggml_get_rows(ctx.context, a.tensor, b.tensor)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
-    def get_rows_back(
-        a: Tensor, b: Tensor, c: Tensor, ctx: Optional[Context] = None
-    ):
+    def get_rows_back(a: Tensor, b: Tensor, c: Tensor, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
         op = ggml.ggml_get_rows_back(ctx.context, a.tensor, b.tensor, c.tensor)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def diag(a: Tensor, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
@@ -968,14 +966,20 @@
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_conv_1d_s1_ph(ctx.context, a.tensor, b.tensor)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
+    def conv_2d_sk_p0(a: Tensor, b: Tensor, ctx: Optional[Context] = None):
+        ctx = ctx or default_context()
+        op = ggml.ggml_conv_2d_sk_p0(ctx.context, a.tensor, b.tensor)
+        return Tensor(tensor=op, ctx=ctx)
+
+    @staticmethod
     def conv_1d_s2_ph(
         a: Tensor,
         b: Tensor,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_conv_1d_s2_ph(ctx.context, a.tensor, b.tensor)
@@ -1059,16 +1063,16 @@
 
 
 class CGraph:
     def __init__(self, cgraph: ggml.ggml_cgraph, ctx: Optional[Context] = None):
         self.cgraph = cgraph
         self.ctx = ctx or default_context()
 
-    def compute(self):
-        ggml.ggml_graph_compute(self.ctx.context, ctypes.pointer(self.cgraph))
+    def compute(self, n_threads: int = 1):
+        ggml.ggml_graph_compute_with_ctx(self.ctx.context, ctypes.pointer(self.cgraph), n_threads=n_threads)
 
     def reset(self):
         ggml.ggml_graph_reset(ctypes.pointer(self.cgraph))
 
     def get_tensor(self, name: bytes):
         return Tensor(
             tensor=ggml.ggml_graph_get_tensor(ctypes.pointer(self.cgraph), name),
@@ -1097,17 +1101,15 @@
         )
 
     @classmethod
     def build_forward(cls, tensor: Tensor):
         return CGraph(cgraph=ggml.ggml_build_forward(tensor.tensor), ctx=tensor.ctx)
 
     @classmethod
-    def build_backward(
-        cls, forward: CGraph, keep: bool, ctx: Optional[Context] = None
-    ):
+    def build_backward(cls, forward: CGraph, keep: bool, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
         return CGraph(
             cgraph=ggml.ggml_build_backward(
                 ctx.context, ctypes.pointer(forward.cgraph), ctypes.c_bool(keep)
             )
         )
```

### Comparing `ggml-python-0.0.7/ggml/ggml.py` & `ggml-python-0.0.8/ggml/ggml.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,17 +1,19 @@
-"""Low-level [ctypes](https://docs.python.org/3/library/ctypes.html) interface for ggml.
+"""This module is the core of the ggml-python library, it exposes a low-level [ctypes](https://docs.python.org/3/library/ctypes.html)-based interface for ggml.
 
-Functions in this module are named as in the original C library.
-This module does not perform additional checks on the input parameters or memory management for the ggml objects created by the library.
+Structures and functions in the `ggml.ggml` module map directly to the original ggml C library and
+they operate at a fairly low level.
+No additional runtime checks checks are performed nor is memory management handled automatically.
+You've been warned :).
 
-Some things to keep in mind when using this module:
+With that in mind here are some useful things to keep in mind
 
 - Functions accept both ctypes types (c_int, c_bool, c_float, etc.) and Python types (int, bool, float, etc.) as parameters.
-- Functions return Python types for simple values (int, bool, float, etc.) and ctypes types for complex values (ggml_context_p, ggml_tensor_p, etc.).
-- Memory management is the responsibility of the user. The user must call `ggml_free` on the context after calling `ggml_init`.
+- Functions return Python types for simple values (int, bool, float, etc.) and ctypes types for complex values ([ggml_context_p][ggml.ggml_context_p], [ggml_tensor_p][ggml.ggml_tensor_p], etc.).
+- Memory management is the responsibility of the user. The user must call [ggml.ggml_free][] on the context after calling [ggml.ggml_init][].
 
 Example
 
 ```python
 import ggml
 import ctypes
 
@@ -32,15 +34,15 @@
 
 # Set the input values
 ggml.ggml_set_f32(x, 2.0)
 ggml.ggml_set_f32(a, 3.0)
 ggml.ggml_set_f32(b, 4.0)
 
 # Compute the graph
-ggml.ggml_graph_compute(ctx, ctypes.pointer(gf))
+ggml.ggml_graph_compute_with_ctx(ctx, ctypes.pointer(gf), 1)
 
 # Get the output value
 output = ggml.ggml_get_f32_1d(f, 0)
 assert output == 16.0
 
 # Free the context
 ggml.ggml_free(ctx)
@@ -48,15 +50,15 @@
 
 """
 import os
 import sys
 import ctypes
 import pathlib
 import importlib.resources
-from typing import List, Optional, Union
+from typing import List, Optional, Sequence, Union
 from typing_extensions import TypeAlias
 
 
 # Load the library
 def load_shared_library(module_name: str, lib_base_name: str):
     # Construct the paths to the possible shared library names
     base_path = pathlib.Path(__file__).parent.resolve()
@@ -120,21 +122,25 @@
 GGML_MAX_DIMS = 4
 # #define GGML_MAX_NODES         4096
 GGML_MAX_NODES = 4096
 # #define GGML_MAX_PARAMS        256
 GGML_MAX_PARAMS = 256
 # #define GGML_MAX_CONTEXTS      64
 GGML_MAX_CONTEXTS = 64
-# #define GGML_MAX_OPT           4
-GGML_MAX_OPT = 4
+# #define GGML_MAX_SRC           6
+GGML_MAX_SRC = 6
 # #define GGML_MAX_NAME          48
 GGML_MAX_NAME = 48
 # #define GGML_DEFAULT_N_THREADS 4
 GGML_DEFAULT_N_THREADS = 4
 
+# #define GGML_EXIT_SUCCESS 0
+GGML_EXIT_SUCCESS = 0
+# #define GGML_EXIT_ABORTED 1
+GGML_EXIT_ABORTED = 1
 
 # TODO: Check if this is correct
 # typedef uint16_t ggml_fp16_t;
 ggml_fp16_t = ctypes.c_uint16
 
 
 # GGML_API float       ggml_fp16_to_fp32(ggml_fp16_t x);
@@ -155,46 +161,49 @@
 lib.ggml_fp32_to_fp16.restype = ggml_fp16_t
 
 
 # GGML_API void ggml_fp16_to_fp32_row(const ggml_fp16_t * x, float * y, size_t n);
 def ggml_fp16_to_fp32_row(
     x,  # type: ctypes.Array[ggml_fp16_t]
     y,  # type: ctypes.Array[ctypes.c_float]
-    n: ctypes.c_size_t,
+    n: Union[ctypes.c_int, int],
 ) -> None:
     return lib.ggml_fp16_to_fp32_row(x, y, n)
 
 
 lib.ggml_fp16_to_fp32_row.argtypes = [
     ctypes.POINTER(ggml_fp16_t),
     ctypes.POINTER(ctypes.c_float),
-    ctypes.c_size_t,
+    ctypes.c_int,
 ]
 lib.ggml_fp16_to_fp32_row.restype = None
 
 
 # GGML_API void ggml_fp32_to_fp16_row(const float * x, ggml_fp16_t * y, size_t n);
 def ggml_fp32_to_fp16_row(
     x,  # type: ctypes.Array[ctypes.c_float]
     y,  # type: ctypes.Array[ggml_fp16_t]
-    n: ctypes.c_size_t,
+    n: Union[ctypes.c_int, int],
 ) -> None:
     return lib.ggml_fp32_to_fp16_row(x, y, n)
 
 
 lib.ggml_fp32_to_fp16_row.argtypes = [
     ctypes.POINTER(ctypes.c_float),
     ctypes.POINTER(ggml_fp16_t),
-    ctypes.c_size_t,
+    ctypes.c_int,
 ]
 lib.ggml_fp32_to_fp16_row.restype = None
 
 
 # struct ggml_context;
 ggml_context_p = ctypes.c_void_p
+"""Opaque pointer to a ggml_context.
+
+ggml_context structs are not accessed directly instead they must be created using [ggml_init](ggml.ggml_init) and freed using [ggml_free](ggml.ggml_free)."""
 
 
 # enum ggml_type {
 #     GGML_TYPE_F32  = 0,
 #     GGML_TYPE_F16  = 1,
 #     GGML_TYPE_Q4_0 = 2,
 #     GGML_TYPE_Q4_1 = 3,
@@ -291,20 +300,23 @@
 #     GGML_OP_DIV,
 #     GGML_OP_SQR,
 #     GGML_OP_SQRT,
 #     GGML_OP_LOG,
 #     GGML_OP_SUM,
 #     GGML_OP_SUM_ROWS,
 #     GGML_OP_MEAN,
+#     GGML_OP_ARGMAX,
 #     GGML_OP_REPEAT,
 #     GGML_OP_REPEAT_BACK,
 #     GGML_OP_ABS,
 #     GGML_OP_SGN,
 #     GGML_OP_NEG,
 #     GGML_OP_STEP,
+#     GGML_OP_TANH,
+#     GGML_OP_ELU,
 #     GGML_OP_RELU,
 #     GGML_OP_GELU,
 #     GGML_OP_GELU_QUICK,
 #     GGML_OP_SILU,
 #     GGML_OP_SILU_BACK,
 #     GGML_OP_NORM, // normalize
 #     GGML_OP_RMS_NORM,
@@ -328,17 +340,18 @@
 #     GGML_OP_DIAG_MASK_ZERO,
 #     GGML_OP_SOFT_MAX,
 #     GGML_OP_SOFT_MAX_BACK,
 #     GGML_OP_ROPE,
 #     GGML_OP_ROPE_BACK,
 #     GGML_OP_ALIBI,
 #     GGML_OP_CLAMP,
-#     GGML_OP_CONV_1D_1S_PH,
-#     GGML_OP_CONV_1D_2S_PH,
-#     GGML_OP_CONV_2D_SK_P0,
+#     GGML_OP_CONV_1D,
+#     GGML_OP_CONV_2D,
+#     GGML_OP_POOL_1D,
+#     GGML_OP_POOL_2D,
 
 #     GGML_OP_FLASH_ATTN,
 #     GGML_OP_FLASH_FF,
 #     GGML_OP_FLASH_ATTN_BACK,
 #     GGML_OP_WIN_PART,
 #     GGML_OP_WIN_UNPART,
 
@@ -364,65 +377,69 @@
 GGML_OP_DIV = 7
 GGML_OP_SQR = 8
 GGML_OP_SQRT = 9
 GGML_OP_LOG = 10
 GGML_OP_SUM = 11
 GGML_OP_SUM_ROWS = 12
 GGML_OP_MEAN = 13
-GGML_OP_REPEAT = 14
-GGML_OP_REPEAT_BACK = 15
-GGML_OP_ABS = 16
-GGML_OP_SGN = 17
-GGML_OP_NEG = 18
-GGML_OP_STEP = 19
-GGML_OP_RELU = 20
-GGML_OP_GELU = 21   
-GGML_OP_GELU_QUICK = 22
-GGML_OP_SILU = 23
-GGML_OP_SILU_BACK = 24
-GGML_OP_NORM = 25
-GGML_OP_RMS_NORM = 26
-GGML_OP_RMS_NORM_BACK = 27
-GGML_OP_MUL_MAT = 28
-GGML_OP_OUT_PROD = 29
-GGML_OP_SCALE = 30
-GGML_OP_SET = 31
-GGML_OP_CPY = 32
-GGML_OP_CONT = 33
-GGML_OP_RESHAPE = 34
-GGML_OP_VIEW = 35
-GGML_OP_PERMUTE = 36
-GGML_OP_TRANSPOSE = 37
-GGML_OP_GET_ROWS = 38
-GGML_OP_GET_ROWS_BACK = 39
-GGML_OP_DIAG = 40
-GGML_OP_DIAG_MASK_INF = 41
-GGML_OP_DIAG_MASK_ZERO = 42
-GGML_OP_SOFT_MAX = 43
-GGML_OP_SOFT_MAX_BACK = 44
-GGML_OP_ROPE = 45
-GGML_OP_ROPE_BACK = 46
-GGML_OP_ALIBI = 47
-GGML_OP_CLAMP = 48
-GGML_OP_CONV_1D_1S_PH = 49
-GGML_OP_CONV_1D_2S_PH = 50
-GGML_OP_CONV_2D_SK_P0 = 51
-GGML_OP_FLASH_ATTN = 52
-GGML_OP_FLASH_FF = 53
-GGML_OP_FLASH_ATTN_BACK = 54
-GGML_OP_WIN_PART = 55
-GGML_OP_WIN_UNPART = 56
-GGML_OP_MAP_UNARY = 57
-GGML_OP_MAP_BINARY = 58
-GGML_OP_MAP_CUSTOM1 = 59
-GGML_OP_MAP_CUSTOM2 = 60
-GGML_OP_MAP_CUSTOM3 = 61
-GGML_OP_CROSS_ENTROPY_LOSS = 62
-GGML_OP_CROSS_ENTROPY_LOSS_BACK = 63
-GGML_OP_COUNT = 64
+GGML_OP_ARGMAX = 14
+GGML_OP_REPEAT = 15
+GGML_OP_REPEAT_BACK = 16
+GGML_OP_ABS = 17
+GGML_OP_SGN = 18
+GGML_OP_NEG = 19
+GGML_OP_STEP = 20
+GGML_OP_TANH = 21
+GGML_OP_ELU = 22
+GGML_OP_RELU = 23
+GGML_OP_GELU = 24
+GGML_OP_GELU_QUICK = 25
+GGML_OP_SILU = 26
+GGML_OP_SILU_BACK = 27
+GGML_OP_NORM = 28
+GGML_OP_RMS_NORM = 29
+GGML_OP_RMS_NORM_BACK = 30
+GGML_OP_MUL_MAT = 31
+GGML_OP_OUT_PROD = 32
+GGML_OP_SCALE = 33
+GGML_OP_SET = 34
+GGML_OP_CPY = 35
+GGML_OP_CONT = 36
+GGML_OP_RESHAPE = 37
+GGML_OP_VIEW = 38
+GGML_OP_PERMUTE = 39
+GGML_OP_TRANSPOSE = 40
+GGML_OP_GET_ROWS = 41
+GGML_OP_GET_ROWS_BACK = 42
+GGML_OP_DIAG = 43
+GGML_OP_DIAG_MASK_INF = 44
+GGML_OP_DIAG_MASK_ZERO = 45
+GGML_OP_SOFT_MAX = 46
+GGML_OP_SOFT_MAX_BACK = 47
+GGML_OP_ROPE = 48
+GGML_OP_ROPE_BACK = 49
+GGML_OP_ALIBI = 50
+GGML_OP_CLAMP = 51
+GGML_OP_CONV_1D = 52
+GGML_OP_CONV_2D = 53
+GGML_OP_POOL_1D = 54
+GGML_OP_POOL_2D = 55
+GGML_OP_FLASH_ATTN = 56
+GGML_OP_FLASH_FF = 57
+GGML_OP_FLASH_ATTN_BACK = 58
+GGML_OP_WIN_PART = 59
+GGML_OP_WIN_UNPART = 60
+GGML_OP_MAP_UNARY = 61
+GGML_OP_MAP_BINARY = 62
+GGML_OP_MAP_CUSTOM1 = 63
+GGML_OP_MAP_CUSTOM2 = 64
+GGML_OP_MAP_CUSTOM3 = 65
+GGML_OP_CROSS_ENTROPY_LOSS = 66
+GGML_OP_CROSS_ENTROPY_LOSS_BACK = 67
+GGML_OP_COUNT = 68
 
 # struct ggml_object {
 #     size_t offs;
 #     size_t size;
 
 #     struct ggml_object * next;
 
@@ -459,123 +476,172 @@
 
 #     // compute data
 #     enum ggml_op op;
 
 #     bool is_param;
 
 #     struct ggml_tensor * grad;
-#     struct ggml_tensor * src0;
-#     struct ggml_tensor * src1;
-#     struct ggml_tensor * opt[GGML_MAX_OPT];
-
-#     // thread scheduling
-#     int n_tasks;
+#     struct ggml_tensor * src[GGML_MAX_SRC];
 
 #     // performance
 #     int     perf_runs;
 #     int64_t perf_cycles;
 #     int64_t perf_time_us;
 
 #     void * data;
 
 #     char name[GGML_MAX_NAME];
 
 #     void * extra; // extra things e.g. for ggml-cuda.cu
 
 
-#     char padding[4];
+#     char padding[8];
 # };
 class ggml_tensor(ctypes.Structure):
     """n-dimensional tensor
 
     Attributes:
         type (int): ggml_type
         backend (int): ggml_backend
         n_dims (int): number of dimensions
-        ne (int64_t * GGML_MAX_DIMS): number of elements in each dimension
-        nb (size_t * GGML_MAX_DIMS): stride in bytes for each dimension
+        ne (ctypes.Array[ctypes.c_int64]): number of elements in each dimension
+        nb (ctypes.Array[ctypes.c_size_t]): stride in bytes for each dimension
         op (int): ggml operation
         is_param (bool): is this a parameter tensor
         grad (ggml_tensor_p): reference to gradient tensor
-        src0 (ggml_tensor_p): reference to source tensor 0
-        src1 (ggml_tensor_p): reference to source tensor 1
-        opt (ggml_tensor_p * GGML_MAX_OPT): optimization tensors
-        n_tasks (int): number of tasks
+        src (ctypes.Array[ggml_tensor_p]): `GGML_MAX_SRC`-length array of source tensors
         perf_runs (int): number of performance runs
-        perf_cycles (int64_t): number of cycles
-        perf_time_us (int64_t): time in microseconds
-        data (void_p): reference to raw tensor data
-        name (char * GGML_MAX_NAME): name of tensor
-        extra (void_p): extra data (e.g. for CUDA)
+        perf_cycles (int): number of cycles
+        perf_time_us (int): time in microseconds
+        data (ctypes.c_void_p): reference to raw tensor data
+        name (bytes): name of tensor
+        extra (ctypes.c_void_p): extra data (e.g. for CUDA)
     """
 
     pass
 
 
 ggml_tensor._fields_ = [
     ("type", ctypes.c_int),
     ("backend", ctypes.c_int),
     ("n_dims", ctypes.c_int),
     ("ne", ctypes.c_int64 * GGML_MAX_DIMS),
     ("nb", ctypes.c_size_t * GGML_MAX_DIMS),
     ("op", ctypes.c_int),
     ("is_param", ctypes.c_bool),
     ("grad", ctypes.POINTER(ggml_tensor)),
-    ("src0", ctypes.POINTER(ggml_tensor)),
-    ("src1", ctypes.POINTER(ggml_tensor)),
-    ("opt", ctypes.POINTER(ggml_tensor) * GGML_MAX_OPT),
-    ("n_tasks", ctypes.c_int),
+    ("src", ctypes.POINTER(ggml_tensor) * GGML_MAX_SRC),
     ("perf_runs", ctypes.c_int),
     ("perf_cycles", ctypes.c_int64),
     ("perf_time_us", ctypes.c_int64),
     ("data", ctypes.c_void_p),
     ("name", ctypes.c_char * GGML_MAX_NAME),
     ("extra", ctypes.c_void_p),
-    ("padding", ctypes.c_char * 4),
+    ("padding", ctypes.c_char * 8),
 ]
 
 GGML_TENSOR_SIZE = ctypes.sizeof(ggml_tensor)
 
 ggml_tensor_p: TypeAlias = "ctypes._Pointer[ggml_tensor]"  # type: ignore
+"""ctypes pointer to a [ggml_tensor][ggml.ggml_tensor]
+
+Can be dereferenced to a [ggml_tensor][ggml.ggml_tensor] object using
+the `.contents` attribute."""
+
+# // the compute plan that needs to be prepared for ggml_graph_compute()
+# // since https://github.com/ggerganov/ggml/issues/287
+# struct ggml_cplan {
+#     size_t    work_size; // size of work buffer, calculated by `ggml_graph_plan()`
+#     uint8_t * work_data; // work buffer, to be allocated by caller before calling to `ggml_graph_compute()`
+
+#     int n_threads;
+
+#     // the `n_tasks` of nodes, 1:1 mapping to cgraph nodes
+#     int n_tasks[GGML_MAX_NODES];
+
+#     // abort ggml_graph_compute when true
+#     bool (*abort_callback)(void * data);
+#     void * abort_callback_data;
+# };
+class ggml_cplan(ctypes.Structure):
+    """Compute plan for a ggml computation graph
+
+    Attributes:
+        work_size (int): size of work buffer
+        work_data (ctypes.c_void_p): work buffer
+        n_threads (int): number of threads to use when computing the graph using [ggml_graph_compute][ggml.ggml_graph_compute]
+        n_tasks (ctypes.Array[ctypes.c_int]): `n_tasks` of nodes, 1:1 mapping to cgraph nodes
+        abort_callback (ctypes.CFUNCTYPE[ctypes.c_bool, ctypes.c_void_p]): abort callback
+        abort_callback_data (ctypes.c_void_p): abort callback data
+    """
+
+    _fields_ = [
+        ("work_size", ctypes.c_size_t),
+        ("work_data", ctypes.c_void_p),
+        ("n_threads", ctypes.c_int),
+        ("n_tasks", ctypes.c_int * GGML_MAX_NODES),
+        (
+            "abort_callback",
+            ctypes.CFUNCTYPE(ctypes.c_bool, ctypes.c_void_p),
+        ),
+        ("abort_callback_data", ctypes.c_void_p),
+    ]
+
+GGML_CPLAN_SIZE = ctypes.sizeof(ggml_cplan)
+
+ggml_cplan_p: TypeAlias = "ctypes._Pointer[ggml_cplan]"  # type: ignore
+"""ctypes pointer to a [ggml_cplan][ggml.ggml_cplan]
+
+Can be dereferenced to a [ggml_cplan][ggml.ggml_cplan] object using
+the `.contents` attribute."""
 
 # // computation graph
 # struct ggml_cgraph {
 #     int n_nodes;
 #     int n_leafs;
-#     int n_threads;
-
-#     size_t work_size;
-#     struct ggml_tensor * work;
 
 #     struct ggml_tensor * nodes[GGML_MAX_NODES];
 #     struct ggml_tensor * grads[GGML_MAX_NODES];
 #     struct ggml_tensor * leafs[GGML_MAX_NODES];
 
 
 #     // performance
 #     int     perf_runs;
 #     int64_t perf_cycles;
 #     int64_t perf_time_us;
 # };
 class ggml_cgraph(ctypes.Structure):
+    """ggml computation graph
+    
+    Attributes:
+        n_nodes (int): number of nodes
+        n_leafs (int): number of leafs
+        nodes (ctypes.Array[ggml_tensor_p]): `n_nodes`-length array of compute tensors
+        grads (ctypes.Array[ggml_tensor_p]): `n_nodes`-length array of gradient tensors
+        leafs (ctypes.Array[ggml_tensor_p]): `n_leafs`-length array of parameter tensors
+        perf_runs (int): number of runs
+        perf_cycles (int): number of cycles
+        perf_time_us (int): computation time in microseconds"""
+
     _fields_ = [
         ("n_nodes", ctypes.c_int),
         ("n_leafs", ctypes.c_int),
-        ("n_threads", ctypes.c_int),
-        ("work_size", ctypes.c_size_t),
-        ("work", ctypes.POINTER(ggml_tensor)),
         ("nodes", ctypes.POINTER(ggml_tensor) * GGML_MAX_NODES),
         ("grads", ctypes.POINTER(ggml_tensor) * GGML_MAX_NODES),
         ("leafs", ctypes.POINTER(ggml_tensor) * GGML_MAX_NODES),
         ("perf_runs", ctypes.c_int),
         ("perf_cycles", ctypes.c_int64),
         ("perf_time_us", ctypes.c_int64),
     ]
 
 ggml_cgraph_p: TypeAlias = "ctypes._Pointer[ggml_cgraph]"  # type: ignore
+"""ctypes pointer to a [ggml_cgraph][ggml.ggml_cgraph]
+
+Can be dereferenced to a [ggml_cgraph][ggml.ggml_cgraph] object using
+the `.contents` attribute."""
 
 
 # struct ggml_scratch {
 #     size_t offs;
 #     size_t size;
 #     void * data;
 # };
@@ -598,26 +664,29 @@
 
     **NOTE**: Reference counting does not cross into ggml, if you allocate a memory buffer
     in python using ctypes Arrays or a numpy array, you must keep a reference to it until
     you free the ggml context otherwise you will encounter a segmentation fault. 
 
     Attributes:
         mem_size (int): size of memory pool in bytes
-        mem_buffer (void_p): pointer to memory pool, if None, memory will be allocated internally
+        mem_buffer (ctypes.c_void_p): pointer to memory pool, if None, memory will be allocated internally
         no_alloc (bool): don't allocate memory for tensor data
     """
 
     _fields_ = [
         ("mem_size", ctypes.c_size_t),
         ("mem_buffer", ctypes.c_void_p),
         ("no_alloc", ctypes.c_bool),
     ]
 
 
 # // compute types
+
+# // NOTE: the INIT or FINALIZE pass is not scheduled unless explicitly enabled.
+# // This behavior was changed since https://github.com/ggerganov/llama.cpp/pull/1995.
 # enum ggml_task_type {
 #     GGML_TASK_INIT = 0,
 #     GGML_TASK_COMPUTE,
 #     GGML_TASK_FINALIZE,
 # };
 GGML_TASK_INIT = 0
 GGML_TASK_COMPUTE = 1
@@ -639,14 +708,15 @@
         ("type", ctypes.c_int),
         ("ith", ctypes.c_int),
         ("nth", ctypes.c_int),
         ("wsize", ctypes.c_size_t),
         ("wdata", ctypes.c_void_p),
     ]
 
+# // misc
 
 # GGML_API void    ggml_time_init(void); // call this once at the beginning of the program
 def ggml_time_init():
     return lib.ggml_time_init()
 
 
 lib.ggml_time_init.argtypes = []
@@ -719,37 +789,58 @@
 lib.ggml_print_objects.argtypes = [ggml_context_p]
 lib.ggml_print_objects.restype = None
 
 
 # GGML_API int64_t ggml_nelements   (const struct ggml_tensor * tensor);
 def ggml_nelements(
     tensor: ggml_tensor_p,  
-) -> int:  
+) -> int:
+    """Get the number of elements in a tensor
+    
+    Parameters:
+        tensor: tensor
+    
+    Returns:
+        number of elements"""
     return lib.ggml_nelements(tensor)
 
 
 lib.ggml_nelements.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_nelements.restype = ctypes.c_int64
 
 
 # GGML_API int64_t ggml_nrows       (const struct ggml_tensor * tensor);
 def ggml_nrows(
     tensor: ggml_tensor_p,  
-) -> int:  
+) -> int:
+    """Get the number of rows in a tensor
+
+    Parameters:
+        tensor: tensor
+    
+    Returns:
+        number of rows"""
     return lib.ggml_nrows(tensor)
 
 
 lib.ggml_nrows.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_nrows.restype = ctypes.c_int64
 
 
 # GGML_API size_t  ggml_nbytes      (const struct ggml_tensor * tensor);
 def ggml_nbytes(
     tensor: ggml_tensor_p,  
-) -> int:  
+) -> int:
+    """Get the number of bytes required to store tensor data
+
+    Parameters:
+        tensor: tensor
+    
+    Returns:
+        number of bytes"""
     return lib.ggml_nbytes(tensor)
 
 
 lib.ggml_nbytes.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_nbytes.restype = ctypes.c_size_t
 
 
@@ -839,47 +930,72 @@
 lib.ggml_ftype_to_ggml_type.argtypes = [ctypes.c_int]
 lib.ggml_ftype_to_ggml_type.restype = ctypes.c_int
 
 
 # GGML_API bool ggml_is_transposed(const struct ggml_tensor * tensor);
 def ggml_is_transposed(
     tensor: ggml_tensor_p,  
-) -> bool:  
+) -> bool:
+    """Check if a tensor is transposed
+    
+    Parameters:
+        tensor: tensor
+    
+    Returns:
+        True if tensor is transposed else False"""
     return lib.ggml_is_transposed(tensor)
 
 
 lib.ggml_is_transposed.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_is_transposed.restype = ctypes.c_bool
 
 
 # GGML_API bool ggml_is_contiguous(const struct ggml_tensor * tensor);
 def ggml_is_contiguous(
     tensor: ggml_tensor_p,  
-) -> bool:  
+) -> bool:
+    """Check if a tensor is contiguous
+
+    Parameters:
+        tensor: tensor
+
+    Returns:
+        True if tensor is contiguous else False"""
     return lib.ggml_is_contiguous(tensor)
 
 
 lib.ggml_is_contiguous.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_is_contiguous.restype = ctypes.c_bool
 
 
 # GGML_API bool ggml_is_permuted  (const struct ggml_tensor * tensor);
 def ggml_is_permuted(
     tensor: ggml_tensor_p,  
-) -> bool:  
+) -> bool:
+    """Check if a tensor is permuted
+
+    Parameters:
+        tensor: tensor
+
+    Returns:
+        True if tensor is permuted else False"""
     return lib.ggml_is_permuted(tensor)
 
 
 lib.ggml_is_permuted.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_is_permuted.restype = ctypes.c_bool
 
 
 # // use this to compute the memory overhead of a tensor
 # GGML_API size_t ggml_tensor_overhead(void);
 def ggml_tensor_overhead() -> int:
+    """Overhead required for a tensor struct in bytes
+    
+    Returns:
+        size of tensor struct in bytes"""
     return lib.ggml_tensor_overhead()
 
 
 lib.ggml_tensor_overhead.argtypes = []
 lib.ggml_tensor_overhead.restype = ctypes.c_size_t
 
 # // main
@@ -903,25 +1019,34 @@
 
 lib.ggml_init.argtypes = [ggml_init_params]
 lib.ggml_init.restype = ggml_context_p
 
 
 # GGML_API void                  ggml_free(struct ggml_context * ctx);
 def ggml_free(ctx: ggml_context_p):
-    """Free the ggml context."""
+    """Free the ggml context.
+    
+    Parameters:
+        ctx: ggml context"""
     return lib.ggml_free(ctx)
 
 
 lib.ggml_free.argtypes = [ggml_context_p]
 lib.ggml_free.restype = None
 
 
 # GGML_API size_t  ggml_used_mem(const struct ggml_context * ctx);
 def ggml_used_mem(ctx: ggml_context_p) -> int:
-    """Return the amount of memory used by the ggml context in bytes."""
+    """Return the amount of memory used by the ggml context in bytes.
+    
+    Parameters:
+        ctx: ggml context
+    
+    Returns:
+        amount of memory used in bytes"""
     return lib.ggml_used_mem(ctx)
 
 
 lib.ggml_used_mem.argtypes = [ggml_context_p]
 lib.ggml_used_mem.restype = ctypes.c_size_t
 
 
@@ -988,15 +1113,15 @@
 ) -> ggml_tensor_p:  
     """Create a new tensor with the given type, number of dimensions, and number of elements in each dimension.
     
     Parameters:
         ctx: ggml context
         type: ggml type
         n_dims: number of dimensions
-        ne: number of elements in each dimension
+        ne (ctypes.Array[ctypes.c_int64]): number of elements in each dimension (array of length n_dims)
     
     Returns:
         Pointer to ggml_tensor"""
     return lib.ggml_new_tensor(ctx, type, n_dims, ne)
 
 
 lib.ggml_new_tensor.argtypes = [
@@ -1179,97 +1304,158 @@
 lib.ggml_new_f32.argtypes = [ggml_context_p, ctypes.c_float]
 lib.ggml_new_f32.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_dup_tensor (struct ggml_context * ctx, const struct ggml_tensor * src);
 def ggml_dup_tensor(
     ctx: ggml_context_p, src: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Create a new tensor with the same type and dimensions as the source tensor.
+    
+    Parameters:
+        ctx: ggml context
+        src: source tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_dup_tensor(ctx, src)
 
 
 lib.ggml_dup_tensor.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_dup_tensor.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_view_tensor(struct ggml_context * ctx, const struct ggml_tensor * src);
 def ggml_view_tensor(
     ctx: ggml_context_p, src: ggml_tensor_p  
 ) -> ggml_tensor_p:
+    """Create a new tensor with the same type, dimensions and data as the source tensor.
+
+    Parameters:
+        ctx: ggml context
+        src: source tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_view_tensor(ctx, src)
 
 
 lib.ggml_view_tensor.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_view_tensor.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_get_tensor(struct ggml_context * ctx, const char * name);
 def ggml_get_tensor(
     ctx: ggml_context_p, name: bytes
 ) -> ggml_tensor_p:
+    """Get a tensor from the ggml context by name.
+    
+    Parameters:
+        ctx: ggml context
+        name: name of tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_get_tensor(ctx, name)
 
 
 lib.ggml_get_tensor.argtypes = [ggml_context_p, ctypes.c_char_p]
 lib.ggml_get_tensor.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_set_zero(struct ggml_tensor * tensor);
 def ggml_set_zero(
     tensor: ggml_tensor_p,  
 ) -> ggml_tensor_p:
+    """Zero all elements in a tensor.
+    
+    Parameters:
+        tensor: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_set_zero(tensor)
 
 
 lib.ggml_set_zero.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_set_zero.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_set_i32 (struct ggml_tensor * tensor, int32_t value);
 def ggml_set_i32(
     tensor: ggml_tensor_p,  
     value: Union[ctypes.c_int32, int],
 ) -> ggml_tensor_p:
+    """Set all elements in a tensor to the given integer value.
+    
+    Parameters:
+        tensor: tensor
+        value: integer value
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_set_i32(tensor, value)
 
 
 lib.ggml_set_i32.argtypes = [ctypes.POINTER(ggml_tensor), ctypes.c_int32]
 lib.ggml_set_i32.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_set_f32 (struct ggml_tensor * tensor, float value);
 def ggml_set_f32(
     tensor: ggml_tensor_p,  
     value: Union[ctypes.c_float, float],
 ) -> ggml_tensor_p:
+    """Set all elements in a tensor to the given float value.
+    
+    Parameters:
+        tensor: tensor
+        value: float value
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_set_f32(tensor, value)
 
 
 lib.ggml_set_f32.argtypes = [ctypes.POINTER(ggml_tensor), ctypes.c_float]
 lib.ggml_set_f32.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API int32_t ggml_get_i32_1d(const struct ggml_tensor * tensor, int i);
 def ggml_get_i32_1d(
     tensor: ggml_tensor_p,  
     i: Union[ctypes.c_int, int],
 ) -> int:
+    """Get the integer value of the i-th element in a 1-dimensional tensor.
+    
+    Parameters:
+        tensor: tensor
+        i: index of element
+
+    Returns:
+        integer value of element at index i"""
     return lib.ggml_get_i32_1d(tensor, i)
 
 
 lib.ggml_get_i32_1d.argtypes = [ctypes.POINTER(ggml_tensor), ctypes.c_int]
 lib.ggml_get_i32_1d.restype = ctypes.c_int32
 
 
 # GGML_API void    ggml_set_i32_1d(const struct ggml_tensor * tensor, int i, int32_t value);
 def ggml_set_i32_1d(
     tensor: ggml_tensor_p,  
     i: Union[ctypes.c_int, int],
     value: Union[ctypes.c_int32, int],
 ):
+    """Set the integer value of the i-th element in a 1-dimensional tensor.
+
+    Parameters:
+        tensor: tensor
+        i: index of element
+        value: integer value to set element to"""
     return lib.ggml_set_i32_1d(tensor, i, value)
 
 
 lib.ggml_set_i32_1d.argtypes = [
     ctypes.POINTER(ggml_tensor),
     ctypes.c_int,
     ctypes.c_int32,
@@ -1278,27 +1464,40 @@
 
 
 # GGML_API float   ggml_get_f32_1d(const struct ggml_tensor * tensor, int i);
 def ggml_get_f32_1d(
     tensor: ggml_tensor_p,  
     i: Union[ctypes.c_int, int],
 ) -> float:
+    """Get the float value of the i-th element in a 1-dimensional tensor.
+    
+    Parameters:
+        tensor: tensor
+
+    Returns:
+        float value of element at index i"""
     return lib.ggml_get_f32_1d(tensor, i)
 
 
 lib.ggml_get_f32_1d.argtypes = [ctypes.POINTER(ggml_tensor), ctypes.c_int]
 lib.ggml_get_f32_1d.restype = ctypes.c_float
 
 
 # GGML_API void    ggml_set_f32_1d(const struct ggml_tensor * tensor, int i, float value);
 def ggml_set_f32_1d(
     tensor: ggml_tensor_p,  
     i: Union[ctypes.c_int, int],
     value: Union[ctypes.c_float, float],
 ):
+    """Set the float value of the i-th element in a 1-dimensional tensor.
+
+    Parameters:
+        tensor: tensor
+        i: index of element
+        value: float value to set element to"""
     return lib.ggml_set_f32_1d(tensor, i, value)
 
 
 lib.ggml_set_f32_1d.argtypes = [
     ctypes.POINTER(ggml_tensor),
     ctypes.c_int,
     ctypes.c_float,
@@ -1306,66 +1505,108 @@
 lib.ggml_set_f32_1d.restype = None
 
 
 # GGML_API void *  ggml_get_data    (const struct ggml_tensor * tensor);
 def ggml_get_data(
     tensor: ggml_tensor_p,  
 ) -> Optional[ctypes.c_void_p]:
+    """Get the data pointer of a tensor.
+    
+    Parameters:
+        tensor: tensor
+
+    Returns:
+        Pointer to data, or None if tensor has no data"""
     return lib.ggml_get_data(tensor)
 
 
 lib.ggml_get_data.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_get_data.restype = ctypes.c_void_p
 
 
 # GGML_API float * ggml_get_data_f32(const struct ggml_tensor * tensor);
 def ggml_get_data_f32(
     tensor: ggml_tensor_p,  
-):  # type: (...) -> ctypes.Array[ctypes.c_float] # type: ignore
+):  # type: (...) -> Optional[ctypes.Array[ctypes.c_float]] # type: ignore
+    """Get the data pointer of a tensor as a float array.
+    
+    Parameters:
+        tensor: tensor
+
+    Returns:
+        (Optional[ctypes.Array[ctypes.c_float]]): array of float to data, or None if tensor has no data"""
     return lib.ggml_get_data_f32(tensor)
 
 
 lib.ggml_get_data_f32.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_get_data_f32.restype = ctypes.POINTER(ctypes.c_float)
 
 
 # GGML_API const char *         ggml_get_name(const struct ggml_tensor * tensor);
 def ggml_get_name(
     tensor: ggml_tensor_p,  
 ) -> bytes:
+    """Get the name of a tensor.
+
+    Parameters:
+        tensor: tensor
+
+    Returns:
+        name of tensor"""
     return lib.ggml_get_name(tensor)
 
 
 lib.ggml_get_name.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_get_name.restype = ctypes.c_char_p
 
 
 # GGML_API struct ggml_tensor * ggml_set_name(struct ggml_tensor * tensor, const char * name);
 def ggml_set_name(
     tensor: ggml_tensor_p,  
     name: bytes,
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Set the name of a tensor.
+
+    Parameters:
+        tensor: tensor
+        name: name to set tensor to
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_set_name(tensor, name)
 
 
 lib.ggml_set_name.argtypes = [ctypes.POINTER(ggml_tensor), ctypes.c_char_p]
 lib.ggml_set_name.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_format_name(struct ggml_tensor * tensor, const char * fmt, ...);
 def ggml_format_name(
     tensor: ggml_tensor_p,
     fmt: bytes,
-    *args,
+    *args: Sequence[Union[bool, int, float, str]],
 ) -> ggml_tensor_p:
+    """Format the name of a tensor using the given format c string and arguments.
+
+    Parameters:
+        tensor: tensor
+        fmt: format c string
+        args: arguments to format string
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_format_name(tensor, fmt, *args)
 
 lib.ggml_format_name.argtypes = [ctypes.POINTER(ggml_tensor), ctypes.c_char_p]
 lib.ggml_format_name.restype = ctypes.POINTER(ggml_tensor)
 
+# //
+# // operations on tensors with backpropagation
+# //
+
 # GGML_API struct ggml_tensor * ggml_dup(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_dup(
     ctx: ggml_context_p, a: ggml_tensor_p  
 ) -> ggml_tensor_p:  
     return lib.ggml_dup(ctx, a)
@@ -1380,14 +1621,23 @@
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_add(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Add two tensors together and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: first tensor
+        b: second tensor
+        
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_add(ctx, a, b)
 
 
 lib.ggml_add.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1400,14 +1650,23 @@
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_add_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Add two tensors together and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: first tensor
+        b: second tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_add_inplace(ctx, a, b)
 
 
 lib.ggml_add_inplace.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1524,14 +1783,23 @@
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_sub(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Subtract two tensors and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: first tensor
+        b: second tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sub(ctx, a, b)
 
 
 lib.ggml_sub.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1544,14 +1812,23 @@
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_sub_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Subtract two tensors and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: first tensor
+        b: second tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sub_inplace(ctx, a, b)
 
 
 lib.ggml_sub_inplace.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1564,14 +1841,23 @@
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_mul(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Element-wise multiply two tensors and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: first tensor
+        b: second tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_mul(ctx, a, b)
 
 
 lib.ggml_mul.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1584,14 +1870,23 @@
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_mul_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Element-wise multiply two tensors and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: first tensor
+        b: second tensor
+        
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_mul_inplace(ctx, a, b)
 
 
 lib.ggml_mul_inplace.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1604,14 +1899,23 @@
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_div(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Element-wise divide two tensors and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: first tensor
+        b: second tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_div(ctx, a, b)
 
 
 lib.ggml_div.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1623,15 +1927,24 @@
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_div_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Element-wise divide two tensors and store the result in the first tensor.
+
+    Parameters:
+        ctx: ggml context
+        a: first tensor
+        b: second tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_div_inplace(ctx, a, b)
 
 
 lib.ggml_div_inplace.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1641,144 +1954,249 @@
 
 # GGML_API struct ggml_tensor * ggml_sqr(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sqr(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Square all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sqr(ctx, a)
 
 
 lib.ggml_sqr.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sqr.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_sqr_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sqr_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Square all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sqr_inplace(ctx, a)
 
 
 lib.ggml_sqr_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sqr_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_sqrt(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sqrt(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Square root all elements in a tensor and return the result.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sqrt(ctx, a)
 
 
 lib.ggml_sqrt.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sqrt.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_sqrt_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sqrt_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Square root all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sqrt_inplace(ctx, a)
 
 
 lib.ggml_sqrt_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sqrt_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_log(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_log(
     ctx: ggml_context_p, a: ggml_tensor_p  
 ) -> ggml_tensor_p:  
+    """Take the natural logarithm of all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+    
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_log(ctx, a)
 
 
 lib.ggml_log.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_log.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_log_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_log_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Take the natural logarithm of all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_log_inplace(ctx, a)
 
 
 lib.ggml_log_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_log_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # // return scalar
 # GGML_API struct ggml_tensor * ggml_sum(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sum(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Sum all elements in a tensor and return the result.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sum(ctx, a)
 
 
 lib.ggml_sum.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sum.restype = ctypes.POINTER(ggml_tensor)
 
 
 # // sums along rows, with input shape [a,b,c,d] return shape [1,b,c,d]
 # GGML_API struct ggml_tensor * ggml_sum_rows(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sum_rows(
     ctx: ggml_context_p, a: ggml_tensor_p  
 ) -> ggml_tensor_p:  
+    """Sum all elements in a tensor along the first axis and return the result.
+    
+    sums along rows, with input shape [a,b,c,d] return shape [1,b,c,d]
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sum_rows(ctx, a)
 
 
 lib.ggml_sum_rows.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sum_rows.restype = ctypes.POINTER(ggml_tensor)
 
 
 # // mean along rows
 # GGML_API struct ggml_tensor * ggml_mean(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_mean(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Take the mean of all elements in a tensor and return the result.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_mean(ctx, a)
 
 
 lib.ggml_mean.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_mean.restype = ctypes.POINTER(ggml_tensor)
 
+# // argmax along rows
+# GGML_API struct ggml_tensor * ggml_argmax(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_argmax(
+    ctx: ggml_context_p, a: ggml_tensor_p
+) -> ggml_tensor_p:
+    """Take the argmax of all elements in a tensor and return the result.
+
+    argmax along rows
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+    
+    Returns:
+        Pointer to ggml_tensor"""
+    return lib.ggml_argmax(ctx, a)
+
+lib.ggml_argmax.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_argmax.restype = ctypes.POINTER(ggml_tensor)
 
 # // if a is the same shape as b, and a is not parameter, return a
 # // otherwise, return a new tensor: repeat(a) to fit in b
 # GGML_API struct ggml_tensor * ggml_repeat(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_repeat(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Repeat a tensor to fit the shape of another tensor.
+
+    If a is the same shape as b, and a is not parameter, return a
+
+    Parameters:
+        ctx: ggml context
+        a: tensor to repeat
+        b: tensor to fit
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_repeat(ctx, a, b)
 
 
 lib.ggml_repeat.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -1808,204 +2226,394 @@
 
 # GGML_API struct ggml_tensor * ggml_abs(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_abs(
     ctx: ggml_context_p, a: ggml_tensor_p  
 ) -> ggml_tensor_p:  
+    """Take the absolute value of all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_abs(ctx, a)
 
 
 lib.ggml_abs.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_abs.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_abs_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_abs_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Take the absolute value of all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+        
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_abs_inplace(ctx, a)
 
 
 lib.ggml_abs_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_abs_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_sgn(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sgn(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Get the sign of all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sgn(ctx, a)
 
 
 lib.ggml_sgn.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sgn.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_sgn_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sgn_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Get the sign of all elements in a tensor and store the result in the first tensor.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_sgn_inplace(ctx, a)
 
 
 lib.ggml_sgn_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sgn_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_neg(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_neg(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Negate all elements in a tensor and return the result.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_neg(ctx, a)
 
 
 lib.ggml_neg.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_neg.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_neg_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_neg_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Negate all elements in a tensor and store the result in the first tensor.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_neg_inplace(ctx, a)
 
 
 lib.ggml_neg_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_neg_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_step(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_step(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
     return lib.ggml_step(ctx, a)
 
 
 lib.ggml_step.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_step.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_tanh(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_tanh(
+    ctx: ggml_context_p, a: ggml_tensor_p
+) -> ggml_tensor_p:
+    """Apply the tanh activation function to all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
+    return lib.ggml_tanh(ctx, a)
+
+lib.ggml_tanh.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_tanh.restype = ctypes.POINTER(ggml_tensor)
+
+# GGML_API struct ggml_tensor * ggml_tanh_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_tanh_inplace(
+    ctx: ggml_context_p,
+    a: ggml_tensor_p,
+) -> ggml_tensor_p:
+    """Apply the tanh activation function to all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
+    return lib.ggml_tanh_inplace(ctx, a)
+
+lib.ggml_tanh_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_tanh_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+# GGML_API struct ggml_tensor * ggml_elu(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_elu(
+    ctx: ggml_context_p, a: ggml_tensor_p
+) -> ggml_tensor_p:
+    """Apply the ELU activation function to all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
+    return lib.ggml_elu(ctx, a)
+
+lib.ggml_elu.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_elu.restype = ctypes.POINTER(ggml_tensor)
+
+# GGML_API struct ggml_tensor * ggml_elu_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_elu_inplace(
+    ctx: ggml_context_p,
+    a: ggml_tensor_p,
+) -> ggml_tensor_p:
+    """Apply the ELU activation function to all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
+    return lib.ggml_elu_inplace(ctx, a)
+
+lib.ggml_elu_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_elu_inplace.restype = ctypes.POINTER(ggml_tensor)
+
 # GGML_API struct ggml_tensor * ggml_relu(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_relu(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p: 
+    """Apply the ReLU activation function to all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+        
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_relu(ctx, a)
 
 
 lib.ggml_relu.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_relu.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_relu_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_relu_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Apply the ReLU activation function to all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+    
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_relu_inplace(ctx, a)
 
 
 lib.ggml_relu_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_relu_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # // TODO: double-check this computation is correct
 # GGML_API struct ggml_tensor * ggml_gelu(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_gelu(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Apply the Gaussian Error Linear Unit activation function to all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_gelu(ctx, a)
 
 
 lib.ggml_gelu.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_gelu.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_gelu_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_gelu_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Apply the Gaussian Error Linear Unit activation function to all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+    
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_gelu_inplace(ctx, a)
 
 
 lib.ggml_gelu_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_gelu_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_gelu_quick(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_gelu_quick(
     ctx: ggml_context_p, a: ggml_tensor_p  
 ) -> ggml_tensor_p:  
+    """Apply the Gaussian Error Linear Unit activation function to all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_gelu_quick(ctx, a)
 
 
 lib.ggml_gelu_quick.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_gelu_quick.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_gelu_quick_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_gelu_quick_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Apply the Gaussian Error Linear Unit activation function to all elements in a tensor and store the result in the first tensor.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_gelu_quick_inplace(ctx, a)
 
 
 lib.ggml_gelu_quick_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_gelu_quick_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_silu(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_silu(
     ctx: ggml_context_p, a: ggml_tensor_p  
 ) -> ggml_tensor_p:  
+    """Apply the Sigmoid Linear Unit activation function to all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+    
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_silu(ctx, a)
 
 
 lib.ggml_silu.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_silu.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_silu_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_silu_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Apply the Sigmoid Linear Unit activation function to all elements in a tensor and store the result in the first tensor.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_silu_inplace(ctx, a)
 
 
 lib.ggml_silu_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_silu_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
@@ -2035,55 +2643,95 @@
 # // TODO: eps is hardcoded to 1e-5 for now
 # GGML_API struct ggml_tensor * ggml_norm(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_norm(
     ctx: ggml_context_p, a: ggml_tensor_p  
 ) -> ggml_tensor_p:  
+    """Normalize all elements in a tensor along the first axis and return the result.
+    
+    normalize along rows.
+    
+    NOTE: eps is hardcoded to 1e-5 for now
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_norm(ctx, a)
 
 
 lib.ggml_norm.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_norm.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_norm_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_norm_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Normalize all elements in a tensor along the first axis and store the result in the first tensor.
+    
+    normalize along rows.
+    
+    NOTE: eps is hardcoded to 1e-5 for now
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+        
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_norm_inplace(ctx, a)
 
 
 lib.ggml_norm_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_norm_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_rms_norm(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_rms_norm(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Compute the root mean square of all elements in a tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_rms_norm(ctx, a)
 
 
 lib.ggml_rms_norm.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_rms_norm.restype = ctypes.POINTER(ggml_tensor)
 
 
 # GGML_API struct ggml_tensor * ggml_rms_norm_inplace(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_rms_norm_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Compute the root mean square of all elements in a tensor and store the result in the first tensor.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_rms_norm_inplace(ctx, a)
 
 
 lib.ggml_rms_norm_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_rms_norm_inplace.restype = ctypes.POINTER(ggml_tensor)
 
 
@@ -2116,15 +2764,28 @@
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_mul_mat(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Multiply two matrices and return the result.
+    
+    A: m rows, n columns
+    B: p rows, n columns  (i.e. we transpose it internally)
+    result is m columns, p rows
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+        b: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_mul_mat(ctx, a, b)
 
 
 lib.ggml_mul_mat.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -2139,15 +2800,28 @@
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_out_prod(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Compute the outer product of two matrices and return the result.
+
+    A: m columns, n rows,
+    B: p columns, n rows,
+    result is m columns, p rows
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+        b: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_out_prod(ctx, a, b)
 
 
 lib.ggml_out_prod.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -2164,14 +2838,23 @@
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_scale(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
 ) -> ggml_tensor_p:  
+    """Scale a tensor by another tensor and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+        b: tensor
+        
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_scale(ctx, a, b)
 
 
 lib.ggml_scale.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -2184,15 +2867,23 @@
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_scale_inplace(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Scale a tensor by another tensor and store the result in the first tensor.
+
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_scale_inplace(ctx, a, b)
 
 
 lib.ggml_scale_inplace.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -2389,15 +3080,23 @@
 
 # // make contiguous
 # GGML_API struct ggml_tensor * ggml_cont(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_cont(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Make a tensor contiguous and return the result.
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_cont(ctx, a)
 
 
 lib.ggml_cont.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_cont.restype = ctypes.POINTER(ggml_tensor)
 
 
@@ -2407,15 +3106,15 @@
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_reshape(
     ctx: ggml_context_p,
     a: ggml_tensor_p,  
     b: ggml_tensor_p,  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
     return lib.ggml_reshape(ctx, a, b)
 
 
 lib.ggml_reshape.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -2685,15 +3384,25 @@
 
 # // alias for ggml_permute(ctx, a, 1, 0, 2, 3)
 # GGML_API struct ggml_tensor * ggml_transpose(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_transpose(
     ctx: ggml_context_p, a: ggml_tensor_p  
-) -> ggml_tensor_p:  
+) -> ggml_tensor_p:
+    """Transpose *the first two dimensions* of a tensor and return the result.
+    
+    alias for `ggml_permute(ctx, a, 1, 0, 2, 3)`
+    
+    Parameters:
+        ctx: ggml context
+        a: tensor
+
+    Returns:
+        Pointer to ggml_tensor"""
     return lib.ggml_transpose(ctx, a)
 
 
 lib.ggml_transpose.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_transpose.restype = ctypes.POINTER(ggml_tensor)
 
 
@@ -3045,88 +3754,234 @@
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.c_float,
     ctypes.c_float,
 ]
 lib.ggml_clamp.restype = ctypes.POINTER(ggml_tensor)
 
-
-# // padding = half
-# // TODO: we don't support extra parameters for now
-# //       that's why we are hard-coding the stride, padding, and dilation
-# //       not great ..
-# // example:
-# // a:      3   80  768    1
-# // b:   3000   80    1    1
-# // res: 3000  768    1    1
-# // used in whisper
-def ggml_conv_1d_s1_ph(
+# GGML_API struct ggml_tensor * ggml_conv_1d(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a,
+#         struct ggml_tensor  * b,
+#         int                   s0,  // stride
+#         int                   p0,  // padding
+#         int                   d0); // dilation
+def ggml_conv_1d(
     ctx: ggml_context_p,
-    a: ggml_tensor_p,  
-    b: ggml_tensor_p,  
-) -> ggml_tensor_p:  
-    return lib.ggml_conv_1d_s1_ph(ctx, a, b)
+    a: ggml_tensor_p,
+    b: ggml_tensor_p,
+    s0: Union[ctypes.c_int, int],
+    p0: Union[ctypes.c_int, int],
+    d0: Union[ctypes.c_int, int],
+) -> ggml_tensor_p:
+    """Convolution 1D
+    
+    Parameters:
+        a: input tensor
+        b: filter tensor
+        s0: stride
+        p0: padding
+        d0: dilation
 
+    Returns:
+        output tensor"""
+    return lib.ggml_conv_1d(ctx, a, b, s0, p0, d0)
 
-lib.ggml_conv_1d_s1_ph.argtypes = [
+lib.ggml_conv_1d.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
 ]
-lib.ggml_conv_1d_s1_ph.restype = ctypes.POINTER(ggml_tensor)
-
+lib.ggml_conv_1d.restype = ctypes.POINTER(ggml_tensor)
 
-# // used in whisper
-# GGML_API struct ggml_tensor * ggml_conv_1d_s2_ph(
+# GGML_API struct ggml_tensor * ggml_conv_2d(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
-#         struct ggml_tensor  * b);
-def ggml_conv_1d_s2_ph(
+#         struct ggml_tensor  * b,
+#         int                   s0,
+#         int                   s1,
+#         int                   p0,
+#         int                   p1,
+#         int                   d0,
+#         int                   d1);
+def ggml_conv_2d(
     ctx: ggml_context_p,
-    a: ggml_tensor_p,  
-    b: ggml_tensor_p,  
-) -> ggml_tensor_p:  
-    return lib.ggml_conv_1d_s2_ph(ctx, a, b)
-
+    a: ggml_tensor_p,
+    b: ggml_tensor_p,
+    s0: Union[ctypes.c_int, int],
+    s1: Union[ctypes.c_int, int],
+    p0: Union[ctypes.c_int, int],
+    p1: Union[ctypes.c_int, int],
+    d0: Union[ctypes.c_int, int],
+    d1: Union[ctypes.c_int, int],
+) -> ggml_tensor_p:
+    """Convolution 2D
+    
+    Parameters:
+        a: input tensor
+        b: filter tensor
+        s0: stride
+        s1: stride
+        p0: padding
+        p1: padding
+        d0: dilation
+        d1: dilation
+        
+    Returns:
+        output tensor"""
+    return lib.ggml_conv_2d(ctx, a, b, s0, s1, p0, p1, d0, d1)
 
-lib.ggml_conv_1d_s2_ph.argtypes = [
+lib.ggml_conv_2d.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
 ]
-lib.ggml_conv_1d_s2_ph.restype = ctypes.POINTER(ggml_tensor)
+lib.ggml_conv_2d.restype = ctypes.POINTER(ggml_tensor)
 
 
-# // kernel size is a->ne[0] x a->ne[1]
-# // stride is equal to kernel size
-# // padding is zero
-# // example:
-# // a:     16   16    3  768
-# // b:   1024 1024    3    1
-# // res:   64   64  768    1
-# // used in sam
-# GGML_API struct ggml_tensor * ggml_conv_2d_sk_p0(
+# // conv_1d with padding = half
+# // alias for ggml_conv_1d(a, b, s, a->ne[0]/2, d)
+# GGML_API struct ggml_tensor* ggml_conv_1d_ph(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
-#         struct ggml_tensor  * b);
-def ggml_conv_2d_sk_p0(
+#         struct ggml_tensor  * b,
+#         int                   s,
+#         int                   d);
+def ggml_conv_1d_ph(
     ctx: ggml_context_p,
-    a: ggml_tensor_p,  
-    b: ggml_tensor_p,  
+    a: ggml_tensor_p,
+    b: ggml_tensor_p,
+    s: Union[ctypes.c_int, int],
+    d: Union[ctypes.c_int, int],
 ) -> ggml_tensor_p:
-    return lib.ggml_conv_2d_sk_p0(ctx, a, b)
-
+    """Convolution 1D with padding = half
+    
+    Parameters:
+        a: input tensor
+        b: filter tensor
+        s: stride
+        d: dilation
+        
+    Returns:
+        output tensor"""
+    return lib.ggml_conv_1d_ph(ctx, a, b, s, d)
 
-lib.ggml_conv_2d_sk_p0.argtypes = [
+lib.ggml_conv_1d_ph.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
+    ctypes.c_int,
+    ctypes.c_int,
 ]
-lib.ggml_conv_2d_sk_p0.restype = ctypes.POINTER(ggml_tensor)
+lib.ggml_conv_1d_ph.restype = ctypes.POINTER(ggml_tensor)
+
+# enum ggml_op_pool {
+#     GGML_OP_POOL_MAX,
+#     GGML_OP_POOL_AVG,
+#     GGML_OP_POOL_COUNT,
+# };
+GGML_OP_POOL_MAX = 0
+GGML_OP_POOL_AVG = 1
+GGML_OP_POOL_COUNT = 2
+
+# GGML_API struct ggml_tensor* ggml_pool_1d(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a,
+#         enum ggml_op_pool     op,
+#         int                   k0, // kernel size
+#         int                   s0, // stride
+#         int                   p0); // padding
+def ggml_pool_1d(
+    ctx: ggml_context_p,
+    a: ggml_tensor_p,
+    op: Union[ctypes.c_int, int],
+    k0: Union[ctypes.c_int, int],
+    s0: Union[ctypes.c_int, int],
+    p0: Union[ctypes.c_int, int],
+) -> ggml_tensor_p:
+    """1D Pooling
+    
+    Parameters:
+        a: input tensor
+        op: pooling operation
+        k0: kernel size
+        s0: stride
+        p0: padding
+        
+    Returns:
+        output tensor"""
+    return lib.ggml_pool_1d(ctx, a, op, k0, s0, p0)
 
+lib.ggml_pool_1d.argtypes = [
+    ggml_context_p,
+    ctypes.POINTER(ggml_tensor),
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+]
+lib.ggml_pool_1d.restype = ctypes.POINTER(ggml_tensor)
+
+# GGML_API struct ggml_tensor* ggml_pool_2d(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a,
+#         enum ggml_op_pool     op,
+#         int                   k0,
+#         int                   k1,
+#         int                   s0,
+#         int                   s1,
+#         int                   p0,
+#         int                   p1);
+def ggml_pool_2d(
+    ctx: ggml_context_p,
+    a: ggml_tensor_p,
+    op: Union[ctypes.c_int, int],
+    k0: Union[ctypes.c_int, int],
+    k1: Union[ctypes.c_int, int],
+    s0: Union[ctypes.c_int, int],
+    s1: Union[ctypes.c_int, int],
+    p0: Union[ctypes.c_int, int],
+    p1: Union[ctypes.c_int, int],
+) -> ggml_tensor_p:
+    """2D Pooling
+    
+    Parameters:
+        a: input tensor
+        op: pooling operation
+        k0: kernel size
+        k1: kernel size
+        s0: stride
+        s1: stride
+        p0: padding
+        p1: padding
+        
+    Returns:
+        output tensor"""
+    return lib.ggml_pool_2d(ctx, a, op, k0, k1, s0, s1, p0, p1)
+
+lib.ggml_pool_2d.argtypes = [
+    ggml_context_p,
+    ctypes.POINTER(ggml_tensor),
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+    ctypes.c_int,
+]
+lib.ggml_pool_2d.restype = ctypes.POINTER(ggml_tensor)
 
 # GGML_API struct ggml_tensor * ggml_flash_attn(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * q,
 #         struct ggml_tensor  * k,
 #         struct ggml_tensor  * v,
 #         bool                  masked);
@@ -3277,31 +4132,34 @@
     ctypes.POINTER(ctypes.c_float),
 )
 
 # typedef void (*ggml_custom1_op_f32_t)(struct ggml_tensor *, const struct ggml_tensor *);
 ggml_custom1_op_f32_t = ctypes.CFUNCTYPE(
     None, ctypes.POINTER(ggml_tensor), ctypes.POINTER(ggml_tensor)
 )
+"""Unary operator function type"""
 
 # typedef void (*ggml_custom2_op_f32_t)(struct ggml_tensor *, const struct ggml_tensor *, const struct ggml_tensor *);
 ggml_custom2_op_f32_t = ctypes.CFUNCTYPE(
     None,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
 )
+"""Binary operator function type"""
 
 # typedef void (*ggml_custom3_op_f32_t)(struct ggml_tensor *, const struct ggml_tensor *, const struct ggml_tensor *, const struct ggml_tensor *);
 ggml_custom3_op_f32_t = ctypes.CFUNCTYPE(
     None,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
 )
+"""Ternary operator function type"""
 
 # GGML_API struct ggml_tensor * ggml_map_unary_f32(
 #         struct ggml_context        * ctx,
 #         struct ggml_tensor         * a,
 #                ggml_unary_op_f32_t   fun);
 def ggml_map_unary_f32(
     ctx: ggml_context_p,
@@ -3386,14 +4244,36 @@
 #         struct ggml_tensor           * a,
 #                 ggml_custom1_op_f32_t   fun);
 def ggml_map_custom1_f32(
     ctx: ggml_context_p,
     a: ggml_tensor_p,
     fun: "ctypes._FuncPointer" # type: ignore
 ) -> ggml_tensor_p:
+    """Custom unary operator on a tensor.
+
+    Example:
+        ```python
+        import ggml
+
+        @ggml.ggml_custom1_op_f32_t
+        def custom_op(b: ggml.tensor_p, a: ggml.tensor_p):
+            # do something with a and copy to b
+            return
+
+        ...
+
+        b = ggml.ggml_map_custom1_f32(ctx, a, custom_op)
+        ```
+    
+    Parameters:
+        a: input tensor
+        fun (ggml.ggml_custom1_op_f32_t): function to apply to each element
+        
+    Returns:
+        output tensor"""
     return lib.ggml_map_custom1_f32(ctx, a, fun)
 
 lib.ggml_map_custom1_f32.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ggml_custom1_op_f32_t,
 ]
@@ -3404,14 +4284,22 @@
 #         struct ggml_tensor           * a,
 #                 ggml_custom1_op_f32_t   fun);
 def ggml_map_custom1_inplace_f32(
     ctx: ggml_context_p,
     a: ggml_tensor_p,
     fun: "ctypes._CFuncPtr" # type: ignore
 ) -> ggml_tensor_p:
+    """Custom unary operator on a tensor inplace.
+
+    Parameters:
+        a: input tensor
+        fun (ggml.ggml_custom1_op_f32_t): function to apply to each element
+
+    Returns:
+        output tensor"""
     return lib.ggml_map_custom1_inplace_f32(ctx, a, fun)
 
 lib.ggml_map_custom1_inplace_f32.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ggml_custom1_op_f32_t,
 ]
@@ -3424,14 +4312,23 @@
 #                 ggml_custom2_op_f32_t   fun);
 def ggml_map_custom2_f32(
     ctx: ggml_context_p,
     a: ggml_tensor_p,
     b: ggml_tensor_p,
     fun: "ctypes._FuncPointer" # type: ignore
 ) -> ggml_tensor_p:
+    """Custom binary operator on two tensors.
+    
+    Parameters:
+        a: input tensor
+        b: input tensor
+        fun (ggml.ggml_custom2_op_f32_t): function to apply to each element
+
+    Returns:
+        output tensor"""
     return lib.ggml_map_custom2_f32(ctx, a, b, fun)
 
 lib.ggml_map_custom2_f32.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
     ggml_custom2_op_f32_t,
@@ -3445,14 +4342,23 @@
 #                 ggml_custom2_op_f32_t   fun);
 def ggml_map_custom2_inplace_f32(
     ctx: ggml_context_p,
     a: ggml_tensor_p,
     b: ggml_tensor_p,
     fun: "ctypes._FuncPointer" # type: ignore
 ) -> ggml_tensor_p:
+    """Custom binary operator on two tensors inplace.
+    
+    Parameters:
+        a: input tensor
+        b: input tensor
+        fun (ggml.ggml_custom2_op_f32_t): function to apply to each element
+
+    Returns:
+        output tensor"""
     return lib.ggml_map_custom2_inplace_f32(ctx, a, b, fun)
 
 lib.ggml_map_custom2_inplace_f32.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
     ggml_custom2_op_f32_t,
@@ -3468,14 +4374,24 @@
 def ggml_map_custom3_f32(
     ctx: ggml_context_p,
     a: ggml_tensor_p,
     b: ggml_tensor_p,
     c: ggml_tensor_p,
     fun: "ctypes._FuncPointer" # type: ignore
 ) -> ggml_tensor_p:
+    """Custom ternary operator on three tensors.
+    
+    Parameters:
+        a: input tensor
+        b: input tensor
+        c: input tensor
+        fun (ggml.ggml_custom3_op_f32_t): function to apply to each element
+        
+    Returns:
+        output tensor"""
     return lib.ggml_map_custom3_f32(ctx, a, b, c, fun)
 
 lib.ggml_map_custom3_f32.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -3492,14 +4408,24 @@
 def ggml_map_custom3_inplace_f32(
     ctx: ggml_context_p,
     a: ggml_tensor_p,
     b: ggml_tensor_p,
     c: ggml_tensor_p,
     fun: "ctypes._FuncPointer" # type: ignore
 ) -> ggml_tensor_p:
+    """Custom ternary operator on three tensors inplace.
+
+    Parameters:
+        a: input tensor
+        b: input tensor
+        c: input tensor
+        fun (ggml.ggml_custom3_op_f32_t): function to apply to each element
+
+    Returns:
+        output tensor"""
     return lib.ggml_map_custom3_inplace_f32(ctx, a, b, c, fun)
 
 lib.ggml_map_custom3_inplace_f32.argtypes = [
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
@@ -3548,18 +4474,21 @@
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
 ]
 lib.ggml_cross_entropy_loss_back.restype = ctypes.POINTER(ggml_tensor)
 
+# //
+# // automatic differentiation
+# //
 
 # GGML_API void ggml_set_param(
 #         struct ggml_context * ctx,
-#         struct ggml_tensor * tensor);
+#         struct ggml_tensor  * tensor);
 def ggml_set_param(
     ctx: ggml_context_p, tensor: ggml_tensor_p  
 ):
     return lib.ggml_set_param(ctx, tensor)
 
 
 lib.ggml_set_param.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
@@ -3567,28 +4496,41 @@
 
 
 # GGML_API void ggml_build_forward_expand(struct ggml_cgraph * cgraph, struct ggml_tensor * tensor);
 def ggml_build_forward_expand(
     cgraph: ggml_cgraph_p,  
     tensor: ggml_tensor_p,  
 ):
+    """Add a tensor to the forward computation graph. This is used to
+    compute and save the value of the tensor.
+
+    Parameters:
+        cgraph: The graph.
+        tensor: The tensor."""
     return lib.ggml_build_forward_expand(cgraph, tensor)
 
 
 lib.ggml_build_forward_expand.argtypes = [
     ctypes.POINTER(ggml_cgraph),
     ctypes.POINTER(ggml_tensor),
 ]
 lib.ggml_build_forward_expand.restype = None
 
 
 # GGML_API struct ggml_cgraph ggml_build_forward (struct ggml_tensor * tensor);
 def ggml_build_forward(
     tensor: ggml_tensor_p,  
 ) -> ggml_cgraph:
+    """Build the forward computation graph.
+    
+    Parameters:
+        tensor: The tensor.
+
+    Returns:
+        The graph."""
     return lib.ggml_build_forward(tensor)
 
 
 lib.ggml_build_forward.argtypes = [ctypes.POINTER(ggml_tensor)]
 lib.ggml_build_forward.restype = ggml_cgraph
 
 
@@ -3605,41 +4547,101 @@
     ggml_context_p,
     ctypes.POINTER(ggml_cgraph),
     ctypes.c_bool,
 ]
 lib.ggml_build_backward.restype = ggml_cgraph
 
 
-# GGML_API void ggml_graph_compute(struct ggml_context * ctx, struct ggml_cgraph * cgraph);
-def ggml_graph_compute(
-    ctx: ggml_context_p, cgraph: ggml_cgraph_p
-):
-    return lib.ggml_graph_compute(ctx, cgraph)
+# // ggml_graph_plan() has to be called before ggml_graph_compute()
+# // when plan.work_size > 0, caller must allocate memory for plan.work_data
+# GGML_API struct ggml_cplan ggml_graph_plan   (struct ggml_cgraph * cgraph, int n_threads /*= GGML_DEFAULT_N_THREADS*/);
+def ggml_graph_plan(
+    cgraph: ggml_cgraph_p,
+    n_threads: Union[ctypes.c_int, int] = GGML_DEFAULT_N_THREADS,
+) -> ggml_cplan:
+    """Plan the computation graph.
+    
+    Parameters:
+        cgraph: The graph.
+        n_threads: The number of threads to use.
 
+    Returns:
+        The plan."""
+    return lib.ggml_graph_plan(cgraph, n_threads)
 
-lib.ggml_graph_compute.argtypes = [ggml_context_p, ctypes.POINTER(ggml_cgraph)]
-lib.ggml_graph_compute.restype = None
+lib.ggml_graph_plan.argtypes = [
+    ctypes.POINTER(ggml_cgraph),
+    ctypes.c_int,
+]
+lib.ggml_graph_plan.restype = ggml_cplan
 
+# GGML_API               int ggml_graph_compute(struct ggml_cgraph * cgraph, struct ggml_cplan * cplan);
+def ggml_graph_compute(
+    cgraph: ggml_cgraph_p,
+    cplan: ggml_cplan_p,
+):
+    """Compute the graph.
+    
+    Parameters:
+        cgraph: The graph.
+        cplan: The plan."""
+    return lib.ggml_graph_compute(cgraph, cplan)
+
+lib.ggml_graph_compute.argtypes = [
+    ctypes.POINTER(ggml_cgraph),
+    ctypes.POINTER(ggml_cplan),
+]
+lib.ggml_graph_compute.restype = ctypes.c_int
 
-# GGML_API void ggml_graph_reset  (struct ggml_cgraph * cgraph);
+# GGML_API              void ggml_graph_reset  (struct ggml_cgraph * cgraph);
 def ggml_graph_reset(
-    cgraph: ggml_cgraph_p
+    cgraph: ggml_cgraph_p,
 ):
+    """Reset the graph.
+    
+    Parameters:
+        cgraph: The graph."""
     return lib.ggml_graph_reset(cgraph)
 
+# // same as ggml_graph_compute() but the work data is allocated as a part of the context
+# // note: the drawback of this API is that you must have ensured that the context has enough memory for the work data
+# GGML_API void ggml_graph_compute_with_ctx(struct ggml_context * ctx, struct ggml_cgraph * cgraph, int n_threads);
+def ggml_graph_compute_with_ctx(
+    ctx: ggml_context_p,
+    cgraph: ggml_cgraph_p,
+    n_threads: Union[ctypes.c_int, int],
+):
+    """Compute the graph with a context.
+    
+    Parameters:
+        ctx: The context.
+        cgraph: The graph.
+        n_threads: The number of threads to use."""
+    return lib.ggml_graph_compute_with_ctx(ctx, cgraph, n_threads)
 
-lib.ggml_graph_reset.argtypes = [ctypes.POINTER(ggml_cgraph)]
-lib.ggml_graph_reset.restype = None
-
+lib.ggml_graph_compute_with_ctx.argtypes = [
+    ggml_context_p,
+    ctypes.POINTER(ggml_cgraph),
+    ctypes.c_int,
+]
+lib.ggml_graph_compute_with_ctx.restype = None
 
 # GGML_API struct ggml_tensor * ggml_graph_get_tensor(struct ggml_cgraph * cgraph, const char * name);
 def ggml_graph_get_tensor(
     cgraph: ggml_cgraph_p,  
     name: bytes,
 ) -> ggml_tensor_p:
+    """Get a tensor from the graph by name.
+    
+    Parameters:
+        cgraph: The graph.
+        name: The name of the tensor.
+
+    Returns:
+        The tensor."""
     return lib.ggml_graph_get_tensor(cgraph, name)
 
 
 lib.ggml_graph_get_tensor.argtypes = [
     ctypes.POINTER(ggml_cgraph),
     ctypes.c_char_p,
 ]
@@ -4338,14 +5340,59 @@
     return lib.ggml_cpu_has_vsx()
 
 
 lib.ggml_cpu_has_vsx.argtypes = []
 lib.ggml_cpu_has_vsx.restype = ctypes.c_int
 
 
+# //
+# // Internal types and functions exposed for tests and benchmarks
+# //
+
+# typedef void (*ggml_to_float_t)(const void * x, float * y, int k);
+ggml_to_float_t = ctypes.CFUNCTYPE(
+    None, ctypes.c_void_p, ctypes.POINTER(ctypes.c_float), ctypes.c_int
+)
+
+# typedef void (*ggml_from_float_t)(const float * x, void * y, int k);
+ggml_from_float_t = ctypes.CFUNCTYPE(
+    None, ctypes.POINTER(ctypes.c_float), ctypes.c_void_p, ctypes.c_int
+)
+
+# typedef void (*ggml_vec_dot_t)(const int n, float * s, const void * x, const void * y);
+ggml_vec_dot_t = ctypes.CFUNCTYPE(
+    None, ctypes.c_int, ctypes.POINTER(ctypes.c_float), ctypes.c_void_p, ctypes.c_void_p
+)
+
+
+# typedef struct {
+#     ggml_to_float_t   to_float;
+#     ggml_from_float_t from_float;
+#     ggml_from_float_t from_float_reference;
+#     ggml_vec_dot_t    vec_dot;
+#     enum ggml_type    vec_dot_type;
+# } ggml_type_traits_t;
+class ggml_type_traits_t(ctypes.Structure):
+    _fields_ = [
+        ("to_float", ggml_to_float_t),
+        ("from_float", ggml_from_float_t),
+        ("from_float_reference", ggml_from_float_t),
+        ("vec_dot", ggml_vec_dot_t),
+        ("vec_dot_type", ctypes.c_int),
+    ]
+
+
+# ggml_type_traits_t ggml_internal_get_type_traits(enum ggml_type i);
+def ggml_internal_get_type_traits(i: Union[ctypes.c_int, int]) -> ggml_type_traits_t:
+    return lib.ggml_internal_get_type_traits(i)
+
+lib.ggml_internal_get_type_traits.argtypes = [ctypes.c_int]
+lib.ggml_internal_get_type_traits.restype = ggml_type_traits_t
+
+
 #####################################################
 # GGML CUDA API
 # source: ggml-cuda.h
 #####################################################
 
 
 GGML_USE_CUBLAS = hasattr(lib, "ggml_init_cublas")
```

### Comparing `ggml-python-0.0.7/pyproject.toml` & `ggml-python-0.0.8/pyproject.toml`

 * *Files 3% similar despite different names*

```diff
@@ -4,15 +4,15 @@
     "cmake>=3.18",
     "ninja",
 ]
 build-backend = "scikit_build_core.build"
 
 [project]
 name = "ggml_python"
-version = "0.0.7"
+version = "0.0.8"
 description = "Python bindings for ggml"
 readme = "README.md"
 license = { text = "MIT" }
 authors = [
     { name = "Andrei Betlen", email = "abetlen@gmail.com" },
 ]
 requires-python = ">=3.7"
@@ -32,15 +32,15 @@
 [tool.scikit-build]
 wheel.packages = ["ggml"]
 wheel.expand-macos-universal-tags = true
 cmake.verbose = true
 
 [project.optional-dependencies]
 test = ["pytest"]
-docs = ["mkdocs", "mkdocstrings[python]", "mkdocs-material"]
+docs = ["mkdocs", "mkdocstrings[python]", "mkdocs-material", "pillow", "cairosvg"]
 convert = [
     "accelerate==0.19.0",
     "numpy==1.24.3",
     "sentencepiece==0.1.98",
     "torch==2.0.1",
     "torchaudio==2.0.2",
     "torchvision==0.15.2",
```

### Comparing `ggml-python-0.0.7/tests/test_experimental.py` & `ggml-python-0.0.8/tests/test_experimental.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/.github/workflows/ci.yml` & `ggml-python-0.0.8/vendor/ggml/.github/workflows/ci.yml`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/CMakeLists.txt` & `ggml-python-0.0.8/vendor/ggml-cpy/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/LICENSE` & `ggml-python-0.0.8/vendor/ggml/LICENSE`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/README.md` & `ggml-python-0.0.8/vendor/ggml-cpy/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/build.zig` & `ggml-python-0.0.8/vendor/ggml-cpy/build.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/cmake/BuildTypes.cmake` & `ggml-python-0.0.8/vendor/ggml/cmake/BuildTypes.cmake`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/cmake/GitVars.cmake` & `ggml-python-0.0.8/vendor/ggml/cmake/GitVars.cmake`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/CMakeLists.txt` & `ggml-python-0.0.8/vendor/ggml/examples/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/common-ggml.cpp` & `ggml-python-0.0.8/vendor/ggml/examples/common-ggml.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/common.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/common.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/common.h` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/common.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/README.md` & `ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/dolly-v2/quantize.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/dr_wav.h` & `ggml-python-0.0.8/vendor/ggml/examples/dr_wav.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-2/README.md` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-2/download-ggml-model.sh` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/download-ggml-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-2/download-model.sh` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/download-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-2/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-2/quantize.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-j/README.md` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-j/download-ggml-model.sh` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/download-ggml-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-j/download-model.sh` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/download-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-j/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-j/quantize.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/README.md` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/gpt-neox/quantize.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mnist/CMakeLists.txt` & `ggml-python-0.0.8/vendor/ggml/examples/mnist/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mnist/README.md` & `ggml-python-0.0.8/vendor/ggml/examples/mnist/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mnist/convert-h5-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/mnist/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mnist/main-cpu.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-cpu.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mnist/main-mtl.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mnist/main-mtl.m` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.m`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mnist/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mnist/web/index.html` & `ggml-python-0.0.8/vendor/ggml/examples/mnist/web/index.html`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mpt/convert-h5-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mpt/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/mpt/quantize.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/dolly-v2.txt` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/dolly-v2.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/gpt-2.txt` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-2.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/gpt-j.txt` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-j.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/gpt-neox.txt` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-neox.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/replit.txt` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/replit.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/starcoder.txt` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/starcoder.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/test-cases.txt` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/test-cases.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/tokenize_huggingface.py` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/tokenize_huggingface.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/prompts/whisper.txt` & `ggml-python-0.0.8/vendor/ggml/examples/prompts/whisper.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/replit/convert-h5-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/replit/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/replit/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/replit/quantize.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/starcoder/README.md` & `ggml-python-0.0.8/vendor/ggml/examples/starcoder/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/starcoder/convert-hf-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/convert-hf-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/starcoder/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/starcoder/quantize.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/whisper/README.md` & `ggml-python-0.0.8/vendor/ggml/examples/whisper/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/whisper/convert-pt-to-ggml.py` & `ggml-python-0.0.8/vendor/ggml/examples/whisper/convert-pt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/whisper/main.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/whisper/quantize.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/whisper/whisper.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/whisper.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/examples/whisper/whisper.h` & `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/whisper.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/include/ggml/ggml.h` & `ggml-python-0.0.8/vendor/ggml-cpy/include/ggml/ggml.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/scripts/sync-llama.sh` & `ggml-python-0.0.8/vendor/ggml-cpy/scripts/sync-llama.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/scripts/sync-whisper.sh` & `ggml-python-0.0.8/vendor/ggml/scripts/sync-whisper.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/src/CMakeLists.txt` & `ggml-python-0.0.8/vendor/ggml-cpy/src/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/src/ggml-cuda.cu` & `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-cuda.cu`

 * *Files 2% similar despite different names*

```diff
@@ -189,14 +189,15 @@
 } block_q6_K;
 static_assert(sizeof(block_q6_K) == sizeof(ggml_fp16_t) + 13*QK_K/16, "wrong q6_K block size/padding");
 
 #define WARP_SIZE 32
 
 #define CUDA_ADD_BLOCK_SIZE 256
 #define CUDA_MUL_BLOCK_SIZE 256
+#define CUDA_REPEAT_BLOCK_SIZE 256
 #define CUDA_SILU_BLOCK_SIZE 256
 #define CUDA_CPY_BLOCK_SIZE 32
 #define CUDA_SCALE_BLOCK_SIZE 256
 #define CUDA_ROPE_BLOCK_SIZE 256
 #define CUDA_DIAG_MASK_INF_BLOCK_SIZE 32
 #define CUDA_DEQUANTIZE_BLOCK_SIZE 256
 
@@ -228,23 +229,83 @@
 
     if (i >= kx) {
         return;
     }
     dst[i] = x[i] * y[i%ky];
 }
 
+static __global__ void repeat_f32(const float * x, float * dst, const int kx, const int ky) {
+    const int i = blockDim.x*blockIdx.x + threadIdx.x;
+
+    if (i >= kx) {
+        return;
+    }
+    dst[i] = x[i%ky];
+}
+
 static __global__ void silu_f32(const float * x, float * dst, const int k) {
     const int i = blockDim.x*blockIdx.x + threadIdx.x;
 
     if (i >= k) {
         return;
     }
     dst[i] = x[i] / (1.0f + expf(-x[i]));
 }
 
+static __global__ void norm_f32(const float * x, float * dst, const int ncols) {
+    const int row = blockIdx.x*blockDim.y + threadIdx.y;
+    const int tid = threadIdx.x;
+
+    const float eps = 1e-5;
+
+    float sum1 = 0.0f; // partial sum for thread in warp
+
+    // compute mean
+    for (int i = 0; i < ncols; i += WARP_SIZE) {
+        const int col = i + tid;
+        const float xi = x[row*ncols + col];
+        sum1 += xi;
+    }
+
+    // sum up partial sums
+    __syncthreads();
+#pragma unroll
+    for (int mask = 16; mask > 0; mask >>= 1) {
+        sum1 += __shfl_xor_sync(0xffffffff, sum1, mask, 32);
+    }
+
+    const float mean = sum1 / ncols;
+
+    // compute variance
+    float sum2 = 0.0f;
+
+    for (int i = 0; i < ncols; i += WARP_SIZE) {
+        const int col = i + tid;
+        const float xi = x[row*ncols + col];
+        sum2 += (xi - mean) * (xi - mean);
+    }
+
+    // sum up partial sums
+    __syncthreads();
+#pragma unroll
+    for (int mask = 16; mask > 0; mask >>= 1) {
+        sum2 += __shfl_xor_sync(0xffffffff, sum2, mask, 32);
+    }
+
+    const float variance = sum2 / ncols;
+
+    // normalize
+    const float scale = 1.0f / sqrtf(variance + eps);
+
+    for (int i = 0; i < ncols; i += WARP_SIZE) {
+        const int col = i + tid;
+        dst[row*ncols + col] = scale * (x[row*ncols + col]);
+    }
+}
+
 static __global__ void rms_norm_f32(const float * x, float * dst, const int ncols) {
     const int row = blockIdx.x*blockDim.y + threadIdx.y;
     const int tid = threadIdx.x;
 
     const float eps = 1e-6;
 
     float tmp = 0.0f; // partial sum for thread in warp
@@ -1384,14 +1445,18 @@
     const float x0 = x[i + 0];
     const float x1 = x[i + 1];
 
     dst[i + 0] = x0*cos_theta - x1*sin_theta;
     dst[i + 1] = x0*sin_theta + x1*cos_theta;
 }
 
+// static __global__ void alibi_f32(const float * x, float * dst, const int ncols, const int n_head, const float m0, const float m1, const int ne1, const int ne2_ne3) {
+//     // TODO: implement
+// }
+
 static __global__ void diag_mask_inf_f32(const float * x, float * dst, const int ncols, const int rows_per_channel, const int n_past) {
     const int col = blockDim.x*blockIdx.x + threadIdx.x;
     const int row = blockDim.y*blockIdx.y + threadIdx.y;
 
     if (col >= ncols) {
         return;
     }
@@ -1460,19 +1525,30 @@
 }
 
 static void mul_f32_cuda(const float * x, const float * y, float * dst, const int kx, const int ky, cudaStream_t stream) {
     const int num_blocks = (kx + CUDA_MUL_BLOCK_SIZE - 1) / CUDA_MUL_BLOCK_SIZE;
     mul_f32<<<num_blocks, CUDA_MUL_BLOCK_SIZE, 0, stream>>>(x, y, dst, kx, ky);
 }
 
+static void repeat_f32_cuda(const float * x, float * dst, const int kx, const int ky, cudaStream_t stream) {
+    const int num_blocks = (kx + CUDA_REPEAT_BLOCK_SIZE - 1) / CUDA_REPEAT_BLOCK_SIZE;
+    repeat_f32<<<num_blocks, CUDA_REPEAT_BLOCK_SIZE, 0, stream>>>(x, dst, kx, ky);
+}
+
 static void silu_f32_cuda(const float * x, float * dst, const int k, cudaStream_t stream) {
     const int num_blocks = (k + CUDA_SILU_BLOCK_SIZE - 1) / CUDA_SILU_BLOCK_SIZE;
     silu_f32<<<num_blocks, CUDA_SILU_BLOCK_SIZE, 0, stream>>>(x, dst, k);
 }
 
+static void norm_f32_cuda(const float * x, float * dst, const int ncols, const int nrows, cudaStream_t stream) {
+    GGML_ASSERT(ncols % WARP_SIZE == 0);
+    const dim3 block_dims(WARP_SIZE, 1, 1);
+    norm_f32<<<nrows, block_dims, 0, stream>>>(x, dst, ncols);
+}
+
 static void rms_norm_f32_cuda(const float * x, float * dst, const int ncols, const int nrows, cudaStream_t stream) {
     GGML_ASSERT(ncols % WARP_SIZE == 0);
     const dim3 block_dims(WARP_SIZE, 1, 1);
     rms_norm_f32<<<nrows, block_dims, 0, stream>>>(x, dst, ncols);
 }
 
 static void dequantize_row_q4_0_cuda(const void * vx, float * y, const int k, cudaStream_t stream) {
@@ -1716,14 +1792,22 @@
     GGML_ASSERT(nrows % 2 == 0);
     const dim3 block_dims(2*CUDA_ROPE_BLOCK_SIZE, 1, 1);
     const int num_blocks_x = (ncols + 2*CUDA_ROPE_BLOCK_SIZE - 1) / (2*CUDA_ROPE_BLOCK_SIZE);
     const dim3 block_nums(num_blocks_x, nrows, 1);
     rope_f32<<<block_nums, block_dims, 0, stream>>>(x, dst, ncols, p, theta_scale);
 }
 
+// static void alibi_f32_cuda(const float * x, float * dst, const int ncols, const int nrows, const int n_head, const int m0, const int m1, const int ne1, const int ne2_ne3, cudaStream_t stream) {
+//     GGML_ASSERT(nrows % 2 == 0);
+//     const dim3 block_dims(2*CUDA_ROPE_BLOCK_SIZE, 1, 1);
+//     const int num_blocks_x = (ncols + 2*CUDA_ROPE_BLOCK_SIZE - 1) / (2*CUDA_ROPE_BLOCK_SIZE);
+//     const dim3 block_nums(num_blocks_x, nrows, 1);
+//     alibi_f32<<<block_nums, block_dims, 0, stream>>>(x, dst, ncols, n_head, m0, m1, ne1, ne2_ne3);
+// }
+
 static void diag_mask_inf_f32_cuda(const float * x, float * dst, const int ncols_x, const int nrows_x, const int rows_per_channel, const int n_past, cudaStream_t stream) {
     const dim3 block_dims(CUDA_DIAG_MASK_INF_BLOCK_SIZE, 1, 1);
     const int block_num_x = (ncols_x + CUDA_DIAG_MASK_INF_BLOCK_SIZE - 1) / CUDA_DIAG_MASK_INF_BLOCK_SIZE;
     const dim3 block_nums(block_num_x, nrows_x, 1);
     diag_mask_inf_f32<<<block_nums, block_dims, 0, stream>>>(x, dst, ncols_x, rows_per_channel, n_past);
 }
 
@@ -1986,14 +2070,47 @@
     }
 
     (void) dst;
     (void) src0_ddq_i;
     (void) i02;
 }
 
+inline void ggml_cuda_op_repeat(
+    const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst, char * src0_ddq_i,
+    float * src0_ddf_i, float * src1_ddf_i, float * dst_ddf_i, int64_t i02, int64_t i01_low, int64_t i01_high, int i1,
+    cudaStream_t & cudaStream_main){
+
+    GGML_ASSERT(src1_ddf_i != nullptr);
+    GGML_ASSERT(dst_ddf_i != nullptr);
+
+    const int64_t ne00 = src0->ne[0];
+    const int64_t ne01 = src0->ne[1];
+
+    const int64_t ne10 = src1->ne[0];
+    const int64_t ne11 = src1->ne[1];
+
+    const int64_t i11 = i1*ne11;
+
+    for (int64_t i01 = i01_low; i01 < i01_high; i01++) {
+        const int64_t i01_mod = i01%ne01;
+        const int64_t i11_mod = i11 + i01_mod%ne11; // broadcast src1 across src0
+
+        float * src1_ddf_i01 = src1_ddf_i + i11_mod*ne10;
+        float * dst_ddf_i01 = dst_ddf_i + i01*ne00;
+
+        // compute
+        repeat_f32_cuda(src1_ddf_i01, dst_ddf_i01, ne00, ne10, cudaStream_main);
+        CUDA_CHECK(cudaGetLastError());
+    }
+
+    (void) src0;
+    (void) src0_ddq_i;
+    (void) i02;
+}
+
 inline void ggml_cuda_op_silu(
     const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst, char * src0_ddq_i,
     float * src0_ddf_i, float * src1_ddf_i, float * dst_ddf_i, int64_t i02, int64_t i01_low, int64_t i01_high, int i1,
     cudaStream_t & cudaStream_main){
 
     GGML_ASSERT(src0_ddf_i != nullptr);
     GGML_ASSERT(dst_ddf_i != nullptr);
@@ -2009,14 +2126,37 @@
     (void) dst;
     (void) src0_ddq_i;
     (void) src1_ddf_i;
     (void) i02;
     (void) i1;
 }
 
+inline void ggml_cuda_op_norm(
+    const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst, char * src0_ddq_i,
+    float * src0_ddf_i, float * src1_ddf_i, float * dst_ddf_i, int64_t i02, int64_t i01_low, int64_t i01_high, int i1,
+    cudaStream_t & cudaStream_main){
+
+    GGML_ASSERT(src0_ddf_i != nullptr);
+    GGML_ASSERT(dst_ddf_i != nullptr);
+
+    const int64_t ne00 = src0->ne[0];
+    const int64_t i01_diff = i01_high - i01_low;
+
+    // compute
+    norm_f32_cuda(src0_ddf_i, dst_ddf_i, ne00, i01_diff, cudaStream_main);
+    CUDA_CHECK(cudaGetLastError());
+
+    (void) src1;
+    (void) dst;
+    (void) src0_ddq_i;
+    (void) src1_ddf_i;
+    (void) i02;
+    (void) i1;
+}
+
 inline void ggml_cuda_op_rms_norm(
     const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst, char * src0_ddq_i,
     float * src0_ddf_i, float * src1_ddf_i, float * dst_ddf_i, int64_t i02, int64_t i01_low, int64_t i01_high, int i1,
     cudaStream_t & cudaStream_main){
 
     GGML_ASSERT(src0_ddf_i != nullptr);
     GGML_ASSERT(dst_ddf_i != nullptr);
@@ -2186,14 +2326,58 @@
 
     (void) dst;
     (void) src0_ddq_i;
     (void) src1_ddf_i;
     (void) i1;
 }
 
+// inline void ggml_cuda_op_alibi(
+//     const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst, char * src0_ddq_i, 
+//     float * src0_ddf_i, float * src1_ddf_i, float * dst_ddf_i, int64_t i02, int64_t i01_low, int64_t i01_high, int i1, 
+//     cudaStream_t & cudaStream_main){
+
+//     GGML_ASSERT(src0_ddf_i != nullptr);
+//     GGML_ASSERT(dst_ddf_i != nullptr);
+
+//     const int64_t ne00 = src0->ne[0];
+//     const int64_t i01_diff = i01_high - i01_low;
+
+//     const int   n_past   = ((int32_t *) src1->data)[0];
+//     const int   n_head   = ((int32_t *) src1->data)[1];
+//     const float max_bias = ((float *)   src1->data)[2];
+
+//     assert(n_past >= 0);
+
+//     const int ne0 = src0->ne[0]; // all_seq_len = n_past + ne1
+//     const int ne1 = src0->ne[1]; // seq_len_without_past
+//     //const int ne2 = src0->ne[2]; // n_head -> this is k
+//     //const int ne3 = src0->ne[3]; // 1 -> bsz
+
+//     const int n  = ggml_nrows(src0);
+//     const int ne2_ne3 = n/ne1; // ne2*ne3
+
+//     const int nb0 = src0->nb[0];
+//     const int nb1 = src0->nb[1];
+//     const int nb2 = src0->nb[2];
+//     //const int nb3 = src0->nb[3];
+
+//     assert(nb0 == sizeof(float));
+//     assert(ne1 + n_past == ne0); (void) n_past;
+
+//     // add alibi to src0 (KQ_scaled)
+//     const int n_heads_log2_floor = 1 << (int) floor(log2(n_head));
+
+//     const float m0 = powf(2.0f, -(max_bias) / n_heads_log2_floor);
+//     const float m1 = powf(2.0f, -(max_bias / 2.0f) / n_heads_log2_floor);
+
+//     // compute
+//     alibi_f32_cuda(src0_ddf_i, dst_ddf_i, ne00, i01_diff, n_head, m0, m1, ne1, ne2_ne3, cudaStream_main);
+//     CUDA_CHECK(cudaGetLastError());
+// }
+
 inline void ggml_cuda_op_diag_mask_inf(
     const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst, char * src0_ddq_i,
     float * src0_ddf_i, float * src1_ddf_i, float * dst_ddf_i, int64_t i02, int64_t i01_low, int64_t i01_high, int i1,
     cudaStream_t & cudaStream_main){
 
     GGML_ASSERT(src0_ddf_i != nullptr);
     GGML_ASSERT(dst_ddf_i != nullptr);
@@ -2552,30 +2736,42 @@
 }
 
 void ggml_cuda_mul(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
     GGML_ASSERT(src0->type == GGML_TYPE_F32 && src1->type == GGML_TYPE_F32 && dst->type == GGML_TYPE_F32);
     ggml_cuda_op(src0, src1, dst, ggml_cuda_op_mul, true, false); // TODO ggml_cuda_op needs modification for flatten
 }
 
+void ggml_cuda_repeat(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
+    GGML_ASSERT(src0->type == GGML_TYPE_F32 && src1->type == GGML_TYPE_F32 && dst->type == GGML_TYPE_F32);
+    ggml_cuda_op(src0, src1, dst, ggml_cuda_op_repeat, true, true);
+}
+
 void ggml_cuda_silu(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
     GGML_ASSERT(src0->type == GGML_TYPE_F32 && dst->type == GGML_TYPE_F32);
     ggml_cuda_op(src0, src1, dst, ggml_cuda_op_silu, true, true);
 }
 
+void ggml_cuda_norm(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
+    GGML_ASSERT(src0->type == GGML_TYPE_F32 && dst->type == GGML_TYPE_F32);
+    ggml_cuda_op(src0, src1, dst, ggml_cuda_op_norm, true, true);
+}
+
 void ggml_cuda_rms_norm(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
     GGML_ASSERT(src0->type == GGML_TYPE_F32 && dst->type == GGML_TYPE_F32);
     ggml_cuda_op(src0, src1, dst, ggml_cuda_op_rms_norm, true, true);
 }
 
 bool ggml_cuda_can_mul_mat(const struct ggml_tensor * src0, const struct ggml_tensor * src1, struct ggml_tensor * dst) {
     const int64_t ne10 = src1->ne[0];
 
     const int64_t ne0 = dst->ne[0];
     const int64_t ne1 = dst->ne[1];
 
+    // fprintf(stderr, "ne10: %ld, ne0: %ld, ne1: %ld\n", ne10, ne0, ne1);
+
     // TODO: find the optimal values for these
     if ((src0->type == GGML_TYPE_F32 || src0->type == GGML_TYPE_F16 || ggml_is_quantized(src0->type)) &&
         src1->type == GGML_TYPE_F32 &&
         dst->type == GGML_TYPE_F32 &&
         (ne0 >= 32 && ne1 >= 32 && ne10 >= 32)) {
         return true;
     }
@@ -2668,14 +2864,18 @@
     ggml_cuda_op(src0, src1, dst, ggml_cuda_op_scale, true, true);
 }
 
 void ggml_cuda_cpy(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
     const int64_t ne = ggml_nelements(src0);
     GGML_ASSERT(ne == ggml_nelements(src1));
 
+    if (src0->backend != GGML_BACKEND_GPU) {
+        fprintf(stderr, "ggml_cuda_cpy: src0->op: %d\n", src0->op);
+        fprintf(stderr, "tensor name = %s\n", dst->name);
+    }
     GGML_ASSERT(src0->backend == GGML_BACKEND_GPU);
     GGML_ASSERT(src1->backend == GGML_BACKEND_GPU);
 
     GGML_ASSERT(ggml_nbytes(src0) <= INT_MAX);
     GGML_ASSERT(ggml_nbytes(src1) <= INT_MAX);
 
     const int64_t ne00 = src0->ne[0];
@@ -2727,14 +2927,19 @@
 }
 
 void ggml_cuda_rope(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
     GGML_ASSERT(src0->type == GGML_TYPE_F32 && dst->type == GGML_TYPE_F32);
     ggml_cuda_op(src0, src1, dst, ggml_cuda_op_rope, true, false); // FIXME flatten changes results
 }
 
+// void ggml_cuda_alibi(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
+//     GGML_ASSERT(src0->type == GGML_TYPE_F32 && dst->type == GGML_TYPE_F32);
+//     ggml_cuda_op(src0, src1, dst, ggml_cuda_op_alibi, true, false); // FIXME flatten changes results
+// }
+
 void ggml_cuda_nop(const ggml_tensor * src0, const ggml_tensor * src1, ggml_tensor * dst) {
     (void) src0;
     (void) src1;
     (void) dst;
 }
 
 void ggml_cuda_transform_tensor(void * data, struct ggml_tensor * tensor) {
@@ -2914,20 +3119,31 @@
             break;
         case GGML_OP_MUL:
             if (!any_on_device) {
                 return false;
             }
             func = ggml_cuda_mul;
             break;
+        case GGML_OP_REPEAT:
+            if (!any_on_device) {
+                return false;
+            }
+            func = ggml_cuda_repeat;
+            break;
         case GGML_OP_SILU:
             if (!any_on_device) {
                 return false;
             }
             func = ggml_cuda_silu;
             break;
+        case GGML_OP_NORM:
+            if (!any_on_device) {
+                return false;
+            }
+            func = ggml_cuda_norm;
         case GGML_OP_RMS_NORM:
             if (!any_on_device) {
                 return false;
             }
             func = ggml_cuda_rms_norm;
             break;
         case GGML_OP_MUL_MAT:
@@ -2944,14 +3160,16 @@
             break;
         case GGML_OP_CPY:
             if (!any_on_device) {
                 return false;
             }
             func = ggml_cuda_cpy;
             break;
+        // case GGML_OP_GET_ROWS:
+        // case GGML_OP_REPEAT:
         case GGML_OP_RESHAPE:
         case GGML_OP_VIEW:
         case GGML_OP_PERMUTE:
         case GGML_OP_TRANSPOSE:
             if (!any_on_device) {
                 return false;
             }
@@ -2971,14 +3189,20 @@
             break;
         case GGML_OP_ROPE:
             if (!any_on_device) {
                 return false;
             }
             func = ggml_cuda_rope;
             break;
+        // case GGML_OP_ALIBI:
+        //     if (!any_on_device) {
+        //         return false;
+        //     }
+        //     func = ggml_cuda_alibi;
+        //     break;
         default:
             return false;
     }
 
     if (params->ith != 0) {
         return true;
     }
```

### Comparing `ggml-python-0.0.7/vendor/ggml/src/ggml-cuda.h` & `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-cuda.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/src/ggml-metal.h` & `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/src/ggml-metal.m` & `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.m`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/src/ggml-metal.metal` & `ggml-python-0.0.8/vendor/ggml/src/ggml-metal.metal`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/src/ggml-opencl.cpp` & `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-opencl.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/src/ggml-opencl.h` & `ggml-python-0.0.8/vendor/ggml/src/ggml-opencl.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/src/ggml.c` & `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml.c`

 * *Files 0% similar despite different names*

```diff
@@ -30739,8299 +30739,8323 @@
 00078120: 455f 4355 424c 4153 0a20 2020 2062 6f6f  E_CUBLAS.    boo
 00078130: 6c20 736b 6970 5f63 7075 203d 2067 676d  l skip_cpu = ggm
 00078140: 6c5f 6375 6461 5f63 6f6d 7075 7465 5f66  l_cuda_compute_f
 00078150: 6f72 7761 7264 2870 6172 616d 732c 2074  orward(params, t
 00078160: 656e 736f 7229 3b0a 2020 2020 6966 2028  ensor);.    if (
 00078170: 736b 6970 5f63 7075 2920 7b0a 2020 2020  skip_cpu) {.    
 00078180: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00078190: 7d0a 2020 2020 4747 4d4c 5f41 5353 4552  }.    GGML_ASSER
-000781a0: 5428 7465 6e73 6f72 2d3e 7372 6330 203d  T(tensor->src0 =
-000781b0: 3d20 4e55 4c4c 207c 7c20 7465 6e73 6f72  = NULL || tensor
-000781c0: 2d3e 7372 6330 2d3e 6261 636b 656e 6420  ->src0->backend 
-000781d0: 3d3d 2047 474d 4c5f 4241 434b 454e 445f  == GGML_BACKEND_
-000781e0: 4350 5529 3b0a 2020 2020 4747 4d4c 5f41  CPU);.    GGML_A
-000781f0: 5353 4552 5428 7465 6e73 6f72 2d3e 7372  SSERT(tensor->sr
-00078200: 6331 203d 3d20 4e55 4c4c 207c 7c20 7465  c1 == NULL || te
-00078210: 6e73 6f72 2d3e 7372 6331 2d3e 6261 636b  nsor->src1->back
-00078220: 656e 6420 3d3d 2047 474d 4c5f 4241 434b  end == GGML_BACK
-00078230: 454e 445f 4350 5529 3b0a 2365 6e64 6966  END_CPU);.#endif
-00078240: 202f 2f20 4747 4d4c 5f55 5345 5f43 5542   // GGML_USE_CUB
-00078250: 4c41 530a 0a20 2020 2073 7769 7463 6820  LAS..    switch 
-00078260: 2874 656e 736f 722d 3e6f 7029 207b 0a20  (tensor->op) {. 
-00078270: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00078280: 5f4f 505f 4455 503a 0a20 2020 2020 2020  _OP_DUP:.       
-00078290: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000782a0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-000782b0: 7574 655f 666f 7277 6172 645f 6475 7028  ute_forward_dup(
-000782c0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-000782d0: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
-000782e0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000782f0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00078300: 2047 474d 4c5f 4f50 5f41 4444 3a0a 2020   GGML_OP_ADD:.  
-00078310: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00078320: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00078330: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00078340: 5f61 6464 2870 6172 616d 732c 2074 656e  _add(params, ten
-00078350: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00078360: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
-00078370: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00078380: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00078390: 6173 6520 4747 4d4c 5f4f 505f 4144 4431  ase GGML_OP_ADD1
-000783a0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000783b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000783c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000783d0: 7761 7264 5f61 6464 3128 7061 7261 6d73  ward_add1(params
-000783e0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-000783f0: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
-00078400: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00078410: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00078420: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00078430: 5f41 4343 3a0a 2020 2020 2020 2020 2020  _ACC:.          
-00078440: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00078450: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00078460: 5f66 6f72 7761 7264 5f61 6363 2870 6172  _forward_acc(par
-00078470: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00078480: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
-00078490: 2074 656e 736f 722d 3e6f 7074 5b30 5d2c   tensor->opt[0],
-000784a0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-000784b0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000784c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000784d0: 5f4f 505f 5355 423a 0a20 2020 2020 2020  _OP_SUB:.       
-000784e0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000784f0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00078500: 7574 655f 666f 7277 6172 645f 7375 6228  ute_forward_sub(
-00078510: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00078520: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
-00078530: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
-00078540: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00078550: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00078560: 474d 4c5f 4f50 5f4d 554c 3a0a 2020 2020  GML_OP_MUL:.    
-00078570: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00078580: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00078590: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-000785a0: 756c 2870 6172 616d 732c 2074 656e 736f  ul(params, tenso
-000785b0: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
-000785c0: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
-000785d0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000785e0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000785f0: 6520 4747 4d4c 5f4f 505f 4449 563a 0a20  e GGML_OP_DIV:. 
-00078600: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00078610: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00078620: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00078630: 645f 6469 7628 7061 7261 6d73 2c20 7465  d_div(params, te
-00078640: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
-00078650: 6f72 2d3e 7372 6331 2c20 7465 6e73 6f72  or->src1, tensor
-00078660: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00078670: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00078680: 6361 7365 2047 474d 4c5f 4f50 5f53 5152  case GGML_OP_SQR
-00078690: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000786a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000786b0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000786c0: 7761 7264 5f73 7172 2870 6172 616d 732c  ward_sqr(params,
-000786d0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-000786e0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-000786f0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00078700: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00078710: 505f 5351 5254 3a0a 2020 2020 2020 2020  P_SQRT:.        
-00078720: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00078730: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00078740: 7465 5f66 6f72 7761 7264 5f73 7172 7428  te_forward_sqrt(
-00078750: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00078760: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
-00078770: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00078780: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00078790: 2047 474d 4c5f 4f50 5f4c 4f47 3a0a 2020   GGML_OP_LOG:.  
-000787a0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000787b0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000787c0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000787d0: 5f6c 6f67 2870 6172 616d 732c 2074 656e  _log(params, ten
-000787e0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-000787f0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00078800: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00078810: 2063 6173 6520 4747 4d4c 5f4f 505f 5355   case GGML_OP_SU
-00078820: 4d3a 0a20 2020 2020 2020 2020 2020 207b  M:.            {
-00078830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078840: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00078850: 7277 6172 645f 7375 6d28 7061 7261 6d73  rward_sum(params
-00078860: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00078870: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00078880: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00078890: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000788a0: 4f50 5f53 554d 5f52 4f57 533a 0a20 2020  OP_SUM_ROWS:.   
-000788b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000788c0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000788d0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000788e0: 7375 6d5f 726f 7773 2870 6172 616d 732c  sum_rows(params,
-000788f0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-00078900: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00078910: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00078920: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00078930: 505f 4d45 414e 3a0a 2020 2020 2020 2020  P_MEAN:.        
-00078940: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00078950: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00078960: 7465 5f66 6f72 7761 7264 5f6d 6561 6e28  te_forward_mean(
-00078970: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00078980: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
-00078990: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000789a0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-000789b0: 2047 474d 4c5f 4f50 5f52 4550 4541 543a   GGML_OP_REPEAT:
-000789c0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000789d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000789e0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000789f0: 6172 645f 7265 7065 6174 2870 6172 616d  ard_repeat(param
-00078a00: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-00078a10: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00078a20: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00078a30: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00078a40: 5f4f 505f 5245 5045 4154 5f42 4143 4b3a  _OP_REPEAT_BACK:
-00078a50: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00078a60: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00078a70: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00078a80: 6172 645f 7265 7065 6174 5f62 6163 6b28  ard_repeat_back(
-00078a90: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00078aa0: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
-00078ab0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00078ac0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00078ad0: 2047 474d 4c5f 4f50 5f41 4253 3a0a 2020   GGML_OP_ABS:.  
-00078ae0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00078af0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00078b00: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00078b10: 5f61 6273 2870 6172 616d 732c 2074 656e  _abs(params, ten
-00078b20: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00078b30: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00078b40: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00078b50: 2063 6173 6520 4747 4d4c 5f4f 505f 5347   case GGML_OP_SG
-00078b60: 4e3a 0a20 2020 2020 2020 2020 2020 207b  N:.            {
-00078b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078b80: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00078b90: 7277 6172 645f 7367 6e28 7061 7261 6d73  rward_sgn(params
-00078ba0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00078bb0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00078bc0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00078bd0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00078be0: 4f50 5f4e 4547 3a0a 2020 2020 2020 2020  OP_NEG:.        
-00078bf0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00078c00: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00078c10: 7465 5f66 6f72 7761 7264 5f6e 6567 2870  te_forward_neg(p
-00078c20: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00078c30: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
-00078c40: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00078c50: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00078c60: 4747 4d4c 5f4f 505f 5354 4550 3a0a 2020  GGML_OP_STEP:.  
-00078c70: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00078c80: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00078c90: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00078ca0: 5f73 7465 7028 7061 7261 6d73 2c20 7465  _step(params, te
-00078cb0: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
-00078cc0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00078cd0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00078ce0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-00078cf0: 454c 553a 0a20 2020 2020 2020 2020 2020  ELU:.           
-00078d00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00078d10: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00078d20: 666f 7277 6172 645f 7265 6c75 2870 6172  forward_relu(par
-00078d30: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00078d40: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
-00078d50: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00078d60: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00078d70: 4d4c 5f4f 505f 4745 4c55 3a0a 2020 2020  ML_OP_GELU:.    
-00078d80: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00078d90: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00078da0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
-00078db0: 656c 7528 7061 7261 6d73 2c20 7465 6e73  elu(params, tens
-00078dc0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00078dd0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00078de0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00078df0: 6361 7365 2047 474d 4c5f 4f50 5f47 454c  case GGML_OP_GEL
-00078e00: 555f 5155 4943 4b3a 0a20 2020 2020 2020  U_QUICK:.       
-00078e10: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00078e20: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00078e30: 7574 655f 666f 7277 6172 645f 6765 6c75  ute_forward_gelu
-00078e40: 5f71 7569 636b 2870 6172 616d 732c 2074  _quick(params, t
-00078e50: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-00078e60: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00078e70: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00078e80: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00078e90: 5349 4c55 3a0a 2020 2020 2020 2020 2020  SILU:.          
-00078ea0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00078eb0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00078ec0: 5f66 6f72 7761 7264 5f73 696c 7528 7061  _forward_silu(pa
-00078ed0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00078ee0: 6330 2c20 7465 6e73 6f72 293b 0a20 2020  c0, tensor);.   
-00078ef0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00078f00: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00078f10: 474d 4c5f 4f50 5f53 494c 555f 4241 434b  GML_OP_SILU_BACK
-00078f20: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00078f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078f40: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00078f50: 7761 7264 5f73 696c 755f 6261 636b 2870  ward_silu_back(p
-00078f60: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00078f70: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
-00078f80: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
-00078f90: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00078fa0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00078fb0: 4d4c 5f4f 505f 4e4f 524d 3a0a 2020 2020  ML_OP_NORM:.    
-00078fc0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00078fd0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00078fe0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6e  ompute_forward_n
-00078ff0: 6f72 6d28 7061 7261 6d73 2c20 7465 6e73  orm(params, tens
-00079000: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00079010: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00079020: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00079030: 6361 7365 2047 474d 4c5f 4f50 5f52 4d53  case GGML_OP_RMS
-00079040: 5f4e 4f52 4d3a 0a20 2020 2020 2020 2020  _NORM:.         
-00079050: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00079060: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00079070: 655f 666f 7277 6172 645f 726d 735f 6e6f  e_forward_rms_no
-00079080: 726d 2870 6172 616d 732c 2074 656e 736f  rm(params, tenso
-00079090: 722d 3e73 7263 302c 2074 656e 736f 7229  r->src0, tensor)
-000790a0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000790b0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000790c0: 6173 6520 4747 4d4c 5f4f 505f 524d 535f  ase GGML_OP_RMS_
-000790d0: 4e4f 524d 5f42 4143 4b3a 0a20 2020 2020  NORM_BACK:.     
-000790e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000790f0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00079100: 6d70 7574 655f 666f 7277 6172 645f 726d  mpute_forward_rm
-00079110: 735f 6e6f 726d 5f62 6163 6b28 7061 7261  s_norm_back(para
-00079120: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00079130: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
-00079140: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00079150: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00079160: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00079170: 4f50 5f4d 554c 5f4d 4154 3a0a 2020 2020  OP_MUL_MAT:.    
-00079180: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00079190: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-000791a0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-000791b0: 756c 5f6d 6174 2870 6172 616d 732c 2074  ul_mat(params, t
-000791c0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-000791d0: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
-000791e0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-000791f0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00079200: 2063 6173 6520 4747 4d4c 5f4f 505f 4f55   case GGML_OP_OU
-00079210: 545f 5052 4f44 3a0a 2020 2020 2020 2020  T_PROD:.        
-00079220: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00079230: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00079240: 7465 5f66 6f72 7761 7264 5f6f 7574 5f70  te_forward_out_p
-00079250: 726f 6428 7061 7261 6d73 2c20 7465 6e73  rod(params, tens
-00079260: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00079270: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
-00079280: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00079290: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-000792a0: 7365 2047 474d 4c5f 4f50 5f53 4341 4c45  se GGML_OP_SCALE
-000792b0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000792c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000792d0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000792e0: 7761 7264 5f73 6361 6c65 2870 6172 616d  ward_scale(param
-000792f0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-00079300: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
-00079310: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00079320: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00079330: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00079340: 505f 5345 543a 0a20 2020 2020 2020 2020  P_SET:.         
-00079350: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00079360: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00079370: 655f 666f 7277 6172 645f 7365 7428 7061  e_forward_set(pa
-00079380: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00079390: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
-000793a0: 2c20 7465 6e73 6f72 2d3e 6f70 745b 305d  , tensor->opt[0]
-000793b0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-000793c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-000793d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000793e0: 4c5f 4f50 5f43 5059 3a0a 2020 2020 2020  L_OP_CPY:.      
-000793f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00079400: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00079410: 7075 7465 5f66 6f72 7761 7264 5f63 7079  pute_forward_cpy
-00079420: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00079430: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-00079440: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00079450: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00079460: 6520 4747 4d4c 5f4f 505f 434f 4e54 3a0a  e GGML_OP_CONT:.
-00079470: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00079480: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00079490: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000794a0: 7264 5f63 6f6e 7428 7061 7261 6d73 2c20  rd_cont(params, 
-000794b0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-000794c0: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-000794d0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000794e0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000794f0: 5f52 4553 4841 5045 3a0a 2020 2020 2020  _RESHAPE:.      
-00079500: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00079510: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00079520: 7075 7465 5f66 6f72 7761 7264 5f72 6573  pute_forward_res
-00079530: 6861 7065 2870 6172 616d 732c 2074 656e  hape(params, ten
-00079540: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00079550: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00079560: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00079570: 2063 6173 6520 4747 4d4c 5f4f 505f 5649   case GGML_OP_VI
-00079580: 4557 3a0a 2020 2020 2020 2020 2020 2020  EW:.            
-00079590: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000795a0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-000795b0: 6f72 7761 7264 5f76 6965 7728 7061 7261  orward_view(para
-000795c0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-000795d0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000795e0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000795f0: 6361 7365 2047 474d 4c5f 4f50 5f50 4552  case GGML_OP_PER
-00079600: 4d55 5445 3a0a 2020 2020 2020 2020 2020  MUTE:.          
-00079610: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00079620: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00079630: 5f66 6f72 7761 7264 5f70 6572 6d75 7465  _forward_permute
-00079640: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00079650: 3e73 7263 3029 3b0a 2020 2020 2020 2020  >src0);.        
-00079660: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00079670: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00079680: 505f 5452 414e 5350 4f53 453a 0a20 2020  P_TRANSPOSE:.   
-00079690: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000796a0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000796b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000796c0: 7472 616e 7370 6f73 6528 7061 7261 6d73  transpose(params
-000796d0: 2c20 7465 6e73 6f72 2d3e 7372 6330 293b  , tensor->src0);
-000796e0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-000796f0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00079700: 7365 2047 474d 4c5f 4f50 5f47 4554 5f52  se GGML_OP_GET_R
-00079710: 4f57 533a 0a20 2020 2020 2020 2020 2020  OWS:.           
-00079720: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00079730: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00079740: 666f 7277 6172 645f 6765 745f 726f 7773  forward_get_rows
-00079750: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00079760: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
-00079770: 7263 312c 2074 656e 736f 7229 3b0a 2020  rc1, tensor);.  
-00079780: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00079790: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000797a0: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
-000797b0: 5f42 4143 4b3a 0a20 2020 2020 2020 2020  _BACK:.         
-000797c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000797d0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-000797e0: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
-000797f0: 7773 5f62 6163 6b28 7061 7261 6d73 2c20  ws_back(params, 
-00079800: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-00079810: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
-00079820: 6f72 2d3e 6f70 745b 305d 2c20 7465 6e73  or->opt[0], tens
-00079830: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00079840: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00079850: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
-00079860: 4941 473a 0a20 2020 2020 2020 2020 2020  IAG:.           
-00079870: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00079880: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00079890: 666f 7277 6172 645f 6469 6167 2870 6172  forward_diag(par
-000798a0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-000798b0: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
-000798c0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000798d0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000798e0: 4d4c 5f4f 505f 4449 4147 5f4d 4153 4b5f  ML_OP_DIAG_MASK_
-000798f0: 494e 463a 0a20 2020 2020 2020 2020 2020  INF:.           
-00079900: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00079910: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00079920: 666f 7277 6172 645f 6469 6167 5f6d 6173  forward_diag_mas
-00079930: 6b5f 696e 6628 7061 7261 6d73 2c20 7465  k_inf(params, te
-00079940: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
-00079950: 6f72 2d3e 7372 6331 2c20 7465 6e73 6f72  or->src1, tensor
-00079960: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00079970: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00079980: 6361 7365 2047 474d 4c5f 4f50 5f44 4941  case GGML_OP_DIA
-00079990: 475f 4d41 534b 5f5a 4552 4f3a 0a20 2020  G_MASK_ZERO:.   
-000799a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000799b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000799c0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000799d0: 6469 6167 5f6d 6173 6b5f 7a65 726f 2870  diag_mask_zero(p
-000799e0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-000799f0: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
-00079a00: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
-00079a10: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00079a20: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00079a30: 4d4c 5f4f 505f 534f 4654 5f4d 4158 3a0a  ML_OP_SOFT_MAX:.
-00079a40: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00079a50: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00079a60: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00079a70: 7264 5f73 6f66 745f 6d61 7828 7061 7261  rd_soft_max(para
-00079a80: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00079a90: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00079aa0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00079ab0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00079ac0: 4c5f 4f50 5f53 4f46 545f 4d41 585f 4241  L_OP_SOFT_MAX_BA
-00079ad0: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
-00079ae0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00079af0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00079b00: 6f72 7761 7264 5f73 6f66 745f 6d61 785f  orward_soft_max_
-00079b10: 6261 636b 2870 6172 616d 732c 2074 656e  back(params, ten
-00079b20: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00079b30: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
-00079b40: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00079b50: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00079b60: 6173 6520 4747 4d4c 5f4f 505f 524f 5045  ase GGML_OP_ROPE
-00079b70: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00079b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079b90: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00079ba0: 7761 7264 5f72 6f70 6528 7061 7261 6d73  ward_rope(params
-00079bb0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00079bc0: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
-00079bd0: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00079be0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00079bf0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00079c00: 5f52 4f50 455f 4241 434b 3a0a 2020 2020  _ROPE_BACK:.    
-00079c10: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00079c20: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00079c30: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
-00079c40: 6f70 655f 6261 636b 2870 6172 616d 732c  ope_back(params,
-00079c50: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-00079c60: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
-00079c70: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00079c80: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00079c90: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00079ca0: 414c 4942 493a 0a20 2020 2020 2020 2020  ALIBI:.         
-00079cb0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00079cc0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00079cd0: 655f 666f 7277 6172 645f 616c 6962 6928  e_forward_alibi(
-00079ce0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00079cf0: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
-00079d00: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
-00079d10: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00079d20: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00079d30: 474d 4c5f 4f50 5f43 4c41 4d50 3a0a 2020  GML_OP_CLAMP:.  
-00079d40: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00079d50: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00079d60: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00079d70: 5f63 6c61 6d70 2870 6172 616d 732c 2074  _clamp(params, t
-00079d80: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-00079d90: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
-00079da0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00079db0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00079dc0: 2063 6173 6520 4747 4d4c 5f4f 505f 434f   case GGML_OP_CO
-00079dd0: 4e56 5f31 445f 5331 5f50 483a 0a20 2020  NV_1D_S1_PH:.   
-00079de0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00079df0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00079e00: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00079e10: 636f 6e76 5f31 645f 7331 5f70 6828 7061  conv_1d_s1_ph(pa
-00079e20: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00079e30: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
-00079e40: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00079e50: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00079e60: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00079e70: 4c5f 4f50 5f43 4f4e 565f 3144 5f53 325f  L_OP_CONV_1D_S2_
-00079e80: 5048 3a0a 2020 2020 2020 2020 2020 2020  PH:.            
-00079e90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00079ea0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00079eb0: 6f72 7761 7264 5f63 6f6e 765f 3164 5f73  orward_conv_1d_s
-00079ec0: 325f 7068 2870 6172 616d 732c 2074 656e  2_ph(params, ten
-00079ed0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00079ee0: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
-00079ef0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00079f00: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00079f10: 6173 6520 4747 4d4c 5f4f 505f 434f 4e56  ase GGML_OP_CONV
-00079f20: 5f32 445f 534b 5f50 303a 0a20 2020 2020  _2D_SK_P0:.     
-00079f30: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00079f40: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00079f50: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
-00079f60: 6e76 5f32 645f 736b 5f70 3028 7061 7261  nv_2d_sk_p0(para
-00079f70: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00079f80: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
-00079f90: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00079fa0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00079fb0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00079fc0: 4f50 5f46 4c41 5348 5f41 5454 4e3a 0a20  OP_FLASH_ATTN:. 
-00079fd0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00079fe0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00079ff0: 7374 2069 6e74 3332 5f74 2074 203d 2067  st int32_t t = g
-0007a000: 676d 6c5f 6765 745f 6933 325f 3164 2874  gml_get_i32_1d(t
-0007a010: 656e 736f 722d 3e6f 7074 5b31 5d2c 2030  ensor->opt[1], 0
-0007a020: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007a030: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
-0007a040: 203d 3d20 3020 7c7c 2074 203d 3d20 3129   == 0 || t == 1)
-0007a050: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007a060: 2020 636f 6e73 7420 626f 6f6c 206d 6173    const bool mas
-0007a070: 6b65 6420 3d20 7420 213d 2030 3b0a 2020  ked = t != 0;.  
-0007a080: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0007a090: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0007a0a0: 7264 5f66 6c61 7368 5f61 7474 6e28 7061  rd_flash_attn(pa
-0007a0b0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-0007a0c0: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
-0007a0d0: 2c20 7465 6e73 6f72 2d3e 6f70 745b 305d  , tensor->opt[0]
-0007a0e0: 2c20 6d61 736b 6564 2c20 7465 6e73 6f72  , masked, tensor
-0007a0f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0007a100: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0007a110: 6361 7365 2047 474d 4c5f 4f50 5f46 4c41  case GGML_OP_FLA
-0007a120: 5348 5f46 463a 0a20 2020 2020 2020 2020  SH_FF:.         
-0007a130: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0007a140: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-0007a150: 655f 666f 7277 6172 645f 666c 6173 685f  e_forward_flash_
-0007a160: 6666 2870 6172 616d 732c 2074 656e 736f  ff(params, tenso
-0007a170: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
-0007a180: 3e73 7263 312c 2074 656e 736f 722d 3e6f  >src1, tensor->o
-0007a190: 7074 5b30 5d2c 2074 656e 736f 722d 3e6f  pt[0], tensor->o
-0007a1a0: 7074 5b31 5d2c 2074 656e 736f 722d 3e6f  pt[1], tensor->o
-0007a1b0: 7074 5b32 5d2c 2074 656e 736f 7229 3b0a  pt[2], tensor);.
-0007a1c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0007a1d0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0007a1e0: 6520 4747 4d4c 5f4f 505f 464c 4153 485f  e GGML_OP_FLASH_
-0007a1f0: 4154 544e 5f42 4143 4b3a 0a20 2020 2020  ATTN_BACK:.     
-0007a200: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0007a210: 2020 2020 2020 2020 2069 6e74 3332 5f74           int32_t
-0007a220: 2074 203d 2067 676d 6c5f 6765 745f 6933   t = ggml_get_i3
-0007a230: 325f 3164 2874 656e 736f 722d 3e6f 7074  2_1d(tensor->opt
-0007a240: 5b32 5d2c 2030 293b 0a20 2020 2020 2020  [2], 0);.       
-0007a250: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-0007a260: 5345 5254 2874 203d 3d20 3020 7c7c 2074  SERT(t == 0 || t
-0007a270: 203d 3d20 3129 3b0a 2020 2020 2020 2020   == 1);.        
-0007a280: 2020 2020 2020 2020 626f 6f6c 206d 6173          bool mas
-0007a290: 6b65 6420 3d20 7420 213d 2030 3b0a 2020  ked = t != 0;.  
-0007a2a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0007a2b0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0007a2c0: 7264 5f66 6c61 7368 5f61 7474 6e5f 6261  rd_flash_attn_ba
-0007a2d0: 636b 2870 6172 616d 732c 2074 656e 736f  ck(params, tenso
-0007a2e0: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
-0007a2f0: 3e73 7263 312c 2074 656e 736f 722d 3e6f  >src1, tensor->o
-0007a300: 7074 5b30 5d2c 2074 656e 736f 722d 3e6f  pt[0], tensor->o
-0007a310: 7074 5b31 5d2c 206d 6173 6b65 642c 2074  pt[1], masked, t
-0007a320: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-0007a330: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007a340: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007a350: 505f 5749 4e5f 5041 5254 3a0a 2020 2020  P_WIN_PART:.    
-0007a360: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007a370: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-0007a380: 6f6d 7075 7465 5f66 6f72 7761 7264 5f77  ompute_forward_w
-0007a390: 696e 5f70 6172 7428 7061 7261 6d73 2c20  in_part(params, 
-0007a3a0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-0007a3b0: 6e73 6f72 2d3e 6f70 745b 305d 2c20 7465  nsor->opt[0], te
-0007a3c0: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-0007a3d0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0007a3e0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007a3f0: 5f57 494e 5f55 4e50 4152 543a 0a20 2020  _WIN_UNPART:.   
-0007a400: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0007a410: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007a420: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0007a430: 7769 6e5f 756e 7061 7274 2870 6172 616d  win_unpart(param
-0007a440: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-0007a450: 2074 656e 736f 722d 3e6f 7074 5b30 5d2c   tensor->opt[0],
-0007a460: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-0007a470: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0007a480: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0007a490: 5f4f 505f 4d41 505f 554e 4152 593a 0a20  _OP_MAP_UNARY:. 
-0007a4a0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0007a4b0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0007a4c0: 7374 2067 676d 6c5f 756e 6172 795f 6f70  st ggml_unary_op
-0007a4d0: 5f66 3332 5f74 2066 756e 203d 202a 2828  _f32_t fun = *((
-0007a4e0: 6767 6d6c 5f75 6e61 7279 5f6f 705f 6633  ggml_unary_op_f3
-0007a4f0: 325f 7420 2a29 7465 6e73 6f72 2d3e 6f70  2_t *)tensor->op
-0007a500: 745b 305d 2d3e 6461 7461 293b 0a20 2020  t[0]->data);.   
-0007a510: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0007a520: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0007a530: 645f 6d61 705f 756e 6172 7928 7061 7261  d_map_unary(para
-0007a540: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-0007a550: 2c20 7465 6e73 6f72 2c20 6675 6e29 3b0a  , tensor, fun);.
-0007a560: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007a570: 2020 2020 2020 2020 2020 6272 6561 6b3b            break;
-0007a580: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0007a590: 4d4c 5f4f 505f 4d41 505f 4249 4e41 5259  ML_OP_MAP_BINARY
-0007a5a0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0007a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a5c0: 636f 6e73 7420 6767 6d6c 5f62 696e 6172  const ggml_binar
-0007a5d0: 795f 6f70 5f66 3332 5f74 2066 756e 203d  y_op_f32_t fun =
-0007a5e0: 202a 2828 6767 6d6c 5f62 696e 6172 795f   *((ggml_binary_
-0007a5f0: 6f70 5f66 3332 5f74 202a 2974 656e 736f  op_f32_t *)tenso
-0007a600: 722d 3e6f 7074 5b30 5d2d 3e64 6174 6129  r->opt[0]->data)
-0007a610: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007a620: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-0007a630: 6f72 7761 7264 5f6d 6170 5f62 696e 6172  orward_map_binar
-0007a640: 7928 7061 7261 6d73 2c20 7465 6e73 6f72  y(params, tensor
-0007a650: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
-0007a660: 7372 6331 2c20 7465 6e73 6f72 2c20 6675  src1, tensor, fu
-0007a670: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
-0007a680: 7d0a 2020 2020 2020 2020 2020 2020 6272  }.            br
-0007a690: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0007a6a0: 6520 4747 4d4c 5f4f 505f 4d41 505f 4355  e GGML_OP_MAP_CU
-0007a6b0: 5354 4f4d 313a 0a20 2020 2020 2020 2020  STOM1:.         
-0007a6c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0007a6d0: 2020 2020 2063 6f6e 7374 2067 676d 6c5f       const ggml_
-0007a6e0: 6375 7374 6f6d 315f 6f70 5f66 3332 5f74  custom1_op_f32_t
-0007a6f0: 2066 756e 203d 202a 2828 6767 6d6c 5f63   fun = *((ggml_c
-0007a700: 7573 746f 6d31 5f6f 705f 6633 325f 7420  ustom1_op_f32_t 
-0007a710: 2a29 7465 6e73 6f72 2d3e 6f70 745b 305d  *)tensor->opt[0]
-0007a720: 2d3e 6461 7461 293b 0a20 2020 2020 2020  ->data);.       
-0007a730: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-0007a740: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
-0007a750: 705f 6375 7374 6f6d 3128 7061 7261 6d73  p_custom1(params
-0007a760: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-0007a770: 7465 6e73 6f72 2c20 6675 6e29 3b0a 2020  tensor, fun);.  
-0007a780: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0007a790: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-0007a7a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0007a7b0: 5f4f 505f 4d41 505f 4355 5354 4f4d 323a  _OP_MAP_CUSTOM2:
-0007a7c0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0007a7d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007a7e0: 6f6e 7374 2067 676d 6c5f 6375 7374 6f6d  onst ggml_custom
-0007a7f0: 325f 6f70 5f66 3332 5f74 2066 756e 203d  2_op_f32_t fun =
-0007a800: 202a 2828 6767 6d6c 5f63 7573 746f 6d32   *((ggml_custom2
-0007a810: 5f6f 705f 6633 325f 7420 2a29 7465 6e73  _op_f32_t *)tens
-0007a820: 6f72 2d3e 6f70 745b 305d 2d3e 6461 7461  or->opt[0]->data
-0007a830: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007a840: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-0007a850: 666f 7277 6172 645f 6d61 705f 6375 7374  forward_map_cust
-0007a860: 6f6d 3228 7061 7261 6d73 2c20 7465 6e73  om2(params, tens
-0007a870: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-0007a880: 2d3e 7372 6331 2c20 7465 6e73 6f72 2c20  ->src1, tensor, 
-0007a890: 6675 6e29 3b0a 2020 2020 2020 2020 2020  fun);.          
-0007a8a0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007a8b0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0007a8c0: 6173 6520 4747 4d4c 5f4f 505f 4d41 505f  ase GGML_OP_MAP_
-0007a8d0: 4355 5354 4f4d 333a 0a20 2020 2020 2020  CUSTOM3:.       
-0007a8e0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0007a8f0: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
-0007a900: 6c5f 6375 7374 6f6d 335f 6f70 5f66 3332  l_custom3_op_f32
-0007a910: 5f74 2066 756e 203d 202a 2828 6767 6d6c  _t fun = *((ggml
-0007a920: 5f63 7573 746f 6d33 5f6f 705f 6633 325f  _custom3_op_f32_
-0007a930: 7420 2a29 7465 6e73 6f72 2d3e 6f70 745b  t *)tensor->opt[
-0007a940: 305d 2d3e 6461 7461 293b 0a20 2020 2020  0]->data);.     
-0007a950: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007a960: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0007a970: 6d61 705f 6375 7374 6f6d 3328 7061 7261  map_custom3(para
-0007a980: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-0007a990: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
-0007a9a0: 7465 6e73 6f72 2d3e 6f70 745b 315d 2c20  tensor->opt[1], 
-0007a9b0: 7465 6e73 6f72 2c20 6675 6e29 3b0a 2020  tensor, fun);.  
-0007a9c0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0007a9d0: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-0007a9e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0007a9f0: 5f4f 505f 4352 4f53 535f 454e 5452 4f50  _OP_CROSS_ENTROP
-0007aa00: 595f 4c4f 5353 3a0a 2020 2020 2020 2020  Y_LOSS:.        
-0007aa10: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007aa20: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-0007aa30: 7465 5f66 6f72 7761 7264 5f63 726f 7373  te_forward_cross
-0007aa40: 5f65 6e74 726f 7079 5f6c 6f73 7328 7061  _entropy_loss(pa
-0007aa50: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-0007aa60: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
-0007aa70: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-0007aa80: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0007aa90: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
-0007aaa0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007aab0: 5f43 524f 5353 5f45 4e54 524f 5059 5f4c  _CROSS_ENTROPY_L
-0007aac0: 4f53 535f 4241 434b 3a0a 2020 2020 2020  OSS_BACK:.      
-0007aad0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0007aae0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-0007aaf0: 7075 7465 5f66 6f72 7761 7264 5f63 726f  pute_forward_cro
-0007ab00: 7373 5f65 6e74 726f 7079 5f6c 6f73 735f  ss_entropy_loss_
-0007ab10: 6261 636b 2870 6172 616d 732c 2074 656e  back(params, ten
-0007ab20: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-0007ab30: 722d 3e73 7263 312c 2074 656e 736f 722d  r->src1, tensor-
-0007ab40: 3e6f 7074 5b30 5d2c 2074 656e 736f 7229  >opt[0], tensor)
-0007ab50: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-0007ab60: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0007ab70: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0007ab80: 4747 4d4c 5f4f 505f 4e4f 4e45 3a0a 2020  GGML_OP_NONE:.  
-0007ab90: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0007aba0: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
-0007abb0: 6f70 0a20 2020 2020 2020 2020 2020 207d  op.            }
-0007abc0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0007abd0: 6361 7365 2047 474d 4c5f 4f50 5f43 4f55  case GGML_OP_COU
-0007abe0: 4e54 3a0a 2020 2020 2020 2020 2020 2020  NT:.            
-0007abf0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007ac00: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-0007ac10: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
-0007ac20: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
-0007ac30: 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .}..////////////
-0007ac40: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0007ac50: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0007ac60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0007ac70: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0007ac80: 2f2f 2f2f 0a0a 7374 6174 6963 2076 6f69  ////..static voi
-0007ac90: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f62  d ggml_compute_b
-0007aca0: 6163 6b77 6172 6428 7374 7275 6374 2067  ackward(struct g
-0007acb0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-0007acc0: 782c 2073 7472 7563 7420 6767 6d6c 5f74  x, struct ggml_t
-0007acd0: 656e 736f 7220 2a20 7465 6e73 6f72 2c20  ensor * tensor, 
-0007ace0: 626f 6f6c 2069 6e70 6c61 6365 2920 7b0a  bool inplace) {.
-0007acf0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0007ad00: 7465 6e73 6f72 202a 2073 7263 3020 3d20  tensor * src0 = 
-0007ad10: 7465 6e73 6f72 2d3e 7372 6330 3b0a 2020  tensor->src0;.  
-0007ad20: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0007ad30: 6e73 6f72 202a 2073 7263 3120 3d20 7465  nsor * src1 = te
-0007ad40: 6e73 6f72 2d3e 7372 6331 3b0a 0a20 2020  nsor->src1;..   
-0007ad50: 2073 7769 7463 6820 2874 656e 736f 722d   switch (tensor-
-0007ad60: 3e6f 7029 207b 0a20 2020 2020 2020 2063  >op) {.        c
-0007ad70: 6173 6520 4747 4d4c 5f4f 505f 4455 503a  ase GGML_OP_DUP:
-0007ad80: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0007ad90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007ada0: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
-0007adb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007adc0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-0007add0: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
-0007ade0: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-0007adf0: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
-0007ae00: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-0007ae10: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007ae20: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0007ae30: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007ae40: 4c5f 4f50 5f41 4444 3a0a 2020 2020 2020  L_OP_ADD:.      
-0007ae50: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0007ae60: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
-0007ae70: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-0007ae80: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0007ae90: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
-0007aea0: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
-0007aeb0: 6330 2d3e 6772 6164 2c20 7465 6e73 6f72  c0->grad, tensor
-0007aec0: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
-0007aed0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007aee0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007aef0: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
-0007af00: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007af10: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-0007af20: 6772 6164 203d 2067 676d 6c5f 6164 645f  grad = ggml_add_
-0007af30: 696d 706c 2863 7478 2c20 7372 6331 2d3e  impl(ctx, src1->
-0007af40: 6772 6164 2c20 7465 6e73 6f72 2d3e 6772  grad, tensor->gr
-0007af50: 6164 2c20 696e 706c 6163 6529 3b0a 2020  ad, inplace);.  
-0007af60: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0007af70: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0007af80: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0007af90: 6520 4747 4d4c 5f4f 505f 4144 4431 3a0a  e GGML_OP_ADD1:.
-0007afa0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0007afb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0007afc0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-0007afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007afe0: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-0007aff0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0007b000: 7478 2c20 7372 6330 2d3e 6772 6164 2c20  tx, src0->grad, 
-0007b010: 7465 6e73 6f72 2d3e 6772 6164 2c20 696e  tensor->grad, in
-0007b020: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-0007b030: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0007b040: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-0007b050: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
-0007b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b070: 7372 6331 2d3e 6772 6164 203d 2067 676d  src1->grad = ggm
-0007b080: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
-0007b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b0a0: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
-0007b0b0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-0007b0c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007b0d0: 5f6d 6561 6e28 6374 782c 2074 656e 736f  _mean(ctx, tenso
-0007b0e0: 722d 3e67 7261 6429 2c20 2f2f 2054 4f44  r->grad), // TOD
-0007b0f0: 4f3a 2073 686f 756c 6420 7072 6f62 6162  O: should probab
-0007b100: 6c79 2062 6520 7375 6d20 696e 7374 6561  ly be sum instea
-0007b110: 6420 6f66 206d 6561 6e0a 2020 2020 2020  d of mean.      
-0007b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b130: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-0007b140: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007b150: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0007b160: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0007b170: 4747 4d4c 5f4f 505f 4143 433a 0a20 2020  GGML_OP_ACC:.   
-0007b180: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0007b190: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007b1a0: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0007b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b1c0: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
-0007b1d0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-0007b1e0: 2073 7263 302d 3e67 7261 642c 2074 656e   src0->grad, ten
-0007b1f0: 736f 722d 3e67 7261 642c 2069 6e70 6c61  sor->grad, inpla
-0007b200: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0007b210: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0007b220: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
-0007b230: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0007b240: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-0007b250: 4c5f 4153 5345 5254 2867 676d 6c5f 6e65  L_ASSERT(ggml_ne
-0007b260: 6c65 6d65 6e74 7328 7465 6e73 6f72 2d3e  lements(tensor->
-0007b270: 6f70 745b 305d 2920 3d3d 2035 293b 0a20  opt[0]) == 5);. 
-0007b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b290: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
-0007b2a0: 656e 736f 722d 3e6f 7074 5b30 5d2d 3e74  ensor->opt[0]->t
-0007b2b0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-0007b2c0: 5f49 3332 293b 0a20 2020 2020 2020 2020  _I32);.         
-0007b2d0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0007b2e0: 2073 697a 655f 7420 6e62 3120 2020 2020   size_t nb1     
-0007b2f0: 3d20 2828 2069 6e74 3332 5f74 202a 2029  = (( int32_t * )
-0007b300: 2074 656e 736f 722d 3e6f 7074 5b30 5d2d   tensor->opt[0]-
-0007b310: 3e64 6174 6129 5b30 5d3b 0a20 2020 2020  >data)[0];.     
-0007b320: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007b330: 6f6e 7374 2073 697a 655f 7420 6e62 3220  onst size_t nb2 
-0007b340: 2020 2020 3d20 2828 2069 6e74 3332 5f74      = (( int32_t
-0007b350: 202a 2029 2074 656e 736f 722d 3e6f 7074   * ) tensor->opt
-0007b360: 5b30 5d2d 3e64 6174 6129 5b31 5d3b 0a20  [0]->data)[1];. 
-0007b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b380: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0007b390: 6e62 3320 2020 2020 3d20 2828 2069 6e74  nb3     = (( int
-0007b3a0: 3332 5f74 202a 2029 2074 656e 736f 722d  32_t * ) tensor-
-0007b3b0: 3e6f 7074 5b30 5d2d 3e64 6174 6129 5b32  >opt[0]->data)[2
-0007b3c0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0007b3d0: 2020 2020 2020 2063 6f6e 7374 2073 697a         const siz
-0007b3e0: 655f 7420 6f66 6673 6574 2020 3d20 2828  e_t offset  = ((
-0007b3f0: 2069 6e74 3332 5f74 202a 2029 2074 656e   int32_t * ) ten
-0007b400: 736f 722d 3e6f 7074 5b30 5d2d 3e64 6174  sor->opt[0]->dat
-0007b410: 6129 5b33 5d3b 0a0a 2020 2020 2020 2020  a)[3];..        
-0007b420: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-0007b430: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0007b440: 2074 656e 736f 725f 6772 6164 5f76 6965   tensor_grad_vie
-0007b450: 7720 3d20 6767 6d6c 5f76 6965 775f 3464  w = ggml_view_4d
-0007b460: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-0007b470: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0007b480: 6e73 6f72 2d3e 6772 6164 2c0a 2020 2020  nsor->grad,.    
-0007b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b4a0: 2020 2020 7372 6331 2d3e 6772 6164 2d3e      src1->grad->
-0007b4b0: 6e65 5b30 5d2c 0a20 2020 2020 2020 2020  ne[0],.         
-0007b4c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007b4d0: 7263 312d 3e67 7261 642d 3e6e 655b 315d  rc1->grad->ne[1]
-0007b4e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007b4f0: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-0007b500: 6772 6164 2d3e 6e65 5b32 5d2c 0a20 2020  grad->ne[2],.   
-0007b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b520: 2020 2020 2073 7263 312d 3e67 7261 642d       src1->grad-
-0007b530: 3e6e 655b 335d 2c0a 2020 2020 2020 2020  >ne[3],.        
-0007b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b550: 6e62 312c 206e 6232 2c20 6e62 332c 206f  nb1, nb2, nb3, o
-0007b560: 6666 7365 7429 3b0a 0a20 2020 2020 2020  ffset);..       
-0007b570: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0007b580: 312d 3e67 7261 6420 3d0a 2020 2020 2020  1->grad =.      
-0007b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b5a0: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-0007b5b0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-0007b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b5d0: 2073 7263 312d 3e67 7261 642c 0a20 2020   src1->grad,.   
-0007b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b5f0: 2020 2020 2020 2020 2067 676d 6c5f 7265           ggml_re
-0007b600: 7368 6170 6528 6374 782c 0a20 2020 2020  shape(ctx,.     
+00078190: 7d0a 2020 2020 6966 2028 7465 6e73 6f72  }.    if (tensor
+000781a0: 2d3e 7372 6330 2021 3d20 4e55 4c4c 2026  ->src0 != NULL &
+000781b0: 2620 7465 6e73 6f72 2d3e 7372 6330 2d3e  & tensor->src0->
+000781c0: 6261 636b 656e 6420 213d 2047 474d 4c5f  backend != GGML_
+000781d0: 4241 434b 454e 445f 4350 5529 207b 0a20  BACKEND_CPU) {. 
+000781e0: 2020 2020 2020 2066 7072 696e 7466 2873         fprintf(s
+000781f0: 7464 6572 722c 2022 4355 4441 2063 6f6d  tderr, "CUDA com
+00078200: 7075 7465 2066 6169 6c65 6420 666f 7220  pute failed for 
+00078210: 6f70 2025 6420 7372 6330 2062 6163 6b65  op %d src0 backe
+00078220: 6e64 2025 645c 6e22 2c20 7465 6e73 6f72  nd %d\n", tensor
+00078230: 2d3e 6f70 2c20 7465 6e73 6f72 2d3e 7372  ->op, tensor->sr
+00078240: 6330 2d3e 6261 636b 656e 6429 3b0a 2020  c0->backend);.  
+00078250: 2020 7d0a 2020 2020 4747 4d4c 5f41 5353    }.    GGML_ASS
+00078260: 4552 5428 7465 6e73 6f72 2d3e 7372 6330  ERT(tensor->src0
+00078270: 203d 3d20 4e55 4c4c 207c 7c20 7465 6e73   == NULL || tens
+00078280: 6f72 2d3e 7372 6330 2d3e 6261 636b 656e  or->src0->backen
+00078290: 6420 3d3d 2047 474d 4c5f 4241 434b 454e  d == GGML_BACKEN
+000782a0: 445f 4350 5529 3b0a 2020 2020 6966 2028  D_CPU);.    if (
+000782b0: 7465 6e73 6f72 2d3e 7372 6331 2021 3d20  tensor->src1 != 
+000782c0: 4e55 4c4c 2026 2620 7465 6e73 6f72 2d3e  NULL && tensor->
+000782d0: 7372 6331 2d3e 6261 636b 656e 6420 213d  src1->backend !=
+000782e0: 2047 474d 4c5f 4241 434b 454e 445f 4350   GGML_BACKEND_CP
+000782f0: 5529 207b 0a20 2020 2020 2020 2066 7072  U) {.        fpr
+00078300: 696e 7466 2873 7464 6572 722c 2022 4355  intf(stderr, "CU
+00078310: 4441 2063 6f6d 7075 7465 2066 6169 6c65  DA compute faile
+00078320: 6420 666f 7220 6f70 2025 6420 7372 6331  d for op %d src1
+00078330: 2062 6163 6b65 6e64 2025 645c 6e22 2c20   backend %d\n", 
+00078340: 7465 6e73 6f72 2d3e 6f70 2c20 7465 6e73  tensor->op, tens
+00078350: 6f72 2d3e 7372 6331 2d3e 6261 636b 656e  or->src1->backen
+00078360: 6429 3b0a 2020 2020 7d0a 2020 2020 4747  d);.    }.    GG
+00078370: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
+00078380: 2d3e 7372 6331 203d 3d20 4e55 4c4c 207c  ->src1 == NULL |
+00078390: 7c20 7465 6e73 6f72 2d3e 7372 6331 2d3e  | tensor->src1->
+000783a0: 6261 636b 656e 6420 3d3d 2047 474d 4c5f  backend == GGML_
+000783b0: 4241 434b 454e 445f 4350 5529 3b0a 2365  BACKEND_CPU);.#e
+000783c0: 6e64 6966 202f 2f20 4747 4d4c 5f55 5345  ndif // GGML_USE
+000783d0: 5f43 5542 4c41 530a 0a20 2020 2073 7769  _CUBLAS..    swi
+000783e0: 7463 6820 2874 656e 736f 722d 3e6f 7029  tch (tensor->op)
+000783f0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00078400: 4747 4d4c 5f4f 505f 4455 503a 0a20 2020  GGML_OP_DUP:.   
+00078410: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00078420: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00078430: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00078440: 6475 7028 7061 7261 6d73 2c20 7465 6e73  dup(params, tens
+00078450: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00078460: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00078470: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00078480: 6361 7365 2047 474d 4c5f 4f50 5f41 4444  case GGML_OP_ADD
+00078490: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000784a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000784b0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000784c0: 7761 7264 5f61 6464 2870 6172 616d 732c  ward_add(params,
+000784d0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+000784e0: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
+000784f0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+00078500: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00078510: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00078520: 4144 4431 3a0a 2020 2020 2020 2020 2020  ADD1:.          
+00078530: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00078540: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00078550: 5f66 6f72 7761 7264 5f61 6464 3128 7061  _forward_add1(pa
+00078560: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00078570: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
+00078580: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+00078590: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000785a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000785b0: 4c5f 4f50 5f41 4343 3a0a 2020 2020 2020  L_OP_ACC:.      
+000785c0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000785d0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+000785e0: 7075 7465 5f66 6f72 7761 7264 5f61 6363  pute_forward_acc
+000785f0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00078600: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
+00078610: 7263 312c 2074 656e 736f 722d 3e6f 7074  rc1, tensor->opt
+00078620: 5b30 5d2c 2074 656e 736f 7229 3b0a 2020  [0], tensor);.  
+00078630: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00078640: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00078650: 4747 4d4c 5f4f 505f 5355 423a 0a20 2020  GGML_OP_SUB:.   
+00078660: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00078670: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00078680: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00078690: 7375 6228 7061 7261 6d73 2c20 7465 6e73  sub(params, tens
+000786a0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+000786b0: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
+000786c0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000786d0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+000786e0: 7365 2047 474d 4c5f 4f50 5f4d 554c 3a0a  se GGML_OP_MUL:.
+000786f0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00078700: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00078710: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00078720: 7264 5f6d 756c 2870 6172 616d 732c 2074  rd_mul(params, t
+00078730: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+00078740: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
+00078750: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00078760: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00078770: 2063 6173 6520 4747 4d4c 5f4f 505f 4449   case GGML_OP_DI
+00078780: 563a 0a20 2020 2020 2020 2020 2020 207b  V:.            {
+00078790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000787a0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000787b0: 7277 6172 645f 6469 7628 7061 7261 6d73  rward_div(params
+000787c0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+000787d0: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
+000787e0: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+000787f0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00078800: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00078810: 5f53 5152 3a0a 2020 2020 2020 2020 2020  _SQR:.          
+00078820: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00078830: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00078840: 5f66 6f72 7761 7264 5f73 7172 2870 6172  _forward_sqr(par
+00078850: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00078860: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
+00078870: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00078880: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00078890: 4d4c 5f4f 505f 5351 5254 3a0a 2020 2020  ML_OP_SQRT:.    
+000788a0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000788b0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+000788c0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+000788d0: 7172 7428 7061 7261 6d73 2c20 7465 6e73  qrt(params, tens
+000788e0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+000788f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00078900: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00078910: 6361 7365 2047 474d 4c5f 4f50 5f4c 4f47  case GGML_OP_LOG
+00078920: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00078930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078940: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00078950: 7761 7264 5f6c 6f67 2870 6172 616d 732c  ward_log(params,
+00078960: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+00078970: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00078980: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00078990: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000789a0: 505f 5355 4d3a 0a20 2020 2020 2020 2020  P_SUM:.         
+000789b0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000789c0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+000789d0: 655f 666f 7277 6172 645f 7375 6d28 7061  e_forward_sum(pa
+000789e0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+000789f0: 6330 2c20 7465 6e73 6f72 293b 0a20 2020  c0, tensor);.   
+00078a00: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00078a10: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00078a20: 474d 4c5f 4f50 5f53 554d 5f52 4f57 533a  GML_OP_SUM_ROWS:
+00078a30: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00078a40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00078a50: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00078a60: 6172 645f 7375 6d5f 726f 7773 2870 6172  ard_sum_rows(par
+00078a70: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00078a80: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
+00078a90: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00078aa0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00078ab0: 4d4c 5f4f 505f 4d45 414e 3a0a 2020 2020  ML_OP_MEAN:.    
+00078ac0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00078ad0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00078ae0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
+00078af0: 6561 6e28 7061 7261 6d73 2c20 7465 6e73  ean(params, tens
+00078b00: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00078b10: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00078b20: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00078b30: 6361 7365 2047 474d 4c5f 4f50 5f52 4550  case GGML_OP_REP
+00078b40: 4541 543a 0a20 2020 2020 2020 2020 2020  EAT:.           
+00078b50: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00078b60: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00078b70: 666f 7277 6172 645f 7265 7065 6174 2870  forward_repeat(p
+00078b80: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00078b90: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
+00078ba0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00078bb0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00078bc0: 4747 4d4c 5f4f 505f 5245 5045 4154 5f42  GGML_OP_REPEAT_B
+00078bd0: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
+00078be0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00078bf0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00078c00: 666f 7277 6172 645f 7265 7065 6174 5f62  forward_repeat_b
+00078c10: 6163 6b28 7061 7261 6d73 2c20 7465 6e73  ack(params, tens
+00078c20: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00078c30: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00078c40: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00078c50: 6361 7365 2047 474d 4c5f 4f50 5f41 4253  case GGML_OP_ABS
+00078c60: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00078c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078c80: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00078c90: 7761 7264 5f61 6273 2870 6172 616d 732c  ward_abs(params,
+00078ca0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+00078cb0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00078cc0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00078cd0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00078ce0: 505f 5347 4e3a 0a20 2020 2020 2020 2020  P_SGN:.         
+00078cf0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00078d00: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00078d10: 655f 666f 7277 6172 645f 7367 6e28 7061  e_forward_sgn(pa
+00078d20: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00078d30: 6330 2c20 7465 6e73 6f72 293b 0a20 2020  c0, tensor);.   
+00078d40: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00078d50: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00078d60: 474d 4c5f 4f50 5f4e 4547 3a0a 2020 2020  GML_OP_NEG:.    
+00078d70: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00078d80: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00078d90: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6e  ompute_forward_n
+00078da0: 6567 2870 6172 616d 732c 2074 656e 736f  eg(params, tenso
+00078db0: 722d 3e73 7263 302c 2074 656e 736f 7229  r->src0, tensor)
+00078dc0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00078dd0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00078de0: 6173 6520 4747 4d4c 5f4f 505f 5354 4550  ase GGML_OP_STEP
+00078df0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00078e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078e10: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00078e20: 7761 7264 5f73 7465 7028 7061 7261 6d73  ward_step(params
+00078e30: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+00078e40: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00078e50: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00078e60: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00078e70: 4f50 5f52 454c 553a 0a20 2020 2020 2020  OP_RELU:.       
+00078e80: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00078e90: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00078ea0: 7574 655f 666f 7277 6172 645f 7265 6c75  ute_forward_relu
+00078eb0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00078ec0: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
+00078ed0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00078ee0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00078ef0: 6520 4747 4d4c 5f4f 505f 4745 4c55 3a0a  e GGML_OP_GELU:.
+00078f00: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00078f10: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00078f20: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00078f30: 7264 5f67 656c 7528 7061 7261 6d73 2c20  rd_gelu(params, 
+00078f40: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+00078f50: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+00078f60: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00078f70: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00078f80: 5f47 454c 555f 5155 4943 4b3a 0a20 2020  _GELU_QUICK:.   
+00078f90: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00078fa0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00078fb0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00078fc0: 6765 6c75 5f71 7569 636b 2870 6172 616d  gelu_quick(param
+00078fd0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00078fe0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00078ff0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00079000: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00079010: 5f4f 505f 5349 4c55 3a0a 2020 2020 2020  _OP_SILU:.      
+00079020: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00079030: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00079040: 7075 7465 5f66 6f72 7761 7264 5f73 696c  pute_forward_sil
+00079050: 7528 7061 7261 6d73 2c20 7465 6e73 6f72  u(params, tensor
+00079060: 2d3e 7372 6330 2c20 7465 6e73 6f72 293b  ->src0, tensor);
+00079070: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00079080: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00079090: 7365 2047 474d 4c5f 4f50 5f53 494c 555f  se GGML_OP_SILU_
+000790a0: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
+000790b0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000790c0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+000790d0: 5f66 6f72 7761 7264 5f73 696c 755f 6261  _forward_silu_ba
+000790e0: 636b 2870 6172 616d 732c 2074 656e 736f  ck(params, tenso
+000790f0: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
+00079100: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
+00079110: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00079120: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00079130: 6520 4747 4d4c 5f4f 505f 4e4f 524d 3a0a  e GGML_OP_NORM:.
+00079140: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00079150: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00079160: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00079170: 7264 5f6e 6f72 6d28 7061 7261 6d73 2c20  rd_norm(params, 
+00079180: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+00079190: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+000791a0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+000791b0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+000791c0: 5f52 4d53 5f4e 4f52 4d3a 0a20 2020 2020  _RMS_NORM:.     
+000791d0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000791e0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+000791f0: 6d70 7574 655f 666f 7277 6172 645f 726d  mpute_forward_rm
+00079200: 735f 6e6f 726d 2870 6172 616d 732c 2074  s_norm(params, t
+00079210: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+00079220: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+00079230: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00079240: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00079250: 524d 535f 4e4f 524d 5f42 4143 4b3a 0a20  RMS_NORM_BACK:. 
+00079260: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00079270: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00079280: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00079290: 645f 726d 735f 6e6f 726d 5f62 6163 6b28  d_rms_norm_back(
+000792a0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+000792b0: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+000792c0: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
+000792d0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000792e0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000792f0: 474d 4c5f 4f50 5f4d 554c 5f4d 4154 3a0a  GML_OP_MUL_MAT:.
+00079300: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00079310: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00079320: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00079330: 7264 5f6d 756c 5f6d 6174 2870 6172 616d  rd_mul_mat(param
+00079340: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00079350: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
+00079360: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00079370: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00079380: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00079390: 505f 4f55 545f 5052 4f44 3a0a 2020 2020  P_OUT_PROD:.    
+000793a0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000793b0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+000793c0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6f  ompute_forward_o
+000793d0: 7574 5f70 726f 6428 7061 7261 6d73 2c20  ut_prod(params, 
+000793e0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+000793f0: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
+00079400: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00079410: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00079420: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+00079430: 4341 4c45 3a0a 2020 2020 2020 2020 2020  CALE:.          
+00079440: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00079450: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00079460: 5f66 6f72 7761 7264 5f73 6361 6c65 2870  _forward_scale(p
+00079470: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00079480: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
+00079490: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
+000794a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000794b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000794c0: 4d4c 5f4f 505f 5345 543a 0a20 2020 2020  ML_OP_SET:.     
+000794d0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000794e0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+000794f0: 6d70 7574 655f 666f 7277 6172 645f 7365  mpute_forward_se
+00079500: 7428 7061 7261 6d73 2c20 7465 6e73 6f72  t(params, tensor
+00079510: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
+00079520: 7372 6331 2c20 7465 6e73 6f72 2d3e 6f70  src1, tensor->op
+00079530: 745b 305d 2c20 7465 6e73 6f72 293b 0a20  t[0], tensor);. 
+00079540: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00079550: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00079560: 2047 474d 4c5f 4f50 5f43 5059 3a0a 2020   GGML_OP_CPY:.  
+00079570: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00079580: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00079590: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000795a0: 5f63 7079 2870 6172 616d 732c 2074 656e  _cpy(params, ten
+000795b0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+000795c0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+000795d0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+000795e0: 2063 6173 6520 4747 4d4c 5f4f 505f 434f   case GGML_OP_CO
+000795f0: 4e54 3a0a 2020 2020 2020 2020 2020 2020  NT:.            
+00079600: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00079610: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00079620: 6f72 7761 7264 5f63 6f6e 7428 7061 7261  orward_cont(para
+00079630: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+00079640: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+00079650: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00079660: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00079670: 4c5f 4f50 5f52 4553 4841 5045 3a0a 2020  L_OP_RESHAPE:.  
+00079680: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00079690: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000796a0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000796b0: 5f72 6573 6861 7065 2870 6172 616d 732c  _reshape(params,
+000796c0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+000796d0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+000796e0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000796f0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00079700: 505f 5649 4557 3a0a 2020 2020 2020 2020  P_VIEW:.        
+00079710: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00079720: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00079730: 7465 5f66 6f72 7761 7264 5f76 6965 7728  te_forward_view(
+00079740: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00079750: 7372 6330 293b 0a20 2020 2020 2020 2020  src0);.         
+00079760: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00079770: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00079780: 5f50 4552 4d55 5445 3a0a 2020 2020 2020  _PERMUTE:.      
+00079790: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000797a0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+000797b0: 7075 7465 5f66 6f72 7761 7264 5f70 6572  pute_forward_per
+000797c0: 6d75 7465 2870 6172 616d 732c 2074 656e  mute(params, ten
+000797d0: 736f 722d 3e73 7263 3029 3b0a 2020 2020  sor->src0);.    
+000797e0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000797f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00079800: 4d4c 5f4f 505f 5452 414e 5350 4f53 453a  ML_OP_TRANSPOSE:
+00079810: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00079820: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00079830: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00079840: 6172 645f 7472 616e 7370 6f73 6528 7061  ard_transpose(pa
+00079850: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00079860: 6330 293b 0a20 2020 2020 2020 2020 2020  c0);.           
+00079870: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00079880: 2020 6361 7365 2047 474d 4c5f 4f50 5f47    case GGML_OP_G
+00079890: 4554 5f52 4f57 533a 0a20 2020 2020 2020  ET_ROWS:.       
+000798a0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000798b0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+000798c0: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
+000798d0: 726f 7773 2870 6172 616d 732c 2074 656e  rows(params, ten
+000798e0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+000798f0: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
+00079900: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00079910: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00079920: 6173 6520 4747 4d4c 5f4f 505f 4745 545f  ase GGML_OP_GET_
+00079930: 524f 5753 5f42 4143 4b3a 0a20 2020 2020  ROWS_BACK:.     
+00079940: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00079950: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00079960: 6d70 7574 655f 666f 7277 6172 645f 6765  mpute_forward_ge
+00079970: 745f 726f 7773 5f62 6163 6b28 7061 7261  t_rows_back(para
+00079980: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+00079990: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
+000799a0: 7465 6e73 6f72 2d3e 6f70 745b 305d 2c20  tensor->opt[0], 
+000799b0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+000799c0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000799d0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000799e0: 4f50 5f44 4941 473a 0a20 2020 2020 2020  OP_DIAG:.       
+000799f0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00079a00: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00079a10: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
+00079a20: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00079a30: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
+00079a40: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00079a50: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00079a60: 6520 4747 4d4c 5f4f 505f 4449 4147 5f4d  e GGML_OP_DIAG_M
+00079a70: 4153 4b5f 494e 463a 0a20 2020 2020 2020  ASK_INF:.       
+00079a80: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00079a90: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00079aa0: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
+00079ab0: 5f6d 6173 6b5f 696e 6628 7061 7261 6d73  _mask_inf(params
+00079ac0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+00079ad0: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
+00079ae0: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+00079af0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00079b00: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00079b10: 5f44 4941 475f 4d41 534b 5f5a 4552 4f3a  _DIAG_MASK_ZERO:
+00079b20: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00079b30: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00079b40: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00079b50: 6172 645f 6469 6167 5f6d 6173 6b5f 7a65  ard_diag_mask_ze
+00079b60: 726f 2870 6172 616d 732c 2074 656e 736f  ro(params, tenso
+00079b70: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
+00079b80: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
+00079b90: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00079ba0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00079bb0: 6520 4747 4d4c 5f4f 505f 534f 4654 5f4d  e GGML_OP_SOFT_M
+00079bc0: 4158 3a0a 2020 2020 2020 2020 2020 2020  AX:.            
+00079bd0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00079be0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00079bf0: 6f72 7761 7264 5f73 6f66 745f 6d61 7828  orward_soft_max(
+00079c00: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00079c10: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
+00079c20: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00079c30: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00079c40: 2047 474d 4c5f 4f50 5f53 4f46 545f 4d41   GGML_OP_SOFT_MA
+00079c50: 585f 4241 434b 3a0a 2020 2020 2020 2020  X_BACK:.        
+00079c60: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00079c70: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00079c80: 7465 5f66 6f72 7761 7264 5f73 6f66 745f  te_forward_soft_
+00079c90: 6d61 785f 6261 636b 2870 6172 616d 732c  max_back(params,
+00079ca0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+00079cb0: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
+00079cc0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+00079cd0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00079ce0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00079cf0: 524f 5045 3a0a 2020 2020 2020 2020 2020  ROPE:.          
+00079d00: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00079d10: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00079d20: 5f66 6f72 7761 7264 5f72 6f70 6528 7061  _forward_rope(pa
+00079d30: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00079d40: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
+00079d50: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+00079d60: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00079d70: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00079d80: 4c5f 4f50 5f52 4f50 455f 4241 434b 3a0a  L_OP_ROPE_BACK:.
+00079d90: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00079da0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00079db0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00079dc0: 7264 5f72 6f70 655f 6261 636b 2870 6172  rd_rope_back(par
+00079dd0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00079de0: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
+00079df0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00079e00: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00079e10: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00079e20: 5f4f 505f 414c 4942 493a 0a20 2020 2020  _OP_ALIBI:.     
+00079e30: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00079e40: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00079e50: 6d70 7574 655f 666f 7277 6172 645f 616c  mpute_forward_al
+00079e60: 6962 6928 7061 7261 6d73 2c20 7465 6e73  ibi(params, tens
+00079e70: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00079e80: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
+00079e90: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00079ea0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00079eb0: 7365 2047 474d 4c5f 4f50 5f43 4c41 4d50  se GGML_OP_CLAMP
+00079ec0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00079ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079ee0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00079ef0: 7761 7264 5f63 6c61 6d70 2870 6172 616d  ward_clamp(param
+00079f00: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00079f10: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
+00079f20: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00079f30: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00079f40: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00079f50: 505f 434f 4e56 5f31 445f 5331 5f50 483a  P_CONV_1D_S1_PH:
+00079f60: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00079f70: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00079f80: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00079f90: 6172 645f 636f 6e76 5f31 645f 7331 5f70  ard_conv_1d_s1_p
+00079fa0: 6828 7061 7261 6d73 2c20 7465 6e73 6f72  h(params, tensor
+00079fb0: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
+00079fc0: 7372 6331 2c20 7465 6e73 6f72 293b 0a20  src1, tensor);. 
+00079fd0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00079fe0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00079ff0: 2047 474d 4c5f 4f50 5f43 4f4e 565f 3144   GGML_OP_CONV_1D
+0007a000: 5f53 325f 5048 3a0a 2020 2020 2020 2020  _S2_PH:.        
+0007a010: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007a020: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0007a030: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
+0007a040: 3164 5f73 325f 7068 2870 6172 616d 732c  1d_s2_ph(params,
+0007a050: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+0007a060: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
+0007a070: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+0007a080: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0007a090: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007a0a0: 434f 4e56 5f32 445f 534b 5f50 303a 0a20  CONV_2D_SK_P0:. 
+0007a0b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0007a0c0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007a0d0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0007a0e0: 645f 636f 6e76 5f32 645f 736b 5f70 3028  d_conv_2d_sk_p0(
+0007a0f0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+0007a100: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+0007a110: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
+0007a120: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0007a130: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0007a140: 474d 4c5f 4f50 5f46 4c41 5348 5f41 5454  GML_OP_FLASH_ATT
+0007a150: 4e3a 0a20 2020 2020 2020 2020 2020 207b  N:.            {
+0007a160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007a170: 2063 6f6e 7374 2069 6e74 3332 5f74 2074   const int32_t t
+0007a180: 203d 2067 676d 6c5f 6765 745f 6933 325f   = ggml_get_i32_
+0007a190: 3164 2874 656e 736f 722d 3e6f 7074 5b31  1d(tensor->opt[1
+0007a1a0: 5d2c 2030 293b 0a20 2020 2020 2020 2020  ], 0);.         
+0007a1b0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0007a1c0: 5254 2874 203d 3d20 3020 7c7c 2074 203d  RT(t == 0 || t =
+0007a1d0: 3d20 3129 3b0a 2020 2020 2020 2020 2020  = 1);.          
+0007a1e0: 2020 2020 2020 636f 6e73 7420 626f 6f6c        const bool
+0007a1f0: 206d 6173 6b65 6420 3d20 7420 213d 2030   masked = t != 0
+0007a200: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007a210: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0007a220: 6f72 7761 7264 5f66 6c61 7368 5f61 7474  orward_flash_att
+0007a230: 6e28 7061 7261 6d73 2c20 7465 6e73 6f72  n(params, tensor
+0007a240: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
+0007a250: 7372 6331 2c20 7465 6e73 6f72 2d3e 6f70  src1, tensor->op
+0007a260: 745b 305d 2c20 6d61 736b 6564 2c20 7465  t[0], masked, te
+0007a270: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+0007a280: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007a290: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007a2a0: 5f46 4c41 5348 5f46 463a 0a20 2020 2020  _FLASH_FF:.     
+0007a2b0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0007a2c0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+0007a2d0: 6d70 7574 655f 666f 7277 6172 645f 666c  mpute_forward_fl
+0007a2e0: 6173 685f 6666 2870 6172 616d 732c 2074  ash_ff(params, t
+0007a2f0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+0007a300: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
+0007a310: 722d 3e6f 7074 5b30 5d2c 2074 656e 736f  r->opt[0], tenso
+0007a320: 722d 3e6f 7074 5b31 5d2c 2074 656e 736f  r->opt[1], tenso
+0007a330: 722d 3e6f 7074 5b32 5d2c 2074 656e 736f  r->opt[2], tenso
+0007a340: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+0007a350: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007a360: 2063 6173 6520 4747 4d4c 5f4f 505f 464c   case GGML_OP_FL
+0007a370: 4153 485f 4154 544e 5f42 4143 4b3a 0a20  ASH_ATTN_BACK:. 
+0007a380: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0007a390: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0007a3a0: 3332 5f74 2074 203d 2067 676d 6c5f 6765  32_t t = ggml_ge
+0007a3b0: 745f 6933 325f 3164 2874 656e 736f 722d  t_i32_1d(tensor-
+0007a3c0: 3e6f 7074 5b32 5d2c 2030 293b 0a20 2020  >opt[2], 0);.   
+0007a3d0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+0007a3e0: 4c5f 4153 5345 5254 2874 203d 3d20 3020  L_ASSERT(t == 0 
+0007a3f0: 7c7c 2074 203d 3d20 3129 3b0a 2020 2020  || t == 1);.    
+0007a400: 2020 2020 2020 2020 2020 2020 626f 6f6c              bool
+0007a410: 206d 6173 6b65 6420 3d20 7420 213d 2030   masked = t != 0
+0007a420: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007a430: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0007a440: 6f72 7761 7264 5f66 6c61 7368 5f61 7474  orward_flash_att
+0007a450: 6e5f 6261 636b 2870 6172 616d 732c 2074  n_back(params, t
+0007a460: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+0007a470: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
+0007a480: 722d 3e6f 7074 5b30 5d2c 2074 656e 736f  r->opt[0], tenso
+0007a490: 722d 3e6f 7074 5b31 5d2c 206d 6173 6b65  r->opt[1], maske
+0007a4a0: 642c 2074 656e 736f 7229 3b0a 2020 2020  d, tensor);.    
+0007a4b0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0007a4c0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0007a4d0: 4d4c 5f4f 505f 5749 4e5f 5041 5254 3a0a  ML_OP_WIN_PART:.
+0007a4e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0007a4f0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0007a500: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0007a510: 7264 5f77 696e 5f70 6172 7428 7061 7261  rd_win_part(para
+0007a520: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+0007a530: 2c20 7465 6e73 6f72 2d3e 6f70 745b 305d  , tensor->opt[0]
+0007a540: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+0007a550: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007a560: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007a570: 4c5f 4f50 5f57 494e 5f55 4e50 4152 543a  L_OP_WIN_UNPART:
+0007a580: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0007a590: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007a5a0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0007a5b0: 6172 645f 7769 6e5f 756e 7061 7274 2870  ard_win_unpart(p
+0007a5c0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+0007a5d0: 7263 302c 2074 656e 736f 722d 3e6f 7074  rc0, tensor->opt
+0007a5e0: 5b30 5d2c 2074 656e 736f 7229 3b0a 2020  [0], tensor);.  
+0007a5f0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0007a600: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0007a610: 4747 4d4c 5f4f 505f 4d41 505f 554e 4152  GGML_OP_MAP_UNAR
+0007a620: 593a 0a20 2020 2020 2020 2020 2020 207b  Y:.            {
+0007a630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007a640: 2063 6f6e 7374 2067 676d 6c5f 756e 6172   const ggml_unar
+0007a650: 795f 6f70 5f66 3332 5f74 2066 756e 203d  y_op_f32_t fun =
+0007a660: 202a 2828 6767 6d6c 5f75 6e61 7279 5f6f   *((ggml_unary_o
+0007a670: 705f 6633 325f 7420 2a29 7465 6e73 6f72  p_f32_t *)tensor
+0007a680: 2d3e 6f70 745b 305d 2d3e 6461 7461 293b  ->opt[0]->data);
+0007a690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007a6a0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0007a6b0: 7277 6172 645f 6d61 705f 756e 6172 7928  rward_map_unary(
+0007a6c0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+0007a6d0: 7372 6330 2c20 7465 6e73 6f72 2c20 6675  src0, tensor, fu
+0007a6e0: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
+0007a6f0: 7d0a 2020 2020 2020 2020 2020 2020 6272  }.            br
+0007a700: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007a710: 6520 4747 4d4c 5f4f 505f 4d41 505f 4249  e GGML_OP_MAP_BI
+0007a720: 4e41 5259 3a0a 2020 2020 2020 2020 2020  NARY:.          
+0007a730: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0007a740: 2020 2020 636f 6e73 7420 6767 6d6c 5f62      const ggml_b
+0007a750: 696e 6172 795f 6f70 5f66 3332 5f74 2066  inary_op_f32_t f
+0007a760: 756e 203d 202a 2828 6767 6d6c 5f62 696e  un = *((ggml_bin
+0007a770: 6172 795f 6f70 5f66 3332 5f74 202a 2974  ary_op_f32_t *)t
+0007a780: 656e 736f 722d 3e6f 7074 5b30 5d2d 3e64  ensor->opt[0]->d
+0007a790: 6174 6129 3b0a 2020 2020 2020 2020 2020  ata);.          
+0007a7a0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0007a7b0: 7465 5f66 6f72 7761 7264 5f6d 6170 5f62  te_forward_map_b
+0007a7c0: 696e 6172 7928 7061 7261 6d73 2c20 7465  inary(params, te
+0007a7d0: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+0007a7e0: 6f72 2d3e 7372 6331 2c20 7465 6e73 6f72  or->src1, tensor
+0007a7f0: 2c20 6675 6e29 3b0a 2020 2020 2020 2020  , fun);.        
+0007a800: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0007a810: 2020 6272 6561 6b3b 0a20 2020 2020 2020    break;.       
+0007a820: 2063 6173 6520 4747 4d4c 5f4f 505f 4d41   case GGML_OP_MA
+0007a830: 505f 4355 5354 4f4d 313a 0a20 2020 2020  P_CUSTOM1:.     
+0007a840: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0007a850: 2020 2020 2020 2020 2063 6f6e 7374 2067           const g
+0007a860: 676d 6c5f 6375 7374 6f6d 315f 6f70 5f66  gml_custom1_op_f
+0007a870: 3332 5f74 2066 756e 203d 202a 2828 6767  32_t fun = *((gg
+0007a880: 6d6c 5f63 7573 746f 6d31 5f6f 705f 6633  ml_custom1_op_f3
+0007a890: 325f 7420 2a29 7465 6e73 6f72 2d3e 6f70  2_t *)tensor->op
+0007a8a0: 745b 305d 2d3e 6461 7461 293b 0a20 2020  t[0]->data);.   
+0007a8b0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007a8c0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0007a8d0: 645f 6d61 705f 6375 7374 6f6d 3128 7061  d_map_custom1(pa
+0007a8e0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+0007a8f0: 6330 2c20 7465 6e73 6f72 2c20 6675 6e29  c0, tensor, fun)
+0007a900: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+0007a910: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0007a920: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0007a930: 4747 4d4c 5f4f 505f 4d41 505f 4355 5354  GGML_OP_MAP_CUST
+0007a940: 4f4d 323a 0a20 2020 2020 2020 2020 2020  OM2:.           
+0007a950: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007a960: 2020 2063 6f6e 7374 2067 676d 6c5f 6375     const ggml_cu
+0007a970: 7374 6f6d 325f 6f70 5f66 3332 5f74 2066  stom2_op_f32_t f
+0007a980: 756e 203d 202a 2828 6767 6d6c 5f63 7573  un = *((ggml_cus
+0007a990: 746f 6d32 5f6f 705f 6633 325f 7420 2a29  tom2_op_f32_t *)
+0007a9a0: 7465 6e73 6f72 2d3e 6f70 745b 305d 2d3e  tensor->opt[0]->
+0007a9b0: 6461 7461 293b 0a20 2020 2020 2020 2020  data);.         
+0007a9c0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+0007a9d0: 7574 655f 666f 7277 6172 645f 6d61 705f  ute_forward_map_
+0007a9e0: 6375 7374 6f6d 3228 7061 7261 6d73 2c20  custom2(params, 
+0007a9f0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+0007aa00: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
+0007aa10: 6f72 2c20 6675 6e29 3b0a 2020 2020 2020  or, fun);.      
+0007aa20: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007aa30: 2020 2020 6272 6561 6b3b 0a20 2020 2020      break;.     
+0007aa40: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007aa50: 4d41 505f 4355 5354 4f4d 333a 0a20 2020  MAP_CUSTOM3:.   
+0007aa60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007aa70: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0007aa80: 2067 676d 6c5f 6375 7374 6f6d 335f 6f70   ggml_custom3_op
+0007aa90: 5f66 3332 5f74 2066 756e 203d 202a 2828  _f32_t fun = *((
+0007aaa0: 6767 6d6c 5f63 7573 746f 6d33 5f6f 705f  ggml_custom3_op_
+0007aab0: 6633 325f 7420 2a29 7465 6e73 6f72 2d3e  f32_t *)tensor->
+0007aac0: 6f70 745b 305d 2d3e 6461 7461 293b 0a20  opt[0]->data);. 
+0007aad0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007aae0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0007aaf0: 6172 645f 6d61 705f 6375 7374 6f6d 3328  ard_map_custom3(
+0007ab00: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+0007ab10: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+0007ab20: 6331 2c20 7465 6e73 6f72 2d3e 6f70 745b  c1, tensor->opt[
+0007ab30: 315d 2c20 7465 6e73 6f72 2c20 6675 6e29  1], tensor, fun)
+0007ab40: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+0007ab50: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0007ab60: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0007ab70: 4747 4d4c 5f4f 505f 4352 4f53 535f 454e  GGML_OP_CROSS_EN
+0007ab80: 5452 4f50 595f 4c4f 5353 3a0a 2020 2020  TROPY_LOSS:.    
+0007ab90: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007aba0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0007abb0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+0007abc0: 726f 7373 5f65 6e74 726f 7079 5f6c 6f73  ross_entropy_los
+0007abd0: 7328 7061 7261 6d73 2c20 7465 6e73 6f72  s(params, tensor
+0007abe0: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
+0007abf0: 7372 6331 2c20 7465 6e73 6f72 293b 0a20  src1, tensor);. 
+0007ac00: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0007ac10: 2020 2020 2020 2020 2062 7265 616b 3b0a           break;.
+0007ac20: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007ac30: 4c5f 4f50 5f43 524f 5353 5f45 4e54 524f  L_OP_CROSS_ENTRO
+0007ac40: 5059 5f4c 4f53 535f 4241 434b 3a0a 2020  PY_LOSS_BACK:.  
+0007ac50: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007ac60: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007ac70: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0007ac80: 5f63 726f 7373 5f65 6e74 726f 7079 5f6c  _cross_entropy_l
+0007ac90: 6f73 735f 6261 636b 2870 6172 616d 732c  oss_back(params,
+0007aca0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+0007acb0: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
+0007acc0: 736f 722d 3e6f 7074 5b30 5d2c 2074 656e  sor->opt[0], ten
+0007acd0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+0007ace0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0007acf0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0007ad00: 6173 6520 4747 4d4c 5f4f 505f 4e4f 4e45  ase GGML_OP_NONE
+0007ad10: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0007ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ad30: 2f2f 206e 6f70 0a20 2020 2020 2020 2020  // nop.         
+0007ad40: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007ad50: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007ad60: 5f43 4f55 4e54 3a0a 2020 2020 2020 2020  _COUNT:.        
+0007ad70: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007ad80: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0007ad90: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+0007ada0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0007adb0: 2020 207d 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f     }.}..////////
+0007adc0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0007add0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0007ade0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0007adf0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0007ae00: 2f2f 2f2f 2f2f 2f2f 0a0a 7374 6174 6963  ////////..static
+0007ae10: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+0007ae20: 7465 5f62 6163 6b77 6172 6428 7374 7275  te_backward(stru
+0007ae30: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0007ae40: 2a20 6374 782c 2073 7472 7563 7420 6767  * ctx, struct gg
+0007ae50: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+0007ae60: 6f72 2c20 626f 6f6c 2069 6e70 6c61 6365  or, bool inplace
+0007ae70: 2920 7b0a 2020 2020 7374 7275 6374 2067  ) {.    struct g
+0007ae80: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0007ae90: 3020 3d20 7465 6e73 6f72 2d3e 7372 6330  0 = tensor->src0
+0007aea0: 3b0a 2020 2020 7374 7275 6374 2067 676d  ;.    struct ggm
+0007aeb0: 6c5f 7465 6e73 6f72 202a 2073 7263 3120  l_tensor * src1 
+0007aec0: 3d20 7465 6e73 6f72 2d3e 7372 6331 3b0a  = tensor->src1;.
+0007aed0: 0a20 2020 2073 7769 7463 6820 2874 656e  .    switch (ten
+0007aee0: 736f 722d 3e6f 7029 207b 0a20 2020 2020  sor->op) {.     
+0007aef0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007af00: 4455 503a 0a20 2020 2020 2020 2020 2020  DUP:.           
+0007af10: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007af20: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+0007af30: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0007af40: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0007af50: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
+0007af60: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
+0007af70: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
+0007af80: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
+0007af90: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0007afa0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0007afb0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0007afc0: 2047 474d 4c5f 4f50 5f41 4444 3a0a 2020   GGML_OP_ADD:.  
+0007afd0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007afe0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0007aff0: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+0007b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b010: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
+0007b020: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+0007b030: 2c20 7372 6330 2d3e 6772 6164 2c20 7465  , src0->grad, te
+0007b040: 6e73 6f72 2d3e 6772 6164 2c20 696e 706c  nsor->grad, inpl
+0007b050: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0007b060: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007b070: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
+0007b080: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0007b090: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007b0a0: 6331 2d3e 6772 6164 203d 2067 676d 6c5f  c1->grad = ggml_
+0007b0b0: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
+0007b0c0: 6331 2d3e 6772 6164 2c20 7465 6e73 6f72  c1->grad, tensor
+0007b0d0: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
+0007b0e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007b0f0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0007b100: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007b110: 2063 6173 6520 4747 4d4c 5f4f 505f 4144   case GGML_OP_AD
+0007b120: 4431 3a0a 2020 2020 2020 2020 2020 2020  D1:.            
+0007b130: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007b140: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0007b150: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007b160: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007b170: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
+0007b180: 706c 2863 7478 2c20 7372 6330 2d3e 6772  pl(ctx, src0->gr
+0007b190: 6164 2c20 7465 6e73 6f72 2d3e 6772 6164  ad, tensor->grad
+0007b1a0: 2c20 696e 706c 6163 6529 3b0a 2020 2020  , inplace);.    
+0007b1b0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0007b1c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0007b1d0: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
+0007b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b1f0: 2020 2020 7372 6331 2d3e 6772 6164 203d      src1->grad =
+0007b200: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+0007b210: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0007b220: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+0007b230: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+0007b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b250: 6767 6d6c 5f6d 6561 6e28 6374 782c 2074  ggml_mean(ctx, t
+0007b260: 656e 736f 722d 3e67 7261 6429 2c20 2f2f  ensor->grad), //
+0007b270: 2054 4f44 4f3a 2073 686f 756c 6420 7072   TODO: should pr
+0007b280: 6f62 6162 6c79 2062 6520 7375 6d20 696e  obably be sum in
+0007b290: 7374 6561 6420 6f66 206d 6561 6e0a 2020  stead of mean.  
+0007b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b2b0: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
+0007b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b2d0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
+0007b2e0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0007b2f0: 6173 6520 4747 4d4c 5f4f 505f 4143 433a  ase GGML_OP_ACC:
+0007b300: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0007b310: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007b320: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
+0007b330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007b340: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+0007b350: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
+0007b360: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
+0007b370: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
+0007b380: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+0007b390: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007b3a0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+0007b3b0: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
+0007b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b3d0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+0007b3e0: 6c5f 6e65 6c65 6d65 6e74 7328 7465 6e73  l_nelements(tens
+0007b3f0: 6f72 2d3e 6f70 745b 305d 2920 3d3d 2035  or->opt[0]) == 5
+0007b400: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0007b410: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0007b420: 5254 2874 656e 736f 722d 3e6f 7074 5b30  RT(tensor->opt[0
+0007b430: 5d2d 3e74 7970 6520 3d3d 2047 474d 4c5f  ]->type == GGML_
+0007b440: 5459 5045 5f49 3332 293b 0a20 2020 2020  TYPE_I32);.     
+0007b450: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007b460: 6f6e 7374 2073 697a 655f 7420 6e62 3120  onst size_t nb1 
+0007b470: 2020 2020 3d20 2828 2069 6e74 3332 5f74      = (( int32_t
+0007b480: 202a 2029 2074 656e 736f 722d 3e6f 7074   * ) tensor->opt
+0007b490: 5b30 5d2d 3e64 6174 6129 5b30 5d3b 0a20  [0]->data)[0];. 
+0007b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b4b0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0007b4c0: 6e62 3220 2020 2020 3d20 2828 2069 6e74  nb2     = (( int
+0007b4d0: 3332 5f74 202a 2029 2074 656e 736f 722d  32_t * ) tensor-
+0007b4e0: 3e6f 7074 5b30 5d2d 3e64 6174 6129 5b31  >opt[0]->data)[1
+0007b4f0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+0007b500: 2020 2020 2020 2063 6f6e 7374 2073 697a         const siz
+0007b510: 655f 7420 6e62 3320 2020 2020 3d20 2828  e_t nb3     = ((
+0007b520: 2069 6e74 3332 5f74 202a 2029 2074 656e   int32_t * ) ten
+0007b530: 736f 722d 3e6f 7074 5b30 5d2d 3e64 6174  sor->opt[0]->dat
+0007b540: 6129 5b32 5d3b 0a20 2020 2020 2020 2020  a)[2];.         
+0007b550: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0007b560: 2073 697a 655f 7420 6f66 6673 6574 2020   size_t offset  
+0007b570: 3d20 2828 2069 6e74 3332 5f74 202a 2029  = (( int32_t * )
+0007b580: 2074 656e 736f 722d 3e6f 7074 5b30 5d2d   tensor->opt[0]-
+0007b590: 3e64 6174 6129 5b33 5d3b 0a0a 2020 2020  >data)[3];..    
+0007b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b5b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007b5c0: 6f72 202a 2074 656e 736f 725f 6772 6164  or * tensor_grad
+0007b5d0: 5f76 6965 7720 3d20 6767 6d6c 5f76 6965  _view = ggml_vie
+0007b5e0: 775f 3464 2863 7478 2c0a 2020 2020 2020  w_4d(ctx,.      
+0007b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b600: 2020 7465 6e73 6f72 2d3e 6772 6164 2c0a    tensor->grad,.
 0007b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b620: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007b630: 636f 6e74 2863 7478 2c20 7465 6e73 6f72  cont(ctx, tensor
-0007b640: 5f67 7261 645f 7669 6577 292c 0a20 2020  _grad_view),.   
-0007b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b660: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0007b670: 312d 3e67 7261 6429 2c0a 2020 2020 2020  1->grad),.      
-0007b680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b690: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-0007b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b6b0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-0007b6c0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0007b6d0: 6173 6520 4747 4d4c 5f4f 505f 5355 423a  ase GGML_OP_SUB:
-0007b6e0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0007b6f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007b700: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
-0007b710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007b720: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-0007b730: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
-0007b740: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-0007b750: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
-0007b760: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-0007b770: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007b780: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007b790: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
-0007b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b7b0: 2073 7263 312d 3e67 7261 6420 3d20 6767   src1->grad = gg
-0007b7c0: 6d6c 5f73 7562 5f69 6d70 6c28 6374 782c  ml_sub_impl(ctx,
-0007b7d0: 2073 7263 312d 3e67 7261 642c 2074 656e   src1->grad, ten
-0007b7e0: 736f 722d 3e67 7261 642c 2069 6e70 6c61  sor->grad, inpla
-0007b7f0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0007b800: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0007b810: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0007b820: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007b830: 5f4d 554c 3a0a 2020 2020 2020 2020 2020  _MUL:.          
-0007b840: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0007b850: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0007b860: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007b870: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0007b880: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
-0007b890: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0007b8a0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-0007b8b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b8d0: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
-0007b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b8f0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0007b900: 6d6c 5f6d 756c 2863 7478 2c20 7372 6331  ml_mul(ctx, src1
-0007b910: 2c20 7465 6e73 6f72 2d3e 6772 6164 292c  , tensor->grad),
+0007b620: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+0007b630: 6164 2d3e 6e65 5b30 5d2c 0a20 2020 2020  ad->ne[0],.     
+0007b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b650: 2020 2073 7263 312d 3e67 7261 642d 3e6e     src1->grad->n
+0007b660: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
+0007b670: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007b680: 6331 2d3e 6772 6164 2d3e 6e65 5b32 5d2c  c1->grad->ne[2],
+0007b690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007b6a0: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
+0007b6b0: 7261 642d 3e6e 655b 335d 2c0a 2020 2020  rad->ne[3],.    
+0007b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b6d0: 2020 2020 6e62 312c 206e 6232 2c20 6e62      nb1, nb2, nb
+0007b6e0: 332c 206f 6666 7365 7429 3b0a 0a20 2020  3, offset);..   
+0007b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b700: 2073 7263 312d 3e67 7261 6420 3d0a 2020   src1->grad =.  
+0007b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b720: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
+0007b730: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
+0007b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b750: 2020 2020 2073 7263 312d 3e67 7261 642c       src1->grad,
+0007b760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007b770: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007b780: 6c5f 7265 7368 6170 6528 6374 782c 0a20  l_reshape(ctx,. 
+0007b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b7a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007b7b0: 676d 6c5f 636f 6e74 2863 7478 2c20 7465  gml_cont(ctx, te
+0007b7c0: 6e73 6f72 5f67 7261 645f 7669 6577 292c  nsor_grad_view),
+0007b7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b7f0: 2073 7263 312d 3e67 7261 6429 2c0a 2020   src1->grad),.  
+0007b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b810: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
+0007b820: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0007b830: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0007b840: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0007b850: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007b860: 5355 423a 0a20 2020 2020 2020 2020 2020  SUB:.           
+0007b870: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007b880: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+0007b890: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0007b8a0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0007b8b0: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
+0007b8c0: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
+0007b8d0: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
+0007b8e0: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
+0007b8f0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0007b900: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007b910: 6620 2873 7263 312d 3e67 7261 6429 207b  f (src1->grad) {
 0007b920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b940: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-0007b950: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0007b960: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0007b970: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
-0007b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b990: 2020 2073 7263 312d 3e67 7261 6420 3d0a     src1->grad =.
-0007b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b9b0: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
-0007b9c0: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
-0007b9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b9e0: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-0007b9f0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-0007ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ba10: 2020 2020 2020 2067 676d 6c5f 6d75 6c28         ggml_mul(
-0007ba20: 6374 782c 2073 7263 302c 2074 656e 736f  ctx, src0, tenso
-0007ba30: 722d 3e67 7261 6429 2c0a 2020 2020 2020  r->grad),.      
+0007b930: 2020 2020 2073 7263 312d 3e67 7261 6420       src1->grad 
+0007b940: 3d20 6767 6d6c 5f73 7562 5f69 6d70 6c28  = ggml_sub_impl(
+0007b950: 6374 782c 2073 7263 312d 3e67 7261 642c  ctx, src1->grad,
+0007b960: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
+0007b970: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+0007b980: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007b990: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007b9a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007b9b0: 4c5f 4f50 5f4d 554c 3a0a 2020 2020 2020  L_OP_MUL:.      
+0007b9c0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0007b9d0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+0007b9e0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0007b9f0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007ba00: 6330 2d3e 6772 6164 203d 0a20 2020 2020  c0->grad =.     
+0007ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ba20: 2020 2067 676d 6c5f 6164 645f 696d 706c     ggml_add_impl
+0007ba30: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
 0007ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ba50: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-0007ba60: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-0007ba70: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0007ba80: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0007ba90: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007baa0: 4449 563a 0a20 2020 2020 2020 2020 2020  DIV:.           
-0007bab0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007bac0: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-0007bad0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-0007bae0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-0007baf0: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
-0007bb00: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0007bb10: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-0007bb20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bb40: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
+0007ba50: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+0007ba60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ba80: 2020 6767 6d6c 5f6d 756c 2863 7478 2c20    ggml_mul(ctx, 
+0007ba90: 7372 6331 2c20 7465 6e73 6f72 2d3e 6772  src1, tensor->gr
+0007baa0: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
+0007bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bac0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
+0007bad0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0007bae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007baf0: 2069 6620 2873 7263 312d 3e67 7261 6429   if (src1->grad)
+0007bb00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007bb10: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+0007bb20: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+0007bb30: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007bb40: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
 0007bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bb60: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0007bb70: 6c5f 6469 7628 6374 782c 2074 656e 736f  l_div(ctx, tenso
-0007bb80: 722d 3e67 7261 642c 2073 7263 3129 2c0a  r->grad, src1),.
-0007bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bbb0: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-0007bbc0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0007bbd0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0007bbe0: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
-0007bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bc00: 2020 7372 6331 2d3e 6772 6164 203d 0a20    src1->grad =. 
-0007bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bc20: 2020 2020 2020 2067 676d 6c5f 7375 625f         ggml_sub_
-0007bc30: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-0007bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bc50: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-0007bc60: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-0007bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bc80: 2020 2020 2020 6767 6d6c 5f6d 756c 2863        ggml_mul(c
-0007bc90: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-0007bca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bcb0: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
-0007bcc0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-0007bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bce0: 2020 2020 2020 2020 2020 6767 6d6c 5f64            ggml_d
-0007bcf0: 6976 2863 7478 2c20 7465 6e73 6f72 2c20  iv(ctx, tensor, 
-0007bd00: 7372 6331 2929 2c0a 2020 2020 2020 2020  src1)),.        
-0007bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bd20: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-0007bd30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007bd40: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007bd50: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007bd60: 2063 6173 6520 4747 4d4c 5f4f 505f 5351   case GGML_OP_SQ
-0007bd70: 523a 0a20 2020 2020 2020 2020 2020 207b  R:.            {
-0007bd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007bd90: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-0007bda0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007bdb0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-0007bdc0: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
-0007bdd0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007bde0: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
+0007bb60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007bb70: 7263 312d 3e67 7261 642c 0a20 2020 2020  rc1->grad,.     
+0007bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bb90: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0007bba0: 6d75 6c28 6374 782c 2073 7263 302c 2074  mul(ctx, src0, t
+0007bbb0: 656e 736f 722d 3e67 7261 6429 2c0a 2020  ensor->grad),.  
+0007bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bbd0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0007bbe0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+0007bbf0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0007bc00: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0007bc10: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007bc20: 5f4f 505f 4449 563a 0a20 2020 2020 2020  _OP_DIV:.       
+0007bc30: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007bc40: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
+0007bc50: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+0007bc60: 2020 2020 2020 2020 2020 2020 2073 7263               src
+0007bc70: 302d 3e67 7261 6420 3d0a 2020 2020 2020  0->grad =.      
+0007bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bc90: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
+0007bca0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0007bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bcc0: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
+0007bcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bcf0: 2067 676d 6c5f 6469 7628 6374 782c 2074   ggml_div(ctx, t
+0007bd00: 656e 736f 722d 3e67 7261 642c 2073 7263  ensor->grad, src
+0007bd10: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+0007bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bd30: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+0007bd40: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bd60: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
+0007bd70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007bd80: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
+0007bd90: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
+0007bda0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0007bdb0: 7375 625f 696d 706c 2863 7478 2c0a 2020  sub_impl(ctx,.  
+0007bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bdd0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007bde0: 6331 2d3e 6772 6164 2c0a 2020 2020 2020  c1->grad,.      
 0007bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007be00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007be10: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+0007be00: 2020 2020 2020 2020 2020 6767 6d6c 5f6d            ggml_m
+0007be10: 756c 2863 7478 2c0a 2020 2020 2020 2020  ul(ctx,.        
 0007be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007be30: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007be40: 7363 616c 6528 6374 782c 0a20 2020 2020  scale(ctx,.     
+0007be30: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+0007be40: 6f72 2d3e 6772 6164 2c0a 2020 2020 2020  or->grad,.      
 0007be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007be60: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0007be70: 676d 6c5f 6d75 6c28 6374 782c 2073 7263  gml_mul(ctx, src
-0007be80: 302c 2074 656e 736f 722d 3e67 7261 6429  0, tensor->grad)
-0007be90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007bea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007beb0: 2020 2020 2020 6767 6d6c 5f6e 6577 5f66        ggml_new_f
-0007bec0: 3332 2863 7478 2c20 322e 3066 2929 2c0a  32(ctx, 2.0f)),.
-0007bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bef0: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-0007bf00: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0007bf10: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0007bf20: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0007bf30: 4d4c 5f4f 505f 5351 5254 3a0a 2020 2020  ML_OP_SQRT:.    
-0007bf40: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007bf50: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-0007bf60: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-0007bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bf80: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
-0007bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bfa0: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
-0007bfb0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
-0007bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bfd0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-0007bfe0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-0007bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c000: 2020 2020 6767 6d6c 5f73 6361 6c65 2863      ggml_scale(c
-0007c010: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0007be60: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0007be70: 6d6c 5f64 6976 2863 7478 2c20 7465 6e73  ml_div(ctx, tens
+0007be80: 6f72 2c20 7372 6331 2929 2c0a 2020 2020  or, src1)),.    
+0007be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bea0: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+0007beb0: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0007bec0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007bed0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007bee0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007bef0: 505f 5351 523a 0a20 2020 2020 2020 2020  P_SQR:.         
+0007bf00: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0007bf10: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+0007bf20: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0007bf30: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0007bf40: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
+0007bf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bf60: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+0007bf70: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0007bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bf90: 2020 2073 7263 302d 3e67 7261 642c 0a20     src0->grad,. 
+0007bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bfb0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007bfc0: 676d 6c5f 7363 616c 6528 6374 782c 0a20  gml_scale(ctx,. 
+0007bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bff0: 2020 2067 676d 6c5f 6d75 6c28 6374 782c     ggml_mul(ctx,
+0007c000: 2073 7263 302c 2074 656e 736f 722d 3e67   src0, tensor->g
+0007c010: 7261 6429 2c0a 2020 2020 2020 2020 2020  rad),.          
 0007c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c030: 2020 2020 2020 2020 6767 6d6c 5f64 6976          ggml_div
-0007c040: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-0007c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c060: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0007c070: 6e73 6f72 2d3e 6772 6164 2c0a 2020 2020  nsor->grad,.    
-0007c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c0a0: 2020 2020 7465 6e73 6f72 292c 0a20 2020      tensor),.   
-0007c0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c0d0: 2067 676d 6c5f 6e65 775f 6633 3228 6374   ggml_new_f32(ct
-0007c0e0: 782c 2030 2e35 6629 292c 0a20 2020 2020  x, 0.5f)),.     
+0007c030: 2020 2020 2020 2020 2020 6767 6d6c 5f6e            ggml_n
+0007c040: 6577 5f66 3332 2863 7478 2c20 322e 3066  ew_f32(ctx, 2.0f
+0007c050: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+0007c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c070: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+0007c080: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007c090: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0007c0a0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007c0b0: 6520 4747 4d4c 5f4f 505f 5351 5254 3a0a  e GGML_OP_SQRT:.
+0007c0c0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0007c0d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0007c0e0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
 0007c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c100: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-0007c110: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0007c120: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0007c130: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0007c140: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007c150: 5f4c 4f47 3a0a 2020 2020 2020 2020 2020  _LOG:.          
-0007c160: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0007c170: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0007c180: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007c190: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0007c1a0: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
-0007c1b0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0007c1c0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-0007c1d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007c100: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+0007c110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007c120: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
+0007c130: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
+0007c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c150: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+0007c160: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+0007c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c180: 2020 2020 2020 2020 6767 6d6c 5f73 6361          ggml_sca
+0007c190: 6c65 2863 7478 2c0a 2020 2020 2020 2020  le(ctx,.        
+0007c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c1b0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007c1c0: 5f64 6976 2863 7478 2c0a 2020 2020 2020  _div(ctx,.      
+0007c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c1f0: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
+0007c1f0: 2020 7465 6e73 6f72 2d3e 6772 6164 2c0a    tensor->grad,.
 0007c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c210: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0007c220: 6d6c 5f64 6976 2863 7478 2c0a 2020 2020  ml_div(ctx,.    
-0007c230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c220: 2020 2020 2020 2020 7465 6e73 6f72 292c          tensor),
+0007c230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0007c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c250: 7465 6e73 6f72 2d3e 6772 6164 2c0a 2020  tensor->grad,.  
-0007c260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c250: 2020 2020 2067 676d 6c5f 6e65 775f 6633       ggml_new_f3
+0007c260: 3228 6374 782c 2030 2e35 6629 292c 0a20  2(ctx, 0.5f)),. 
 0007c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c280: 2020 7372 6330 292c 0a20 2020 2020 2020    src0),.       
-0007c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c2a0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-0007c2b0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007c2c0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0007c2d0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0007c2e0: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
-0007c2f0: 554d 3a0a 2020 2020 2020 2020 2020 2020  UM:.            
-0007c300: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007c310: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-0007c320: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007c330: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-0007c340: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
-0007c350: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0007c360: 6c5f 6164 6431 5f69 6d70 6c28 6374 782c  l_add1_impl(ctx,
-0007c370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c390: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
-0007c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c3b0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-0007c3c0: 736f 722d 3e67 7261 642c 0a20 2020 2020  sor->grad,.     
-0007c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c3e0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-0007c3f0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0007c400: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0007c410: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0007c420: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007c430: 5f53 554d 5f52 4f57 533a 0a20 2020 2020  _SUM_ROWS:.     
-0007c440: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0007c450: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-0007c460: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-0007c470: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007c480: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
-0007c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c4a0: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
-0007c4b0: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
-0007c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c4d0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-0007c4e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0007c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c500: 2020 2067 676d 6c5f 7265 7065 6174 2863     ggml_repeat(c
-0007c510: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-0007c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c530: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
-0007c540: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+0007c280: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007c290: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+0007c2a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007c2b0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007c2c0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007c2d0: 4c5f 4f50 5f4c 4f47 3a0a 2020 2020 2020  L_OP_LOG:.      
+0007c2e0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0007c2f0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+0007c300: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0007c310: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007c320: 6330 2d3e 6772 6164 203d 0a20 2020 2020  c0->grad =.     
+0007c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c340: 2020 2067 676d 6c5f 6164 645f 696d 706c     ggml_add_impl
+0007c350: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+0007c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c370: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+0007c380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c3a0: 2020 6767 6d6c 5f64 6976 2863 7478 2c0a    ggml_div(ctx,.
+0007c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c3d0: 2020 2020 7465 6e73 6f72 2d3e 6772 6164      tensor->grad
+0007c3e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c400: 2020 2020 2020 7372 6330 292c 0a20 2020        src0),.   
+0007c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c420: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+0007c430: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+0007c440: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0007c450: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0007c460: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0007c470: 4f50 5f53 554d 3a0a 2020 2020 2020 2020  OP_SUM:.        
+0007c480: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007c490: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+0007c4a0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+0007c4b0: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+0007c4c0: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+0007c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c4e0: 2067 676d 6c5f 6164 6431 5f69 6d70 6c28   ggml_add1_impl(
+0007c4f0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0007c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c510: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
+0007c520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c540: 2074 656e 736f 722d 3e67 7261 642c 0a20   tensor->grad,. 
 0007c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c560: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0007c570: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
-0007c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c590: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
-0007c5a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c5b0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0007c5c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0007c5d0: 6361 7365 2047 474d 4c5f 4f50 5f4d 4541  case GGML_OP_MEA
-0007c5e0: 4e3a 0a20 2020 2020 2020 2020 2020 207b  N:.            {
-0007c5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c600: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-0007c610: 7365 293b 202f 2f20 544f 444f 3a20 696d  se); // TODO: im
-0007c620: 706c 656d 656e 740a 2020 2020 2020 2020  plement.        
-0007c630: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007c640: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007c650: 505f 5245 5045 4154 3a0a 2020 2020 2020  P_REPEAT:.      
-0007c660: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0007c670: 2020 2020 2020 2020 2f2f 206e 6563 6573          // neces
-0007c680: 7361 7279 2066 6f72 206c 6c61 6d61 0a20  sary for llama. 
-0007c690: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007c6a0: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
-0007c6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c6c0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-0007c6d0: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
-0007c6e0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-0007c6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c700: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
-0007c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c720: 2020 2020 2020 2020 2067 676d 6c5f 7265           ggml_re
-0007c730: 7065 6174 5f62 6163 6b28 6374 782c 2074  peat_back(ctx, t
-0007c740: 656e 736f 722d 3e67 7261 642c 2073 7263  ensor->grad, src
-0007c750: 302d 3e67 7261 6429 2c0a 2020 2020 2020  0->grad),.      
-0007c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c770: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-0007c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c790: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-0007c7a0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0007c7b0: 6173 6520 4747 4d4c 5f4f 505f 5245 5045  ase GGML_OP_REPE
-0007c7c0: 4154 5f42 4143 4b3a 0a20 2020 2020 2020  AT_BACK:.       
-0007c7d0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0007c7e0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-0007c7f0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0007c800: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0007c810: 544f 444f 3a20 7465 7374 2074 6869 730a  TODO: test this.
-0007c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c830: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-0007c840: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0007c850: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-0007c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c870: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
-0007c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c890: 2020 2020 2020 2020 6767 6d6c 5f72 6570          ggml_rep
-0007c8a0: 6561 7428 6374 782c 2074 656e 736f 722d  eat(ctx, tensor-
-0007c8b0: 3e67 7261 642c 2073 7263 302d 3e67 7261  >grad, src0->gra
-0007c8c0: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-0007c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c8e0: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-0007c8f0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0007c900: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0007c910: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0007c920: 4d4c 5f4f 505f 4142 533a 0a20 2020 2020  ML_OP_ABS:.     
-0007c930: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0007c940: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-0007c950: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-0007c960: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007c970: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+0007c560: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007c570: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+0007c580: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007c590: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007c5a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007c5b0: 4c5f 4f50 5f53 554d 5f52 4f57 533a 0a20  L_OP_SUM_ROWS:. 
+0007c5c0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0007c5d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007c5e0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+0007c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c600: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
+0007c610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c620: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+0007c630: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
+0007c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c650: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0007c660: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+0007c670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c680: 2020 2020 2020 2067 676d 6c5f 7265 7065         ggml_repe
+0007c690: 6174 2863 7478 2c0a 2020 2020 2020 2020  at(ctx,.        
+0007c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c6b0: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+0007c6c0: 6f72 2d3e 6772 6164 2c0a 2020 2020 2020  or->grad,.      
+0007c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c6e0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007c6f0: 6330 2d3e 6772 6164 292c 0a20 2020 2020  c0->grad),.     
+0007c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c710: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+0007c720: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+0007c730: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0007c740: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007c750: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007c760: 5f4d 4541 4e3a 0a20 2020 2020 2020 2020  _MEAN:.         
+0007c770: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0007c780: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0007c790: 2866 616c 7365 293b 202f 2f20 544f 444f  (false); // TODO
+0007c7a0: 3a20 696d 706c 656d 656e 740a 2020 2020  : implement.    
+0007c7b0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0007c7c0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0007c7d0: 4d4c 5f4f 505f 5245 5045 4154 3a0a 2020  ML_OP_REPEAT:.  
+0007c7e0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007c7f0: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
+0007c800: 6563 6573 7361 7279 2066 6f72 206c 6c61  ecessary for lla
+0007c810: 6d61 0a20 2020 2020 2020 2020 2020 2020  ma.             
+0007c820: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+0007c830: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0007c840: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0007c850: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
+0007c860: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
+0007c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c880: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
+0007c890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007c8a0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007c8b0: 6c5f 7265 7065 6174 5f62 6163 6b28 6374  l_repeat_back(ct
+0007c8c0: 782c 2074 656e 736f 722d 3e67 7261 642c  x, tensor->grad,
+0007c8d0: 2073 7263 302d 3e67 7261 6429 2c0a 2020   src0->grad),.  
+0007c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c8f0: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
+0007c900: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0007c910: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0007c920: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0007c930: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007c940: 5245 5045 4154 5f42 4143 4b3a 0a20 2020  REPEAT_BACK:.   
+0007c950: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007c960: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+0007c970: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
 0007c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c990: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
-0007c9a0: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
-0007c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c9c0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-0007c9d0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0007c990: 202f 2f20 544f 444f 3a20 7465 7374 2074   // TODO: test t
+0007c9a0: 6869 730a 2020 2020 2020 2020 2020 2020  his.            
+0007c9b0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007c9c0: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
+0007c9d0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
 0007c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c9f0: 2020 2067 676d 6c5f 6d75 6c28 6374 782c     ggml_mul(ctx,
-0007ca00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ca20: 2020 2020 2067 676d 6c5f 7367 6e28 6374       ggml_sgn(ct
-0007ca30: 782c 2073 7263 3029 2c0a 2020 2020 2020  x, src0),.      
-0007ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ca50: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0007ca60: 6e73 6f72 2d3e 6772 6164 292c 0a20 2020  nsor->grad),.   
-0007ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ca80: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-0007ca90: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-0007caa0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0007cab0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0007cac0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007cad0: 4f50 5f53 474e 3a0a 2020 2020 2020 2020  OP_SGN:.        
-0007cae0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007caf0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0007cb00: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0007cb10: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
-0007cb20: 6f6f 700a 2020 2020 2020 2020 2020 2020  oop.            
-0007cb30: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0007cb40: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0007cb50: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007cb60: 4e45 473a 0a20 2020 2020 2020 2020 2020  NEG:.           
-0007cb70: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007cb80: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-0007cb90: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-0007cba0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-0007cbb0: 7261 6420 3d20 6767 6d6c 5f73 7562 5f69  rad = ggml_sub_i
-0007cbc0: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-0007cbd0: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
-0007cbe0: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
-0007cbf0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0007cc00: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0007cc10: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0007cc20: 2047 474d 4c5f 4f50 5f53 5445 503a 0a20   GGML_OP_STEP:. 
-0007cc30: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0007cc40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0007cc50: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-0007cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cc70: 2020 202f 2f20 6e6f 6f70 0a20 2020 2020     // noop.     
-0007cc80: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0007cc90: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0007cca0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0007ccb0: 474d 4c5f 4f50 5f52 454c 553a 0a20 2020  GML_OP_RELU:.   
-0007ccc0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0007ccd0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007cce0: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0007ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cd00: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
-0007cd10: 6d6c 5f73 7562 5f69 6d70 6c28 6374 782c  ml_sub_impl(ctx,
-0007cd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007cd30: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0007cd40: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
-0007cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cd60: 2020 2020 2067 676d 6c5f 6d75 6c28 6374       ggml_mul(ct
-0007cd70: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-0007cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cd90: 2020 2067 676d 6c5f 7374 6570 2863 7478     ggml_step(ctx
-0007cda0: 2c20 7372 6330 292c 0a20 2020 2020 2020  , src0),.       
-0007cdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cdc0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-0007cdd0: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
-0007cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cdf0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-0007ce00: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0007ce10: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0007ce20: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0007ce30: 6520 4747 4d4c 5f4f 505f 4745 4c55 3a0a  e GGML_OP_GELU:.
-0007ce40: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0007ce50: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-0007ce60: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-0007ce70: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
-0007ce80: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
-0007ce90: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0007cea0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007ceb0: 4c5f 4f50 5f47 454c 555f 5155 4943 4b3a  L_OP_GELU_QUICK:
-0007cec0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0007ced0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-0007cee0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0007cef0: 293b 202f 2f20 544f 444f 3a20 6e6f 7420  ); // TODO: not 
-0007cf00: 696d 706c 656d 656e 7465 640a 2020 2020  implemented.    
-0007cf10: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0007cf20: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0007cf30: 4d4c 5f4f 505f 414c 4942 493a 0a20 2020  ML_OP_ALIBI:.   
-0007cf40: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0007cf50: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0007cf60: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
-0007cf70: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
-0007cf80: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
-0007cf90: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007cfa0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007cfb0: 505f 434c 414d 503a 0a20 2020 2020 2020  P_CLAMP:.       
-0007cfc0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0007cfd0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0007cfe0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-0007cff0: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
-0007d000: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-0007d010: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007d020: 2063 6173 6520 4747 4d4c 5f4f 505f 5349   case GGML_OP_SI
-0007d030: 4c55 3a0a 2020 2020 2020 2020 2020 2020  LU:.            
-0007d040: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007d050: 2020 2f2f 206e 6563 6573 7361 7279 2066    // necessary f
-0007d060: 6f72 206c 6c61 6d61 0a20 2020 2020 2020  or llama.       
-0007d070: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-0007d080: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-0007d090: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007d0a0: 7263 302d 3e67 7261 6420 3d20 6767 6d6c  rc0->grad = ggml
-0007d0b0: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
-0007d0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d0d0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-0007d0e0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-0007d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d100: 2020 2067 676d 6c5f 7369 6c75 5f62 6163     ggml_silu_bac
-0007d110: 6b28 6374 782c 2073 7263 302c 2074 656e  k(ctx, src0, ten
-0007d120: 736f 722d 3e67 7261 6429 2c0a 2020 2020  sor->grad),.    
-0007d130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d140: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-0007d150: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007d160: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007d170: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007d180: 2063 6173 6520 4747 4d4c 5f4f 505f 5349   case GGML_OP_SI
-0007d190: 4c55 5f42 4143 4b3a 0a20 2020 2020 2020  LU_BACK:.       
-0007d1a0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0007d1b0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0007d1c0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-0007d1d0: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
-0007d1e0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-0007d1f0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007d200: 2063 6173 6520 4747 4d4c 5f4f 505f 4e4f   case GGML_OP_NO
-0007d210: 524d 3a0a 2020 2020 2020 2020 2020 2020  RM:.            
-0007d220: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007d230: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-0007d240: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
-0007d250: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
-0007d260: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0007d270: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0007d280: 2047 474d 4c5f 4f50 5f52 4d53 5f4e 4f52   GGML_OP_RMS_NOR
-0007d290: 4d3a 0a20 2020 2020 2020 2020 2020 207b  M:.            {
-0007d2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007d2b0: 202f 2f20 6e65 6365 7373 6172 7920 666f   // necessary fo
-0007d2c0: 7220 6c6c 616d 610a 2020 2020 2020 2020  r llama.        
-0007d2d0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
-0007d2e0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-0007d2f0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0007d300: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
-0007d310: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
-0007d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d330: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0007d340: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-0007d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d360: 2020 6767 6d6c 5f72 6d73 5f6e 6f72 6d5f    ggml_rms_norm_
-0007d370: 6261 636b 2863 7478 2c20 7372 6330 2c20  back(ctx, src0, 
-0007d380: 7465 6e73 6f72 2d3e 6772 6164 292c 0a20  tensor->grad),. 
-0007d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d3a0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-0007d3b0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0007d3c0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0007d3d0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0007d3e0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007d3f0: 5f52 4d53 5f4e 4f52 4d5f 4241 434b 3a0a  _RMS_NORM_BACK:.
-0007d400: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0007d410: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-0007d420: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-0007d430: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
-0007d440: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
-0007d450: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0007d460: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007d470: 4c5f 4f50 5f4d 554c 5f4d 4154 3a0a 2020  L_OP_MUL_MAT:.  
-0007d480: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0007d490: 2020 2020 2020 2020 2020 2020 2f2f 2068              // h
-0007d4a0: 7474 7073 3a2f 2f63 7332 3331 6e2e 6769  ttps://cs231n.gi
-0007d4b0: 7468 7562 2e69 6f2f 6f70 7469 6d69 7a61  thub.io/optimiza
-0007d4c0: 7469 6f6e 2d32 2f23 7374 6167 6564 0a20  tion-2/#staged. 
-0007d4d0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0007d4e0: 2f20 2320 666f 7277 6172 6420 7061 7373  / # forward pass
-0007d4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007d500: 202f 2f20 7330 203d 206e 702e 7261 6e64   // s0 = np.rand
-0007d510: 6f6d 2e72 616e 646e 2835 2c20 3130 290a  om.randn(5, 10).
-0007d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d530: 2f2f 2073 3120 3d20 6e70 2e72 616e 646f  // s1 = np.rando
-0007d540: 6d2e 7261 6e64 6e28 3130 2c20 3329 0a20  m.randn(10, 3). 
-0007d550: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0007d560: 2f20 7420 3d20 7330 2e64 6f74 2873 3129  / t = s0.dot(s1)
-0007d570: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0007d580: 2020 2f2f 2023 206e 6f77 2073 7570 706f    // # now suppo
-0007d590: 7365 2077 6520 6861 6420 7468 6520 6772  se we had the gr
-0007d5a0: 6164 6965 6e74 206f 6e20 7420 6672 6f6d  adient on t from
-0007d5b0: 2061 626f 7665 2069 6e20 7468 6520 6369   above in the ci
-0007d5c0: 7263 7569 740a 2020 2020 2020 2020 2020  rcuit.          
-0007d5d0: 2020 2020 2020 2f2f 2064 7420 3d20 6e70        // dt = np
-0007d5e0: 2e72 616e 646f 6d2e 7261 6e64 6e28 2a74  .random.randn(*t
-0007d5f0: 2e73 6861 7065 2920 2320 7361 6d65 2073  .shape) # same s
-0007d600: 6861 7065 2061 7320 740a 2020 2020 2020  hape as t.      
-0007d610: 2020 2020 2020 2020 2020 2f2f 2064 7330            // ds0
-0007d620: 203d 2064 742e 646f 7428 7331 2e54 2920   = dt.dot(s1.T) 
-0007d630: 232e 5420 6769 7665 7320 7468 6520 7472  #.T gives the tr
-0007d640: 616e 7370 6f73 6520 6f66 2074 6865 206d  anspose of the m
-0007d650: 6174 7269 780a 2020 2020 2020 2020 2020  atrix.          
-0007d660: 2020 2020 2020 2f2f 2064 7331 203d 2074        // ds1 = t
-0007d670: 2e54 2e64 6f74 2864 7429 0a0a 2020 2020  .T.dot(dt)..    
-0007d680: 2020 2020 2020 2020 2020 2020 2f2f 2074              // t
-0007d690: 656e 736f 722e 7368 6170 6520 5b6d 2c70  ensor.shape [m,p
-0007d6a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0007d6b0: 2020 2f2f 2073 7263 302e 7368 6170 6520    // src0.shape 
-0007d6c0: 2020 5b6e 2c6d 5d0a 2020 2020 2020 2020    [n,m].        
-0007d6d0: 2020 2020 2020 2020 2f2f 2073 7263 312e          // src1.
-0007d6e0: 7368 6170 6520 2020 5b6e 2c70 5d0a 0a20  shape   [n,p].. 
-0007d6f0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0007d700: 2f20 6e65 6365 7373 6172 7920 666f 7220  / necessary for 
-0007d710: 6c6c 616d 610a 2020 2020 2020 2020 2020  llama.          
-0007d720: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0007d730: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0007d740: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0007d750: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
-0007d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d770: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0007d780: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-0007d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d7a0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-0007d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d7d0: 6767 6d6c 5f6f 7574 5f70 726f 6428 6374  ggml_out_prod(ct
-0007d7e0: 782c 202f 2f20 5b6e 2c6d 5d0a 2020 2020  x, // [n,m].    
-0007d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c9f0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
+0007ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ca10: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007ca20: 5f72 6570 6561 7428 6374 782c 2074 656e  _repeat(ctx, ten
+0007ca30: 736f 722d 3e67 7261 642c 2073 7263 302d  sor->grad, src0-
+0007ca40: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
+0007ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ca60: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+0007ca70: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007ca80: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0007ca90: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007caa0: 6520 4747 4d4c 5f4f 505f 4142 533a 0a20  e GGML_OP_ABS:. 
+0007cab0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0007cac0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007cad0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+0007cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007caf0: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
+0007cb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cb10: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+0007cb20: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
+0007cb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cb40: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0007cb50: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+0007cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cb70: 2020 2020 2020 2067 676d 6c5f 6d75 6c28         ggml_mul(
+0007cb80: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0007cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cba0: 2020 2020 2020 2020 2067 676d 6c5f 7367           ggml_sg
+0007cbb0: 6e28 6374 782c 2073 7263 3029 2c0a 2020  n(ctx, src0),.  
+0007cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cbe0: 2020 7465 6e73 6f72 2d3e 6772 6164 292c    tensor->grad),
+0007cbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cc10: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+0007cc20: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0007cc30: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0007cc40: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0007cc50: 474d 4c5f 4f50 5f53 474e 3a0a 2020 2020  GML_OP_SGN:.    
+0007cc60: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007cc70: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0007cc80: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
+0007cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cca0: 2f2f 206e 6f6f 700a 2020 2020 2020 2020  // noop.        
+0007ccb0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0007ccc0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0007ccd0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007cce0: 5f4f 505f 4e45 473a 0a20 2020 2020 2020  _OP_NEG:.       
+0007ccf0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007cd00: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
+0007cd10: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+0007cd20: 2020 2020 2020 2020 2020 2020 2073 7263               src
+0007cd30: 302d 3e67 7261 6420 3d20 6767 6d6c 5f73  0->grad = ggml_s
+0007cd40: 7562 5f69 6d70 6c28 6374 782c 2073 7263  ub_impl(ctx, src
+0007cd50: 302d 3e67 7261 642c 2074 656e 736f 722d  0->grad, tensor-
+0007cd60: 3e67 7261 642c 2069 6e70 6c61 6365 293b  >grad, inplace);
+0007cd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007cd80: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0007cd90: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007cda0: 6361 7365 2047 474d 4c5f 4f50 5f53 5445  case GGML_OP_STE
+0007cdb0: 503a 0a20 2020 2020 2020 2020 2020 207b  P:.            {
+0007cdc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007cdd0: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+0007cde0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007cdf0: 2020 2020 2020 202f 2f20 6e6f 6f70 0a20         // noop. 
+0007ce00: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0007ce10: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0007ce20: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0007ce30: 7365 2047 474d 4c5f 4f50 5f52 454c 553a  se GGML_OP_RELU:
+0007ce40: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0007ce50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007ce60: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
+0007ce70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ce80: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+0007ce90: 3d20 6767 6d6c 5f73 7562 5f69 6d70 6c28  = ggml_sub_impl(
+0007cea0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0007ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cec0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
+0007ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cee0: 2020 2020 2020 2020 2067 676d 6c5f 6d75           ggml_mu
+0007cef0: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+0007cf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cf10: 2020 2020 2020 2067 676d 6c5f 7374 6570         ggml_step
+0007cf20: 2863 7478 2c20 7372 6330 292c 0a20 2020  (ctx, src0),.   
+0007cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cf40: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0007cf50: 736f 722d 3e67 7261 6429 2c0a 2020 2020  sor->grad),.    
+0007cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cf70: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+0007cf80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007cf90: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0007cfa0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007cfb0: 2063 6173 6520 4747 4d4c 5f4f 505f 4745   case GGML_OP_GE
+0007cfc0: 4c55 3a0a 2020 2020 2020 2020 2020 2020  LU:.            
+0007cfd0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007cfe0: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0007cff0: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
+0007d000: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
+0007d010: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0007d020: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0007d030: 2047 474d 4c5f 4f50 5f47 454c 555f 5155   GGML_OP_GELU_QU
+0007d040: 4943 4b3a 0a20 2020 2020 2020 2020 2020  ICK:.           
+0007d050: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007d060: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+0007d070: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+0007d080: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
+0007d090: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0007d0a0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007d0b0: 6520 4747 4d4c 5f4f 505f 414c 4942 493a  e GGML_OP_ALIBI:
+0007d0c0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0007d0d0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0007d0e0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0007d0f0: 293b 202f 2f20 544f 444f 3a20 6e6f 7420  ); // TODO: not 
+0007d100: 696d 706c 656d 656e 7465 640a 2020 2020  implemented.    
+0007d110: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0007d120: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0007d130: 4d4c 5f4f 505f 434c 414d 503a 0a20 2020  ML_OP_CLAMP:.   
+0007d140: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007d150: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0007d160: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
+0007d170: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
+0007d180: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
+0007d190: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007d1a0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007d1b0: 505f 5349 4c55 3a0a 2020 2020 2020 2020  P_SILU:.        
+0007d1c0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007d1d0: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
+0007d1e0: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
+0007d1f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007d200: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+0007d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d220: 2020 2073 7263 302d 3e67 7261 6420 3d20     src0->grad = 
+0007d230: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+0007d240: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0007d250: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007d260: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+0007d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d280: 2020 2020 2020 2067 676d 6c5f 7369 6c75         ggml_silu
+0007d290: 5f62 6163 6b28 6374 782c 2073 7263 302c  _back(ctx, src0,
+0007d2a0: 2074 656e 736f 722d 3e67 7261 6429 2c0a   tensor->grad),.
+0007d2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d2c0: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+0007d2d0: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0007d2e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007d2f0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007d300: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007d310: 505f 5349 4c55 5f42 4143 4b3a 0a20 2020  P_SILU_BACK:.   
+0007d320: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007d330: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0007d340: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
+0007d350: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
+0007d360: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
+0007d370: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007d380: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007d390: 505f 4e4f 524d 3a0a 2020 2020 2020 2020  P_NORM:.        
+0007d3a0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007d3b0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0007d3c0: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
+0007d3d0: 4f3a 206e 6f74 2069 6d70 6c65 6d65 6e74  O: not implement
+0007d3e0: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
+0007d3f0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007d400: 6361 7365 2047 474d 4c5f 4f50 5f52 4d53  case GGML_OP_RMS
+0007d410: 5f4e 4f52 4d3a 0a20 2020 2020 2020 2020  _NORM:.         
+0007d420: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0007d430: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
+0007d440: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
+0007d450: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0007d460: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+0007d470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d480: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
+0007d490: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+0007d4a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007d4b0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007d4c0: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
+0007d4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d4e0: 2020 2020 2020 6767 6d6c 5f72 6d73 5f6e        ggml_rms_n
+0007d4f0: 6f72 6d5f 6261 636b 2863 7478 2c20 7372  orm_back(ctx, sr
+0007d500: 6330 2c20 7465 6e73 6f72 2d3e 6772 6164  c0, tensor->grad
+0007d510: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0007d520: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007d530: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+0007d540: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007d550: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007d560: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007d570: 4c5f 4f50 5f52 4d53 5f4e 4f52 4d5f 4241  L_OP_RMS_NORM_BA
+0007d580: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+0007d590: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007d5a0: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0007d5b0: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
+0007d5c0: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
+0007d5d0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0007d5e0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0007d5f0: 2047 474d 4c5f 4f50 5f4d 554c 5f4d 4154   GGML_OP_MUL_MAT
+0007d600: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0007d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d620: 2f2f 2068 7474 7073 3a2f 2f63 7332 3331  // https://cs231
+0007d630: 6e2e 6769 7468 7562 2e69 6f2f 6f70 7469  n.github.io/opti
+0007d640: 6d69 7a61 7469 6f6e 2d32 2f23 7374 6167  mization-2/#stag
+0007d650: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+0007d660: 2020 202f 2f20 2320 666f 7277 6172 6420     // # forward 
+0007d670: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+0007d680: 2020 2020 202f 2f20 7330 203d 206e 702e       // s0 = np.
+0007d690: 7261 6e64 6f6d 2e72 616e 646e 2835 2c20  random.randn(5, 
+0007d6a0: 3130 290a 2020 2020 2020 2020 2020 2020  10).            
+0007d6b0: 2020 2020 2f2f 2073 3120 3d20 6e70 2e72      // s1 = np.r
+0007d6c0: 616e 646f 6d2e 7261 6e64 6e28 3130 2c20  andom.randn(10, 
+0007d6d0: 3329 0a20 2020 2020 2020 2020 2020 2020  3).             
+0007d6e0: 2020 202f 2f20 7420 3d20 7330 2e64 6f74     // t = s0.dot
+0007d6f0: 2873 3129 0a0a 2020 2020 2020 2020 2020  (s1)..          
+0007d700: 2020 2020 2020 2f2f 2023 206e 6f77 2073        // # now s
+0007d710: 7570 706f 7365 2077 6520 6861 6420 7468  uppose we had th
+0007d720: 6520 6772 6164 6965 6e74 206f 6e20 7420  e gradient on t 
+0007d730: 6672 6f6d 2061 626f 7665 2069 6e20 7468  from above in th
+0007d740: 6520 6369 7263 7569 740a 2020 2020 2020  e circuit.      
+0007d750: 2020 2020 2020 2020 2020 2f2f 2064 7420            // dt 
+0007d760: 3d20 6e70 2e72 616e 646f 6d2e 7261 6e64  = np.random.rand
+0007d770: 6e28 2a74 2e73 6861 7065 2920 2320 7361  n(*t.shape) # sa
+0007d780: 6d65 2073 6861 7065 2061 7320 740a 2020  me shape as t.  
+0007d790: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007d7a0: 2064 7330 203d 2064 742e 646f 7428 7331   ds0 = dt.dot(s1
+0007d7b0: 2e54 2920 232e 5420 6769 7665 7320 7468  .T) #.T gives th
+0007d7c0: 6520 7472 616e 7370 6f73 6520 6f66 2074  e transpose of t
+0007d7d0: 6865 206d 6174 7269 780a 2020 2020 2020  he matrix.      
+0007d7e0: 2020 2020 2020 2020 2020 2f2f 2064 7331            // ds1
+0007d7f0: 203d 2074 2e54 2e64 6f74 2864 7429 0a0a   = t.T.dot(dt)..
 0007d800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d810: 7372 6331 2c20 2020 2020 2020 2020 202f  src1,          /
-0007d820: 2f20 5b6e 2c70 5d0a 2020 2020 2020 2020  / [n,p].        
-0007d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d840: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-0007d850: 6f72 2d3e 6772 6164 292c 202f 2f20 5b6d  or->grad), // [m
-0007d860: 2c70 5d0a 2020 2020 2020 2020 2020 2020  ,p].            
-0007d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d880: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-0007d890: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0007d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d8b0: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
-0007d8c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007d8d0: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
-0007d8e0: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-0007d8f0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007d900: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
+0007d810: 2f2f 2074 656e 736f 722e 7368 6170 6520  // tensor.shape 
+0007d820: 5b6d 2c70 5d0a 2020 2020 2020 2020 2020  [m,p].          
+0007d830: 2020 2020 2020 2f2f 2073 7263 302e 7368        // src0.sh
+0007d840: 6170 6520 2020 5b6e 2c6d 5d0a 2020 2020  ape   [n,m].    
+0007d850: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
+0007d860: 7263 312e 7368 6170 6520 2020 5b6e 2c70  rc1.shape   [n,p
+0007d870: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+0007d880: 2020 202f 2f20 6e65 6365 7373 6172 7920     // necessary 
+0007d890: 666f 7220 6c6c 616d 610a 2020 2020 2020  for llama.      
+0007d8a0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0007d8b0: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
+0007d8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d8d0: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
+0007d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d8f0: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
+0007d900: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
 0007d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d920: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0007d930: 6331 2d3e 6772 6164 2c0a 2020 2020 2020  c1->grad,.      
+0007d920: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007d930: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
 0007d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d950: 2020 2020 2020 2020 2020 2f2f 2067 676d            // ggm
-0007d960: 6c5f 6d75 6c5f 6d61 7428 6374 782c 2020  l_mul_mat(ctx,  
+0007d950: 2020 2020 6767 6d6c 5f6f 7574 5f70 726f      ggml_out_pro
+0007d960: 6428 6374 782c 202f 2f20 5b6e 2c6d 5d0a  d(ctx, // [n,m].
 0007d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d980: 202f 2f20 5b6e 2c70 5d0a 2020 2020 2020   // [n,p].      
-0007d990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d9a0: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-0007d9b0: 2067 676d 6c5f 636f 6e74 2863 7478 2c20   ggml_cont(ctx, 
+0007d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d990: 2020 2020 7372 6331 2c20 2020 2020 2020      src1,       
+0007d9a0: 2020 202f 2f20 5b6e 2c70 5d0a 2020 2020     // [n,p].    
+0007d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d9d0: 202f 2f20 5b6d 2c6e 5d0a 2020 2020 2020   // [m,n].      
-0007d9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d9f0: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-0007da00: 2020 2020 2067 676d 6c5f 7472 616e 7370       ggml_transp
-0007da10: 6f73 6528 6374 782c 2073 7263 3029 292c  ose(ctx, src0)),
-0007da20: 202f 2f20 5b6d 2c6e 5d0a 2020 2020 2020   // [m,n].      
-0007da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da40: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-0007da50: 2074 656e 736f 722d 3e67 7261 6429 2c20   tensor->grad), 
-0007da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da70: 202f 2f20 5b6d 2c70 5d0a 0a20 2020 2020   // [m,p]..     
-0007da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da90: 2020 2020 2020 2020 2020 202f 2f20 2f2f             // //
-0007daa0: 2077 6865 6e20 7372 6330 2069 7320 6269   when src0 is bi
-0007dab0: 6767 6572 2074 6861 6e20 7465 6e73 6f72  gger than tensor
-0007dac0: 2d3e 6772 6164 2028 7468 6973 2069 7320  ->grad (this is 
-0007dad0: 6d6f 7374 6c79 2074 6865 2063 6173 6520  mostly the case 
-0007dae0: 696e 206c 6c61 6d61 292c 0a20 2020 2020  in llama),.     
-0007daf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007db00: 2020 2020 2020 2020 2020 202f 2f20 2f2f             // //
-0007db10: 2061 766f 6964 2074 7261 6e73 706f 7365   avoid transpose
-0007db20: 206f 6620 7372 6330 2c20 7261 7468 6572   of src0, rather
-0007db30: 2074 7261 6e73 706f 7365 2073 6d61 6c6c   transpose small
-0007db40: 6572 2074 656e 736f 722d 3e67 7261 640a  er tensor->grad.
-0007db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d9d0: 7465 6e73 6f72 2d3e 6772 6164 292c 202f  tensor->grad), /
+0007d9e0: 2f20 5b6d 2c70 5d0a 2020 2020 2020 2020  / [m,p].        
+0007d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007da00: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+0007da10: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007da20: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0007da30: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
+0007da40: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+0007da50: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+0007da60: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
+0007da70: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007da80: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+0007da90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dab0: 2020 7372 6331 2d3e 6772 6164 2c0a 2020    src1->grad,.  
+0007dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dad0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007dae0: 2067 676d 6c5f 6d75 6c5f 6d61 7428 6374   ggml_mul_mat(ct
+0007daf0: 782c 2020 2020 2020 2020 2020 2020 2020  x,              
+0007db00: 2020 2020 202f 2f20 5b6e 2c70 5d0a 2020       // [n,p].  
+0007db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007db20: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007db30: 2020 2020 2067 676d 6c5f 636f 6e74 2863       ggml_cont(c
+0007db40: 7478 2c20 2020 2020 2020 2020 2020 2020  tx,             
+0007db50: 2020 2020 202f 2f20 5b6d 2c6e 5d0a 2020       // [m,n].  
 0007db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007db70: 2f2f 202f 2f20 616e 6420 7468 656e 2075  // // and then u
-0007db80: 7365 2067 676d 6c5f 6f75 745f 7072 6f64  se ggml_out_prod
-0007db90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dbb0: 2067 676d 6c5f 6f75 745f 7072 6f64 2863   ggml_out_prod(c
-0007dbc0: 7478 2c20 2020 2020 2020 2020 2020 2020  tx,             
-0007dbd0: 2020 2020 202f 2f20 5b6e 2c70 5d0a 2020       // [n,p].  
-0007dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc00: 2020 7372 6330 2c20 2020 2020 2020 2020    src0,         
-0007dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc20: 2020 2f2f 205b 6e2c 6d5d 0a20 2020 2020    // [n,m].     
-0007dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0007dc50: 676d 6c5f 7472 616e 7370 6f73 6528 6374  gml_transpose(ct
-0007dc60: 782c 2020 2020 2020 2020 2020 2020 202f  x,             /
-0007dc70: 2f20 5b70 2c6d 5d0a 2020 2020 2020 2020  / [p,m].        
-0007dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dca0: 7465 6e73 6f72 2d3e 6772 6164 2929 2c20  tensor->grad)), 
-0007dcb0: 2020 2020 2020 2020 2020 2020 2f2f 205b              // [
-0007dcc0: 6d2c 705d 0a20 2020 2020 2020 2020 2020  m,p].           
-0007dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dce0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-0007dcf0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007dd00: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0007dd10: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-0007dd20: 7365 2047 474d 4c5f 4f50 5f4f 5554 5f50  se GGML_OP_OUT_P
-0007dd30: 524f 443a 0a20 2020 2020 2020 2020 2020  ROD:.           
-0007dd40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007dd50: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0007dd60: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
-0007dd70: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
-0007dd80: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0007dd90: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0007dda0: 6520 4747 4d4c 5f4f 505f 5343 414c 453a  e GGML_OP_SCALE:
-0007ddb0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0007ddc0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0007ddd0: 2f20 6e65 6365 7373 6172 7920 666f 7220  / necessary for 
-0007dde0: 6c6c 616d 610a 2020 2020 2020 2020 2020  llama.          
-0007ddf0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0007de00: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0007de10: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0007de20: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
-0007de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007de40: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0007de50: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-0007de60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007de70: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
-0007de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007de90: 2020 2020 2020 2020 6767 6d6c 5f73 6361          ggml_sca
-0007dea0: 6c65 5f69 6d70 6c28 6374 782c 2074 656e  le_impl(ctx, ten
-0007deb0: 736f 722d 3e67 7261 642c 2073 7263 312c  sor->grad, src1,
-0007dec0: 2066 616c 7365 292c 0a20 2020 2020 2020   false),.       
-0007ded0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dee0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-0007def0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007df00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007df10: 2069 6620 2873 7263 312d 3e67 7261 6429   if (src1->grad)
-0007df20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007df30: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
-0007df40: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
-0007df50: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007df60: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
-0007df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007df80: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-0007df90: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-0007dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dfb0: 2020 2067 676d 6c5f 7375 6d28 6374 782c     ggml_sum(ctx,
-0007dfc0: 2067 676d 6c5f 6d75 6c5f 696d 706c 2863   ggml_mul_impl(c
-0007dfd0: 7478 2c20 7465 6e73 6f72 2d3e 6772 6164  tx, tensor->grad
-0007dfe0: 2c20 7372 6330 2c20 6661 6c73 6529 292c  , src0, false)),
-0007dff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007e000: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-0007e010: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-0007e020: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0007e030: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0007e040: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007e050: 4f50 5f53 4554 3a0a 2020 2020 2020 2020  OP_SET:.        
-0007e060: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007e070: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0007e080: 5428 6767 6d6c 5f6e 656c 656d 656e 7473  T(ggml_nelements
-0007e090: 2874 656e 736f 722d 3e6f 7074 5b30 5d29  (tensor->opt[0])
-0007e0a0: 203d 3d20 3529 3b0a 2020 2020 2020 2020   == 5);.        
-0007e0b0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0007e0c0: 4552 5428 7465 6e73 6f72 2d3e 6f70 745b  ERT(tensor->opt[
-0007e0d0: 305d 2d3e 7479 7065 203d 3d20 4747 4d4c  0]->type == GGML
-0007e0e0: 5f54 5950 455f 4933 3229 3b0a 2020 2020  _TYPE_I32);.    
-0007e0f0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0007e100: 7420 7369 7a65 5f74 206e 6231 2020 2020  t size_t nb1    
-0007e110: 203d 2028 2820 696e 7433 325f 7420 2a20   = (( int32_t * 
-0007e120: 2920 7465 6e73 6f72 2d3e 6f70 745b 305d  ) tensor->opt[0]
-0007e130: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
-0007e140: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0007e150: 7420 7369 7a65 5f74 206e 6232 2020 2020  t size_t nb2    
-0007e160: 203d 2028 2820 696e 7433 325f 7420 2a20   = (( int32_t * 
-0007e170: 2920 7465 6e73 6f72 2d3e 6f70 745b 305d  ) tensor->opt[0]
-0007e180: 2d3e 6461 7461 295b 315d 3b0a 2020 2020  ->data)[1];.    
-0007e190: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0007e1a0: 7420 7369 7a65 5f74 206e 6233 2020 2020  t size_t nb3    
-0007e1b0: 203d 2028 2820 696e 7433 325f 7420 2a20   = (( int32_t * 
-0007e1c0: 2920 7465 6e73 6f72 2d3e 6f70 745b 305d  ) tensor->opt[0]
-0007e1d0: 2d3e 6461 7461 295b 325d 3b0a 2020 2020  ->data)[2];.    
-0007e1e0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0007e1f0: 7420 7369 7a65 5f74 206f 6666 7365 7420  t size_t offset 
-0007e200: 203d 2028 2820 696e 7433 325f 7420 2a20   = (( int32_t * 
-0007e210: 2920 7465 6e73 6f72 2d3e 6f70 745b 305d  ) tensor->opt[0]
-0007e220: 2d3e 6461 7461 295b 335d 3b0a 0a20 2020  ->data)[3];..   
-0007e230: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0007e240: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0007e250: 2a20 7465 6e73 6f72 5f67 7261 645f 7669  * tensor_grad_vi
-0007e260: 6577 203d 204e 554c 4c3b 0a0a 2020 2020  ew = NULL;..    
-0007e270: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0007e280: 7372 6330 2d3e 6772 6164 207c 7c20 7372  src0->grad || sr
-0007e290: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
-0007e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e2b0: 4747 4d4c 5f41 5353 4552 5428 7372 6330  GGML_ASSERT(src0
-0007e2c0: 2d3e 7479 7065 203d 3d20 7465 6e73 6f72  ->type == tensor
-0007e2d0: 2d3e 7479 7065 293b 0a20 2020 2020 2020  ->type);.       
-0007e2e0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-0007e2f0: 4c5f 4153 5345 5254 2874 656e 736f 722d  L_ASSERT(tensor-
-0007e300: 3e67 7261 642d 3e74 7970 6520 3d3d 2074  >grad->type == t
-0007e310: 656e 736f 722d 3e74 7970 6529 3b0a 2020  ensor->type);.  
-0007e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e330: 2020 4747 4d4c 5f41 5353 4552 5428 7465    GGML_ASSERT(te
-0007e340: 6e73 6f72 2d3e 6772 6164 2d3e 7479 7065  nsor->grad->type
-0007e350: 203d 3d20 7372 6331 2d3e 6772 6164 2d3e   == src1->grad->
-0007e360: 7479 7065 293b 0a0a 2020 2020 2020 2020  type);..        
-0007e370: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-0007e380: 6f72 5f67 7261 645f 7669 6577 203d 2067  or_grad_view = g
-0007e390: 676d 6c5f 7669 6577 5f34 6428 6374 782c  gml_view_4d(ctx,
-0007e3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007e3b0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-0007e3c0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-0007e3d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007e3e0: 7263 312d 3e67 7261 642d 3e6e 655b 305d  rc1->grad->ne[0]
-0007e3f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007e400: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-0007e410: 6772 6164 2d3e 6e65 5b31 5d2c 0a20 2020  grad->ne[1],.   
+0007db70: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007db80: 2020 2020 2020 2020 2067 676d 6c5f 7472           ggml_tr
+0007db90: 616e 7370 6f73 6528 6374 782c 2073 7263  anspose(ctx, src
+0007dba0: 3029 292c 202f 2f20 5b6d 2c6e 5d0a 2020  0)), // [m,n].  
+0007dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dbc0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007dbd0: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
+0007dbe0: 6429 2c20 2020 2020 2020 2020 2020 2020  d),             
+0007dbf0: 2020 2020 202f 2f20 5b6d 2c70 5d0a 0a20       // [m,p].. 
+0007dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dc10: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0007dc20: 2f20 2f2f 2077 6865 6e20 7372 6330 2069  / // when src0 i
+0007dc30: 7320 6269 6767 6572 2074 6861 6e20 7465  s bigger than te
+0007dc40: 6e73 6f72 2d3e 6772 6164 2028 7468 6973  nsor->grad (this
+0007dc50: 2069 7320 6d6f 7374 6c79 2074 6865 2063   is mostly the c
+0007dc60: 6173 6520 696e 206c 6c61 6d61 292c 0a20  ase in llama),. 
+0007dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dc80: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0007dc90: 2f20 2f2f 2061 766f 6964 2074 7261 6e73  / // avoid trans
+0007dca0: 706f 7365 206f 6620 7372 6330 2c20 7261  pose of src0, ra
+0007dcb0: 7468 6572 2074 7261 6e73 706f 7365 2073  ther transpose s
+0007dcc0: 6d61 6c6c 6572 2074 656e 736f 722d 3e67  maller tensor->g
+0007dcd0: 7261 640a 2020 2020 2020 2020 2020 2020  rad.            
+0007dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dcf0: 2020 2020 2f2f 202f 2f20 616e 6420 7468      // // and th
+0007dd00: 656e 2075 7365 2067 676d 6c5f 6f75 745f  en use ggml_out_
+0007dd10: 7072 6f64 0a20 2020 2020 2020 2020 2020  prod.           
+0007dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dd30: 2020 2020 2067 676d 6c5f 6f75 745f 7072       ggml_out_pr
+0007dd40: 6f64 2863 7478 2c20 2020 2020 2020 2020  od(ctx,         
+0007dd50: 2020 2020 2020 2020 202f 2f20 5b6e 2c70           // [n,p
+0007dd60: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0007dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dd80: 2020 2020 2020 7372 6330 2c20 2020 2020        src0,     
+0007dd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dda0: 2020 2020 2020 2f2f 205b 6e2c 6d5d 0a20        // [n,m]. 
+0007ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ddc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ddd0: 2020 2067 676d 6c5f 7472 616e 7370 6f73     ggml_transpos
+0007dde0: 6528 6374 782c 2020 2020 2020 2020 2020  e(ctx,          
+0007ddf0: 2020 202f 2f20 5b70 2c6d 5d0a 2020 2020     // [p,m].    
+0007de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007de10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007de20: 2020 2020 7465 6e73 6f72 2d3e 6772 6164      tensor->grad
+0007de30: 2929 2c20 2020 2020 2020 2020 2020 2020  )),             
+0007de40: 2f2f 205b 6d2c 705d 0a20 2020 2020 2020  // [m,p].       
+0007de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007de60: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+0007de70: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0007de80: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0007de90: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0007dea0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4f    case GGML_OP_O
+0007deb0: 5554 5f50 524f 443a 0a20 2020 2020 2020  UT_PROD:.       
+0007dec0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007ded0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0007dee0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
+0007def0: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
+0007df00: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+0007df10: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007df20: 2063 6173 6520 4747 4d4c 5f4f 505f 5343   case GGML_OP_SC
+0007df30: 414c 453a 0a20 2020 2020 2020 2020 2020  ALE:.           
+0007df40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007df50: 2020 202f 2f20 6e65 6365 7373 6172 7920     // necessary 
+0007df60: 666f 7220 6c6c 616d 610a 2020 2020 2020  for llama.      
+0007df70: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0007df80: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
+0007df90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dfa0: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
+0007dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dfc0: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
+0007dfd0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+0007dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dff0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
+0007e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e010: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007e020: 5f73 6361 6c65 5f69 6d70 6c28 6374 782c  _scale_impl(ctx,
+0007e030: 2074 656e 736f 722d 3e67 7261 642c 2073   tensor->grad, s
+0007e040: 7263 312c 2066 616c 7365 292c 0a20 2020  rc1, false),.   
+0007e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e060: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+0007e070: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0007e080: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0007e090: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
+0007e0a0: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0007e0b0: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
+0007e0c0: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
+0007e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e0e0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+0007e0f0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0007e100: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007e110: 7263 312d 3e67 7261 642c 0a20 2020 2020  rc1->grad,.     
+0007e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e130: 2020 2020 2020 2067 676d 6c5f 7375 6d28         ggml_sum(
+0007e140: 6374 782c 2067 676d 6c5f 6d75 6c5f 696d  ctx, ggml_mul_im
+0007e150: 706c 2863 7478 2c20 7465 6e73 6f72 2d3e  pl(ctx, tensor->
+0007e160: 6772 6164 2c20 7372 6330 2c20 6661 6c73  grad, src0, fals
+0007e170: 6529 292c 0a20 2020 2020 2020 2020 2020  e)),.           
+0007e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e190: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+0007e1a0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0007e1b0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0007e1c0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0007e1d0: 474d 4c5f 4f50 5f53 4554 3a0a 2020 2020  GML_OP_SET:.    
+0007e1e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007e1f0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0007e200: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
+0007e210: 656e 7473 2874 656e 736f 722d 3e6f 7074  ents(tensor->opt
+0007e220: 5b30 5d29 203d 3d20 3529 3b0a 2020 2020  [0]) == 5);.    
+0007e230: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0007e240: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
+0007e250: 6f70 745b 305d 2d3e 7479 7065 203d 3d20  opt[0]->type == 
+0007e260: 4747 4d4c 5f54 5950 455f 4933 3229 3b0a  GGML_TYPE_I32);.
+0007e270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e280: 636f 6e73 7420 7369 7a65 5f74 206e 6231  const size_t nb1
+0007e290: 2020 2020 203d 2028 2820 696e 7433 325f       = (( int32_
+0007e2a0: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
+0007e2b0: 745b 305d 2d3e 6461 7461 295b 305d 3b0a  t[0]->data)[0];.
+0007e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e2d0: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
+0007e2e0: 2020 2020 203d 2028 2820 696e 7433 325f       = (( int32_
+0007e2f0: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
+0007e300: 745b 305d 2d3e 6461 7461 295b 315d 3b0a  t[0]->data)[1];.
+0007e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e320: 636f 6e73 7420 7369 7a65 5f74 206e 6233  const size_t nb3
+0007e330: 2020 2020 203d 2028 2820 696e 7433 325f       = (( int32_
+0007e340: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
+0007e350: 745b 305d 2d3e 6461 7461 295b 325d 3b0a  t[0]->data)[2];.
+0007e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e370: 636f 6e73 7420 7369 7a65 5f74 206f 6666  const size_t off
+0007e380: 7365 7420 203d 2028 2820 696e 7433 325f  set  = (( int32_
+0007e390: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
+0007e3a0: 745b 305d 2d3e 6461 7461 295b 335d 3b0a  t[0]->data)[3];.
+0007e3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007e3c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0007e3d0: 736f 7220 2a20 7465 6e73 6f72 5f67 7261  sor * tensor_gra
+0007e3e0: 645f 7669 6577 203d 204e 554c 4c3b 0a0a  d_view = NULL;..
+0007e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e400: 6966 2028 7372 6330 2d3e 6772 6164 207c  if (src0->grad |
+0007e410: 7c20 7372 6331 2d3e 6772 6164 2920 7b0a  | src1->grad) {.
 0007e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e430: 2020 2020 2073 7263 312d 3e67 7261 642d       src1->grad-
-0007e440: 3e6e 655b 325d 2c0a 2020 2020 2020 2020  >ne[2],.        
-0007e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e460: 7372 6331 2d3e 6772 6164 2d3e 6e65 5b33  src1->grad->ne[3
-0007e470: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0007e480: 2020 2020 2020 2020 2020 206e 6231 2c20             nb1, 
-0007e490: 6e62 322c 206e 6233 2c20 6f66 6673 6574  nb2, nb3, offset
-0007e4a0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007e4b0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0007e4c0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0007e4d0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0007e4e0: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0007e4f0: 2d3e 6772 6164 203d 2067 676d 6c5f 6164  ->grad = ggml_ad
-0007e500: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
-0007e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e520: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-0007e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e540: 2020 2020 2020 2020 6767 6d6c 5f61 6363          ggml_acc
-0007e550: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
-0007e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e570: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
-0007e580: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-0007e590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e5a0: 2067 676d 6c5f 6e65 6728 6374 782c 2074   ggml_neg(ctx, t
-0007e5b0: 656e 736f 725f 6772 6164 5f76 6965 7729  ensor_grad_view)
-0007e5c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007e5d0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-0007e5e0: 312c 206e 6232 2c20 6e62 332c 206f 6666  1, nb2, nb3, off
-0007e5f0: 7365 742c 2066 616c 7365 292c 0a20 2020  set, false),.   
-0007e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e610: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-0007e620: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007e630: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0007e640: 2020 6966 2028 7372 6331 2d3e 6772 6164    if (src1->grad
-0007e650: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007e660: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
-0007e670: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
-0007e680: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0007e690: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
-0007e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e6b0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
-0007e6c0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-0007e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e6e0: 2020 2020 6767 6d6c 5f72 6573 6861 7065      ggml_reshape
-0007e6f0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-0007e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e710: 2020 2020 2020 6767 6d6c 5f63 6f6e 7428        ggml_cont(
-0007e720: 6374 782c 2074 656e 736f 725f 6772 6164  ctx, tensor_grad
-0007e730: 5f76 6965 7729 2c0a 2020 2020 2020 2020  _view),.        
-0007e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e750: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
-0007e760: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
-0007e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e780: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-0007e790: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0007e7a0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0007e7b0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0007e7c0: 474d 4c5f 4f50 5f43 5059 3a0a 2020 2020  GML_OP_CPY:.    
-0007e7d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007e7e0: 2020 2020 2020 2020 2020 2f2f 206e 6563            // nec
-0007e7f0: 6573 7361 7279 2066 6f72 206c 6c61 6d61  essary for llama
-0007e800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007e810: 202f 2f20 6370 7920 6f76 6572 7772 6974   // cpy overwrit
-0007e820: 6573 2076 616c 7565 206f 6620 7372 6331  es value of src1
-0007e830: 2062 7920 7372 6330 2061 6e64 2072 6574   by src0 and ret
-0007e840: 7572 6e73 2076 6965 7728 7372 6331 290a  urns view(src1).
+0007e430: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0007e440: 7372 6330 2d3e 7479 7065 203d 3d20 7465  src0->type == te
+0007e450: 6e73 6f72 2d3e 7479 7065 293b 0a20 2020  nsor->type);.   
+0007e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e470: 2047 474d 4c5f 4153 5345 5254 2874 656e   GGML_ASSERT(ten
+0007e480: 736f 722d 3e67 7261 642d 3e74 7970 6520  sor->grad->type 
+0007e490: 3d3d 2074 656e 736f 722d 3e74 7970 6529  == tensor->type)
+0007e4a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007e4b0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0007e4c0: 5428 7465 6e73 6f72 2d3e 6772 6164 2d3e  T(tensor->grad->
+0007e4d0: 7479 7065 203d 3d20 7372 6331 2d3e 6772  type == src1->gr
+0007e4e0: 6164 2d3e 7479 7065 293b 0a0a 2020 2020  ad->type);..    
+0007e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e500: 7465 6e73 6f72 5f67 7261 645f 7669 6577  tensor_grad_view
+0007e510: 203d 2067 676d 6c5f 7669 6577 5f34 6428   = ggml_view_4d(
+0007e520: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0007e530: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0007e540: 736f 722d 3e67 7261 642c 0a20 2020 2020  sor->grad,.     
+0007e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e560: 2020 2073 7263 312d 3e67 7261 642d 3e6e     src1->grad->n
+0007e570: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
+0007e580: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007e590: 6331 2d3e 6772 6164 2d3e 6e65 5b31 5d2c  c1->grad->ne[1],
+0007e5a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007e5b0: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
+0007e5c0: 7261 642d 3e6e 655b 325d 2c0a 2020 2020  rad->ne[2],.    
+0007e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e5e0: 2020 2020 7372 6331 2d3e 6772 6164 2d3e      src1->grad->
+0007e5f0: 6e65 5b33 5d2c 0a20 2020 2020 2020 2020  ne[3],.         
+0007e600: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0007e610: 6231 2c20 6e62 322c 206e 6233 2c20 6f66  b1, nb2, nb3, of
+0007e620: 6673 6574 293b 0a20 2020 2020 2020 2020  fset);.         
+0007e630: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0007e640: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0007e650: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
+0007e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e670: 7372 6330 2d3e 6772 6164 203d 2067 676d  src0->grad = ggm
+0007e680: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
+0007e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e6a0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007e6b0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0007e6c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007e6d0: 5f61 6363 5f69 6d70 6c28 6374 782c 0a20  _acc_impl(ctx,. 
+0007e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e6f0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0007e700: 722d 3e67 7261 642c 0a20 2020 2020 2020  r->grad,.       
+0007e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e720: 2020 2020 2067 676d 6c5f 6e65 6728 6374       ggml_neg(ct
+0007e730: 782c 2074 656e 736f 725f 6772 6164 5f76  x, tensor_grad_v
+0007e740: 6965 7729 2c0a 2020 2020 2020 2020 2020  iew),.          
+0007e750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e760: 2020 6e62 312c 206e 6232 2c20 6e62 332c    nb1, nb2, nb3,
+0007e770: 206f 6666 7365 742c 2066 616c 7365 292c   offset, false),
+0007e780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007e790: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+0007e7a0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0007e7b0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+0007e7c0: 2020 2020 2020 6966 2028 7372 6331 2d3e        if (src1->
+0007e7d0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+0007e7e0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+0007e7f0: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+0007e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e810: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+0007e820: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0007e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e840: 7372 6331 2d3e 6772 6164 2c0a 2020 2020  src1->grad,.    
 0007e850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e860: 2f2f 2074 6865 206f 7665 7277 7269 7469  // the overwriti
-0007e870: 6e67 2069 7320 6d61 7468 656d 6174 6963  ng is mathematic
-0007e880: 616c 6c79 2065 7175 6976 616c 656e 7420  ally equivalent 
-0007e890: 746f 3a0a 2020 2020 2020 2020 2020 2020  to:.            
-0007e8a0: 2020 2020 2f2f 2074 656e 736f 7220 3d20      // tensor = 
-0007e8b0: 7372 6330 202a 2031 202b 2073 7263 3120  src0 * 1 + src1 
-0007e8c0: 2a20 300a 2020 2020 2020 2020 2020 2020  * 0.            
-0007e8d0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0007e8e0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007e8f0: 2020 2020 2020 2020 2020 2f2f 2064 7372            // dsr
-0007e900: 6330 203d 2064 7465 6e73 6f72 202a 2031  c0 = dtensor * 1
-0007e910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007e920: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-0007e930: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
-0007e940: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-0007e950: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
-0007e960: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-0007e970: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007e980: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007e990: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
-0007e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e9b0: 202f 2f20 6473 7263 3120 3d20 6474 656e   // dsrc1 = dten
-0007e9c0: 736f 7220 2a20 3020 2d3e 206e 6f6f 700a  sor * 0 -> noop.
-0007e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e9e0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-0007e9f0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0007ea00: 6173 6520 4747 4d4c 5f4f 505f 434f 4e54  ase GGML_OP_CONT
-0007ea10: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0007ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ea30: 2f2f 2073 616d 6520 6173 2063 7079 0a20  // same as cpy. 
-0007ea40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007ea50: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
-0007ea60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007ea70: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-0007ea80: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
-0007ea90: 6f75 7328 7372 6330 2d3e 6772 6164 2929  ous(src0->grad))
-0007eaa0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007eab0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0007eac0: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-0007ead0: 756f 7573 2874 656e 736f 722d 3e67 7261  uous(tensor->gra
-0007eae0: 6429 293b 0a20 2020 2020 2020 2020 2020  d));.           
-0007eaf0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-0007eb00: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
-0007eb10: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-0007eb20: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
-0007eb30: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
-0007eb40: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0007eb50: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0007eb60: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0007eb70: 2047 474d 4c5f 4f50 5f52 4553 4841 5045   GGML_OP_RESHAPE
-0007eb80: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0007eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eba0: 2f2f 206e 6563 6573 7361 7279 2066 6f72  // necessary for
-0007ebb0: 206c 6c61 6d61 0a20 2020 2020 2020 2020   llama.         
-0007ebc0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-0007ebd0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0007ebe0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0007ebf0: 302d 3e67 7261 6420 3d0a 2020 2020 2020  0->grad =.      
-0007ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ec10: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-0007ec20: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-0007ec30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007ec40: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0007ec50: 6c5f 7265 7368 6170 6528 6374 782c 2074  l_reshape(ctx, t
-0007ec60: 656e 736f 722d 3e67 7261 642c 2073 7263  ensor->grad, src
-0007ec70: 302d 3e67 7261 6429 2c0a 2020 2020 2020  0->grad),.      
-0007ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ec90: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-0007eca0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007ecb0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0007ecc0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0007ecd0: 4747 4d4c 5f4f 505f 5649 4557 3a0a 2020  GGML_OP_VIEW:.  
-0007ece0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0007ecf0: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
-0007ed00: 6563 6573 7361 7279 2066 6f72 206c 6c61  ecessary for lla
-0007ed10: 6d61 0a20 2020 2020 2020 2020 2020 2020  ma.             
-0007ed20: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-0007ed30: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-0007ed40: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
-0007ed50: 6f66 6673 6574 3b0a 0a20 2020 2020 2020  offset;..       
-0007ed60: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-0007ed70: 4c5f 4153 5345 5254 2873 697a 656f 6628  L_ASSERT(sizeof(
-0007ed80: 6f66 6673 6574 2920 3c3d 2067 676d 6c5f  offset) <= ggml_
-0007ed90: 6e62 7974 6573 2874 656e 736f 722d 3e6f  nbytes(tensor->o
-0007eda0: 7074 5b30 5d29 293b 0a20 2020 2020 2020  pt[0]));.       
-0007edb0: 2020 2020 2020 2020 2020 2020 206d 656d               mem
-0007edc0: 6370 7928 266f 6666 7365 742c 2074 656e  cpy(&offset, ten
-0007edd0: 736f 722d 3e6f 7074 5b30 5d2d 3e64 6174  sor->opt[0]->dat
-0007ede0: 612c 2073 697a 656f 6628 6f66 6673 6574  a, sizeof(offset
-0007edf0: 2929 3b0a 0a20 2020 2020 2020 2020 2020  ));..           
-0007ee00: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
-0007ee10: 6e62 3120 2020 2020 3d20 7465 6e73 6f72  nb1     = tensor
-0007ee20: 2d3e 6e62 5b31 5d3b 0a20 2020 2020 2020  ->nb[1];.       
-0007ee30: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-0007ee40: 655f 7420 6e62 3220 2020 2020 3d20 7465  e_t nb2     = te
-0007ee50: 6e73 6f72 2d3e 6e62 5b32 5d3b 0a20 2020  nsor->nb[2];.   
-0007ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ee70: 2073 697a 655f 7420 6e62 3320 2020 2020   size_t nb3     
-0007ee80: 3d20 7465 6e73 6f72 2d3e 6e62 5b33 5d3b  = tensor->nb[3];
-0007ee90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0007eea0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0007eeb0: 7479 7065 2021 3d20 7372 6330 2d3e 6772  type != src0->gr
-0007eec0: 6164 2d3e 7479 7065 2920 7b0a 2020 2020  ad->type) {.    
-0007eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eee0: 2020 2020 2f2f 2067 7261 6469 656e 7420      // gradient 
-0007eef0: 6973 2074 7970 6963 616c 6c79 2046 3332  is typically F32
-0007ef00: 2c20 6275 7420 7372 6330 2063 6f75 6c64  , but src0 could
-0007ef10: 2062 6520 6f74 6865 7220 7479 7065 0a20   be other type. 
-0007ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ef30: 2020 2020 2020 2073 697a 655f 7420 6e67         size_t ng
-0007ef40: 203d 2067 676d 6c5f 656c 656d 656e 745f   = ggml_element_
-0007ef50: 7369 7a65 2873 7263 302d 3e67 7261 6429  size(src0->grad)
-0007ef60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007ef70: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
-0007ef80: 206e 3020 3d20 6767 6d6c 5f65 6c65 6d65   n0 = ggml_eleme
-0007ef90: 6e74 5f73 697a 6528 7372 6330 293b 0a20  nt_size(src0);. 
-0007efa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007efb0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0007efc0: 5254 286f 6666 7365 7420 2520 6e30 203d  RT(offset % n0 =
-0007efd0: 3d20 3029 3b0a 2020 2020 2020 2020 2020  = 0);.          
-0007efe0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-0007eff0: 4d4c 5f41 5353 4552 5428 6e62 3120 2520  ML_ASSERT(nb1 % 
-0007f000: 6e30 203d 3d20 3029 3b0a 2020 2020 2020  n0 == 0);.      
-0007f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f020: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-0007f030: 3220 2520 6e30 203d 3d20 3029 3b0a 2020  2 % n0 == 0);.  
-0007f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f050: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0007f060: 5428 6e62 3320 2520 6e30 203d 3d20 3029  T(nb3 % n0 == 0)
-0007f070: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007f080: 2020 2020 2020 2020 2020 6f66 6673 6574            offset
-0007f090: 203d 2028 6f66 6673 6574 202f 206e 3029   = (offset / n0)
-0007f0a0: 202a 206e 673b 0a20 2020 2020 2020 2020   * ng;.         
-0007f0b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0007f0c0: 6231 203d 2028 6e62 3120 2f20 6e30 2920  b1 = (nb1 / n0) 
-0007f0d0: 2a20 6e67 3b0a 2020 2020 2020 2020 2020  * ng;.          
-0007f0e0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-0007f0f0: 3220 3d20 286e 6232 202f 206e 3029 202a  2 = (nb2 / n0) *
-0007f100: 206e 673b 0a20 2020 2020 2020 2020 2020   ng;.           
-0007f110: 2020 2020 2020 2020 2020 2020 206e 6233               nb3
-0007f120: 203d 2028 6e62 3320 2f20 6e30 2920 2a20   = (nb3 / n0) * 
-0007f130: 6e67 3b0a 2020 2020 2020 2020 2020 2020  ng;.            
-0007f140: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0007f150: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007f160: 7263 302d 3e67 7261 6420 3d20 6767 6d6c  rc0->grad = ggml
-0007f170: 5f61 6363 5f69 6d70 6c28 6374 782c 2073  _acc_impl(ctx, s
-0007f180: 7263 302d 3e67 7261 642c 2074 656e 736f  rc0->grad, tenso
-0007f190: 722d 3e67 7261 642c 206e 6231 2c20 6e62  r->grad, nb1, nb
-0007f1a0: 322c 206e 6233 2c20 6f66 6673 6574 2c20  2, nb3, offset, 
-0007f1b0: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-0007f1c0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0007f1d0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0007f1e0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0007f1f0: 4d4c 5f4f 505f 5045 524d 5554 453a 0a20  ML_OP_PERMUTE:. 
-0007f200: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0007f210: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0007f220: 6e65 6365 7373 6172 7920 666f 7220 6c6c  necessary for ll
-0007f230: 616d 610a 2020 2020 2020 2020 2020 2020  ama.            
-0007f240: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0007f250: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007f260: 2020 2020 2020 2020 2020 696e 7433 325f            int32_
-0007f270: 7420 2a20 6178 6573 203d 2028 696e 7433  t * axes = (int3
-0007f280: 325f 7420 2a29 2074 656e 736f 722d 3e6f  2_t *) tensor->o
-0007f290: 7074 5b30 5d2d 3e64 6174 613b 0a20 2020  pt[0]->data;.   
-0007f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f2b0: 2069 6e74 2061 7869 7330 203d 2061 7865   int axis0 = axe
-0007f2c0: 735b 305d 2026 2030 7833 3b0a 2020 2020  s[0] & 0x3;.    
+0007e860: 2020 2020 2020 2020 6767 6d6c 5f72 6573          ggml_res
+0007e870: 6861 7065 2863 7478 2c0a 2020 2020 2020  hape(ctx,.      
+0007e880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e890: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0007e8a0: 6f6e 7428 6374 782c 2074 656e 736f 725f  ont(ctx, tensor_
+0007e8b0: 6772 6164 5f76 6965 7729 2c0a 2020 2020  grad_view),.    
+0007e8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e8d0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+0007e8e0: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
+0007e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e900: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
+0007e910: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0007e920: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0007e930: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0007e940: 7365 2047 474d 4c5f 4f50 5f43 5059 3a0a  se GGML_OP_CPY:.
+0007e950: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0007e960: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007e970: 206e 6563 6573 7361 7279 2066 6f72 206c   necessary for l
+0007e980: 6c61 6d61 0a20 2020 2020 2020 2020 2020  lama.           
+0007e990: 2020 2020 202f 2f20 6370 7920 6f76 6572       // cpy over
+0007e9a0: 7772 6974 6573 2076 616c 7565 206f 6620  writes value of 
+0007e9b0: 7372 6331 2062 7920 7372 6330 2061 6e64  src1 by src0 and
+0007e9c0: 2072 6574 7572 6e73 2076 6965 7728 7372   returns view(sr
+0007e9d0: 6331 290a 2020 2020 2020 2020 2020 2020  c1).            
+0007e9e0: 2020 2020 2f2f 2074 6865 206f 7665 7277      // the overw
+0007e9f0: 7269 7469 6e67 2069 7320 6d61 7468 656d  riting is mathem
+0007ea00: 6174 6963 616c 6c79 2065 7175 6976 616c  atically equival
+0007ea10: 656e 7420 746f 3a0a 2020 2020 2020 2020  ent to:.        
+0007ea20: 2020 2020 2020 2020 2f2f 2074 656e 736f          // tenso
+0007ea30: 7220 3d20 7372 6330 202a 2031 202b 2073  r = src0 * 1 + s
+0007ea40: 7263 3120 2a20 300a 2020 2020 2020 2020  rc1 * 0.        
+0007ea50: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+0007ea60: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0007ea70: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007ea80: 2064 7372 6330 203d 2064 7465 6e73 6f72   dsrc0 = dtensor
+0007ea90: 202a 2031 0a20 2020 2020 2020 2020 2020   * 1.           
+0007eaa0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0007eab0: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
+0007eac0: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
+0007ead0: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
+0007eae0: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
+0007eaf0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0007eb00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007eb10: 6620 2873 7263 312d 3e67 7261 6429 207b  f (src1->grad) {
+0007eb20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007eb30: 2020 2020 202f 2f20 6473 7263 3120 3d20       // dsrc1 = 
+0007eb40: 6474 656e 736f 7220 2a20 3020 2d3e 206e  dtensor * 0 -> n
+0007eb50: 6f6f 700a 2020 2020 2020 2020 2020 2020  oop.            
+0007eb60: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0007eb70: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0007eb80: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007eb90: 434f 4e54 3a0a 2020 2020 2020 2020 2020  CONT:.          
+0007eba0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0007ebb0: 2020 2020 2f2f 2073 616d 6520 6173 2063      // same as c
+0007ebc0: 7079 0a20 2020 2020 2020 2020 2020 2020  py.             
+0007ebd0: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+0007ebe0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0007ebf0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0007ec00: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
+0007ec10: 7469 6775 6f75 7328 7372 6330 2d3e 6772  tiguous(src0->gr
+0007ec20: 6164 2929 3b0a 2020 2020 2020 2020 2020  ad));.          
+0007ec30: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0007ec40: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
+0007ec50: 6e74 6967 756f 7573 2874 656e 736f 722d  ntiguous(tensor-
+0007ec60: 3e67 7261 6429 293b 0a20 2020 2020 2020  >grad));.       
+0007ec70: 2020 2020 2020 2020 2020 2020 2073 7263               src
+0007ec80: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
+0007ec90: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
+0007eca0: 302d 3e67 7261 642c 2074 656e 736f 722d  0->grad, tensor-
+0007ecb0: 3e67 7261 642c 2069 6e70 6c61 6365 293b  >grad, inplace);
+0007ecc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ecd0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0007ece0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007ecf0: 6361 7365 2047 474d 4c5f 4f50 5f52 4553  case GGML_OP_RES
+0007ed00: 4841 5045 3a0a 2020 2020 2020 2020 2020  HAPE:.          
+0007ed10: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0007ed20: 2020 2020 2f2f 206e 6563 6573 7361 7279      // necessary
+0007ed30: 2066 6f72 206c 6c61 6d61 0a20 2020 2020   for llama.     
+0007ed40: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+0007ed50: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
+0007ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ed70: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
+0007ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ed90: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
+0007eda0: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
+0007edb0: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+0007edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007edd0: 2067 676d 6c5f 7265 7368 6170 6528 6374   ggml_reshape(ct
+0007ede0: 782c 2074 656e 736f 722d 3e67 7261 642c  x, tensor->grad,
+0007edf0: 2073 7263 302d 3e67 7261 6429 2c0a 2020   src0->grad),.  
+0007ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee10: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
+0007ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee30: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
+0007ee40: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0007ee50: 6173 6520 4747 4d4c 5f4f 505f 5649 4557  ase GGML_OP_VIEW
+0007ee60: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0007ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee80: 2f2f 206e 6563 6573 7361 7279 2066 6f72  // necessary for
+0007ee90: 206c 6c61 6d61 0a20 2020 2020 2020 2020   llama.         
+0007eea0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
+0007eeb0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+0007eec0: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+0007eed0: 655f 7420 6f66 6673 6574 3b0a 0a20 2020  e_t offset;..   
+0007eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007eef0: 2047 474d 4c5f 4153 5345 5254 2873 697a   GGML_ASSERT(siz
+0007ef00: 656f 6628 6f66 6673 6574 2920 3c3d 2067  eof(offset) <= g
+0007ef10: 676d 6c5f 6e62 7974 6573 2874 656e 736f  gml_nbytes(tenso
+0007ef20: 722d 3e6f 7074 5b30 5d29 293b 0a20 2020  r->opt[0]));.   
+0007ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ef40: 206d 656d 6370 7928 266f 6666 7365 742c   memcpy(&offset,
+0007ef50: 2074 656e 736f 722d 3e6f 7074 5b30 5d2d   tensor->opt[0]-
+0007ef60: 3e64 6174 612c 2073 697a 656f 6628 6f66  >data, sizeof(of
+0007ef70: 6673 6574 2929 3b0a 0a20 2020 2020 2020  fset));..       
+0007ef80: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+0007ef90: 655f 7420 6e62 3120 2020 2020 3d20 7465  e_t nb1     = te
+0007efa0: 6e73 6f72 2d3e 6e62 5b31 5d3b 0a20 2020  nsor->nb[1];.   
+0007efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007efc0: 2073 697a 655f 7420 6e62 3220 2020 2020   size_t nb2     
+0007efd0: 3d20 7465 6e73 6f72 2d3e 6e62 5b32 5d3b  = tensor->nb[2];
+0007efe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007eff0: 2020 2020 2073 697a 655f 7420 6e62 3320       size_t nb3 
+0007f000: 2020 2020 3d20 7465 6e73 6f72 2d3e 6e62      = tensor->nb
+0007f010: 5b33 5d3b 0a0a 2020 2020 2020 2020 2020  [3];..          
+0007f020: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0007f030: 6330 2d3e 7479 7065 2021 3d20 7372 6330  c0->type != src0
+0007f040: 2d3e 6772 6164 2d3e 7479 7065 2920 7b0a  ->grad->type) {.
+0007f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f060: 2020 2020 2020 2020 2f2f 2067 7261 6469          // gradi
+0007f070: 656e 7420 6973 2074 7970 6963 616c 6c79  ent is typically
+0007f080: 2046 3332 2c20 6275 7420 7372 6330 2063   F32, but src0 c
+0007f090: 6f75 6c64 2062 6520 6f74 6865 7220 7479  ould be other ty
+0007f0a0: 7065 0a20 2020 2020 2020 2020 2020 2020  pe.             
+0007f0b0: 2020 2020 2020 2020 2020 2073 697a 655f             size_
+0007f0c0: 7420 6e67 203d 2067 676d 6c5f 656c 656d  t ng = ggml_elem
+0007f0d0: 656e 745f 7369 7a65 2873 7263 302d 3e67  ent_size(src0->g
+0007f0e0: 7261 6429 3b0a 2020 2020 2020 2020 2020  rad);.          
+0007f0f0: 2020 2020 2020 2020 2020 2020 2020 7369                si
+0007f100: 7a65 5f74 206e 3020 3d20 6767 6d6c 5f65  ze_t n0 = ggml_e
+0007f110: 6c65 6d65 6e74 5f73 697a 6528 7372 6330  lement_size(src0
+0007f120: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0007f130: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0007f140: 4153 5345 5254 286f 6666 7365 7420 2520  ASSERT(offset % 
+0007f150: 6e30 203d 3d20 3029 3b0a 2020 2020 2020  n0 == 0);.      
+0007f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f170: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0007f180: 3120 2520 6e30 203d 3d20 3029 3b0a 2020  1 % n0 == 0);.  
+0007f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f1a0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0007f1b0: 5428 6e62 3220 2520 6e30 203d 3d20 3029  T(nb2 % n0 == 0)
+0007f1c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007f1d0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0007f1e0: 5353 4552 5428 6e62 3320 2520 6e30 203d  SSERT(nb3 % n0 =
+0007f1f0: 3d20 3029 3b0a 2020 2020 2020 2020 2020  = 0);.          
+0007f200: 2020 2020 2020 2020 2020 2020 2020 6f66                of
+0007f210: 6673 6574 203d 2028 6f66 6673 6574 202f  fset = (offset /
+0007f220: 206e 3029 202a 206e 673b 0a20 2020 2020   n0) * ng;.     
+0007f230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f240: 2020 206e 6231 203d 2028 6e62 3120 2f20     nb1 = (nb1 / 
+0007f250: 6e30 2920 2a20 6e67 3b0a 2020 2020 2020  n0) * ng;.      
+0007f260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f270: 2020 6e62 3220 3d20 286e 6232 202f 206e    nb2 = (nb2 / n
+0007f280: 3029 202a 206e 673b 0a20 2020 2020 2020  0) * ng;.       
+0007f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f2a0: 206e 6233 203d 2028 6e62 3320 2f20 6e30   nb3 = (nb3 / n0
+0007f2b0: 2920 2a20 6e67 3b0a 2020 2020 2020 2020  ) * ng;.        
+0007f2c0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
 0007f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f2e0: 696e 7420 6178 6973 3120 3d20 6178 6573  int axis1 = axes
-0007f2f0: 5b31 5d20 2620 3078 333b 0a20 2020 2020  [1] & 0x3;.     
-0007f300: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007f310: 6e74 2061 7869 7332 203d 2061 7865 735b  nt axis2 = axes[
-0007f320: 325d 2026 2030 7833 3b0a 2020 2020 2020  2] & 0x3;.      
-0007f330: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0007f340: 7420 6178 6973 3320 3d20 6178 6573 5b33  t axis3 = axes[3
-0007f350: 5d20 2620 3078 333b 0a20 2020 2020 2020  ] & 0x3;.       
-0007f360: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-0007f370: 2061 7865 735f 6261 636b 7761 7264 5b34   axes_backward[4
-0007f380: 5d20 3d20 7b30 2c30 2c30 2c30 7d3b 0a20  ] = {0,0,0,0};. 
-0007f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f3a0: 2020 2061 7865 735f 6261 636b 7761 7264     axes_backward
-0007f3b0: 5b61 7869 7330 5d20 3d20 303b 0a20 2020  [axis0] = 0;.   
-0007f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f3d0: 2061 7865 735f 6261 636b 7761 7264 5b61   axes_backward[a
-0007f3e0: 7869 7331 5d20 3d20 313b 0a20 2020 2020  xis1] = 1;.     
-0007f3f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0007f400: 7865 735f 6261 636b 7761 7264 5b61 7869  xes_backward[axi
-0007f410: 7332 5d20 3d20 323b 0a20 2020 2020 2020  s2] = 2;.       
-0007f420: 2020 2020 2020 2020 2020 2020 2061 7865               axe
-0007f430: 735f 6261 636b 7761 7264 5b61 7869 7333  s_backward[axis3
-0007f440: 5d20 3d20 333b 0a20 2020 2020 2020 2020  ] = 3;.         
-0007f450: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-0007f460: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
-0007f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f480: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-0007f490: 782c 2073 7263 302d 3e67 7261 642c 0a20  x, src0->grad,. 
-0007f4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f4b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007f4c0: 7065 726d 7574 6528 6374 782c 0a20 2020  permute(ctx,.   
-0007f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f4e0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-0007f4f0: 736f 722d 3e67 7261 642c 0a20 2020 2020  sor->grad,.     
-0007f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f510: 2020 2020 2020 2020 2020 2061 7865 735f             axes_
-0007f520: 6261 636b 7761 7264 5b30 5d2c 0a20 2020  backward[0],.   
-0007f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f540: 2020 2020 2020 2020 2020 2020 2061 7865               axe
-0007f550: 735f 6261 636b 7761 7264 5b31 5d2c 0a20  s_backward[1],. 
-0007f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f570: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0007f580: 7865 735f 6261 636b 7761 7264 5b32 5d2c  xes_backward[2],
-0007f590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f2e0: 2020 2073 7263 302d 3e67 7261 6420 3d20     src0->grad = 
+0007f2f0: 6767 6d6c 5f61 6363 5f69 6d70 6c28 6374  ggml_acc_impl(ct
+0007f300: 782c 2073 7263 302d 3e67 7261 642c 2074  x, src0->grad, t
+0007f310: 656e 736f 722d 3e67 7261 642c 206e 6231  ensor->grad, nb1
+0007f320: 2c20 6e62 322c 206e 6233 2c20 6f66 6673  , nb2, nb3, offs
+0007f330: 6574 2c20 696e 706c 6163 6529 3b0a 2020  et, inplace);.  
+0007f340: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007f350: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0007f360: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007f370: 6520 4747 4d4c 5f4f 505f 5045 524d 5554  e GGML_OP_PERMUT
+0007f380: 453a 0a20 2020 2020 2020 2020 2020 207b  E:.            {
+0007f390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f3a0: 202f 2f20 6e65 6365 7373 6172 7920 666f   // necessary fo
+0007f3b0: 7220 6c6c 616d 610a 2020 2020 2020 2020  r llama.        
+0007f3c0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+0007f3d0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0007f3e0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0007f3f0: 7433 325f 7420 2a20 6178 6573 203d 2028  t32_t * axes = (
+0007f400: 696e 7433 325f 7420 2a29 2074 656e 736f  int32_t *) tenso
+0007f410: 722d 3e6f 7074 5b30 5d2d 3e64 6174 613b  r->opt[0]->data;
+0007f420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f430: 2020 2020 2069 6e74 2061 7869 7330 203d       int axis0 =
+0007f440: 2061 7865 735b 305d 2026 2030 7833 3b0a   axes[0] & 0x3;.
+0007f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f460: 2020 2020 696e 7420 6178 6973 3120 3d20      int axis1 = 
+0007f470: 6178 6573 5b31 5d20 2620 3078 333b 0a20  axes[1] & 0x3;. 
+0007f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f490: 2020 2069 6e74 2061 7869 7332 203d 2061     int axis2 = a
+0007f4a0: 7865 735b 325d 2026 2030 7833 3b0a 2020  xes[2] & 0x3;.  
+0007f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f4c0: 2020 696e 7420 6178 6973 3320 3d20 6178    int axis3 = ax
+0007f4d0: 6573 5b33 5d20 2620 3078 333b 0a20 2020  es[3] & 0x3;.   
+0007f4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f4f0: 2069 6e74 2061 7865 735f 6261 636b 7761   int axes_backwa
+0007f500: 7264 5b34 5d20 3d20 7b30 2c30 2c30 2c30  rd[4] = {0,0,0,0
+0007f510: 7d3b 0a20 2020 2020 2020 2020 2020 2020  };.             
+0007f520: 2020 2020 2020 2061 7865 735f 6261 636b         axes_back
+0007f530: 7761 7264 5b61 7869 7330 5d20 3d20 303b  ward[axis0] = 0;
+0007f540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f550: 2020 2020 2061 7865 735f 6261 636b 7761       axes_backwa
+0007f560: 7264 5b61 7869 7331 5d20 3d20 313b 0a20  rd[axis1] = 1;. 
+0007f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f580: 2020 2061 7865 735f 6261 636b 7761 7264     axes_backward
+0007f590: 5b61 7869 7332 5d20 3d20 323b 0a20 2020  [axis2] = 2;.   
 0007f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f5b0: 2061 7865 735f 6261 636b 7761 7264 5b33   axes_backward[3
-0007f5c0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0007f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f5e0: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-0007f5f0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0007f600: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0007f610: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0007f620: 4d4c 5f4f 505f 5452 414e 5350 4f53 453a  ML_OP_TRANSPOSE:
-0007f630: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0007f640: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0007f650: 2f20 6e65 6365 7373 6172 7920 666f 7220  / necessary for 
-0007f660: 6c6c 616d 610a 2020 2020 2020 2020 2020  llama.          
-0007f670: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0007f680: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0007f690: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0007f6a0: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
-0007f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f6c0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0007f6d0: 7478 2c20 7372 6330 2d3e 6772 6164 2c0a  tx, src0->grad,.
-0007f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f6f0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007f700: 5f74 7261 6e73 706f 7365 2863 7478 2c20  _transpose(ctx, 
-0007f710: 7465 6e73 6f72 2d3e 6772 6164 292c 0a20  tensor->grad),. 
+0007f5b0: 2061 7865 735f 6261 636b 7761 7264 5b61   axes_backward[a
+0007f5c0: 7869 7333 5d20 3d20 333b 0a20 2020 2020  xis3] = 3;.     
+0007f5d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007f5e0: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+0007f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f600: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+0007f610: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
+0007f620: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0007f630: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007f640: 676d 6c5f 7065 726d 7574 6528 6374 782c  gml_permute(ctx,
+0007f650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f670: 2074 656e 736f 722d 3e67 7261 642c 0a20   tensor->grad,. 
+0007f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f690: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0007f6a0: 7865 735f 6261 636b 7761 7264 5b30 5d2c  xes_backward[0],
+0007f6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f6d0: 2061 7865 735f 6261 636b 7761 7264 5b31   axes_backward[1
+0007f6e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0007f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f700: 2020 2061 7865 735f 6261 636b 7761 7264     axes_backward
+0007f710: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
 0007f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f730: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
-0007f740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007f750: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0007f760: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0007f770: 6361 7365 2047 474d 4c5f 4f50 5f47 4554  case GGML_OP_GET
-0007f780: 5f52 4f57 533a 0a20 2020 2020 2020 2020  _ROWS:.         
-0007f790: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0007f7a0: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
-0007f7b0: 7920 666f 7220 6c6c 616d 6120 286f 6e6c  y for llama (onl
-0007f7c0: 7920 666f 7220 746f 6b65 6e69 7a65 7229  y for tokenizer)
-0007f7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007f7e0: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-0007f7f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007f800: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-0007f810: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
-0007f820: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007f830: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
-0007f840: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
-0007f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f860: 2020 2020 2020 2067 676d 6c5f 6765 745f         ggml_get_
-0007f870: 726f 7773 5f62 6163 6b28 6374 782c 2074  rows_back(ctx, t
-0007f880: 656e 736f 722d 3e67 7261 642c 2073 7263  ensor->grad, src
-0007f890: 312c 2073 7263 302d 3e67 7261 6429 2c0a  1, src0->grad),.
-0007f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f8b0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-0007f8c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007f8d0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007f8e0: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
-0007f8f0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007f900: 2020 2020 2020 2020 2020 2f2f 206e 6f6f            // noo
-0007f910: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
-0007f920: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007f930: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007f940: 2063 6173 6520 4747 4d4c 5f4f 505f 4745   case GGML_OP_GE
-0007f950: 545f 524f 5753 5f42 4143 4b3a 0a20 2020  T_ROWS_BACK:.   
-0007f960: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0007f970: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0007f980: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
-0007f990: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
-0007f9a0: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
-0007f9b0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007f9c0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007f9d0: 505f 4449 4147 3a0a 2020 2020 2020 2020  P_DIAG:.        
-0007f9e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007f9f0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0007fa00: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
-0007fa10: 4f3a 206e 6f74 2069 6d70 6c65 6d65 6e74  O: not implement
-0007fa20: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
-0007fa30: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0007fa40: 6361 7365 2047 474d 4c5f 4f50 5f44 4941  case GGML_OP_DIA
-0007fa50: 475f 4d41 534b 5f49 4e46 3a0a 2020 2020  G_MASK_INF:.    
-0007fa60: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007fa70: 2020 2020 2020 2020 2020 2f2f 206e 6563            // nec
-0007fa80: 6573 7361 7279 2066 6f72 206c 6c61 6d61  essary for llama
-0007fa90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007faa0: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-0007fab0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007fac0: 2020 2020 2020 2061 7373 6572 7428 7372         assert(sr
-0007fad0: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
-0007fae0: 5f54 5950 455f 4933 3229 3b0a 2020 2020  _TYPE_I32);.    
-0007faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fb00: 6173 7365 7274 2867 676d 6c5f 6e65 6c65  assert(ggml_nele
-0007fb10: 6d65 6e74 7328 7372 6331 2920 3d3d 2032  ments(src1) == 2
-0007fb20: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007fb30: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0007fb40: 206e 5f70 6173 7420 3d20 2828 696e 7433   n_past = ((int3
-0007fb50: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
-0007fb60: 6129 5b30 5d3b 0a20 2020 2020 2020 2020  a)[0];.         
-0007fb70: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-0007fb80: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
-0007fb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fba0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-0007fbb0: 782c 2073 7263 302d 3e67 7261 642c 0a20  x, src0->grad,. 
-0007fbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fbd0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007fbe0: 6469 6167 5f6d 6173 6b5f 7a65 726f 5f69  diag_mask_zero_i
-0007fbf0: 6d70 6c28 6374 782c 2074 656e 736f 722d  mpl(ctx, tensor-
-0007fc00: 3e67 7261 642c 206e 5f70 6173 742c 2066  >grad, n_past, f
-0007fc10: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
-0007fc20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007fc30: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-0007fc40: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007fc50: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007fc60: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
+0007f730: 2020 2020 2061 7865 735f 6261 636b 7761       axes_backwa
+0007f740: 7264 5b33 5d29 2c0a 2020 2020 2020 2020  rd[3]),.        
+0007f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f760: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+0007f770: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007f780: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0007f790: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007f7a0: 6520 4747 4d4c 5f4f 505f 5452 414e 5350  e GGML_OP_TRANSP
+0007f7b0: 4f53 453a 0a20 2020 2020 2020 2020 2020  OSE:.           
+0007f7c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007f7d0: 2020 202f 2f20 6e65 6365 7373 6172 7920     // necessary 
+0007f7e0: 666f 7220 6c6c 616d 610a 2020 2020 2020  for llama.      
+0007f7f0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0007f800: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
+0007f810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f820: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
+0007f830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f840: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
+0007f850: 706c 2863 7478 2c20 7372 6330 2d3e 6772  pl(ctx, src0->gr
+0007f860: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0007f870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f880: 6767 6d6c 5f74 7261 6e73 706f 7365 2863  ggml_transpose(c
+0007f890: 7478 2c20 7465 6e73 6f72 2d3e 6772 6164  tx, tensor->grad
+0007f8a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0007f8b0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+0007f8c0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+0007f8d0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0007f8e0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007f8f0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007f900: 5f47 4554 5f52 4f57 533a 0a20 2020 2020  _GET_ROWS:.     
+0007f910: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0007f920: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
+0007f930: 7373 6172 7920 666f 7220 6c6c 616d 6120  ssary for llama 
+0007f940: 286f 6e6c 7920 666f 7220 746f 6b65 6e69  (only for tokeni
+0007f950: 7a65 7229 0a20 2020 2020 2020 2020 2020  zer).           
+0007f960: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+0007f970: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0007f980: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0007f990: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
+0007f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f9b0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+0007f9c0: 782c 2073 7263 302d 3e67 7261 642c 0a20  x, src0->grad,. 
+0007f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f9e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0007f9f0: 6765 745f 726f 7773 5f62 6163 6b28 6374  get_rows_back(ct
+0007fa00: 782c 2074 656e 736f 722d 3e67 7261 642c  x, tensor->grad,
+0007fa10: 2073 7263 312c 2073 7263 302d 3e67 7261   src1, src0->gra
+0007fa20: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+0007fa30: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+0007fa40: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0007fa50: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007fa60: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
+0007fa70: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0007fa80: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007fa90: 206e 6f6f 700a 2020 2020 2020 2020 2020   noop.          
+0007faa0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007fab0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007fac0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007fad0: 505f 4745 545f 524f 5753 5f42 4143 4b3a  P_GET_ROWS_BACK:
+0007fae0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0007faf0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0007fb00: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0007fb10: 293b 202f 2f20 544f 444f 3a20 6e6f 7420  ); // TODO: not 
+0007fb20: 696d 706c 656d 656e 7465 640a 2020 2020  implemented.    
+0007fb30: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0007fb40: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0007fb50: 4d4c 5f4f 505f 4449 4147 3a0a 2020 2020  ML_OP_DIAG:.    
+0007fb60: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007fb70: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0007fb80: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+0007fb90: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+0007fba0: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+0007fbb0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007fbc0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007fbd0: 5f44 4941 475f 4d41 534b 5f49 4e46 3a0a  _DIAG_MASK_INF:.
+0007fbe0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0007fbf0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007fc00: 206e 6563 6573 7361 7279 2066 6f72 206c   necessary for l
+0007fc10: 6c61 6d61 0a20 2020 2020 2020 2020 2020  lama.           
+0007fc20: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+0007fc30: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0007fc40: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0007fc50: 7428 7372 6331 2d3e 7479 7065 203d 3d20  t(src1->type == 
+0007fc60: 4747 4d4c 5f54 5950 455f 4933 3229 3b0a  GGML_TYPE_I32);.
 0007fc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fc80: 202f 2f20 6e6f 6f70 0a20 2020 2020 2020   // noop.       
-0007fc90: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007fca0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0007fcb0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007fcc0: 4c5f 4f50 5f44 4941 475f 4d41 534b 5f5a  L_OP_DIAG_MASK_Z
-0007fcd0: 4552 4f3a 0a20 2020 2020 2020 2020 2020  ERO:.           
-0007fce0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007fcf0: 2020 202f 2f20 6e65 6365 7373 6172 7920     // necessary 
-0007fd00: 666f 7220 6c6c 616d 610a 2020 2020 2020  for llama.      
-0007fd10: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-0007fd20: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-0007fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fd40: 6173 7365 7274 2873 7263 312d 3e74 7970  assert(src1->typ
-0007fd50: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
-0007fd60: 3332 293b 0a20 2020 2020 2020 2020 2020  32);.           
-0007fd70: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-0007fd80: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-0007fd90: 7263 3129 203d 3d20 3229 3b0a 2020 2020  rc1) == 2);.    
+0007fc80: 2020 2020 6173 7365 7274 2867 676d 6c5f      assert(ggml_
+0007fc90: 6e65 6c65 6d65 6e74 7328 7372 6331 2920  nelements(src1) 
+0007fca0: 3d3d 2032 293b 0a20 2020 2020 2020 2020  == 2);.         
+0007fcb0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0007fcc0: 2069 6e74 206e 5f70 6173 7420 3d20 2828   int n_past = ((
+0007fcd0: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
+0007fce0: 3e64 6174 6129 5b30 5d3b 0a20 2020 2020  >data)[0];.     
+0007fcf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007fd00: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+0007fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007fd20: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+0007fd30: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
+0007fd40: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0007fd50: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007fd60: 676d 6c5f 6469 6167 5f6d 6173 6b5f 7a65  gml_diag_mask_ze
+0007fd70: 726f 5f69 6d70 6c28 6374 782c 2074 656e  ro_impl(ctx, ten
+0007fd80: 736f 722d 3e67 7261 642c 206e 5f70 6173  sor->grad, n_pas
+0007fd90: 742c 2066 616c 7365 292c 0a20 2020 2020  t, false),.     
 0007fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fdb0: 636f 6e73 7420 696e 7420 6e5f 7061 7374  const int n_past
-0007fdc0: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
-0007fdd0: 7372 6331 2d3e 6461 7461 295b 305d 3b0a  src1->data)[0];.
-0007fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fdf0: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-0007fe00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007fe10: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
-0007fe20: 645f 696d 706c 2863 7478 2c20 7372 6330  d_impl(ctx, src0
-0007fe30: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-0007fe40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fe50: 2020 2020 6767 6d6c 5f64 6961 675f 6d61      ggml_diag_ma
-0007fe60: 736b 5f7a 6572 6f5f 696d 706c 2863 7478  sk_zero_impl(ctx
-0007fe70: 2c20 7465 6e73 6f72 2d3e 6772 6164 2c20  , tensor->grad, 
-0007fe80: 6e5f 7061 7374 2c20 6661 6c73 6529 2c0a  n_past, false),.
-0007fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fea0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-0007feb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007fec0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007fed0: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
-0007fee0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007fef0: 2020 2020 2020 2020 2020 2f2f 206e 6f6f            // noo
-0007ff00: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
-0007ff10: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007ff20: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007ff30: 2063 6173 6520 4747 4d4c 5f4f 505f 534f   case GGML_OP_SO
-0007ff40: 4654 5f4d 4158 3a0a 2020 2020 2020 2020  FT_MAX:.        
-0007ff50: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007ff60: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
-0007ff70: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
-0007ff80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0007ff90: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-0007ffa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ffb0: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
+0007fdb0: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
+0007fdc0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0007fdd0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007fde0: 6620 2873 7263 312d 3e67 7261 6429 207b  f (src1->grad) {
+0007fdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007fe00: 2020 2020 202f 2f20 6e6f 6f70 0a20 2020       // noop.   
+0007fe10: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0007fe20: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0007fe30: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0007fe40: 2047 474d 4c5f 4f50 5f44 4941 475f 4d41   GGML_OP_DIAG_MA
+0007fe50: 534b 5f5a 4552 4f3a 0a20 2020 2020 2020  SK_ZERO:.       
+0007fe60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007fe70: 2020 2020 2020 202f 2f20 6e65 6365 7373         // necess
+0007fe80: 6172 7920 666f 7220 6c6c 616d 610a 2020  ary for llama.  
+0007fe90: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0007fea0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
+0007feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007fec0: 2020 2020 6173 7365 7274 2873 7263 312d      assert(src1-
+0007fed0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+0007fee0: 5045 5f49 3332 293b 0a20 2020 2020 2020  PE_I32);.       
+0007fef0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0007ff00: 6572 7428 6767 6d6c 5f6e 656c 656d 656e  ert(ggml_nelemen
+0007ff10: 7473 2873 7263 3129 203d 3d20 3229 3b0a  ts(src1) == 2);.
+0007ff20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ff30: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
+0007ff40: 7061 7374 203d 2028 2869 6e74 3332 5f74  past = ((int32_t
+0007ff50: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
+0007ff60: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
+0007ff70: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007ff80: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+0007ff90: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007ffa0: 6c5f 6164 645f 696d 706c 2863 7478 2c20  l_add_impl(ctx, 
+0007ffb0: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
 0007ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ffd0: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
-0007ffe0: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
-0007fff0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-00080000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080010: 2020 2067 676d 6c5f 736f 6674 5f6d 6178     ggml_soft_max
-00080020: 5f62 6163 6b28 6374 782c 2074 656e 736f  _back(ctx, tenso
-00080030: 722d 3e67 7261 642c 2074 656e 736f 7229  r->grad, tensor)
-00080040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00080050: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-00080060: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00080070: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00080080: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00080090: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000800a0: 5f53 4f46 545f 4d41 585f 4241 434b 3a0a  _SOFT_MAX_BACK:.
-000800b0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000800c0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-000800d0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-000800e0: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
-000800f0: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
-00080100: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00080110: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00080120: 4c5f 4f50 5f52 4f50 453a 0a20 2020 2020  L_OP_ROPE:.     
-00080130: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00080140: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
-00080150: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
-00080160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080170: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-00080180: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00080190: 2020 2020 2020 6173 7365 7274 2873 7263        assert(src
-000801a0: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
-000801b0: 5459 5045 5f49 3332 293b 0a20 2020 2020  TYPE_I32);.     
-000801c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000801d0: 7373 6572 7428 6767 6d6c 5f6e 656c 656d  ssert(ggml_nelem
-000801e0: 656e 7473 2873 7263 3129 203d 3d20 3329  ents(src1) == 3)
-000801f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00080200: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00080210: 6e5f 7061 7374 203d 2028 2869 6e74 3332  n_past = ((int32
-00080220: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
-00080230: 295b 305d 3b0a 2020 2020 2020 2020 2020  )[0];.          
-00080240: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00080250: 696e 7420 6e5f 6469 6d73 203d 2028 2869  int n_dims = ((i
-00080260: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-00080270: 6461 7461 295b 315d 3b0a 2020 2020 2020  data)[1];.      
-00080280: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00080290: 6e73 7420 696e 7420 6d6f 6465 2020 203d  nst int mode   =
-000802a0: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-000802b0: 6331 2d3e 6461 7461 295b 325d 3b0a 2020  c1->data)[2];.  
-000802c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000802d0: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
-000802e0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-000802f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00080300: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00080310: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
-00080320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080330: 2020 2020 2020 6767 6d6c 5f72 6f70 655f        ggml_rope_
-00080340: 6261 636b 2863 7478 2c0a 2020 2020 2020  back(ctx,.      
-00080350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080360: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-00080370: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-00080380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080390: 2020 2020 2020 2020 6e5f 7061 7374 2c0a          n_past,.
-000803a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000803b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000803c0: 6e5f 6469 6d73 2c0a 2020 2020 2020 2020  n_dims,.        
-000803d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000803e0: 2020 2020 2020 2020 6d6f 6465 292c 0a20          mode),. 
-000803f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080400: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-00080410: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00080420: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00080430: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
-00080440: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00080450: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00080460: 6e6f 6f70 0a20 2020 2020 2020 2020 2020  noop.           
-00080470: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00080480: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00080490: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000804a0: 5f52 4f50 455f 4241 434b 3a0a 2020 2020  _ROPE_BACK:.    
-000804b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000804c0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-000804d0: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-000804e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000804f0: 6173 7365 7274 2873 7263 312d 3e74 7970  assert(src1->typ
-00080500: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
-00080510: 3332 293b 0a20 2020 2020 2020 2020 2020  32);.           
-00080520: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-00080530: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-00080540: 7263 3129 203d 3d20 3429 3b0a 2020 2020  rc1) == 4);.    
+0007ffd0: 2020 2020 2020 2020 6767 6d6c 5f64 6961          ggml_dia
+0007ffe0: 675f 6d61 736b 5f7a 6572 6f5f 696d 706c  g_mask_zero_impl
+0007fff0: 2863 7478 2c20 7465 6e73 6f72 2d3e 6772  (ctx, tensor->gr
+00080000: 6164 2c20 6e5f 7061 7374 2c20 6661 6c73  ad, n_past, fals
+00080010: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00080020: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+00080030: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+00080040: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00080050: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
+00080060: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00080070: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00080080: 206e 6f6f 700a 2020 2020 2020 2020 2020   noop.          
+00080090: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000800a0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000800b0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000800c0: 505f 534f 4654 5f4d 4158 3a0a 2020 2020  P_SOFT_MAX:.    
+000800d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000800e0: 2020 2020 2020 2020 2020 2f2f 206e 6563            // nec
+000800f0: 6573 7361 7279 2066 6f72 206c 6c61 6d61  essary for llama
+00080100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00080110: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+00080120: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00080130: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+00080140: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+00080150: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00080160: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
+00080170: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+00080180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080190: 2020 2020 2020 2067 676d 6c5f 736f 6674         ggml_soft
+000801a0: 5f6d 6178 5f62 6163 6b28 6374 782c 2074  _max_back(ctx, t
+000801b0: 656e 736f 722d 3e67 7261 642c 2074 656e  ensor->grad, ten
+000801c0: 736f 7229 2c0a 2020 2020 2020 2020 2020  sor),.          
+000801d0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000801e0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+000801f0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00080200: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00080210: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00080220: 4c5f 4f50 5f53 4f46 545f 4d41 585f 4241  L_OP_SOFT_MAX_BA
+00080230: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+00080240: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00080250: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+00080260: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
+00080270: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
+00080280: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00080290: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+000802a0: 2047 474d 4c5f 4f50 5f52 4f50 453a 0a20   GGML_OP_ROPE:. 
+000802b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000802c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+000802d0: 6e65 6365 7373 6172 7920 666f 7220 6c6c  necessary for ll
+000802e0: 616d 610a 2020 2020 2020 2020 2020 2020  ama.            
+000802f0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
+00080300: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00080310: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00080320: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+00080330: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
+00080340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080350: 2020 2061 7373 6572 7428 6767 6d6c 5f6e     assert(ggml_n
+00080360: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
+00080370: 3d20 3329 3b0a 2020 2020 2020 2020 2020  = 3);.          
+00080380: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00080390: 696e 7420 6e5f 7061 7374 203d 2028 2869  int n_past = ((i
+000803a0: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
+000803b0: 6461 7461 295b 305d 3b0a 2020 2020 2020  data)[0];.      
+000803c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000803d0: 6e73 7420 696e 7420 6e5f 6469 6d73 203d  nst int n_dims =
+000803e0: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
+000803f0: 6331 2d3e 6461 7461 295b 315d 3b0a 2020  c1->data)[1];.  
+00080400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080410: 2020 636f 6e73 7420 696e 7420 6d6f 6465    const int mode
+00080420: 2020 203d 2028 2869 6e74 3332 5f74 202a     = ((int32_t *
+00080430: 2920 7372 6331 2d3e 6461 7461 295b 325d  ) src1->data)[2]
+00080440: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00080450: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+00080460: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
+00080470: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+00080480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080490: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
+000804a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000804b0: 2020 2020 2020 2020 2020 6767 6d6c 5f72            ggml_r
+000804c0: 6f70 655f 6261 636b 2863 7478 2c0a 2020  ope_back(ctx,.  
+000804d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000804e0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+000804f0: 6e73 6f72 2d3e 6772 6164 2c0a 2020 2020  nsor->grad,.    
+00080500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080510: 2020 2020 2020 2020 2020 2020 6e5f 7061              n_pa
+00080520: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+00080530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080540: 2020 2020 6e5f 6469 6d73 2c0a 2020 2020      n_dims,.    
 00080550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080560: 636f 6e73 7420 696e 7420 6e5f 7061 7374  const int n_past
-00080570: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
-00080580: 7372 6331 2d3e 6461 7461 295b 305d 3b0a  src1->data)[0];.
-00080590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000805a0: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-000805b0: 6469 6d73 203d 2028 2869 6e74 3332 5f74  dims = ((int32_t
-000805c0: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-000805d0: 315d 3b0a 2020 2020 2020 2020 2020 2020  1];.            
-000805e0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000805f0: 7420 6d6f 6465 2020 203d 2028 2869 6e74  t mode   = ((int
-00080600: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
-00080610: 7461 295b 325d 3b0a 2020 2020 2020 2020  ta)[2];.        
-00080620: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00080630: 7420 696e 7420 6e5f 6374 7820 203d 2028  t int n_ctx  = (
-00080640: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-00080650: 2d3e 6461 7461 295b 335d 3b0a 2020 2020  ->data)[3];.    
+00080560: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00080570: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00080580: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00080590: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+000805a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000805b0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+000805c0: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
+000805d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000805e0: 202f 2f20 6e6f 6f70 0a20 2020 2020 2020   // noop.       
+000805f0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00080600: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00080610: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00080620: 4c5f 4f50 5f52 4f50 455f 4241 434b 3a0a  L_OP_ROPE_BACK:.
+00080630: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00080640: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00080650: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
 00080660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080670: 7372 6330 2d3e 6772 6164 203d 2067 676d  src0->grad = ggm
-00080680: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
-00080690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000806a0: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-000806b0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-000806c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000806d0: 2020 2020 6767 6d6c 5f72 6f70 6528 6374      ggml_rope(ct
-000806e0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-000806f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080700: 2020 2074 656e 736f 722d 3e67 7261 642c     tensor->grad,
-00080710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00080720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080730: 206e 5f70 6173 742c 0a20 2020 2020 2020   n_past,.       
-00080740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080750: 2020 2020 2020 2020 206e 5f64 696d 732c           n_dims,
-00080760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00080770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080780: 206d 6f64 652c 0a20 2020 2020 2020 2020   mode,.         
-00080790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000807a0: 2020 2020 2020 206e 5f63 7478 292c 0a20         n_ctx),. 
-000807b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000807c0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-000807d0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-000807e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000807f0: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
-00080800: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00080810: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00080820: 6e6f 6f70 0a20 2020 2020 2020 2020 2020  noop.           
-00080830: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00080840: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00080850: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00080860: 5f43 4f4e 565f 3144 5f53 315f 5048 3a0a  _CONV_1D_S1_PH:.
-00080870: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00080880: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00080890: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-000808a0: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
-000808b0: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
-000808c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-000808d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000808e0: 4c5f 4f50 5f43 4f4e 565f 3144 5f53 325f  L_OP_CONV_1D_S2_
-000808f0: 5048 3a0a 2020 2020 2020 2020 2020 2020  PH:.            
-00080900: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00080910: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00080920: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
-00080930: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
-00080940: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00080950: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00080960: 2047 474d 4c5f 4f50 5f43 4f4e 565f 3244   GGML_OP_CONV_2D
-00080970: 5f53 4b5f 5030 3a0a 2020 2020 2020 2020  _SK_P0:.        
-00080980: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00080990: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-000809a0: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
-000809b0: 4f3a 206e 6f74 2069 6d70 6c65 6d65 6e74  O: not implement
-000809c0: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
-000809d0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000809e0: 6361 7365 2047 474d 4c5f 4f50 5f46 4c41  case GGML_OP_FLA
-000809f0: 5348 5f41 5454 4e3a 0a20 2020 2020 2020  SH_ATTN:.       
-00080a00: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00080a10: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00080a20: 6d6c 5f74 656e 736f 7220 2a20 666c 6173  ml_tensor * flas
-00080a30: 685f 6772 6164 203d 204e 554c 4c3b 0a20  h_grad = NULL;. 
-00080a40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00080a50: 6620 2873 7263 302d 3e67 7261 6420 7c7c  f (src0->grad ||
-00080a60: 2073 7263 312d 3e67 7261 6420 7c7c 2074   src1->grad || t
-00080a70: 656e 736f 722d 3e6f 7074 5b30 5d2d 3e67  ensor->opt[0]->g
-00080a80: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-00080a90: 2020 2020 2020 2020 2020 2069 6e74 3332             int32
-00080aa0: 5f74 2074 203d 2067 676d 6c5f 6765 745f  _t t = ggml_get_
-00080ab0: 6933 325f 3164 2874 656e 736f 722d 3e6f  i32_1d(tensor->o
-00080ac0: 7074 5b31 5d2c 2030 293b 0a20 2020 2020  pt[1], 0);.     
-00080ad0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00080ae0: 474d 4c5f 4153 5345 5254 2874 203d 3d20  GML_ASSERT(t == 
-00080af0: 3020 7c7c 2074 203d 3d20 3129 3b0a 2020  0 || t == 1);.  
-00080b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080b10: 2020 626f 6f6c 206d 6173 6b65 6420 3d20    bool masked = 
-00080b20: 7420 213d 2030 3b0a 2020 2020 2020 2020  t != 0;.        
-00080b30: 2020 2020 2020 2020 2020 2020 666c 6173              flas
-00080b40: 685f 6772 6164 203d 0a20 2020 2020 2020  h_grad =.       
-00080b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080b60: 2067 676d 6c5f 666c 6173 685f 6174 746e   ggml_flash_attn
-00080b70: 5f62 6163 6b28 6374 782c 0a20 2020 2020  _back(ctx,.     
-00080b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080b90: 2020 2020 2020 2073 7263 302c 0a20 2020         src0,.   
-00080ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080bb0: 2020 2020 2020 2020 2073 7263 312c 0a20           src1,. 
-00080bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080bd0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-00080be0: 722d 3e6f 7074 5b30 5d2c 0a20 2020 2020  r->opt[0],.     
-00080bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080c00: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
-00080c10: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00080c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080c30: 206d 6173 6b65 6429 3b0a 2020 2020 2020   masked);.      
-00080c40: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00080c50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00080c60: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-00080c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080c80: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00080c90: 656e 736f 7220 2a20 6772 6164 5f71 203d  ensor * grad_q =
-00080ca0: 204e 554c 4c3b 0a20 2020 2020 2020 2020   NULL;.         
-00080cb0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00080cc0: 2073 697a 655f 7420 6e62 3020 2020 203d   size_t nb0    =
-00080cd0: 2066 6c61 7368 5f67 7261 642d 3e6e 625b   flash_grad->nb[
-00080ce0: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
-00080cf0: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
-00080d00: 7a65 5f74 206f 6666 7365 7420 3d20 303b  ze_t offset = 0;
-00080d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00080d20: 2020 2020 2073 7769 7463 6828 7372 6330       switch(src0
-00080d30: 2d3e 6e5f 6469 6d73 2920 7b0a 2020 2020  ->n_dims) {.    
-00080d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080d50: 2020 2020 6361 7365 2032 3a0a 2020 2020      case 2:.    
-00080d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080d70: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00080d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080d90: 2020 2020 2020 2020 2020 6772 6164 5f71            grad_q
-00080da0: 203d 2067 676d 6c5f 7669 6577 5f32 6428   = ggml_view_2d(
-00080db0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00080dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080dd0: 2020 2020 2020 2020 2066 6c61 7368 5f67           flash_g
-00080de0: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00080df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080e00: 2020 2020 2020 2020 2073 7263 302d 3e6e           src0->n
-00080e10: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
-00080e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080e30: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00080e40: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
-00080e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080e60: 2020 2020 2020 2020 2020 206e 6230 2a73             nb0*s
-00080e70: 7263 302d 3e6e 655b 305d 2c0a 2020 2020  rc0->ne[0],.    
-00080e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080ea0: 6f66 6673 6574 293b 0a20 2020 2020 2020  offset);.       
-00080eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080ec0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00080ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080ee0: 2020 2020 2020 6361 7365 2033 3a0a 2020        case 3:.  
-00080ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080f00: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00080f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080f20: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-00080f30: 5f71 203d 2067 676d 6c5f 7669 6577 5f33  _q = ggml_view_3
-00080f40: 6428 6374 782c 0a20 2020 2020 2020 2020  d(ctx,.         
-00080f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080f60: 2020 2020 2020 2020 2020 2066 6c61 7368             flash
-00080f70: 5f67 7261 642c 0a20 2020 2020 2020 2020  _grad,.         
-00080f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080f90: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-00080fa0: 3e6e 655b 305d 2c0a 2020 2020 2020 2020  >ne[0],.        
-00080fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080fc0: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-00080fd0: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
-00080fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080ff0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00081000: 302d 3e6e 655b 325d 2c0a 2020 2020 2020  0->ne[2],.      
+00080670: 2020 2020 6173 7365 7274 2873 7263 312d      assert(src1-
+00080680: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00080690: 5045 5f49 3332 293b 0a20 2020 2020 2020  PE_I32);.       
+000806a0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+000806b0: 6572 7428 6767 6d6c 5f6e 656c 656d 656e  ert(ggml_nelemen
+000806c0: 7473 2873 7263 3129 203d 3d20 3429 3b0a  ts(src1) == 4);.
+000806d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000806e0: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
+000806f0: 7061 7374 203d 2028 2869 6e74 3332 5f74  past = ((int32_t
+00080700: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
+00080710: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
+00080720: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00080730: 7420 6e5f 6469 6d73 203d 2028 2869 6e74  t n_dims = ((int
+00080740: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
+00080750: 7461 295b 315d 3b0a 2020 2020 2020 2020  ta)[1];.        
+00080760: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00080770: 7420 696e 7420 6d6f 6465 2020 203d 2028  t int mode   = (
+00080780: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
+00080790: 2d3e 6461 7461 295b 325d 3b0a 2020 2020  ->data)[2];.    
+000807a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000807b0: 636f 6e73 7420 696e 7420 6e5f 6374 7820  const int n_ctx 
+000807c0: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
+000807d0: 7372 6331 2d3e 6461 7461 295b 335d 3b0a  src1->data)[3];.
+000807e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000807f0: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+00080800: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+00080810: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+00080820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080830: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
+00080840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080850: 2020 2020 2020 2020 6767 6d6c 5f72 6f70          ggml_rop
+00080860: 6528 6374 782c 0a20 2020 2020 2020 2020  e(ctx,.         
+00080870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080880: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
+00080890: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+000808a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000808b0: 2020 2020 206e 5f70 6173 742c 0a20 2020       n_past,.   
+000808c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000808d0: 2020 2020 2020 2020 2020 2020 206e 5f64               n_d
+000808e0: 696d 732c 0a20 2020 2020 2020 2020 2020  ims,.           
+000808f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080900: 2020 2020 206d 6f64 652c 0a20 2020 2020       mode,.     
+00080910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080920: 2020 2020 2020 2020 2020 206e 5f63 7478             n_ctx
+00080930: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00080940: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00080950: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+00080960: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00080970: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+00080980: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
+00080990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000809a0: 202f 2f20 6e6f 6f70 0a20 2020 2020 2020   // noop.       
+000809b0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000809c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000809d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000809e0: 4c5f 4f50 5f43 4f4e 565f 3144 5f53 315f  L_OP_CONV_1D_S1_
+000809f0: 5048 3a0a 2020 2020 2020 2020 2020 2020  PH:.            
+00080a00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00080a10: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+00080a20: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
+00080a30: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
+00080a40: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00080a50: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00080a60: 2047 474d 4c5f 4f50 5f43 4f4e 565f 3144   GGML_OP_CONV_1D
+00080a70: 5f53 325f 5048 3a0a 2020 2020 2020 2020  _S2_PH:.        
+00080a80: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00080a90: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00080aa0: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
+00080ab0: 4f3a 206e 6f74 2069 6d70 6c65 6d65 6e74  O: not implement
+00080ac0: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
+00080ad0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00080ae0: 6361 7365 2047 474d 4c5f 4f50 5f43 4f4e  case GGML_OP_CON
+00080af0: 565f 3244 5f53 4b5f 5030 3a0a 2020 2020  V_2D_SK_P0:.    
+00080b00: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00080b10: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00080b20: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+00080b30: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+00080b40: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+00080b50: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00080b60: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00080b70: 5f46 4c41 5348 5f41 5454 4e3a 0a20 2020  _FLASH_ATTN:.   
+00080b80: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00080b90: 2020 2020 2020 2020 2020 2073 7472 7563             struc
+00080ba0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00080bb0: 666c 6173 685f 6772 6164 203d 204e 554c  flash_grad = NUL
+00080bc0: 4c3b 0a20 2020 2020 2020 2020 2020 2020  L;.             
+00080bd0: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+00080be0: 6420 7c7c 2073 7263 312d 3e67 7261 6420  d || src1->grad 
+00080bf0: 7c7c 2074 656e 736f 722d 3e6f 7074 5b30  || tensor->opt[0
+00080c00: 5d2d 3e67 7261 6429 207b 0a20 2020 2020  ]->grad) {.     
+00080c10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00080c20: 6e74 3332 5f74 2074 203d 2067 676d 6c5f  nt32_t t = ggml_
+00080c30: 6765 745f 6933 325f 3164 2874 656e 736f  get_i32_1d(tenso
+00080c40: 722d 3e6f 7074 5b31 5d2c 2030 293b 0a20  r->opt[1], 0);. 
+00080c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080c60: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
+00080c70: 203d 3d20 3020 7c7c 2074 203d 3d20 3129   == 0 || t == 1)
+00080c80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00080c90: 2020 2020 2020 626f 6f6c 206d 6173 6b65        bool maske
+00080ca0: 6420 3d20 7420 213d 2030 3b0a 2020 2020  d = t != 0;.    
+00080cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080cc0: 666c 6173 685f 6772 6164 203d 0a20 2020  flash_grad =.   
+00080cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080ce0: 2020 2020 2067 676d 6c5f 666c 6173 685f       ggml_flash_
+00080cf0: 6174 746e 5f62 6163 6b28 6374 782c 0a20  attn_back(ctx,. 
+00080d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080d10: 2020 2020 2020 2020 2020 2073 7263 302c             src0,
+00080d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00080d30: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00080d40: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+00080d50: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00080d60: 656e 736f 722d 3e6f 7074 5b30 5d2c 0a20  ensor->opt[0],. 
+00080d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080d80: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+00080d90: 722d 3e67 7261 642c 0a20 2020 2020 2020  r->grad,.       
+00080da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080db0: 2020 2020 206d 6173 6b65 6429 3b0a 2020       masked);.  
+00080dc0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00080dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00080de0: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+00080df0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00080e00: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00080e10: 6d6c 5f74 656e 736f 7220 2a20 6772 6164  ml_tensor * grad
+00080e20: 5f71 203d 204e 554c 4c3b 0a20 2020 2020  _q = NULL;.     
+00080e30: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00080e40: 6f6e 7374 2073 697a 655f 7420 6e62 3020  onst size_t nb0 
+00080e50: 2020 203d 2066 6c61 7368 5f67 7261 642d     = flash_grad-
+00080e60: 3e6e 625b 305d 3b0a 2020 2020 2020 2020  >nb[0];.        
+00080e70: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00080e80: 7420 7369 7a65 5f74 206f 6666 7365 7420  t size_t offset 
+00080e90: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+00080ea0: 2020 2020 2020 2020 2073 7769 7463 6828           switch(
+00080eb0: 7372 6330 2d3e 6e5f 6469 6d73 2920 7b0a  src0->n_dims) {.
+00080ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080ed0: 2020 2020 2020 2020 6361 7365 2032 3a0a          case 2:.
+00080ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080ef0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00080f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080f10: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+00080f20: 6164 5f71 203d 2067 676d 6c5f 7669 6577  ad_q = ggml_view
+00080f30: 5f32 6428 6374 782c 0a20 2020 2020 2020  _2d(ctx,.       
+00080f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080f50: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
+00080f60: 7368 5f67 7261 642c 0a20 2020 2020 2020  sh_grad,.       
+00080f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080f80: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00080f90: 302d 3e6e 655b 305d 2c0a 2020 2020 2020  0->ne[0],.      
+00080fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080fb0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00080fc0: 6330 2d3e 6e65 5b31 5d2c 0a20 2020 2020  c0->ne[1],.     
+00080fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080fe0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00080ff0: 6230 2a73 7263 302d 3e6e 655b 305d 2c0a  b0*src0->ne[0],.
+00081000: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00081010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081020: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-00081030: 302a 7372 6330 2d3e 6e65 5b30 5d2c 0a20  0*src0->ne[0],. 
-00081040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081060: 2020 206e 6230 2a73 7263 302d 3e6e 655b     nb0*src0->ne[
-00081070: 305d 2a73 7263 302d 3e6e 655b 315d 2c0a  0]*src0->ne[1],.
-00081080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081020: 2020 2020 6f66 6673 6574 293b 0a20 2020      offset);.   
+00081030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081040: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00081050: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00081060: 2020 2020 2020 2020 2020 6361 7365 2033            case 3
+00081070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00081080: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 00081090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000810a0: 2020 2020 6f66 6673 6574 293b 0a20 2020      offset);.   
-000810b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000810c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000810d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000810e0: 2020 2020 2020 2020 2020 6361 7365 2034            case 4
-000810f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00081100: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00081110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081130: 6772 6164 5f71 203d 2067 676d 6c5f 7669  grad_q = ggml_vi
-00081140: 6577 5f34 6428 6374 782c 0a20 2020 2020  ew_4d(ctx,.     
-00081150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081160: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00081170: 6c61 7368 5f67 7261 642c 0a20 2020 2020  lash_grad,.     
-00081180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081190: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000811a0: 7263 302d 3e6e 655b 305d 2c0a 2020 2020  rc0->ne[0],.    
-000811b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000811c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000811d0: 7372 6330 2d3e 6e65 5b31 5d2c 0a20 2020  src0->ne[1],.   
-000811e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000811f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081200: 2073 7263 302d 3e6e 655b 325d 2c0a 2020   src0->ne[2],.  
+000810a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000810b0: 6772 6164 5f71 203d 2067 676d 6c5f 7669  grad_q = ggml_vi
+000810c0: 6577 5f33 6428 6374 782c 0a20 2020 2020  ew_3d(ctx,.     
+000810d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000810e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000810f0: 6c61 7368 5f67 7261 642c 0a20 2020 2020  lash_grad,.     
+00081100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081110: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00081120: 7263 302d 3e6e 655b 305d 2c0a 2020 2020  rc0->ne[0],.    
+00081130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081150: 7372 6330 2d3e 6e65 5b31 5d2c 0a20 2020  src0->ne[1],.   
+00081160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081180: 2073 7263 302d 3e6e 655b 325d 2c0a 2020   src0->ne[2],.  
+00081190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000811a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000811b0: 2020 6e62 302a 7372 6330 2d3e 6e65 5b30    nb0*src0->ne[0
+000811c0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000811d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000811e0: 2020 2020 2020 206e 6230 2a73 7263 302d         nb0*src0-
+000811f0: 3e6e 655b 305d 2a73 7263 302d 3e6e 655b  >ne[0]*src0->ne[
+00081200: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
 00081210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081230: 2020 7372 6330 2d3e 6e65 5b33 5d2c 0a20    src0->ne[3],. 
-00081240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081260: 2020 206e 6230 2a73 7263 302d 3e6e 655b     nb0*src0->ne[
-00081270: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00081220: 2020 2020 2020 2020 6f66 6673 6574 293b          offset);
+00081230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081240: 2020 2020 2020 2020 2020 2020 207d 2062               } b
+00081250: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
+00081260: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00081270: 7365 2034 3a0a 2020 2020 2020 2020 2020  se 4:.          
 00081280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081290: 2020 2020 2020 2020 6e62 302a 7372 6330          nb0*src0
-000812a0: 2d3e 6e65 5b30 5d2a 7372 6330 2d3e 6e65  ->ne[0]*src0->ne
-000812b0: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
-000812c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000812d0: 2020 2020 2020 2020 206e 6230 2a73 7263           nb0*src
-000812e0: 302d 3e6e 655b 305d 2a73 7263 302d 3e6e  0->ne[0]*src0->n
-000812f0: 655b 315d 2a73 7263 302d 3e6e 655b 325d  e[1]*src0->ne[2]
-00081300: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00081290: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000812a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000812b0: 2020 2020 6772 6164 5f71 203d 2067 676d      grad_q = ggm
+000812c0: 6c5f 7669 6577 5f34 6428 6374 782c 0a20  l_view_4d(ctx,. 
+000812d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000812e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000812f0: 2020 2066 6c61 7368 5f67 7261 642c 0a20     flash_grad,. 
+00081300: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00081310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081320: 2020 2020 2020 6f66 6673 6574 293b 0a20        offset);. 
+00081320: 2020 2073 7263 302d 3e6e 655b 305d 2c0a     src0->ne[0],.
 00081330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081340: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00081350: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
-00081360: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00081370: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00081380: 7263 302d 3e67 7261 6420 3d20 6767 6d6c  rc0->grad = ggml
-00081390: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
+00081340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081350: 2020 2020 7372 6330 2d3e 6e65 5b31 5d2c      src0->ne[1],
+00081360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081380: 2020 2020 2073 7263 302d 3e6e 655b 325d       src0->ne[2]
+00081390: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 000813a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000813b0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-000813c0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+000813b0: 2020 2020 2020 7372 6330 2d3e 6e65 5b33        src0->ne[3
+000813c0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
 000813d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000813e0: 2020 2067 7261 645f 712c 0a20 2020 2020     grad_q,.     
-000813f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081400: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
-00081410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00081420: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-00081430: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
-00081440: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-00081450: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00081460: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00081470: 7261 645f 6b20 3d20 4e55 4c4c 3b0a 2020  rad_k = NULL;.  
-00081480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081490: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-000814a0: 6230 2020 2020 3d20 666c 6173 685f 6772  b0    = flash_gr
-000814b0: 6164 2d3e 6e62 5b30 5d3b 0a20 2020 2020  ad->nb[0];.     
-000814c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000814d0: 6f6e 7374 2073 697a 655f 7420 6f66 6673  onst size_t offs
-000814e0: 6574 203d 206e 6230 2a73 7263 302d 3e6e  et = nb0*src0->n
-000814f0: 655b 305d 2a73 7263 302d 3e6e 655b 315d  e[0]*src0->ne[1]
-00081500: 2a73 7263 302d 3e6e 655b 325d 2a73 7263  *src0->ne[2]*src
-00081510: 302d 3e6e 655b 335d 3b0a 2020 2020 2020  0->ne[3];.      
-00081520: 2020 2020 2020 2020 2020 2020 2020 7377                sw
-00081530: 6974 6368 2873 7263 312d 3e6e 5f64 696d  itch(src1->n_dim
-00081540: 7329 207b 0a20 2020 2020 2020 2020 2020  s) {.           
-00081550: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00081560: 6520 323a 0a20 2020 2020 2020 2020 2020  e 2:.           
+000813e0: 2020 2020 2020 206e 6230 2a73 7263 302d         nb0*src0-
+000813f0: 3e6e 655b 305d 2c0a 2020 2020 2020 2020  >ne[0],.        
+00081400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081410: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
+00081420: 7372 6330 2d3e 6e65 5b30 5d2a 7372 6330  src0->ne[0]*src0
+00081430: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
+00081440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081450: 2020 2020 2020 2020 2020 2020 206e 6230               nb0
+00081460: 2a73 7263 302d 3e6e 655b 305d 2a73 7263  *src0->ne[0]*src
+00081470: 302d 3e6e 655b 315d 2a73 7263 302d 3e6e  0->ne[1]*src0->n
+00081480: 655b 325d 2c0a 2020 2020 2020 2020 2020  e[2],.          
+00081490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000814a0: 2020 2020 2020 2020 2020 6f66 6673 6574            offset
+000814b0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+000814c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000814d0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000814e0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+000814f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081500: 2020 2073 7263 302d 3e67 7261 6420 3d20     src0->grad = 
+00081510: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+00081520: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00081530: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00081540: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+00081550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081560: 2020 2020 2020 2067 7261 645f 712c 0a20         grad_q,. 
 00081570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081580: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00081590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000815a0: 2020 2067 7261 645f 6b20 3d20 6767 6d6c     grad_k = ggml
-000815b0: 5f76 6965 775f 3264 2863 7478 2c0a 2020  _view_2d(ctx,.  
-000815c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000815d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000815e0: 2020 666c 6173 685f 6772 6164 2c0a 2020    flash_grad,.  
-000815f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081610: 2020 7372 6331 2d3e 6e65 5b30 5d2c 0a20    src1->ne[0],. 
-00081620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081640: 2020 2073 7263 312d 3e6e 655b 315d 2c0a     src1->ne[1],.
-00081650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081670: 2020 2020 6e62 302a 7372 6331 2d3e 6e65      nb0*src1->ne
-00081680: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-00081690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000816a0: 2020 2020 2020 2020 206f 6666 7365 7429           offset)
-000816b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000816c0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-000816d0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-000816e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000816f0: 6173 6520 333a 0a20 2020 2020 2020 2020  ase 3:.         
-00081700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081710: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00081720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081730: 2020 2020 2067 7261 645f 6b20 3d20 6767       grad_k = gg
-00081740: 6d6c 5f76 6965 775f 3364 2863 7478 2c0a  ml_view_3d(ctx,.
+00081580: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+00081590: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+000815a0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000815b0: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
+000815c0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+000815d0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000815e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000815f0: 202a 2067 7261 645f 6b20 3d20 4e55 4c4c   * grad_k = NULL
+00081600: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00081610: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
+00081620: 5f74 206e 6230 2020 2020 3d20 666c 6173  _t nb0    = flas
+00081630: 685f 6772 6164 2d3e 6e62 5b30 5d3b 0a20  h_grad->nb[0];. 
+00081640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081650: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+00081660: 6f66 6673 6574 203d 206e 6230 2a73 7263  offset = nb0*src
+00081670: 302d 3e6e 655b 305d 2a73 7263 302d 3e6e  0->ne[0]*src0->n
+00081680: 655b 315d 2a73 7263 302d 3e6e 655b 325d  e[1]*src0->ne[2]
+00081690: 2a73 7263 302d 3e6e 655b 335d 3b0a 2020  *src0->ne[3];.  
+000816a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000816b0: 2020 7377 6974 6368 2873 7263 312d 3e6e    switch(src1->n
+000816c0: 5f64 696d 7329 207b 0a20 2020 2020 2020  _dims) {.       
+000816d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000816e0: 2063 6173 6520 323a 0a20 2020 2020 2020   case 2:.       
+000816f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081700: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00081710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081720: 2020 2020 2020 2067 7261 645f 6b20 3d20         grad_k = 
+00081730: 6767 6d6c 5f76 6965 775f 3264 2863 7478  ggml_view_2d(ctx
+00081740: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00081750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081770: 2020 2020 666c 6173 685f 6772 6164 2c0a      flash_grad,.
+00081760: 2020 2020 2020 666c 6173 685f 6772 6164        flash_grad
+00081770: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00081780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000817a0: 2020 2020 7372 6331 2d3e 6e65 5b30 5d2c      src1->ne[0],
-000817b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000817c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000817d0: 2020 2020 2073 7263 312d 3e6e 655b 315d       src1->ne[1]
-000817e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000817f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081800: 2020 2020 2020 7372 6331 2d3e 6e65 5b32        src1->ne[2
-00081810: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00081820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081830: 2020 2020 2020 206e 6230 2a73 7263 312d         nb0*src1-
-00081840: 3e6e 655b 305d 2c0a 2020 2020 2020 2020  >ne[0],.        
-00081850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081860: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
-00081870: 7372 6331 2d3e 6e65 5b30 5d2a 7372 6331  src1->ne[0]*src1
-00081880: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
-00081890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000818a0: 2020 2020 2020 2020 2020 2020 206f 6666               off
-000818b0: 7365 7429 3b0a 2020 2020 2020 2020 2020  set);.          
-000818c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000818d0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00081790: 2020 2020 2020 7372 6331 2d3e 6e65 5b30        src1->ne[0
+000817a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000817b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000817c0: 2020 2020 2020 2073 7263 312d 3e6e 655b         src1->ne[
+000817d0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+000817e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000817f0: 2020 2020 2020 2020 6e62 302a 7372 6331          nb0*src1
+00081800: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
+00081810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081820: 2020 2020 2020 2020 2020 2020 206f 6666               off
+00081830: 7365 7429 3b0a 2020 2020 2020 2020 2020  set);.          
+00081840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081850: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00081860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081870: 2020 2063 6173 6520 333a 0a20 2020 2020     case 3:.     
+00081880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081890: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000818a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000818b0: 2020 2020 2020 2020 2067 7261 645f 6b20           grad_k 
+000818c0: 3d20 6767 6d6c 5f76 6965 775f 3364 2863  = ggml_view_3d(c
+000818d0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
 000818e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000818f0: 2020 2063 6173 6520 343a 0a20 2020 2020     case 4:.     
-00081900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081910: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00081920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081930: 2020 2020 2020 2020 2067 7261 645f 6b20           grad_k 
-00081940: 3d20 6767 6d6c 5f76 6965 775f 3464 2863  = ggml_view_4d(c
-00081950: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-00081960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081970: 2020 2020 2020 2020 666c 6173 685f 6772          flash_gr
-00081980: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-00081990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000819a0: 2020 2020 2020 2020 7372 6331 2d3e 6e65          src1->ne
-000819b0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-000819c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000819d0: 2020 2020 2020 2020 2073 7263 312d 3e6e           src1->n
-000819e0: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
-000819f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081a00: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-00081a10: 6e65 5b32 5d2c 0a20 2020 2020 2020 2020  ne[2],.         
+000818f0: 2020 2020 2020 2020 666c 6173 685f 6772          flash_gr
+00081900: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+00081910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081920: 2020 2020 2020 2020 7372 6331 2d3e 6e65          src1->ne
+00081930: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+00081940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081950: 2020 2020 2020 2020 2073 7263 312d 3e6e           src1->n
+00081960: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
+00081970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081980: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+00081990: 6e65 5b32 5d2c 0a20 2020 2020 2020 2020  ne[2],.         
+000819a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000819b0: 2020 2020 2020 2020 2020 206e 6230 2a73             nb0*s
+000819c0: 7263 312d 3e6e 655b 305d 2c0a 2020 2020  rc1->ne[0],.    
+000819d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000819e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000819f0: 6e62 302a 7372 6331 2d3e 6e65 5b30 5d2a  nb0*src1->ne[0]*
+00081a00: 7372 6331 2d3e 6e65 5b31 5d2c 0a20 2020  src1->ne[1],.   
+00081a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00081a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081a30: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-00081a40: 3e6e 655b 335d 2c0a 2020 2020 2020 2020  >ne[3],.        
-00081a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081a60: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
-00081a70: 7372 6331 2d3e 6e65 5b30 5d2c 0a20 2020  src1->ne[0],.   
+00081a30: 206f 6666 7365 7429 3b0a 2020 2020 2020   offset);.      
+00081a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081a50: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00081a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081a70: 2020 2020 2020 2063 6173 6520 343a 0a20         case 4:. 
 00081a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081aa0: 206e 6230 2a73 7263 312d 3e6e 655b 305d   nb0*src1->ne[0]
-00081ab0: 2a73 7263 312d 3e6e 655b 315d 2c0a 2020  *src1->ne[1],.  
-00081ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081ae0: 2020 6e62 302a 7372 6331 2d3e 6e65 5b30    nb0*src1->ne[0
-00081af0: 5d2a 7372 6331 2d3e 6e65 5b31 5d2a 7372  ]*src1->ne[1]*sr
-00081b00: 6331 2d3e 6e65 5b32 5d2c 0a20 2020 2020  c1->ne[2],.     
+00081a90: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00081aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081ab0: 2020 2020 2020 2020 2020 2020 2067 7261               gra
+00081ac0: 645f 6b20 3d20 6767 6d6c 5f76 6965 775f  d_k = ggml_view_
+00081ad0: 3464 2863 7478 2c0a 2020 2020 2020 2020  4d(ctx,.        
+00081ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081af0: 2020 2020 2020 2020 2020 2020 666c 6173              flas
+00081b00: 685f 6772 6164 2c0a 2020 2020 2020 2020  h_grad,.        
 00081b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081b20: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00081b30: 6666 7365 7429 3b0a 2020 2020 2020 2020  ffset);.        
+00081b20: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00081b30: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
 00081b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081b50: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00081b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081b70: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-00081b80: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
-00081b90: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
-00081ba0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
-00081bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081bc0: 2020 2020 7372 6331 2d3e 6772 6164 2c0a      src1->grad,.
+00081b50: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00081b60: 312d 3e6e 655b 315d 2c0a 2020 2020 2020  1->ne[1],.      
+00081b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081b80: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00081b90: 6331 2d3e 6e65 5b32 5d2c 0a20 2020 2020  c1->ne[2],.     
+00081ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081bb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00081bc0: 7263 312d 3e6e 655b 335d 2c0a 2020 2020  rc1->ne[3],.    
 00081bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081be0: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-00081bf0: 5f6b 2c0a 2020 2020 2020 2020 2020 2020  _k,.            
-00081c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081c10: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-00081c20: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00081c30: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00081c40: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00081c50: 2a20 6f70 7430 203d 2074 656e 736f 722d  * opt0 = tensor-
-00081c60: 3e6f 7074 5b30 5d3b 0a0a 2020 2020 2020  >opt[0];..      
-00081c70: 2020 2020 2020 2020 2020 6966 2028 6f70            if (op
-00081c80: 7430 2d3e 6772 6164 2920 7b0a 2020 2020  t0->grad) {.    
+00081be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081bf0: 6e62 302a 7372 6331 2d3e 6e65 5b30 5d2c  nb0*src1->ne[0],
+00081c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081c20: 2020 2020 206e 6230 2a73 7263 312d 3e6e       nb0*src1->n
+00081c30: 655b 305d 2a73 7263 312d 3e6e 655b 315d  e[0]*src1->ne[1]
+00081c40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00081c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081c60: 2020 2020 2020 6e62 302a 7372 6331 2d3e        nb0*src1->
+00081c70: 6e65 5b30 5d2a 7372 6331 2d3e 6e65 5b31  ne[0]*src1->ne[1
+00081c80: 5d2a 7372 6331 2d3e 6e65 5b32 5d2c 0a20  ]*src1->ne[2],. 
 00081c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081ca0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00081cb0: 6f72 202a 2067 7261 645f 7620 3d20 4e55  or * grad_v = NU
-00081cc0: 4c4c 3b0a 2020 2020 2020 2020 2020 2020  LL;.            
-00081cd0: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
-00081ce0: 7a65 5f74 206e 6230 2020 2020 3d20 666c  ze_t nb0    = fl
-00081cf0: 6173 685f 6772 6164 2d3e 6e62 5b30 5d3b  ash_grad->nb[0];
-00081d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00081d10: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
-00081d20: 7420 6f66 6673 6574 203d 206e 6230 2a73  t offset = nb0*s
-00081d30: 7263 302d 3e6e 655b 305d 2a73 7263 302d  rc0->ne[0]*src0-
-00081d40: 3e6e 655b 315d 2a73 7263 302d 3e6e 655b  >ne[1]*src0->ne[
-00081d50: 325d 2a73 7263 302d 3e6e 655b 335d 0a20  2]*src0->ne[3]. 
+00081ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081cb0: 2020 206f 6666 7365 7429 3b0a 2020 2020     offset);.    
+00081cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081cd0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00081ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081cf0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00081d00: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00081d10: 2d3e 6772 6164 203d 2067 676d 6c5f 6164  ->grad = ggml_ad
+00081d20: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
+00081d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081d40: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+00081d50: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
 00081d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081d80: 2020 2020 2020 202b 206e 6230 2a73 7263         + nb0*src
-00081d90: 312d 3e6e 655b 305d 2a73 7263 312d 3e6e  1->ne[0]*src1->n
-00081da0: 655b 315d 2a73 7263 312d 3e6e 655b 325d  e[1]*src1->ne[2]
-00081db0: 2a73 7263 312d 3e6e 655b 335d 3b0a 2020  *src1->ne[3];.  
-00081dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081dd0: 2020 7377 6974 6368 286f 7074 302d 3e6e    switch(opt0->n
-00081de0: 5f64 696d 7329 207b 0a20 2020 2020 2020  _dims) {.       
-00081df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081e00: 2063 6173 6520 323a 0a20 2020 2020 2020   case 2:.       
+00081d70: 6772 6164 5f6b 2c0a 2020 2020 2020 2020  grad_k,.        
+00081d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081d90: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+00081da0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00081db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081dc0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00081dd0: 736f 7220 2a20 6f70 7430 203d 2074 656e  sor * opt0 = ten
+00081de0: 736f 722d 3e6f 7074 5b30 5d3b 0a0a 2020  sor->opt[0];..  
+00081df0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00081e00: 2028 6f70 7430 2d3e 6772 6164 2920 7b0a   (opt0->grad) {.
 00081e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081e20: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00081e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081e40: 2020 2020 2020 2067 7261 645f 7620 3d20         grad_v = 
-00081e50: 6767 6d6c 5f76 6965 775f 3264 2863 7478  ggml_view_2d(ctx
-00081e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00081e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081e80: 2020 2020 2020 666c 6173 685f 6772 6164        flash_grad
-00081e90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00081ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081eb0: 2020 2020 2020 6f70 7430 2d3e 6e65 5b30        opt0->ne[0
-00081ec0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00081ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081ee0: 2020 2020 2020 206f 7074 302d 3e6e 655b         opt0->ne[
-00081ef0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-00081f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081f10: 2020 2020 2020 2020 6e62 302a 6f70 7430          nb0*opt0
-00081f20: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
-00081f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081f40: 2020 2020 2020 2020 2020 2020 206f 6666               off
-00081f50: 7365 7429 3b0a 2020 2020 2020 2020 2020  set);.          
-00081f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081f70: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00081f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081f90: 2020 2063 6173 6520 333a 0a20 2020 2020     case 3:.     
-00081fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081fb0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00081fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081fd0: 2020 2020 2020 2020 2067 7261 645f 7620           grad_v 
-00081fe0: 3d20 6767 6d6c 5f76 6965 775f 3364 2863  = ggml_view_3d(c
-00081ff0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-00082000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082010: 2020 2020 2020 2020 666c 6173 685f 6772          flash_gr
-00082020: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-00082030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082040: 2020 2020 2020 2020 6f70 7430 2d3e 6e65          opt0->ne
-00082050: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-00082060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082070: 2020 2020 2020 2020 206f 7074 302d 3e6e           opt0->n
-00082080: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
-00082090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000820a0: 2020 2020 2020 2020 2020 6f70 7430 2d3e            opt0->
-000820b0: 6e65 5b32 5d2c 0a20 2020 2020 2020 2020  ne[2],.         
+00081e20: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00081e30: 7465 6e73 6f72 202a 2067 7261 645f 7620  tensor * grad_v 
+00081e40: 3d20 4e55 4c4c 3b0a 2020 2020 2020 2020  = NULL;.        
+00081e50: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00081e60: 7420 7369 7a65 5f74 206e 6230 2020 2020  t size_t nb0    
+00081e70: 3d20 666c 6173 685f 6772 6164 2d3e 6e62  = flash_grad->nb
+00081e80: 5b30 5d3b 0a20 2020 2020 2020 2020 2020  [0];.           
+00081e90: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
+00081ea0: 697a 655f 7420 6f66 6673 6574 203d 206e  ize_t offset = n
+00081eb0: 6230 2a73 7263 302d 3e6e 655b 305d 2a73  b0*src0->ne[0]*s
+00081ec0: 7263 302d 3e6e 655b 315d 2a73 7263 302d  rc0->ne[1]*src0-
+00081ed0: 3e6e 655b 325d 2a73 7263 302d 3e6e 655b  >ne[2]*src0->ne[
+00081ee0: 335d 0a20 2020 2020 2020 2020 2020 2020  3].             
+00081ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081f00: 2020 2020 2020 2020 2020 202b 206e 6230             + nb0
+00081f10: 2a73 7263 312d 3e6e 655b 305d 2a73 7263  *src1->ne[0]*src
+00081f20: 312d 3e6e 655b 315d 2a73 7263 312d 3e6e  1->ne[1]*src1->n
+00081f30: 655b 325d 2a73 7263 312d 3e6e 655b 335d  e[2]*src1->ne[3]
+00081f40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00081f50: 2020 2020 2020 7377 6974 6368 286f 7074        switch(opt
+00081f60: 302d 3e6e 5f64 696d 7329 207b 0a20 2020  0->n_dims) {.   
+00081f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081f80: 2020 2020 2063 6173 6520 323a 0a20 2020       case 2:.   
+00081f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081fa0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00081fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081fc0: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
+00081fd0: 7620 3d20 6767 6d6c 5f76 6965 775f 3264  v = ggml_view_2d
+00081fe0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+00081ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082000: 2020 2020 2020 2020 2020 666c 6173 685f            flash_
+00082010: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+00082020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082030: 2020 2020 2020 2020 2020 6f70 7430 2d3e            opt0->
+00082040: 6e65 5b30 5d2c 0a20 2020 2020 2020 2020  ne[0],.         
+00082050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082060: 2020 2020 2020 2020 2020 206f 7074 302d             opt0-
+00082070: 3e6e 655b 315d 2c0a 2020 2020 2020 2020  >ne[1],.        
+00082080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082090: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
+000820a0: 6f70 7430 2d3e 6e65 5b30 5d2c 0a20 2020  opt0->ne[0],.   
+000820b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000820c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000820d0: 2020 2020 2020 2020 2020 206e 6230 2a6f             nb0*o
-000820e0: 7074 302d 3e6e 655b 305d 2c0a 2020 2020  pt0->ne[0],.    
-000820f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000820d0: 206f 6666 7365 7429 3b0a 2020 2020 2020   offset);.      
+000820e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000820f0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
 00082100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082110: 6e62 302a 6f70 7430 2d3e 6e65 5b30 5d2a  nb0*opt0->ne[0]*
-00082120: 6f70 7430 2d3e 6e65 5b31 5d2c 0a20 2020  opt0->ne[1],.   
-00082130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082110: 2020 2020 2020 2063 6173 6520 333a 0a20         case 3:. 
+00082120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082130: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
 00082140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082150: 206f 6666 7365 7429 3b0a 2020 2020 2020   offset);.      
-00082160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082170: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00082150: 2020 2020 2020 2020 2020 2020 2067 7261               gra
+00082160: 645f 7620 3d20 6767 6d6c 5f76 6965 775f  d_v = ggml_view_
+00082170: 3364 2863 7478 2c0a 2020 2020 2020 2020  3d(ctx,.        
 00082180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082190: 2020 2020 2020 2063 6173 6520 343a 0a20         case 4:. 
-000821a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000821b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000821c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000821d0: 2020 2020 2020 2020 2020 2020 2067 7261               gra
-000821e0: 645f 7620 3d20 6767 6d6c 5f76 6965 775f  d_v = ggml_view_
-000821f0: 3464 2863 7478 2c0a 2020 2020 2020 2020  4d(ctx,.        
-00082200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082210: 2020 2020 2020 2020 2020 2020 666c 6173              flas
-00082220: 685f 6772 6164 2c0a 2020 2020 2020 2020  h_grad,.        
-00082230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082240: 2020 2020 2020 2020 2020 2020 6f70 7430              opt0
-00082250: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
-00082260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082270: 2020 2020 2020 2020 2020 2020 206f 7074               opt
-00082280: 302d 3e6e 655b 315d 2c0a 2020 2020 2020  0->ne[1],.      
-00082290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000822a0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
-000822b0: 7430 2d3e 6e65 5b32 5d2c 0a20 2020 2020  t0->ne[2],.     
+00082190: 2020 2020 2020 2020 2020 2020 666c 6173              flas
+000821a0: 685f 6772 6164 2c0a 2020 2020 2020 2020  h_grad,.        
+000821b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000821c0: 2020 2020 2020 2020 2020 2020 6f70 7430              opt0
+000821d0: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
+000821e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000821f0: 2020 2020 2020 2020 2020 2020 206f 7074               opt
+00082200: 302d 3e6e 655b 315d 2c0a 2020 2020 2020  0->ne[1],.      
+00082210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082220: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+00082230: 7430 2d3e 6e65 5b32 5d2c 0a20 2020 2020  t0->ne[2],.     
+00082240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082250: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00082260: 6230 2a6f 7074 302d 3e6e 655b 305d 2c0a  b0*opt0->ne[0],.
+00082270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082290: 2020 2020 6e62 302a 6f70 7430 2d3e 6e65      nb0*opt0->ne
+000822a0: 5b30 5d2a 6f70 7430 2d3e 6e65 5b31 5d2c  [0]*opt0->ne[1],
+000822b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000822c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000822d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000822e0: 7074 302d 3e6e 655b 335d 2c0a 2020 2020  pt0->ne[3],.    
-000822f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082310: 6e62 302a 6f70 7430 2d3e 6e65 5b30 5d2c  nb0*opt0->ne[0],
-00082320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082340: 2020 2020 206e 6230 2a6f 7074 302d 3e6e       nb0*opt0->n
-00082350: 655b 305d 2a6f 7074 302d 3e6e 655b 315d  e[0]*opt0->ne[1]
-00082360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00082370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082380: 2020 2020 2020 6e62 302a 6f70 7430 2d3e        nb0*opt0->
-00082390: 6e65 5b30 5d2a 6f70 7430 2d3e 6e65 5b31  ne[0]*opt0->ne[1
-000823a0: 5d2a 6f70 7430 2d3e 6e65 5b32 5d2c 0a20  ]*opt0->ne[2],. 
+000822d0: 2020 2020 206f 6666 7365 7429 3b0a 2020       offset);.  
+000822e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000822f0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00082300: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+00082310: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00082320: 343a 0a20 2020 2020 2020 2020 2020 2020  4:.             
+00082330: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00082340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082360: 2067 7261 645f 7620 3d20 6767 6d6c 5f76   grad_v = ggml_v
+00082370: 6965 775f 3464 2863 7478 2c0a 2020 2020  iew_4d(ctx,.    
+00082380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000823a0: 666c 6173 685f 6772 6164 2c0a 2020 2020  flash_grad,.    
 000823b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000823c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000823d0: 2020 206f 6666 7365 7429 3b0a 2020 2020     offset);.    
+000823d0: 6f70 7430 2d3e 6e65 5b30 5d2c 0a20 2020  opt0->ne[0],.   
 000823e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000823f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00082400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082410: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00082420: 2020 2020 2020 2020 2020 2020 6f70 7430              opt0
-00082430: 2d3e 6772 6164 203d 2067 676d 6c5f 6164  ->grad = ggml_ad
-00082440: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
+000823f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082400: 206f 7074 302d 3e6e 655b 315d 2c0a 2020   opt0->ne[1],.  
+00082410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082430: 2020 6f70 7430 2d3e 6e65 5b32 5d2c 0a20    opt0->ne[2],. 
+00082440: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00082450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082460: 2020 2020 2020 2020 6f70 7430 2d3e 6772          opt0->gr
-00082470: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+00082460: 2020 206f 7074 302d 3e6e 655b 335d 2c0a     opt0->ne[3],.
+00082470: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00082480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082490: 6772 6164 5f76 2c0a 2020 2020 2020 2020  grad_v,.        
-000824a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000824b0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-000824c0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-000824d0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000824e0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000824f0: 6520 4747 4d4c 5f4f 505f 464c 4153 485f  e GGML_OP_FLASH_
-00082500: 4646 3a0a 2020 2020 2020 2020 2020 2020  FF:.            
-00082510: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00082520: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00082530: 6c73 6529 3b20 2f2f 206e 6f74 2073 7570  lse); // not sup
-00082540: 706f 7274 6564 0a20 2020 2020 2020 2020  ported.         
-00082550: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00082560: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00082570: 5f46 4c41 5348 5f41 5454 4e5f 4241 434b  _FLASH_ATTN_BACK
-00082580: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00082590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000825a0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-000825b0: 6529 3b20 2f2f 206e 6f74 2073 7570 706f  e); // not suppo
-000825c0: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
-000825d0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000825e0: 2020 6361 7365 2047 474d 4c5f 4f50 5f57    case GGML_OP_W
-000825f0: 494e 5f50 4152 543a 0a20 2020 2020 2020  IN_PART:.       
-00082600: 2063 6173 6520 4747 4d4c 5f4f 505f 5749   case GGML_OP_WI
-00082610: 4e5f 554e 5041 5254 3a0a 2020 2020 2020  N_UNPART:.      
-00082620: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
-00082630: 4150 5f55 4e41 5259 3a0a 2020 2020 2020  AP_UNARY:.      
-00082640: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
-00082650: 4150 5f42 494e 4152 593a 0a20 2020 2020  AP_BINARY:.     
-00082660: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00082670: 4d41 505f 4355 5354 4f4d 313a 0a20 2020  MAP_CUSTOM1:.   
-00082680: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00082690: 505f 4d41 505f 4355 5354 4f4d 323a 0a20  P_MAP_CUSTOM2:. 
-000826a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000826b0: 5f4f 505f 4d41 505f 4355 5354 4f4d 333a  _OP_MAP_CUSTOM3:
-000826c0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000826d0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-000826e0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-000826f0: 293b 202f 2f20 6e6f 7420 7375 7070 6f72  ); // not suppor
-00082700: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-00082710: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00082720: 2063 6173 6520 4747 4d4c 5f4f 505f 4352   case GGML_OP_CR
-00082730: 4f53 535f 454e 5452 4f50 595f 4c4f 5353  OSS_ENTROPY_LOSS
-00082740: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00082750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082760: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-00082770: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00082780: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-00082790: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
-000827a0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-000827b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000827c0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-000827d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000827e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000827f0: 2020 6767 6d6c 5f63 726f 7373 5f65 6e74    ggml_cross_ent
-00082800: 726f 7079 5f6c 6f73 735f 6261 636b 2863  ropy_loss_back(c
-00082810: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-00082820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082830: 2020 2020 2020 2020 7372 6330 2c0a 2020          src0,.  
-00082840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082860: 2020 7372 6331 2c0a 2020 2020 2020 2020    src1,.        
-00082870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082880: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-00082890: 6f72 2d3e 6772 6164 292c 0a20 2020 2020  or->grad),.     
-000828a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000828b0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-000828c0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-000828d0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000828e0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000828f0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00082900: 5f43 524f 5353 5f45 4e54 524f 5059 5f4c  _CROSS_ENTROPY_L
-00082910: 4f53 535f 4241 434b 3a0a 2020 2020 2020  OSS_BACK:.      
-00082920: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00082930: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00082940: 4552 5428 6661 6c73 6529 3b20 2f2f 206e  ERT(false); // n
-00082950: 6f74 2073 7570 706f 7274 6564 0a20 2020  ot supported.   
-00082960: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00082970: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00082980: 474d 4c5f 4f50 5f4e 4f4e 453a 0a20 2020  GML_OP_NONE:.   
-00082990: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000829a0: 2020 2020 2020 2020 2020 202f 2f20 6e6f             // no
-000829b0: 700a 2020 2020 2020 2020 2020 2020 7d20  p.            } 
-000829c0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000829d0: 6173 6520 4747 4d4c 5f4f 505f 434f 554e  ase GGML_OP_COUN
-000829e0: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
-000829f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082a00: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00082a10: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00082a20: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00082a30: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00082a40: 676d 6c5f 7669 7369 745f 7061 7265 6e74  gml_visit_parent
-00082a50: 7328 7374 7275 6374 2067 676d 6c5f 6367  s(struct ggml_cg
-00082a60: 7261 7068 202a 2063 6772 6170 682c 2073  raph * cgraph, s
-00082a70: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00082a80: 7220 2a20 6e6f 6465 2920 7b0a 2020 2020  r * node) {.    
-00082a90: 6966 2028 6e6f 6465 2d3e 6772 6164 203d  if (node->grad =
-00082aa0: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
-00082ab0: 2020 2f2f 2074 6869 7320 7573 7561 6c6c    // this usuall
-00082ac0: 7920 6861 7070 656e 7320 7768 656e 2077  y happens when w
-00082ad0: 6520 6765 6e65 7261 7465 2069 6e74 6572  e generate inter
-00082ae0: 6d65 6469 6174 6520 6e6f 6465 7320 6672  mediate nodes fr
-00082af0: 6f6d 2063 6f6e 7374 616e 7473 2069 6e20  om constants in 
-00082b00: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
-00082b10: 730a 2020 2020 2020 2020 2f2f 2069 7420  s.        // it 
-00082b20: 6361 6e20 616c 736f 2068 6170 7065 6e20  can also happen 
-00082b30: 6475 7269 6e67 2066 6f72 7761 7264 2070  during forward p
-00082b40: 6173 732c 2069 6620 7468 6520 7573 6572  ass, if the user
-00082b50: 2070 6572 666f 726d 7320 636f 6d70 7574   performs comput
-00082b60: 6174 696f 6e73 2077 6974 6820 636f 6e73  ations with cons
-00082b70: 7461 6e74 730a 2020 2020 2020 2020 6966  tants.        if
-00082b80: 2028 6e6f 6465 2d3e 6f70 2021 3d20 4747   (node->op != GG
-00082b90: 4d4c 5f4f 505f 4e4f 4e45 2920 7b0a 2020  ML_OP_NONE) {.  
-00082ba0: 2020 2020 2020 2020 2020 2f2f 4747 4d4c            //GGML
-00082bb0: 5f50 5249 4e54 5f44 4542 5547 2822 2573  _PRINT_DEBUG("%s
-00082bc0: 3a20 7761 726e 696e 673a 206e 6f64 6520  : warning: node 
-00082bd0: 2570 2068 6173 206e 6f20 6772 6164 2c20  %p has no grad, 
-00082be0: 6275 7420 6f70 2025 645c 6e22 2c20 5f5f  but op %d\n", __
-00082bf0: 6675 6e63 5f5f 2c20 2876 6f69 6420 2a29  func__, (void *)
-00082c00: 206e 6f64 652c 206e 6f64 652d 3e6f 7029   node, node->op)
-00082c10: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-00082c20: 7d0a 0a20 2020 202f 2f20 6368 6563 6b20  }..    // check 
-00082c30: 6966 2061 6c72 6561 6479 2076 6973 6974  if already visit
-00082c40: 6564 0a20 2020 2066 6f72 2028 696e 7420  ed.    for (int 
-00082c50: 6920 3d20 303b 2069 203c 2063 6772 6170  i = 0; i < cgrap
-00082c60: 682d 3e6e 5f6e 6f64 6573 3b20 692b 2b29  h->n_nodes; i++)
-00082c70: 207b 0a20 2020 2020 2020 2069 6620 2863   {.        if (c
-00082c80: 6772 6170 682d 3e6e 6f64 6573 5b69 5d20  graph->nodes[i] 
-00082c90: 3d3d 206e 6f64 6529 207b 0a20 2020 2020  == node) {.     
-00082ca0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-00082cb0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-00082cc0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00082cd0: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
-00082ce0: 6e5f 6c65 6166 733b 2069 2b2b 2920 7b0a  n_leafs; i++) {.
-00082cf0: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
-00082d00: 7068 2d3e 6c65 6166 735b 695d 203d 3d20  ph->leafs[i] == 
-00082d10: 6e6f 6465 2920 7b0a 2020 2020 2020 2020  node) {.        
-00082d20: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00082d30: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-00082d40: 2069 6620 286e 6f64 652d 3e73 7263 3029   if (node->src0)
-00082d50: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
-00082d60: 7669 7369 745f 7061 7265 6e74 7328 6367  visit_parents(cg
-00082d70: 7261 7068 2c20 6e6f 6465 2d3e 7372 6330  raph, node->src0
-00082d80: 293b 0a20 2020 207d 0a0a 2020 2020 6966  );.    }..    if
-00082d90: 2028 6e6f 6465 2d3e 7372 6331 2920 7b0a   (node->src1) {.
-00082da0: 2020 2020 2020 2020 6767 6d6c 5f76 6973          ggml_vis
-00082db0: 6974 5f70 6172 656e 7473 2863 6772 6170  it_parents(cgrap
-00082dc0: 682c 206e 6f64 652d 3e73 7263 3129 3b0a  h, node->src1);.
-00082dd0: 2020 2020 7d0a 0a20 2020 2066 6f72 2028      }..    for (
-00082de0: 696e 7420 6920 3d20 303b 2069 203c 2047  int i = 0; i < G
-00082df0: 474d 4c5f 4d41 585f 4f50 543b 202b 2b69  GML_MAX_OPT; ++i
-00082e00: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
-00082e10: 6e6f 6465 2d3e 6f70 745b 695d 2920 7b0a  node->opt[i]) {.
-00082e20: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00082e30: 5f76 6973 6974 5f70 6172 656e 7473 2863  _visit_parents(c
-00082e40: 6772 6170 682c 206e 6f64 652d 3e6f 7074  graph, node->opt
-00082e50: 5b69 5d29 3b0a 2020 2020 2020 2020 7d0a  [i]);.        }.
-00082e60: 2020 2020 7d0a 0a20 2020 2069 6620 286e      }..    if (n
-00082e70: 6f64 652d 3e6f 7020 3d3d 2047 474d 4c5f  ode->op == GGML_
-00082e80: 4f50 5f4e 4f4e 4520 2626 206e 6f64 652d  OP_NONE && node-
-00082e90: 3e67 7261 6420 3d3d 204e 554c 4c29 207b  >grad == NULL) {
-00082ea0: 0a20 2020 2020 2020 202f 2f20 7265 6163  .        // reac
-00082eb0: 6865 6420 6120 6c65 6166 206e 6f64 652c  hed a leaf node,
-00082ec0: 206e 6f74 2070 6172 7420 6f66 2074 6865   not part of the
-00082ed0: 2067 7261 6469 656e 7420 6772 6170 6820   gradient graph 
-00082ee0: 2865 2e67 2e20 6120 636f 6e73 7461 6e74  (e.g. a constant
-00082ef0: 290a 2020 2020 2020 2020 4747 4d4c 5f41  ).        GGML_A
-00082f00: 5353 4552 5428 6367 7261 7068 2d3e 6e5f  SSERT(cgraph->n_
-00082f10: 6c65 6166 7320 3c20 4747 4d4c 5f4d 4158  leafs < GGML_MAX
-00082f20: 5f4e 4f44 4553 293b 0a0a 2020 2020 2020  _NODES);..      
-00082f30: 2020 6966 2028 7374 726c 656e 286e 6f64    if (strlen(nod
-00082f40: 652d 3e6e 616d 6529 203d 3d20 3029 207b  e->name) == 0) {
-00082f50: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00082f60: 6c5f 666f 726d 6174 5f6e 616d 6528 6e6f  l_format_name(no
-00082f70: 6465 2c20 226c 6561 665f 2564 222c 2063  de, "leaf_%d", c
-00082f80: 6772 6170 682d 3e6e 5f6c 6561 6673 293b  graph->n_leafs);
-00082f90: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00082fa0: 2020 2020 6367 7261 7068 2d3e 6c65 6166      cgraph->leaf
-00082fb0: 735b 6367 7261 7068 2d3e 6e5f 6c65 6166  s[cgraph->n_leaf
-00082fc0: 735d 203d 206e 6f64 653b 0a20 2020 2020  s] = node;.     
-00082fd0: 2020 2063 6772 6170 682d 3e6e 5f6c 6561     cgraph->n_lea
-00082fe0: 6673 2b2b 3b0a 2020 2020 7d20 656c 7365  fs++;.    } else
-00082ff0: 207b 0a20 2020 2020 2020 2047 474d 4c5f   {.        GGML_
-00083000: 4153 5345 5254 2863 6772 6170 682d 3e6e  ASSERT(cgraph->n
-00083010: 5f6e 6f64 6573 203c 2047 474d 4c5f 4d41  _nodes < GGML_MA
-00083020: 585f 4e4f 4445 5329 3b0a 0a20 2020 2020  X_NODES);..     
-00083030: 2020 2069 6620 2873 7472 6c65 6e28 6e6f     if (strlen(no
-00083040: 6465 2d3e 6e61 6d65 2920 3d3d 2030 2920  de->name) == 0) 
-00083050: 7b0a 2020 2020 2020 2020 2020 2020 6767  {.            gg
-00083060: 6d6c 5f66 6f72 6d61 745f 6e61 6d65 286e  ml_format_name(n
-00083070: 6f64 652c 2022 6e6f 6465 5f25 6422 2c20  ode, "node_%d", 
-00083080: 6367 7261 7068 2d3e 6e5f 6e6f 6465 7329  cgraph->n_nodes)
-00083090: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-000830a0: 2020 2020 2063 6772 6170 682d 3e6e 6f64       cgraph->nod
-000830b0: 6573 5b63 6772 6170 682d 3e6e 5f6e 6f64  es[cgraph->n_nod
-000830c0: 6573 5d20 3d20 6e6f 6465 3b0a 2020 2020  es] = node;.    
-000830d0: 2020 2020 6367 7261 7068 2d3e 6772 6164      cgraph->grad
-000830e0: 735b 6367 7261 7068 2d3e 6e5f 6e6f 6465  s[cgraph->n_node
-000830f0: 735d 203d 206e 6f64 652d 3e67 7261 643b  s] = node->grad;
-00083100: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
-00083110: 3e6e 5f6e 6f64 6573 2b2b 3b0a 2020 2020  >n_nodes++;.    
-00083120: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-00083130: 2067 676d 6c5f 6275 696c 645f 666f 7277   ggml_build_forw
-00083140: 6172 645f 696d 706c 2873 7472 7563 7420  ard_impl(struct 
-00083150: 6767 6d6c 5f63 6772 6170 6820 2a20 6367  ggml_cgraph * cg
-00083160: 7261 7068 2c20 7374 7275 6374 2067 676d  raph, struct ggm
-00083170: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
-00083180: 722c 2062 6f6f 6c20 6578 7061 6e64 2920  r, bool expand) 
-00083190: 7b0a 2020 2020 6966 2028 2165 7870 616e  {.    if (!expan
-000831a0: 6429 207b 0a20 2020 2020 2020 2063 6772  d) {.        cgr
-000831b0: 6170 682d 3e6e 5f6e 6f64 6573 203d 2030  aph->n_nodes = 0
-000831c0: 3b0a 2020 2020 2020 2020 6367 7261 7068  ;.        cgraph
-000831d0: 2d3e 6e5f 6c65 6166 7320 3d20 303b 0a20  ->n_leafs = 0;. 
-000831e0: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-000831f0: 696e 7420 6e30 203d 2063 6772 6170 682d  int n0 = cgraph-
-00083200: 3e6e 5f6e 6f64 6573 3b0a 2020 2020 554e  >n_nodes;.    UN
-00083210: 5553 4544 286e 3029 3b0a 0a20 2020 2067  USED(n0);..    g
-00083220: 676d 6c5f 7669 7369 745f 7061 7265 6e74  gml_visit_parent
-00083230: 7328 6367 7261 7068 2c20 7465 6e73 6f72  s(cgraph, tensor
-00083240: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
-00083250: 7420 6e5f 6e65 7720 3d20 6367 7261 7068  t n_new = cgraph
-00083260: 2d3e 6e5f 6e6f 6465 7320 2d20 6e30 3b0a  ->n_nodes - n0;.
-00083270: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
-00083280: 4542 5547 2822 2573 3a20 7669 7369 7465  EBUG("%s: visite
-00083290: 6420 2564 206e 6577 206e 6f64 6573 5c6e  d %d new nodes\n
-000832a0: 222c 205f 5f66 756e 635f 5f2c 206e 5f6e  ", __func__, n_n
-000832b0: 6577 293b 0a0a 2020 2020 6966 2028 6e5f  ew);..    if (n_
-000832c0: 6e65 7720 3e20 3029 207b 0a20 2020 2020  new > 0) {.     
-000832d0: 2020 202f 2f20 7468 6520 6c61 7374 2061     // the last a
-000832e0: 6464 6564 206e 6f64 6520 7368 6f75 6c64  dded node should
-000832f0: 2061 6c77 6179 7320 6265 2073 7461 7274   always be start
-00083300: 696e 6720 706f 696e 740a 2020 2020 2020  ing point.      
-00083310: 2020 4747 4d4c 5f41 5353 4552 5428 6367    GGML_ASSERT(cg
-00083320: 7261 7068 2d3e 6e6f 6465 735b 6367 7261  raph->nodes[cgra
-00083330: 7068 2d3e 6e5f 6e6f 6465 7320 2d20 315d  ph->n_nodes - 1]
-00083340: 203d 3d20 7465 6e73 6f72 293b 0a20 2020   == tensor);.   
-00083350: 207d 0a7d 0a0a 766f 6964 2067 676d 6c5f   }.}..void ggml_
-00083360: 6275 696c 645f 666f 7277 6172 645f 6578  build_forward_ex
-00083370: 7061 6e64 2873 7472 7563 7420 6767 6d6c  pand(struct ggml
-00083380: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
-00083390: 2c20 7374 7275 6374 2067 676d 6c5f 7465  , struct ggml_te
-000833a0: 6e73 6f72 202a 2074 656e 736f 7229 207b  nsor * tensor) {
-000833b0: 0a20 2020 2067 676d 6c5f 6275 696c 645f  .    ggml_build_
-000833c0: 666f 7277 6172 645f 696d 706c 2863 6772  forward_impl(cgr
-000833d0: 6170 682c 2074 656e 736f 722c 2074 7275  aph, tensor, tru
-000833e0: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
-000833f0: 6d6c 5f63 6772 6170 6820 6767 6d6c 5f62  ml_cgraph ggml_b
-00083400: 7569 6c64 5f66 6f72 7761 7264 2873 7472  uild_forward(str
-00083410: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00083420: 2a20 7465 6e73 6f72 2920 7b0a 2020 2020  * tensor) {.    
-00083430: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-00083440: 7068 2072 6573 756c 7420 3d20 7b0a 2020  ph result = {.  
-00083450: 2020 2020 2020 2f2a 2e6e 5f6e 6f64 6573        /*.n_nodes
-00083460: 2020 2020 2020 3d2a 2f20 302c 0a20 2020        =*/ 0,.   
-00083470: 2020 2020 202f 2a2e 6e5f 6c65 6166 7320       /*.n_leafs 
-00083480: 2020 2020 203d 2a2f 2030 2c0a 2020 2020       =*/ 0,.    
-00083490: 2020 2020 2f2a 2e6e 5f74 6872 6561 6473      /*.n_threads
-000834a0: 2020 2020 3d2a 2f20 4747 4d4c 5f44 4546      =*/ GGML_DEF
-000834b0: 4155 4c54 5f4e 5f54 4852 4541 4453 2c0a  AULT_N_THREADS,.
-000834c0: 2020 2020 2020 2020 2f2a 2e77 6f72 6b5f          /*.work_
-000834d0: 7369 7a65 2020 2020 3d2a 2f20 302c 0a20  size    =*/ 0,. 
-000834e0: 2020 2020 2020 202f 2a2e 776f 726b 2020         /*.work  
-000834f0: 2020 2020 2020 203d 2a2f 204e 554c 4c2c         =*/ NULL,
-00083500: 0a20 2020 2020 2020 202f 2a2e 6e6f 6465  .        /*.node
-00083510: 7320 2020 2020 2020 203d 2a2f 207b 204e  s        =*/ { N
-00083520: 554c 4c20 7d2c 0a20 2020 2020 2020 202f  ULL },.        /
-00083530: 2a2e 6772 6164 7320 2020 2020 2020 203d  *.grads        =
-00083540: 2a2f 207b 204e 554c 4c20 7d2c 0a20 2020  */ { NULL },.   
-00083550: 2020 2020 202f 2a2e 6c65 6166 7320 2020       /*.leafs   
-00083560: 2020 2020 203d 2a2f 207b 204e 554c 4c20       =*/ { NULL 
-00083570: 7d2c 0a20 2020 2020 2020 202f 2a2e 7065  },.        /*.pe
-00083580: 7266 5f72 756e 7320 2020 203d 2a2f 2030  rf_runs    =*/ 0
-00083590: 2c0a 2020 2020 2020 2020 2f2a 2e70 6572  ,.        /*.per
-000835a0: 665f 6379 636c 6573 2020 3d2a 2f20 302c  f_cycles  =*/ 0,
-000835b0: 0a20 2020 2020 2020 202f 2a2e 7065 7266  .        /*.perf
-000835c0: 5f74 696d 655f 7573 203d 2a2f 2030 2c0a  _time_us =*/ 0,.
-000835d0: 2020 2020 7d3b 0a0a 2020 2020 6767 6d6c      };..    ggml
-000835e0: 5f62 7569 6c64 5f66 6f72 7761 7264 5f69  _build_forward_i
-000835f0: 6d70 6c28 2672 6573 756c 742c 2074 656e  mpl(&result, ten
-00083600: 736f 722c 2066 616c 7365 293b 0a0a 2020  sor, false);..  
-00083610: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
-00083620: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-00083630: 6367 7261 7068 2067 676d 6c5f 6275 696c  cgraph ggml_buil
-00083640: 645f 6261 636b 7761 7264 2873 7472 7563  d_backward(struc
-00083650: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00083660: 2063 7478 2c20 7374 7275 6374 2067 676d   ctx, struct ggm
-00083670: 6c5f 6367 7261 7068 202a 2067 662c 2062  l_cgraph * gf, b
-00083680: 6f6f 6c20 6b65 6570 2920 7b0a 2020 2020  ool keep) {.    
-00083690: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-000836a0: 7068 2072 6573 756c 7420 3d20 2a67 663b  ph result = *gf;
-000836b0: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-000836c0: 5428 6766 2d3e 6e5f 6e6f 6465 7320 3e20  T(gf->n_nodes > 
-000836d0: 3029 3b0a 0a20 2020 202f 2f20 6966 2077  0);..    // if w
-000836e0: 6520 6172 6520 6b65 6570 696e 6720 7468  e are keeping th
-000836f0: 6520 6772 6164 6965 6e74 2067 7261 7068  e gradient graph
-00083700: 2c20 7765 2068 6176 6520 746f 2064 6574  , we have to det
-00083710: 6163 6820 7468 6520 6772 6164 6965 6e74  ach the gradient
-00083720: 206e 6f64 6573 2066 726f 6d20 7468 6520   nodes from the 
-00083730: 6f72 6967 696e 616c 2067 7261 7068 0a20  original graph. 
-00083740: 2020 2069 6620 286b 6565 7029 207b 0a20     if (keep) {. 
-00083750: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00083760: 6920 3d20 303b 2069 203c 2067 662d 3e6e  i = 0; i < gf->n
-00083770: 5f6e 6f64 6573 3b20 692b 2b29 207b 0a20  _nodes; i++) {. 
-00083780: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00083790: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000837a0: 6e6f 6465 203d 2067 662d 3e6e 6f64 6573  node = gf->nodes
-000837b0: 5b69 5d3b 0a0a 2020 2020 2020 2020 2020  [i];..          
-000837c0: 2020 6966 2028 6e6f 6465 2d3e 6772 6164    if (node->grad
-000837d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000837e0: 2020 2020 6e6f 6465 2d3e 6772 6164 203d      node->grad =
-000837f0: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-00083800: 2863 7478 2c20 6e6f 6465 293b 0a20 2020  (ctx, node);.   
-00083810: 2020 2020 2020 2020 2020 2020 2067 662d               gf-
-00083820: 3e67 7261 6473 5b69 5d20 3d20 6e6f 6465  >grads[i] = node
-00083830: 2d3e 6772 6164 3b0a 2020 2020 2020 2020  ->grad;.        
-00083840: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-00083850: 2020 2020 7d0a 0a20 2020 2066 6f72 2028      }..    for (
-00083860: 696e 7420 6920 3d20 6766 2d3e 6e5f 6e6f  int i = gf->n_no
-00083870: 6465 7320 2d20 313b 2069 203e 3d20 303b  des - 1; i >= 0;
-00083880: 2069 2d2d 2920 7b0a 2020 2020 2020 2020   i--) {.        
-00083890: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000838a0: 6f72 202a 206e 6f64 6520 3d20 6766 2d3e  or * node = gf->
-000838b0: 6e6f 6465 735b 695d 3b0a 0a20 2020 2020  nodes[i];..     
-000838c0: 2020 202f 2f20 6265 6361 7573 6520 7765     // because we
-000838d0: 2064 6574 6163 6865 6420 7468 6520 6772   detached the gr
-000838e0: 6164 206e 6f64 6573 2066 726f 6d20 7468  ad nodes from th
-000838f0: 6520 6f72 6967 696e 616c 2067 7261 7068  e original graph
-00083900: 2c20 7765 2063 616e 2061 6666 6f72 6420  , we can afford 
-00083910: 696e 706c 6163 6520 6f70 6572 6174 696f  inplace operatio
-00083920: 6e73 0a20 2020 2020 2020 2069 6620 286e  ns.        if (n
-00083930: 6f64 652d 3e67 7261 6429 207b 0a20 2020  ode->grad) {.   
-00083940: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00083950: 6d70 7574 655f 6261 636b 7761 7264 2863  mpute_backward(c
-00083960: 7478 2c20 6e6f 6465 2c20 6b65 6570 293b  tx, node, keep);
-00083970: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-00083980: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-00083990: 203d 2067 662d 3e6e 5f6e 6f64 6573 202d   = gf->n_nodes -
-000839a0: 2031 3b20 6920 3e3d 2030 3b20 692d 2d29   1; i >= 0; i--)
-000839b0: 207b 0a20 2020 2020 2020 2073 7472 7563   {.        struc
-000839c0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000839d0: 6e6f 6465 203d 2067 662d 3e6e 6f64 6573  node = gf->nodes
-000839e0: 5b69 5d3b 0a0a 2020 2020 2020 2020 6966  [i];..        if
-000839f0: 2028 6e6f 6465 2d3e 6973 5f70 6172 616d   (node->is_param
-00083a00: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00083a10: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
-00083a20: 2822 2573 3a20 666f 756e 6420 726f 6f74  ("%s: found root
-00083a30: 206e 6f64 6520 2570 5c6e 222c 205f 5f66   node %p\n", __f
-00083a40: 756e 635f 5f2c 2028 766f 6964 202a 2920  unc__, (void *) 
-00083a50: 6e6f 6465 293b 0a20 2020 2020 2020 2020  node);.         
-00083a60: 2020 2067 676d 6c5f 6275 696c 645f 666f     ggml_build_fo
-00083a70: 7277 6172 645f 696d 706c 2826 7265 7375  rward_impl(&resu
-00083a80: 6c74 2c20 6e6f 6465 2d3e 6772 6164 2c20  lt, node->grad, 
-00083a90: 7472 7565 293b 0a20 2020 2020 2020 207d  true);.        }
-00083aa0: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
-00083ab0: 726e 2072 6573 756c 743b 0a7d 0a0a 2f2f  rn result;.}..//
-00083ac0: 0a2f 2f20 7468 7265 6164 2064 6174 610a  .// thread data.
-00083ad0: 2f2f 0a2f 2f20 7379 6e63 6872 6f6e 697a  //.// synchroniz
-00083ae0: 6174 696f 6e20 6973 2064 6f6e 6520 7669  ation is done vi
-00083af0: 6120 6275 7379 206c 6f6f 7073 0a2f 2f20  a busy loops.// 
-00083b00: 4920 7472 6965 6420 7573 696e 6720 7370  I tried using sp
-00083b10: 696e 206c 6f63 6b73 2c20 6275 7420 6e6f  in locks, but no
-00083b20: 7420 7375 7265 2068 6f77 2074 6f20 7573  t sure how to us
-00083b30: 6520 7468 656d 2063 6f72 7265 6374 6c79  e them correctly
-00083b40: 202d 2074 6865 2074 6869 6e67 7320 4920   - the things I 
-00083b50: 7472 6965 6420 7765 7265 2073 6c6f 7765  tried were slowe
-00083b60: 7220 7468 616e 2062 7573 7920 6c6f 6f70  r than busy loop
-00083b70: 730a 2f2f 0a0a 2369 6664 6566 205f 5f41  s.//..#ifdef __A
-00083b80: 5050 4c45 5f5f 0a0a 2f2f 2369 6e63 6c75  PPLE__..//#inclu
-00083b90: 6465 203c 6f73 2f6c 6f63 6b2e 683e 0a2f  de <os/lock.h>./
-00083ba0: 2f0a 2f2f 7479 7065 6465 6620 6f73 5f75  /.//typedef os_u
-00083bb0: 6e66 6169 725f 6c6f 636b 2067 676d 6c5f  nfair_lock ggml_
-00083bc0: 6c6f 636b 5f74 3b0a 2f2f 0a2f 2f23 6465  lock_t;.//.//#de
-00083bd0: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f69  fine ggml_lock_i
-00083be0: 6e69 7428 7829 2020 2020 554e 5553 4544  nit(x)    UNUSED
-00083bf0: 2878 290a 2f2f 2364 6566 696e 6520 6767  (x).//#define gg
-00083c00: 6d6c 5f6c 6f63 6b5f 6465 7374 726f 7928  ml_lock_destroy(
-00083c10: 7829 2055 4e55 5345 4428 7829 0a2f 2f23  x) UNUSED(x).//#
-00083c20: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
-00083c30: 5f6c 6f63 6b20 2020 2020 2020 6f73 5f75  _lock       os_u
-00083c40: 6e66 6169 725f 6c6f 636b 5f6c 6f63 6b0a  nfair_lock_lock.
-00083c50: 2f2f 2364 6566 696e 6520 6767 6d6c 5f6c  //#define ggml_l
-00083c60: 6f63 6b5f 756e 6c6f 636b 2020 2020 206f  ock_unlock     o
-00083c70: 735f 756e 6661 6972 5f6c 6f63 6b5f 756e  s_unfair_lock_un
-00083c80: 6c6f 636b 0a2f 2f0a 2f2f 2364 6566 696e  lock.//.//#defin
-00083c90: 6520 4747 4d4c 5f4c 4f43 4b5f 494e 4954  e GGML_LOCK_INIT
-00083ca0: 4941 4c49 5a45 5220 4f53 5f55 4e46 4149  IALIZER OS_UNFAI
-00083cb0: 525f 4c4f 434b 5f49 4e49 540a 0a74 7970  R_LOCK_INIT..typ
-00083cc0: 6564 6566 2069 6e74 2067 676d 6c5f 6c6f  edef int ggml_lo
-00083cd0: 636b 5f74 3b0a 0a23 6465 6669 6e65 2067  ck_t;..#define g
-00083ce0: 676d 6c5f 6c6f 636b 5f69 6e69 7428 7829  gml_lock_init(x)
-00083cf0: 2020 2020 554e 5553 4544 2878 290a 2364      UNUSED(x).#d
-00083d00: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-00083d10: 6465 7374 726f 7928 7829 2055 4e55 5345  destroy(x) UNUSE
-00083d20: 4428 7829 0a23 6465 6669 6e65 2067 676d  D(x).#define ggm
-00083d30: 6c5f 6c6f 636b 5f6c 6f63 6b28 7829 2020  l_lock_lock(x)  
-00083d40: 2020 554e 5553 4544 2878 290a 2364 6566    UNUSED(x).#def
-00083d50: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 756e  ine ggml_lock_un
-00083d60: 6c6f 636b 2878 2920 2055 4e55 5345 4428  lock(x)  UNUSED(
-00083d70: 7829 0a0a 2364 6566 696e 6520 4747 4d4c  x)..#define GGML
-00083d80: 5f4c 4f43 4b5f 494e 4954 4941 4c49 5a45  _LOCK_INITIALIZE
-00083d90: 5220 300a 0a74 7970 6564 6566 2070 7468  R 0..typedef pth
-00083da0: 7265 6164 5f74 2067 676d 6c5f 7468 7265  read_t ggml_thre
-00083db0: 6164 5f74 3b0a 0a23 6465 6669 6e65 2067  ad_t;..#define g
-00083dc0: 676d 6c5f 7468 7265 6164 5f63 7265 6174  gml_thread_creat
-00083dd0: 6520 7074 6872 6561 645f 6372 6561 7465  e pthread_create
-00083de0: 0a23 6465 6669 6e65 2067 676d 6c5f 7468  .#define ggml_th
-00083df0: 7265 6164 5f6a 6f69 6e20 2020 7074 6872  read_join   pthr
-00083e00: 6561 645f 6a6f 696e 0a0a 2365 6c73 650a  ead_join..#else.
-00083e10: 0a2f 2f74 7970 6564 6566 2070 7468 7265  .//typedef pthre
-00083e20: 6164 5f73 7069 6e6c 6f63 6b5f 7420 6767  ad_spinlock_t gg
-00083e30: 6d6c 5f6c 6f63 6b5f 743b 0a0a 2f2f 2364  ml_lock_t;..//#d
-00083e40: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-00083e50: 696e 6974 2878 2920 7074 6872 6561 645f  init(x) pthread_
-00083e60: 7370 696e 5f69 6e69 7428 782c 2050 5448  spin_init(x, PTH
-00083e70: 5245 4144 5f50 524f 4345 5353 5f50 5249  READ_PROCESS_PRI
-00083e80: 5641 5445 290a 2f2f 2364 6566 696e 6520  VATE).//#define 
-00083e90: 6767 6d6c 5f6c 6f63 6b5f 6465 7374 726f  ggml_lock_destro
-00083ea0: 7920 7074 6872 6561 645f 7370 696e 5f64  y pthread_spin_d
-00083eb0: 6573 7472 6f79 0a2f 2f23 6465 6669 6e65  estroy.//#define
-00083ec0: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b20   ggml_lock_lock 
-00083ed0: 2020 2070 7468 7265 6164 5f73 7069 6e5f     pthread_spin_
-00083ee0: 6c6f 636b 0a2f 2f23 6465 6669 6e65 2067  lock.//#define g
-00083ef0: 676d 6c5f 6c6f 636b 5f75 6e6c 6f63 6b20  gml_lock_unlock 
-00083f00: 2070 7468 7265 6164 5f73 7069 6e5f 756e   pthread_spin_un
-00083f10: 6c6f 636b 0a0a 7479 7065 6465 6620 696e  lock..typedef in
-00083f20: 7420 6767 6d6c 5f6c 6f63 6b5f 743b 0a0a  t ggml_lock_t;..
-00083f30: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
-00083f40: 6b5f 696e 6974 2878 2920 2020 2055 4e55  k_init(x)    UNU
-00083f50: 5345 4428 7829 0a23 6465 6669 6e65 2067  SED(x).#define g
-00083f60: 676d 6c5f 6c6f 636b 5f64 6573 7472 6f79  gml_lock_destroy
-00083f70: 2878 2920 554e 5553 4544 2878 290a 2369  (x) UNUSED(x).#i
-00083f80: 6620 6465 6669 6e65 6428 5f5f 7838 365f  f defined(__x86_
-00083f90: 3634 5f5f 2920 7c7c 2028 6465 6669 6e65  64__) || (define
-00083fa0: 6428 5f4d 5343 5f56 4552 2920 2626 2064  d(_MSC_VER) && d
-00083fb0: 6566 696e 6564 285f 4d5f 414d 4436 3429  efined(_M_AMD64)
-00083fc0: 290a 2364 6566 696e 6520 6767 6d6c 5f6c  ).#define ggml_l
-00083fd0: 6f63 6b5f 6c6f 636b 2878 2920 2020 205f  ock_lock(x)    _
-00083fe0: 6d6d 5f70 6175 7365 2829 0a23 656c 7365  mm_pause().#else
-00083ff0: 0a23 6465 6669 6e65 2067 676d 6c5f 6c6f  .#define ggml_lo
-00084000: 636b 5f6c 6f63 6b28 7829 2020 2020 554e  ck_lock(x)    UN
-00084010: 5553 4544 2878 290a 2365 6e64 6966 0a23  USED(x).#endif.#
-00084020: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
-00084030: 5f75 6e6c 6f63 6b28 7829 2020 554e 5553  _unlock(x)  UNUS
-00084040: 4544 2878 290a 0a23 6465 6669 6e65 2047  ED(x)..#define G
-00084050: 474d 4c5f 4c4f 434b 5f49 4e49 5449 414c  GML_LOCK_INITIAL
-00084060: 495a 4552 2030 0a0a 7479 7065 6465 6620  IZER 0..typedef 
-00084070: 7074 6872 6561 645f 7420 6767 6d6c 5f74  pthread_t ggml_t
-00084080: 6872 6561 645f 743b 0a0a 2364 6566 696e  hread_t;..#defin
-00084090: 6520 6767 6d6c 5f74 6872 6561 645f 6372  e ggml_thread_cr
-000840a0: 6561 7465 2070 7468 7265 6164 5f63 7265  eate pthread_cre
-000840b0: 6174 650a 2364 6566 696e 6520 6767 6d6c  ate.#define ggml
-000840c0: 5f74 6872 6561 645f 6a6f 696e 2020 2070  _thread_join   p
-000840d0: 7468 7265 6164 5f6a 6f69 6e0a 0a23 656e  thread_join..#en
-000840e0: 6469 660a 0a23 6966 6465 6620 5f5f 6c69  dif..#ifdef __li
-000840f0: 6e75 785f 5f0a 766f 6964 2073 6574 5f6e  nux__.void set_n
-00084100: 756d 615f 7468 7265 6164 5f61 6666 696e  uma_thread_affin
-00084110: 6974 7928 696e 7420 7468 7265 6164 5f6e  ity(int thread_n
-00084120: 2c20 696e 7420 6e5f 7468 7265 6164 7329  , int n_threads)
-00084130: 207b 0a20 2020 2069 6620 2821 6767 6d6c   {.    if (!ggml
-00084140: 5f69 735f 6e75 6d61 2829 2920 7b0a 2020  _is_numa()) {.  
-00084150: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00084160: 2020 7d0a 0a20 2020 202f 2f20 7275 6e20    }..    // run 
-00084170: 7468 7265 6164 206f 6e20 6e6f 6465 5f6e  thread on node_n
-00084180: 756d 2074 6872 6561 645f 6e20 2f20 2874  um thread_n / (t
-00084190: 6872 6561 6473 2070 6572 206e 6f64 6529  hreads per node)
-000841a0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-000841b0: 6f64 655f 6e75 6d20 3d20 7468 7265 6164  ode_num = thread
-000841c0: 5f6e 202f 2028 286e 5f74 6872 6561 6473  _n / ((n_threads
-000841d0: 202b 2067 5f73 7461 7465 2e6e 756d 612e   + g_state.numa.
-000841e0: 6e5f 6e6f 6465 7320 2d20 3129 202f 2067  n_nodes - 1) / g
-000841f0: 5f73 7461 7465 2e6e 756d 612e 6e5f 6e6f  _state.numa.n_no
-00084200: 6465 7329 3b0a 2020 2020 7374 7275 6374  des);.    struct
-00084210: 2067 676d 6c5f 6e75 6d61 5f6e 6f64 6520   ggml_numa_node 
-00084220: 2a20 6e6f 6465 203d 2026 675f 7374 6174  * node = &g_stat
-00084230: 652e 6e75 6d61 2e6e 6f64 6573 5b6e 6f64  e.numa.nodes[nod
-00084240: 655f 6e75 6d5d 3b0a 2020 2020 7369 7a65  e_num];.    size
-00084250: 5f74 2073 6574 7369 7a65 203d 2043 5055  _t setsize = CPU
-00084260: 5f41 4c4c 4f43 5f53 495a 4528 675f 7374  _ALLOC_SIZE(g_st
-00084270: 6174 652e 6e75 6d61 2e74 6f74 616c 5f63  ate.numa.total_c
-00084280: 7075 7329 3b0a 0a20 2020 2063 7075 5f73  pus);..    cpu_s
-00084290: 6574 5f74 202a 2063 7075 7320 3d20 4350  et_t * cpus = CP
-000842a0: 555f 414c 4c4f 4328 675f 7374 6174 652e  U_ALLOC(g_state.
-000842b0: 6e75 6d61 2e74 6f74 616c 5f63 7075 7329  numa.total_cpus)
-000842c0: 3b0a 2020 2020 4350 555f 5a45 524f 5f53  ;.    CPU_ZERO_S
-000842d0: 2873 6574 7369 7a65 2c20 6370 7573 293b  (setsize, cpus);
-000842e0: 0a20 2020 2066 6f72 2028 7369 7a65 5f74  .    for (size_t
-000842f0: 2069 203d 2030 3b20 6920 3c20 6e6f 6465   i = 0; i < node
-00084300: 2d3e 6e5f 6370 7573 3b20 2b2b 6929 207b  ->n_cpus; ++i) {
-00084310: 0a20 2020 2020 2020 2043 5055 5f53 4554  .        CPU_SET
-00084320: 5f53 286e 6f64 652d 3e63 7075 735b 695d  _S(node->cpus[i]
-00084330: 2c20 7365 7473 697a 652c 2063 7075 7329  , setsize, cpus)
-00084340: 3b0a 2020 2020 7d0a 0a20 2020 2069 6e74  ;.    }..    int
-00084350: 2072 7620 3d20 7074 6872 6561 645f 7365   rv = pthread_se
-00084360: 7461 6666 696e 6974 795f 6e70 2870 7468  taffinity_np(pth
-00084370: 7265 6164 5f73 656c 6628 292c 2073 6574  read_self(), set
-00084380: 7369 7a65 2c20 6370 7573 293b 0a20 2020  size, cpus);.   
-00084390: 2069 6620 2872 7629 207b 0a20 2020 2020   if (rv) {.     
-000843a0: 2020 2020 2020 2066 7072 696e 7466 2873         fprintf(s
-000843b0: 7464 6572 722c 2022 7761 726e 696e 673a  tderr, "warning:
-000843c0: 2070 7468 7265 6164 5f73 6574 6166 6669   pthread_setaffi
-000843d0: 6e69 7479 5f6e 7028 2920 6661 696c 6564  nity_np() failed
-000843e0: 3a20 2573 5c6e 222c 0a20 2020 2020 2020  : %s\n",.       
-000843f0: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00084400: 6572 726f 7228 7276 2929 3b0a 2020 2020  error(rv));.    
-00084410: 7d0a 0a20 2020 2043 5055 5f46 5245 4528  }..    CPU_FREE(
-00084420: 6370 7573 293b 0a7d 0a0a 766f 6964 2063  cpus);.}..void c
-00084430: 6c65 6172 5f6e 756d 615f 7468 7265 6164  lear_numa_thread
-00084440: 5f61 6666 696e 6974 7928 766f 6964 2920  _affinity(void) 
-00084450: 7b0a 2020 2020 6966 2028 2167 676d 6c5f  {.    if (!ggml_
-00084460: 6973 5f6e 756d 6128 2929 207b 0a20 2020  is_numa()) {.   
-00084470: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-00084480: 207d 0a0a 2020 2020 7369 7a65 5f74 2073   }..    size_t s
-00084490: 6574 7369 7a65 203d 2043 5055 5f41 4c4c  etsize = CPU_ALL
-000844a0: 4f43 5f53 495a 4528 675f 7374 6174 652e  OC_SIZE(g_state.
-000844b0: 6e75 6d61 2e74 6f74 616c 5f63 7075 7329  numa.total_cpus)
-000844c0: 3b0a 0a20 2020 2063 7075 5f73 6574 5f74  ;..    cpu_set_t
-000844d0: 202a 2063 7075 7320 3d20 4350 555f 414c   * cpus = CPU_AL
-000844e0: 4c4f 4328 675f 7374 6174 652e 6e75 6d61  LOC(g_state.numa
-000844f0: 2e74 6f74 616c 5f63 7075 7329 3b0a 2020  .total_cpus);.  
-00084500: 2020 4350 555f 5a45 524f 5f53 2873 6574    CPU_ZERO_S(set
-00084510: 7369 7a65 2c20 6370 7573 293b 0a20 2020  size, cpus);.   
-00084520: 2066 6f72 2028 756e 7369 676e 6564 2069   for (unsigned i
-00084530: 203d 2030 3b20 6920 3c20 675f 7374 6174   = 0; i < g_stat
-00084540: 652e 6e75 6d61 2e74 6f74 616c 5f63 7075  e.numa.total_cpu
-00084550: 733b 202b 2b69 2920 7b0a 2020 2020 2020  s; ++i) {.      
-00084560: 2020 4350 555f 5345 545f 5328 692c 2073    CPU_SET_S(i, s
-00084570: 6574 7369 7a65 2c20 6370 7573 293b 0a20  etsize, cpus);. 
-00084580: 2020 207d 0a0a 2020 2020 696e 7420 7276     }..    int rv
-00084590: 203d 2070 7468 7265 6164 5f73 6574 6166   = pthread_setaf
-000845a0: 6669 6e69 7479 5f6e 7028 7074 6872 6561  finity_np(pthrea
-000845b0: 645f 7365 6c66 2829 2c20 7365 7473 697a  d_self(), setsiz
-000845c0: 652c 2063 7075 7329 3b0a 2020 2020 6966  e, cpus);.    if
-000845d0: 2028 7276 2920 7b0a 2020 2020 2020 2020   (rv) {.        
-000845e0: 6670 7269 6e74 6628 7374 6465 7272 2c20  fprintf(stderr, 
-000845f0: 2277 6172 6e69 6e67 3a20 7074 6872 6561  "warning: pthrea
-00084600: 645f 7365 7461 6666 696e 6974 795f 6e70  d_setaffinity_np
-00084610: 2829 2066 6169 6c65 643a 2025 735c 6e22  () failed: %s\n"
-00084620: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-00084630: 7265 7272 6f72 2872 7629 293b 0a20 2020  rerror(rv));.   
-00084640: 207d 0a0a 2020 2020 4350 555f 4652 4545   }..    CPU_FREE
-00084650: 2863 7075 7329 3b0a 7d0a 2365 6c73 650a  (cpus);.}.#else.
-00084660: 2f2f 2054 4f44 4f3a 2057 696e 646f 7773  // TODO: Windows
-00084670: 2065 7463 2e0a 2f2f 2028 7468 6520 6c69   etc..// (the li
-00084680: 6e75 7820 696d 706c 656d 656e 7461 7469  nux implementati
-00084690: 6f6e 206d 6179 2061 6c73 6f20 776f 726b  on may also work
-000846a0: 206f 6e20 4253 442c 2073 6f6d 656f 6e65   on BSD, someone
-000846b0: 2073 686f 756c 6420 7465 7374 290a 766f   should test).vo
-000846c0: 6964 2073 6574 5f6e 756d 615f 7468 7265  id set_numa_thre
-000846d0: 6164 5f61 6666 696e 6974 7928 696e 7420  ad_affinity(int 
-000846e0: 7468 7265 6164 5f6e 2c20 696e 7420 6e5f  thread_n, int n_
-000846f0: 7468 7265 6164 7329 207b 2055 4e55 5345  threads) { UNUSE
-00084700: 4428 7468 7265 6164 5f6e 293b 2055 4e55  D(thread_n); UNU
-00084710: 5345 4428 6e5f 7468 7265 6164 7329 3b20  SED(n_threads); 
-00084720: 207d 0a76 6f69 6420 636c 6561 725f 6e75   }.void clear_nu
-00084730: 6d61 5f74 6872 6561 645f 6166 6669 6e69  ma_thread_affini
-00084740: 7479 2876 6f69 6429 207b 7d0a 2365 6e64  ty(void) {}.#end
-00084750: 6966 0a0a 7374 7275 6374 2067 676d 6c5f  if..struct ggml_
-00084760: 636f 6d70 7574 655f 7374 6174 655f 7368  compute_state_sh
-00084770: 6172 6564 207b 0a20 2020 2073 7472 7563  ared {.    struc
-00084780: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-00084790: 6367 7261 7068 3b0a 0a20 2020 2069 6e74  cgraph;..    int
-000847a0: 3634 5f74 2070 6572 665f 6e6f 6465 5f73  64_t perf_node_s
-000847b0: 7461 7274 5f63 7963 6c65 733b 0a20 2020  tart_cycles;.   
-000847c0: 2069 6e74 3634 5f74 2070 6572 665f 6e6f   int64_t perf_no
-000847d0: 6465 5f73 7461 7274 5f74 696d 655f 7573  de_start_time_us
-000847e0: 3b0a 0a20 2020 2069 6e74 206e 5f74 6872  ;..    int n_thr
-000847f0: 6561 6473 3b0a 0a20 2020 202f 2f20 7379  eads;..    // sy
-00084800: 6e63 6872 6f6e 697a 6174 696f 6e20 7072  nchronization pr
-00084810: 696d 6974 6976 6573 0a20 2020 2061 746f  imitives.    ato
-00084820: 6d69 635f 696e 7420 6e5f 6163 7469 7665  mic_int n_active
-00084830: 3b20 2f2f 206e 756d 2061 6374 6976 6520  ; // num active 
-00084840: 7468 7265 6164 730a 2020 2020 6174 6f6d  threads.    atom
-00084850: 6963 5f69 6e74 206e 6f64 655f 6e3b 2020  ic_int node_n;  
-00084860: 202f 2f20 6163 7469 7665 2067 7261 7068   // active graph
-00084870: 206e 6f64 650a 7d3b 0a0a 7374 7275 6374   node.};..struct
-00084880: 2067 676d 6c5f 636f 6d70 7574 655f 7374   ggml_compute_st
-00084890: 6174 6520 7b0a 2020 2020 6767 6d6c 5f74  ate {.    ggml_t
-000848a0: 6872 6561 645f 7420 7468 7264 3b0a 2020  hread_t thrd;.  
-000848b0: 2020 696e 7420 6974 683b 0a20 2020 2073    int ith;.    s
-000848c0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-000848d0: 7465 5f73 7461 7465 5f73 6861 7265 6420  te_state_shared 
-000848e0: 2a20 7368 6172 6564 3b0a 7d3b 0a0a 7374  * shared;.};..st
-000848f0: 6174 6963 2076 6f69 6420 6767 6d6c 5f67  atic void ggml_g
-00084900: 7261 7068 5f63 6f6d 7075 7465 5f70 6572  raph_compute_per
-00084910: 665f 7374 6174 735f 6e6f 6465 2873 7472  f_stats_node(str
-00084920: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00084930: 2a20 6e6f 6465 2c20 636f 6e73 7420 7374  * node, const st
-00084940: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00084950: 655f 7374 6174 655f 7368 6172 6564 202a  e_state_shared *
-00084960: 2073 7429 207b 0a20 2020 2069 6e74 3634   st) {.    int64
-00084970: 5f74 2063 7963 6c65 735f 6375 7220 203d  _t cycles_cur  =
-00084980: 2067 676d 6c5f 7065 7266 5f63 7963 6c65   ggml_perf_cycle
-00084990: 7328 2920 202d 2073 742d 3e70 6572 665f  s()  - st->perf_
-000849a0: 6e6f 6465 5f73 7461 7274 5f63 7963 6c65  node_start_cycle
-000849b0: 733b 0a20 2020 2069 6e74 3634 5f74 2074  s;.    int64_t t
-000849c0: 696d 655f 7573 5f63 7572 203d 2067 676d  ime_us_cur = ggm
-000849d0: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
-000849e0: 202d 2073 742d 3e70 6572 665f 6e6f 6465   - st->perf_node
-000849f0: 5f73 7461 7274 5f74 696d 655f 7573 3b0a  _start_time_us;.
-00084a00: 0a20 2020 206e 6f64 652d 3e70 6572 665f  .    node->perf_
-00084a10: 7275 6e73 2b2b 3b0a 2020 2020 6e6f 6465  runs++;.    node
-00084a20: 2d3e 7065 7266 5f63 7963 6c65 7320 202b  ->perf_cycles  +
-00084a30: 3d20 6379 636c 6573 5f63 7572 3b0a 2020  = cycles_cur;.  
-00084a40: 2020 6e6f 6465 2d3e 7065 7266 5f74 696d    node->perf_tim
-00084a50: 655f 7573 202b 3d20 7469 6d65 5f75 735f  e_us += time_us_
-00084a60: 6375 723b 0a7d 0a0a 7374 6174 6963 2074  cur;.}..static t
-00084a70: 6872 6561 645f 7265 745f 7420 6767 6d6c  hread_ret_t ggml
-00084a80: 5f67 7261 7068 5f63 6f6d 7075 7465 5f74  _graph_compute_t
-00084a90: 6872 6561 6428 766f 6964 202a 2064 6174  hread(void * dat
-00084aa0: 6129 207b 0a20 2020 2073 7472 7563 7420  a) {.    struct 
-00084ab0: 6767 6d6c 5f63 6f6d 7075 7465 5f73 7461  ggml_compute_sta
-00084ac0: 7465 202a 2073 7461 7465 203d 2028 7374  te * state = (st
-00084ad0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00084ae0: 655f 7374 6174 6520 2a29 2064 6174 613b  e_state *) data;
-00084af0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-00084b00: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
-00084b10: 203d 2073 7461 7465 2d3e 7368 6172 6564   = state->shared
-00084b20: 2d3e 6367 7261 7068 3b0a 0a20 2020 2063  ->cgraph;..    c
-00084b30: 6f6e 7374 2069 6e74 206e 5f74 6872 6561  onst int n_threa
-00084b40: 6473 203d 2073 7461 7465 2d3e 7368 6172  ds = state->shar
-00084b50: 6564 2d3e 6e5f 7468 7265 6164 733b 0a20  ed->n_threads;. 
-00084b60: 2020 2073 6574 5f6e 756d 615f 7468 7265     set_numa_thre
-00084b70: 6164 5f61 6666 696e 6974 7928 7374 6174  ad_affinity(stat
-00084b80: 652d 3e69 7468 2c20 6e5f 7468 7265 6164  e->ith, n_thread
-00084b90: 7329 3b0a 0a20 2020 2069 6e74 206e 6f64  s);..    int nod
-00084ba0: 655f 6e20 3d20 2d31 3b0a 0a20 2020 2077  e_n = -1;..    w
-00084bb0: 6869 6c65 2028 7472 7565 2920 7b0a 2020  hile (true) {.  
-00084bc0: 2020 2020 2020 6966 2028 6174 6f6d 6963        if (atomic
-00084bd0: 5f66 6574 6368 5f73 7562 2826 7374 6174  _fetch_sub(&stat
-00084be0: 652d 3e73 6861 7265 642d 3e6e 5f61 6374  e->shared->n_act
-00084bf0: 6976 652c 2031 2920 3d3d 2031 2920 7b0a  ive, 1) == 1) {.
-00084c00: 2020 2020 2020 2020 2020 2020 2f2f 2061              // a
-00084c10: 6c6c 206f 7468 6572 2074 6872 6561 6473  ll other threads
-00084c20: 2061 7265 2066 696e 6973 6865 6420 616e   are finished an
-00084c30: 6420 7370 696e 6e69 6e67 0a20 2020 2020  d spinning.     
-00084c40: 2020 2020 2020 202f 2f20 646f 2066 696e         // do fin
-00084c50: 616c 697a 6520 616e 6420 696e 6974 2068  alize and init h
-00084c60: 6572 6520 736f 2077 6520 646f 6e27 7420  ere so we don't 
-00084c70: 6861 7665 2073 796e 6368 726f 6e69 7a65  have synchronize
-00084c80: 2061 6761 696e 0a20 2020 2020 2020 2020   again.         
-00084c90: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00084ca0: 6f6d 7075 7465 5f70 6172 616d 7320 7061  ompute_params pa
-00084cb0: 7261 6d73 203d 207b 0a20 2020 2020 2020  rams = {.       
-00084cc0: 2020 2020 2020 2020 202f 2a2e 7479 7065           /*.type
-00084cd0: 2020 3d2a 2f20 4747 4d4c 5f54 4153 4b5f    =*/ GGML_TASK_
-00084ce0: 4649 4e41 4c49 5a45 2c0a 2020 2020 2020  FINALIZE,.      
-00084cf0: 2020 2020 2020 2020 2020 2f2a 2e69 7468            /*.ith
-00084d00: 2020 203d 2a2f 2030 2c0a 2020 2020 2020     =*/ 0,.      
-00084d10: 2020 2020 2020 2020 2020 2f2a 2e6e 7468            /*.nth
-00084d20: 2020 203d 2a2f 2030 2c0a 2020 2020 2020     =*/ 0,.      
-00084d30: 2020 2020 2020 2020 2020 2f2a 2e77 7369            /*.wsi
-00084d40: 7a65 203d 2a2f 2063 6772 6170 682d 3e77  ze =*/ cgraph->w
-00084d50: 6f72 6b20 3f20 6767 6d6c 5f6e 6279 7465  ork ? ggml_nbyte
-00084d60: 7328 6367 7261 7068 2d3e 776f 726b 2920  s(cgraph->work) 
-00084d70: 3a20 302c 0a20 2020 2020 2020 2020 2020  : 0,.           
-00084d80: 2020 2020 202f 2a2e 7764 6174 6120 3d2a       /*.wdata =*
-00084d90: 2f20 6367 7261 7068 2d3e 776f 726b 203f  / cgraph->work ?
-00084da0: 2063 6772 6170 682d 3e77 6f72 6b2d 3e64   cgraph->work->d
-00084db0: 6174 6120 3a20 4e55 4c4c 2c0a 2020 2020  ata : NULL,.    
-00084dc0: 2020 2020 2020 2020 7d3b 0a0a 2020 2020          };..    
-00084dd0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-00084de0: 5f6e 2021 3d20 2d31 2920 7b0a 2020 2020  _n != -1) {.    
-00084df0: 2020 2020 2020 2020 2020 2020 2f2a 2046              /* F
-00084e00: 494e 414c 495a 4520 2a2f 0a20 2020 2020  INALIZE */.     
-00084e10: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00084e20: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00084e30: 6e6f 6465 203d 2073 7461 7465 2d3e 7368  node = state->sh
-00084e40: 6172 6564 2d3e 6367 7261 7068 2d3e 6e6f  ared->cgraph->no
-00084e50: 6465 735b 6e6f 6465 5f6e 5d3b 0a20 2020  des[node_n];.   
-00084e60: 2020 2020 2020 2020 2020 2020 2070 6172               par
-00084e70: 616d 732e 6e74 6820 3d20 6e6f 6465 2d3e  ams.nth = node->
-00084e80: 6e5f 7461 736b 733b 0a20 2020 2020 2020  n_tasks;.       
-00084e90: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00084ea0: 6d70 7574 655f 666f 7277 6172 6428 2670  mpute_forward(&p
-00084eb0: 6172 616d 732c 206e 6f64 6529 3b0a 2020  arams, node);.  
-00084ec0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00084ed0: 6d6c 5f67 7261 7068 5f63 6f6d 7075 7465  ml_graph_compute
-00084ee0: 5f70 6572 665f 7374 6174 735f 6e6f 6465  _perf_stats_node
-00084ef0: 286e 6f64 652c 2073 7461 7465 2d3e 7368  (node, state->sh
-00084f00: 6172 6564 293b 0a20 2020 2020 2020 2020  ared);.         
-00084f10: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00084f20: 2020 2f2f 2064 6973 7472 6962 7574 6520    // distribute 
-00084f30: 6e65 7720 776f 726b 206f 7220 6578 6563  new work or exec
-00084f40: 7574 6520 6974 2064 6972 6563 7420 6966  ute it direct if
-00084f50: 2031 540a 2020 2020 2020 2020 2020 2020   1T.            
-00084f60: 7768 696c 6520 282b 2b6e 6f64 655f 6e20  while (++node_n 
-00084f70: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
-00084f80: 7329 207b 0a20 2020 2020 2020 2020 2020  s) {.           
-00084f90: 2020 2020 2047 474d 4c5f 5052 494e 545f       GGML_PRINT_
-00084fa0: 4445 4255 475f 3528 2225 733a 2025 642f  DEBUG_5("%s: %d/
-00084fb0: 2564 5c6e 222c 205f 5f66 756e 635f 5f2c  %d\n", __func__,
-00084fc0: 206e 6f64 655f 6e2c 2063 6772 6170 682d   node_n, cgraph-
-00084fd0: 3e6e 5f6e 6f64 6573 293b 0a0a 2020 2020  >n_nodes);..    
-00084fe0: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-00084ff0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00085000: 206e 6f64 6520 3d20 6367 7261 7068 2d3e   node = cgraph->
-00085010: 6e6f 6465 735b 6e6f 6465 5f6e 5d3b 0a0a  nodes[node_n];..
-00085020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085030: 7374 6174 652d 3e73 6861 7265 642d 3e70  state->shared->p
-00085040: 6572 665f 6e6f 6465 5f73 7461 7274 5f63  erf_node_start_c
-00085050: 7963 6c65 7320 203d 2067 676d 6c5f 7065  ycles  = ggml_pe
-00085060: 7266 5f63 7963 6c65 7328 293b 0a20 2020  rf_cycles();.   
-00085070: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00085080: 7465 2d3e 7368 6172 6564 2d3e 7065 7266  te->shared->perf
-00085090: 5f6e 6f64 655f 7374 6172 745f 7469 6d65  _node_start_time
-000850a0: 5f75 7320 3d20 6767 6d6c 5f70 6572 665f  _us = ggml_perf_
-000850b0: 7469 6d65 5f75 7328 293b 0a0a 2020 2020  time_us();..    
-000850c0: 2020 2020 2020 2020 2020 2020 2f2a 2049              /* I
-000850d0: 4e49 5420 2a2f 0a20 2020 2020 2020 2020  NIT */.         
-000850e0: 2020 2020 2020 2070 6172 616d 732e 7479         params.ty
-000850f0: 7065 203d 2047 474d 4c5f 5441 534b 5f49  pe = GGML_TASK_I
-00085100: 4e49 543b 0a20 2020 2020 2020 2020 2020  NIT;.           
-00085110: 2020 2020 2070 6172 616d 732e 6e74 6820       params.nth 
-00085120: 203d 206e 6f64 652d 3e6e 5f74 6173 6b73   = node->n_tasks
-00085130: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00085140: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00085150: 6f72 7761 7264 2826 7061 7261 6d73 2c20  orward(&params, 
-00085160: 6e6f 6465 293b 0a0a 2020 2020 2020 2020  node);..        
-00085170: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-00085180: 2d3e 6e5f 7461 736b 7320 3d3d 2031 2920  ->n_tasks == 1) 
-00085190: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000851a0: 2020 2020 2020 2f2f 2054 4f44 4f3a 206d        // TODO: m
-000851b0: 6179 6265 2070 7573 6820 6e6f 6465 5f6e  aybe push node_n
-000851c0: 2074 6f20 7468 6520 6174 6f6d 6963 2062   to the atomic b
-000851d0: 7574 2069 6620 6f74 6865 7220 7468 7265  ut if other thre
-000851e0: 6164 7320 7365 6520 6e5f 7461 736b 7320  ads see n_tasks 
-000851f0: 6973 2031 2c0a 2020 2020 2020 2020 2020  is 1,.          
-00085200: 2020 2020 2020 2020 2020 2f2f 2074 6865            // the
-00085210: 7920 646f 2073 6f6d 6574 6869 6e67 206d  y do something m
-00085220: 6f72 6520 6566 6669 6369 656e 7420 7468  ore efficient th
-00085230: 616e 2073 7069 6e6e 696e 6720 283f 290a  an spinning (?).
+00082490: 2020 2020 6e62 302a 6f70 7430 2d3e 6e65      nb0*opt0->ne
+000824a0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+000824b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000824c0: 2020 2020 2020 2020 206e 6230 2a6f 7074           nb0*opt
+000824d0: 302d 3e6e 655b 305d 2a6f 7074 302d 3e6e  0->ne[0]*opt0->n
+000824e0: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
+000824f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082500: 2020 2020 2020 2020 2020 6e62 302a 6f70            nb0*op
+00082510: 7430 2d3e 6e65 5b30 5d2a 6f70 7430 2d3e  t0->ne[0]*opt0->
+00082520: 6e65 5b31 5d2a 6f70 7430 2d3e 6e65 5b32  ne[1]*opt0->ne[2
+00082530: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00082540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082550: 2020 2020 2020 206f 6666 7365 7429 3b0a         offset);.
+00082560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082570: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00082580: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
+00082590: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+000825a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000825b0: 6f70 7430 2d3e 6772 6164 203d 2067 676d  opt0->grad = ggm
+000825c0: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
+000825d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000825e0: 2020 2020 2020 2020 2020 2020 6f70 7430              opt0
+000825f0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+00082600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082610: 2020 2020 6772 6164 5f76 2c0a 2020 2020      grad_v,.    
+00082620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082630: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+00082640: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00082650: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00082660: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00082670: 2063 6173 6520 4747 4d4c 5f4f 505f 464c   case GGML_OP_FL
+00082680: 4153 485f 4646 3a0a 2020 2020 2020 2020  ASH_FF:.        
+00082690: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000826a0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+000826b0: 5428 6661 6c73 6529 3b20 2f2f 206e 6f74  T(false); // not
+000826c0: 2073 7570 706f 7274 6564 0a20 2020 2020   supported.     
+000826d0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000826e0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000826f0: 4c5f 4f50 5f46 4c41 5348 5f41 5454 4e5f  L_OP_FLASH_ATTN_
+00082700: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
+00082710: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00082720: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00082730: 6661 6c73 6529 3b20 2f2f 206e 6f74 2073  false); // not s
+00082740: 7570 706f 7274 6564 0a20 2020 2020 2020  upported.       
+00082750: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00082760: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00082770: 4f50 5f57 494e 5f50 4152 543a 0a20 2020  OP_WIN_PART:.   
+00082780: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00082790: 505f 5749 4e5f 554e 5041 5254 3a0a 2020  P_WIN_UNPART:.  
+000827a0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000827b0: 4f50 5f4d 4150 5f55 4e41 5259 3a0a 2020  OP_MAP_UNARY:.  
+000827c0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000827d0: 4f50 5f4d 4150 5f42 494e 4152 593a 0a20  OP_MAP_BINARY:. 
+000827e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000827f0: 5f4f 505f 4d41 505f 4355 5354 4f4d 313a  _OP_MAP_CUSTOM1:
+00082800: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00082810: 4d4c 5f4f 505f 4d41 505f 4355 5354 4f4d  ML_OP_MAP_CUSTOM
+00082820: 323a 0a20 2020 2020 2020 2063 6173 6520  2:.        case 
+00082830: 4747 4d4c 5f4f 505f 4d41 505f 4355 5354  GGML_OP_MAP_CUST
+00082840: 4f4d 333a 0a20 2020 2020 2020 2020 2020  OM3:.           
+00082850: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00082860: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00082870: 616c 7365 293b 202f 2f20 6e6f 7420 7375  alse); // not su
+00082880: 7070 6f72 7465 640a 2020 2020 2020 2020  pported.        
+00082890: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000828a0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000828b0: 505f 4352 4f53 535f 454e 5452 4f50 595f  P_CROSS_ENTROPY_
+000828c0: 4c4f 5353 3a0a 2020 2020 2020 2020 2020  LOSS:.          
+000828d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000828e0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
+000828f0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00082900: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+00082910: 6772 6164 203d 2067 676d 6c5f 6164 645f  grad = ggml_add_
+00082920: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
+00082930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082940: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+00082950: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+00082960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082970: 2020 2020 2020 6767 6d6c 5f63 726f 7373        ggml_cross
+00082980: 5f65 6e74 726f 7079 5f6c 6f73 735f 6261  _entropy_loss_ba
+00082990: 636b 2863 7478 2c0a 2020 2020 2020 2020  ck(ctx,.        
+000829a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000829b0: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+000829c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000829d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000829e0: 2020 2020 2020 7372 6331 2c0a 2020 2020        src1,.    
+000829f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082a10: 7465 6e73 6f72 2d3e 6772 6164 292c 0a20  tensor->grad),. 
+00082a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082a30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00082a40: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+00082a50: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00082a60: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00082a70: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00082a80: 4c5f 4f50 5f43 524f 5353 5f45 4e54 524f  L_OP_CROSS_ENTRO
+00082a90: 5059 5f4c 4f53 535f 4241 434b 3a0a 2020  PY_LOSS_BACK:.  
+00082aa0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00082ab0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00082ac0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+00082ad0: 2f2f 206e 6f74 2073 7570 706f 7274 6564  // not supported
+00082ae0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00082af0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00082b00: 7365 2047 474d 4c5f 4f50 5f4e 4f4e 453a  se GGML_OP_NONE:
+00082b10: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00082b20: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00082b30: 2f20 6e6f 700a 2020 2020 2020 2020 2020  / nop.          
+00082b40: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00082b50: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00082b60: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
+00082b70: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00082b80: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00082b90: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+00082ba0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00082bb0: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+00082bc0: 6964 2067 676d 6c5f 7669 7369 745f 7061  id ggml_visit_pa
+00082bd0: 7265 6e74 7328 7374 7275 6374 2067 676d  rents(struct ggm
+00082be0: 6c5f 6367 7261 7068 202a 2063 6772 6170  l_cgraph * cgrap
+00082bf0: 682c 2073 7472 7563 7420 6767 6d6c 5f74  h, struct ggml_t
+00082c00: 656e 736f 7220 2a20 6e6f 6465 2920 7b0a  ensor * node) {.
+00082c10: 2020 2020 6966 2028 6e6f 6465 2d3e 6772      if (node->gr
+00082c20: 6164 203d 3d20 4e55 4c4c 2920 7b0a 2020  ad == NULL) {.  
+00082c30: 2020 2020 2020 2f2f 2074 6869 7320 7573        // this us
+00082c40: 7561 6c6c 7920 6861 7070 656e 7320 7768  ually happens wh
+00082c50: 656e 2077 6520 6765 6e65 7261 7465 2069  en we generate i
+00082c60: 6e74 6572 6d65 6469 6174 6520 6e6f 6465  ntermediate node
+00082c70: 7320 6672 6f6d 2063 6f6e 7374 616e 7473  s from constants
+00082c80: 2069 6e20 7468 6520 6261 636b 7761 7264   in the backward
+00082c90: 2070 6173 730a 2020 2020 2020 2020 2f2f   pass.        //
+00082ca0: 2069 7420 6361 6e20 616c 736f 2068 6170   it can also hap
+00082cb0: 7065 6e20 6475 7269 6e67 2066 6f72 7761  pen during forwa
+00082cc0: 7264 2070 6173 732c 2069 6620 7468 6520  rd pass, if the 
+00082cd0: 7573 6572 2070 6572 666f 726d 7320 636f  user performs co
+00082ce0: 6d70 7574 6174 696f 6e73 2077 6974 6820  mputations with 
+00082cf0: 636f 6e73 7461 6e74 730a 2020 2020 2020  constants.      
+00082d00: 2020 6966 2028 6e6f 6465 2d3e 6f70 2021    if (node->op !
+00082d10: 3d20 4747 4d4c 5f4f 505f 4e4f 4e45 2920  = GGML_OP_NONE) 
+00082d20: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
+00082d30: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+00082d40: 2822 2573 3a20 7761 726e 696e 673a 206e  ("%s: warning: n
+00082d50: 6f64 6520 2570 2068 6173 206e 6f20 6772  ode %p has no gr
+00082d60: 6164 2c20 6275 7420 6f70 2025 645c 6e22  ad, but op %d\n"
+00082d70: 2c20 5f5f 6675 6e63 5f5f 2c20 2876 6f69  , __func__, (voi
+00082d80: 6420 2a29 206e 6f64 652c 206e 6f64 652d  d *) node, node-
+00082d90: 3e6f 7029 3b0a 2020 2020 2020 2020 7d0a  >op);.        }.
+00082da0: 2020 2020 7d0a 0a20 2020 202f 2f20 6368      }..    // ch
+00082db0: 6563 6b20 6966 2061 6c72 6561 6479 2076  eck if already v
+00082dc0: 6973 6974 6564 0a20 2020 2066 6f72 2028  isited.    for (
+00082dd0: 696e 7420 6920 3d20 303b 2069 203c 2063  int i = 0; i < c
+00082de0: 6772 6170 682d 3e6e 5f6e 6f64 6573 3b20  graph->n_nodes; 
+00082df0: 692b 2b29 207b 0a20 2020 2020 2020 2069  i++) {.        i
+00082e00: 6620 2863 6772 6170 682d 3e6e 6f64 6573  f (cgraph->nodes
+00082e10: 5b69 5d20 3d3d 206e 6f64 6529 207b 0a20  [i] == node) {. 
+00082e20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00082e30: 6e3b 0a20 2020 2020 2020 207d 0a20 2020  n;.        }.   
+00082e40: 207d 0a0a 2020 2020 666f 7220 2869 6e74   }..    for (int
+00082e50: 2069 203d 2030 3b20 6920 3c20 6367 7261   i = 0; i < cgra
+00082e60: 7068 2d3e 6e5f 6c65 6166 733b 2069 2b2b  ph->n_leafs; i++
+00082e70: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
+00082e80: 6367 7261 7068 2d3e 6c65 6166 735b 695d  cgraph->leafs[i]
+00082e90: 203d 3d20 6e6f 6465 2920 7b0a 2020 2020   == node) {.    
+00082ea0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00082eb0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+00082ec0: 0a20 2020 2069 6620 286e 6f64 652d 3e73  .    if (node->s
+00082ed0: 7263 3029 207b 0a20 2020 2020 2020 2067  rc0) {.        g
+00082ee0: 676d 6c5f 7669 7369 745f 7061 7265 6e74  gml_visit_parent
+00082ef0: 7328 6367 7261 7068 2c20 6e6f 6465 2d3e  s(cgraph, node->
+00082f00: 7372 6330 293b 0a20 2020 207d 0a0a 2020  src0);.    }..  
+00082f10: 2020 6966 2028 6e6f 6465 2d3e 7372 6331    if (node->src1
+00082f20: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
+00082f30: 5f76 6973 6974 5f70 6172 656e 7473 2863  _visit_parents(c
+00082f40: 6772 6170 682c 206e 6f64 652d 3e73 7263  graph, node->src
+00082f50: 3129 3b0a 2020 2020 7d0a 0a20 2020 2066  1);.    }..    f
+00082f60: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00082f70: 203c 2047 474d 4c5f 4d41 585f 4f50 543b   < GGML_MAX_OPT;
+00082f80: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+00082f90: 6966 2028 6e6f 6465 2d3e 6f70 745b 695d  if (node->opt[i]
+00082fa0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00082fb0: 6767 6d6c 5f76 6973 6974 5f70 6172 656e  ggml_visit_paren
+00082fc0: 7473 2863 6772 6170 682c 206e 6f64 652d  ts(cgraph, node-
+00082fd0: 3e6f 7074 5b69 5d29 3b0a 2020 2020 2020  >opt[i]);.      
+00082fe0: 2020 7d0a 2020 2020 7d0a 0a20 2020 2069    }.    }..    i
+00082ff0: 6620 286e 6f64 652d 3e6f 7020 3d3d 2047  f (node->op == G
+00083000: 474d 4c5f 4f50 5f4e 4f4e 4520 2626 206e  GML_OP_NONE && n
+00083010: 6f64 652d 3e67 7261 6420 3d3d 204e 554c  ode->grad == NUL
+00083020: 4c29 207b 0a20 2020 2020 2020 202f 2f20  L) {.        // 
+00083030: 7265 6163 6865 6420 6120 6c65 6166 206e  reached a leaf n
+00083040: 6f64 652c 206e 6f74 2070 6172 7420 6f66  ode, not part of
+00083050: 2074 6865 2067 7261 6469 656e 7420 6772   the gradient gr
+00083060: 6170 6820 2865 2e67 2e20 6120 636f 6e73  aph (e.g. a cons
+00083070: 7461 6e74 290a 2020 2020 2020 2020 4747  tant).        GG
+00083080: 4d4c 5f41 5353 4552 5428 6367 7261 7068  ML_ASSERT(cgraph
+00083090: 2d3e 6e5f 6c65 6166 7320 3c20 4747 4d4c  ->n_leafs < GGML
+000830a0: 5f4d 4158 5f4e 4f44 4553 293b 0a0a 2020  _MAX_NODES);..  
+000830b0: 2020 2020 2020 6966 2028 7374 726c 656e        if (strlen
+000830c0: 286e 6f64 652d 3e6e 616d 6529 203d 3d20  (node->name) == 
+000830d0: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+000830e0: 2067 676d 6c5f 666f 726d 6174 5f6e 616d   ggml_format_nam
+000830f0: 6528 6e6f 6465 2c20 226c 6561 665f 2564  e(node, "leaf_%d
+00083100: 222c 2063 6772 6170 682d 3e6e 5f6c 6561  ", cgraph->n_lea
+00083110: 6673 293b 0a20 2020 2020 2020 207d 0a0a  fs);.        }..
+00083120: 2020 2020 2020 2020 6367 7261 7068 2d3e          cgraph->
+00083130: 6c65 6166 735b 6367 7261 7068 2d3e 6e5f  leafs[cgraph->n_
+00083140: 6c65 6166 735d 203d 206e 6f64 653b 0a20  leafs] = node;. 
+00083150: 2020 2020 2020 2063 6772 6170 682d 3e6e         cgraph->n
+00083160: 5f6c 6561 6673 2b2b 3b0a 2020 2020 7d20  _leafs++;.    } 
+00083170: 656c 7365 207b 0a20 2020 2020 2020 2047  else {.        G
+00083180: 474d 4c5f 4153 5345 5254 2863 6772 6170  GML_ASSERT(cgrap
+00083190: 682d 3e6e 5f6e 6f64 6573 203c 2047 474d  h->n_nodes < GGM
+000831a0: 4c5f 4d41 585f 4e4f 4445 5329 3b0a 0a20  L_MAX_NODES);.. 
+000831b0: 2020 2020 2020 2069 6620 2873 7472 6c65         if (strle
+000831c0: 6e28 6e6f 6465 2d3e 6e61 6d65 2920 3d3d  n(node->name) ==
+000831d0: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
+000831e0: 2020 6767 6d6c 5f66 6f72 6d61 745f 6e61    ggml_format_na
+000831f0: 6d65 286e 6f64 652c 2022 6e6f 6465 5f25  me(node, "node_%
+00083200: 6422 2c20 6367 7261 7068 2d3e 6e5f 6e6f  d", cgraph->n_no
+00083210: 6465 7329 3b0a 2020 2020 2020 2020 7d0a  des);.        }.
+00083220: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
+00083230: 3e6e 6f64 6573 5b63 6772 6170 682d 3e6e  >nodes[cgraph->n
+00083240: 5f6e 6f64 6573 5d20 3d20 6e6f 6465 3b0a  _nodes] = node;.
+00083250: 2020 2020 2020 2020 6367 7261 7068 2d3e          cgraph->
+00083260: 6772 6164 735b 6367 7261 7068 2d3e 6e5f  grads[cgraph->n_
+00083270: 6e6f 6465 735d 203d 206e 6f64 652d 3e67  nodes] = node->g
+00083280: 7261 643b 0a20 2020 2020 2020 2063 6772  rad;.        cgr
+00083290: 6170 682d 3e6e 5f6e 6f64 6573 2b2b 3b0a  aph->n_nodes++;.
+000832a0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+000832b0: 766f 6964 2067 676d 6c5f 6275 696c 645f  void ggml_build_
+000832c0: 666f 7277 6172 645f 696d 706c 2873 7472  forward_impl(str
+000832d0: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+000832e0: 2a20 6367 7261 7068 2c20 7374 7275 6374  * cgraph, struct
+000832f0: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
+00083300: 656e 736f 722c 2062 6f6f 6c20 6578 7061  ensor, bool expa
+00083310: 6e64 2920 7b0a 2020 2020 6966 2028 2165  nd) {.    if (!e
+00083320: 7870 616e 6429 207b 0a20 2020 2020 2020  xpand) {.       
+00083330: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
+00083340: 203d 2030 3b0a 2020 2020 2020 2020 6367   = 0;.        cg
+00083350: 7261 7068 2d3e 6e5f 6c65 6166 7320 3d20  raph->n_leafs = 
+00083360: 303b 0a20 2020 207d 0a0a 2020 2020 636f  0;.    }..    co
+00083370: 6e73 7420 696e 7420 6e30 203d 2063 6772  nst int n0 = cgr
+00083380: 6170 682d 3e6e 5f6e 6f64 6573 3b0a 2020  aph->n_nodes;.  
+00083390: 2020 554e 5553 4544 286e 3029 3b0a 0a20    UNUSED(n0);.. 
+000833a0: 2020 2067 676d 6c5f 7669 7369 745f 7061     ggml_visit_pa
+000833b0: 7265 6e74 7328 6367 7261 7068 2c20 7465  rents(cgraph, te
+000833c0: 6e73 6f72 293b 0a0a 2020 2020 636f 6e73  nsor);..    cons
+000833d0: 7420 696e 7420 6e5f 6e65 7720 3d20 6367  t int n_new = cg
+000833e0: 7261 7068 2d3e 6e5f 6e6f 6465 7320 2d20  raph->n_nodes - 
+000833f0: 6e30 3b0a 2020 2020 4747 4d4c 5f50 5249  n0;.    GGML_PRI
+00083400: 4e54 5f44 4542 5547 2822 2573 3a20 7669  NT_DEBUG("%s: vi
+00083410: 7369 7465 6420 2564 206e 6577 206e 6f64  sited %d new nod
+00083420: 6573 5c6e 222c 205f 5f66 756e 635f 5f2c  es\n", __func__,
+00083430: 206e 5f6e 6577 293b 0a0a 2020 2020 6966   n_new);..    if
+00083440: 2028 6e5f 6e65 7720 3e20 3029 207b 0a20   (n_new > 0) {. 
+00083450: 2020 2020 2020 202f 2f20 7468 6520 6c61         // the la
+00083460: 7374 2061 6464 6564 206e 6f64 6520 7368  st added node sh
+00083470: 6f75 6c64 2061 6c77 6179 7320 6265 2073  ould always be s
+00083480: 7461 7274 696e 6720 706f 696e 740a 2020  tarting point.  
+00083490: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+000834a0: 5428 6367 7261 7068 2d3e 6e6f 6465 735b  T(cgraph->nodes[
+000834b0: 6367 7261 7068 2d3e 6e5f 6e6f 6465 7320  cgraph->n_nodes 
+000834c0: 2d20 315d 203d 3d20 7465 6e73 6f72 293b  - 1] == tensor);
+000834d0: 0a20 2020 207d 0a7d 0a0a 766f 6964 2067  .    }.}..void g
+000834e0: 676d 6c5f 6275 696c 645f 666f 7277 6172  gml_build_forwar
+000834f0: 645f 6578 7061 6e64 2873 7472 7563 7420  d_expand(struct 
+00083500: 6767 6d6c 5f63 6772 6170 6820 2a20 6367  ggml_cgraph * cg
+00083510: 7261 7068 2c20 7374 7275 6374 2067 676d  raph, struct ggm
+00083520: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
+00083530: 7229 207b 0a20 2020 2067 676d 6c5f 6275  r) {.    ggml_bu
+00083540: 696c 645f 666f 7277 6172 645f 696d 706c  ild_forward_impl
+00083550: 2863 6772 6170 682c 2074 656e 736f 722c  (cgraph, tensor,
+00083560: 2074 7275 6529 3b0a 7d0a 0a73 7472 7563   true);.}..struc
+00083570: 7420 6767 6d6c 5f63 6772 6170 6820 6767  t ggml_cgraph gg
+00083580: 6d6c 5f62 7569 6c64 5f66 6f72 7761 7264  ml_build_forward
+00083590: 2873 7472 7563 7420 6767 6d6c 5f74 656e  (struct ggml_ten
+000835a0: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
+000835b0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000835c0: 6367 7261 7068 2072 6573 756c 7420 3d20  cgraph result = 
+000835d0: 7b0a 2020 2020 2020 2020 2f2a 2e6e 5f6e  {.        /*.n_n
+000835e0: 6f64 6573 2020 2020 2020 3d2a 2f20 302c  odes      =*/ 0,
+000835f0: 0a20 2020 2020 2020 202f 2a2e 6e5f 6c65  .        /*.n_le
+00083600: 6166 7320 2020 2020 203d 2a2f 2030 2c0a  afs      =*/ 0,.
+00083610: 2020 2020 2020 2020 2f2a 2e6e 5f74 6872          /*.n_thr
+00083620: 6561 6473 2020 2020 3d2a 2f20 4747 4d4c  eads    =*/ GGML
+00083630: 5f44 4546 4155 4c54 5f4e 5f54 4852 4541  _DEFAULT_N_THREA
+00083640: 4453 2c0a 2020 2020 2020 2020 2f2a 2e77  DS,.        /*.w
+00083650: 6f72 6b5f 7369 7a65 2020 2020 3d2a 2f20  ork_size    =*/ 
+00083660: 302c 0a20 2020 2020 2020 202f 2a2e 776f  0,.        /*.wo
+00083670: 726b 2020 2020 2020 2020 203d 2a2f 204e  rk         =*/ N
+00083680: 554c 4c2c 0a20 2020 2020 2020 202f 2a2e  ULL,.        /*.
+00083690: 6e6f 6465 7320 2020 2020 2020 203d 2a2f  nodes        =*/
+000836a0: 207b 204e 554c 4c20 7d2c 0a20 2020 2020   { NULL },.     
+000836b0: 2020 202f 2a2e 6772 6164 7320 2020 2020     /*.grads     
+000836c0: 2020 203d 2a2f 207b 204e 554c 4c20 7d2c     =*/ { NULL },
+000836d0: 0a20 2020 2020 2020 202f 2a2e 6c65 6166  .        /*.leaf
+000836e0: 7320 2020 2020 2020 203d 2a2f 207b 204e  s        =*/ { N
+000836f0: 554c 4c20 7d2c 0a20 2020 2020 2020 202f  ULL },.        /
+00083700: 2a2e 7065 7266 5f72 756e 7320 2020 203d  *.perf_runs    =
+00083710: 2a2f 2030 2c0a 2020 2020 2020 2020 2f2a  */ 0,.        /*
+00083720: 2e70 6572 665f 6379 636c 6573 2020 3d2a  .perf_cycles  =*
+00083730: 2f20 302c 0a20 2020 2020 2020 202f 2a2e  / 0,.        /*.
+00083740: 7065 7266 5f74 696d 655f 7573 203d 2a2f  perf_time_us =*/
+00083750: 2030 2c0a 2020 2020 7d3b 0a0a 2020 2020   0,.    };..    
+00083760: 6767 6d6c 5f62 7569 6c64 5f66 6f72 7761  ggml_build_forwa
+00083770: 7264 5f69 6d70 6c28 2672 6573 756c 742c  rd_impl(&result,
+00083780: 2074 656e 736f 722c 2066 616c 7365 293b   tensor, false);
+00083790: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
+000837a0: 756c 743b 0a7d 0a0a 7374 7275 6374 2067  ult;.}..struct g
+000837b0: 676d 6c5f 6367 7261 7068 2067 676d 6c5f  gml_cgraph ggml_
+000837c0: 6275 696c 645f 6261 636b 7761 7264 2873  build_backward(s
+000837d0: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+000837e0: 7874 202a 2063 7478 2c20 7374 7275 6374  xt * ctx, struct
+000837f0: 2067 676d 6c5f 6367 7261 7068 202a 2067   ggml_cgraph * g
+00083800: 662c 2062 6f6f 6c20 6b65 6570 2920 7b0a  f, bool keep) {.
+00083810: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00083820: 6367 7261 7068 2072 6573 756c 7420 3d20  cgraph result = 
+00083830: 2a67 663b 0a0a 2020 2020 4747 4d4c 5f41  *gf;..    GGML_A
+00083840: 5353 4552 5428 6766 2d3e 6e5f 6e6f 6465  SSERT(gf->n_node
+00083850: 7320 3e20 3029 3b0a 0a20 2020 202f 2f20  s > 0);..    // 
+00083860: 6966 2077 6520 6172 6520 6b65 6570 696e  if we are keepin
+00083870: 6720 7468 6520 6772 6164 6965 6e74 2067  g the gradient g
+00083880: 7261 7068 2c20 7765 2068 6176 6520 746f  raph, we have to
+00083890: 2064 6574 6163 6820 7468 6520 6772 6164   detach the grad
+000838a0: 6965 6e74 206e 6f64 6573 2066 726f 6d20  ient nodes from 
+000838b0: 7468 6520 6f72 6967 696e 616c 2067 7261  the original gra
+000838c0: 7068 0a20 2020 2069 6620 286b 6565 7029  ph.    if (keep)
+000838d0: 207b 0a20 2020 2020 2020 2066 6f72 2028   {.        for (
+000838e0: 696e 7420 6920 3d20 303b 2069 203c 2067  int i = 0; i < g
+000838f0: 662d 3e6e 5f6e 6f64 6573 3b20 692b 2b29  f->n_nodes; i++)
+00083900: 207b 0a20 2020 2020 2020 2020 2020 2073   {.            s
+00083910: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00083920: 7220 2a20 6e6f 6465 203d 2067 662d 3e6e  r * node = gf->n
+00083930: 6f64 6573 5b69 5d3b 0a0a 2020 2020 2020  odes[i];..      
+00083940: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
+00083950: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00083960: 2020 2020 2020 2020 6e6f 6465 2d3e 6772          node->gr
+00083970: 6164 203d 2067 676d 6c5f 6475 705f 7465  ad = ggml_dup_te
+00083980: 6e73 6f72 2863 7478 2c20 6e6f 6465 293b  nsor(ctx, node);
+00083990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000839a0: 2067 662d 3e67 7261 6473 5b69 5d20 3d20   gf->grads[i] = 
+000839b0: 6e6f 6465 2d3e 6772 6164 3b0a 2020 2020  node->grad;.    
+000839c0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000839d0: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
+000839e0: 6f72 2028 696e 7420 6920 3d20 6766 2d3e  or (int i = gf->
+000839f0: 6e5f 6e6f 6465 7320 2d20 313b 2069 203e  n_nodes - 1; i >
+00083a00: 3d20 303b 2069 2d2d 2920 7b0a 2020 2020  = 0; i--) {.    
+00083a10: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00083a20: 7465 6e73 6f72 202a 206e 6f64 6520 3d20  tensor * node = 
+00083a30: 6766 2d3e 6e6f 6465 735b 695d 3b0a 0a20  gf->nodes[i];.. 
+00083a40: 2020 2020 2020 202f 2f20 6265 6361 7573         // becaus
+00083a50: 6520 7765 2064 6574 6163 6865 6420 7468  e we detached th
+00083a60: 6520 6772 6164 206e 6f64 6573 2066 726f  e grad nodes fro
+00083a70: 6d20 7468 6520 6f72 6967 696e 616c 2067  m the original g
+00083a80: 7261 7068 2c20 7765 2063 616e 2061 6666  raph, we can aff
+00083a90: 6f72 6420 696e 706c 6163 6520 6f70 6572  ord inplace oper
+00083aa0: 6174 696f 6e73 0a20 2020 2020 2020 2069  ations.        i
+00083ab0: 6620 286e 6f64 652d 3e67 7261 6429 207b  f (node->grad) {
+00083ac0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+00083ad0: 6c5f 636f 6d70 7574 655f 6261 636b 7761  l_compute_backwa
+00083ae0: 7264 2863 7478 2c20 6e6f 6465 2c20 6b65  rd(ctx, node, ke
+00083af0: 6570 293b 0a20 2020 2020 2020 207d 0a20  ep);.        }. 
+00083b00: 2020 207d 0a0a 2020 2020 666f 7220 2869     }..    for (i
+00083b10: 6e74 2069 203d 2067 662d 3e6e 5f6e 6f64  nt i = gf->n_nod
+00083b20: 6573 202d 2031 3b20 6920 3e3d 2030 3b20  es - 1; i >= 0; 
+00083b30: 692d 2d29 207b 0a20 2020 2020 2020 2073  i--) {.        s
+00083b40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00083b50: 7220 2a20 6e6f 6465 203d 2067 662d 3e6e  r * node = gf->n
+00083b60: 6f64 6573 5b69 5d3b 0a0a 2020 2020 2020  odes[i];..      
+00083b70: 2020 6966 2028 6e6f 6465 2d3e 6973 5f70    if (node->is_p
+00083b80: 6172 616d 2920 7b0a 2020 2020 2020 2020  aram) {.        
+00083b90: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
+00083ba0: 4542 5547 2822 2573 3a20 666f 756e 6420  EBUG("%s: found 
+00083bb0: 726f 6f74 206e 6f64 6520 2570 5c6e 222c  root node %p\n",
+00083bc0: 205f 5f66 756e 635f 5f2c 2028 766f 6964   __func__, (void
+00083bd0: 202a 2920 6e6f 6465 293b 0a20 2020 2020   *) node);.     
+00083be0: 2020 2020 2020 2067 676d 6c5f 6275 696c         ggml_buil
+00083bf0: 645f 666f 7277 6172 645f 696d 706c 2826  d_forward_impl(&
+00083c00: 7265 7375 6c74 2c20 6e6f 6465 2d3e 6772  result, node->gr
+00083c10: 6164 2c20 7472 7565 293b 0a20 2020 2020  ad, true);.     
+00083c20: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+00083c30: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+00083c40: 0a0a 2f2f 0a2f 2f20 7468 7265 6164 2064  ..//.// thread d
+00083c50: 6174 610a 2f2f 0a2f 2f20 7379 6e63 6872  ata.//.// synchr
+00083c60: 6f6e 697a 6174 696f 6e20 6973 2064 6f6e  onization is don
+00083c70: 6520 7669 6120 6275 7379 206c 6f6f 7073  e via busy loops
+00083c80: 0a2f 2f20 4920 7472 6965 6420 7573 696e  .// I tried usin
+00083c90: 6720 7370 696e 206c 6f63 6b73 2c20 6275  g spin locks, bu
+00083ca0: 7420 6e6f 7420 7375 7265 2068 6f77 2074  t not sure how t
+00083cb0: 6f20 7573 6520 7468 656d 2063 6f72 7265  o use them corre
+00083cc0: 6374 6c79 202d 2074 6865 2074 6869 6e67  ctly - the thing
+00083cd0: 7320 4920 7472 6965 6420 7765 7265 2073  s I tried were s
+00083ce0: 6c6f 7765 7220 7468 616e 2062 7573 7920  lower than busy 
+00083cf0: 6c6f 6f70 730a 2f2f 0a0a 2369 6664 6566  loops.//..#ifdef
+00083d00: 205f 5f41 5050 4c45 5f5f 0a0a 2f2f 2369   __APPLE__..//#i
+00083d10: 6e63 6c75 6465 203c 6f73 2f6c 6f63 6b2e  nclude <os/lock.
+00083d20: 683e 0a2f 2f0a 2f2f 7479 7065 6465 6620  h>.//.//typedef 
+00083d30: 6f73 5f75 6e66 6169 725f 6c6f 636b 2067  os_unfair_lock g
+00083d40: 676d 6c5f 6c6f 636b 5f74 3b0a 2f2f 0a2f  gml_lock_t;.//./
+00083d50: 2f23 6465 6669 6e65 2067 676d 6c5f 6c6f  /#define ggml_lo
+00083d60: 636b 5f69 6e69 7428 7829 2020 2020 554e  ck_init(x)    UN
+00083d70: 5553 4544 2878 290a 2f2f 2364 6566 696e  USED(x).//#defin
+00083d80: 6520 6767 6d6c 5f6c 6f63 6b5f 6465 7374  e ggml_lock_dest
+00083d90: 726f 7928 7829 2055 4e55 5345 4428 7829  roy(x) UNUSED(x)
+00083da0: 0a2f 2f23 6465 6669 6e65 2067 676d 6c5f  .//#define ggml_
+00083db0: 6c6f 636b 5f6c 6f63 6b20 2020 2020 2020  lock_lock       
+00083dc0: 6f73 5f75 6e66 6169 725f 6c6f 636b 5f6c  os_unfair_lock_l
+00083dd0: 6f63 6b0a 2f2f 2364 6566 696e 6520 6767  ock.//#define gg
+00083de0: 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b 2020  ml_lock_unlock  
+00083df0: 2020 206f 735f 756e 6661 6972 5f6c 6f63     os_unfair_loc
+00083e00: 6b5f 756e 6c6f 636b 0a2f 2f0a 2f2f 2364  k_unlock.//.//#d
+00083e10: 6566 696e 6520 4747 4d4c 5f4c 4f43 4b5f  efine GGML_LOCK_
+00083e20: 494e 4954 4941 4c49 5a45 5220 4f53 5f55  INITIALIZER OS_U
+00083e30: 4e46 4149 525f 4c4f 434b 5f49 4e49 540a  NFAIR_LOCK_INIT.
+00083e40: 0a74 7970 6564 6566 2069 6e74 2067 676d  .typedef int ggm
+00083e50: 6c5f 6c6f 636b 5f74 3b0a 0a23 6465 6669  l_lock_t;..#defi
+00083e60: 6e65 2067 676d 6c5f 6c6f 636b 5f69 6e69  ne ggml_lock_ini
+00083e70: 7428 7829 2020 2020 554e 5553 4544 2878  t(x)    UNUSED(x
+00083e80: 290a 2364 6566 696e 6520 6767 6d6c 5f6c  ).#define ggml_l
+00083e90: 6f63 6b5f 6465 7374 726f 7928 7829 2055  ock_destroy(x) U
+00083ea0: 4e55 5345 4428 7829 0a23 6465 6669 6e65  NUSED(x).#define
+00083eb0: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b28   ggml_lock_lock(
+00083ec0: 7829 2020 2020 554e 5553 4544 2878 290a  x)    UNUSED(x).
+00083ed0: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
+00083ee0: 6b5f 756e 6c6f 636b 2878 2920 2055 4e55  k_unlock(x)  UNU
+00083ef0: 5345 4428 7829 0a0a 2364 6566 696e 6520  SED(x)..#define 
+00083f00: 4747 4d4c 5f4c 4f43 4b5f 494e 4954 4941  GGML_LOCK_INITIA
+00083f10: 4c49 5a45 5220 300a 0a74 7970 6564 6566  LIZER 0..typedef
+00083f20: 2070 7468 7265 6164 5f74 2067 676d 6c5f   pthread_t ggml_
+00083f30: 7468 7265 6164 5f74 3b0a 0a23 6465 6669  thread_t;..#defi
+00083f40: 6e65 2067 676d 6c5f 7468 7265 6164 5f63  ne ggml_thread_c
+00083f50: 7265 6174 6520 7074 6872 6561 645f 6372  reate pthread_cr
+00083f60: 6561 7465 0a23 6465 6669 6e65 2067 676d  eate.#define ggm
+00083f70: 6c5f 7468 7265 6164 5f6a 6f69 6e20 2020  l_thread_join   
+00083f80: 7074 6872 6561 645f 6a6f 696e 0a0a 2365  pthread_join..#e
+00083f90: 6c73 650a 0a2f 2f74 7970 6564 6566 2070  lse..//typedef p
+00083fa0: 7468 7265 6164 5f73 7069 6e6c 6f63 6b5f  thread_spinlock_
+00083fb0: 7420 6767 6d6c 5f6c 6f63 6b5f 743b 0a0a  t ggml_lock_t;..
+00083fc0: 2f2f 2364 6566 696e 6520 6767 6d6c 5f6c  //#define ggml_l
+00083fd0: 6f63 6b5f 696e 6974 2878 2920 7074 6872  ock_init(x) pthr
+00083fe0: 6561 645f 7370 696e 5f69 6e69 7428 782c  ead_spin_init(x,
+00083ff0: 2050 5448 5245 4144 5f50 524f 4345 5353   PTHREAD_PROCESS
+00084000: 5f50 5249 5641 5445 290a 2f2f 2364 6566  _PRIVATE).//#def
+00084010: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 6465  ine ggml_lock_de
+00084020: 7374 726f 7920 7074 6872 6561 645f 7370  stroy pthread_sp
+00084030: 696e 5f64 6573 7472 6f79 0a2f 2f23 6465  in_destroy.//#de
+00084040: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f6c  fine ggml_lock_l
+00084050: 6f63 6b20 2020 2070 7468 7265 6164 5f73  ock    pthread_s
+00084060: 7069 6e5f 6c6f 636b 0a2f 2f23 6465 6669  pin_lock.//#defi
+00084070: 6e65 2067 676d 6c5f 6c6f 636b 5f75 6e6c  ne ggml_lock_unl
+00084080: 6f63 6b20 2070 7468 7265 6164 5f73 7069  ock  pthread_spi
+00084090: 6e5f 756e 6c6f 636b 0a0a 7479 7065 6465  n_unlock..typede
+000840a0: 6620 696e 7420 6767 6d6c 5f6c 6f63 6b5f  f int ggml_lock_
+000840b0: 743b 0a0a 2364 6566 696e 6520 6767 6d6c  t;..#define ggml
+000840c0: 5f6c 6f63 6b5f 696e 6974 2878 2920 2020  _lock_init(x)   
+000840d0: 2055 4e55 5345 4428 7829 0a23 6465 6669   UNUSED(x).#defi
+000840e0: 6e65 2067 676d 6c5f 6c6f 636b 5f64 6573  ne ggml_lock_des
+000840f0: 7472 6f79 2878 2920 554e 5553 4544 2878  troy(x) UNUSED(x
+00084100: 290a 2369 6620 6465 6669 6e65 6428 5f5f  ).#if defined(__
+00084110: 7838 365f 3634 5f5f 2920 7c7c 2028 6465  x86_64__) || (de
+00084120: 6669 6e65 6428 5f4d 5343 5f56 4552 2920  fined(_MSC_VER) 
+00084130: 2626 2064 6566 696e 6564 285f 4d5f 414d  && defined(_M_AM
+00084140: 4436 3429 290a 2364 6566 696e 6520 6767  D64)).#define gg
+00084150: 6d6c 5f6c 6f63 6b5f 6c6f 636b 2878 2920  ml_lock_lock(x) 
+00084160: 2020 205f 6d6d 5f70 6175 7365 2829 0a23     _mm_pause().#
+00084170: 656c 7365 0a23 6465 6669 6e65 2067 676d  else.#define ggm
+00084180: 6c5f 6c6f 636b 5f6c 6f63 6b28 7829 2020  l_lock_lock(x)  
+00084190: 2020 554e 5553 4544 2878 290a 2365 6e64    UNUSED(x).#end
+000841a0: 6966 0a23 6465 6669 6e65 2067 676d 6c5f  if.#define ggml_
+000841b0: 6c6f 636b 5f75 6e6c 6f63 6b28 7829 2020  lock_unlock(x)  
+000841c0: 554e 5553 4544 2878 290a 0a23 6465 6669  UNUSED(x)..#defi
+000841d0: 6e65 2047 474d 4c5f 4c4f 434b 5f49 4e49  ne GGML_LOCK_INI
+000841e0: 5449 414c 495a 4552 2030 0a0a 7479 7065  TIALIZER 0..type
+000841f0: 6465 6620 7074 6872 6561 645f 7420 6767  def pthread_t gg
+00084200: 6d6c 5f74 6872 6561 645f 743b 0a0a 2364  ml_thread_t;..#d
+00084210: 6566 696e 6520 6767 6d6c 5f74 6872 6561  efine ggml_threa
+00084220: 645f 6372 6561 7465 2070 7468 7265 6164  d_create pthread
+00084230: 5f63 7265 6174 650a 2364 6566 696e 6520  _create.#define 
+00084240: 6767 6d6c 5f74 6872 6561 645f 6a6f 696e  ggml_thread_join
+00084250: 2020 2070 7468 7265 6164 5f6a 6f69 6e0a     pthread_join.
+00084260: 0a23 656e 6469 660a 0a23 6966 6465 6620  .#endif..#ifdef 
+00084270: 5f5f 6c69 6e75 785f 5f0a 766f 6964 2073  __linux__.void s
+00084280: 6574 5f6e 756d 615f 7468 7265 6164 5f61  et_numa_thread_a
+00084290: 6666 696e 6974 7928 696e 7420 7468 7265  ffinity(int thre
+000842a0: 6164 5f6e 2c20 696e 7420 6e5f 7468 7265  ad_n, int n_thre
+000842b0: 6164 7329 207b 0a20 2020 2069 6620 2821  ads) {.    if (!
+000842c0: 6767 6d6c 5f69 735f 6e75 6d61 2829 2920  ggml_is_numa()) 
+000842d0: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+000842e0: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+000842f0: 7275 6e20 7468 7265 6164 206f 6e20 6e6f  run thread on no
+00084300: 6465 5f6e 756d 2074 6872 6561 645f 6e20  de_num thread_n 
+00084310: 2f20 2874 6872 6561 6473 2070 6572 206e  / (threads per n
+00084320: 6f64 6529 0a20 2020 2063 6f6e 7374 2069  ode).    const i
+00084330: 6e74 206e 6f64 655f 6e75 6d20 3d20 7468  nt node_num = th
+00084340: 7265 6164 5f6e 202f 2028 286e 5f74 6872  read_n / ((n_thr
+00084350: 6561 6473 202b 2067 5f73 7461 7465 2e6e  eads + g_state.n
+00084360: 756d 612e 6e5f 6e6f 6465 7320 2d20 3129  uma.n_nodes - 1)
+00084370: 202f 2067 5f73 7461 7465 2e6e 756d 612e   / g_state.numa.
+00084380: 6e5f 6e6f 6465 7329 3b0a 2020 2020 7374  n_nodes);.    st
+00084390: 7275 6374 2067 676d 6c5f 6e75 6d61 5f6e  ruct ggml_numa_n
+000843a0: 6f64 6520 2a20 6e6f 6465 203d 2026 675f  ode * node = &g_
+000843b0: 7374 6174 652e 6e75 6d61 2e6e 6f64 6573  state.numa.nodes
+000843c0: 5b6e 6f64 655f 6e75 6d5d 3b0a 2020 2020  [node_num];.    
+000843d0: 7369 7a65 5f74 2073 6574 7369 7a65 203d  size_t setsize =
+000843e0: 2043 5055 5f41 4c4c 4f43 5f53 495a 4528   CPU_ALLOC_SIZE(
+000843f0: 675f 7374 6174 652e 6e75 6d61 2e74 6f74  g_state.numa.tot
+00084400: 616c 5f63 7075 7329 3b0a 0a20 2020 2063  al_cpus);..    c
+00084410: 7075 5f73 6574 5f74 202a 2063 7075 7320  pu_set_t * cpus 
+00084420: 3d20 4350 555f 414c 4c4f 4328 675f 7374  = CPU_ALLOC(g_st
+00084430: 6174 652e 6e75 6d61 2e74 6f74 616c 5f63  ate.numa.total_c
+00084440: 7075 7329 3b0a 2020 2020 4350 555f 5a45  pus);.    CPU_ZE
+00084450: 524f 5f53 2873 6574 7369 7a65 2c20 6370  RO_S(setsize, cp
+00084460: 7573 293b 0a20 2020 2066 6f72 2028 7369  us);.    for (si
+00084470: 7a65 5f74 2069 203d 2030 3b20 6920 3c20  ze_t i = 0; i < 
+00084480: 6e6f 6465 2d3e 6e5f 6370 7573 3b20 2b2b  node->n_cpus; ++
+00084490: 6929 207b 0a20 2020 2020 2020 2043 5055  i) {.        CPU
+000844a0: 5f53 4554 5f53 286e 6f64 652d 3e63 7075  _SET_S(node->cpu
+000844b0: 735b 695d 2c20 7365 7473 697a 652c 2063  s[i], setsize, c
+000844c0: 7075 7329 3b0a 2020 2020 7d0a 0a20 2020  pus);.    }..   
+000844d0: 2069 6e74 2072 7620 3d20 7074 6872 6561   int rv = pthrea
+000844e0: 645f 7365 7461 6666 696e 6974 795f 6e70  d_setaffinity_np
+000844f0: 2870 7468 7265 6164 5f73 656c 6628 292c  (pthread_self(),
+00084500: 2073 6574 7369 7a65 2c20 6370 7573 293b   setsize, cpus);
+00084510: 0a20 2020 2069 6620 2872 7629 207b 0a20  .    if (rv) {. 
+00084520: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+00084530: 7466 2873 7464 6572 722c 2022 7761 726e  tf(stderr, "warn
+00084540: 696e 673a 2070 7468 7265 6164 5f73 6574  ing: pthread_set
+00084550: 6166 6669 6e69 7479 5f6e 7028 2920 6661  affinity_np() fa
+00084560: 696c 6564 3a20 2573 5c6e 222c 0a20 2020  iled: %s\n",.   
+00084570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084580: 2073 7472 6572 726f 7228 7276 2929 3b0a   strerror(rv));.
+00084590: 2020 2020 7d0a 0a20 2020 2043 5055 5f46      }..    CPU_F
+000845a0: 5245 4528 6370 7573 293b 0a7d 0a0a 766f  REE(cpus);.}..vo
+000845b0: 6964 2063 6c65 6172 5f6e 756d 615f 7468  id clear_numa_th
+000845c0: 7265 6164 5f61 6666 696e 6974 7928 766f  read_affinity(vo
+000845d0: 6964 2920 7b0a 2020 2020 6966 2028 2167  id) {.    if (!g
+000845e0: 676d 6c5f 6973 5f6e 756d 6128 2929 207b  gml_is_numa()) {
+000845f0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00084600: 0a20 2020 207d 0a0a 2020 2020 7369 7a65  .    }..    size
+00084610: 5f74 2073 6574 7369 7a65 203d 2043 5055  _t setsize = CPU
+00084620: 5f41 4c4c 4f43 5f53 495a 4528 675f 7374  _ALLOC_SIZE(g_st
+00084630: 6174 652e 6e75 6d61 2e74 6f74 616c 5f63  ate.numa.total_c
+00084640: 7075 7329 3b0a 0a20 2020 2063 7075 5f73  pus);..    cpu_s
+00084650: 6574 5f74 202a 2063 7075 7320 3d20 4350  et_t * cpus = CP
+00084660: 555f 414c 4c4f 4328 675f 7374 6174 652e  U_ALLOC(g_state.
+00084670: 6e75 6d61 2e74 6f74 616c 5f63 7075 7329  numa.total_cpus)
+00084680: 3b0a 2020 2020 4350 555f 5a45 524f 5f53  ;.    CPU_ZERO_S
+00084690: 2873 6574 7369 7a65 2c20 6370 7573 293b  (setsize, cpus);
+000846a0: 0a20 2020 2066 6f72 2028 756e 7369 676e  .    for (unsign
+000846b0: 6564 2069 203d 2030 3b20 6920 3c20 675f  ed i = 0; i < g_
+000846c0: 7374 6174 652e 6e75 6d61 2e74 6f74 616c  state.numa.total
+000846d0: 5f63 7075 733b 202b 2b69 2920 7b0a 2020  _cpus; ++i) {.  
+000846e0: 2020 2020 2020 4350 555f 5345 545f 5328        CPU_SET_S(
+000846f0: 692c 2073 6574 7369 7a65 2c20 6370 7573  i, setsize, cpus
+00084700: 293b 0a20 2020 207d 0a0a 2020 2020 696e  );.    }..    in
+00084710: 7420 7276 203d 2070 7468 7265 6164 5f73  t rv = pthread_s
+00084720: 6574 6166 6669 6e69 7479 5f6e 7028 7074  etaffinity_np(pt
+00084730: 6872 6561 645f 7365 6c66 2829 2c20 7365  hread_self(), se
+00084740: 7473 697a 652c 2063 7075 7329 3b0a 2020  tsize, cpus);.  
+00084750: 2020 6966 2028 7276 2920 7b0a 2020 2020    if (rv) {.    
+00084760: 2020 2020 6670 7269 6e74 6628 7374 6465      fprintf(stde
+00084770: 7272 2c20 2277 6172 6e69 6e67 3a20 7074  rr, "warning: pt
+00084780: 6872 6561 645f 7365 7461 6666 696e 6974  hread_setaffinit
+00084790: 795f 6e70 2829 2066 6169 6c65 643a 2025  y_np() failed: %
+000847a0: 735c 6e22 2c0a 2020 2020 2020 2020 2020  s\n",.          
+000847b0: 2020 7374 7265 7272 6f72 2872 7629 293b    strerror(rv));
+000847c0: 0a20 2020 207d 0a0a 2020 2020 4350 555f  .    }..    CPU_
+000847d0: 4652 4545 2863 7075 7329 3b0a 7d0a 2365  FREE(cpus);.}.#e
+000847e0: 6c73 650a 2f2f 2054 4f44 4f3a 2057 696e  lse.// TODO: Win
+000847f0: 646f 7773 2065 7463 2e0a 2f2f 2028 7468  dows etc..// (th
+00084800: 6520 6c69 6e75 7820 696d 706c 656d 656e  e linux implemen
+00084810: 7461 7469 6f6e 206d 6179 2061 6c73 6f20  tation may also 
+00084820: 776f 726b 206f 6e20 4253 442c 2073 6f6d  work on BSD, som
+00084830: 656f 6e65 2073 686f 756c 6420 7465 7374  eone should test
+00084840: 290a 766f 6964 2073 6574 5f6e 756d 615f  ).void set_numa_
+00084850: 7468 7265 6164 5f61 6666 696e 6974 7928  thread_affinity(
+00084860: 696e 7420 7468 7265 6164 5f6e 2c20 696e  int thread_n, in
+00084870: 7420 6e5f 7468 7265 6164 7329 207b 2055  t n_threads) { U
+00084880: 4e55 5345 4428 7468 7265 6164 5f6e 293b  NUSED(thread_n);
+00084890: 2055 4e55 5345 4428 6e5f 7468 7265 6164   UNUSED(n_thread
+000848a0: 7329 3b20 207d 0a76 6f69 6420 636c 6561  s);  }.void clea
+000848b0: 725f 6e75 6d61 5f74 6872 6561 645f 6166  r_numa_thread_af
+000848c0: 6669 6e69 7479 2876 6f69 6429 207b 7d0a  finity(void) {}.
+000848d0: 2365 6e64 6966 0a0a 7374 7275 6374 2067  #endif..struct g
+000848e0: 676d 6c5f 636f 6d70 7574 655f 7374 6174  gml_compute_stat
+000848f0: 655f 7368 6172 6564 207b 0a20 2020 2073  e_shared {.    s
+00084900: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+00084910: 6820 2a20 6367 7261 7068 3b0a 0a20 2020  h * cgraph;..   
+00084920: 2069 6e74 3634 5f74 2070 6572 665f 6e6f   int64_t perf_no
+00084930: 6465 5f73 7461 7274 5f63 7963 6c65 733b  de_start_cycles;
+00084940: 0a20 2020 2069 6e74 3634 5f74 2070 6572  .    int64_t per
+00084950: 665f 6e6f 6465 5f73 7461 7274 5f74 696d  f_node_start_tim
+00084960: 655f 7573 3b0a 0a20 2020 2069 6e74 206e  e_us;..    int n
+00084970: 5f74 6872 6561 6473 3b0a 0a20 2020 202f  _threads;..    /
+00084980: 2f20 7379 6e63 6872 6f6e 697a 6174 696f  / synchronizatio
+00084990: 6e20 7072 696d 6974 6976 6573 0a20 2020  n primitives.   
+000849a0: 2061 746f 6d69 635f 696e 7420 6e5f 6163   atomic_int n_ac
+000849b0: 7469 7665 3b20 2f2f 206e 756d 2061 6374  tive; // num act
+000849c0: 6976 6520 7468 7265 6164 730a 2020 2020  ive threads.    
+000849d0: 6174 6f6d 6963 5f69 6e74 206e 6f64 655f  atomic_int node_
+000849e0: 6e3b 2020 202f 2f20 6163 7469 7665 2067  n;   // active g
+000849f0: 7261 7068 206e 6f64 650a 7d3b 0a0a 7374  raph node.};..st
+00084a00: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00084a10: 655f 7374 6174 6520 7b0a 2020 2020 6767  e_state {.    gg
+00084a20: 6d6c 5f74 6872 6561 645f 7420 7468 7264  ml_thread_t thrd
+00084a30: 3b0a 2020 2020 696e 7420 6974 683b 0a20  ;.    int ith;. 
+00084a40: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+00084a50: 6f6d 7075 7465 5f73 7461 7465 5f73 6861  ompute_state_sha
+00084a60: 7265 6420 2a20 7368 6172 6564 3b0a 7d3b  red * shared;.};
+00084a70: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00084a80: 6d6c 5f67 7261 7068 5f63 6f6d 7075 7465  ml_graph_compute
+00084a90: 5f70 6572 665f 7374 6174 735f 6e6f 6465  _perf_stats_node
+00084aa0: 2873 7472 7563 7420 6767 6d6c 5f74 656e  (struct ggml_ten
+00084ab0: 736f 7220 2a20 6e6f 6465 2c20 636f 6e73  sor * node, cons
+00084ac0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+00084ad0: 6d70 7574 655f 7374 6174 655f 7368 6172  mpute_state_shar
+00084ae0: 6564 202a 2073 7429 207b 0a20 2020 2069  ed * st) {.    i
+00084af0: 6e74 3634 5f74 2063 7963 6c65 735f 6375  nt64_t cycles_cu
+00084b00: 7220 203d 2067 676d 6c5f 7065 7266 5f63  r  = ggml_perf_c
+00084b10: 7963 6c65 7328 2920 202d 2073 742d 3e70  ycles()  - st->p
+00084b20: 6572 665f 6e6f 6465 5f73 7461 7274 5f63  erf_node_start_c
+00084b30: 7963 6c65 733b 0a20 2020 2069 6e74 3634  ycles;.    int64
+00084b40: 5f74 2074 696d 655f 7573 5f63 7572 203d  _t time_us_cur =
+00084b50: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
+00084b60: 7573 2829 202d 2073 742d 3e70 6572 665f  us() - st->perf_
+00084b70: 6e6f 6465 5f73 7461 7274 5f74 696d 655f  node_start_time_
+00084b80: 7573 3b0a 0a20 2020 206e 6f64 652d 3e70  us;..    node->p
+00084b90: 6572 665f 7275 6e73 2b2b 3b0a 2020 2020  erf_runs++;.    
+00084ba0: 6e6f 6465 2d3e 7065 7266 5f63 7963 6c65  node->perf_cycle
+00084bb0: 7320 202b 3d20 6379 636c 6573 5f63 7572  s  += cycles_cur
+00084bc0: 3b0a 2020 2020 6e6f 6465 2d3e 7065 7266  ;.    node->perf
+00084bd0: 5f74 696d 655f 7573 202b 3d20 7469 6d65  _time_us += time
+00084be0: 5f75 735f 6375 723b 0a7d 0a0a 7374 6174  _us_cur;.}..stat
+00084bf0: 6963 2074 6872 6561 645f 7265 745f 7420  ic thread_ret_t 
+00084c00: 6767 6d6c 5f67 7261 7068 5f63 6f6d 7075  ggml_graph_compu
+00084c10: 7465 5f74 6872 6561 6428 766f 6964 202a  te_thread(void *
+00084c20: 2064 6174 6129 207b 0a20 2020 2073 7472   data) {.    str
+00084c30: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00084c40: 5f73 7461 7465 202a 2073 7461 7465 203d  _state * state =
+00084c50: 2028 7374 7275 6374 2067 676d 6c5f 636f   (struct ggml_co
+00084c60: 6d70 7574 655f 7374 6174 6520 2a29 2064  mpute_state *) d
+00084c70: 6174 613b 0a20 2020 2073 7472 7563 7420  ata;.    struct 
+00084c80: 6767 6d6c 5f63 6772 6170 6820 2a20 6367  ggml_cgraph * cg
+00084c90: 7261 7068 203d 2073 7461 7465 2d3e 7368  raph = state->sh
+00084ca0: 6172 6564 2d3e 6367 7261 7068 3b0a 0a20  ared->cgraph;.. 
+00084cb0: 2020 2063 6f6e 7374 2069 6e74 206e 5f74     const int n_t
+00084cc0: 6872 6561 6473 203d 2073 7461 7465 2d3e  hreads = state->
+00084cd0: 7368 6172 6564 2d3e 6e5f 7468 7265 6164  shared->n_thread
+00084ce0: 733b 0a20 2020 2073 6574 5f6e 756d 615f  s;.    set_numa_
+00084cf0: 7468 7265 6164 5f61 6666 696e 6974 7928  thread_affinity(
+00084d00: 7374 6174 652d 3e69 7468 2c20 6e5f 7468  state->ith, n_th
+00084d10: 7265 6164 7329 3b0a 0a20 2020 2069 6e74  reads);..    int
+00084d20: 206e 6f64 655f 6e20 3d20 2d31 3b0a 0a20   node_n = -1;.. 
+00084d30: 2020 2077 6869 6c65 2028 7472 7565 2920     while (true) 
+00084d40: 7b0a 2020 2020 2020 2020 6966 2028 6174  {.        if (at
+00084d50: 6f6d 6963 5f66 6574 6368 5f73 7562 2826  omic_fetch_sub(&
+00084d60: 7374 6174 652d 3e73 6861 7265 642d 3e6e  state->shared->n
+00084d70: 5f61 6374 6976 652c 2031 2920 3d3d 2031  _active, 1) == 1
+00084d80: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00084d90: 2f2f 2061 6c6c 206f 7468 6572 2074 6872  // all other thr
+00084da0: 6561 6473 2061 7265 2066 696e 6973 6865  eads are finishe
+00084db0: 6420 616e 6420 7370 696e 6e69 6e67 0a20  d and spinning. 
+00084dc0: 2020 2020 2020 2020 2020 202f 2f20 646f             // do
+00084dd0: 2066 696e 616c 697a 6520 616e 6420 696e   finalize and in
+00084de0: 6974 2068 6572 6520 736f 2077 6520 646f  it here so we do
+00084df0: 6e27 7420 6861 7665 2073 796e 6368 726f  n't have synchro
+00084e00: 6e69 7a65 2061 6761 696e 0a20 2020 2020  nize again.     
+00084e10: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00084e20: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00084e30: 7320 7061 7261 6d73 203d 207b 0a20 2020  s params = {.   
+00084e40: 2020 2020 2020 2020 2020 2020 202f 2a2e               /*.
+00084e50: 7479 7065 2020 3d2a 2f20 4747 4d4c 5f54  type  =*/ GGML_T
+00084e60: 4153 4b5f 4649 4e41 4c49 5a45 2c0a 2020  ASK_FINALIZE,.  
+00084e70: 2020 2020 2020 2020 2020 2020 2020 2f2a                /*
+00084e80: 2e69 7468 2020 203d 2a2f 2030 2c0a 2020  .ith   =*/ 0,.  
+00084e90: 2020 2020 2020 2020 2020 2020 2020 2f2a                /*
+00084ea0: 2e6e 7468 2020 203d 2a2f 2030 2c0a 2020  .nth   =*/ 0,.  
+00084eb0: 2020 2020 2020 2020 2020 2020 2020 2f2a                /*
+00084ec0: 2e77 7369 7a65 203d 2a2f 2063 6772 6170  .wsize =*/ cgrap
+00084ed0: 682d 3e77 6f72 6b20 3f20 6767 6d6c 5f6e  h->work ? ggml_n
+00084ee0: 6279 7465 7328 6367 7261 7068 2d3e 776f  bytes(cgraph->wo
+00084ef0: 726b 2920 3a20 302c 0a20 2020 2020 2020  rk) : 0,.       
+00084f00: 2020 2020 2020 2020 202f 2a2e 7764 6174           /*.wdat
+00084f10: 6120 3d2a 2f20 6367 7261 7068 2d3e 776f  a =*/ cgraph->wo
+00084f20: 726b 203f 2063 6772 6170 682d 3e77 6f72  rk ? cgraph->wor
+00084f30: 6b2d 3e64 6174 6120 3a20 4e55 4c4c 2c0a  k->data : NULL,.
+00084f40: 2020 2020 2020 2020 2020 2020 7d3b 0a0a              };..
+00084f50: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00084f60: 6e6f 6465 5f6e 2021 3d20 2d31 2920 7b0a  node_n != -1) {.
+00084f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084f80: 2f2a 2046 494e 414c 495a 4520 2a2f 0a20  /* FINALIZE */. 
+00084f90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00084fa0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00084fb0: 7220 2a20 6e6f 6465 203d 2073 7461 7465  r * node = state
+00084fc0: 2d3e 7368 6172 6564 2d3e 6367 7261 7068  ->shared->cgraph
+00084fd0: 2d3e 6e6f 6465 735b 6e6f 6465 5f6e 5d3b  ->nodes[node_n];
+00084fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00084ff0: 2070 6172 616d 732e 6e74 6820 3d20 6e6f   params.nth = no
+00085000: 6465 2d3e 6e5f 7461 736b 733b 0a20 2020  de->n_tasks;.   
+00085010: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00085020: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00085030: 6428 2670 6172 616d 732c 206e 6f64 6529  d(&params, node)
+00085040: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00085050: 2020 6767 6d6c 5f67 7261 7068 5f63 6f6d    ggml_graph_com
+00085060: 7075 7465 5f70 6572 665f 7374 6174 735f  pute_perf_stats_
+00085070: 6e6f 6465 286e 6f64 652c 2073 7461 7465  node(node, state
+00085080: 2d3e 7368 6172 6564 293b 0a20 2020 2020  ->shared);.     
+00085090: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+000850a0: 2020 2020 2020 2f2f 2064 6973 7472 6962        // distrib
+000850b0: 7574 6520 6e65 7720 776f 726b 206f 7220  ute new work or 
+000850c0: 6578 6563 7574 6520 6974 2064 6972 6563  execute it direc
+000850d0: 7420 6966 2031 540a 2020 2020 2020 2020  t if 1T.        
+000850e0: 2020 2020 7768 696c 6520 282b 2b6e 6f64      while (++nod
+000850f0: 655f 6e20 3c20 6367 7261 7068 2d3e 6e5f  e_n < cgraph->n_
+00085100: 6e6f 6465 7329 207b 0a20 2020 2020 2020  nodes) {.       
+00085110: 2020 2020 2020 2020 2047 474d 4c5f 5052           GGML_PR
+00085120: 494e 545f 4445 4255 475f 3528 2225 733a  INT_DEBUG_5("%s:
+00085130: 2025 642f 2564 5c6e 222c 205f 5f66 756e   %d/%d\n", __fun
+00085140: 635f 5f2c 206e 6f64 655f 6e2c 2063 6772  c__, node_n, cgr
+00085150: 6170 682d 3e6e 5f6e 6f64 6573 293b 0a0a  aph->n_nodes);..
+00085160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085170: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00085180: 6f72 202a 206e 6f64 6520 3d20 6367 7261  or * node = cgra
+00085190: 7068 2d3e 6e6f 6465 735b 6e6f 6465 5f6e  ph->nodes[node_n
+000851a0: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
+000851b0: 2020 2020 7374 6174 652d 3e73 6861 7265      state->share
+000851c0: 642d 3e70 6572 665f 6e6f 6465 5f73 7461  d->perf_node_sta
+000851d0: 7274 5f63 7963 6c65 7320 203d 2067 676d  rt_cycles  = ggm
+000851e0: 6c5f 7065 7266 5f63 7963 6c65 7328 293b  l_perf_cycles();
+000851f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00085200: 2073 7461 7465 2d3e 7368 6172 6564 2d3e   state->shared->
+00085210: 7065 7266 5f6e 6f64 655f 7374 6172 745f  perf_node_start_
+00085220: 7469 6d65 5f75 7320 3d20 6767 6d6c 5f70  time_us = ggml_p
+00085230: 6572 665f 7469 6d65 5f75 7328 293b 0a0a  erf_time_us();..
 00085240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085250: 2020 2020 7061 7261 6d73 2e74 7970 6520      params.type 
-00085260: 3d20 4747 4d4c 5f54 4153 4b5f 434f 4d50  = GGML_TASK_COMP
-00085270: 5554 453b 0a20 2020 2020 2020 2020 2020  UTE;.           
-00085280: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00085290: 6d70 7574 655f 666f 7277 6172 6428 2670  mpute_forward(&p
-000852a0: 6172 616d 732c 206e 6f64 6529 3b0a 0a20  arams, node);.. 
-000852b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000852c0: 2020 2070 6172 616d 732e 7479 7065 203d     params.type =
-000852d0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-000852e0: 495a 453b 0a20 2020 2020 2020 2020 2020  IZE;.           
-000852f0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00085300: 6d70 7574 655f 666f 7277 6172 6428 2670  mpute_forward(&p
-00085310: 6172 616d 732c 206e 6f64 6529 3b0a 2020  arams, node);.  
-00085320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085330: 2020 6767 6d6c 5f67 7261 7068 5f63 6f6d    ggml_graph_com
-00085340: 7075 7465 5f70 6572 665f 7374 6174 735f  pute_perf_stats_
-00085350: 6e6f 6465 286e 6f64 652c 2073 7461 7465  node(node, state
-00085360: 2d3e 7368 6172 6564 293b 0a20 2020 2020  ->shared);.     
-00085370: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-00085380: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-00085390: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-000853a0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000853b0: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-000853c0: 2020 2020 2020 2020 2020 2020 6174 6f6d              atom
-000853d0: 6963 5f73 746f 7265 2826 7374 6174 652d  ic_store(&state-
-000853e0: 3e73 6861 7265 642d 3e6e 5f61 6374 6976  >shared->n_activ
-000853f0: 652c 206e 5f74 6872 6561 6473 293b 0a20  e, n_threads);. 
-00085400: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
-00085410: 635f 7374 6f72 6528 2673 7461 7465 2d3e  c_store(&state->
-00085420: 7368 6172 6564 2d3e 6e6f 6465 5f6e 2c20  shared->node_n, 
-00085430: 2020 6e6f 6465 5f6e 293b 0a20 2020 2020    node_n);.     
-00085440: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-00085450: 2020 2020 2020 2020 2f2f 2077 6169 7420          // wait 
-00085460: 666f 7220 6f74 6865 7220 7468 7265 6164  for other thread
-00085470: 7320 746f 2066 696e 6973 680a 2020 2020  s to finish.    
-00085480: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00085490: 7420 6c61 7374 203d 206e 6f64 655f 6e3b  t last = node_n;
-000854a0: 0a20 2020 2020 2020 2020 2020 2064 6f20  .            do 
-000854b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000854c0: 2020 7363 6865 645f 7969 656c 6428 293b    sched_yield();
-000854d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000854e0: 206e 6f64 655f 6e20 3d20 6174 6f6d 6963   node_n = atomic
-000854f0: 5f6c 6f61 6428 2673 7461 7465 2d3e 7368  _load(&state->sh
-00085500: 6172 6564 2d3e 6e6f 6465 5f6e 293b 0a20  ared->node_n);. 
-00085510: 2020 2020 2020 2020 2020 207d 2077 6869             } whi
-00085520: 6c65 2028 6e6f 6465 5f6e 203d 3d20 6c61  le (node_n == la
-00085530: 7374 293b 0a20 2020 2020 2020 207d 0a0a  st);.        }..
-00085540: 2020 2020 2020 2020 2f2f 2063 6865 636b          // check
-00085550: 2069 6620 7765 2073 686f 756c 6420 7374   if we should st
-00085560: 6f70 0a20 2020 2020 2020 2069 6620 286e  op.        if (n
-00085570: 6f64 655f 6e20 3e3d 2063 6772 6170 682d  ode_n >= cgraph-
-00085580: 3e6e 5f6e 6f64 6573 2920 6272 6561 6b3b  >n_nodes) break;
-00085590: 0a0a 2020 2020 2020 2020 2f2a 2043 4f4d  ..        /* COM
-000855a0: 5055 5445 202a 2f0a 2020 2020 2020 2020  PUTE */.        
-000855b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000855c0: 6f72 202a 206e 6f64 6520 3d20 6367 7261  or * node = cgra
-000855d0: 7068 2d3e 6e6f 6465 735b 6e6f 6465 5f6e  ph->nodes[node_n
-000855e0: 5d3b 0a0a 2020 2020 2020 2020 7374 7275  ];..        stru
-000855f0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00085600: 7061 7261 6d73 2070 6172 616d 7320 3d20  params params = 
-00085610: 7b0a 2020 2020 2020 2020 2020 2020 2f2a  {.            /*
-00085620: 2e74 7970 6520 203d 2a2f 2047 474d 4c5f  .type  =*/ GGML_
-00085630: 5441 534b 5f43 4f4d 5055 5445 2c0a 2020  TASK_COMPUTE,.  
-00085640: 2020 2020 2020 2020 2020 2f2a 2e69 7468            /*.ith
-00085650: 2020 203d 2a2f 2073 7461 7465 2d3e 6974     =*/ state->it
-00085660: 682c 0a20 2020 2020 2020 2020 2020 202f  h,.            /
-00085670: 2a2e 6e74 6820 2020 3d2a 2f20 6e6f 6465  *.nth   =*/ node
-00085680: 2d3e 6e5f 7461 736b 732c 0a20 2020 2020  ->n_tasks,.     
-00085690: 2020 2020 2020 202f 2a2e 7773 697a 6520         /*.wsize 
-000856a0: 3d2a 2f20 6367 7261 7068 2d3e 776f 726b  =*/ cgraph->work
-000856b0: 203f 2067 676d 6c5f 6e62 7974 6573 2863   ? ggml_nbytes(c
-000856c0: 6772 6170 682d 3e77 6f72 6b29 203a 2030  graph->work) : 0
-000856d0: 2c0a 2020 2020 2020 2020 2020 2020 2f2a  ,.            /*
-000856e0: 2e77 6461 7461 203d 2a2f 2063 6772 6170  .wdata =*/ cgrap
-000856f0: 682d 3e77 6f72 6b20 3f20 6367 7261 7068  h->work ? cgraph
-00085700: 2d3e 776f 726b 2d3e 6461 7461 203a 204e  ->work->data : N
-00085710: 554c 4c2c 0a20 2020 2020 2020 207d 3b0a  ULL,.        };.
-00085720: 0a20 2020 2020 2020 2069 6620 2873 7461  .        if (sta
-00085730: 7465 2d3e 6974 6820 3c20 6e6f 6465 2d3e  te->ith < node->
-00085740: 6e5f 7461 736b 7329 207b 0a20 2020 2020  n_tasks) {.     
-00085750: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00085760: 7574 655f 666f 7277 6172 6428 2670 6172  ute_forward(&par
-00085770: 616d 732c 206e 6f64 6529 3b0a 2020 2020  ams, node);.    
-00085780: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-00085790: 2072 6574 7572 6e20 303b 0a7d 0a0a 766f   return 0;.}..vo
-000857a0: 6964 2067 676d 6c5f 6772 6170 685f 636f  id ggml_graph_co
-000857b0: 6d70 7574 6528 7374 7275 6374 2067 676d  mpute(struct ggm
-000857c0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
-000857d0: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
-000857e0: 6170 6820 2a20 6367 7261 7068 2920 7b0a  aph * cgraph) {.
-000857f0: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-00085800: 7468 7265 6164 7320 3d20 6367 7261 7068  threads = cgraph
-00085810: 2d3e 6e5f 7468 7265 6164 733b 0a0a 2020  ->n_threads;..  
-00085820: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-00085830: 6d70 7574 655f 7374 6174 655f 7368 6172  mpute_state_shar
-00085840: 6564 2073 7461 7465 5f73 6861 7265 6420  ed state_shared 
-00085850: 3d20 7b0a 2020 2020 2020 2020 2f2a 2e63  = {.        /*.c
-00085860: 6772 6170 6820 2020 2020 2020 2020 2020  graph           
-00085870: 2020 2020 2020 203d 2a2f 2063 6772 6170         =*/ cgrap
-00085880: 682c 0a20 2020 2020 2020 202f 2a2e 7065  h,.        /*.pe
-00085890: 7266 5f6e 6f64 655f 7374 6172 745f 6379  rf_node_start_cy
-000858a0: 636c 6573 2020 3d2a 2f20 302c 0a20 2020  cles  =*/ 0,.   
-000858b0: 2020 2020 202f 2a2e 7065 7266 5f6e 6f64       /*.perf_nod
-000858c0: 655f 7374 6172 745f 7469 6d65 5f75 7320  e_start_time_us 
-000858d0: 3d2a 2f20 302c 0a20 2020 2020 2020 202f  =*/ 0,.        /
-000858e0: 2a2e 6e5f 7468 7265 6164 7320 2020 2020  *.n_threads     
-000858f0: 2020 2020 2020 2020 2020 3d2a 2f20 6e5f            =*/ n_
-00085900: 7468 7265 6164 732c 0a20 2020 2020 2020  threads,.       
-00085910: 202f 2a2e 6e5f 6163 7469 7665 2020 2020   /*.n_active    
-00085920: 2020 2020 2020 2020 2020 2020 3d2a 2f20              =*/ 
-00085930: 6e5f 7468 7265 6164 732c 0a20 2020 2020  n_threads,.     
-00085940: 2020 202f 2a2e 6e6f 6465 5f6e 2020 2020     /*.node_n    
-00085950: 2020 2020 2020 2020 2020 2020 2020 3d2a                =*
-00085960: 2f20 2d31 2c0a 2020 2020 7d3b 0a20 2020  / -1,.    };.   
-00085970: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00085980: 7075 7465 5f73 7461 7465 202a 2077 6f72  pute_state * wor
-00085990: 6b65 7273 203d 2061 6c6c 6f63 6128 7369  kers = alloca(si
-000859a0: 7a65 6f66 2873 7472 7563 7420 6767 6d6c  zeof(struct ggml
-000859b0: 5f63 6f6d 7075 7465 5f73 7461 7465 292a  _compute_state)*
-000859c0: 6e5f 7468 7265 6164 7329 3b0a 0a20 2020  n_threads);..   
-000859d0: 202f 2f20 696e 6974 6961 6c69 7a65 2074   // initialize t
-000859e0: 6173 6b73 202b 2077 6f72 6b20 6275 6666  asks + work buff
-000859f0: 6572 0a20 2020 207b 0a20 2020 2020 2020  er.    {.       
-00085a00: 2073 697a 655f 7420 776f 726b 5f73 697a   size_t work_siz
-00085a10: 6520 3d20 303b 0a0a 2020 2020 2020 2020  e = 0;..        
-00085a20: 2f2f 2074 6872 6561 6420 7363 6865 6475  // thread schedu
-00085a30: 6c69 6e67 2066 6f72 2074 6865 2064 6966  ling for the dif
-00085a40: 6665 7265 6e74 206f 7065 7261 7469 6f6e  ferent operation
-00085a50: 730a 2020 2020 2020 2020 666f 7220 2869  s.        for (i
-00085a60: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
-00085a70: 7261 7068 2d3e 6e5f 6e6f 6465 733b 2069  raph->n_nodes; i
-00085a80: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00085a90: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00085aa0: 6e73 6f72 202a 206e 6f64 6520 3d20 6367  nsor * node = cg
-00085ab0: 7261 7068 2d3e 6e6f 6465 735b 695d 3b0a  raph->nodes[i];.
-00085ac0: 0a20 2020 2020 2020 2020 2020 2073 7769  .            swi
-00085ad0: 7463 6820 286e 6f64 652d 3e6f 7029 207b  tch (node->op) {
-00085ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00085af0: 2063 6173 6520 4747 4d4c 5f4f 505f 4350   case GGML_OP_CP
-00085b00: 593a 0a20 2020 2020 2020 2020 2020 2020  Y:.             
-00085b10: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00085b20: 4455 503a 0a20 2020 2020 2020 2020 2020  DUP:.           
-00085b30: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00085b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085b50: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
-00085b60: 203d 206e 5f74 6872 6561 6473 3b0a 0a20   = n_threads;.. 
-00085b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085b80: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
-00085b90: 7220 3d20 303b 0a20 2020 2020 2020 2020  r = 0;.         
-00085ba0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00085bb0: 6620 2867 676d 6c5f 6973 5f71 7561 6e74  f (ggml_is_quant
-00085bc0: 697a 6564 286e 6f64 652d 3e74 7970 6529  ized(node->type)
-00085bd0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00085be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085bf0: 6375 7220 3d20 4747 4d4c 5f54 5950 455f  cur = GGML_TYPE_
-00085c00: 5349 5a45 5b47 474d 4c5f 5459 5045 5f46  SIZE[GGML_TYPE_F
-00085c10: 3332 5d20 2a20 6e6f 6465 2d3e 6e65 5b30  32] * node->ne[0
-00085c20: 5d20 2a20 6e5f 7468 7265 6164 733b 0a20  ] * n_threads;. 
-00085c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085c40: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00085c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085c60: 2020 776f 726b 5f73 697a 6520 3d20 4d41    work_size = MA
-00085c70: 5828 776f 726b 5f73 697a 652c 2063 7572  X(work_size, cur
-00085c80: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00085c90: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00085ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085cb0: 6361 7365 2047 474d 4c5f 4f50 5f41 4444  case GGML_OP_ADD
-00085cc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00085cd0: 2020 6361 7365 2047 474d 4c5f 4f50 5f41    case GGML_OP_A
-00085ce0: 4444 313a 0a20 2020 2020 2020 2020 2020  DD1:.           
-00085cf0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00085d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085d10: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
-00085d20: 203d 206e 5f74 6872 6561 6473 3b0a 0a20   = n_threads;.. 
-00085d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085d40: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
-00085d50: 7220 3d20 303b 0a0a 2020 2020 2020 2020  r = 0;..        
+00085250: 2f2a 2049 4e49 5420 2a2f 0a20 2020 2020  /* INIT */.     
+00085260: 2020 2020 2020 2020 2020 2070 6172 616d             param
+00085270: 732e 7479 7065 203d 2047 474d 4c5f 5441  s.type = GGML_TA
+00085280: 534b 5f49 4e49 543b 0a20 2020 2020 2020  SK_INIT;.       
+00085290: 2020 2020 2020 2020 2070 6172 616d 732e           params.
+000852a0: 6e74 6820 203d 206e 6f64 652d 3e6e 5f74  nth  = node->n_t
+000852b0: 6173 6b73 3b0a 2020 2020 2020 2020 2020  asks;.          
+000852c0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+000852d0: 7465 5f66 6f72 7761 7264 2826 7061 7261  te_forward(&para
+000852e0: 6d73 2c20 6e6f 6465 293b 0a0a 2020 2020  ms, node);..    
+000852f0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00085300: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d3d  node->n_tasks ==
+00085310: 2031 2920 7b0a 2020 2020 2020 2020 2020   1) {.          
+00085320: 2020 2020 2020 2020 2020 2f2f 2054 4f44            // TOD
+00085330: 4f3a 206d 6179 6265 2070 7573 6820 6e6f  O: maybe push no
+00085340: 6465 5f6e 2074 6f20 7468 6520 6174 6f6d  de_n to the atom
+00085350: 6963 2062 7574 2069 6620 6f74 6865 7220  ic but if other 
+00085360: 7468 7265 6164 7320 7365 6520 6e5f 7461  threads see n_ta
+00085370: 736b 7320 6973 2031 2c0a 2020 2020 2020  sks is 1,.      
+00085380: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00085390: 2074 6865 7920 646f 2073 6f6d 6574 6869   they do somethi
+000853a0: 6e67 206d 6f72 6520 6566 6669 6369 656e  ng more efficien
+000853b0: 7420 7468 616e 2073 7069 6e6e 696e 6720  t than spinning 
+000853c0: 283f 290a 2020 2020 2020 2020 2020 2020  (?).            
+000853d0: 2020 2020 2020 2020 7061 7261 6d73 2e74          params.t
+000853e0: 7970 6520 3d20 4747 4d4c 5f54 4153 4b5f  ype = GGML_TASK_
+000853f0: 434f 4d50 5554 453b 0a20 2020 2020 2020  COMPUTE;.       
+00085400: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00085410: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00085420: 6428 2670 6172 616d 732c 206e 6f64 6529  d(&params, node)
+00085430: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00085440: 2020 2020 2020 2070 6172 616d 732e 7479         params.ty
+00085450: 7065 203d 2047 474d 4c5f 5441 534b 5f46  pe = GGML_TASK_F
+00085460: 494e 414c 495a 453b 0a20 2020 2020 2020  INALIZE;.       
+00085470: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00085480: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00085490: 6428 2670 6172 616d 732c 206e 6f64 6529  d(&params, node)
+000854a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000854b0: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
+000854c0: 5f63 6f6d 7075 7465 5f70 6572 665f 7374  _compute_perf_st
+000854d0: 6174 735f 6e6f 6465 286e 6f64 652c 2073  ats_node(node, s
+000854e0: 7461 7465 2d3e 7368 6172 6564 293b 0a20  tate->shared);. 
+000854f0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00085500: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+00085510: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00085520: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+00085530: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00085540: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00085550: 6174 6f6d 6963 5f73 746f 7265 2826 7374  atomic_store(&st
+00085560: 6174 652d 3e73 6861 7265 642d 3e6e 5f61  ate->shared->n_a
+00085570: 6374 6976 652c 206e 5f74 6872 6561 6473  ctive, n_threads
+00085580: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
+00085590: 746f 6d69 635f 7374 6f72 6528 2673 7461  tomic_store(&sta
+000855a0: 7465 2d3e 7368 6172 6564 2d3e 6e6f 6465  te->shared->node
+000855b0: 5f6e 2c20 2020 6e6f 6465 5f6e 293b 0a20  _n,   node_n);. 
+000855c0: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+000855d0: 2020 2020 2020 2020 2020 2020 2f2f 2077              // w
+000855e0: 6169 7420 666f 7220 6f74 6865 7220 7468  ait for other th
+000855f0: 7265 6164 7320 746f 2066 696e 6973 680a  reads to finish.
+00085600: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00085610: 7420 696e 7420 6c61 7374 203d 206e 6f64  t int last = nod
+00085620: 655f 6e3b 0a20 2020 2020 2020 2020 2020  e_n;.           
+00085630: 2064 6f20 7b0a 2020 2020 2020 2020 2020   do {.          
+00085640: 2020 2020 2020 7363 6865 645f 7969 656c        sched_yiel
+00085650: 6428 293b 0a20 2020 2020 2020 2020 2020  d();.           
+00085660: 2020 2020 206e 6f64 655f 6e20 3d20 6174       node_n = at
+00085670: 6f6d 6963 5f6c 6f61 6428 2673 7461 7465  omic_load(&state
+00085680: 2d3e 7368 6172 6564 2d3e 6e6f 6465 5f6e  ->shared->node_n
+00085690: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000856a0: 2077 6869 6c65 2028 6e6f 6465 5f6e 203d   while (node_n =
+000856b0: 3d20 6c61 7374 293b 0a20 2020 2020 2020  = last);.       
+000856c0: 207d 0a0a 2020 2020 2020 2020 2f2f 2063   }..        // c
+000856d0: 6865 636b 2069 6620 7765 2073 686f 756c  heck if we shoul
+000856e0: 6420 7374 6f70 0a20 2020 2020 2020 2069  d stop.        i
+000856f0: 6620 286e 6f64 655f 6e20 3e3d 2063 6772  f (node_n >= cgr
+00085700: 6170 682d 3e6e 5f6e 6f64 6573 2920 6272  aph->n_nodes) br
+00085710: 6561 6b3b 0a0a 2020 2020 2020 2020 2f2a  eak;..        /*
+00085720: 2043 4f4d 5055 5445 202a 2f0a 2020 2020   COMPUTE */.    
+00085730: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00085740: 7465 6e73 6f72 202a 206e 6f64 6520 3d20  tensor * node = 
+00085750: 6367 7261 7068 2d3e 6e6f 6465 735b 6e6f  cgraph->nodes[no
+00085760: 6465 5f6e 5d3b 0a0a 2020 2020 2020 2020  de_n];..        
+00085770: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00085780: 7574 655f 7061 7261 6d73 2070 6172 616d  ute_params param
+00085790: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+000857a0: 2020 2f2a 2e74 7970 6520 203d 2a2f 2047    /*.type  =*/ G
+000857b0: 474d 4c5f 5441 534b 5f43 4f4d 5055 5445  GML_TASK_COMPUTE
+000857c0: 2c0a 2020 2020 2020 2020 2020 2020 2f2a  ,.            /*
+000857d0: 2e69 7468 2020 203d 2a2f 2073 7461 7465  .ith   =*/ state
+000857e0: 2d3e 6974 682c 0a20 2020 2020 2020 2020  ->ith,.         
+000857f0: 2020 202f 2a2e 6e74 6820 2020 3d2a 2f20     /*.nth   =*/ 
+00085800: 6e6f 6465 2d3e 6e5f 7461 736b 732c 0a20  node->n_tasks,. 
+00085810: 2020 2020 2020 2020 2020 202f 2a2e 7773             /*.ws
+00085820: 697a 6520 3d2a 2f20 6367 7261 7068 2d3e  ize =*/ cgraph->
+00085830: 776f 726b 203f 2067 676d 6c5f 6e62 7974  work ? ggml_nbyt
+00085840: 6573 2863 6772 6170 682d 3e77 6f72 6b29  es(cgraph->work)
+00085850: 203a 2030 2c0a 2020 2020 2020 2020 2020   : 0,.          
+00085860: 2020 2f2a 2e77 6461 7461 203d 2a2f 2063    /*.wdata =*/ c
+00085870: 6772 6170 682d 3e77 6f72 6b20 3f20 6367  graph->work ? cg
+00085880: 7261 7068 2d3e 776f 726b 2d3e 6461 7461  raph->work->data
+00085890: 203a 204e 554c 4c2c 0a20 2020 2020 2020   : NULL,.       
+000858a0: 207d 3b0a 0a20 2020 2020 2020 2069 6620   };..        if 
+000858b0: 2873 7461 7465 2d3e 6974 6820 3c20 6e6f  (state->ith < no
+000858c0: 6465 2d3e 6e5f 7461 736b 7329 207b 0a20  de->n_tasks) {. 
+000858d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000858e0: 636f 6d70 7574 655f 666f 7277 6172 6428  compute_forward(
+000858f0: 2670 6172 616d 732c 206e 6f64 6529 3b0a  &params, node);.
+00085900: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+00085910: 0a20 2020 2072 6574 7572 6e20 303b 0a7d  .    return 0;.}
+00085920: 0a0a 766f 6964 2067 676d 6c5f 6772 6170  ..void ggml_grap
+00085930: 685f 636f 6d70 7574 6528 7374 7275 6374  h_compute(struct
+00085940: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00085950: 6374 782c 2073 7472 7563 7420 6767 6d6c  ctx, struct ggml
+00085960: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
+00085970: 2920 7b0a 2020 2020 636f 6e73 7420 696e  ) {.    const in
+00085980: 7420 6e5f 7468 7265 6164 7320 3d20 6367  t n_threads = cg
+00085990: 7261 7068 2d3e 6e5f 7468 7265 6164 733b  raph->n_threads;
+000859a0: 0a0a 2020 2020 7374 7275 6374 2067 676d  ..    struct ggm
+000859b0: 6c5f 636f 6d70 7574 655f 7374 6174 655f  l_compute_state_
+000859c0: 7368 6172 6564 2073 7461 7465 5f73 6861  shared state_sha
+000859d0: 7265 6420 3d20 7b0a 2020 2020 2020 2020  red = {.        
+000859e0: 2f2a 2e63 6772 6170 6820 2020 2020 2020  /*.cgraph       
+000859f0: 2020 2020 2020 2020 2020 203d 2a2f 2063             =*/ c
+00085a00: 6772 6170 682c 0a20 2020 2020 2020 202f  graph,.        /
+00085a10: 2a2e 7065 7266 5f6e 6f64 655f 7374 6172  *.perf_node_star
+00085a20: 745f 6379 636c 6573 2020 3d2a 2f20 302c  t_cycles  =*/ 0,
+00085a30: 0a20 2020 2020 2020 202f 2a2e 7065 7266  .        /*.perf
+00085a40: 5f6e 6f64 655f 7374 6172 745f 7469 6d65  _node_start_time
+00085a50: 5f75 7320 3d2a 2f20 302c 0a20 2020 2020  _us =*/ 0,.     
+00085a60: 2020 202f 2a2e 6e5f 7468 7265 6164 7320     /*.n_threads 
+00085a70: 2020 2020 2020 2020 2020 2020 2020 3d2a                =*
+00085a80: 2f20 6e5f 7468 7265 6164 732c 0a20 2020  / n_threads,.   
+00085a90: 2020 2020 202f 2a2e 6e5f 6163 7469 7665       /*.n_active
+00085aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085ab0: 3d2a 2f20 6e5f 7468 7265 6164 732c 0a20  =*/ n_threads,. 
+00085ac0: 2020 2020 2020 202f 2a2e 6e6f 6465 5f6e         /*.node_n
+00085ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085ae0: 2020 3d2a 2f20 2d31 2c0a 2020 2020 7d3b    =*/ -1,.    };
+00085af0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00085b00: 5f63 6f6d 7075 7465 5f73 7461 7465 202a  _compute_state *
+00085b10: 2077 6f72 6b65 7273 203d 2061 6c6c 6f63   workers = alloc
+00085b20: 6128 7369 7a65 6f66 2873 7472 7563 7420  a(sizeof(struct 
+00085b30: 6767 6d6c 5f63 6f6d 7075 7465 5f73 7461  ggml_compute_sta
+00085b40: 7465 292a 6e5f 7468 7265 6164 7329 3b0a  te)*n_threads);.
+00085b50: 0a20 2020 202f 2f20 696e 6974 6961 6c69  .    // initiali
+00085b60: 7a65 2074 6173 6b73 202b 2077 6f72 6b20  ze tasks + work 
+00085b70: 6275 6666 6572 0a20 2020 207b 0a20 2020  buffer.    {.   
+00085b80: 2020 2020 2073 697a 655f 7420 776f 726b       size_t work
+00085b90: 5f73 697a 6520 3d20 303b 0a0a 2020 2020  _size = 0;..    
+00085ba0: 2020 2020 2f2f 2074 6872 6561 6420 7363      // thread sc
+00085bb0: 6865 6475 6c69 6e67 2066 6f72 2074 6865  heduling for the
+00085bc0: 2064 6966 6665 7265 6e74 206f 7065 7261   different opera
+00085bd0: 7469 6f6e 730a 2020 2020 2020 2020 666f  tions.        fo
+00085be0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00085bf0: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
+00085c00: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
+00085c10: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00085c20: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
+00085c30: 3d20 6367 7261 7068 2d3e 6e6f 6465 735b  = cgraph->nodes[
+00085c40: 695d 3b0a 0a20 2020 2020 2020 2020 2020  i];..           
+00085c50: 2073 7769 7463 6820 286e 6f64 652d 3e6f   switch (node->o
+00085c60: 7029 207b 0a20 2020 2020 2020 2020 2020  p) {.           
+00085c70: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00085c80: 505f 4350 593a 0a20 2020 2020 2020 2020  P_CPY:.         
+00085c90: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00085ca0: 5f4f 505f 4455 503a 0a20 2020 2020 2020  _OP_DUP:.       
+00085cb0: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00085cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085cd0: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
+00085ce0: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
+00085cf0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00085d00: 2020 2020 2020 2020 2020 2073 697a 655f             size_
+00085d10: 7420 6375 7220 3d20 303b 0a20 2020 2020  t cur = 0;.     
+00085d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085d30: 2020 2069 6620 2867 676d 6c5f 6973 5f71     if (ggml_is_q
+00085d40: 7561 6e74 697a 6564 286e 6f64 652d 3e74  uantized(node->t
+00085d50: 7970 6529 2920 7b0a 2020 2020 2020 2020  ype)) {.        
 00085d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085d70: 6966 2028 6767 6d6c 5f69 735f 7175 616e  if (ggml_is_quan
-00085d80: 7469 7a65 6428 6e6f 6465 2d3e 7372 6330  tized(node->src0
-00085d90: 2d3e 7479 7065 2929 207b 0a20 2020 2020  ->type)) {.     
-00085da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085db0: 2020 2020 2020 2063 7572 203d 2047 474d         cur = GGM
-00085dc0: 4c5f 5459 5045 5f53 495a 455b 4747 4d4c  L_TYPE_SIZE[GGML
-00085dd0: 5f54 5950 455f 4633 325d 202a 206e 6f64  _TYPE_F32] * nod
-00085de0: 652d 3e73 7263 302d 3e6e 655b 305d 202a  e->src0->ne[0] *
-00085df0: 206e 5f74 6872 6561 6473 3b0a 2020 2020   n_threads;.    
-00085e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085e10: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00085e20: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00085e30: 6f72 6b5f 7369 7a65 203d 204d 4158 2877  ork_size = MAX(w
-00085e40: 6f72 6b5f 7369 7a65 2c20 6375 7229 3b0a  ork_size, cur);.
-00085e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085e60: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00085e70: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00085e80: 6520 4747 4d4c 5f4f 505f 4143 433a 0a20  e GGML_OP_ACC:. 
-00085e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085ea0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00085eb0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00085ec0: 652d 3e6e 5f74 6173 6b73 203d 206e 5f74  e->n_tasks = n_t
-00085ed0: 6872 6561 6473 3b0a 0a20 2020 2020 2020  hreads;..       
+00085d70: 2020 2020 6375 7220 3d20 4747 4d4c 5f54      cur = GGML_T
+00085d80: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
+00085d90: 5045 5f46 3332 5d20 2a20 6e6f 6465 2d3e  PE_F32] * node->
+00085da0: 6e65 5b30 5d20 2a20 6e5f 7468 7265 6164  ne[0] * n_thread
+00085db0: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
+00085dc0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+00085dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085de0: 2020 2020 2020 776f 726b 5f73 697a 6520        work_size 
+00085df0: 3d20 4d41 5828 776f 726b 5f73 697a 652c  = MAX(work_size,
+00085e00: 2063 7572 293b 0a20 2020 2020 2020 2020   cur);.         
+00085e10: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00085e20: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
+00085e30: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00085e40: 5f41 4444 3a0a 2020 2020 2020 2020 2020  _ADD:.          
+00085e50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00085e60: 4f50 5f41 4444 313a 0a20 2020 2020 2020  OP_ADD1:.       
+00085e70: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00085e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085e90: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
+00085ea0: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
+00085eb0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00085ec0: 2020 2020 2020 2020 2020 2073 697a 655f             size_
+00085ed0: 7420 6375 7220 3d20 303b 0a0a 2020 2020  t cur = 0;..    
 00085ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085ef0: 2073 697a 655f 7420 6375 7220 3d20 303b   size_t cur = 0;
-00085f00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00085f10: 2020 2020 2020 2020 2020 6966 2028 6767            if (gg
-00085f20: 6d6c 5f69 735f 7175 616e 7469 7a65 6428  ml_is_quantized(
-00085f30: 6e6f 6465 2d3e 7372 6330 2d3e 7479 7065  node->src0->type
-00085f40: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
-00085f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085f60: 2063 7572 203d 2047 474d 4c5f 5459 5045   cur = GGML_TYPE
-00085f70: 5f53 495a 455b 4747 4d4c 5f54 5950 455f  _SIZE[GGML_TYPE_
-00085f80: 4633 325d 202a 206e 6f64 652d 3e73 7263  F32] * node->src
-00085f90: 312d 3e6e 655b 305d 202a 206e 5f74 6872  1->ne[0] * n_thr
-00085fa0: 6561 6473 3b0a 2020 2020 2020 2020 2020  eads;.          
-00085fb0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00085fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00085fd0: 2020 2020 2020 2020 2077 6f72 6b5f 7369           work_si
-00085fe0: 7a65 203d 204d 4158 2877 6f72 6b5f 7369  ze = MAX(work_si
-00085ff0: 7a65 2c20 6375 7229 3b0a 2020 2020 2020  ze, cur);.      
-00086000: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00086010: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-00086020: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00086030: 5f4f 505f 5355 423a 0a20 2020 2020 2020  _OP_SUB:.       
-00086040: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00086050: 4d4c 5f4f 505f 4449 563a 0a20 2020 2020  ML_OP_DIV:.     
-00086060: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00086070: 4747 4d4c 5f4f 505f 5351 523a 0a20 2020  GGML_OP_SQR:.   
-00086080: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00086090: 6520 4747 4d4c 5f4f 505f 5351 5254 3a0a  e GGML_OP_SQRT:.
-000860a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000860b0: 6361 7365 2047 474d 4c5f 4f50 5f4c 4f47  case GGML_OP_LOG
-000860c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000860d0: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
-000860e0: 554d 3a0a 2020 2020 2020 2020 2020 2020  UM:.            
-000860f0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00086100: 5f53 554d 5f52 4f57 533a 0a20 2020 2020  _SUM_ROWS:.     
-00086110: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00086120: 4747 4d4c 5f4f 505f 4d45 414e 3a0a 2020  GGML_OP_MEAN:.  
-00086130: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00086140: 7365 2047 474d 4c5f 4f50 5f52 4550 4541  se GGML_OP_REPEA
-00086150: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
-00086160: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00086170: 5245 5045 4154 5f42 4143 4b3a 0a20 2020  REPEAT_BACK:.   
-00086180: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00086190: 6520 4747 4d4c 5f4f 505f 4142 533a 0a20  e GGML_OP_ABS:. 
-000861a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000861b0: 6173 6520 4747 4d4c 5f4f 505f 5347 4e3a  ase GGML_OP_SGN:
-000861c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000861d0: 2063 6173 6520 4747 4d4c 5f4f 505f 4e45   case GGML_OP_NE
-000861e0: 473a 0a20 2020 2020 2020 2020 2020 2020  G:.             
-000861f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00086200: 5354 4550 3a0a 2020 2020 2020 2020 2020  STEP:.          
-00086210: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00086220: 4f50 5f52 454c 553a 0a20 2020 2020 2020  OP_RELU:.       
-00086230: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00086240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086250: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
-00086260: 6173 6b73 203d 2031 3b0a 2020 2020 2020  asks = 1;.      
-00086270: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00086280: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-00086290: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000862a0: 5f4f 505f 4d55 4c3a 0a20 2020 2020 2020  _OP_MUL:.       
-000862b0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-000862c0: 4d4c 5f4f 505f 4745 4c55 3a0a 2020 2020  ML_OP_GELU:.    
-000862d0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-000862e0: 2047 474d 4c5f 4f50 5f47 454c 555f 5155   GGML_OP_GELU_QU
-000862f0: 4943 4b3a 0a20 2020 2020 2020 2020 2020  ICK:.           
-00086300: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00086310: 505f 5349 4c55 3a0a 2020 2020 2020 2020  P_SILU:.        
-00086320: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00086330: 4c5f 4f50 5f53 494c 555f 4241 434b 3a0a  L_OP_SILU_BACK:.
-00086340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086350: 6361 7365 2047 474d 4c5f 4f50 5f4e 4f52  case GGML_OP_NOR
-00086360: 4d3a 0a20 2020 2020 2020 2020 2020 2020  M:.             
-00086370: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00086380: 524d 535f 4e4f 524d 3a0a 2020 2020 2020  RMS_NORM:.      
+00085ef0: 2020 2020 6966 2028 6767 6d6c 5f69 735f      if (ggml_is_
+00085f00: 7175 616e 7469 7a65 6428 6e6f 6465 2d3e  quantized(node->
+00085f10: 7372 6330 2d3e 7479 7065 2929 207b 0a20  src0->type)) {. 
+00085f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085f30: 2020 2020 2020 2020 2020 2063 7572 203d             cur =
+00085f40: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
+00085f50: 4747 4d4c 5f54 5950 455f 4633 325d 202a  GGML_TYPE_F32] *
+00085f60: 206e 6f64 652d 3e73 7263 302d 3e6e 655b   node->src0->ne[
+00085f70: 305d 202a 206e 5f74 6872 6561 6473 3b0a  0] * n_threads;.
+00085f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085f90: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00085fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085fb0: 2020 2077 6f72 6b5f 7369 7a65 203d 204d     work_size = M
+00085fc0: 4158 2877 6f72 6b5f 7369 7a65 2c20 6375  AX(work_size, cu
+00085fd0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00085fe0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00085ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086000: 2063 6173 6520 4747 4d4c 5f4f 505f 4143   case GGML_OP_AC
+00086010: 433a 0a20 2020 2020 2020 2020 2020 2020  C:.             
+00086020: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00086030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086040: 206e 6f64 652d 3e6e 5f74 6173 6b73 203d   node->n_tasks =
+00086050: 206e 5f74 6872 6561 6473 3b0a 0a20 2020   n_threads;..   
+00086060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086070: 2020 2020 2073 697a 655f 7420 6375 7220       size_t cur 
+00086080: 3d20 303b 0a0a 2020 2020 2020 2020 2020  = 0;..          
+00086090: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000860a0: 2028 6767 6d6c 5f69 735f 7175 616e 7469   (ggml_is_quanti
+000860b0: 7a65 6428 6e6f 6465 2d3e 7372 6330 2d3e  zed(node->src0->
+000860c0: 7479 7065 2929 207b 0a20 2020 2020 2020  type)) {.       
+000860d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000860e0: 2020 2020 2063 7572 203d 2047 474d 4c5f       cur = GGML_
+000860f0: 5459 5045 5f53 495a 455b 4747 4d4c 5f54  TYPE_SIZE[GGML_T
+00086100: 5950 455f 4633 325d 202a 206e 6f64 652d  YPE_F32] * node-
+00086110: 3e73 7263 312d 3e6e 655b 305d 202a 206e  >src1->ne[0] * n
+00086120: 5f74 6872 6561 6473 3b0a 2020 2020 2020  _threads;.      
+00086130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086140: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00086150: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+00086160: 6b5f 7369 7a65 203d 204d 4158 2877 6f72  k_size = MAX(wor
+00086170: 6b5f 7369 7a65 2c20 6375 7229 3b0a 2020  k_size, cur);.  
+00086180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086190: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000861a0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+000861b0: 4747 4d4c 5f4f 505f 5355 423a 0a20 2020  GGML_OP_SUB:.   
+000861c0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+000861d0: 6520 4747 4d4c 5f4f 505f 4449 563a 0a20  e GGML_OP_DIV:. 
+000861e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000861f0: 6173 6520 4747 4d4c 5f4f 505f 5351 523a  ase GGML_OP_SQR:
+00086200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086210: 2063 6173 6520 4747 4d4c 5f4f 505f 5351   case GGML_OP_SQ
+00086220: 5254 3a0a 2020 2020 2020 2020 2020 2020  RT:.            
+00086230: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00086240: 5f4c 4f47 3a0a 2020 2020 2020 2020 2020  _LOG:.          
+00086250: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00086260: 4f50 5f53 554d 3a0a 2020 2020 2020 2020  OP_SUM:.        
+00086270: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00086280: 4c5f 4f50 5f53 554d 5f52 4f57 533a 0a20  L_OP_SUM_ROWS:. 
+00086290: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000862a0: 6173 6520 4747 4d4c 5f4f 505f 4d45 414e  ase GGML_OP_MEAN
+000862b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000862c0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
+000862d0: 4550 4541 543a 0a20 2020 2020 2020 2020  EPEAT:.         
+000862e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000862f0: 5f4f 505f 5245 5045 4154 5f42 4143 4b3a  _OP_REPEAT_BACK:
+00086300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086310: 2063 6173 6520 4747 4d4c 5f4f 505f 4142   case GGML_OP_AB
+00086320: 533a 0a20 2020 2020 2020 2020 2020 2020  S:.             
+00086330: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00086340: 5347 4e3a 0a20 2020 2020 2020 2020 2020  SGN:.           
+00086350: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00086360: 505f 4e45 473a 0a20 2020 2020 2020 2020  P_NEG:.         
+00086370: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00086380: 5f4f 505f 5354 4550 3a0a 2020 2020 2020  _OP_STEP:.      
 00086390: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-000863a0: 474d 4c5f 4f50 5f52 4d53 5f4e 4f52 4d5f  GML_OP_RMS_NORM_
-000863b0: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
-000863c0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000863d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000863e0: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
-000863f0: 7320 3d20 6e5f 7468 7265 6164 733b 0a20  s = n_threads;. 
-00086400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086410: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00086420: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00086430: 2047 474d 4c5f 4f50 5f4d 554c 5f4d 4154   GGML_OP_MUL_MAT
-00086440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00086450: 2020 6361 7365 2047 474d 4c5f 4f50 5f4f    case GGML_OP_O
-00086460: 5554 5f50 524f 443a 0a20 2020 2020 2020  UT_PROD:.       
-00086470: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00086480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086490: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
-000864a0: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
-000864b0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000864c0: 2020 2020 2020 2020 2020 202f 2f20 544f             // TO
-000864d0: 444f 3a20 7573 6520 6469 6666 6572 656e  DO: use differen
-000864e0: 7420 7363 6865 6475 6c69 6e67 2066 6f72  t scheduling for
-000864f0: 2064 6966 6665 7265 6e74 206d 6174 7269   different matri
-00086500: 7820 7369 7a65 730a 2020 2020 2020 2020  x sizes.        
-00086510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086520: 2f2f 636f 6e73 7420 696e 7420 6e72 3020  //const int nr0 
-00086530: 3d20 6767 6d6c 5f6e 726f 7773 286e 6f64  = ggml_nrows(nod
-00086540: 652d 3e73 7263 3029 3b0a 2020 2020 2020  e->src0);.      
+000863a0: 474d 4c5f 4f50 5f52 454c 553a 0a20 2020  GML_OP_RELU:.   
+000863b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000863c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000863d0: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+000863e0: 3e6e 5f74 6173 6b73 203d 2031 3b0a 2020  >n_tasks = 1;.  
+000863f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086400: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00086410: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00086420: 4747 4d4c 5f4f 505f 4d55 4c3a 0a20 2020  GGML_OP_MUL:.   
+00086430: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00086440: 6520 4747 4d4c 5f4f 505f 4745 4c55 3a0a  e GGML_OP_GELU:.
+00086450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086460: 6361 7365 2047 474d 4c5f 4f50 5f47 454c  case GGML_OP_GEL
+00086470: 555f 5155 4943 4b3a 0a20 2020 2020 2020  U_QUICK:.       
+00086480: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00086490: 4d4c 5f4f 505f 5349 4c55 3a0a 2020 2020  ML_OP_SILU:.    
+000864a0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+000864b0: 2047 474d 4c5f 4f50 5f53 494c 555f 4241   GGML_OP_SILU_BA
+000864c0: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+000864d0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+000864e0: 5f4e 4f52 4d3a 0a20 2020 2020 2020 2020  _NORM:.         
+000864f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00086500: 5f4f 505f 524d 535f 4e4f 524d 3a0a 2020  _OP_RMS_NORM:.  
+00086510: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00086520: 7365 2047 474d 4c5f 4f50 5f52 4d53 5f4e  se GGML_OP_RMS_N
+00086530: 4f52 4d5f 4241 434b 3a0a 2020 2020 2020  ORM_BACK:.      
+00086540: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 00086550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086560: 2020 2f2f 636f 6e73 7420 696e 7420 6e72    //const int nr
-00086570: 3120 3d20 6767 6d6c 5f6e 726f 7773 286e  1 = ggml_nrows(n
-00086580: 6f64 652d 3e73 7263 3129 3b0a 0a20 2020  ode->src1);..   
-00086590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000865a0: 2020 2020 202f 2f6e 6f64 652d 3e6e 5f74       //node->n_t
-000865b0: 6173 6b73 203d 204d 494e 286e 5f74 6872  asks = MIN(n_thr
-000865c0: 6561 6473 2c20 4d41 5828 312c 206e 7230  eads, MAX(1, nr0
-000865d0: 2f31 3238 2929 3b0a 2020 2020 2020 2020  /128));.        
-000865e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000865f0: 2f2f 7072 696e 7466 2822 6e72 3020 3d20  //printf("nr0 = 
-00086600: 2538 642c 206e 7231 203d 2025 3864 2c20  %8d, nr1 = %8d, 
-00086610: 6e72 302a 6e72 3120 3d20 2538 642c 206e  nr0*nr1 = %8d, n
-00086620: 5f74 6173 6b73 203d 2025 645c 6e22 2c20  _tasks = %d\n", 
-00086630: 6e72 302c 206e 7231 2c20 6e72 302a 6e72  nr0, nr1, nr0*nr
-00086640: 312c 206e 6f64 652d 3e6e 5f74 6173 6b73  1, node->n_tasks
-00086650: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00086660: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-00086670: 5f74 2063 7572 203d 2030 3b0a 0a23 6966  _t cur = 0;..#if
-00086680: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
-00086690: 455f 4355 424c 4153 290a 2020 2020 2020  E_CUBLAS).      
-000866a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000866b0: 2020 6966 2028 6767 6d6c 5f63 7564 615f    if (ggml_cuda_
-000866c0: 6361 6e5f 6d75 6c5f 6d61 7428 6e6f 6465  can_mul_mat(node
-000866d0: 2d3e 7372 6330 2c20 6e6f 6465 2d3e 7372  ->src0, node->sr
-000866e0: 6331 2c20 6e6f 6465 2929 207b 0a20 2020  c1, node)) {.   
-000866f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086700: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
-00086710: 5f74 6173 6b73 203d 2031 3b20 2f2f 2054  _tasks = 1; // T
-00086720: 4f44 4f3a 2074 6869 7320 6163 7475 616c  ODO: this actual
-00086730: 6c79 2069 7320 646f 696e 6720 6e6f 7468  ly is doing noth
-00086740: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-00086750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086560: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+00086570: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
+00086580: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
+00086590: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000865a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000865b0: 6361 7365 2047 474d 4c5f 4f50 5f4d 554c  case GGML_OP_MUL
+000865c0: 5f4d 4154 3a0a 2020 2020 2020 2020 2020  _MAT:.          
+000865d0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000865e0: 4f50 5f4f 5554 5f50 524f 443a 0a20 2020  OP_OUT_PROD:.   
+000865f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086600: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00086610: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+00086620: 3e6e 5f74 6173 6b73 203d 206e 5f74 6872  >n_tasks = n_thr
+00086630: 6561 6473 3b0a 0a20 2020 2020 2020 2020  eads;..         
+00086640: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00086650: 2f20 544f 444f 3a20 7573 6520 6469 6666  / TODO: use diff
+00086660: 6572 656e 7420 7363 6865 6475 6c69 6e67  erent scheduling
+00086670: 2066 6f72 2064 6966 6665 7265 6e74 206d   for different m
+00086680: 6174 7269 7820 7369 7a65 730a 2020 2020  atrix sizes.    
+00086690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000866a0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+000866b0: 6e72 3020 3d20 6767 6d6c 5f6e 726f 7773  nr0 = ggml_nrows
+000866c0: 286e 6f64 652d 3e73 7263 3029 3b0a 2020  (node->src0);.  
+000866d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000866e0: 2020 2020 2020 2f2f 636f 6e73 7420 696e        //const in
+000866f0: 7420 6e72 3120 3d20 6767 6d6c 5f6e 726f  t nr1 = ggml_nro
+00086700: 7773 286e 6f64 652d 3e73 7263 3129 3b0a  ws(node->src1);.
+00086710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086720: 2020 2020 2020 2020 202f 2f6e 6f64 652d           //node-
+00086730: 3e6e 5f74 6173 6b73 203d 204d 494e 286e  >n_tasks = MIN(n
+00086740: 5f74 6872 6561 6473 2c20 4d41 5828 312c  _threads, MAX(1,
+00086750: 206e 7230 2f31 3238 2929 3b0a 2020 2020   nr0/128));.    
 00086760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086770: 2020 2020 2f2f 2020 2020 2020 2074 6865      //       the
-00086780: 2074 6872 6561 6473 2061 7265 2073 7469   threads are sti
-00086790: 6c6c 2073 7069 6e6e 696e 670a 2020 2020  ll spinning.    
-000867a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000867b0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000867c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000867d0: 7365 0a23 656c 6966 2064 6566 696e 6564  se.#elif defined
-000867e0: 2847 474d 4c5f 5553 455f 434c 424c 4153  (GGML_USE_CLBLAS
-000867f0: 5429 0a20 2020 2020 2020 2020 2020 2020  T).             
-00086800: 2020 2020 2020 2020 2020 2069 6620 2867             if (g
-00086810: 676d 6c5f 636c 5f63 616e 5f6d 756c 5f6d  gml_cl_can_mul_m
-00086820: 6174 286e 6f64 652d 3e73 7263 302c 206e  at(node->src0, n
-00086830: 6f64 652d 3e73 7263 312c 206e 6f64 6529  ode->src1, node)
-00086840: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00086850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086860: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-00086870: 313b 202f 2f20 544f 444f 3a20 7468 6973  1; // TODO: this
-00086880: 2061 6374 7561 6c6c 7920 6973 2064 6f69   actually is doi
-00086890: 6e67 206e 6f74 6869 6e67 0a20 2020 2020  ng nothing.     
-000868a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000868b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000868c0: 2020 2020 2020 2020 2020 202f 2f20 2020             //   
-000868d0: 2020 2020 7468 6520 7468 7265 6164 7320      the threads 
-000868e0: 6172 6520 7374 696c 6c20 7370 696e 6e69  are still spinni
-000868f0: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-00086900: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00086910: 7572 203d 2067 676d 6c5f 636c 5f6d 756c  ur = ggml_cl_mul
-00086920: 5f6d 6174 5f67 6574 5f77 7369 7a65 286e  _mat_get_wsize(n
-00086930: 6f64 652d 3e73 7263 302c 206e 6f64 652d  ode->src0, node-
-00086940: 3e73 7263 312c 206e 6f64 6529 3b0a 2020  >src1, node);.  
-00086950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086960: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00086970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086980: 656c 7365 0a23 656e 6469 660a 2020 2020  else.#endif.    
-00086990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000869a0: 2020 2020 6966 2028 6e6f 6465 2d3e 7372      if (node->sr
-000869b0: 6330 2d3e 7479 7065 203d 3d20 4747 4d4c  c0->type == GGML
-000869c0: 5f54 5950 455f 4631 3620 2626 206e 6f64  _TYPE_F16 && nod
-000869d0: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
-000869e0: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
-000869f0: 7b0a 2369 6620 6465 6669 6e65 6428 4747  {.#if defined(GG
-00086a00: 4d4c 5f55 5345 5f41 4343 454c 4552 4154  ML_USE_ACCELERAT
-00086a10: 4529 207c 7c20 6465 6669 6e65 6428 4747  E) || defined(GG
-00086a20: 4d4c 5f55 5345 5f4f 5045 4e42 4c41 5329  ML_USE_OPENBLAS)
-00086a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00086a40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00086a50: 2867 676d 6c5f 636f 6d70 7574 655f 666f  (ggml_compute_fo
-00086a60: 7277 6172 645f 6d75 6c5f 6d61 745f 7573  rward_mul_mat_us
-00086a70: 655f 626c 6173 286e 6f64 652d 3e73 7263  e_blas(node->src
-00086a80: 302c 206e 6f64 652d 3e73 7263 312c 206e  0, node->src1, n
-00086a90: 6f64 6529 2920 7b0a 2020 2020 2020 2020  ode)) {.        
-00086aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086ab0: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
-00086ac0: 7461 736b 7320 3d20 313b 202f 2f20 544f  tasks = 1; // TO
-00086ad0: 444f 3a20 7468 6973 2061 6374 7561 6c6c  DO: this actuall
-00086ae0: 7920 6973 2064 6f69 6e67 206e 6f74 6869  y is doing nothi
-00086af0: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-00086b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086770: 2020 2020 2f2f 7072 696e 7466 2822 6e72      //printf("nr
+00086780: 3020 3d20 2538 642c 206e 7231 203d 2025  0 = %8d, nr1 = %
+00086790: 3864 2c20 6e72 302a 6e72 3120 3d20 2538  8d, nr0*nr1 = %8
+000867a0: 642c 206e 5f74 6173 6b73 203d 2025 645c  d, n_tasks = %d\
+000867b0: 6e22 2c20 6e72 302c 206e 7231 2c20 6e72  n", nr0, nr1, nr
+000867c0: 302a 6e72 312c 206e 6f64 652d 3e6e 5f74  0*nr1, node->n_t
+000867d0: 6173 6b73 293b 0a0a 2020 2020 2020 2020  asks);..        
+000867e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000867f0: 7369 7a65 5f74 2063 7572 203d 2030 3b0a  size_t cur = 0;.
+00086800: 0a23 6966 2064 6566 696e 6564 2847 474d  .#if defined(GGM
+00086810: 4c5f 5553 455f 4355 424c 4153 290a 2020  L_USE_CUBLAS).  
+00086820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086830: 2020 2020 2020 6966 2028 6767 6d6c 5f63        if (ggml_c
+00086840: 7564 615f 6361 6e5f 6d75 6c5f 6d61 7428  uda_can_mul_mat(
+00086850: 6e6f 6465 2d3e 7372 6330 2c20 6e6f 6465  node->src0, node
+00086860: 2d3e 7372 6331 2c20 6e6f 6465 2929 207b  ->src1, node)) {
+00086870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086880: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00086890: 652d 3e6e 5f74 6173 6b73 203d 2031 3b20  e->n_tasks = 1; 
+000868a0: 2f2f 2054 4f44 4f3a 2074 6869 7320 6163  // TODO: this ac
+000868b0: 7475 616c 6c79 2069 7320 646f 696e 6720  tually is doing 
+000868c0: 6e6f 7468 696e 670a 2020 2020 2020 2020  nothing.        
+000868d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000868e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000868f0: 2020 2020 2020 2020 2f2f 2020 2020 2020          //      
+00086900: 2074 6865 2074 6872 6561 6473 2061 7265   the threads are
+00086910: 2073 7469 6c6c 2073 7069 6e6e 696e 670a   still spinning.
+00086920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086930: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00086940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086950: 2020 656c 7365 0a23 656c 6966 2064 6566    else.#elif def
+00086960: 696e 6564 2847 474d 4c5f 5553 455f 434c  ined(GGML_USE_CL
+00086970: 424c 4153 5429 0a20 2020 2020 2020 2020  BLAST).         
+00086980: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00086990: 6620 2867 676d 6c5f 636c 5f63 616e 5f6d  f (ggml_cl_can_m
+000869a0: 756c 5f6d 6174 286e 6f64 652d 3e73 7263  ul_mat(node->src
+000869b0: 302c 206e 6f64 652d 3e73 7263 312c 206e  0, node->src1, n
+000869c0: 6f64 6529 2920 7b0a 2020 2020 2020 2020  ode)) {.        
+000869d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000869e0: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
+000869f0: 7320 3d20 313b 202f 2f20 544f 444f 3a20  s = 1; // TODO: 
+00086a00: 7468 6973 2061 6374 7561 6c6c 7920 6973  this actually is
+00086a10: 2064 6f69 6e67 206e 6f74 6869 6e67 0a20   doing nothing. 
+00086a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086a40: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00086a50: 2f20 2020 2020 2020 7468 6520 7468 7265  /       the thre
+00086a60: 6164 7320 6172 6520 7374 696c 6c20 7370  ads are still sp
+00086a70: 696e 6e69 6e67 0a20 2020 2020 2020 2020  inning.         
+00086a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086a90: 2020 2063 7572 203d 2067 676d 6c5f 636c     cur = ggml_cl
+00086aa0: 5f6d 756c 5f6d 6174 5f67 6574 5f77 7369  _mul_mat_get_wsi
+00086ab0: 7a65 286e 6f64 652d 3e73 7263 302c 206e  ze(node->src0, n
+00086ac0: 6f64 652d 3e73 7263 312c 206e 6f64 6529  ode->src1, node)
+00086ad0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00086ae0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00086af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086b00: 2020 2020 656c 7365 0a23 656e 6469 660a      else.#endif.
 00086b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086b20: 2020 2020 2020 2f2f 2020 2020 2020 2074        //       t
-00086b30: 6865 2074 6872 6561 6473 2061 7265 2073  he threads are s
-00086b40: 7469 6c6c 2073 7069 6e6e 696e 670a 2020  till spinning.  
-00086b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086b60: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00086b70: 2068 6572 6520 7765 206e 6565 6420 6d65   here we need me
-00086b80: 6d6f 7279 206a 7573 7420 666f 7220 7369  mory just for si
-00086b90: 6e67 6c65 2032 4420 6d61 7472 6978 2066  ngle 2D matrix f
-00086ba0: 726f 6d20 7372 6330 0a20 2020 2020 2020  rom src0.       
-00086bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086bc0: 2020 2020 2020 2020 2063 7572 203d 2047           cur = G
-00086bd0: 474d 4c5f 5459 5045 5f53 495a 455b 4747  GML_TYPE_SIZE[GG
-00086be0: 4d4c 5f54 5950 455f 4633 325d 2a28 6e6f  ML_TYPE_F32]*(no
-00086bf0: 6465 2d3e 7372 6330 2d3e 6e65 5b30 5d2a  de->src0->ne[0]*
-00086c00: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b31  node->src0->ne[1
-00086c10: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
+00086b20: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
+00086b30: 2d3e 7372 6330 2d3e 7479 7065 203d 3d20  ->src0->type == 
+00086b40: 4747 4d4c 5f54 5950 455f 4631 3620 2626  GGML_TYPE_F16 &&
+00086b50: 206e 6f64 652d 3e73 7263 312d 3e74 7970   node->src1->typ
+00086b60: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+00086b70: 3332 2920 7b0a 2369 6620 6465 6669 6e65  32) {.#if define
+00086b80: 6428 4747 4d4c 5f55 5345 5f41 4343 454c  d(GGML_USE_ACCEL
+00086b90: 4552 4154 4529 207c 7c20 6465 6669 6e65  ERATE) || define
+00086ba0: 6428 4747 4d4c 5f55 5345 5f4f 5045 4e42  d(GGML_USE_OPENB
+00086bb0: 4c41 5329 0a20 2020 2020 2020 2020 2020  LAS).           
+00086bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086bd0: 2069 6620 2867 676d 6c5f 636f 6d70 7574   if (ggml_comput
+00086be0: 655f 666f 7277 6172 645f 6d75 6c5f 6d61  e_forward_mul_ma
+00086bf0: 745f 7573 655f 626c 6173 286e 6f64 652d  t_use_blas(node-
+00086c00: 3e73 7263 302c 206e 6f64 652d 3e73 7263  >src0, node->src
+00086c10: 312c 206e 6f64 6529 2920 7b0a 2020 2020  1, node)) {.    
 00086c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086c30: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-00086c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086c50: 2020 2020 2020 2020 2063 7572 203d 2047           cur = G
-00086c60: 474d 4c5f 5459 5045 5f53 495a 455b 4747  GML_TYPE_SIZE[GG
-00086c70: 4d4c 5f54 5950 455f 4631 365d 2a67 676d  ML_TYPE_F16]*ggm
-00086c80: 6c5f 6e65 6c65 6d65 6e74 7328 6e6f 6465  l_nelements(node
-00086c90: 2d3e 7372 6331 293b 0a20 2020 2020 2020  ->src1);.       
-00086ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086cb0: 2020 2020 207d 0a23 656c 7365 0a20 2020       }.#else.   
-00086cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086cd0: 2020 2020 2020 2020 2063 7572 203d 2047           cur = G
-00086ce0: 474d 4c5f 5459 5045 5f53 495a 455b 4747  GML_TYPE_SIZE[GG
-00086cf0: 4d4c 5f54 5950 455f 4631 365d 2a67 676d  ML_TYPE_F16]*ggm
-00086d00: 6c5f 6e65 6c65 6d65 6e74 7328 6e6f 6465  l_nelements(node
-00086d10: 2d3e 7372 6331 293b 0a23 656e 6469 660a  ->src1);.#endif.
-00086d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086d30: 2020 2020 2020 2020 7d20 656c 7365 2069          } else i
-00086d40: 6620 286e 6f64 652d 3e73 7263 302d 3e74  f (node->src0->t
-00086d50: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00086d60: 5f46 3332 2026 2620 6e6f 6465 2d3e 7372  _F32 && node->sr
-00086d70: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
-00086d80: 5f54 5950 455f 4633 3229 207b 0a20 2020  _TYPE_F32) {.   
-00086d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086da0: 2020 2020 2020 2020 2063 7572 203d 2030           cur = 0
-00086db0: 3b0a 2369 6620 6465 6669 6e65 6428 4747  ;.#if defined(GG
-00086dc0: 4d4c 5f55 5345 5f41 4343 454c 4552 4154  ML_USE_ACCELERAT
-00086dd0: 4529 207c 7c20 6465 6669 6e65 6428 4747  E) || defined(GG
-00086de0: 4d4c 5f55 5345 5f4f 5045 4e42 4c41 5329  ML_USE_OPENBLAS)
-00086df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00086e00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00086e10: 2867 676d 6c5f 636f 6d70 7574 655f 666f  (ggml_compute_fo
-00086e20: 7277 6172 645f 6d75 6c5f 6d61 745f 7573  rward_mul_mat_us
-00086e30: 655f 626c 6173 286e 6f64 652d 3e73 7263  e_blas(node->src
-00086e40: 302c 206e 6f64 652d 3e73 7263 312c 206e  0, node->src1, n
-00086e50: 6f64 6529 2920 7b0a 2020 2020 2020 2020  ode)) {.        
-00086e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086e70: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
-00086e80: 7461 736b 7320 3d20 313b 0a20 2020 2020  tasks = 1;.     
-00086e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086ea0: 2020 2020 2020 207d 0a23 656e 6469 660a         }.#endif.
-00086eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086ec0: 2020 2020 2020 2020 7d20 656c 7365 2069          } else i
-00086ed0: 6620 2867 676d 6c5f 6973 5f71 7561 6e74  f (ggml_is_quant
-00086ee0: 697a 6564 286e 6f64 652d 3e73 7263 302d  ized(node->src0-
-00086ef0: 3e74 7970 6529 2026 2620 6e6f 6465 2d3e  >type) && node->
-00086f00: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-00086f10: 4d4c 5f54 5950 455f 4633 3229 207b 0a23  ML_TYPE_F32) {.#
-00086f20: 6966 2064 6566 696e 6564 2847 474d 4c5f  if defined(GGML_
-00086f30: 5553 455f 4143 4345 4c45 5241 5445 2920  USE_ACCELERATE) 
-00086f40: 7c7c 2064 6566 696e 6564 2847 474d 4c5f  || defined(GGML_
-00086f50: 5553 455f 4f50 454e 424c 4153 290a 2020  USE_OPENBLAS).  
-00086f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086f70: 2020 2020 2020 2020 2020 6966 2028 6767            if (gg
-00086f80: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00086f90: 7264 5f6d 756c 5f6d 6174 5f75 7365 5f62  rd_mul_mat_use_b
-00086fa0: 6c61 7328 6e6f 6465 2d3e 7372 6330 2c20  las(node->src0, 
-00086fb0: 6e6f 6465 2d3e 7372 6331 2c20 6e6f 6465  node->src1, node
-00086fc0: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
-00086fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086fe0: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
-00086ff0: 6b73 203d 2031 3b0a 2020 2020 2020 2020  ks = 1;.        
-00087000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087010: 2020 2020 2020 2020 6375 7220 3d20 4747          cur = GG
-00087020: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
-00087030: 4c5f 5459 5045 5f46 3332 5d2a 286e 6f64  L_TYPE_F32]*(nod
-00087040: 652d 3e73 7263 302d 3e6e 655b 305d 2a6e  e->src0->ne[0]*n
-00087050: 6f64 652d 3e73 7263 302d 3e6e 655b 315d  ode->src0->ne[1]
-00087060: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00087070: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00087080: 2065 6c73 650a 2365 6e64 6966 0a20 2020   else.#endif.   
-00087090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000870a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000870b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000870c0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000870d0: 2065 6e75 6d20 6767 6d6c 5f74 7970 6520   enum ggml_type 
-000870e0: 7479 7065 5f71 203d 2071 7561 6e74 697a  type_q = quantiz
-000870f0: 655f 666e 735b 6e6f 6465 2d3e 7372 6330  e_fns[node->src0
-00087100: 2d3e 7479 7065 5d2e 7665 635f 646f 745f  ->type].vec_dot_
-00087110: 7479 7065 3b0a 2020 2020 2020 2020 2020  type;.          
-00087120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087130: 2020 2020 2020 6375 7220 3d20 4747 4d4c        cur = GGML
-00087140: 5f54 5950 455f 5349 5a45 5b74 7970 655f  _TYPE_SIZE[type_
-00087150: 715d 2a67 676d 6c5f 6e65 6c65 6d65 6e74  q]*ggml_nelement
-00087160: 7328 6e6f 6465 2d3e 7372 6331 292f 4747  s(node->src1)/GG
-00087170: 4d4c 5f42 4c43 4b5f 5349 5a45 5b74 7970  ML_BLCK_SIZE[typ
-00087180: 655f 715d 3b0a 2020 2020 2020 2020 2020  e_q];.          
-00087190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000871a0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000871b0: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-000871c0: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-000871d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000871e0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-000871f0: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00087200: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-00087210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087220: 2020 2020 2020 2020 776f 726b 5f73 697a          work_siz
-00087230: 6520 3d20 4d41 5828 776f 726b 5f73 697a  e = MAX(work_siz
-00087240: 652c 2063 7572 293b 0a20 2020 2020 2020  e, cur);.       
-00087250: 2020 2020 2020 2020 2020 2020 207d 2062               } b
-00087260: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
-00087270: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00087280: 4f50 5f53 4341 4c45 3a0a 2020 2020 2020  OP_SCALE:.      
-00087290: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+00086c30: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00086c40: 2d3e 6e5f 7461 736b 7320 3d20 313b 202f  ->n_tasks = 1; /
+00086c50: 2f20 544f 444f 3a20 7468 6973 2061 6374  / TODO: this act
+00086c60: 7561 6c6c 7920 6973 2064 6f69 6e67 206e  ually is doing n
+00086c70: 6f74 6869 6e67 0a20 2020 2020 2020 2020  othing.         
+00086c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086ca0: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
+00086cb0: 2020 2074 6865 2074 6872 6561 6473 2061     the threads a
+00086cc0: 7265 2073 7469 6c6c 2073 7069 6e6e 696e  re still spinnin
+00086cd0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+00086ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086cf0: 2020 2f2f 2068 6572 6520 7765 206e 6565    // here we nee
+00086d00: 6420 6d65 6d6f 7279 206a 7573 7420 666f  d memory just fo
+00086d10: 7220 7369 6e67 6c65 2032 4420 6d61 7472  r single 2D matr
+00086d20: 6978 2066 726f 6d20 7372 6330 0a20 2020  ix from src0.   
+00086d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086d40: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00086d50: 203d 2047 474d 4c5f 5459 5045 5f53 495a   = GGML_TYPE_SIZ
+00086d60: 455b 4747 4d4c 5f54 5950 455f 4633 325d  E[GGML_TYPE_F32]
+00086d70: 2a28 6e6f 6465 2d3e 7372 6330 2d3e 6e65  *(node->src0->ne
+00086d80: 5b30 5d2a 6e6f 6465 2d3e 7372 6330 2d3e  [0]*node->src0->
+00086d90: 6e65 5b31 5d29 3b0a 2020 2020 2020 2020  ne[1]);.        
+00086da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086db0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+00086dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086dd0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00086de0: 203d 2047 474d 4c5f 5459 5045 5f53 495a   = GGML_TYPE_SIZ
+00086df0: 455b 4747 4d4c 5f54 5950 455f 4631 365d  E[GGML_TYPE_F16]
+00086e00: 2a67 676d 6c5f 6e65 6c65 6d65 6e74 7328  *ggml_nelements(
+00086e10: 6e6f 6465 2d3e 7372 6331 293b 0a20 2020  node->src1);.   
+00086e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086e30: 2020 2020 2020 2020 207d 0a23 656c 7365           }.#else
+00086e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086e50: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00086e60: 203d 2047 474d 4c5f 5459 5045 5f53 495a   = GGML_TYPE_SIZ
+00086e70: 455b 4747 4d4c 5f54 5950 455f 4631 365d  E[GGML_TYPE_F16]
+00086e80: 2a67 676d 6c5f 6e65 6c65 6d65 6e74 7328  *ggml_nelements(
+00086e90: 6e6f 6465 2d3e 7372 6331 293b 0a23 656e  node->src1);.#en
+00086ea0: 6469 660a 2020 2020 2020 2020 2020 2020  dif.            
+00086eb0: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00086ec0: 7365 2069 6620 286e 6f64 652d 3e73 7263  se if (node->src
+00086ed0: 302d 3e74 7970 6520 3d3d 2047 474d 4c5f  0->type == GGML_
+00086ee0: 5459 5045 5f46 3332 2026 2620 6e6f 6465  TYPE_F32 && node
+00086ef0: 2d3e 7372 6331 2d3e 7479 7065 203d 3d20  ->src1->type == 
+00086f00: 4747 4d4c 5f54 5950 455f 4633 3229 207b  GGML_TYPE_F32) {
+00086f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086f20: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00086f30: 203d 2030 3b0a 2369 6620 6465 6669 6e65   = 0;.#if define
+00086f40: 6428 4747 4d4c 5f55 5345 5f41 4343 454c  d(GGML_USE_ACCEL
+00086f50: 4552 4154 4529 207c 7c20 6465 6669 6e65  ERATE) || define
+00086f60: 6428 4747 4d4c 5f55 5345 5f4f 5045 4e42  d(GGML_USE_OPENB
+00086f70: 4c41 5329 0a20 2020 2020 2020 2020 2020  LAS).           
+00086f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086f90: 2069 6620 2867 676d 6c5f 636f 6d70 7574   if (ggml_comput
+00086fa0: 655f 666f 7277 6172 645f 6d75 6c5f 6d61  e_forward_mul_ma
+00086fb0: 745f 7573 655f 626c 6173 286e 6f64 652d  t_use_blas(node-
+00086fc0: 3e73 7263 302c 206e 6f64 652d 3e73 7263  >src0, node->src
+00086fd0: 312c 206e 6f64 6529 2920 7b0a 2020 2020  1, node)) {.    
+00086fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086ff0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00087000: 2d3e 6e5f 7461 736b 7320 3d20 313b 0a20  ->n_tasks = 1;. 
+00087010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087020: 2020 2020 2020 2020 2020 207d 0a23 656e             }.#en
+00087030: 6469 660a 2020 2020 2020 2020 2020 2020  dif.            
+00087040: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00087050: 7365 2069 6620 2867 676d 6c5f 6973 5f71  se if (ggml_is_q
+00087060: 7561 6e74 697a 6564 286e 6f64 652d 3e73  uantized(node->s
+00087070: 7263 302d 3e74 7970 6529 2026 2620 6e6f  rc0->type) && no
+00087080: 6465 2d3e 7372 6331 2d3e 7479 7065 203d  de->src1->type =
+00087090: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
+000870a0: 207b 0a23 6966 2064 6566 696e 6564 2847   {.#if defined(G
+000870b0: 474d 4c5f 5553 455f 4143 4345 4c45 5241  GML_USE_ACCELERA
+000870c0: 5445 2920 7c7c 2064 6566 696e 6564 2847  TE) || defined(G
+000870d0: 474d 4c5f 5553 455f 4f50 454e 424c 4153  GML_USE_OPENBLAS
+000870e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000870f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00087100: 2028 6767 6d6c 5f63 6f6d 7075 7465 5f66   (ggml_compute_f
+00087110: 6f72 7761 7264 5f6d 756c 5f6d 6174 5f75  orward_mul_mat_u
+00087120: 7365 5f62 6c61 7328 6e6f 6465 2d3e 7372  se_blas(node->sr
+00087130: 6330 2c20 6e6f 6465 2d3e 7372 6331 2c20  c0, node->src1, 
+00087140: 6e6f 6465 2929 207b 0a20 2020 2020 2020  node)) {.       
+00087150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087160: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
+00087170: 5f74 6173 6b73 203d 2031 3b0a 2020 2020  _tasks = 1;.    
+00087180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087190: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
+000871a0: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
+000871b0: 5b47 474d 4c5f 5459 5045 5f46 3332 5d2a  [GGML_TYPE_F32]*
+000871c0: 286e 6f64 652d 3e73 7263 302d 3e6e 655b  (node->src0->ne[
+000871d0: 305d 2a6e 6f64 652d 3e73 7263 302d 3e6e  0]*node->src0->n
+000871e0: 655b 315d 293b 0a20 2020 2020 2020 2020  e[1]);.         
+000871f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087200: 2020 207d 2065 6c73 650a 2365 6e64 6966     } else.#endif
+00087210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00087220: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00087230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087240: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00087250: 6f6e 7374 2065 6e75 6d20 6767 6d6c 5f74  onst enum ggml_t
+00087260: 7970 6520 7479 7065 5f71 203d 2071 7561  ype type_q = qua
+00087270: 6e74 697a 655f 666e 735b 6e6f 6465 2d3e  ntize_fns[node->
+00087280: 7372 6330 2d3e 7479 7065 5d2e 7665 635f  src0->type].vec_
+00087290: 646f 745f 7479 7065 3b0a 2020 2020 2020  dot_type;.      
 000872a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000872b0: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
-000872c0: 7461 736b 7320 3d20 313b 0a20 2020 2020  tasks = 1;.     
-000872d0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000872e0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000872f0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00087300: 4c5f 4f50 5f53 4554 3a0a 2020 2020 2020  L_OP_SET:.      
-00087310: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00087320: 474d 4c5f 4f50 5f43 4f4e 543a 0a20 2020  GML_OP_CONT:.   
-00087330: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00087340: 6520 4747 4d4c 5f4f 505f 5245 5348 4150  e GGML_OP_RESHAP
-00087350: 453a 0a20 2020 2020 2020 2020 2020 2020  E:.             
-00087360: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00087370: 5649 4557 3a0a 2020 2020 2020 2020 2020  VIEW:.          
-00087380: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00087390: 4f50 5f50 4552 4d55 5445 3a0a 2020 2020  OP_PERMUTE:.    
-000873a0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-000873b0: 2047 474d 4c5f 4f50 5f54 5241 4e53 504f   GGML_OP_TRANSPO
-000873c0: 5345 3a0a 2020 2020 2020 2020 2020 2020  SE:.            
-000873d0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000873e0: 5f47 4554 5f52 4f57 533a 0a20 2020 2020  _GET_ROWS:.     
-000873f0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00087400: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
-00087410: 5f42 4143 4b3a 0a20 2020 2020 2020 2020  _BACK:.         
-00087420: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00087430: 5f4f 505f 4449 4147 3a0a 2020 2020 2020  _OP_DIAG:.      
-00087440: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00087450: 474d 4c5f 4f50 5f44 4941 475f 4d41 534b  GML_OP_DIAG_MASK
-00087460: 5f5a 4552 4f3a 0a20 2020 2020 2020 2020  _ZERO:.         
-00087470: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00087480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087490: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
-000874a0: 6b73 203d 2031 3b0a 2020 2020 2020 2020  ks = 1;.        
-000874b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000874c0: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
-000874d0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000874e0: 505f 4449 4147 5f4d 4153 4b5f 494e 463a  P_DIAG_MASK_INF:
-000874f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00087500: 2063 6173 6520 4747 4d4c 5f4f 505f 534f   case GGML_OP_SO
-00087510: 4654 5f4d 4158 3a0a 2020 2020 2020 2020  FT_MAX:.        
-00087520: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00087530: 4c5f 4f50 5f53 4f46 545f 4d41 585f 4241  L_OP_SOFT_MAX_BA
-00087540: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
-00087550: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00087560: 5f52 4f50 453a 0a20 2020 2020 2020 2020  _ROPE:.         
-00087570: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00087580: 5f4f 505f 524f 5045 5f42 4143 4b3a 0a20  _OP_ROPE_BACK:. 
-00087590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000875a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000875b0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-000875c0: 652d 3e6e 5f74 6173 6b73 203d 206e 5f74  e->n_tasks = n_t
-000875d0: 6872 6561 6473 3b0a 2020 2020 2020 2020  hreads;.        
-000875e0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000875f0: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
-00087600: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00087610: 505f 414c 4942 493a 0a20 2020 2020 2020  P_ALIBI:.       
-00087620: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+000872b0: 2020 2020 2020 2020 2020 6375 7220 3d20            cur = 
+000872c0: 4747 4d4c 5f54 5950 455f 5349 5a45 5b74  GGML_TYPE_SIZE[t
+000872d0: 7970 655f 715d 2a67 676d 6c5f 6e65 6c65  ype_q]*ggml_nele
+000872e0: 6d65 6e74 7328 6e6f 6465 2d3e 7372 6331  ments(node->src1
+000872f0: 292f 4747 4d4c 5f42 4c43 4b5f 5349 5a45  )/GGML_BLCK_SIZE
+00087300: 5b74 7970 655f 715d 3b0a 2020 2020 2020  [type_q];.      
+00087310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087320: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00087330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087340: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+00087350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087360: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00087370: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+00087380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087390: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+000873a0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+000873b0: 5f73 697a 6520 3d20 4d41 5828 776f 726b  _size = MAX(work
+000873c0: 5f73 697a 652c 2063 7572 293b 0a20 2020  _size, cur);.   
+000873d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000873e0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+000873f0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00087400: 474d 4c5f 4f50 5f53 4341 4c45 3a0a 2020  GML_OP_SCALE:.  
+00087410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087420: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00087430: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00087440: 2d3e 6e5f 7461 736b 7320 3d20 313b 0a20  ->n_tasks = 1;. 
+00087450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087460: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00087470: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00087480: 2047 474d 4c5f 4f50 5f53 4554 3a0a 2020   GGML_OP_SET:.  
+00087490: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+000874a0: 7365 2047 474d 4c5f 4f50 5f43 4f4e 543a  se GGML_OP_CONT:
+000874b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000874c0: 2063 6173 6520 4747 4d4c 5f4f 505f 5245   case GGML_OP_RE
+000874d0: 5348 4150 453a 0a20 2020 2020 2020 2020  SHAPE:.         
+000874e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000874f0: 5f4f 505f 5649 4557 3a0a 2020 2020 2020  _OP_VIEW:.      
+00087500: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00087510: 474d 4c5f 4f50 5f50 4552 4d55 5445 3a0a  GML_OP_PERMUTE:.
+00087520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087530: 6361 7365 2047 474d 4c5f 4f50 5f54 5241  case GGML_OP_TRA
+00087540: 4e53 504f 5345 3a0a 2020 2020 2020 2020  NSPOSE:.        
+00087550: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00087560: 4c5f 4f50 5f47 4554 5f52 4f57 533a 0a20  L_OP_GET_ROWS:. 
+00087570: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00087580: 6173 6520 4747 4d4c 5f4f 505f 4745 545f  ase GGML_OP_GET_
+00087590: 524f 5753 5f42 4143 4b3a 0a20 2020 2020  ROWS_BACK:.     
+000875a0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+000875b0: 4747 4d4c 5f4f 505f 4449 4147 3a0a 2020  GGML_OP_DIAG:.  
+000875c0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+000875d0: 7365 2047 474d 4c5f 4f50 5f44 4941 475f  se GGML_OP_DIAG_
+000875e0: 4d41 534b 5f5a 4552 4f3a 0a20 2020 2020  MASK_ZERO:.     
+000875f0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00087600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00087610: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
+00087620: 5f74 6173 6b73 203d 2031 3b0a 2020 2020  _tasks = 1;.    
 00087630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087640: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
-00087650: 6173 6b73 203d 2031 3b20 2f2f 544f 444f  asks = 1; //TODO
-00087660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00087670: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00087680: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00087690: 7365 2047 474d 4c5f 4f50 5f43 4c41 4d50  se GGML_OP_CLAMP
-000876a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000876b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000876c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000876d0: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-000876e0: 313b 202f 2f54 4f44 4f0a 2020 2020 2020  1; //TODO.      
-000876f0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00087700: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-00087710: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00087720: 5f4f 505f 434f 4e56 5f31 445f 5331 5f50  _OP_CONV_1D_S1_P
-00087730: 483a 0a20 2020 2020 2020 2020 2020 2020  H:.             
-00087740: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00087750: 434f 4e56 5f31 445f 5332 5f50 483a 0a20  CONV_1D_S2_PH:. 
+00087640: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00087650: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00087660: 4d4c 5f4f 505f 4449 4147 5f4d 4153 4b5f  ML_OP_DIAG_MASK_
+00087670: 494e 463a 0a20 2020 2020 2020 2020 2020  INF:.           
+00087680: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00087690: 505f 534f 4654 5f4d 4158 3a0a 2020 2020  P_SOFT_MAX:.    
+000876a0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+000876b0: 2047 474d 4c5f 4f50 5f53 4f46 545f 4d41   GGML_OP_SOFT_MA
+000876c0: 585f 4241 434b 3a0a 2020 2020 2020 2020  X_BACK:.        
+000876d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000876e0: 4c5f 4f50 5f52 4f50 453a 0a20 2020 2020  L_OP_ROPE:.     
+000876f0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00087700: 4747 4d4c 5f4f 505f 524f 5045 5f42 4143  GGML_OP_ROPE_BAC
+00087710: 4b3a 0a20 2020 2020 2020 2020 2020 2020  K:.             
+00087720: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00087730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087740: 206e 6f64 652d 3e6e 5f74 6173 6b73 203d   node->n_tasks =
+00087750: 206e 5f74 6872 6561 6473 3b0a 2020 2020   n_threads;.    
 00087760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087770: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00087780: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00087790: 652d 3e6e 5f74 6173 6b73 203d 206e 5f74  e->n_tasks = n_t
-000877a0: 6872 6561 6473 3b0a 0a20 2020 2020 2020  hreads;..       
-000877b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000877c0: 2047 474d 4c5f 4153 5345 5254 286e 6f64   GGML_ASSERT(nod
-000877d0: 652d 3e73 7263 302d 3e6e 655b 335d 203d  e->src0->ne[3] =
-000877e0: 3d20 3129 3b0a 2020 2020 2020 2020 2020  = 1);.          
-000877f0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00087800: 4d4c 5f41 5353 4552 5428 6e6f 6465 2d3e  ML_ASSERT(node->
-00087810: 7372 6331 2d3e 6e65 5b32 5d20 3d3d 2031  src1->ne[2] == 1
-00087820: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00087830: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00087840: 4153 5345 5254 286e 6f64 652d 3e73 7263  ASSERT(node->src
-00087850: 312d 3e6e 655b 335d 203d 3d20 3129 3b0a  1->ne[3] == 1);.
-00087860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00087870: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
-00087880: 6375 7220 3d20 303b 0a20 2020 2020 2020  cur = 0;.       
-00087890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000878a0: 2063 6f6e 7374 2069 6e74 206e 6b20 3d20   const int nk = 
-000878b0: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b30  node->src0->ne[0
-000878c0: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
-000878d0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000878e0: 6e6f 6465 2d3e 7372 6330 2d3e 7479 7065  node->src0->type
-000878f0: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
-00087900: 3620 2626 0a20 2020 2020 2020 2020 2020  6 &&.           
-00087910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087920: 206e 6f64 652d 3e73 7263 312d 3e74 7970   node->src1->typ
-00087930: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-00087940: 3332 2920 7b0a 2020 2020 2020 2020 2020  32) {.          
-00087950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087960: 2020 6375 7220 3d20 7369 7a65 6f66 2867    cur = sizeof(g
-00087970: 676d 6c5f 6670 3136 5f74 292a 280a 2020  gml_fp16_t)*(.  
-00087980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000879a0: 2020 6e6b 2a67 676d 6c5f 7570 3332 286e    nk*ggml_up32(n
-000879b0: 6f64 652d 3e73 7263 302d 3e6e 655b 315d  ode->src0->ne[1]
-000879c0: 292a 6e6f 6465 2d3e 7372 6330 2d3e 6e65  )*node->src0->ne
-000879d0: 5b32 5d20 2b0a 2020 2020 2020 2020 2020  [2] +.          
-000879e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000879f0: 2020 2020 2020 2020 2020 2820 322a 286e            ( 2*(n
-00087a00: 6b2f 3229 202b 206e 6f64 652d 3e73 7263  k/2) + node->src
-00087a10: 312d 3e6e 655b 305d 292a 6e6f 6465 2d3e  1->ne[0])*node->
-00087a20: 7372 6331 2d3e 6e65 5b31 5d0a 2020 2020  src1->ne[1].    
-00087a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087a50: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00087a60: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-00087a70: 6520 6966 2028 6e6f 6465 2d3e 7372 6330  e if (node->src0
-00087a80: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00087a90: 5950 455f 4633 3220 2626 0a20 2020 2020  YPE_F32 &&.     
-00087aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087ab0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00087ac0: 6465 2d3e 7372 6331 2d3e 7479 7065 203d  de->src1->type =
-00087ad0: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
-00087ae0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00087af0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00087b00: 7572 203d 2073 697a 656f 6628 666c 6f61  ur = sizeof(floa
-00087b10: 7429 2a28 0a20 2020 2020 2020 2020 2020  t)*(.           
-00087b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087b30: 2020 2020 2020 2020 206e 6b2a 6767 6d6c           nk*ggml
-00087b40: 5f75 7033 3228 6e6f 6465 2d3e 7372 6330  _up32(node->src0
-00087b50: 2d3e 6e65 5b31 5d29 2a6e 6f64 652d 3e73  ->ne[1])*node->s
-00087b60: 7263 302d 3e6e 655b 325d 202b 0a20 2020  rc0->ne[2] +.   
-00087b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087b90: 2028 2032 2a28 6e6b 2f32 2920 2b20 6e6f   ( 2*(nk/2) + no
-00087ba0: 6465 2d3e 7372 6331 2d3e 6e65 5b30 5d29  de->src1->ne[0])
-00087bb0: 2a6e 6f64 652d 3e73 7263 312d 3e6e 655b  *node->src1->ne[
-00087bc0: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-00087bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087be0: 2020 2020 2020 2029 3b0a 2020 2020 2020         );.      
-00087bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087c00: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00087c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087c20: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00087c30: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-00087c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087c50: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00087c60: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00087c70: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
-00087c80: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
-00087c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087ca0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00087cb0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00087cc0: 2047 474d 4c5f 4f50 5f43 4f4e 565f 3244   GGML_OP_CONV_2D
-00087cd0: 5f53 4b5f 5030 3a0a 2020 2020 2020 2020  _SK_P0:.        
-00087ce0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00087cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087d00: 2020 2020 2020 6e6f 6465 2d3e 6e5f 7461        node->n_ta
-00087d10: 736b 7320 3d20 6e5f 7468 7265 6164 733b  sks = n_threads;
-00087d20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00087d30: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00087d40: 5353 4552 5428 6e6f 6465 2d3e 7372 6331  SSERT(node->src1
-00087d50: 2d3e 6e65 5b33 5d20 3d3d 2031 293b 0a0a  ->ne[3] == 1);..
-00087d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087d70: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00087d80: 7436 345f 7420 6e65 3030 203d 206e 6f64  t64_t ne00 = nod
-00087d90: 652d 3e73 7263 302d 3e6e 655b 305d 3b20  e->src0->ne[0]; 
-00087da0: 2f2f 2057 0a20 2020 2020 2020 2020 2020  // W.           
-00087db0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00087dc0: 7374 2069 6e74 3634 5f74 206e 6530 3120  st int64_t ne01 
-00087dd0: 3d20 6e6f 6465 2d3e 7372 6330 2d3e 6e65  = node->src0->ne
-00087de0: 5b31 5d3b 202f 2f20 480a 2020 2020 2020  [1]; // H.      
-00087df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087e00: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00087e10: 6e65 3032 203d 206e 6f64 652d 3e73 7263  ne02 = node->src
-00087e20: 302d 3e6e 655b 325d 3b20 2f2f 2043 0a20  0->ne[2]; // C. 
+00087770: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00087780: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00087790: 4d4c 5f4f 505f 414c 4942 493a 0a20 2020  ML_OP_ALIBI:.   
+000877a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000877b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000877c0: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+000877d0: 3e6e 5f74 6173 6b73 203d 2031 3b20 2f2f  >n_tasks = 1; //
+000877e0: 544f 444f 0a20 2020 2020 2020 2020 2020  TODO.           
+000877f0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00087800: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00087810: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+00087820: 4c41 4d50 3a0a 2020 2020 2020 2020 2020  LAMP:.          
+00087830: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00087840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087850: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
+00087860: 7320 3d20 313b 202f 2f54 4f44 4f0a 2020  s = 1; //TODO.  
+00087870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087880: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00087890: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+000878a0: 4747 4d4c 5f4f 505f 434f 4e56 5f31 445f  GGML_OP_CONV_1D_
+000878b0: 5331 5f50 483a 0a20 2020 2020 2020 2020  S1_PH:.         
+000878c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000878d0: 5f4f 505f 434f 4e56 5f31 445f 5332 5f50  _OP_CONV_1D_S2_P
+000878e0: 483a 0a20 2020 2020 2020 2020 2020 2020  H:.             
+000878f0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00087900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087910: 206e 6f64 652d 3e6e 5f74 6173 6b73 203d   node->n_tasks =
+00087920: 206e 5f74 6872 6561 6473 3b0a 0a20 2020   n_threads;..   
+00087930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087940: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00087950: 286e 6f64 652d 3e73 7263 302d 3e6e 655b  (node->src0->ne[
+00087960: 335d 203d 3d20 3129 3b0a 2020 2020 2020  3] == 1);.      
+00087970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087980: 2020 4747 4d4c 5f41 5353 4552 5428 6e6f    GGML_ASSERT(no
+00087990: 6465 2d3e 7372 6331 2d3e 6e65 5b32 5d20  de->src1->ne[2] 
+000879a0: 3d3d 2031 293b 0a20 2020 2020 2020 2020  == 1);.         
+000879b0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+000879c0: 474d 4c5f 4153 5345 5254 286e 6f64 652d  GML_ASSERT(node-
+000879d0: 3e73 7263 312d 3e6e 655b 335d 203d 3d20  >src1->ne[3] == 
+000879e0: 3129 3b0a 0a20 2020 2020 2020 2020 2020  1);..           
+000879f0: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+00087a00: 655f 7420 6375 7220 3d20 303b 0a20 2020  e_t cur = 0;.   
+00087a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087a20: 2020 2020 2063 6f6e 7374 2069 6e74 206e       const int n
+00087a30: 6b20 3d20 6e6f 6465 2d3e 7372 6330 2d3e  k = node->src0->
+00087a40: 6e65 5b30 5d3b 0a0a 2020 2020 2020 2020  ne[0];..        
+00087a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087a60: 6966 2028 6e6f 6465 2d3e 7372 6330 2d3e  if (node->src0->
+00087a70: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00087a80: 455f 4631 3620 2626 0a20 2020 2020 2020  E_F16 &&.       
+00087a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087aa0: 2020 2020 206e 6f64 652d 3e73 7263 312d       node->src1-
+00087ab0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00087ac0: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
+00087ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087ae0: 2020 2020 2020 6375 7220 3d20 7369 7a65        cur = size
+00087af0: 6f66 2867 676d 6c5f 6670 3136 5f74 292a  of(ggml_fp16_t)*
+00087b00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00087b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087b20: 2020 2020 2020 6e6b 2a67 676d 6c5f 7570        nk*ggml_up
+00087b30: 3332 286e 6f64 652d 3e73 7263 302d 3e6e  32(node->src0->n
+00087b40: 655b 315d 292a 6e6f 6465 2d3e 7372 6330  e[1])*node->src0
+00087b50: 2d3e 6e65 5b32 5d20 2b0a 2020 2020 2020  ->ne[2] +.      
+00087b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087b70: 2020 2020 2020 2020 2020 2020 2020 2820                ( 
+00087b80: 322a 286e 6b2f 3229 202b 206e 6f64 652d  2*(nk/2) + node-
+00087b90: 3e73 7263 312d 3e6e 655b 305d 292a 6e6f  >src1->ne[0])*no
+00087ba0: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d0a  de->src1->ne[1].
+00087bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087bd0: 2020 2020 293b 0a20 2020 2020 2020 2020      );.         
+00087be0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00087bf0: 2065 6c73 6520 6966 2028 6e6f 6465 2d3e   else if (node->
+00087c00: 7372 6330 2d3e 7479 7065 203d 3d20 4747  src0->type == GG
+00087c10: 4d4c 5f54 5950 455f 4633 3220 2626 0a20  ML_TYPE_F32 &&. 
+00087c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087c40: 2020 6e6f 6465 2d3e 7372 6331 2d3e 7479    node->src1->ty
+00087c50: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00087c60: 4633 3229 207b 0a20 2020 2020 2020 2020  F32) {.         
+00087c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087c80: 2020 2063 7572 203d 2073 697a 656f 6628     cur = sizeof(
+00087c90: 666c 6f61 7429 2a28 0a20 2020 2020 2020  float)*(.       
+00087ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087cb0: 2020 2020 2020 2020 2020 2020 206e 6b2a               nk*
+00087cc0: 6767 6d6c 5f75 7033 3228 6e6f 6465 2d3e  ggml_up32(node->
+00087cd0: 7372 6330 2d3e 6e65 5b31 5d29 2a6e 6f64  src0->ne[1])*nod
+00087ce0: 652d 3e73 7263 302d 3e6e 655b 325d 202b  e->src0->ne[2] +
+00087cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00087d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087d10: 2020 2020 2028 2032 2a28 6e6b 2f32 2920       ( 2*(nk/2) 
+00087d20: 2b20 6e6f 6465 2d3e 7372 6331 2d3e 6e65  + node->src1->ne
+00087d30: 5b30 5d29 2a6e 6f64 652d 3e73 7263 312d  [0])*node->src1-
+00087d40: 3e6e 655b 315d 0a20 2020 2020 2020 2020  >ne[1].         
+00087d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087d60: 2020 2020 2020 2020 2020 2029 3b0a 2020             );.  
+00087d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087d80: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
+00087d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087da0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00087db0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+00087dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087dd0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00087de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087df0: 2020 776f 726b 5f73 697a 6520 3d20 4d41    work_size = MA
+00087e00: 5828 776f 726b 5f73 697a 652c 2063 7572  X(work_size, cur
+00087e10: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00087e20: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
 00087e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087e40: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00087e50: 3634 5f74 206e 6530 3320 3d20 6e6f 6465  64_t ne03 = node
-00087e60: 2d3e 7372 6330 2d3e 6e65 5b33 5d3b 202f  ->src0->ne[3]; /
-00087e70: 2f20 4e0a 0a20 2020 2020 2020 2020 2020  / N..           
-00087e80: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00087e90: 7374 2069 6e74 3634 5f74 206e 6531 3020  st int64_t ne10 
-00087ea0: 3d20 6e6f 6465 2d3e 7372 6331 2d3e 6e65  = node->src1->ne
-00087eb0: 5b30 5d3b 202f 2f20 570a 2020 2020 2020  [0]; // W.      
-00087ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087ed0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00087ee0: 6e65 3131 203d 206e 6f64 652d 3e73 7263  ne11 = node->src
-00087ef0: 312d 3e6e 655b 315d 3b20 2f2f 2048 0a20  1->ne[1]; // H. 
-00087f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087f10: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00087f20: 3634 5f74 206e 6531 3220 3d20 6e6f 6465  64_t ne12 = node
-00087f30: 2d3e 7372 6331 2d3e 6e65 5b32 5d3b 202f  ->src1->ne[2]; /
-00087f40: 2f20 430a 0a20 2020 2020 2020 2020 2020  / C..           
-00087f50: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00087f60: 7374 2069 6e74 3634 5f74 206e 6b20 3d20  st int64_t nk = 
-00087f70: 6e65 3030 2a6e 6530 313b 0a0a 2020 2020  ne00*ne01;..    
-00087f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087f90: 2020 2020 554e 5553 4544 286e 6530 3229      UNUSED(ne02)
-00087fa0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00087fb0: 2020 2020 2020 2020 2020 554e 5553 4544            UNUSED
-00087fc0: 286e 6530 3329 3b0a 2020 2020 2020 2020  (ne03);.        
-00087fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087fe0: 554e 5553 4544 286e 6b29 3b0a 0a20 2020  UNUSED(nk);..   
-00087ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088000: 2020 2020 2073 697a 655f 7420 6375 7220       size_t cur 
-00088010: 3d20 303b 0a0a 2020 2020 2020 2020 2020  = 0;..          
-00088020: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00088030: 2028 6e6f 6465 2d3e 7372 6330 2d3e 7479   (node->src0->ty
-00088040: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-00088050: 4631 3620 2626 0a20 2020 2020 2020 2020  F16 &&.         
-00088060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088070: 2020 206e 6f64 652d 3e73 7263 312d 3e74     node->src1->t
-00088080: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00088090: 5f46 3332 2920 7b0a 2020 2020 2020 2020  _F32) {.        
-000880a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000880b0: 2020 2020 6375 7220 3d20 7369 7a65 6f66      cur = sizeof
-000880c0: 2867 676d 6c5f 6670 3136 5f74 292a 286e  (ggml_fp16_t)*(n
-000880d0: 6531 302a 6e65 3131 2a6e 6531 3229 3b0a  e10*ne11*ne12);.
-000880e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000880f0: 2020 2020 2020 2020 7d20 656c 7365 2069          } else i
-00088100: 6620 286e 6f64 652d 3e73 7263 302d 3e74  f (node->src0->t
-00088110: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00088120: 5f46 3332 2026 260a 2020 2020 2020 2020  _F32 &&.        
-00088130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088140: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-00088150: 3e73 7263 312d 3e74 7970 6520 3d3d 2047  >src1->type == G
-00088160: 474d 4c5f 5459 5045 5f46 3332 2920 7b0a  GML_TYPE_F32) {.
-00088170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088180: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-00088190: 3d20 7369 7a65 6f66 2866 6c6f 6174 292a  = sizeof(float)*
-000881a0: 2020 2020 2020 286e 6531 302a 6e65 3131        (ne10*ne11
-000881b0: 2a6e 6531 3229 3b0a 2020 2020 2020 2020  *ne12);.        
-000881c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000881d0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+00087e40: 6361 7365 2047 474d 4c5f 4f50 5f43 4f4e  case GGML_OP_CON
+00087e50: 565f 3244 5f53 4b5f 5030 3a0a 2020 2020  V_2D_SK_P0:.    
+00087e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087e70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00087e80: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
+00087e90: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
+00087ea0: 6164 733b 0a0a 2020 2020 2020 2020 2020  ads;..          
+00087eb0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00087ec0: 4d4c 5f41 5353 4552 5428 6e6f 6465 2d3e  ML_ASSERT(node->
+00087ed0: 7372 6331 2d3e 6e65 5b33 5d20 3d3d 2031  src1->ne[3] == 1
+00087ee0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00087ef0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00087f00: 7420 696e 7436 345f 7420 6e65 3030 203d  t int64_t ne00 =
+00087f10: 206e 6f64 652d 3e73 7263 302d 3e6e 655b   node->src0->ne[
+00087f20: 305d 3b20 2f2f 2057 0a20 2020 2020 2020  0]; // W.       
+00087f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087f40: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00087f50: 6530 3120 3d20 6e6f 6465 2d3e 7372 6330  e01 = node->src0
+00087f60: 2d3e 6e65 5b31 5d3b 202f 2f20 480a 2020  ->ne[1]; // H.  
+00087f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087f80: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00087f90: 345f 7420 6e65 3032 203d 206e 6f64 652d  4_t ne02 = node-
+00087fa0: 3e73 7263 302d 3e6e 655b 325d 3b20 2f2f  >src0->ne[2]; //
+00087fb0: 2043 0a20 2020 2020 2020 2020 2020 2020   C.             
+00087fc0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00087fd0: 2069 6e74 3634 5f74 206e 6530 3320 3d20   int64_t ne03 = 
+00087fe0: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b33  node->src0->ne[3
+00087ff0: 5d3b 202f 2f20 4e0a 0a20 2020 2020 2020  ]; // N..       
+00088000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088010: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00088020: 6531 3020 3d20 6e6f 6465 2d3e 7372 6331  e10 = node->src1
+00088030: 2d3e 6e65 5b30 5d3b 202f 2f20 570a 2020  ->ne[0]; // W.  
+00088040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088050: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00088060: 345f 7420 6e65 3131 203d 206e 6f64 652d  4_t ne11 = node-
+00088070: 3e73 7263 312d 3e6e 655b 315d 3b20 2f2f  >src1->ne[1]; //
+00088080: 2048 0a20 2020 2020 2020 2020 2020 2020   H.             
+00088090: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+000880a0: 2069 6e74 3634 5f74 206e 6531 3220 3d20   int64_t ne12 = 
+000880b0: 6e6f 6465 2d3e 7372 6331 2d3e 6e65 5b32  node->src1->ne[2
+000880c0: 5d3b 202f 2f20 430a 0a20 2020 2020 2020  ]; // C..       
+000880d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000880e0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+000880f0: 6b20 3d20 6e65 3030 2a6e 6530 313b 0a0a  k = ne00*ne01;..
+00088100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088110: 2020 2020 2020 2020 554e 5553 4544 286e          UNUSED(n
+00088120: 6530 3229 3b0a 2020 2020 2020 2020 2020  e02);.          
+00088130: 2020 2020 2020 2020 2020 2020 2020 554e                UN
+00088140: 5553 4544 286e 6530 3329 3b0a 2020 2020  USED(ne03);.    
+00088150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088160: 2020 2020 554e 5553 4544 286e 6b29 3b0a      UNUSED(nk);.
+00088170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00088180: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+00088190: 6375 7220 3d20 303b 0a0a 2020 2020 2020  cur = 0;..      
+000881a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000881b0: 2020 6966 2028 6e6f 6465 2d3e 7372 6330    if (node->src0
+000881c0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+000881d0: 5950 455f 4631 3620 2626 0a20 2020 2020  YPE_F16 &&.     
 000881e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000881f0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00088200: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00088210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088220: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-00088230: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00088240: 5f73 697a 6520 3d20 4d41 5828 776f 726b  _size = MAX(work
-00088250: 5f73 697a 652c 2063 7572 293b 0a20 2020  _size, cur);.   
-00088260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088270: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00088280: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00088290: 474d 4c5f 4f50 5f46 4c41 5348 5f41 5454  GML_OP_FLASH_ATT
-000882a0: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
-000882b0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000882c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000882d0: 206e 6f64 652d 3e6e 5f74 6173 6b73 203d   node->n_tasks =
-000882e0: 206e 5f74 6872 6561 6473 3b0a 0a20 2020   n_threads;..   
-000882f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088300: 2020 2020 2073 697a 655f 7420 6375 7220       size_t cur 
-00088310: 3d20 303b 0a0a 2020 2020 2020 2020 2020  = 0;..          
-00088320: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00088330: 6e73 7420 696e 7436 345f 7420 6e65 3131  nst int64_t ne11
-00088340: 203d 2067 676d 6c5f 7570 286e 6f64 652d   = ggml_up(node-
-00088350: 3e73 7263 312d 3e6e 655b 315d 2c20 4747  >src1->ne[1], GG
-00088360: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
-00088370: 4c4c 293b 0a0a 2020 2020 2020 2020 2020  LL);..          
-00088380: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00088390: 2028 6e6f 6465 2d3e 7372 6331 2d3e 7479   (node->src1->ty
-000883a0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-000883b0: 4633 3229 207b 0a20 2020 2020 2020 2020  F32) {.         
-000883c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000883d0: 2020 2063 7572 2020 3d20 7369 7a65 6f66     cur  = sizeof
-000883e0: 2866 6c6f 6174 292a 6e65 3131 2a6e 6f64  (float)*ne11*nod
-000883f0: 652d 3e6e 5f74 6173 6b73 3b20 2f2f 2054  e->n_tasks; // T
-00088400: 4f44 4f3a 2074 6869 7320 6361 6e20 6265  ODO: this can be
-00088410: 636f 6d65 2028 6e5f 7461 736b 732d 3129  come (n_tasks-1)
-00088420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00088430: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00088440: 202b 3d20 7369 7a65 6f66 2866 6c6f 6174   += sizeof(float
-00088450: 292a 6e65 3131 2a6e 6f64 652d 3e6e 5f74  )*ne11*node->n_t
-00088460: 6173 6b73 3b20 2f2f 2074 6869 7320 6973  asks; // this is
-00088470: 206f 7665 7265 7374 696d 6174 6564 2062   overestimated b
-00088480: 7920 7832 0a20 2020 2020 2020 2020 2020  y x2.           
-00088490: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
+000881f0: 2020 2020 2020 206e 6f64 652d 3e73 7263         node->src
+00088200: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
+00088210: 5459 5045 5f46 3332 2920 7b0a 2020 2020  TYPE_F32) {.    
+00088220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088230: 2020 2020 2020 2020 6375 7220 3d20 7369          cur = si
+00088240: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
+00088250: 292a 286e 6531 302a 6e65 3131 2a6e 6531  )*(ne10*ne11*ne1
+00088260: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
+00088270: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00088280: 7365 2069 6620 286e 6f64 652d 3e73 7263  se if (node->src
+00088290: 302d 3e74 7970 6520 3d3d 2047 474d 4c5f  0->type == GGML_
+000882a0: 5459 5045 5f46 3332 2026 260a 2020 2020  TYPE_F32 &&.    
+000882b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000882c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000882d0: 6f64 652d 3e73 7263 312d 3e74 7970 6520  ode->src1->type 
+000882e0: 3d3d 2047 474d 4c5f 5459 5045 5f46 3332  == GGML_TYPE_F32
+000882f0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00088300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088310: 6375 7220 3d20 7369 7a65 6f66 2866 6c6f  cur = sizeof(flo
+00088320: 6174 292a 2020 2020 2020 286e 6531 302a  at)*      (ne10*
+00088330: 6e65 3131 2a6e 6531 3229 3b0a 2020 2020  ne11*ne12);.    
+00088340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088350: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+00088360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088370: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00088380: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+00088390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000883a0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000883b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000883c0: 776f 726b 5f73 697a 6520 3d20 4d41 5828  work_size = MAX(
+000883d0: 776f 726b 5f73 697a 652c 2063 7572 293b  work_size, cur);
+000883e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000883f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00088400: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00088410: 7365 2047 474d 4c5f 4f50 5f46 4c41 5348  se GGML_OP_FLASH
+00088420: 5f41 5454 4e3a 0a20 2020 2020 2020 2020  _ATTN:.         
+00088430: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00088440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088450: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
+00088460: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
+00088470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00088480: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+00088490: 6375 7220 3d20 303b 0a0a 2020 2020 2020  cur = 0;..      
 000884a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000884b0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-000884c0: 2d3e 7372 6331 2d3e 7479 7065 203d 3d20  ->src1->type == 
-000884d0: 4747 4d4c 5f54 5950 455f 4631 3629 207b  GGML_TYPE_F16) {
-000884e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000884f0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00088500: 2020 3d20 7369 7a65 6f66 2866 6c6f 6174    = sizeof(float
-00088510: 292a 6e65 3131 2a6e 6f64 652d 3e6e 5f74  )*ne11*node->n_t
-00088520: 6173 6b73 3b20 2f2f 2054 4f44 4f3a 2074  asks; // TODO: t
-00088530: 6869 7320 6361 6e20 6265 636f 6d65 2028  his can become (
-00088540: 6e5f 7461 736b 732d 3129 0a20 2020 2020  n_tasks-1).     
-00088550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088560: 2020 2020 2020 2063 7572 202b 3d20 7369         cur += si
-00088570: 7a65 6f66 2866 6c6f 6174 292a 6e65 3131  zeof(float)*ne11
-00088580: 2a6e 6f64 652d 3e6e 5f74 6173 6b73 3b20  *node->n_tasks; 
-00088590: 2f2f 2074 6869 7320 6973 206f 7665 7265  // this is overe
-000885a0: 7374 696d 6174 6564 2062 7920 7832 0a20  stimated by x2. 
+000884b0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+000884c0: 6e65 3131 203d 2067 676d 6c5f 7570 286e  ne11 = ggml_up(n
+000884d0: 6f64 652d 3e73 7263 312d 3e6e 655b 315d  ode->src1->ne[1]
+000884e0: 2c20 4747 4d4c 5f53 4f46 545f 4d41 585f  , GGML_SOFT_MAX_
+000884f0: 554e 524f 4c4c 293b 0a0a 2020 2020 2020  UNROLL);..      
+00088500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088510: 2020 6966 2028 6e6f 6465 2d3e 7372 6331    if (node->src1
+00088520: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00088530: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
+00088540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088550: 2020 2020 2020 2063 7572 2020 3d20 7369         cur  = si
+00088560: 7a65 6f66 2866 6c6f 6174 292a 6e65 3131  zeof(float)*ne11
+00088570: 2a6e 6f64 652d 3e6e 5f74 6173 6b73 3b20  *node->n_tasks; 
+00088580: 2f2f 2054 4f44 4f3a 2074 6869 7320 6361  // TODO: this ca
+00088590: 6e20 6265 636f 6d65 2028 6e5f 7461 736b  n become (n_task
+000885a0: 732d 3129 0a20 2020 2020 2020 2020 2020  s-1).           
 000885b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000885c0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-000885d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000885e0: 2020 776f 726b 5f73 697a 6520 3d20 4d41    work_size = MA
-000885f0: 5828 776f 726b 5f73 697a 652c 2063 7572  X(work_size, cur
-00088600: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00088610: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00088620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088630: 6361 7365 2047 474d 4c5f 4f50 5f46 4c41  case GGML_OP_FLA
-00088640: 5348 5f46 463a 0a20 2020 2020 2020 2020  SH_FF:.         
-00088650: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00088660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088670: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
-00088680: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
-00088690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000886a0: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
-000886b0: 6375 7220 3d20 303b 0a0a 2020 2020 2020  cur = 0;..      
-000886c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000886d0: 2020 6966 2028 6e6f 6465 2d3e 7372 6331    if (node->src1
-000886e0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-000886f0: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
-00088700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088710: 2020 2020 2020 2063 7572 2020 3d20 7369         cur  = si
-00088720: 7a65 6f66 2866 6c6f 6174 292a 6e6f 6465  zeof(float)*node
-00088730: 2d3e 7372 6331 2d3e 6e65 5b31 5d2a 6e6f  ->src1->ne[1]*no
-00088740: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
-00088750: 544f 444f 3a20 7468 6973 2063 616e 2062  TODO: this can b
-00088760: 6563 6f6d 6520 286e 5f74 6173 6b73 2d31  ecome (n_tasks-1
-00088770: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00088780: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00088790: 7220 2b3d 2073 697a 656f 6628 666c 6f61  r += sizeof(floa
-000887a0: 7429 2a6e 6f64 652d 3e73 7263 312d 3e6e  t)*node->src1->n
-000887b0: 655b 315d 2a6e 6f64 652d 3e6e 5f74 6173  e[1]*node->n_tas
-000887c0: 6b73 3b20 2f2f 2074 6869 7320 6973 206f  ks; // this is o
-000887d0: 7665 7265 7374 696d 6174 6564 2062 7920  verestimated by 
-000887e0: 7832 0a20 2020 2020 2020 2020 2020 2020  x2.             
-000887f0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00088800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088810: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
-00088820: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-00088830: 4d4c 5f54 5950 455f 4631 3629 207b 0a20  ML_TYPE_F16) {. 
+000885c0: 2063 7572 202b 3d20 7369 7a65 6f66 2866   cur += sizeof(f
+000885d0: 6c6f 6174 292a 6e65 3131 2a6e 6f64 652d  loat)*ne11*node-
+000885e0: 3e6e 5f74 6173 6b73 3b20 2f2f 2074 6869  >n_tasks; // thi
+000885f0: 7320 6973 206f 7665 7265 7374 696d 6174  s is overestimat
+00088600: 6564 2062 7920 7832 0a20 2020 2020 2020  ed by x2.       
+00088610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088620: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00088630: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00088640: 6e6f 6465 2d3e 7372 6331 2d3e 7479 7065  node->src1->type
+00088650: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
+00088660: 3629 207b 0a20 2020 2020 2020 2020 2020  6) {.           
+00088670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088680: 2063 7572 2020 3d20 7369 7a65 6f66 2866   cur  = sizeof(f
+00088690: 6c6f 6174 292a 6e65 3131 2a6e 6f64 652d  loat)*ne11*node-
+000886a0: 3e6e 5f74 6173 6b73 3b20 2f2f 2054 4f44  >n_tasks; // TOD
+000886b0: 4f3a 2074 6869 7320 6361 6e20 6265 636f  O: this can beco
+000886c0: 6d65 2028 6e5f 7461 736b 732d 3129 0a20  me (n_tasks-1). 
+000886d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000886e0: 2020 2020 2020 2020 2020 2063 7572 202b             cur +
+000886f0: 3d20 7369 7a65 6f66 2866 6c6f 6174 292a  = sizeof(float)*
+00088700: 6e65 3131 2a6e 6f64 652d 3e6e 5f74 6173  ne11*node->n_tas
+00088710: 6b73 3b20 2f2f 2074 6869 7320 6973 206f  ks; // this is o
+00088720: 7665 7265 7374 696d 6174 6564 2062 7920  verestimated by 
+00088730: 7832 0a20 2020 2020 2020 2020 2020 2020  x2.             
+00088740: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+00088750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088760: 2020 2020 2020 776f 726b 5f73 697a 6520        work_size 
+00088770: 3d20 4d41 5828 776f 726b 5f73 697a 652c  = MAX(work_size,
+00088780: 2063 7572 293b 0a20 2020 2020 2020 2020   cur);.         
+00088790: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000887a0: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
+000887b0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+000887c0: 5f46 4c41 5348 5f46 463a 0a20 2020 2020  _FLASH_FF:.     
+000887d0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+000887e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000887f0: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
+00088800: 5f74 6173 6b73 203d 206e 5f74 6872 6561  _tasks = n_threa
+00088810: 6473 3b0a 0a20 2020 2020 2020 2020 2020  ds;..           
+00088820: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+00088830: 655f 7420 6375 7220 3d20 303b 0a0a 2020  e_t cur = 0;..  
 00088840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088850: 2020 2020 2020 2020 2020 2063 7572 2020             cur  
-00088860: 3d20 7369 7a65 6f66 2866 6c6f 6174 292a  = sizeof(float)*
-00088870: 6e6f 6465 2d3e 7372 6331 2d3e 6e65 5b31  node->src1->ne[1
-00088880: 5d2a 6e6f 6465 2d3e 6e5f 7461 736b 733b  ]*node->n_tasks;
-00088890: 202f 2f20 544f 444f 3a20 7468 6973 2063   // TODO: this c
-000888a0: 616e 2062 6563 6f6d 6520 286e 5f74 6173  an become (n_tas
-000888b0: 6b73 2d31 290a 2020 2020 2020 2020 2020  ks-1).          
-000888c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000888d0: 2020 6375 7220 2b3d 2073 697a 656f 6628    cur += sizeof(
-000888e0: 666c 6f61 7429 2a6e 6f64 652d 3e73 7263  float)*node->src
-000888f0: 312d 3e6e 655b 315d 2a6e 6f64 652d 3e6e  1->ne[1]*node->n
-00088900: 5f74 6173 6b73 3b20 2f2f 2074 6869 7320  _tasks; // this 
-00088910: 6973 206f 7665 7265 7374 696d 6174 6564  is overestimated
-00088920: 2062 7920 7832 0a20 2020 2020 2020 2020   by x2.         
-00088930: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00088940: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00088950: 2020 2020 2020 2020 2020 776f 726b 5f73            work_s
-00088960: 697a 6520 3d20 4d41 5828 776f 726b 5f73  ize = MAX(work_s
-00088970: 697a 652c 2063 7572 293b 0a20 2020 2020  ize, cur);.     
-00088980: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00088990: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000889a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000889b0: 4c5f 4f50 5f46 4c41 5348 5f41 5454 4e5f  L_OP_FLASH_ATTN_
-000889c0: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
-000889d0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000889e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000889f0: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
-00088a00: 7320 3d20 6e5f 7468 7265 6164 733b 0a0a  s = n_threads;..
-00088a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088a20: 2020 2020 2020 2020 7369 7a65 5f74 2063          size_t c
-00088a30: 7572 203d 2030 3b0a 0a20 2020 2020 2020  ur = 0;..       
+00088850: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
+00088860: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
+00088870: 4d4c 5f54 5950 455f 4633 3229 207b 0a20  ML_TYPE_F32) {. 
+00088880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088890: 2020 2020 2020 2020 2020 2063 7572 2020             cur  
+000888a0: 3d20 7369 7a65 6f66 2866 6c6f 6174 292a  = sizeof(float)*
+000888b0: 6e6f 6465 2d3e 7372 6331 2d3e 6e65 5b31  node->src1->ne[1
+000888c0: 5d2a 6e6f 6465 2d3e 6e5f 7461 736b 733b  ]*node->n_tasks;
+000888d0: 202f 2f20 544f 444f 3a20 7468 6973 2063   // TODO: this c
+000888e0: 616e 2062 6563 6f6d 6520 286e 5f74 6173  an become (n_tas
+000888f0: 6b73 2d31 290a 2020 2020 2020 2020 2020  ks-1).          
+00088900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088910: 2020 6375 7220 2b3d 2073 697a 656f 6628    cur += sizeof(
+00088920: 666c 6f61 7429 2a6e 6f64 652d 3e73 7263  float)*node->src
+00088930: 312d 3e6e 655b 315d 2a6e 6f64 652d 3e6e  1->ne[1]*node->n
+00088940: 5f74 6173 6b73 3b20 2f2f 2074 6869 7320  _tasks; // this 
+00088950: 6973 206f 7665 7265 7374 696d 6174 6564  is overestimated
+00088960: 2062 7920 7832 0a20 2020 2020 2020 2020   by x2.         
+00088970: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00088980: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00088990: 2020 2020 2020 2020 2020 6966 2028 6e6f            if (no
+000889a0: 6465 2d3e 7372 6331 2d3e 7479 7065 203d  de->src1->type =
+000889b0: 3d20 4747 4d4c 5f54 5950 455f 4631 3629  = GGML_TYPE_F16)
+000889c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000889d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000889e0: 7572 2020 3d20 7369 7a65 6f66 2866 6c6f  ur  = sizeof(flo
+000889f0: 6174 292a 6e6f 6465 2d3e 7372 6331 2d3e  at)*node->src1->
+00088a00: 6e65 5b31 5d2a 6e6f 6465 2d3e 6e5f 7461  ne[1]*node->n_ta
+00088a10: 736b 733b 202f 2f20 544f 444f 3a20 7468  sks; // TODO: th
+00088a20: 6973 2063 616e 2062 6563 6f6d 6520 286e  is can become (n
+00088a30: 5f74 6173 6b73 2d31 290a 2020 2020 2020  _tasks-1).      
 00088a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088a50: 2063 6f6e 7374 2069 6e74 3634 5f74 2020   const int64_t  
-00088a60: 2020 4420 3d20 6e6f 6465 2d3e 7372 6330    D = node->src0
-00088a70: 2d3e 6e65 5b30 5d3b 0a20 2020 2020 2020  ->ne[0];.       
-00088a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088a90: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00088aa0: 6531 3120 3d20 6767 6d6c 5f75 7028 6e6f  e11 = ggml_up(no
-00088ab0: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d2c  de->src1->ne[1],
-00088ac0: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
-00088ad0: 4e52 4f4c 4c29 3b0a 2020 2020 2020 2020  NROLL);.        
-00088ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088af0: 636f 6e73 7420 696e 7436 345f 7420 6d78  const int64_t mx
-00088b00: 446e 203d 204d 4158 2844 2c20 6e65 3131  Dn = MAX(D, ne11
-00088b10: 2920 2a20 323b 202f 2f20 2a32 2062 6563  ) * 2; // *2 bec
-00088b20: 6175 7365 206f 6620 5320 616e 6420 534d  ause of S and SM
-00088b30: 2069 6e20 6767 6d6c 5f63 6f6d 7075 7465   in ggml_compute
-00088b40: 5f66 6f72 7761 7264 5f66 6c61 7368 5f61  _forward_flash_a
-00088b50: 7474 6e5f 6261 636b 0a20 2020 2020 2020  ttn_back.       
+00088a50: 2020 2020 2020 6375 7220 2b3d 2073 697a        cur += siz
+00088a60: 656f 6628 666c 6f61 7429 2a6e 6f64 652d  eof(float)*node-
+00088a70: 3e73 7263 312d 3e6e 655b 315d 2a6e 6f64  >src1->ne[1]*nod
+00088a80: 652d 3e6e 5f74 6173 6b73 3b20 2f2f 2074  e->n_tasks; // t
+00088a90: 6869 7320 6973 206f 7665 7265 7374 696d  his is overestim
+00088aa0: 6174 6564 2062 7920 7832 0a20 2020 2020  ated by x2.     
+00088ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088ac0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+00088ad0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+00088ae0: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
+00088af0: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
+00088b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088b10: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00088b20: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00088b30: 2047 474d 4c5f 4f50 5f46 4c41 5348 5f41   GGML_OP_FLASH_A
+00088b40: 5454 4e5f 4241 434b 3a0a 2020 2020 2020  TTN_BACK:.      
+00088b50: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 00088b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088b70: 2069 6620 286e 6f64 652d 3e73 7263 312d   if (node->src1-
-00088b80: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00088b90: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
-00088ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088bb0: 2020 2020 2020 6375 7220 203d 2073 697a        cur  = siz
-00088bc0: 656f 6628 666c 6f61 7429 2a6d 7844 6e2a  eof(float)*mxDn*
-00088bd0: 6e6f 6465 2d3e 6e5f 7461 736b 733b 202f  node->n_tasks; /
-00088be0: 2f20 544f 444f 3a20 7468 6973 2063 616e  / TODO: this can
-00088bf0: 2062 6563 6f6d 6520 286e 5f74 6173 6b73   become (n_tasks
-00088c00: 2d31 290a 2020 2020 2020 2020 2020 2020  -1).            
-00088c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088c20: 6375 7220 2b3d 2073 697a 656f 6628 666c  cur += sizeof(fl
-00088c30: 6f61 7429 2a6d 7844 6e2a 6e6f 6465 2d3e  oat)*mxDn*node->
-00088c40: 6e5f 7461 736b 733b 202f 2f20 7468 6973  n_tasks; // this
-00088c50: 2069 7320 6f76 6572 6573 7469 6d61 7465   is overestimate
-00088c60: 6420 6279 2078 320a 2020 2020 2020 2020  d by x2.        
-00088c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088c80: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
-00088c90: 2020 2020 2020 2020 2020 2069 6620 286e             if (n
-00088ca0: 6f64 652d 3e73 7263 312d 3e74 7970 6520  ode->src1->type 
-00088cb0: 3d3d 2047 474d 4c5f 5459 5045 5f46 3136  == GGML_TYPE_F16
-00088cc0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00088cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088ce0: 6375 7220 203d 2073 697a 656f 6628 666c  cur  = sizeof(fl
-00088cf0: 6f61 7429 2a6d 7844 6e2a 6e6f 6465 2d3e  oat)*mxDn*node->
-00088d00: 6e5f 7461 736b 733b 202f 2f20 544f 444f  n_tasks; // TODO
-00088d10: 3a20 7468 6973 2063 616e 2062 6563 6f6d  : this can becom
-00088d20: 6520 286e 5f74 6173 6b73 2d31 290a 2020  e (n_tasks-1).  
-00088d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088d40: 2020 2020 2020 2020 2020 6375 7220 2b3d            cur +=
-00088d50: 2073 697a 656f 6628 666c 6f61 7429 2a6d   sizeof(float)*m
-00088d60: 7844 6e2a 6e6f 6465 2d3e 6e5f 7461 736b  xDn*node->n_task
-00088d70: 733b 202f 2f20 7468 6973 2069 7320 6f76  s; // this is ov
-00088d80: 6572 6573 7469 6d61 7465 6420 6279 2078  erestimated by x
-00088d90: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-00088da0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00088db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088dc0: 2020 2020 2077 6f72 6b5f 7369 7a65 203d       work_size =
-00088dd0: 204d 4158 2877 6f72 6b5f 7369 7a65 2c20   MAX(work_size, 
-00088de0: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
-00088df0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00088e00: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00088e10: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00088e20: 5749 4e5f 5041 5254 3a0a 2020 2020 2020  WIN_PART:.      
-00088e30: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00088e40: 474d 4c5f 4f50 5f57 494e 5f55 4e50 4152  GML_OP_WIN_UNPAR
-00088e50: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
-00088e60: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00088e70: 4d41 505f 554e 4152 593a 0a20 2020 2020  MAP_UNARY:.     
-00088e80: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00088e90: 4747 4d4c 5f4f 505f 4d41 505f 4249 4e41  GGML_OP_MAP_BINA
-00088ea0: 5259 3a0a 2020 2020 2020 2020 2020 2020  RY:.            
-00088eb0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00088ec0: 5f4d 4150 5f43 5553 544f 4d31 3a0a 2020  _MAP_CUSTOM1:.  
-00088ed0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00088ee0: 7365 2047 474d 4c5f 4f50 5f4d 4150 5f43  se GGML_OP_MAP_C
-00088ef0: 5553 544f 4d32 3a0a 2020 2020 2020 2020  USTOM2:.        
-00088f00: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00088f10: 4c5f 4f50 5f4d 4150 5f43 5553 544f 4d33  L_OP_MAP_CUSTOM3
-00088f20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00088f30: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00088f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088f50: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-00088f60: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
-00088f70: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00088f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088f90: 6361 7365 2047 474d 4c5f 4f50 5f43 524f  case GGML_OP_CRO
-00088fa0: 5353 5f45 4e54 524f 5059 5f4c 4f53 533a  SS_ENTROPY_LOSS:
-00088fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00088fc0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00088fd0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00088fe0: 6f64 652d 3e6e 5f74 6173 6b73 203d 206e  ode->n_tasks = n
-00088ff0: 5f74 6872 6561 6473 3b0a 0a20 2020 2020  _threads;..     
-00089000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089010: 2020 2073 697a 655f 7420 6375 7220 3d20     size_t cur = 
-00089020: 6767 6d6c 5f74 7970 655f 7369 7a65 286e  ggml_type_size(n
-00089030: 6f64 652d 3e74 7970 6529 2a28 6e6f 6465  ode->type)*(node
-00089040: 2d3e 6e5f 7461 736b 7320 2b20 6e6f 6465  ->n_tasks + node
-00089050: 2d3e 7372 6330 2d3e 6e65 5b30 5d2a 6e6f  ->src0->ne[0]*no
-00089060: 6465 2d3e 6e5f 7461 736b 7329 3b0a 0a20  de->n_tasks);.. 
-00089070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089080: 2020 2020 2020 2077 6f72 6b5f 7369 7a65         work_size
-00089090: 203d 204d 4158 2877 6f72 6b5f 7369 7a65   = MAX(work_size
-000890a0: 2c20 6375 7229 3b0a 2020 2020 2020 2020  , cur);.        
-000890b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000890c0: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
-000890d0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000890e0: 505f 4352 4f53 535f 454e 5452 4f50 595f  P_CROSS_ENTROPY_
-000890f0: 4c4f 5353 5f42 4143 4b3a 0a20 2020 2020  LOSS_BACK:.     
-00089100: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00089110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00089120: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
-00089130: 5f74 6173 6b73 203d 206e 5f74 6872 6561  _tasks = n_threa
-00089140: 6473 3b0a 0a20 2020 2020 2020 2020 2020  ds;..           
-00089150: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-00089160: 655f 7420 6375 7220 3d20 6767 6d6c 5f74  e_t cur = ggml_t
-00089170: 7970 655f 7369 7a65 286e 6f64 652d 3e74  ype_size(node->t
-00089180: 7970 6529 2a6e 6f64 652d 3e73 7263 302d  ype)*node->src0-
-00089190: 3e6e 655b 305d 2a6e 6f64 652d 3e6e 5f74  >ne[0]*node->n_t
-000891a0: 6173 6b73 3b0a 0a20 2020 2020 2020 2020  asks;..         
-000891b0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000891c0: 6f72 6b5f 7369 7a65 203d 204d 4158 2877  ork_size = MAX(w
-000891d0: 6f72 6b5f 7369 7a65 2c20 6375 7229 3b0a  ork_size, cur);.
-000891e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000891f0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00089200: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00089210: 6520 4747 4d4c 5f4f 505f 4e4f 4e45 3a0a  e GGML_OP_NONE:.
-00089220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089230: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00089240: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00089250: 6465 2d3e 6e5f 7461 736b 7320 3d20 313b  de->n_tasks = 1;
-00089260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00089270: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00089280: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00089290: 7365 2047 474d 4c5f 4f50 5f43 4f55 4e54  se GGML_OP_COUNT
-000892a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000892b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000892c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000892d0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-000892e0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-000892f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00089300: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00089310: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00089320: 2020 6966 2028 6367 7261 7068 2d3e 776f    if (cgraph->wo
-00089330: 726b 2021 3d20 4e55 4c4c 2026 2620 776f  rk != NULL && wo
-00089340: 726b 5f73 697a 6520 3e20 6367 7261 7068  rk_size > cgraph
-00089350: 2d3e 776f 726b 5f73 697a 6529 207b 0a20  ->work_size) {. 
-00089360: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00089370: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
-00089380: 2f20 544f 444f 3a20 6265 7474 6572 2068  / TODO: better h
-00089390: 616e 646c 696e 670a 2020 2020 2020 2020  andling.        
-000893a0: 7d0a 0a20 2020 2020 2020 2069 6620 2877  }..        if (w
-000893b0: 6f72 6b5f 7369 7a65 203e 2030 2026 2620  ork_size > 0 && 
-000893c0: 6367 7261 7068 2d3e 776f 726b 203d 3d20  cgraph->work == 
-000893d0: 4e55 4c4c 2920 7b0a 2020 2020 2020 2020  NULL) {.        
-000893e0: 2020 2020 6367 7261 7068 2d3e 776f 726b      cgraph->work
-000893f0: 5f73 697a 6520 3d20 776f 726b 5f73 697a  _size = work_siz
-00089400: 6520 2b20 4341 4348 455f 4c49 4e45 5f53  e + CACHE_LINE_S
-00089410: 495a 452a 286e 5f74 6872 6561 6473 202d  IZE*(n_threads -
-00089420: 2031 293b 0a0a 2020 2020 2020 2020 2020   1);..          
-00089430: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
-00089440: 5547 2822 2573 3a20 616c 6c6f 6361 7469  UG("%s: allocati
-00089450: 6e67 2077 6f72 6b20 6275 6666 6572 2066  ng work buffer f
-00089460: 6f72 2067 7261 7068 2028 257a 7520 6279  or graph (%zu by
-00089470: 7465 7329 5c6e 222c 205f 5f66 756e 635f  tes)\n", __func_
-00089480: 5f2c 2063 6772 6170 682d 3e77 6f72 6b5f  _, cgraph->work_
-00089490: 7369 7a65 293b 0a20 2020 2020 2020 2020  size);.         
-000894a0: 2020 2063 6772 6170 682d 3e77 6f72 6b20     cgraph->work 
-000894b0: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-000894c0: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-000894d0: 5950 455f 4938 2c20 6367 7261 7068 2d3e  YPE_I8, cgraph->
-000894e0: 776f 726b 5f73 697a 6529 3b0a 2020 2020  work_size);.    
-000894f0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-00089500: 202f 2f20 6372 6561 7465 2074 6872 6561   // create threa
-00089510: 6420 706f 6f6c 0a20 2020 2069 6620 286e  d pool.    if (n
-00089520: 5f74 6872 6561 6473 203e 2031 2920 7b0a  _threads > 1) {.
-00089530: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00089540: 206a 203d 2031 3b20 6a20 3c20 6e5f 7468   j = 1; j < n_th
-00089550: 7265 6164 733b 202b 2b6a 2920 7b0a 2020  reads; ++j) {.  
-00089560: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00089570: 735b 6a5d 203d 2028 7374 7275 6374 2067  s[j] = (struct g
-00089580: 676d 6c5f 636f 6d70 7574 655f 7374 6174  gml_compute_stat
-00089590: 6529 207b 0a20 2020 2020 2020 2020 2020  e) {.           
-000895a0: 2020 2020 202e 7468 7264 2020 203d 2030       .thrd   = 0
-000895b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000895c0: 2020 2e69 7468 203d 206a 2c0a 2020 2020    .ith = j,.    
-000895d0: 2020 2020 2020 2020 2020 2020 2e73 6861              .sha
-000895e0: 7265 6420 3d20 2673 7461 7465 5f73 6861  red = &state_sha
-000895f0: 7265 642c 0a20 2020 2020 2020 2020 2020  red,.           
-00089600: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
-00089610: 2063 6f6e 7374 2069 6e74 2072 6320 3d20   const int rc = 
-00089620: 6767 6d6c 5f74 6872 6561 645f 6372 6561  ggml_thread_crea
-00089630: 7465 2826 776f 726b 6572 735b 6a5d 2e74  te(&workers[j].t
-00089640: 6872 642c 204e 554c 4c2c 2067 676d 6c5f  hrd, NULL, ggml_
-00089650: 6772 6170 685f 636f 6d70 7574 655f 7468  graph_compute_th
-00089660: 7265 6164 2c20 2677 6f72 6b65 7273 5b6a  read, &workers[j
-00089670: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
-00089680: 4747 4d4c 5f41 5353 4552 5428 7263 203d  GGML_ASSERT(rc =
-00089690: 3d20 3029 3b0a 2020 2020 2020 2020 7d0a  = 0);.        }.
-000896a0: 2020 2020 7d0a 2020 2020 776f 726b 6572      }.    worker
-000896b0: 735b 305d 2e69 7468 203d 2030 3b0a 2020  s[0].ith = 0;.  
-000896c0: 2020 776f 726b 6572 735b 305d 2e73 6861    workers[0].sha
-000896d0: 7265 6420 3d20 2673 7461 7465 5f73 6861  red = &state_sha
-000896e0: 7265 643b 0a0a 2020 2020 636f 6e73 7420  red;..    const 
-000896f0: 696e 7436 345f 7420 7065 7266 5f73 7461  int64_t perf_sta
-00089700: 7274 5f63 7963 6c65 7320 203d 2067 676d  rt_cycles  = ggm
-00089710: 6c5f 7065 7266 5f63 7963 6c65 7328 293b  l_perf_cycles();
-00089720: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00089730: 5f74 2070 6572 665f 7374 6172 745f 7469  _t perf_start_ti
-00089740: 6d65 5f75 7320 3d20 6767 6d6c 5f70 6572  me_us = ggml_per
-00089750: 665f 7469 6d65 5f75 7328 293b 0a0a 2020  f_time_us();..  
-00089760: 2020 2f2f 2074 6869 7320 6973 2061 2077    // this is a w
-00089770: 6f72 6b20 7468 7265 6164 2074 6f6f 0a20  ork thread too. 
-00089780: 2020 2067 676d 6c5f 6772 6170 685f 636f     ggml_graph_co
-00089790: 6d70 7574 655f 7468 7265 6164 2826 776f  mpute_thread(&wo
-000897a0: 726b 6572 735b 305d 293b 0a0a 2020 2020  rkers[0]);..    
-000897b0: 2f2f 2064 6f6e 2774 206c 6561 7665 2061  // don't leave a
-000897c0: 6666 696e 6974 7920 7365 7420 6f6e 2074  ffinity set on t
-000897d0: 6865 206d 6169 6e20 7468 7265 6164 0a20  he main thread. 
-000897e0: 2020 2063 6c65 6172 5f6e 756d 615f 7468     clear_numa_th
-000897f0: 7265 6164 5f61 6666 696e 6974 7928 293b  read_affinity();
-00089800: 0a0a 2020 2020 2f2f 206a 6f69 6e20 7468  ..    // join th
-00089810: 7265 6164 2070 6f6f 6c0a 2020 2020 6966  read pool.    if
-00089820: 2028 6e5f 7468 7265 6164 7320 3e20 3129   (n_threads > 1)
-00089830: 207b 0a20 2020 2020 2020 2066 6f72 2028   {.        for (
-00089840: 696e 7420 6a20 3d20 313b 206a 203c 206e  int j = 1; j < n
-00089850: 5f74 6872 6561 6473 3b20 6a2b 2b29 207b  _threads; j++) {
-00089860: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00089870: 7374 2069 6e74 2072 6320 3d20 6767 6d6c  st int rc = ggml
-00089880: 5f74 6872 6561 645f 6a6f 696e 2877 6f72  _thread_join(wor
-00089890: 6b65 7273 5b6a 5d2e 7468 7264 2c20 4e55  kers[j].thrd, NU
-000898a0: 4c4c 293b 0a20 2020 2020 2020 2020 2020  LL);.           
-000898b0: 2047 474d 4c5f 4153 5345 5254 2872 6320   GGML_ASSERT(rc 
-000898c0: 3d3d 2030 293b 0a20 2020 2020 2020 207d  == 0);.        }
-000898d0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2070  .    }..    // p
-000898e0: 6572 666f 726d 616e 6365 2073 7461 7473  erformance stats
-000898f0: 2028 6772 6170 6829 0a20 2020 207b 0a20   (graph).    {. 
-00089900: 2020 2020 2020 2069 6e74 3634 5f74 2070         int64_t p
-00089910: 6572 665f 6379 636c 6573 5f63 7572 2020  erf_cycles_cur  
-00089920: 3d20 6767 6d6c 5f70 6572 665f 6379 636c  = ggml_perf_cycl
-00089930: 6573 2829 2020 2d20 7065 7266 5f73 7461  es()  - perf_sta
-00089940: 7274 5f63 7963 6c65 733b 0a20 2020 2020  rt_cycles;.     
-00089950: 2020 2069 6e74 3634 5f74 2070 6572 665f     int64_t perf_
-00089960: 7469 6d65 5f75 735f 6375 7220 3d20 6767  time_us_cur = gg
-00089970: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-00089980: 2920 2d20 7065 7266 5f73 7461 7274 5f74  ) - perf_start_t
-00089990: 696d 655f 7573 3b0a 0a20 2020 2020 2020  ime_us;..       
-000899a0: 2063 6772 6170 682d 3e70 6572 665f 7275   cgraph->perf_ru
-000899b0: 6e73 2b2b 3b0a 2020 2020 2020 2020 6367  ns++;.        cg
-000899c0: 7261 7068 2d3e 7065 7266 5f63 7963 6c65  raph->perf_cycle
-000899d0: 7320 202b 3d20 7065 7266 5f63 7963 6c65  s  += perf_cycle
-000899e0: 735f 6375 723b 0a20 2020 2020 2020 2063  s_cur;.        c
-000899f0: 6772 6170 682d 3e70 6572 665f 7469 6d65  graph->perf_time
-00089a00: 5f75 7320 2b3d 2070 6572 665f 7469 6d65  _us += perf_time
-00089a10: 5f75 735f 6375 723b 0a0a 2020 2020 2020  _us_cur;..      
-00089a20: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
-00089a30: 5547 2822 2573 3a20 7065 7266 2028 2564  UG("%s: perf (%d
-00089a40: 2920 2d20 6370 7520 3d20 252e 3366 202f  ) - cpu = %.3f /
-00089a50: 2025 2e33 6620 6d73 2c20 7761 6c6c 203d   %.3f ms, wall =
-00089a60: 2025 2e33 6620 2f20 252e 3366 206d 735c   %.3f / %.3f ms\
-00089a70: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-00089a80: 2020 2020 5f5f 6675 6e63 5f5f 2c20 6367      __func__, cg
-00089a90: 7261 7068 2d3e 7065 7266 5f72 756e 732c  raph->perf_runs,
-00089aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00089ab0: 2028 646f 7562 6c65 2920 7065 7266 5f63   (double) perf_c
-00089ac0: 7963 6c65 735f 6375 7220 2020 2020 202f  ycles_cur      /
-00089ad0: 2028 646f 7562 6c65 2920 6767 6d6c 5f63   (double) ggml_c
-00089ae0: 7963 6c65 735f 7065 725f 6d73 2829 2c0a  ycles_per_ms(),.
-00089af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089b00: 2864 6f75 626c 6529 2063 6772 6170 682d  (double) cgraph-
-00089b10: 3e70 6572 665f 6379 636c 6573 2020 2f20  >perf_cycles  / 
-00089b20: 2864 6f75 626c 6529 2067 676d 6c5f 6379  (double) ggml_cy
-00089b30: 636c 6573 5f70 6572 5f6d 7328 2920 2f20  cles_per_ms() / 
-00089b40: 2864 6f75 626c 6529 2063 6772 6170 682d  (double) cgraph-
-00089b50: 3e70 6572 665f 7275 6e73 2c0a 2020 2020  >perf_runs,.    
-00089b60: 2020 2020 2020 2020 2020 2020 2864 6f75              (dou
-00089b70: 626c 6529 2070 6572 665f 7469 6d65 5f75  ble) perf_time_u
-00089b80: 735f 6375 7220 2020 2020 2f20 3130 3030  s_cur     / 1000
-00089b90: 2e30 2c0a 2020 2020 2020 2020 2020 2020  .0,.            
-00089ba0: 2020 2020 2864 6f75 626c 6529 2063 6772      (double) cgr
-00089bb0: 6170 682d 3e70 6572 665f 7469 6d65 5f75  aph->perf_time_u
-00089bc0: 7320 2f20 3130 3030 2e30 202f 2063 6772  s / 1000.0 / cgr
-00089bd0: 6170 682d 3e70 6572 665f 7275 6e73 293b  aph->perf_runs);
-00089be0: 0a20 2020 207d 0a7d 0a0a 766f 6964 2067  .    }.}..void g
-00089bf0: 676d 6c5f 6772 6170 685f 7265 7365 7428  gml_graph_reset(
-00089c00: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-00089c10: 7068 202a 2063 6772 6170 6829 207b 0a20  ph * cgraph) {. 
-00089c20: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00089c30: 303b 2069 203c 2063 6772 6170 682d 3e6e  0; i < cgraph->n
-00089c40: 5f6e 6f64 6573 3b20 692b 2b29 207b 0a20  _nodes; i++) {. 
-00089c50: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00089c60: 6d6c 5f74 656e 736f 7220 2a20 6772 6164  ml_tensor * grad
-00089c70: 203d 2063 6772 6170 682d 3e67 7261 6473   = cgraph->grads
-00089c80: 5b69 5d3b 0a0a 2020 2020 2020 2020 6966  [i];..        if
-00089c90: 2028 6772 6164 2920 7b0a 2020 2020 2020   (grad) {.      
-00089ca0: 2020 2020 2020 6767 6d6c 5f73 6574 5f7a        ggml_set_z
-00089cb0: 6572 6f28 6772 6164 293b 0a20 2020 2020  ero(grad);.     
-00089cc0: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-00089cd0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00089ce0: 202a 2067 676d 6c5f 6772 6170 685f 6765   * ggml_graph_ge
-00089cf0: 745f 7465 6e73 6f72 2873 7472 7563 7420  t_tensor(struct 
-00089d00: 6767 6d6c 5f63 6772 6170 6820 2a20 6367  ggml_cgraph * cg
-00089d10: 7261 7068 2c20 636f 6e73 7420 6368 6172  raph, const char
-00089d20: 202a 206e 616d 6529 207b 0a20 2020 2066   * name) {.    f
-00089d30: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00089d40: 203c 2063 6772 6170 682d 3e6e 5f6c 6561   < cgraph->n_lea
-00089d50: 6673 3b20 692b 2b29 207b 0a20 2020 2020  fs; i++) {.     
-00089d60: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00089d70: 656e 736f 7220 2a20 6c65 6166 203d 2063  ensor * leaf = c
-00089d80: 6772 6170 682d 3e6c 6561 6673 5b69 5d3b  graph->leafs[i];
-00089d90: 0a0a 2020 2020 2020 2020 6966 2028 7374  ..        if (st
-00089da0: 7263 6d70 286c 6561 662d 3e6e 616d 652c  rcmp(leaf->name,
-00089db0: 206e 616d 6529 203d 3d20 3029 207b 0a20   name) == 0) {. 
-00089dc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00089dd0: 6e20 6c65 6166 3b0a 2020 2020 2020 2020  n leaf;.        
-00089de0: 7d0a 2020 2020 7d0a 0a20 2020 2066 6f72  }.    }..    for
-00089df0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-00089e00: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
-00089e10: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00089e20: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00089e30: 736f 7220 2a20 6e6f 6465 203d 2063 6772  sor * node = cgr
-00089e40: 6170 682d 3e6e 6f64 6573 5b69 5d3b 0a0a  aph->nodes[i];..
-00089e50: 2020 2020 2020 2020 6966 2028 7374 7263          if (strc
-00089e60: 6d70 286e 6f64 652d 3e6e 616d 652c 206e  mp(node->name, n
-00089e70: 616d 6529 203d 3d20 3029 207b 0a20 2020  ame) == 0) {.   
-00089e80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00089e90: 6e6f 6465 3b0a 2020 2020 2020 2020 7d0a  node;.        }.
-00089ea0: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
-00089eb0: 6e20 4e55 4c4c 3b0a 7d0a 0a73 7461 7469  n NULL;.}..stati
-00089ec0: 6320 766f 6964 2067 676d 6c5f 6772 6170  c void ggml_grap
-00089ed0: 685f 6578 706f 7274 5f6c 6561 6628 636f  h_export_leaf(co
-00089ee0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00089ef0: 7465 6e73 6f72 202a 2074 656e 736f 722c  tensor * tensor,
-00089f00: 2046 494c 4520 2a20 666f 7574 2920 7b0a   FILE * fout) {.
-00089f10: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00089f20: 7420 2a20 6e65 203d 2074 656e 736f 722d  t * ne = tensor-
-00089f30: 3e6e 653b 0a20 2020 2063 6f6e 7374 2073  >ne;.    const s
-00089f40: 697a 655f 7420 202a 206e 6220 3d20 7465  ize_t  * nb = te
-00089f50: 6e73 6f72 2d3e 6e62 3b0a 0a20 2020 2066  nsor->nb;..    f
-00089f60: 7072 696e 7466 2866 6f75 742c 2022 252d  printf(fout, "%-
-00089f70: 3673 2025 2d31 3273 2025 3864 2025 2220  6s %-12s %8d %" 
-00089f80: 5052 4964 3634 2022 2025 2220 5052 4964  PRId64 " %" PRId
-00089f90: 3634 2022 2025 2220 5052 4964 3634 2022  64 " %" PRId64 "
-00089fa0: 2025 2220 5052 4964 3634 2022 2025 3136   %" PRId64 " %16
-00089fb0: 7a75 2025 3136 7a75 2025 3136 7a75 2025  zu %16zu %16zu %
-00089fc0: 3136 7a75 2025 3136 7020 2533 3273 5c6e  16zu %16p %32s\n
-00089fd0: 222c 0a20 2020 2020 2020 2020 2020 2067  ",.            g
-00089fe0: 676d 6c5f 7479 7065 5f6e 616d 6528 7465  gml_type_name(te
-00089ff0: 6e73 6f72 2d3e 7479 7065 292c 0a20 2020  nsor->type),.   
-0008a000: 2020 2020 2020 2020 2067 676d 6c5f 6f70           ggml_op
-0008a010: 5f6e 616d 6520 2028 7465 6e73 6f72 2d3e  _name  (tensor->
-0008a020: 6f70 292c 0a20 2020 2020 2020 2020 2020  op),.           
-0008a030: 2074 656e 736f 722d 3e6e 5f64 696d 732c   tensor->n_dims,
-0008a040: 0a20 2020 2020 2020 2020 2020 206e 655b  .            ne[
-0008a050: 305d 2c20 6e65 5b31 5d2c 206e 655b 325d  0], ne[1], ne[2]
-0008a060: 2c20 6e65 5b33 5d2c 0a20 2020 2020 2020  , ne[3],.       
-0008a070: 2020 2020 206e 625b 305d 2c20 6e62 5b31       nb[0], nb[1
-0008a080: 5d2c 206e 625b 325d 2c20 6e62 5b33 5d2c  ], nb[2], nb[3],
-0008a090: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
-0008a0a0: 736f 722d 3e64 6174 612c 0a20 2020 2020  sor->data,.     
-0008a0b0: 2020 2020 2020 2074 656e 736f 722d 3e6e         tensor->n
-0008a0c0: 616d 6529 3b0a 7d0a 0a73 7461 7469 6320  ame);.}..static 
-0008a0d0: 766f 6964 2067 676d 6c5f 6772 6170 685f  void ggml_graph_
-0008a0e0: 6578 706f 7274 5f6e 6f64 6528 636f 6e73  export_node(cons
-0008a0f0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0008a100: 6e73 6f72 202a 2074 656e 736f 722c 2063  nsor * tensor, c
-0008a110: 6f6e 7374 2063 6861 7220 2a20 6172 672c  onst char * arg,
-0008a120: 2046 494c 4520 2a20 666f 7574 2920 7b0a   FILE * fout) {.
-0008a130: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0008a140: 7420 2a20 6e65 203d 2074 656e 736f 722d  t * ne = tensor-
-0008a150: 3e6e 653b 0a20 2020 2063 6f6e 7374 2073  >ne;.    const s
-0008a160: 697a 655f 7420 202a 206e 6220 3d20 7465  ize_t  * nb = te
-0008a170: 6e73 6f72 2d3e 6e62 3b0a 0a20 2020 2066  nsor->nb;..    f
-0008a180: 7072 696e 7466 2866 6f75 742c 2022 252d  printf(fout, "%-
-0008a190: 3673 2025 2d36 7320 252d 3132 7320 2538  6s %-6s %-12s %8
-0008a1a0: 6420 2522 2050 5249 6436 3420 2220 2522  d %" PRId64 " %"
-0008a1b0: 2050 5249 6436 3420 2220 2522 2050 5249   PRId64 " %" PRI
-0008a1c0: 6436 3420 2220 2522 2050 5249 6436 3420  d64 " %" PRId64 
-0008a1d0: 2220 2531 367a 7520 2531 367a 7520 2531  " %16zu %16zu %1
-0008a1e0: 367a 7520 2531 367a 7520 2538 6420 2531  6zu %16zu %8d %1
-0008a1f0: 3670 2025 3332 735c 6e22 2c0a 2020 2020  6p %32s\n",.    
-0008a200: 2020 2020 2020 2020 6172 672c 0a20 2020          arg,.   
-0008a210: 2020 2020 2020 2020 2067 676d 6c5f 7479           ggml_ty
-0008a220: 7065 5f6e 616d 6528 7465 6e73 6f72 2d3e  pe_name(tensor->
-0008a230: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
-0008a240: 2020 2067 676d 6c5f 6f70 5f6e 616d 6520     ggml_op_name 
-0008a250: 2028 7465 6e73 6f72 2d3e 6f70 292c 0a20   (tensor->op),. 
-0008a260: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0008a270: 722d 3e6e 5f64 696d 732c 0a20 2020 2020  r->n_dims,.     
-0008a280: 2020 2020 2020 206e 655b 305d 2c20 6e65         ne[0], ne
-0008a290: 5b31 5d2c 206e 655b 325d 2c20 6e65 5b33  [1], ne[2], ne[3
-0008a2a0: 5d2c 0a20 2020 2020 2020 2020 2020 206e  ],.            n
-0008a2b0: 625b 305d 2c20 6e62 5b31 5d2c 206e 625b  b[0], nb[1], nb[
-0008a2c0: 325d 2c20 6e62 5b33 5d2c 0a20 2020 2020  2], nb[3],.     
-0008a2d0: 2020 2020 2020 2074 656e 736f 722d 3e6e         tensor->n
-0008a2e0: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
-0008a2f0: 2020 2020 7465 6e73 6f72 2d3e 6461 7461      tensor->data
-0008a300: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-0008a310: 6e73 6f72 2d3e 6e61 6d65 293b 0a7d 0a0a  nsor->name);.}..
-0008a320: 766f 6964 2067 676d 6c5f 6772 6170 685f  void ggml_graph_
-0008a330: 6578 706f 7274 2863 6f6e 7374 2073 7472  export(const str
-0008a340: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
-0008a350: 2a20 6367 7261 7068 2c20 636f 6e73 7420  * cgraph, const 
-0008a360: 6368 6172 202a 2066 6e61 6d65 2920 7b0a  char * fname) {.
-0008a370: 2020 2020 2f2f 6173 7365 7274 2863 6772      //assert(cgr
-0008a380: 6170 682d 3e77 6f72 6b20 2020 2020 203d  aph->work      =
-0008a390: 3d20 4e55 4c4c 293b 0a20 2020 202f 2f61  = NULL);.    //a
-0008a3a0: 7373 6572 7428 6367 7261 7068 2d3e 776f  ssert(cgraph->wo
-0008a3b0: 726b 5f73 697a 6520 3d3d 2030 293b 0a0a  rk_size == 0);..
-0008a3c0: 2020 2020 7569 6e74 3634 5f74 2073 697a      uint64_t siz
-0008a3d0: 655f 6576 616c 203d 2030 3b0a 0a20 2020  e_eval = 0;..   
-0008a3e0: 202f 2f20 636f 6d70 7574 6520 7369 7a65   // compute size
-0008a3f0: 206f 6620 696e 7465 726d 6564 6961 7465   of intermediate
-0008a400: 2072 6573 756c 7473 0a20 2020 202f 2f20   results.    // 
-0008a410: 544f 444f 3a20 646f 6573 206e 6f74 2074  TODO: does not t
-0008a420: 616b 6520 696e 746f 2061 6363 6f75 6e74  ake into account
-0008a430: 2073 6372 6174 6368 2062 7566 6665 7273   scratch buffers
-0008a440: 2021 2121 210a 2020 2020 666f 7220 2869   !!!!.    for (i
-0008a450: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
-0008a460: 7261 7068 2d3e 6e5f 6e6f 6465 733b 202b  raph->n_nodes; +
-0008a470: 2b69 2920 7b0a 2020 2020 2020 2020 7369  +i) {.        si
-0008a480: 7a65 5f65 7661 6c20 2b3d 2067 676d 6c5f  ze_eval += ggml_
-0008a490: 6e62 7974 6573 2863 6772 6170 682d 3e6e  nbytes(cgraph->n
-0008a4a0: 6f64 6573 5b69 5d29 3b0a 2020 2020 7d0a  odes[i]);.    }.
-0008a4b0: 0a20 2020 202f 2f20 7072 696e 740a 2020  .    // print.  
-0008a4c0: 2020 7b0a 2020 2020 2020 2020 4649 4c45    {.        FILE
-0008a4d0: 202a 2066 6f75 7420 3d20 7374 646f 7574   * fout = stdout
-0008a4e0: 3b0a 0a20 2020 2020 2020 2066 7072 696e  ;..        fprin
-0008a4f0: 7466 2866 6f75 742c 2022 5c6e 2229 3b0a  tf(fout, "\n");.
-0008a500: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
-0008a510: 666f 7574 2c20 2225 2d31 3673 2025 3878  fout, "%-16s %8x
-0008a520: 5c6e 222c 2022 6d61 6769 6322 2c20 2020  \n", "magic",   
-0008a530: 2020 2020 2047 474d 4c5f 4649 4c45 5f4d       GGML_FILE_M
-0008a540: 4147 4943 293b 0a20 2020 2020 2020 2066  AGIC);.        f
-0008a550: 7072 696e 7466 2866 6f75 742c 2022 252d  printf(fout, "%-
-0008a560: 3136 7320 2538 645c 6e22 2c20 2276 6572  16s %8d\n", "ver
-0008a570: 7369 6f6e 222c 2020 2020 2020 4747 4d4c  sion",      GGML
-0008a580: 5f46 494c 455f 5645 5253 494f 4e29 3b0a  _FILE_VERSION);.
-0008a590: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
-0008a5a0: 666f 7574 2c20 2225 2d31 3673 2025 3864  fout, "%-16s %8d
-0008a5b0: 5c6e 222c 2022 6c65 6166 7322 2c20 2020  \n", "leafs",   
-0008a5c0: 2020 2020 2063 6772 6170 682d 3e6e 5f6c       cgraph->n_l
-0008a5d0: 6561 6673 293b 0a20 2020 2020 2020 2066  eafs);.        f
-0008a5e0: 7072 696e 7466 2866 6f75 742c 2022 252d  printf(fout, "%-
-0008a5f0: 3136 7320 2538 645c 6e22 2c20 226e 6f64  16s %8d\n", "nod
-0008a600: 6573 222c 2020 2020 2020 2020 6367 7261  es",        cgra
-0008a610: 7068 2d3e 6e5f 6e6f 6465 7329 3b0a 2020  ph->n_nodes);.  
-0008a620: 2020 2020 2020 6670 7269 6e74 6628 666f        fprintf(fo
-0008a630: 7574 2c20 2225 2d31 3673 2025 2220 5052  ut, "%-16s %" PR
-0008a640: 4975 3634 2022 5c6e 222c 2022 6576 616c  Iu64 "\n", "eval
-0008a650: 222c 2073 697a 655f 6576 616c 293b 0a0a  ", size_eval);..
-0008a660: 2020 2020 2020 2020 2f2f 2068 6561 6465          // heade
-0008a670: 720a 2020 2020 2020 2020 6670 7269 6e74  r.        fprint
-0008a680: 6628 666f 7574 2c20 225c 6e22 293b 0a20  f(fout, "\n");. 
-0008a690: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
-0008a6a0: 6f75 742c 2022 252d 3673 2025 2d31 3273  out, "%-6s %-12s
-0008a6b0: 2025 3873 2025 3873 2025 3873 2025 3873   %8s %8s %8s %8s
-0008a6c0: 2025 3873 2025 3136 7320 2531 3673 2025   %8s %16s %16s %
-0008a6d0: 3136 7320 2531 3673 2025 3136 7320 2531  16s %16s %16s %1
-0008a6e0: 3673 5c6e 222c 0a20 2020 2020 2020 2020  6s\n",.         
-0008a6f0: 2020 2020 2020 2022 5459 5045 222c 2022         "TYPE", "
-0008a700: 4f50 222c 2022 4e44 494d 5322 2c20 224e  OP", "NDIMS", "N
-0008a710: 4530 222c 2022 4e45 3122 2c20 224e 4532  E0", "NE1", "NE2
-0008a720: 222c 2022 4e45 3322 2c20 224e 4230 222c  ", "NE3", "NB0",
-0008a730: 2022 4e42 3122 2c20 224e 4232 222c 2022   "NB1", "NB2", "
-0008a740: 4e42 3322 2c20 2244 4154 4122 2c20 224e  NB3", "DATA", "N
-0008a750: 414d 4522 293b 0a0a 2020 2020 2020 2020  AME");..        
-0008a760: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0008a770: 6920 3c20 6367 7261 7068 2d3e 6e5f 6c65  i < cgraph->n_le
-0008a780: 6166 733b 202b 2b69 2920 7b0a 2020 2020  afs; ++i) {.    
-0008a790: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
-0008a7a0: 7068 5f65 7870 6f72 745f 6c65 6166 2863  ph_export_leaf(c
-0008a7b0: 6772 6170 682d 3e6c 6561 6673 5b69 5d2c  graph->leafs[i],
-0008a7c0: 2066 6f75 7429 3b0a 0a20 2020 2020 2020   fout);..       
-0008a7d0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-0008a7e0: 2863 6772 6170 682d 3e6c 6561 6673 5b69  (cgraph->leafs[i
-0008a7f0: 5d2d 3e6f 7020 2020 3d3d 2047 474d 4c5f  ]->op   == GGML_
-0008a800: 4f50 5f4e 4f4e 4529 3b0a 2020 2020 2020  OP_NONE);.      
-0008a810: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0008a820: 5428 6367 7261 7068 2d3e 6c65 6166 735b  T(cgraph->leafs[
-0008a830: 695d 2d3e 7372 6330 203d 3d20 4e55 4c4c  i]->src0 == NULL
-0008a840: 293b 0a20 2020 2020 2020 2020 2020 2047  );.            G
-0008a850: 474d 4c5f 4153 5345 5254 2863 6772 6170  GML_ASSERT(cgrap
-0008a860: 682d 3e6c 6561 6673 5b69 5d2d 3e73 7263  h->leafs[i]->src
-0008a870: 3120 3d3d 204e 554c 4c29 3b0a 2020 2020  1 == NULL);.    
-0008a880: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
-0008a890: 2f20 6865 6164 6572 0a20 2020 2020 2020  / header.       
-0008a8a0: 2066 7072 696e 7466 2866 6f75 742c 2022   fprintf(fout, "
-0008a8b0: 5c6e 2229 3b0a 2020 2020 2020 2020 6670  \n");.        fp
-0008a8c0: 7269 6e74 6628 666f 7574 2c20 2225 2d36  rintf(fout, "%-6
-0008a8d0: 7320 252d 3673 2025 2d31 3273 2025 3873  s %-6s %-12s %8s
-0008a8e0: 2025 3873 2025 3873 2025 3873 2025 3873   %8s %8s %8s %8s
-0008a8f0: 2025 3136 7320 2531 3673 2025 3136 7320   %16s %16s %16s 
-0008a900: 2531 3673 2025 3873 2025 3136 7320 2531  %16s %8s %16s %1
-0008a910: 3673 5c6e 222c 0a20 2020 2020 2020 2020  6s\n",.         
-0008a920: 2020 2020 2020 2022 4152 4722 2c20 2254         "ARG", "T
-0008a930: 5950 4522 2c20 224f 5022 2c20 224e 4449  YPE", "OP", "NDI
-0008a940: 4d53 222c 2022 4e45 3022 2c20 224e 4531  MS", "NE0", "NE1
-0008a950: 222c 2022 4e45 3222 2c20 224e 4533 222c  ", "NE2", "NE3",
-0008a960: 2022 4e42 3022 2c20 224e 4231 222c 2022   "NB0", "NB1", "
-0008a970: 4e42 3222 2c20 224e 4233 222c 2022 4e54  NB2", "NB3", "NT
-0008a980: 4153 4b53 222c 2022 4441 5441 222c 2022  ASKS", "DATA", "
-0008a990: 4e41 4d45 2229 3b0a 0a20 2020 2020 2020  NAME");..       
-0008a9a0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0008a9b0: 2069 203c 2063 6772 6170 682d 3e6e 5f6e   i < cgraph->n_n
-0008a9c0: 6f64 6573 3b20 2b2b 6929 207b 0a20 2020  odes; ++i) {.   
-0008a9d0: 2020 2020 2020 2020 2067 676d 6c5f 6772           ggml_gr
-0008a9e0: 6170 685f 6578 706f 7274 5f6e 6f64 6528  aph_export_node(
-0008a9f0: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
-0008aa00: 2c20 2244 5354 222c 2066 6f75 7429 3b0a  , "DST", fout);.
-0008aa10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0008aa20: 2863 6772 6170 682d 3e6e 6f64 6573 5b69  (cgraph->nodes[i
-0008aa30: 5d2d 3e73 7263 3029 207b 0a20 2020 2020  ]->src0) {.     
-0008aa40: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0008aa50: 6772 6170 685f 6578 706f 7274 5f6e 6f64  graph_export_nod
-0008aa60: 6528 6367 7261 7068 2d3e 6e6f 6465 735b  e(cgraph->nodes[
-0008aa70: 695d 2d3e 7372 6330 2c20 2253 5243 3022  i]->src0, "SRC0"
-0008aa80: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
-0008aa90: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008aaa0: 2020 2020 6966 2028 6367 7261 7068 2d3e      if (cgraph->
-0008aab0: 6e6f 6465 735b 695d 2d3e 7372 6331 2920  nodes[i]->src1) 
-0008aac0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0008aad0: 2020 6767 6d6c 5f67 7261 7068 5f65 7870    ggml_graph_exp
-0008aae0: 6f72 745f 6e6f 6465 2863 6772 6170 682d  ort_node(cgraph-
-0008aaf0: 3e6e 6f64 6573 5b69 5d2d 3e73 7263 312c  >nodes[i]->src1,
-0008ab00: 2022 5352 4331 222c 2066 6f75 7429 3b0a   "SRC1", fout);.
-0008ab10: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-0008ab20: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-0008ab30: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
-0008ab40: 474d 4c5f 4d41 585f 4f50 543b 202b 2b6a  GML_MAX_OPT; ++j
-0008ab50: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008ab60: 2020 2020 6966 2028 6367 7261 7068 2d3e      if (cgraph->
-0008ab70: 6e6f 6465 735b 695d 2d3e 6f70 745b 6a5d  nodes[i]->opt[j]
-0008ab80: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008ab90: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
-0008aba0: 7068 5f65 7870 6f72 745f 6e6f 6465 2863  ph_export_node(c
-0008abb0: 6772 6170 682d 3e6e 6f64 6573 5b69 5d2d  graph->nodes[i]-
-0008abc0: 3e6f 7074 5b6a 5d2c 2022 4f50 5422 2c20  >opt[j], "OPT", 
-0008abd0: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-0008abe0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0008abf0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008ac00: 2020 2020 6670 7269 6e74 6628 666f 7574      fprintf(fout
-0008ac10: 2c20 225c 6e22 293b 0a20 2020 2020 2020  , "\n");.       
-0008ac20: 207d 0a0a 2020 2020 2020 2020 6670 7269   }..        fpri
-0008ac30: 6e74 6628 666f 7574 2c20 225c 6e22 293b  ntf(fout, "\n");
-0008ac40: 0a20 2020 207d 0a0a 2020 2020 2f2f 2077  .    }..    // w
-0008ac50: 7269 7465 2062 696e 6172 7920 6461 7461  rite binary data
-0008ac60: 0a20 2020 207b 0a20 2020 2020 2020 2046  .    {.        F
-0008ac70: 494c 4520 2a20 666f 7574 203d 2066 6f70  ILE * fout = fop
-0008ac80: 656e 2866 6e61 6d65 2c20 2277 6222 293b  en(fname, "wb");
-0008ac90: 0a0a 2020 2020 2020 2020 6966 2028 2166  ..        if (!f
-0008aca0: 6f75 7429 207b 0a20 2020 2020 2020 2020  out) {.         
-0008acb0: 2020 2066 7072 696e 7466 2873 7464 6572     fprintf(stder
-0008acc0: 722c 2022 2573 3a20 6661 696c 6564 2074  r, "%s: failed t
-0008acd0: 6f20 6f70 656e 2025 735c 6e22 2c20 5f5f  o open %s\n", __
-0008ace0: 6675 6e63 5f5f 2c20 666e 616d 6529 3b0a  func__, fname);.
-0008acf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0008ad00: 726e 3b0a 2020 2020 2020 2020 7d0a 0a20  rn;.        }.. 
-0008ad10: 2020 2020 2020 202f 2f20 6865 6164 6572         // header
-0008ad20: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-0008ad30: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-0008ad40: 7433 325f 7420 6d61 6769 6320 2020 3d20  t32_t magic   = 
-0008ad50: 4747 4d4c 5f46 494c 455f 4d41 4749 433b  GGML_FILE_MAGIC;
-0008ad60: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0008ad70: 7374 2075 696e 7433 325f 7420 7665 7273  st uint32_t vers
-0008ad80: 696f 6e20 3d20 4747 4d4c 5f46 494c 455f  ion = GGML_FILE_
-0008ad90: 5645 5253 494f 4e3b 0a20 2020 2020 2020  VERSION;.       
-0008ada0: 2020 2020 2063 6f6e 7374 2075 696e 7433       const uint3
-0008adb0: 325f 7420 6e5f 6c65 6166 7320 3d20 6367  2_t n_leafs = cg
-0008adc0: 7261 7068 2d3e 6e5f 6c65 6166 733b 0a20  raph->n_leafs;. 
-0008add0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0008ade0: 2075 696e 7433 325f 7420 6e6f 6465 7320   uint32_t nodes 
-0008adf0: 2020 3d20 6367 7261 7068 2d3e 6e5f 6e6f    = cgraph->n_no
-0008ae00: 6465 733b 0a0a 2020 2020 2020 2020 2020  des;..          
-0008ae10: 2020 6677 7269 7465 2826 6d61 6769 632c    fwrite(&magic,
-0008ae20: 2020 2020 2073 697a 656f 6628 7569 6e74       sizeof(uint
-0008ae30: 3332 5f74 292c 2031 2c20 666f 7574 293b  32_t), 1, fout);
-0008ae40: 0a20 2020 2020 2020 2020 2020 2066 7772  .            fwr
-0008ae50: 6974 6528 2676 6572 7369 6f6e 2c20 2020  ite(&version,   
-0008ae60: 7369 7a65 6f66 2875 696e 7433 325f 7429  sizeof(uint32_t)
-0008ae70: 2c20 312c 2066 6f75 7429 3b0a 2020 2020  , 1, fout);.    
-0008ae80: 2020 2020 2020 2020 6677 7269 7465 2826          fwrite(&
-0008ae90: 6e5f 6c65 6166 732c 2020 2073 697a 656f  n_leafs,   sizeo
-0008aea0: 6628 7569 6e74 3332 5f74 292c 2031 2c20  f(uint32_t), 1, 
-0008aeb0: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-0008aec0: 2020 2066 7772 6974 6528 266e 6f64 6573     fwrite(&nodes
-0008aed0: 2c20 2020 2020 7369 7a65 6f66 2875 696e  ,     sizeof(uin
-0008aee0: 7433 325f 7429 2c20 312c 2066 6f75 7429  t32_t), 1, fout)
-0008aef0: 3b0a 2020 2020 2020 2020 2020 2020 6677  ;.            fw
-0008af00: 7269 7465 2826 7369 7a65 5f65 7661 6c2c  rite(&size_eval,
-0008af10: 2073 697a 656f 6628 7569 6e74 3634 5f74   sizeof(uint64_t
-0008af20: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
-0008af30: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008af40: 2f2f 206c 6561 6673 0a20 2020 2020 2020  // leafs.       
-0008af50: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-0008af60: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0008af70: 203c 2063 6772 6170 682d 3e6e 5f6c 6561   < cgraph->n_lea
-0008af80: 6673 3b20 2b2b 6929 207b 0a20 2020 2020  fs; ++i) {.     
-0008af90: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0008afa0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0008afb0: 736f 7220 2a20 7465 6e73 6f72 203d 2063  sor * tensor = c
-0008afc0: 6772 6170 682d 3e6c 6561 6673 5b69 5d3b  graph->leafs[i];
-0008afd0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0008afe0: 2020 636f 6e73 7420 7569 6e74 3332 5f74    const uint32_t
-0008aff0: 2074 7970 6520 2020 3d20 7465 6e73 6f72   type   = tensor
-0008b000: 2d3e 7479 7065 3b0a 2020 2020 2020 2020  ->type;.        
-0008b010: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-0008b020: 6e74 3332 5f74 206f 7020 2020 2020 3d20  nt32_t op     = 
-0008b030: 7465 6e73 6f72 2d3e 6f70 3b0a 2020 2020  tensor->op;.    
-0008b040: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0008b050: 7420 7569 6e74 3332 5f74 206e 5f64 696d  t uint32_t n_dim
-0008b060: 7320 3d20 7465 6e73 6f72 2d3e 6e5f 6469  s = tensor->n_di
-0008b070: 6d73 3b0a 0a20 2020 2020 2020 2020 2020  ms;..           
-0008b080: 2020 2020 2066 7772 6974 6528 2674 7970       fwrite(&typ
-0008b090: 652c 2020 2073 697a 656f 6628 7569 6e74  e,   sizeof(uint
-0008b0a0: 3332 5f74 292c 2031 2c20 666f 7574 293b  32_t), 1, fout);
-0008b0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008b0c0: 2066 7772 6974 6528 266f 702c 2020 2020   fwrite(&op,    
-0008b0d0: 2073 697a 656f 6628 7569 6e74 3332 5f74   sizeof(uint32_t
-0008b0e0: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
-0008b0f0: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
-0008b100: 6974 6528 266e 5f64 696d 732c 2073 697a  ite(&n_dims, siz
-0008b110: 656f 6628 7569 6e74 3332 5f74 292c 2031  eof(uint32_t), 1
-0008b120: 2c20 666f 7574 293b 0a0a 2020 2020 2020  , fout);..      
-0008b130: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0008b140: 6e74 206a 203d 2030 3b20 6a20 3c20 4747  nt j = 0; j < GG
-0008b150: 4d4c 5f4d 4158 5f44 494d 533b 202b 2b6a  ML_MAX_DIMS; ++j
-0008b160: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008b170: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-0008b180: 6e74 3634 5f74 206e 6520 3d20 7465 6e73  nt64_t ne = tens
-0008b190: 6f72 2d3e 6e65 5b6a 5d3b 0a20 2020 2020  or->ne[j];.     
-0008b1a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0008b1b0: 6f6e 7374 2075 696e 7436 345f 7420 6e62  onst uint64_t nb
-0008b1c0: 203d 2074 656e 736f 722d 3e6e 625b 6a5d   = tensor->nb[j]
-0008b1d0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0008b1e0: 2020 2020 2020 2066 7772 6974 6528 266e         fwrite(&n
-0008b1f0: 652c 2073 697a 656f 6628 7569 6e74 3634  e, sizeof(uint64
-0008b200: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
-0008b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b220: 2020 2066 7772 6974 6528 266e 622c 2073     fwrite(&nb, s
-0008b230: 697a 656f 6628 7569 6e74 3634 5f74 292c  izeof(uint64_t),
-0008b240: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-0008b250: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-0008b260: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0008b270: 2073 746f 7265 2074 6865 2070 6f69 6e74   store the point
-0008b280: 6572 2061 6464 7265 7373 0a20 2020 2020  er address.     
-0008b290: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0008b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b2b0: 2063 6f6e 7374 2075 696e 7436 345f 7420   const uint64_t 
-0008b2c0: 7074 7220 3d20 2875 696e 7436 345f 7429  ptr = (uint64_t)
-0008b2d0: 2074 656e 736f 722d 3e64 6174 613b 0a0a   tensor->data;..
-0008b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b2f0: 2020 2020 6677 7269 7465 2826 7074 722c      fwrite(&ptr,
-0008b300: 2073 697a 656f 6628 7569 6e74 3634 5f74   sizeof(uint64_t
-0008b310: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
-0008b320: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-0008b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b340: 6677 7269 7465 2874 656e 736f 722d 3e6e  fwrite(tensor->n
-0008b350: 616d 652c 2073 697a 656f 6628 6368 6172  ame, sizeof(char
-0008b360: 292c 2047 474d 4c5f 4d41 585f 4e41 4d45  ), GGML_MAX_NAME
-0008b370: 2c20 666f 7574 293b 0a0a 2020 2020 2020  , fout);..      
-0008b380: 2020 2020 2020 2020 2020 2f2f 2064 756d            // dum
-0008b390: 7020 7468 6520 6461 7461 0a20 2020 2020  p the data.     
-0008b3a0: 2020 2020 2020 2020 2020 202f 2f20 544f             // TO
-0008b3b0: 444f 3a20 7061 6420 7468 6973 2074 6f20  DO: pad this to 
-0008b3c0: 3332 2062 7974 6520 626f 756e 6461 7279  32 byte boundary
-0008b3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008b3e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008b3f0: 2020 2020 2020 2063 6f6e 7374 2073 697a         const siz
-0008b400: 655f 7420 7369 7a65 203d 2067 676d 6c5f  e_t size = ggml_
-0008b410: 6e62 7974 6573 2874 656e 736f 7229 3b0a  nbytes(tensor);.
+00088b70: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+00088b80: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
+00088b90: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
+00088ba0: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+00088bb0: 5f74 2063 7572 203d 2030 3b0a 0a20 2020  _t cur = 0;..   
+00088bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088bd0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+00088be0: 5f74 2020 2020 4420 3d20 6e6f 6465 2d3e  _t    D = node->
+00088bf0: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
+00088c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088c10: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+00088c20: 5f74 206e 6531 3120 3d20 6767 6d6c 5f75  _t ne11 = ggml_u
+00088c30: 7028 6e6f 6465 2d3e 7372 6331 2d3e 6e65  p(node->src1->ne
+00088c40: 5b31 5d2c 2047 474d 4c5f 534f 4654 5f4d  [1], GGML_SOFT_M
+00088c50: 4158 5f55 4e52 4f4c 4c29 3b0a 2020 2020  AX_UNROLL);.    
+00088c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088c70: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00088c80: 7420 6d78 446e 203d 204d 4158 2844 2c20  t mxDn = MAX(D, 
+00088c90: 6e65 3131 2920 2a20 323b 202f 2f20 2a32  ne11) * 2; // *2
+00088ca0: 2062 6563 6175 7365 206f 6620 5320 616e   because of S an
+00088cb0: 6420 534d 2069 6e20 6767 6d6c 5f63 6f6d  d SM in ggml_com
+00088cc0: 7075 7465 5f66 6f72 7761 7264 5f66 6c61  pute_forward_fla
+00088cd0: 7368 5f61 7474 6e5f 6261 636b 0a20 2020  sh_attn_back.   
+00088ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088cf0: 2020 2020 2069 6620 286e 6f64 652d 3e73       if (node->s
+00088d00: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
+00088d10: 4c5f 5459 5045 5f46 3332 2920 7b0a 2020  L_TYPE_F32) {.  
+00088d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088d30: 2020 2020 2020 2020 2020 6375 7220 203d            cur  =
+00088d40: 2073 697a 656f 6628 666c 6f61 7429 2a6d   sizeof(float)*m
+00088d50: 7844 6e2a 6e6f 6465 2d3e 6e5f 7461 736b  xDn*node->n_task
+00088d60: 733b 202f 2f20 544f 444f 3a20 7468 6973  s; // TODO: this
+00088d70: 2063 616e 2062 6563 6f6d 6520 286e 5f74   can become (n_t
+00088d80: 6173 6b73 2d31 290a 2020 2020 2020 2020  asks-1).        
+00088d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088da0: 2020 2020 6375 7220 2b3d 2073 697a 656f      cur += sizeo
+00088db0: 6628 666c 6f61 7429 2a6d 7844 6e2a 6e6f  f(float)*mxDn*no
+00088dc0: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
+00088dd0: 7468 6973 2069 7320 6f76 6572 6573 7469  this is overesti
+00088de0: 6d61 7465 6420 6279 2078 320a 2020 2020  mated by x2.    
+00088df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088e00: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00088e10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00088e20: 6620 286e 6f64 652d 3e73 7263 312d 3e74  f (node->src1->t
+00088e30: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00088e40: 5f46 3136 2920 7b0a 2020 2020 2020 2020  _F16) {.        
+00088e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088e60: 2020 2020 6375 7220 203d 2073 697a 656f      cur  = sizeo
+00088e70: 6628 666c 6f61 7429 2a6d 7844 6e2a 6e6f  f(float)*mxDn*no
+00088e80: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
+00088e90: 544f 444f 3a20 7468 6973 2063 616e 2062  TODO: this can b
+00088ea0: 6563 6f6d 6520 286e 5f74 6173 6b73 2d31  ecome (n_tasks-1
+00088eb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00088ec0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00088ed0: 7220 2b3d 2073 697a 656f 6628 666c 6f61  r += sizeof(floa
+00088ee0: 7429 2a6d 7844 6e2a 6e6f 6465 2d3e 6e5f  t)*mxDn*node->n_
+00088ef0: 7461 736b 733b 202f 2f20 7468 6973 2069  tasks; // this i
+00088f00: 7320 6f76 6572 6573 7469 6d61 7465 6420  s overestimated 
+00088f10: 6279 2078 320a 2020 2020 2020 2020 2020  by x2.          
+00088f20: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00088f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00088f40: 2020 2020 2020 2020 2077 6f72 6b5f 7369           work_si
+00088f50: 7a65 203d 204d 4158 2877 6f72 6b5f 7369  ze = MAX(work_si
+00088f60: 7a65 2c20 6375 7229 3b0a 2020 2020 2020  ze, cur);.      
+00088f70: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+00088f80: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+00088f90: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00088fa0: 5f4f 505f 5749 4e5f 5041 5254 3a0a 2020  _OP_WIN_PART:.  
+00088fb0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00088fc0: 7365 2047 474d 4c5f 4f50 5f57 494e 5f55  se GGML_OP_WIN_U
+00088fd0: 4e50 4152 543a 0a20 2020 2020 2020 2020  NPART:.         
+00088fe0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00088ff0: 5f4f 505f 4d41 505f 554e 4152 593a 0a20  _OP_MAP_UNARY:. 
+00089000: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00089010: 6173 6520 4747 4d4c 5f4f 505f 4d41 505f  ase GGML_OP_MAP_
+00089020: 4249 4e41 5259 3a0a 2020 2020 2020 2020  BINARY:.        
+00089030: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00089040: 4c5f 4f50 5f4d 4150 5f43 5553 544f 4d31  L_OP_MAP_CUSTOM1
+00089050: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00089060: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
+00089070: 4150 5f43 5553 544f 4d32 3a0a 2020 2020  AP_CUSTOM2:.    
+00089080: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00089090: 2047 474d 4c5f 4f50 5f4d 4150 5f43 5553   GGML_OP_MAP_CUS
+000890a0: 544f 4d33 3a0a 2020 2020 2020 2020 2020  TOM3:.          
+000890b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000890c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000890d0: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
+000890e0: 7320 3d20 313b 0a20 2020 2020 2020 2020  s = 1;.         
+000890f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00089100: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
+00089110: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00089120: 5f43 524f 5353 5f45 4e54 524f 5059 5f4c  _CROSS_ENTROPY_L
+00089130: 4f53 533a 0a20 2020 2020 2020 2020 2020  OSS:.           
+00089140: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00089150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089160: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
+00089170: 203d 206e 5f74 6872 6561 6473 3b0a 0a20   = n_threads;.. 
+00089180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089190: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
+000891a0: 7220 3d20 6767 6d6c 5f74 7970 655f 7369  r = ggml_type_si
+000891b0: 7a65 286e 6f64 652d 3e74 7970 6529 2a28  ze(node->type)*(
+000891c0: 6e6f 6465 2d3e 6e5f 7461 736b 7320 2b20  node->n_tasks + 
+000891d0: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b30  node->src0->ne[0
+000891e0: 5d2a 6e6f 6465 2d3e 6e5f 7461 736b 7329  ]*node->n_tasks)
+000891f0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00089200: 2020 2020 2020 2020 2020 2077 6f72 6b5f             work_
+00089210: 7369 7a65 203d 204d 4158 2877 6f72 6b5f  size = MAX(work_
+00089220: 7369 7a65 2c20 6375 7229 3b0a 2020 2020  size, cur);.    
+00089230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089240: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00089250: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00089260: 4d4c 5f4f 505f 4352 4f53 535f 454e 5452  ML_OP_CROSS_ENTR
+00089270: 4f50 595f 4c4f 5353 5f42 4143 4b3a 0a20  OPY_LOSS_BACK:. 
+00089280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089290: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000892a0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+000892b0: 652d 3e6e 5f74 6173 6b73 203d 206e 5f74  e->n_tasks = n_t
+000892c0: 6872 6561 6473 3b0a 0a20 2020 2020 2020  hreads;..       
+000892d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000892e0: 2073 697a 655f 7420 6375 7220 3d20 6767   size_t cur = gg
+000892f0: 6d6c 5f74 7970 655f 7369 7a65 286e 6f64  ml_type_size(nod
+00089300: 652d 3e74 7970 6529 2a6e 6f64 652d 3e73  e->type)*node->s
+00089310: 7263 302d 3e6e 655b 305d 2a6e 6f64 652d  rc0->ne[0]*node-
+00089320: 3e6e 5f74 6173 6b73 3b0a 0a20 2020 2020  >n_tasks;..     
+00089330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089340: 2020 2077 6f72 6b5f 7369 7a65 203d 204d     work_size = M
+00089350: 4158 2877 6f72 6b5f 7369 7a65 2c20 6375  AX(work_size, cu
+00089360: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00089370: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00089380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00089390: 2063 6173 6520 4747 4d4c 5f4f 505f 4e4f   case GGML_OP_NO
+000893a0: 4e45 3a0a 2020 2020 2020 2020 2020 2020  NE:.            
+000893b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000893c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000893d0: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
+000893e0: 3d20 313b 0a20 2020 2020 2020 2020 2020  = 1;.           
+000893f0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00089400: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00089410: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+00089420: 4f55 4e54 3a0a 2020 2020 2020 2020 2020  OUNT:.          
+00089430: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00089440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089450: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00089460: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00089470: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00089480: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
+00089490: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
+000894a0: 2020 2020 2020 6966 2028 6367 7261 7068        if (cgraph
+000894b0: 2d3e 776f 726b 2021 3d20 4e55 4c4c 2026  ->work != NULL &
+000894c0: 2620 776f 726b 5f73 697a 6520 3e20 6367  & work_size > cg
+000894d0: 7261 7068 2d3e 776f 726b 5f73 697a 6529  raph->work_size)
+000894e0: 207b 0a20 2020 2020 2020 2020 2020 2047   {.            G
+000894f0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00089500: 293b 202f 2f20 544f 444f 3a20 6265 7474  ); // TODO: bett
+00089510: 6572 2068 616e 646c 696e 670a 2020 2020  er handling.    
+00089520: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
+00089530: 6620 2877 6f72 6b5f 7369 7a65 203e 2030  f (work_size > 0
+00089540: 2026 2620 6367 7261 7068 2d3e 776f 726b   && cgraph->work
+00089550: 203d 3d20 4e55 4c4c 2920 7b0a 2020 2020   == NULL) {.    
+00089560: 2020 2020 2020 2020 6367 7261 7068 2d3e          cgraph->
+00089570: 776f 726b 5f73 697a 6520 3d20 776f 726b  work_size = work
+00089580: 5f73 697a 6520 2b20 4341 4348 455f 4c49  _size + CACHE_LI
+00089590: 4e45 5f53 495a 452a 286e 5f74 6872 6561  NE_SIZE*(n_threa
+000895a0: 6473 202d 2031 293b 0a0a 2020 2020 2020  ds - 1);..      
+000895b0: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
+000895c0: 5f44 4542 5547 2822 2573 3a20 616c 6c6f  _DEBUG("%s: allo
+000895d0: 6361 7469 6e67 2077 6f72 6b20 6275 6666  cating work buff
+000895e0: 6572 2066 6f72 2067 7261 7068 2028 257a  er for graph (%z
+000895f0: 7520 6279 7465 7329 5c6e 222c 205f 5f66  u bytes)\n", __f
+00089600: 756e 635f 5f2c 2063 6772 6170 682d 3e77  unc__, cgraph->w
+00089610: 6f72 6b5f 7369 7a65 293b 0a20 2020 2020  ork_size);.     
+00089620: 2020 2020 2020 2063 6772 6170 682d 3e77         cgraph->w
+00089630: 6f72 6b20 3d20 6767 6d6c 5f6e 6577 5f74  ork = ggml_new_t
+00089640: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
+00089650: 4d4c 5f54 5950 455f 4938 2c20 6367 7261  ML_TYPE_I8, cgra
+00089660: 7068 2d3e 776f 726b 5f73 697a 6529 3b0a  ph->work_size);.
+00089670: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+00089680: 0a20 2020 202f 2f20 6372 6561 7465 2074  .    // create t
+00089690: 6872 6561 6420 706f 6f6c 0a20 2020 2069  hread pool.    i
+000896a0: 6620 286e 5f74 6872 6561 6473 203e 2031  f (n_threads > 1
+000896b0: 2920 7b0a 2020 2020 2020 2020 666f 7220  ) {.        for 
+000896c0: 2869 6e74 206a 203d 2031 3b20 6a20 3c20  (int j = 1; j < 
+000896d0: 6e5f 7468 7265 6164 733b 202b 2b6a 2920  n_threads; ++j) 
+000896e0: 7b0a 2020 2020 2020 2020 2020 2020 776f  {.            wo
+000896f0: 726b 6572 735b 6a5d 203d 2028 7374 7275  rkers[j] = (stru
+00089700: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00089710: 7374 6174 6529 207b 0a20 2020 2020 2020  state) {.       
+00089720: 2020 2020 2020 2020 202e 7468 7264 2020           .thrd  
+00089730: 203d 2030 2c0a 2020 2020 2020 2020 2020   = 0,.          
+00089740: 2020 2020 2020 2e69 7468 203d 206a 2c0a        .ith = j,.
+00089750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089760: 2e73 6861 7265 6420 3d20 2673 7461 7465  .shared = &state
+00089770: 5f73 6861 7265 642c 0a20 2020 2020 2020  _shared,.       
+00089780: 2020 2020 207d 3b0a 0a20 2020 2020 2020       };..       
+00089790: 2020 2020 2063 6f6e 7374 2069 6e74 2072       const int r
+000897a0: 6320 3d20 6767 6d6c 5f74 6872 6561 645f  c = ggml_thread_
+000897b0: 6372 6561 7465 2826 776f 726b 6572 735b  create(&workers[
+000897c0: 6a5d 2e74 6872 642c 204e 554c 4c2c 2067  j].thrd, NULL, g
+000897d0: 676d 6c5f 6772 6170 685f 636f 6d70 7574  gml_graph_comput
+000897e0: 655f 7468 7265 6164 2c20 2677 6f72 6b65  e_thread, &worke
+000897f0: 7273 5b6a 5d29 3b0a 2020 2020 2020 2020  rs[j]);.        
+00089800: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00089810: 7263 203d 3d20 3029 3b0a 2020 2020 2020  rc == 0);.      
+00089820: 2020 7d0a 2020 2020 7d0a 2020 2020 776f    }.    }.    wo
+00089830: 726b 6572 735b 305d 2e69 7468 203d 2030  rkers[0].ith = 0
+00089840: 3b0a 2020 2020 776f 726b 6572 735b 305d  ;.    workers[0]
+00089850: 2e73 6861 7265 6420 3d20 2673 7461 7465  .shared = &state
+00089860: 5f73 6861 7265 643b 0a0a 2020 2020 636f  _shared;..    co
+00089870: 6e73 7420 696e 7436 345f 7420 7065 7266  nst int64_t perf
+00089880: 5f73 7461 7274 5f63 7963 6c65 7320 203d  _start_cycles  =
+00089890: 2067 676d 6c5f 7065 7266 5f63 7963 6c65   ggml_perf_cycle
+000898a0: 7328 293b 0a20 2020 2063 6f6e 7374 2069  s();.    const i
+000898b0: 6e74 3634 5f74 2070 6572 665f 7374 6172  nt64_t perf_star
+000898c0: 745f 7469 6d65 5f75 7320 3d20 6767 6d6c  t_time_us = ggml
+000898d0: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
+000898e0: 0a0a 2020 2020 2f2f 2074 6869 7320 6973  ..    // this is
+000898f0: 2061 2077 6f72 6b20 7468 7265 6164 2074   a work thread t
+00089900: 6f6f 0a20 2020 2067 676d 6c5f 6772 6170  oo.    ggml_grap
+00089910: 685f 636f 6d70 7574 655f 7468 7265 6164  h_compute_thread
+00089920: 2826 776f 726b 6572 735b 305d 293b 0a0a  (&workers[0]);..
+00089930: 2020 2020 2f2f 2064 6f6e 2774 206c 6561      // don't lea
+00089940: 7665 2061 6666 696e 6974 7920 7365 7420  ve affinity set 
+00089950: 6f6e 2074 6865 206d 6169 6e20 7468 7265  on the main thre
+00089960: 6164 0a20 2020 2063 6c65 6172 5f6e 756d  ad.    clear_num
+00089970: 615f 7468 7265 6164 5f61 6666 696e 6974  a_thread_affinit
+00089980: 7928 293b 0a0a 2020 2020 2f2f 206a 6f69  y();..    // joi
+00089990: 6e20 7468 7265 6164 2070 6f6f 6c0a 2020  n thread pool.  
+000899a0: 2020 6966 2028 6e5f 7468 7265 6164 7320    if (n_threads 
+000899b0: 3e20 3129 207b 0a20 2020 2020 2020 2066  > 1) {.        f
+000899c0: 6f72 2028 696e 7420 6a20 3d20 313b 206a  or (int j = 1; j
+000899d0: 203c 206e 5f74 6872 6561 6473 3b20 6a2b   < n_threads; j+
+000899e0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000899f0: 2063 6f6e 7374 2069 6e74 2072 6320 3d20   const int rc = 
+00089a00: 6767 6d6c 5f74 6872 6561 645f 6a6f 696e  ggml_thread_join
+00089a10: 2877 6f72 6b65 7273 5b6a 5d2e 7468 7264  (workers[j].thrd
+00089a20: 2c20 4e55 4c4c 293b 0a20 2020 2020 2020  , NULL);.       
+00089a30: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00089a40: 2872 6320 3d3d 2030 293b 0a20 2020 2020  (rc == 0);.     
+00089a50: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+00089a60: 2f2f 2070 6572 666f 726d 616e 6365 2073  // performance s
+00089a70: 7461 7473 2028 6772 6170 6829 0a20 2020  tats (graph).   
+00089a80: 207b 0a20 2020 2020 2020 2069 6e74 3634   {.        int64
+00089a90: 5f74 2070 6572 665f 6379 636c 6573 5f63  _t perf_cycles_c
+00089aa0: 7572 2020 3d20 6767 6d6c 5f70 6572 665f  ur  = ggml_perf_
+00089ab0: 6379 636c 6573 2829 2020 2d20 7065 7266  cycles()  - perf
+00089ac0: 5f73 7461 7274 5f63 7963 6c65 733b 0a20  _start_cycles;. 
+00089ad0: 2020 2020 2020 2069 6e74 3634 5f74 2070         int64_t p
+00089ae0: 6572 665f 7469 6d65 5f75 735f 6375 7220  erf_time_us_cur 
+00089af0: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
+00089b00: 5f75 7328 2920 2d20 7065 7266 5f73 7461  _us() - perf_sta
+00089b10: 7274 5f74 696d 655f 7573 3b0a 0a20 2020  rt_time_us;..   
+00089b20: 2020 2020 2063 6772 6170 682d 3e70 6572       cgraph->per
+00089b30: 665f 7275 6e73 2b2b 3b0a 2020 2020 2020  f_runs++;.      
+00089b40: 2020 6367 7261 7068 2d3e 7065 7266 5f63    cgraph->perf_c
+00089b50: 7963 6c65 7320 202b 3d20 7065 7266 5f63  ycles  += perf_c
+00089b60: 7963 6c65 735f 6375 723b 0a20 2020 2020  ycles_cur;.     
+00089b70: 2020 2063 6772 6170 682d 3e70 6572 665f     cgraph->perf_
+00089b80: 7469 6d65 5f75 7320 2b3d 2070 6572 665f  time_us += perf_
+00089b90: 7469 6d65 5f75 735f 6375 723b 0a0a 2020  time_us_cur;..  
+00089ba0: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
+00089bb0: 5f44 4542 5547 2822 2573 3a20 7065 7266  _DEBUG("%s: perf
+00089bc0: 2028 2564 2920 2d20 6370 7520 3d20 252e   (%d) - cpu = %.
+00089bd0: 3366 202f 2025 2e33 6620 6d73 2c20 7761  3f / %.3f ms, wa
+00089be0: 6c6c 203d 2025 2e33 6620 2f20 252e 3366  ll = %.3f / %.3f
+00089bf0: 206d 735c 6e22 2c0a 2020 2020 2020 2020   ms\n",.        
+00089c00: 2020 2020 2020 2020 5f5f 6675 6e63 5f5f          __func__
+00089c10: 2c20 6367 7261 7068 2d3e 7065 7266 5f72  , cgraph->perf_r
+00089c20: 756e 732c 0a20 2020 2020 2020 2020 2020  uns,.           
+00089c30: 2020 2020 2028 646f 7562 6c65 2920 7065       (double) pe
+00089c40: 7266 5f63 7963 6c65 735f 6375 7220 2020  rf_cycles_cur   
+00089c50: 2020 202f 2028 646f 7562 6c65 2920 6767     / (double) gg
+00089c60: 6d6c 5f63 7963 6c65 735f 7065 725f 6d73  ml_cycles_per_ms
+00089c70: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00089c80: 2020 2020 2864 6f75 626c 6529 2063 6772      (double) cgr
+00089c90: 6170 682d 3e70 6572 665f 6379 636c 6573  aph->perf_cycles
+00089ca0: 2020 2f20 2864 6f75 626c 6529 2067 676d    / (double) ggm
+00089cb0: 6c5f 6379 636c 6573 5f70 6572 5f6d 7328  l_cycles_per_ms(
+00089cc0: 2920 2f20 2864 6f75 626c 6529 2063 6772  ) / (double) cgr
+00089cd0: 6170 682d 3e70 6572 665f 7275 6e73 2c0a  aph->perf_runs,.
+00089ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089cf0: 2864 6f75 626c 6529 2070 6572 665f 7469  (double) perf_ti
+00089d00: 6d65 5f75 735f 6375 7220 2020 2020 2f20  me_us_cur     / 
+00089d10: 3130 3030 2e30 2c0a 2020 2020 2020 2020  1000.0,.        
+00089d20: 2020 2020 2020 2020 2864 6f75 626c 6529          (double)
+00089d30: 2063 6772 6170 682d 3e70 6572 665f 7469   cgraph->perf_ti
+00089d40: 6d65 5f75 7320 2f20 3130 3030 2e30 202f  me_us / 1000.0 /
+00089d50: 2063 6772 6170 682d 3e70 6572 665f 7275   cgraph->perf_ru
+00089d60: 6e73 293b 0a20 2020 207d 0a7d 0a0a 766f  ns);.    }.}..vo
+00089d70: 6964 2067 676d 6c5f 6772 6170 685f 7265  id ggml_graph_re
+00089d80: 7365 7428 7374 7275 6374 2067 676d 6c5f  set(struct ggml_
+00089d90: 6367 7261 7068 202a 2063 6772 6170 6829  cgraph * cgraph)
+00089da0: 207b 0a20 2020 2066 6f72 2028 696e 7420   {.    for (int 
+00089db0: 6920 3d20 303b 2069 203c 2063 6772 6170  i = 0; i < cgrap
+00089dc0: 682d 3e6e 5f6e 6f64 6573 3b20 692b 2b29  h->n_nodes; i++)
+00089dd0: 207b 0a20 2020 2020 2020 2073 7472 7563   {.        struc
+00089de0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00089df0: 6772 6164 203d 2063 6772 6170 682d 3e67  grad = cgraph->g
+00089e00: 7261 6473 5b69 5d3b 0a0a 2020 2020 2020  rads[i];..      
+00089e10: 2020 6966 2028 6772 6164 2920 7b0a 2020    if (grad) {.  
+00089e20: 2020 2020 2020 2020 2020 6767 6d6c 5f73            ggml_s
+00089e30: 6574 5f7a 6572 6f28 6772 6164 293b 0a20  et_zero(grad);. 
+00089e40: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+00089e50: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+00089e60: 6e73 6f72 202a 2067 676d 6c5f 6772 6170  nsor * ggml_grap
+00089e70: 685f 6765 745f 7465 6e73 6f72 2873 7472  h_get_tensor(str
+00089e80: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+00089e90: 2a20 6367 7261 7068 2c20 636f 6e73 7420  * cgraph, const 
+00089ea0: 6368 6172 202a 206e 616d 6529 207b 0a20  char * name) {. 
+00089eb0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00089ec0: 303b 2069 203c 2063 6772 6170 682d 3e6e  0; i < cgraph->n
+00089ed0: 5f6c 6561 6673 3b20 692b 2b29 207b 0a20  _leafs; i++) {. 
+00089ee0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00089ef0: 6d6c 5f74 656e 736f 7220 2a20 6c65 6166  ml_tensor * leaf
+00089f00: 203d 2063 6772 6170 682d 3e6c 6561 6673   = cgraph->leafs
+00089f10: 5b69 5d3b 0a0a 2020 2020 2020 2020 6966  [i];..        if
+00089f20: 2028 7374 7263 6d70 286c 6561 662d 3e6e   (strcmp(leaf->n
+00089f30: 616d 652c 206e 616d 6529 203d 3d20 3029  ame, name) == 0)
+00089f40: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
+00089f50: 6574 7572 6e20 6c65 6166 3b0a 2020 2020  eturn leaf;.    
+00089f60: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+00089f70: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00089f80: 2069 203c 2063 6772 6170 682d 3e6e 5f6e   i < cgraph->n_n
+00089f90: 6f64 6573 3b20 692b 2b29 207b 0a20 2020  odes; i++) {.   
+00089fa0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00089fb0: 5f74 656e 736f 7220 2a20 6e6f 6465 203d  _tensor * node =
+00089fc0: 2063 6772 6170 682d 3e6e 6f64 6573 5b69   cgraph->nodes[i
+00089fd0: 5d3b 0a0a 2020 2020 2020 2020 6966 2028  ];..        if (
+00089fe0: 7374 7263 6d70 286e 6f64 652d 3e6e 616d  strcmp(node->nam
+00089ff0: 652c 206e 616d 6529 203d 3d20 3029 207b  e, name) == 0) {
+0008a000: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0008a010: 7572 6e20 6e6f 6465 3b0a 2020 2020 2020  urn node;.      
+0008a020: 2020 7d0a 2020 2020 7d0a 0a20 2020 2072    }.    }..    r
+0008a030: 6574 7572 6e20 4e55 4c4c 3b0a 7d0a 0a73  eturn NULL;.}..s
+0008a040: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0008a050: 6772 6170 685f 6578 706f 7274 5f6c 6561  graph_export_lea
+0008a060: 6628 636f 6e73 7420 7374 7275 6374 2067  f(const struct g
+0008a070: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
+0008a080: 736f 722c 2046 494c 4520 2a20 666f 7574  sor, FILE * fout
+0008a090: 2920 7b0a 2020 2020 636f 6e73 7420 696e  ) {.    const in
+0008a0a0: 7436 345f 7420 2a20 6e65 203d 2074 656e  t64_t * ne = ten
+0008a0b0: 736f 722d 3e6e 653b 0a20 2020 2063 6f6e  sor->ne;.    con
+0008a0c0: 7374 2073 697a 655f 7420 202a 206e 6220  st size_t  * nb 
+0008a0d0: 3d20 7465 6e73 6f72 2d3e 6e62 3b0a 0a20  = tensor->nb;.. 
+0008a0e0: 2020 2066 7072 696e 7466 2866 6f75 742c     fprintf(fout,
+0008a0f0: 2022 252d 3673 2025 2d31 3273 2025 3864   "%-6s %-12s %8d
+0008a100: 2025 2220 5052 4964 3634 2022 2025 2220   %" PRId64 " %" 
+0008a110: 5052 4964 3634 2022 2025 2220 5052 4964  PRId64 " %" PRId
+0008a120: 3634 2022 2025 2220 5052 4964 3634 2022  64 " %" PRId64 "
+0008a130: 2025 3136 7a75 2025 3136 7a75 2025 3136   %16zu %16zu %16
+0008a140: 7a75 2025 3136 7a75 2025 3136 7020 2533  zu %16zu %16p %3
+0008a150: 3273 5c6e 222c 0a20 2020 2020 2020 2020  2s\n",.         
+0008a160: 2020 2067 676d 6c5f 7479 7065 5f6e 616d     ggml_type_nam
+0008a170: 6528 7465 6e73 6f72 2d3e 7479 7065 292c  e(tensor->type),
+0008a180: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0008a190: 6c5f 6f70 5f6e 616d 6520 2028 7465 6e73  l_op_name  (tens
+0008a1a0: 6f72 2d3e 6f70 292c 0a20 2020 2020 2020  or->op),.       
+0008a1b0: 2020 2020 2074 656e 736f 722d 3e6e 5f64       tensor->n_d
+0008a1c0: 696d 732c 0a20 2020 2020 2020 2020 2020  ims,.           
+0008a1d0: 206e 655b 305d 2c20 6e65 5b31 5d2c 206e   ne[0], ne[1], n
+0008a1e0: 655b 325d 2c20 6e65 5b33 5d2c 0a20 2020  e[2], ne[3],.   
+0008a1f0: 2020 2020 2020 2020 206e 625b 305d 2c20           nb[0], 
+0008a200: 6e62 5b31 5d2c 206e 625b 325d 2c20 6e62  nb[1], nb[2], nb
+0008a210: 5b33 5d2c 0a20 2020 2020 2020 2020 2020  [3],.           
+0008a220: 2074 656e 736f 722d 3e64 6174 612c 0a20   tensor->data,. 
+0008a230: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0008a240: 722d 3e6e 616d 6529 3b0a 7d0a 0a73 7461  r->name);.}..sta
+0008a250: 7469 6320 766f 6964 2067 676d 6c5f 6772  tic void ggml_gr
+0008a260: 6170 685f 6578 706f 7274 5f6e 6f64 6528  aph_export_node(
+0008a270: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0008a280: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
+0008a290: 722c 2063 6f6e 7374 2063 6861 7220 2a20  r, const char * 
+0008a2a0: 6172 672c 2046 494c 4520 2a20 666f 7574  arg, FILE * fout
+0008a2b0: 2920 7b0a 2020 2020 636f 6e73 7420 696e  ) {.    const in
+0008a2c0: 7436 345f 7420 2a20 6e65 203d 2074 656e  t64_t * ne = ten
+0008a2d0: 736f 722d 3e6e 653b 0a20 2020 2063 6f6e  sor->ne;.    con
+0008a2e0: 7374 2073 697a 655f 7420 202a 206e 6220  st size_t  * nb 
+0008a2f0: 3d20 7465 6e73 6f72 2d3e 6e62 3b0a 0a20  = tensor->nb;.. 
+0008a300: 2020 2066 7072 696e 7466 2866 6f75 742c     fprintf(fout,
+0008a310: 2022 252d 3673 2025 2d36 7320 252d 3132   "%-6s %-6s %-12
+0008a320: 7320 2538 6420 2522 2050 5249 6436 3420  s %8d %" PRId64 
+0008a330: 2220 2522 2050 5249 6436 3420 2220 2522  " %" PRId64 " %"
+0008a340: 2050 5249 6436 3420 2220 2522 2050 5249   PRId64 " %" PRI
+0008a350: 6436 3420 2220 2531 367a 7520 2531 367a  d64 " %16zu %16z
+0008a360: 7520 2531 367a 7520 2531 367a 7520 2538  u %16zu %16zu %8
+0008a370: 6420 2531 3670 2025 3332 735c 6e22 2c0a  d %16p %32s\n",.
+0008a380: 2020 2020 2020 2020 2020 2020 6172 672c              arg,
+0008a390: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0008a3a0: 6c5f 7479 7065 5f6e 616d 6528 7465 6e73  l_type_name(tens
+0008a3b0: 6f72 2d3e 7479 7065 292c 0a20 2020 2020  or->type),.     
+0008a3c0: 2020 2020 2020 2067 676d 6c5f 6f70 5f6e         ggml_op_n
+0008a3d0: 616d 6520 2028 7465 6e73 6f72 2d3e 6f70  ame  (tensor->op
+0008a3e0: 292c 0a20 2020 2020 2020 2020 2020 2074  ),.            t
+0008a3f0: 656e 736f 722d 3e6e 5f64 696d 732c 0a20  ensor->n_dims,. 
+0008a400: 2020 2020 2020 2020 2020 206e 655b 305d             ne[0]
+0008a410: 2c20 6e65 5b31 5d2c 206e 655b 325d 2c20  , ne[1], ne[2], 
+0008a420: 6e65 5b33 5d2c 0a20 2020 2020 2020 2020  ne[3],.         
+0008a430: 2020 206e 625b 305d 2c20 6e62 5b31 5d2c     nb[0], nb[1],
+0008a440: 206e 625b 325d 2c20 6e62 5b33 5d2c 0a20   nb[2], nb[3],. 
+0008a450: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0008a460: 722d 3e6e 5f74 6173 6b73 2c0a 2020 2020  r->n_tasks,.    
+0008a470: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
+0008a480: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+0008a490: 2020 7465 6e73 6f72 2d3e 6e61 6d65 293b    tensor->name);
+0008a4a0: 0a7d 0a0a 766f 6964 2067 676d 6c5f 6772  .}..void ggml_gr
+0008a4b0: 6170 685f 6578 706f 7274 2863 6f6e 7374  aph_export(const
+0008a4c0: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+0008a4d0: 6170 6820 2a20 6367 7261 7068 2c20 636f  aph * cgraph, co
+0008a4e0: 6e73 7420 6368 6172 202a 2066 6e61 6d65  nst char * fname
+0008a4f0: 2920 7b0a 2020 2020 2f2f 6173 7365 7274  ) {.    //assert
+0008a500: 2863 6772 6170 682d 3e77 6f72 6b20 2020  (cgraph->work   
+0008a510: 2020 203d 3d20 4e55 4c4c 293b 0a20 2020     == NULL);.   
+0008a520: 202f 2f61 7373 6572 7428 6367 7261 7068   //assert(cgraph
+0008a530: 2d3e 776f 726b 5f73 697a 6520 3d3d 2030  ->work_size == 0
+0008a540: 293b 0a0a 2020 2020 7569 6e74 3634 5f74  );..    uint64_t
+0008a550: 2073 697a 655f 6576 616c 203d 2030 3b0a   size_eval = 0;.
+0008a560: 0a20 2020 202f 2f20 636f 6d70 7574 6520  .    // compute 
+0008a570: 7369 7a65 206f 6620 696e 7465 726d 6564  size of intermed
+0008a580: 6961 7465 2072 6573 756c 7473 0a20 2020  iate results.   
+0008a590: 202f 2f20 544f 444f 3a20 646f 6573 206e   // TODO: does n
+0008a5a0: 6f74 2074 616b 6520 696e 746f 2061 6363  ot take into acc
+0008a5b0: 6f75 6e74 2073 6372 6174 6368 2062 7566  ount scratch buf
+0008a5c0: 6665 7273 2021 2121 210a 2020 2020 666f  fers !!!!.    fo
+0008a5d0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+0008a5e0: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
+0008a5f0: 733b 202b 2b69 2920 7b0a 2020 2020 2020  s; ++i) {.      
+0008a600: 2020 7369 7a65 5f65 7661 6c20 2b3d 2067    size_eval += g
+0008a610: 676d 6c5f 6e62 7974 6573 2863 6772 6170  gml_nbytes(cgrap
+0008a620: 682d 3e6e 6f64 6573 5b69 5d29 3b0a 2020  h->nodes[i]);.  
+0008a630: 2020 7d0a 0a20 2020 202f 2f20 7072 696e    }..    // prin
+0008a640: 740a 2020 2020 7b0a 2020 2020 2020 2020  t.    {.        
+0008a650: 4649 4c45 202a 2066 6f75 7420 3d20 7374  FILE * fout = st
+0008a660: 646f 7574 3b0a 0a20 2020 2020 2020 2066  dout;..        f
+0008a670: 7072 696e 7466 2866 6f75 742c 2022 5c6e  printf(fout, "\n
+0008a680: 2229 3b0a 2020 2020 2020 2020 6670 7269  ");.        fpri
+0008a690: 6e74 6628 666f 7574 2c20 2225 2d31 3673  ntf(fout, "%-16s
+0008a6a0: 2025 3878 5c6e 222c 2022 6d61 6769 6322   %8x\n", "magic"
+0008a6b0: 2c20 2020 2020 2020 2047 474d 4c5f 4649  ,        GGML_FI
+0008a6c0: 4c45 5f4d 4147 4943 293b 0a20 2020 2020  LE_MAGIC);.     
+0008a6d0: 2020 2066 7072 696e 7466 2866 6f75 742c     fprintf(fout,
+0008a6e0: 2022 252d 3136 7320 2538 645c 6e22 2c20   "%-16s %8d\n", 
+0008a6f0: 2276 6572 7369 6f6e 222c 2020 2020 2020  "version",      
+0008a700: 4747 4d4c 5f46 494c 455f 5645 5253 494f  GGML_FILE_VERSIO
+0008a710: 4e29 3b0a 2020 2020 2020 2020 6670 7269  N);.        fpri
+0008a720: 6e74 6628 666f 7574 2c20 2225 2d31 3673  ntf(fout, "%-16s
+0008a730: 2025 3864 5c6e 222c 2022 6c65 6166 7322   %8d\n", "leafs"
+0008a740: 2c20 2020 2020 2020 2063 6772 6170 682d  ,        cgraph-
+0008a750: 3e6e 5f6c 6561 6673 293b 0a20 2020 2020  >n_leafs);.     
+0008a760: 2020 2066 7072 696e 7466 2866 6f75 742c     fprintf(fout,
+0008a770: 2022 252d 3136 7320 2538 645c 6e22 2c20   "%-16s %8d\n", 
+0008a780: 226e 6f64 6573 222c 2020 2020 2020 2020  "nodes",        
+0008a790: 6367 7261 7068 2d3e 6e5f 6e6f 6465 7329  cgraph->n_nodes)
+0008a7a0: 3b0a 2020 2020 2020 2020 6670 7269 6e74  ;.        fprint
+0008a7b0: 6628 666f 7574 2c20 2225 2d31 3673 2025  f(fout, "%-16s %
+0008a7c0: 2220 5052 4975 3634 2022 5c6e 222c 2022  " PRIu64 "\n", "
+0008a7d0: 6576 616c 222c 2073 697a 655f 6576 616c  eval", size_eval
+0008a7e0: 293b 0a0a 2020 2020 2020 2020 2f2f 2068  );..        // h
+0008a7f0: 6561 6465 720a 2020 2020 2020 2020 6670  eader.        fp
+0008a800: 7269 6e74 6628 666f 7574 2c20 225c 6e22  rintf(fout, "\n"
+0008a810: 293b 0a20 2020 2020 2020 2066 7072 696e  );.        fprin
+0008a820: 7466 2866 6f75 742c 2022 252d 3673 2025  tf(fout, "%-6s %
+0008a830: 2d31 3273 2025 3873 2025 3873 2025 3873  -12s %8s %8s %8s
+0008a840: 2025 3873 2025 3873 2025 3136 7320 2531   %8s %8s %16s %1
+0008a850: 3673 2025 3136 7320 2531 3673 2025 3136  6s %16s %16s %16
+0008a860: 7320 2531 3673 5c6e 222c 0a20 2020 2020  s %16s\n",.     
+0008a870: 2020 2020 2020 2020 2020 2022 5459 5045             "TYPE
+0008a880: 222c 2022 4f50 222c 2022 4e44 494d 5322  ", "OP", "NDIMS"
+0008a890: 2c20 224e 4530 222c 2022 4e45 3122 2c20  , "NE0", "NE1", 
+0008a8a0: 224e 4532 222c 2022 4e45 3322 2c20 224e  "NE2", "NE3", "N
+0008a8b0: 4230 222c 2022 4e42 3122 2c20 224e 4232  B0", "NB1", "NB2
+0008a8c0: 222c 2022 4e42 3322 2c20 2244 4154 4122  ", "NB3", "DATA"
+0008a8d0: 2c20 224e 414d 4522 293b 0a0a 2020 2020  , "NAME");..    
+0008a8e0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+0008a8f0: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
+0008a900: 6e5f 6c65 6166 733b 202b 2b69 2920 7b0a  n_leafs; ++i) {.
+0008a910: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0008a920: 5f67 7261 7068 5f65 7870 6f72 745f 6c65  _graph_export_le
+0008a930: 6166 2863 6772 6170 682d 3e6c 6561 6673  af(cgraph->leafs
+0008a940: 5b69 5d2c 2066 6f75 7429 3b0a 0a20 2020  [i], fout);..   
+0008a950: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0008a960: 5345 5254 2863 6772 6170 682d 3e6c 6561  SERT(cgraph->lea
+0008a970: 6673 5b69 5d2d 3e6f 7020 2020 3d3d 2047  fs[i]->op   == G
+0008a980: 474d 4c5f 4f50 5f4e 4f4e 4529 3b0a 2020  GML_OP_NONE);.  
+0008a990: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0008a9a0: 5353 4552 5428 6367 7261 7068 2d3e 6c65  SSERT(cgraph->le
+0008a9b0: 6166 735b 695d 2d3e 7372 6330 203d 3d20  afs[i]->src0 == 
+0008a9c0: 4e55 4c4c 293b 0a20 2020 2020 2020 2020  NULL);.         
+0008a9d0: 2020 2047 474d 4c5f 4153 5345 5254 2863     GGML_ASSERT(c
+0008a9e0: 6772 6170 682d 3e6c 6561 6673 5b69 5d2d  graph->leafs[i]-
+0008a9f0: 3e73 7263 3120 3d3d 204e 554c 4c29 3b0a  >src1 == NULL);.
+0008aa00: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0008aa10: 2020 202f 2f20 6865 6164 6572 0a20 2020     // header.   
+0008aa20: 2020 2020 2066 7072 696e 7466 2866 6f75       fprintf(fou
+0008aa30: 742c 2022 5c6e 2229 3b0a 2020 2020 2020  t, "\n");.      
+0008aa40: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
+0008aa50: 2225 2d36 7320 252d 3673 2025 2d31 3273  "%-6s %-6s %-12s
+0008aa60: 2025 3873 2025 3873 2025 3873 2025 3873   %8s %8s %8s %8s
+0008aa70: 2025 3873 2025 3136 7320 2531 3673 2025   %8s %16s %16s %
+0008aa80: 3136 7320 2531 3673 2025 3873 2025 3136  16s %16s %8s %16
+0008aa90: 7320 2531 3673 5c6e 222c 0a20 2020 2020  s %16s\n",.     
+0008aaa0: 2020 2020 2020 2020 2020 2022 4152 4722             "ARG"
+0008aab0: 2c20 2254 5950 4522 2c20 224f 5022 2c20  , "TYPE", "OP", 
+0008aac0: 224e 4449 4d53 222c 2022 4e45 3022 2c20  "NDIMS", "NE0", 
+0008aad0: 224e 4531 222c 2022 4e45 3222 2c20 224e  "NE1", "NE2", "N
+0008aae0: 4533 222c 2022 4e42 3022 2c20 224e 4231  E3", "NB0", "NB1
+0008aaf0: 222c 2022 4e42 3222 2c20 224e 4233 222c  ", "NB2", "NB3",
+0008ab00: 2022 4e54 4153 4b53 222c 2022 4441 5441   "NTASKS", "DATA
+0008ab10: 222c 2022 4e41 4d45 2229 3b0a 0a20 2020  ", "NAME");..   
+0008ab20: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+0008ab30: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
+0008ab40: 3e6e 5f6e 6f64 6573 3b20 2b2b 6929 207b  >n_nodes; ++i) {
+0008ab50: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0008ab60: 6c5f 6772 6170 685f 6578 706f 7274 5f6e  l_graph_export_n
+0008ab70: 6f64 6528 6367 7261 7068 2d3e 6e6f 6465  ode(cgraph->node
+0008ab80: 735b 695d 2c20 2244 5354 222c 2066 6f75  s[i], "DST", fou
+0008ab90: 7429 3b0a 0a20 2020 2020 2020 2020 2020  t);..           
+0008aba0: 2069 6620 2863 6772 6170 682d 3e6e 6f64   if (cgraph->nod
+0008abb0: 6573 5b69 5d2d 3e73 7263 3029 207b 0a20  es[i]->src0) {. 
+0008abc0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0008abd0: 676d 6c5f 6772 6170 685f 6578 706f 7274  gml_graph_export
+0008abe0: 5f6e 6f64 6528 6367 7261 7068 2d3e 6e6f  _node(cgraph->no
+0008abf0: 6465 735b 695d 2d3e 7372 6330 2c20 2253  des[i]->src0, "S
+0008ac00: 5243 3022 2c20 666f 7574 293b 0a20 2020  RC0", fout);.   
+0008ac10: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+0008ac20: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
+0008ac30: 7068 2d3e 6e6f 6465 735b 695d 2d3e 7372  ph->nodes[i]->sr
+0008ac40: 6331 2920 7b0a 2020 2020 2020 2020 2020  c1) {.          
+0008ac50: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
+0008ac60: 5f65 7870 6f72 745f 6e6f 6465 2863 6772  _export_node(cgr
+0008ac70: 6170 682d 3e6e 6f64 6573 5b69 5d2d 3e73  aph->nodes[i]->s
+0008ac80: 7263 312c 2022 5352 4331 222c 2066 6f75  rc1, "SRC1", fou
+0008ac90: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+0008aca0: 7d0a 0a20 2020 2020 2020 2020 2020 2066  }..            f
+0008acb0: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
+0008acc0: 203c 2047 474d 4c5f 4d41 585f 4f50 543b   < GGML_MAX_OPT;
+0008acd0: 202b 2b6a 2920 7b0a 2020 2020 2020 2020   ++j) {.        
+0008ace0: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
+0008acf0: 7068 2d3e 6e6f 6465 735b 695d 2d3e 6f70  ph->nodes[i]->op
+0008ad00: 745b 6a5d 2920 7b0a 2020 2020 2020 2020  t[j]) {.        
+0008ad10: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0008ad20: 5f67 7261 7068 5f65 7870 6f72 745f 6e6f  _graph_export_no
+0008ad30: 6465 2863 6772 6170 682d 3e6e 6f64 6573  de(cgraph->nodes
+0008ad40: 5b69 5d2d 3e6f 7074 5b6a 5d2c 2022 4f50  [i]->opt[j], "OP
+0008ad50: 5422 2c20 666f 7574 293b 0a20 2020 2020  T", fout);.     
+0008ad60: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0008ad70: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+0008ad80: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
+0008ad90: 666f 7574 2c20 225c 6e22 293b 0a20 2020  fout, "\n");.   
+0008ada0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0008adb0: 6670 7269 6e74 6628 666f 7574 2c20 225c  fprintf(fout, "\
+0008adc0: 6e22 293b 0a20 2020 207d 0a0a 2020 2020  n");.    }..    
+0008add0: 2f2f 2077 7269 7465 2062 696e 6172 7920  // write binary 
+0008ade0: 6461 7461 0a20 2020 207b 0a20 2020 2020  data.    {.     
+0008adf0: 2020 2046 494c 4520 2a20 666f 7574 203d     FILE * fout =
+0008ae00: 2066 6f70 656e 2866 6e61 6d65 2c20 2277   fopen(fname, "w
+0008ae10: 6222 293b 0a0a 2020 2020 2020 2020 6966  b");..        if
+0008ae20: 2028 2166 6f75 7429 207b 0a20 2020 2020   (!fout) {.     
+0008ae30: 2020 2020 2020 2066 7072 696e 7466 2873         fprintf(s
+0008ae40: 7464 6572 722c 2022 2573 3a20 6661 696c  tderr, "%s: fail
+0008ae50: 6564 2074 6f20 6f70 656e 2025 735c 6e22  ed to open %s\n"
+0008ae60: 2c20 5f5f 6675 6e63 5f5f 2c20 666e 616d  , __func__, fnam
+0008ae70: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0008ae80: 7265 7475 726e 3b0a 2020 2020 2020 2020  return;.        
+0008ae90: 7d0a 0a20 2020 2020 2020 202f 2f20 6865  }..        // he
+0008aea0: 6164 6572 0a20 2020 2020 2020 207b 0a20  ader.        {. 
+0008aeb0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0008aec0: 2075 696e 7433 325f 7420 6d61 6769 6320   uint32_t magic 
+0008aed0: 2020 3d20 4747 4d4c 5f46 494c 455f 4d41    = GGML_FILE_MA
+0008aee0: 4749 433b 0a20 2020 2020 2020 2020 2020  GIC;.           
+0008aef0: 2063 6f6e 7374 2075 696e 7433 325f 7420   const uint32_t 
+0008af00: 7665 7273 696f 6e20 3d20 4747 4d4c 5f46  version = GGML_F
+0008af10: 494c 455f 5645 5253 494f 4e3b 0a20 2020  ILE_VERSION;.   
+0008af20: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+0008af30: 696e 7433 325f 7420 6e5f 6c65 6166 7320  int32_t n_leafs 
+0008af40: 3d20 6367 7261 7068 2d3e 6e5f 6c65 6166  = cgraph->n_leaf
+0008af50: 733b 0a20 2020 2020 2020 2020 2020 2063  s;.            c
+0008af60: 6f6e 7374 2075 696e 7433 325f 7420 6e6f  onst uint32_t no
+0008af70: 6465 7320 2020 3d20 6367 7261 7068 2d3e  des   = cgraph->
+0008af80: 6e5f 6e6f 6465 733b 0a0a 2020 2020 2020  n_nodes;..      
+0008af90: 2020 2020 2020 6677 7269 7465 2826 6d61        fwrite(&ma
+0008afa0: 6769 632c 2020 2020 2073 697a 656f 6628  gic,     sizeof(
+0008afb0: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
+0008afc0: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
+0008afd0: 2066 7772 6974 6528 2676 6572 7369 6f6e   fwrite(&version
+0008afe0: 2c20 2020 7369 7a65 6f66 2875 696e 7433  ,   sizeof(uint3
+0008aff0: 325f 7429 2c20 312c 2066 6f75 7429 3b0a  2_t), 1, fout);.
+0008b000: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
+0008b010: 7465 2826 6e5f 6c65 6166 732c 2020 2073  te(&n_leafs,   s
+0008b020: 697a 656f 6628 7569 6e74 3332 5f74 292c  izeof(uint32_t),
+0008b030: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
+0008b040: 2020 2020 2020 2066 7772 6974 6528 266e         fwrite(&n
+0008b050: 6f64 6573 2c20 2020 2020 7369 7a65 6f66  odes,     sizeof
+0008b060: 2875 696e 7433 325f 7429 2c20 312c 2066  (uint32_t), 1, f
+0008b070: 6f75 7429 3b0a 2020 2020 2020 2020 2020  out);.          
+0008b080: 2020 6677 7269 7465 2826 7369 7a65 5f65    fwrite(&size_e
+0008b090: 7661 6c2c 2073 697a 656f 6628 7569 6e74  val, sizeof(uint
+0008b0a0: 3634 5f74 292c 2031 2c20 666f 7574 293b  64_t), 1, fout);
+0008b0b0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0008b0c0: 2020 2020 2f2f 206c 6561 6673 0a20 2020      // leafs.   
+0008b0d0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0008b0e0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+0008b0f0: 303b 2069 203c 2063 6772 6170 682d 3e6e  0; i < cgraph->n
+0008b100: 5f6c 6561 6673 3b20 2b2b 6929 207b 0a20  _leafs; ++i) {. 
+0008b110: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0008b120: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0008b130: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
+0008b140: 203d 2063 6772 6170 682d 3e6c 6561 6673   = cgraph->leafs
+0008b150: 5b69 5d3b 0a0a 2020 2020 2020 2020 2020  [i];..          
+0008b160: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+0008b170: 3332 5f74 2074 7970 6520 2020 3d20 7465  32_t type   = te
+0008b180: 6e73 6f72 2d3e 7479 7065 3b0a 2020 2020  nsor->type;.    
+0008b190: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0008b1a0: 7420 7569 6e74 3332 5f74 206f 7020 2020  t uint32_t op   
+0008b1b0: 2020 3d20 7465 6e73 6f72 2d3e 6f70 3b0a    = tensor->op;.
+0008b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008b1d0: 636f 6e73 7420 7569 6e74 3332 5f74 206e  const uint32_t n
+0008b1e0: 5f64 696d 7320 3d20 7465 6e73 6f72 2d3e  _dims = tensor->
+0008b1f0: 6e5f 6469 6d73 3b0a 0a20 2020 2020 2020  n_dims;..       
+0008b200: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
+0008b210: 2674 7970 652c 2020 2073 697a 656f 6628  &type,   sizeof(
+0008b220: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
+0008b230: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
+0008b240: 2020 2020 2066 7772 6974 6528 266f 702c       fwrite(&op,
+0008b250: 2020 2020 2073 697a 656f 6628 7569 6e74       sizeof(uint
+0008b260: 3332 5f74 292c 2031 2c20 666f 7574 293b  32_t), 1, fout);
+0008b270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008b280: 2066 7772 6974 6528 266e 5f64 696d 732c   fwrite(&n_dims,
+0008b290: 2073 697a 656f 6628 7569 6e74 3332 5f74   sizeof(uint32_t
+0008b2a0: 292c 2031 2c20 666f 7574 293b 0a0a 2020  ), 1, fout);..  
+0008b2b0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0008b2c0: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+0008b2d0: 3c20 4747 4d4c 5f4d 4158 5f44 494d 533b  < GGML_MAX_DIMS;
+0008b2e0: 202b 2b6a 2920 7b0a 2020 2020 2020 2020   ++j) {.        
+0008b2f0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0008b300: 7420 7569 6e74 3634 5f74 206e 6520 3d20  t uint64_t ne = 
+0008b310: 7465 6e73 6f72 2d3e 6e65 5b6a 5d3b 0a20  tensor->ne[j];. 
+0008b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008b330: 2020 2063 6f6e 7374 2075 696e 7436 345f     const uint64_
+0008b340: 7420 6e62 203d 2074 656e 736f 722d 3e6e  t nb = tensor->n
+0008b350: 625b 6a5d 3b0a 0a20 2020 2020 2020 2020  b[j];..         
+0008b360: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
+0008b370: 6528 266e 652c 2073 697a 656f 6628 7569  e(&ne, sizeof(ui
+0008b380: 6e74 3634 5f74 292c 2031 2c20 666f 7574  nt64_t), 1, fout
+0008b390: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0008b3a0: 2020 2020 2020 2066 7772 6974 6528 266e         fwrite(&n
+0008b3b0: 622c 2073 697a 656f 6628 7569 6e74 3634  b, sizeof(uint64
+0008b3c0: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
+0008b3d0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0008b3e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0008b3f0: 2020 2f2f 2073 746f 7265 2074 6865 2070    // store the p
+0008b400: 6f69 6e74 6572 2061 6464 7265 7373 0a20  ointer address. 
+0008b410: 2020 2020 2020 2020 2020 2020 2020 207b                 {
 0008b420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008b430: 2020 2020 2066 7772 6974 6528 7465 6e73       fwrite(tens
-0008b440: 6f72 2d3e 6461 7461 2c20 7369 7a65 6f66  or->data, sizeof
-0008b450: 2863 6861 7229 2c20 7369 7a65 2c20 666f  (char), size, fo
-0008b460: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-0008b470: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0008b480: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
-0008b490: 2020 2020 2020 2020 2f2f 206e 6f64 6573          // nodes
-0008b4a0: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-0008b4b0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0008b4c0: 6920 3d20 303b 2069 203c 2063 6772 6170  i = 0; i < cgrap
-0008b4d0: 682d 3e6e 5f6e 6f64 6573 3b20 2b2b 6929  h->n_nodes; ++i)
-0008b4e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008b4f0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0008b500: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
-0008b510: 6e73 6f72 203d 2063 6772 6170 682d 3e6e  nsor = cgraph->n
-0008b520: 6f64 6573 5b69 5d3b 0a0a 2020 2020 2020  odes[i];..      
-0008b530: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0008b540: 7569 6e74 3332 5f74 2074 7970 6520 2020  uint32_t type   
-0008b550: 3d20 7465 6e73 6f72 2d3e 7479 7065 3b0a  = tensor->type;.
-0008b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b570: 636f 6e73 7420 7569 6e74 3332 5f74 206f  const uint32_t o
-0008b580: 7020 2020 2020 3d20 7465 6e73 6f72 2d3e  p     = tensor->
-0008b590: 6f70 3b0a 2020 2020 2020 2020 2020 2020  op;.            
-0008b5a0: 2020 2020 636f 6e73 7420 7569 6e74 3332      const uint32
-0008b5b0: 5f74 206e 5f64 696d 7320 3d20 7465 6e73  _t n_dims = tens
-0008b5c0: 6f72 2d3e 6e5f 6469 6d73 3b0a 0a20 2020  or->n_dims;..   
-0008b5d0: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
-0008b5e0: 6974 6528 2674 7970 652c 2020 2073 697a  ite(&type,   siz
-0008b5f0: 656f 6628 7569 6e74 3332 5f74 292c 2031  eof(uint32_t), 1
-0008b600: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
-0008b610: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
-0008b620: 266f 702c 2020 2020 2073 697a 656f 6628  &op,     sizeof(
-0008b630: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
-0008b640: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-0008b650: 2020 2020 2066 7772 6974 6528 266e 5f64       fwrite(&n_d
-0008b660: 696d 732c 2073 697a 656f 6628 7569 6e74  ims, sizeof(uint
-0008b670: 3332 5f74 292c 2031 2c20 666f 7574 293b  32_t), 1, fout);
-0008b680: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0008b690: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
-0008b6a0: 3b20 6a20 3c20 4747 4d4c 5f4d 4158 5f44  ; j < GGML_MAX_D
-0008b6b0: 494d 533b 202b 2b6a 2920 7b0a 2020 2020  IMS; ++j) {.    
-0008b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b6d0: 636f 6e73 7420 7569 6e74 3634 5f74 206e  const uint64_t n
-0008b6e0: 6520 3d20 7465 6e73 6f72 2d3e 6e65 5b6a  e = tensor->ne[j
-0008b6f0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0008b700: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-0008b710: 7436 345f 7420 6e62 203d 2074 656e 736f  t64_t nb = tenso
-0008b720: 722d 3e6e 625b 6a5d 3b0a 0a20 2020 2020  r->nb[j];..     
-0008b730: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0008b740: 7772 6974 6528 266e 652c 2073 697a 656f  write(&ne, sizeo
-0008b750: 6628 7569 6e74 3634 5f74 292c 2031 2c20  f(uint64_t), 1, 
-0008b760: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-0008b770: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-0008b780: 6528 266e 622c 2073 697a 656f 6628 7569  e(&nb, sizeof(ui
-0008b790: 6e74 3634 5f74 292c 2031 2c20 666f 7574  nt64_t), 1, fout
-0008b7a0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008b7b0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0008b7c0: 2020 2020 2020 2f2f 2073 746f 7265 2074        // store t
-0008b7d0: 6865 2070 6f69 6e74 6572 2061 6464 7265  he pointer addre
-0008b7e0: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
-0008b7f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0008b800: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
-0008b810: 696e 7436 345f 7420 7074 7220 3d20 2875  int64_t ptr = (u
-0008b820: 696e 7436 345f 7429 2074 656e 736f 722d  int64_t) tensor-
-0008b830: 3e64 6174 613b 0a0a 2020 2020 2020 2020  >data;..        
-0008b840: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
-0008b850: 7465 2826 7074 722c 2073 697a 656f 6628  te(&ptr, sizeof(
-0008b860: 7569 6e74 3634 5f74 292c 2031 2c20 666f  uint64_t), 1, fo
-0008b870: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-0008b880: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008b890: 2020 2020 2020 2020 6677 7269 7465 2874          fwrite(t
-0008b8a0: 656e 736f 722d 3e6e 616d 652c 2073 697a  ensor->name, siz
-0008b8b0: 656f 6628 6368 6172 292c 2047 474d 4c5f  eof(char), GGML_
-0008b8c0: 4d41 585f 4e41 4d45 2c20 666f 7574 293b  MAX_NAME, fout);
-0008b8d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0008b8e0: 2020 2f2f 206f 7574 7075 7420 7468 6520    // output the 
-0008b8f0: 6f70 2061 7267 756d 656e 7473 0a20 2020  op arguments.   
-0008b900: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-0008b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b920: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0008b930: 656e 736f 7220 2a20 6172 6773 5b32 202b  ensor * args[2 +
-0008b940: 2047 474d 4c5f 4d41 585f 4f50 545d 203d   GGML_MAX_OPT] =
-0008b950: 207b 204e 554c 4c20 7d3b 0a0a 2020 2020   { NULL };..    
-0008b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b970: 6172 6773 5b30 5d20 3d20 7465 6e73 6f72  args[0] = tensor
-0008b980: 2d3e 7372 6330 3b0a 2020 2020 2020 2020  ->src0;.        
-0008b990: 2020 2020 2020 2020 2020 2020 6172 6773              args
-0008b9a0: 5b31 5d20 3d20 7465 6e73 6f72 2d3e 7372  [1] = tensor->sr
-0008b9b0: 6331 3b0a 0a20 2020 2020 2020 2020 2020  c1;..           
-0008b9c0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0008b9d0: 7420 6a20 3d20 303b 206a 203c 2047 474d  t j = 0; j < GGM
-0008b9e0: 4c5f 4d41 585f 4f50 543b 202b 2b6a 2920  L_MAX_OPT; ++j) 
-0008b9f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0008ba00: 2020 2020 2020 2020 2020 6172 6773 5b32            args[2
-0008ba10: 202b 206a 5d20 3d20 7465 6e73 6f72 2d3e   + j] = tensor->
-0008ba20: 6f70 745b 6a5d 3b0a 2020 2020 2020 2020  opt[j];.        
-0008ba30: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-0008ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ba50: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-0008ba60: 303b 206a 203c 2032 202b 2047 474d 4c5f  0; j < 2 + GGML_
-0008ba70: 4d41 585f 4f50 543b 202b 2b6a 2920 7b0a  MAX_OPT; ++j) {.
-0008ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ba90: 2020 2020 2020 2020 6966 2028 6172 6773          if (args
-0008baa0: 5b6a 5d29 207b 0a20 2020 2020 2020 2020  [j]) {.         
-0008bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bac0: 2020 2069 6e74 3332 5f74 2069 6478 203d     int32_t idx =
-0008bad0: 202d 313b 0a0a 2020 2020 2020 2020 2020   -1;..          
+0008b430: 2020 2020 2063 6f6e 7374 2075 696e 7436       const uint6
+0008b440: 345f 7420 7074 7220 3d20 2875 696e 7436  4_t ptr = (uint6
+0008b450: 345f 7429 2074 656e 736f 722d 3e64 6174  4_t) tensor->dat
+0008b460: 613b 0a0a 2020 2020 2020 2020 2020 2020  a;..            
+0008b470: 2020 2020 2020 2020 6677 7269 7465 2826          fwrite(&
+0008b480: 7074 722c 2073 697a 656f 6628 7569 6e74  ptr, sizeof(uint
+0008b490: 3634 5f74 292c 2031 2c20 666f 7574 293b  64_t), 1, fout);
+0008b4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008b4b0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+0008b4c0: 2020 2020 6677 7269 7465 2874 656e 736f      fwrite(tenso
+0008b4d0: 722d 3e6e 616d 652c 2073 697a 656f 6628  r->name, sizeof(
+0008b4e0: 6368 6172 292c 2047 474d 4c5f 4d41 585f  char), GGML_MAX_
+0008b4f0: 4e41 4d45 2c20 666f 7574 293b 0a0a 2020  NAME, fout);..  
+0008b500: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0008b510: 2064 756d 7020 7468 6520 6461 7461 0a20   dump the data. 
+0008b520: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0008b530: 2f20 544f 444f 3a20 7061 6420 7468 6973  / TODO: pad this
+0008b540: 2074 6f20 3332 2062 7974 6520 626f 756e   to 32 byte boun
+0008b550: 6461 7279 0a20 2020 2020 2020 2020 2020  dary.           
+0008b560: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0008b570: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0008b580: 2073 697a 655f 7420 7369 7a65 203d 2067   size_t size = g
+0008b590: 676d 6c5f 6e62 7974 6573 2874 656e 736f  gml_nbytes(tenso
+0008b5a0: 7229 3b0a 0a20 2020 2020 2020 2020 2020  r);..           
+0008b5b0: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
+0008b5c0: 7465 6e73 6f72 2d3e 6461 7461 2c20 7369  tensor->data, si
+0008b5d0: 7a65 6f66 2863 6861 7229 2c20 7369 7a65  zeof(char), size
+0008b5e0: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
+0008b5f0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0008b600: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0008b610: 207d 0a0a 2020 2020 2020 2020 2f2f 206e   }..        // n
+0008b620: 6f64 6573 0a20 2020 2020 2020 207b 0a20  odes.        {. 
+0008b630: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0008b640: 696e 7420 6920 3d20 303b 2069 203c 2063  int i = 0; i < c
+0008b650: 6772 6170 682d 3e6e 5f6e 6f64 6573 3b20  graph->n_nodes; 
+0008b660: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
+0008b670: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0008b680: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0008b690: 2a20 7465 6e73 6f72 203d 2063 6772 6170  * tensor = cgrap
+0008b6a0: 682d 3e6e 6f64 6573 5b69 5d3b 0a0a 2020  h->nodes[i];..  
+0008b6b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0008b6c0: 6e73 7420 7569 6e74 3332 5f74 2074 7970  nst uint32_t typ
+0008b6d0: 6520 2020 3d20 7465 6e73 6f72 2d3e 7479  e   = tensor->ty
+0008b6e0: 7065 3b0a 2020 2020 2020 2020 2020 2020  pe;.            
+0008b6f0: 2020 2020 636f 6e73 7420 7569 6e74 3332      const uint32
+0008b700: 5f74 206f 7020 2020 2020 3d20 7465 6e73  _t op     = tens
+0008b710: 6f72 2d3e 6f70 3b0a 2020 2020 2020 2020  or->op;.        
+0008b720: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+0008b730: 6e74 3332 5f74 206e 5f64 696d 7320 3d20  nt32_t n_dims = 
+0008b740: 7465 6e73 6f72 2d3e 6e5f 6469 6d73 3b0a  tensor->n_dims;.
+0008b750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008b760: 2066 7772 6974 6528 2674 7970 652c 2020   fwrite(&type,  
+0008b770: 2073 697a 656f 6628 7569 6e74 3332 5f74   sizeof(uint32_t
+0008b780: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
+0008b790: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
+0008b7a0: 6974 6528 266f 702c 2020 2020 2073 697a  ite(&op,     siz
+0008b7b0: 656f 6628 7569 6e74 3332 5f74 292c 2031  eof(uint32_t), 1
+0008b7c0: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
+0008b7d0: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
+0008b7e0: 266e 5f64 696d 732c 2073 697a 656f 6628  &n_dims, sizeof(
+0008b7f0: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
+0008b800: 7574 293b 0a0a 2020 2020 2020 2020 2020  ut);..          
+0008b810: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+0008b820: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f4d   = 0; j < GGML_M
+0008b830: 4158 5f44 494d 533b 202b 2b6a 2920 7b0a  AX_DIMS; ++j) {.
+0008b840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008b850: 2020 2020 636f 6e73 7420 7569 6e74 3634      const uint64
+0008b860: 5f74 206e 6520 3d20 7465 6e73 6f72 2d3e  _t ne = tensor->
+0008b870: 6e65 5b6a 5d3b 0a20 2020 2020 2020 2020  ne[j];.         
+0008b880: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0008b890: 2075 696e 7436 345f 7420 6e62 203d 2074   uint64_t nb = t
+0008b8a0: 656e 736f 722d 3e6e 625b 6a5d 3b0a 0a20  ensor->nb[j];.. 
+0008b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008b8c0: 2020 2066 7772 6974 6528 266e 652c 2073     fwrite(&ne, s
+0008b8d0: 697a 656f 6628 7569 6e74 3634 5f74 292c  izeof(uint64_t),
+0008b8e0: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
+0008b8f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0008b900: 7772 6974 6528 266e 622c 2073 697a 656f  write(&nb, sizeo
+0008b910: 6628 7569 6e74 3634 5f74 292c 2031 2c20  f(uint64_t), 1, 
+0008b920: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
+0008b930: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0008b940: 2020 2020 2020 2020 2020 2f2f 2073 746f            // sto
+0008b950: 7265 2074 6865 2070 6f69 6e74 6572 2061  re the pointer a
+0008b960: 6464 7265 7373 0a20 2020 2020 2020 2020  ddress.         
+0008b970: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0008b980: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0008b990: 7374 2075 696e 7436 345f 7420 7074 7220  st uint64_t ptr 
+0008b9a0: 3d20 2875 696e 7436 345f 7429 2074 656e  = (uint64_t) ten
+0008b9b0: 736f 722d 3e64 6174 613b 0a0a 2020 2020  sor->data;..    
+0008b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008b9d0: 6677 7269 7465 2826 7074 722c 2073 697a  fwrite(&ptr, siz
+0008b9e0: 656f 6628 7569 6e74 3634 5f74 292c 2031  eof(uint64_t), 1
+0008b9f0: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
+0008ba00: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+0008ba10: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
+0008ba20: 7465 2874 656e 736f 722d 3e6e 616d 652c  te(tensor->name,
+0008ba30: 2073 697a 656f 6628 6368 6172 292c 2047   sizeof(char), G
+0008ba40: 474d 4c5f 4d41 585f 4e41 4d45 2c20 666f  GML_MAX_NAME, fo
+0008ba50: 7574 293b 0a0a 2020 2020 2020 2020 2020  ut);..          
+0008ba60: 2020 2020 2020 2f2f 206f 7574 7075 7420        // output 
+0008ba70: 7468 6520 6f70 2061 7267 756d 656e 7473  the op arguments
+0008ba80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008ba90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0008baa0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0008bab0: 6d6c 5f74 656e 736f 7220 2a20 6172 6773  ml_tensor * args
+0008bac0: 5b32 202b 2047 474d 4c5f 4d41 585f 4f50  [2 + GGML_MAX_OP
+0008bad0: 545d 203d 207b 204e 554c 4c20 7d3b 0a0a  T] = { NULL };..
 0008bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008baf0: 2020 2f2f 2063 6865 636b 2069 6620 6c65    // check if le
-0008bb00: 6166 0a20 2020 2020 2020 2020 2020 2020  af.             
-0008bb10: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0008bb20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bb40: 2066 6f72 2028 696e 7420 6b20 3d20 303b   for (int k = 0;
-0008bb50: 206b 203c 2063 6772 6170 682d 3e6e 5f6c   k < cgraph->n_l
-0008bb60: 6561 6673 3b20 2b2b 6b29 207b 0a20 2020  eafs; ++k) {.   
-0008bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bb90: 2069 6620 2861 7267 735b 6a5d 203d 3d20   if (args[j] == 
-0008bba0: 6367 7261 7068 2d3e 6c65 6166 735b 6b5d  cgraph->leafs[k]
-0008bbb0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bbd0: 2020 2020 2020 2020 2020 2020 6964 7820              idx 
-0008bbe0: 3d20 6b3b 0a20 2020 2020 2020 2020 2020  = k;.           
-0008bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bc00: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0008bc10: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
-0008bc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bc30: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0008bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bc50: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0008baf0: 2020 2020 6172 6773 5b30 5d20 3d20 7465      args[0] = te
+0008bb00: 6e73 6f72 2d3e 7372 6330 3b0a 2020 2020  nsor->src0;.    
+0008bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bb20: 6172 6773 5b31 5d20 3d20 7465 6e73 6f72  args[1] = tensor
+0008bb30: 2d3e 7372 6331 3b0a 0a20 2020 2020 2020  ->src1;..       
+0008bb40: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0008bb50: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
+0008bb60: 2047 474d 4c5f 4d41 585f 4f50 543b 202b   GGML_MAX_OPT; +
+0008bb70: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
+0008bb80: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+0008bb90: 6773 5b32 202b 206a 5d20 3d20 7465 6e73  gs[2 + j] = tens
+0008bba0: 6f72 2d3e 6f70 745b 6a5d 3b0a 2020 2020  or->opt[j];.    
+0008bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bbc0: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+0008bbd0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+0008bbe0: 6a20 3d20 303b 206a 203c 2032 202b 2047  j = 0; j < 2 + G
+0008bbf0: 474d 4c5f 4d41 585f 4f50 543b 202b 2b6a  GML_MAX_OPT; ++j
+0008bc00: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008bc10: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0008bc20: 6172 6773 5b6a 5d29 207b 0a20 2020 2020  args[j]) {.     
+0008bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bc40: 2020 2020 2020 2069 6e74 3332 5f74 2069         int32_t i
+0008bc50: 6478 203d 202d 313b 0a0a 2020 2020 2020  dx = -1;..      
 0008bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bc70: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0008bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bc90: 2020 2020 2020 202f 2f20 6368 6563 6b20         // check 
-0008bca0: 6966 206e 6f64 650a 2020 2020 2020 2020  if node.        
+0008bc70: 2020 2020 2020 2f2f 2063 6865 636b 2069        // check i
+0008bc80: 6620 6c65 6166 0a20 2020 2020 2020 2020  f leaf.         
+0008bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bca0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
 0008bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bcc0: 2020 2020 6966 2028 6964 7820 3d3d 202d      if (idx == -
-0008bcd0: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-0008bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bcf0: 2020 2020 2066 6f72 2028 696e 7420 6b20       for (int k 
-0008bd00: 3d20 303b 206b 203c 2063 6772 6170 682d  = 0; k < cgraph-
-0008bd10: 3e6e 5f6e 6f64 6573 3b20 2b2b 6b29 207b  >n_nodes; ++k) {
-0008bd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bd40: 2020 2020 2069 6620 2861 7267 735b 6a5d       if (args[j]
-0008bd50: 203d 3d20 6367 7261 7068 2d3e 6e6f 6465   == cgraph->node
-0008bd60: 735b 6b5d 2920 7b0a 2020 2020 2020 2020  s[k]) {.        
+0008bcc0: 2020 2020 2066 6f72 2028 696e 7420 6b20       for (int k 
+0008bcd0: 3d20 303b 206b 203c 2063 6772 6170 682d  = 0; k < cgraph-
+0008bce0: 3e6e 5f6c 6561 6673 3b20 2b2b 6b29 207b  >n_leafs; ++k) {
+0008bcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008bd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bd10: 2020 2020 2069 6620 2861 7267 735b 6a5d       if (args[j]
+0008bd20: 203d 3d20 6367 7261 7068 2d3e 6c65 6166   == cgraph->leaf
+0008bd30: 735b 6b5d 2920 7b0a 2020 2020 2020 2020  s[k]) {.        
+0008bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bd60: 6964 7820 3d20 6b3b 0a20 2020 2020 2020  idx = k;.       
 0008bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0008bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bd90: 6964 7820 3d20 4747 4d4c 5f4d 4158 5f4e  idx = GGML_MAX_N
-0008bda0: 4f44 4553 202b 206b 3b0a 2020 2020 2020  ODES + k;.      
-0008bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bd90: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0008bda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bdb0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
 0008bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bdd0: 2020 6272 6561 6b3b 0a20 2020 2020 2020    break;.       
+0008bdd0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
 0008bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bdf0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0008bdf0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
 0008be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008be10: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0008be20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008be30: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-0008be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008be50: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0008be60: 6964 7820 3d3d 202d 3129 207b 0a20 2020  idx == -1) {.   
-0008be70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008be80: 2020 2020 2020 2020 2020 2020 2066 7072               fpr
-0008be90: 696e 7466 2873 7464 6572 722c 2022 2573  intf(stderr, "%s
-0008bea0: 3a20 6661 696c 6564 2074 6f20 6669 6e64  : failed to find
-0008beb0: 2074 656e 736f 722c 2061 7267 203d 2025   tensor, arg = %
-0008bec0: 642c 206e 6f64 6520 3d20 2564 5c6e 222c  d, node = %d\n",
-0008bed0: 205f 5f66 756e 635f 5f2c 206a 2c20 6929   __func__, j, i)
-0008bee0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0008be10: 2020 2020 2020 2020 2020 202f 2f20 6368             // ch
+0008be20: 6563 6b20 6966 206e 6f64 650a 2020 2020  eck if node.    
+0008be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008be40: 2020 2020 2020 2020 6966 2028 6964 7820          if (idx 
+0008be50: 3d3d 202d 3129 207b 0a20 2020 2020 2020  == -1) {.       
+0008be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008be70: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0008be80: 7420 6b20 3d20 303b 206b 203c 2063 6772  t k = 0; k < cgr
+0008be90: 6170 682d 3e6e 5f6e 6f64 6573 3b20 2b2b  aph->n_nodes; ++
+0008bea0: 6b29 207b 0a20 2020 2020 2020 2020 2020  k) {.           
+0008beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bec0: 2020 2020 2020 2020 2069 6620 2861 7267           if (arg
+0008bed0: 735b 6a5d 203d 3d20 6367 7261 7068 2d3e  s[j] == cgraph->
+0008bee0: 6e6f 6465 735b 6b5d 2920 7b0a 2020 2020  nodes[k]) {.    
 0008bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bf00: 2020 7265 7475 726e 3b0a 2020 2020 2020    return;.      
-0008bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bf20: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0008bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bf10: 2020 2020 6964 7820 3d20 4747 4d4c 5f4d      idx = GGML_M
+0008bf20: 4158 5f4e 4f44 4553 202b 206b 3b0a 2020  AX_NODES + k;.  
 0008bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bf40: 2020 2020 2066 7772 6974 6528 2669 6478       fwrite(&idx
-0008bf50: 2c20 7369 7a65 6f66 2869 6e74 3332 5f74  , sizeof(int32_t
-0008bf60: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
+0008bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bf50: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
+0008bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0008bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bf80: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
+0008bf80: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
 0008bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bfa0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0008bfb0: 696e 7433 325f 7420 6e75 6c20 3d20 2d31  int32_t nul = -1
-0008bfc0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0008bfd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0008bfe0: 7772 6974 6528 266e 756c 2c20 7369 7a65  write(&nul, size
-0008bff0: 6f66 2869 6e74 3332 5f74 292c 2031 2c20  of(int32_t), 1, 
-0008c000: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-0008c010: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0008c020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008c030: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0008c040: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0008c050: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0008c060: 0a0a 2020 2020 2020 2020 6663 6c6f 7365  ..        fclose
-0008c070: 2866 6f75 7429 3b0a 2020 2020 7d0a 7d0a  (fout);.    }.}.
-0008c080: 0a73 7472 7563 7420 6767 6d6c 5f63 6772  .struct ggml_cgr
-0008c090: 6170 6820 6767 6d6c 5f67 7261 7068 5f69  aph ggml_graph_i
-0008c0a0: 6d70 6f72 7428 636f 6e73 7420 6368 6172  mport(const char
-0008c0b0: 202a 2066 6e61 6d65 2c20 7374 7275 6374   * fname, struct
-0008c0c0: 2067 676d 6c5f 636f 6e74 6578 7420 2a2a   ggml_context **
-0008c0d0: 2063 7478 5f64 6174 612c 2073 7472 7563   ctx_data, struc
-0008c0e0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-0008c0f0: 2a20 6374 785f 6576 616c 2920 7b0a 2020  * ctx_eval) {.  
-0008c100: 2020 6173 7365 7274 282a 6374 785f 6461    assert(*ctx_da
-0008c110: 7461 203d 3d20 4e55 4c4c 293b 0a20 2020  ta == NULL);.   
-0008c120: 2061 7373 6572 7428 2a63 7478 5f65 7661   assert(*ctx_eva
-0008c130: 6c20 3d3d 204e 554c 4c29 3b0a 0a20 2020  l == NULL);..   
-0008c140: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
-0008c150: 6170 6820 7265 7375 6c74 203d 207b 2030  aph result = { 0
-0008c160: 207d 3b0a 0a20 2020 2073 7472 7563 7420   };..    struct 
-0008c170: 6767 6d6c 5f74 656e 736f 7220 2a20 6461  ggml_tensor * da
-0008c180: 7461 203d 204e 554c 4c3b 0a0a 2020 2020  ta = NULL;..    
-0008c190: 2f2f 2072 6561 6420 6669 6c65 2069 6e74  // read file int
-0008c1a0: 6f20 6461 7461 0a20 2020 207b 0a20 2020  o data.    {.   
-0008c1b0: 2020 2020 2046 494c 4520 2a20 6669 6e20       FILE * fin 
-0008c1c0: 3d20 666f 7065 6e28 666e 616d 652c 2022  = fopen(fname, "
-0008c1d0: 7262 2229 3b0a 2020 2020 2020 2020 6966  rb");.        if
-0008c1e0: 2028 2166 696e 2920 7b0a 2020 2020 2020   (!fin) {.      
-0008c1f0: 2020 2020 2020 6670 7269 6e74 6628 7374        fprintf(st
-0008c200: 6465 7272 2c20 2225 733a 2066 6169 6c65  derr, "%s: faile
-0008c210: 6420 746f 206f 7065 6e20 2573 5c6e 222c  d to open %s\n",
-0008c220: 205f 5f66 756e 635f 5f2c 2066 6e61 6d65   __func__, fname
-0008c230: 293b 0a20 2020 2020 2020 2020 2020 2072  );.            r
-0008c240: 6574 7572 6e20 7265 7375 6c74 3b0a 2020  eturn result;.  
-0008c250: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0008c260: 2073 697a 655f 7420 6673 697a 6520 3d20   size_t fsize = 
-0008c270: 303b 0a0a 2020 2020 2020 2020 6673 6565  0;..        fsee
-0008c280: 6b28 6669 6e2c 2030 2c20 5345 454b 5f45  k(fin, 0, SEEK_E
-0008c290: 4e44 293b 0a20 2020 2020 2020 2066 7369  ND);.        fsi
-0008c2a0: 7a65 203d 2066 7465 6c6c 2866 696e 293b  ze = ftell(fin);
-0008c2b0: 0a20 2020 2020 2020 2066 7365 656b 2866  .        fseek(f
-0008c2c0: 696e 2c20 302c 2053 4545 4b5f 5345 5429  in, 0, SEEK_SET)
-0008c2d0: 3b0a 0a20 2020 2020 2020 202f 2f20 6372  ;..        // cr
-0008c2e0: 6561 7465 2074 6865 2064 6174 6120 636f  eate the data co
-0008c2f0: 6e74 6578 740a 2020 2020 2020 2020 7b0a  ntext.        {.
-0008c300: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0008c310: 7420 7369 7a65 5f74 206f 7665 7268 6561  t size_t overhea
-0008c320: 6420 3d20 312a 6767 6d6c 5f74 656e 736f  d = 1*ggml_tenso
-0008c330: 725f 6f76 6572 6865 6164 2829 3b0a 0a20  r_overhead();.. 
-0008c340: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-0008c350: 7420 6767 6d6c 5f69 6e69 745f 7061 7261  t ggml_init_para
-0008c360: 6d73 2070 6172 616d 7320 3d20 7b0a 2020  ms params = {.  
-0008c370: 2020 2020 2020 2020 2020 2020 2020 2e6d                .m
-0008c380: 656d 5f73 697a 6520 2020 3d20 6673 697a  em_size   = fsiz
-0008c390: 6520 2b20 6f76 6572 6865 6164 2c0a 2020  e + overhead,.  
-0008c3a0: 2020 2020 2020 2020 2020 2020 2020 2e6d                .m
-0008c3b0: 656d 5f62 7566 6665 7220 3d20 4e55 4c4c  em_buffer = NULL
-0008c3c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0008c3d0: 2020 2e6e 6f5f 616c 6c6f 6320 2020 3d20    .no_alloc   = 
-0008c3e0: 6661 6c73 652c 0a20 2020 2020 2020 2020  false,.         
-0008c3f0: 2020 207d 3b0a 0a20 2020 2020 2020 2020     };..         
-0008c400: 2020 202a 6374 785f 6461 7461 203d 2067     *ctx_data = g
-0008c410: 676d 6c5f 696e 6974 2870 6172 616d 7329  gml_init(params)
-0008c420: 3b0a 0a20 2020 2020 2020 2020 2020 2069  ;..            i
-0008c430: 6620 2821 2a63 7478 5f64 6174 6129 207b  f (!*ctx_data) {
-0008c440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008c450: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
-0008c460: 2022 2573 3a20 6661 696c 6564 2074 6f20   "%s: failed to 
-0008c470: 6372 6561 7465 2067 676d 6c20 636f 6e74  create ggml cont
-0008c480: 6578 745c 6e22 2c20 5f5f 6675 6e63 5f5f  ext\n", __func__
-0008c490: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008c4a0: 2020 2066 636c 6f73 6528 6669 6e29 3b0a     fclose(fin);.
-0008c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c4c0: 7265 7475 726e 2072 6573 756c 743b 0a20  return result;. 
-0008c4d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0008c4e0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008c4f0: 6461 7461 203d 2067 676d 6c5f 6e65 775f  data = ggml_new_
-0008c500: 7465 6e73 6f72 5f31 6428 2a63 7478 5f64  tensor_1d(*ctx_d
-0008c510: 6174 612c 2047 474d 4c5f 5459 5045 5f49  ata, GGML_TYPE_I
-0008c520: 382c 2066 7369 7a65 293b 0a0a 2020 2020  8, fsize);..    
-0008c530: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0008c540: 2020 636f 6e73 7420 7369 7a65 5f74 2072    const size_t r
-0008c550: 6574 203d 2066 7265 6164 2864 6174 612d  et = fread(data-
-0008c560: 3e64 6174 612c 2073 697a 656f 6628 6368  >data, sizeof(ch
-0008c570: 6172 292c 2066 7369 7a65 2c20 6669 6e29  ar), fsize, fin)
-0008c580: 3b0a 2020 2020 2020 2020 2020 2020 6966  ;.            if
-0008c590: 2028 7265 7420 213d 2066 7369 7a65 2920   (ret != fsize) 
-0008c5a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0008c5b0: 2020 6670 7269 6e74 6628 7374 6465 7272    fprintf(stderr
-0008c5c0: 2c20 2225 733a 2066 6169 6c65 6420 746f  , "%s: failed to
-0008c5d0: 2072 6561 6420 2573 5c6e 222c 205f 5f66   read %s\n", __f
-0008c5e0: 756e 635f 5f2c 2066 6e61 6d65 293b 0a20  unc__, fname);. 
-0008c5f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0008c600: 636c 6f73 6528 6669 6e29 3b0a 2020 2020  close(fin);.    
-0008c610: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0008c620: 726e 2072 6573 756c 743b 0a20 2020 2020  rn result;.     
-0008c630: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0008c640: 207d 0a0a 2020 2020 2020 2020 6663 6c6f   }..        fclo
-0008c650: 7365 2866 696e 293b 0a20 2020 207d 0a0a  se(fin);.    }..
-0008c660: 2020 2020 2f2f 2070 6f70 756c 6174 6520      // populate 
-0008c670: 7265 7375 6c74 0a20 2020 207b 0a20 2020  result.    {.   
-0008c680: 2020 2020 2063 6861 7220 2a20 7074 7220       char * ptr 
-0008c690: 3d20 2863 6861 7220 2a29 2064 6174 612d  = (char *) data-
-0008c6a0: 3e64 6174 613b 0a0a 2020 2020 2020 2020  >data;..        
-0008c6b0: 636f 6e73 7420 7569 6e74 3332 5f74 206d  const uint32_t m
-0008c6c0: 6167 6963 203d 202a 2863 6f6e 7374 2075  agic = *(const u
-0008c6d0: 696e 7433 325f 7420 2a29 2070 7472 3b20  int32_t *) ptr; 
-0008c6e0: 7074 7220 2b3d 2073 697a 656f 6628 6d61  ptr += sizeof(ma
-0008c6f0: 6769 6329 3b0a 0a20 2020 2020 2020 2069  gic);..        i
-0008c700: 6620 286d 6167 6963 2021 3d20 4747 4d4c  f (magic != GGML
-0008c710: 5f46 494c 455f 4d41 4749 4329 207b 0a20  _FILE_MAGIC) {. 
-0008c720: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-0008c730: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
-0008c740: 696e 7661 6c69 6420 6d61 6769 6320 6e75  invalid magic nu
-0008c750: 6d62 6572 2c20 676f 7420 2530 3878 5c6e  mber, got %08x\n
-0008c760: 222c 205f 5f66 756e 635f 5f2c 206d 6167  ", __func__, mag
-0008c770: 6963 293b 0a20 2020 2020 2020 2020 2020  ic);.           
-0008c780: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-0008c790: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0008c7a0: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
-0008c7b0: 7420 7665 7273 696f 6e20 3d20 2a28 636f  t version = *(co
-0008c7c0: 6e73 7420 7569 6e74 3332 5f74 202a 2920  nst uint32_t *) 
-0008c7d0: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
-0008c7e0: 6f66 2876 6572 7369 6f6e 293b 0a0a 2020  of(version);..  
-0008c7f0: 2020 2020 2020 6966 2028 7665 7273 696f        if (versio
-0008c800: 6e20 213d 2047 474d 4c5f 4649 4c45 5f56  n != GGML_FILE_V
-0008c810: 4552 5349 4f4e 2920 7b0a 2020 2020 2020  ERSION) {.      
-0008c820: 2020 2020 2020 6670 7269 6e74 6628 7374        fprintf(st
-0008c830: 6465 7272 2c20 2225 733a 2069 6e76 616c  derr, "%s: inval
-0008c840: 6964 2076 6572 7369 6f6e 206e 756d 6265  id version numbe
-0008c850: 725c 6e22 2c20 5f5f 6675 6e63 5f5f 293b  r\n", __func__);
-0008c860: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0008c870: 7572 6e20 7265 7375 6c74 3b0a 2020 2020  urn result;.    
-0008c880: 2020 2020 7d0a 0a20 2020 2020 2020 2063      }..        c
-0008c890: 6f6e 7374 2075 696e 7433 325f 7420 6e5f  onst uint32_t n_
-0008c8a0: 6c65 6166 7320 2020 3d20 2a28 636f 6e73  leafs   = *(cons
-0008c8b0: 7420 7569 6e74 3332 5f74 202a 2920 7074  t uint32_t *) pt
-0008c8c0: 723b 2070 7472 202b 3d20 7369 7a65 6f66  r; ptr += sizeof
-0008c8d0: 286e 5f6c 6561 6673 293b 0a20 2020 2020  (n_leafs);.     
-0008c8e0: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
-0008c8f0: 7420 6e5f 6e6f 6465 7320 2020 3d20 2a28  t n_nodes   = *(
-0008c900: 636f 6e73 7420 7569 6e74 3332 5f74 202a  const uint32_t *
-0008c910: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
-0008c920: 7a65 6f66 286e 5f6e 6f64 6573 293b 0a20  zeof(n_nodes);. 
-0008c930: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-0008c940: 7436 345f 7420 7369 7a65 5f65 7661 6c20  t64_t size_eval 
-0008c950: 3d20 2a28 636f 6e73 7420 7569 6e74 3634  = *(const uint64
-0008c960: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
-0008c970: 3d20 7369 7a65 6f66 2873 697a 655f 6576  = sizeof(size_ev
-0008c980: 616c 293b 0a0a 2020 2020 2020 2020 7265  al);..        re
-0008c990: 7375 6c74 2e6e 5f6c 6561 6673 203d 206e  sult.n_leafs = n
-0008c9a0: 5f6c 6561 6673 3b0a 2020 2020 2020 2020  _leafs;.        
-0008c9b0: 7265 7375 6c74 2e6e 5f6e 6f64 6573 203d  result.n_nodes =
-0008c9c0: 206e 5f6e 6f64 6573 3b0a 0a20 2020 2020   n_nodes;..     
-0008c9d0: 2020 202f 2f20 6372 6561 7465 2074 6865     // create the
-0008c9e0: 2064 6174 6120 636f 6e74 6578 740a 2020   data context.  
-0008c9f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0008ca00: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0008ca10: 206f 7665 7268 6561 6420 3d20 286e 5f6c   overhead = (n_l
-0008ca20: 6561 6673 202b 206e 5f6e 6f64 6573 292a  eafs + n_nodes)*
-0008ca30: 6767 6d6c 5f74 656e 736f 725f 6f76 6572  ggml_tensor_over
-0008ca40: 6865 6164 2829 3b0a 0a20 2020 2020 2020  head();..       
-0008ca50: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0008ca60: 5f69 6e69 745f 7061 7261 6d73 2070 6172  _init_params par
-0008ca70: 616d 7320 3d20 7b0a 2020 2020 2020 2020  ams = {.        
-0008ca80: 2020 2020 2020 2020 2e6d 656d 5f73 697a          .mem_siz
-0008ca90: 6520 2020 3d20 7369 7a65 5f65 7661 6c20  e   = size_eval 
-0008caa0: 2b20 6f76 6572 6865 6164 2c0a 2020 2020  + overhead,.    
-0008cab0: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
-0008cac0: 5f62 7566 6665 7220 3d20 4e55 4c4c 2c0a  _buffer = NULL,.
-0008cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008cae0: 2e6e 6f5f 616c 6c6f 6320 2020 3d20 7472  .no_alloc   = tr
-0008caf0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0008cb00: 7d3b 0a0a 2020 2020 2020 2020 2020 2020  };..            
-0008cb10: 2a63 7478 5f65 7661 6c20 3d20 6767 6d6c  *ctx_eval = ggml
-0008cb20: 5f69 6e69 7428 7061 7261 6d73 293b 0a0a  _init(params);..
-0008cb30: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0008cb40: 212a 6374 785f 6576 616c 2920 7b0a 2020  !*ctx_eval) {.  
-0008cb50: 2020 2020 2020 2020 2020 2020 2020 6670                fp
-0008cb60: 7269 6e74 6628 7374 6465 7272 2c20 2225  rintf(stderr, "%
-0008cb70: 733a 2066 6169 6c65 6420 746f 2063 7265  s: failed to cre
-0008cb80: 6174 6520 6767 6d6c 2063 6f6e 7465 7874  ate ggml context
-0008cb90: 5c6e 222c 205f 5f66 756e 635f 5f29 3b0a  \n", __func__);.
-0008cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008cbb0: 7265 7475 726e 2072 6573 756c 743b 0a20  return result;. 
-0008cbc0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0008cbd0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008cbe0: 2f2f 206c 6561 6673 0a20 2020 2020 2020  // leafs.       
-0008cbf0: 207b 0a20 2020 2020 2020 2020 2020 2075   {.            u
-0008cc00: 696e 7433 325f 7420 7479 7065 3b0a 2020  int32_t type;.  
-0008cc10: 2020 2020 2020 2020 2020 7569 6e74 3332            uint32
-0008cc20: 5f74 206f 703b 0a20 2020 2020 2020 2020  _t op;.         
-0008cc30: 2020 2075 696e 7433 325f 7420 6e5f 6469     uint32_t n_di
-0008cc40: 6d73 3b0a 0a20 2020 2020 2020 2020 2020  ms;..           
-0008cc50: 2066 6f72 2028 7569 6e74 3332 5f74 2069   for (uint32_t i
-0008cc60: 203d 2030 3b20 6920 3c20 6e5f 6c65 6166   = 0; i < n_leaf
-0008cc70: 733b 202b 2b69 2920 7b0a 2020 2020 2020  s; ++i) {.      
-0008cc80: 2020 2020 2020 2020 2020 7479 7065 2020            type  
-0008cc90: 203d 202a 2863 6f6e 7374 2075 696e 7433   = *(const uint3
-0008cca0: 325f 7420 2a29 2070 7472 3b20 7074 7220  2_t *) ptr; ptr 
-0008ccb0: 2b3d 2073 697a 656f 6628 7479 7065 293b  += sizeof(type);
-0008ccc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008ccd0: 206f 7020 2020 2020 3d20 2a28 636f 6e73   op     = *(cons
-0008cce0: 7420 7569 6e74 3332 5f74 202a 2920 7074  t uint32_t *) pt
-0008ccf0: 723b 2070 7472 202b 3d20 7369 7a65 6f66  r; ptr += sizeof
-0008cd00: 286f 7029 3b0a 2020 2020 2020 2020 2020  (op);.          
-0008cd10: 2020 2020 2020 6e5f 6469 6d73 203d 202a        n_dims = *
-0008cd20: 2863 6f6e 7374 2075 696e 7433 325f 7420  (const uint32_t 
-0008cd30: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
-0008cd40: 697a 656f 6628 6e5f 6469 6d73 293b 0a0a  izeof(n_dims);..
-0008cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008cd60: 696e 7436 345f 7420 6e65 5b47 474d 4c5f  int64_t ne[GGML_
-0008cd70: 4d41 585f 4449 4d53 5d3b 0a20 2020 2020  MAX_DIMS];.     
-0008cd80: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-0008cd90: 7420 206e 625b 4747 4d4c 5f4d 4158 5f44  t  nb[GGML_MAX_D
-0008cda0: 494d 535d 3b0a 0a20 2020 2020 2020 2020  IMS];..         
-0008cdb0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0008cdc0: 6a20 3d20 303b 206a 203c 2047 474d 4c5f  j = 0; j < GGML_
-0008cdd0: 4d41 585f 4449 4d53 3b20 2b2b 6a29 207b  MAX_DIMS; ++j) {
-0008cde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008cdf0: 2020 2020 2075 696e 7436 345f 7420 6e65       uint64_t ne
-0008ce00: 5f63 7572 3b0a 2020 2020 2020 2020 2020  _cur;.          
-0008ce10: 2020 2020 2020 2020 2020 7569 6e74 3634            uint64
-0008ce20: 5f74 206e 625f 6375 723b 0a0a 2020 2020  _t nb_cur;..    
-0008ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ce40: 6e65 5f63 7572 203d 202a 2863 6f6e 7374  ne_cur = *(const
-0008ce50: 2075 696e 7436 345f 7420 2a29 2070 7472   uint64_t *) ptr
-0008ce60: 3b20 7074 7220 2b3d 2073 697a 656f 6628  ; ptr += sizeof(
-0008ce70: 6e65 5f63 7572 293b 0a20 2020 2020 2020  ne_cur);.       
-0008ce80: 2020 2020 2020 2020 2020 2020 206e 625f               nb_
-0008ce90: 6375 7220 3d20 2a28 636f 6e73 7420 7569  cur = *(const ui
-0008cea0: 6e74 3634 5f74 202a 2920 7074 723b 2070  nt64_t *) ptr; p
-0008ceb0: 7472 202b 3d20 7369 7a65 6f66 286e 625f  tr += sizeof(nb_
-0008cec0: 6375 7229 3b0a 0a20 2020 2020 2020 2020  cur);..         
-0008ced0: 2020 2020 2020 2020 2020 206e 655b 6a5d             ne[j]
-0008cee0: 203d 206e 655f 6375 723b 0a20 2020 2020   = ne_cur;.     
-0008cef0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0008cf00: 625b 6a5d 203d 206e 625f 6375 723b 0a20  b[j] = nb_cur;. 
-0008cf10: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0008cf20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0008cf30: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0008cf40: 6e73 6f72 202a 2074 656e 736f 7220 3d20  nsor * tensor = 
-0008cf50: 6767 6d6c 5f6e 6577 5f74 656e 736f 7228  ggml_new_tensor(
-0008cf60: 2a63 7478 5f65 7661 6c2c 2028 656e 756d  *ctx_eval, (enum
-0008cf70: 2067 676d 6c5f 7479 7065 2920 7479 7065   ggml_type) type
-0008cf80: 2c20 6e5f 6469 6d73 2c20 6e65 293b 0a0a  , n_dims, ne);..
-0008cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008cfa0: 7465 6e73 6f72 2d3e 6f70 203d 2028 656e  tensor->op = (en
-0008cfb0: 756d 2067 676d 6c5f 6f70 2920 6f70 3b0a  um ggml_op) op;.
-0008cfc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008cfd0: 2075 696e 7436 345f 7420 7074 725f 6375   uint64_t ptr_cu
-0008cfe0: 7220 3d20 2a28 636f 6e73 7420 7569 6e74  r = *(const uint
-0008cff0: 3634 5f74 202a 2920 7074 723b 2070 7472  64_t *) ptr; ptr
-0008d000: 202b 3d20 7369 7a65 6f66 2870 7472 5f63   += sizeof(ptr_c
-0008d010: 7572 293b 0a0a 2020 2020 2020 2020 2020  ur);..          
-0008d020: 2020 2020 2020 6d65 6d63 7079 2874 656e        memcpy(ten
-0008d030: 736f 722d 3e6e 616d 652c 2070 7472 2c20  sor->name, ptr, 
-0008d040: 4747 4d4c 5f4d 4158 5f4e 414d 4529 3b20  GGML_MAX_NAME); 
-0008d050: 7074 7220 2b3d 2047 474d 4c5f 4d41 585f  ptr += GGML_MAX_
-0008d060: 4e41 4d45 3b0a 0a20 2020 2020 2020 2020  NAME;..         
-0008d070: 2020 2020 2020 2074 656e 736f 722d 3e64         tensor->d
-0008d080: 6174 6120 3d20 2876 6f69 6420 2a29 2070  ata = (void *) p
-0008d090: 7472 3b0a 0a20 2020 2020 2020 2020 2020  tr;..           
-0008d0a0: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-0008d0b0: 3d20 303b 206a 203c 2047 474d 4c5f 4d41  = 0; j < GGML_MA
-0008d0c0: 585f 4449 4d53 3b20 2b2b 6a29 207b 0a20  X_DIMS; ++j) {. 
-0008d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008d0e0: 2020 2074 656e 736f 722d 3e6e 625b 6a5d     tensor->nb[j]
-0008d0f0: 203d 206e 625b 6a5d 3b0a 2020 2020 2020   = nb[j];.      
-0008d100: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0008d110: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0008d120: 756c 742e 6c65 6166 735b 695d 203d 2074  ult.leafs[i] = t
-0008d130: 656e 736f 723b 0a0a 2020 2020 2020 2020  ensor;..        
-0008d140: 2020 2020 2020 2020 7074 7220 2b3d 2067          ptr += g
-0008d150: 676d 6c5f 6e62 7974 6573 2874 656e 736f  gml_nbytes(tenso
-0008d160: 7229 3b0a 0a20 2020 2020 2020 2020 2020  r);..           
-0008d170: 2020 2020 2066 7072 696e 7466 2873 7464       fprintf(std
-0008d180: 6572 722c 2022 2573 3a20 6c6f 6164 6564  err, "%s: loaded
-0008d190: 206c 6561 6620 2564 3a20 2725 3136 7327   leaf %d: '%16s'
-0008d1a0: 2c20 2533 6420 6469 6d73 2c20 2539 7a75  , %3d dims, %9zu
-0008d1b0: 2062 7974 6573 5c6e 222c 205f 5f66 756e   bytes\n", __fun
-0008d1c0: 635f 5f2c 2069 2c20 7465 6e73 6f72 2d3e  c__, i, tensor->
-0008d1d0: 6e61 6d65 2c20 6e5f 6469 6d73 2c20 6767  name, n_dims, gg
-0008d1e0: 6d6c 5f6e 6279 7465 7328 7465 6e73 6f72  ml_nbytes(tensor
-0008d1f0: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
-0008d200: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-0008d210: 2020 2020 2067 676d 6c5f 7365 745f 6e6f       ggml_set_no
-0008d220: 5f61 6c6c 6f63 282a 6374 785f 6576 616c  _alloc(*ctx_eval
-0008d230: 2c20 6661 6c73 6529 3b0a 0a20 2020 2020  , false);..     
-0008d240: 2020 202f 2f20 6e6f 6465 730a 2020 2020     // nodes.    
-0008d250: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0008d260: 2020 7569 6e74 3332 5f74 2074 7970 653b    uint32_t type;
-0008d270: 0a20 2020 2020 2020 2020 2020 2075 696e  .            uin
-0008d280: 7433 325f 7420 6f70 3b0a 2020 2020 2020  t32_t op;.      
-0008d290: 2020 2020 2020 7569 6e74 3332 5f74 206e        uint32_t n
-0008d2a0: 5f64 696d 733b 0a0a 2020 2020 2020 2020  _dims;..        
-0008d2b0: 2020 2020 666f 7220 2875 696e 7433 325f      for (uint32_
-0008d2c0: 7420 6920 3d20 303b 2069 203c 206e 5f6e  t i = 0; i < n_n
-0008d2d0: 6f64 6573 3b20 2b2b 6929 207b 0a20 2020  odes; ++i) {.   
-0008d2e0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-0008d2f0: 6520 2020 3d20 2a28 636f 6e73 7420 7569  e   = *(const ui
-0008d300: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
-0008d310: 7472 202b 3d20 7369 7a65 6f66 2874 7970  tr += sizeof(typ
-0008d320: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-0008d330: 2020 2020 6f70 2020 2020 203d 202a 2863      op     = *(c
-0008d340: 6f6e 7374 2075 696e 7433 325f 7420 2a29  onst uint32_t *)
-0008d350: 2070 7472 3b20 7074 7220 2b3d 2073 697a   ptr; ptr += siz
-0008d360: 656f 6628 6f70 293b 0a20 2020 2020 2020  eof(op);.       
-0008d370: 2020 2020 2020 2020 206e 5f64 696d 7320           n_dims 
-0008d380: 3d20 2a28 636f 6e73 7420 7569 6e74 3332  = *(const uint32
-0008d390: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
-0008d3a0: 3d20 7369 7a65 6f66 286e 5f64 696d 7329  = sizeof(n_dims)
-0008d3b0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0008d3c0: 2020 2065 6e75 6d20 6767 6d6c 5f6f 7020     enum ggml_op 
-0008d3d0: 656f 7020 3d20 2865 6e75 6d20 6767 6d6c  eop = (enum ggml
-0008d3e0: 5f6f 7029 206f 703b 0a0a 2020 2020 2020  _op) op;..      
-0008d3f0: 2020 2020 2020 2020 2020 696e 7436 345f            int64_
-0008d400: 7420 6e65 5b47 474d 4c5f 4d41 585f 4449  t ne[GGML_MAX_DI
-0008d410: 4d53 5d3b 0a20 2020 2020 2020 2020 2020  MS];.           
-0008d420: 2020 2020 2073 697a 655f 7420 206e 625b       size_t  nb[
-0008d430: 4747 4d4c 5f4d 4158 5f44 494d 535d 3b0a  GGML_MAX_DIMS];.
-0008d440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008d450: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-0008d460: 206a 203c 2047 474d 4c5f 4d41 585f 4449   j < GGML_MAX_DI
-0008d470: 4d53 3b20 2b2b 6a29 207b 0a20 2020 2020  MS; ++j) {.     
-0008d480: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0008d490: 696e 7436 345f 7420 6e65 5f63 7572 3b0a  int64_t ne_cur;.
-0008d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008d4b0: 2020 2020 7569 6e74 3634 5f74 206e 625f      uint64_t nb_
-0008d4c0: 6375 723b 0a0a 2020 2020 2020 2020 2020  cur;..          
-0008d4d0: 2020 2020 2020 2020 2020 6e65 5f63 7572            ne_cur
-0008d4e0: 203d 202a 2863 6f6e 7374 2075 696e 7436   = *(const uint6
-0008d4f0: 345f 7420 2a29 2070 7472 3b20 7074 7220  4_t *) ptr; ptr 
-0008d500: 2b3d 2073 697a 656f 6628 6e65 5f63 7572  += sizeof(ne_cur
-0008d510: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008d520: 2020 2020 2020 206e 625f 6375 7220 3d20         nb_cur = 
-0008d530: 2a28 636f 6e73 7420 7569 6e74 3634 5f74  *(const uint64_t
-0008d540: 202a 2920 7074 723b 2070 7472 202b 3d20   *) ptr; ptr += 
-0008d550: 7369 7a65 6f66 286e 625f 6375 7229 3b0a  sizeof(nb_cur);.
-0008d560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008d570: 2020 2020 206e 655b 6a5d 203d 206e 655f       ne[j] = ne_
-0008d580: 6375 723b 0a20 2020 2020 2020 2020 2020  cur;.           
-0008d590: 2020 2020 2020 2020 206e 625b 6a5d 203d           nb[j] =
-0008d5a0: 206e 625f 6375 723b 0a20 2020 2020 2020   nb_cur;.       
-0008d5b0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-0008d5c0: 2020 2020 2020 2020 2020 2020 7569 6e74              uint
-0008d5d0: 3634 5f74 2070 7472 5f63 7572 203d 202a  64_t ptr_cur = *
-0008d5e0: 2863 6f6e 7374 2075 696e 7436 345f 7420  (const uint64_t 
-0008d5f0: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
-0008d600: 697a 656f 6628 7074 725f 6375 7229 3b20  izeof(ptr_cur); 
-0008d610: 2f2f 2054 4f44 4f3a 206e 6f74 2079 6574  // TODO: not yet
-0008d620: 2075 7365 640a 0a20 2020 2020 2020 2020   used..         
-0008d630: 2020 2020 2020 2063 6f6e 7374 2063 6861         const cha
-0008d640: 7220 2a20 7074 725f 6e61 6d65 203d 2070  r * ptr_name = p
-0008d650: 7472 3b20 7074 7220 2b3d 2047 474d 4c5f  tr; ptr += GGML_
-0008d660: 4d41 585f 4e41 4d45 3b0a 0a20 2020 2020  MAX_NAME;..     
-0008d670: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0008d680: 2069 6e74 3332 5f74 202a 2070 7472 5f61   int32_t * ptr_a
-0008d690: 7267 5f69 6478 203d 2028 636f 6e73 7420  rg_idx = (const 
-0008d6a0: 696e 7433 325f 7420 2a29 2070 7472 3b20  int32_t *) ptr; 
-0008d6b0: 7074 7220 2b3d 2028 3220 2b20 4747 4d4c  ptr += (2 + GGML
-0008d6c0: 5f4d 4158 5f4f 5054 292a 7369 7a65 6f66  _MAX_OPT)*sizeof
-0008d6d0: 2869 6e74 3332 5f74 293b 0a0a 2020 2020  (int32_t);..    
-0008d6e0: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-0008d6f0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0008d700: 2061 7267 735b 3220 2b20 4747 4d4c 5f4d   args[2 + GGML_M
-0008d710: 4158 5f4f 5054 5d20 3d20 7b20 4e55 4c4c  AX_OPT] = { NULL
-0008d720: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
-0008d730: 2020 2020 202f 2f20 7061 7273 6520 6172       // parse ar
-0008d740: 6773 0a20 2020 2020 2020 2020 2020 2020  gs.             
-0008d750: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-0008d760: 303b 206a 203c 2032 202b 2047 474d 4c5f  0; j < 2 + GGML_
-0008d770: 4d41 585f 4f50 543b 202b 2b6a 2920 7b0a  MAX_OPT; ++j) {.
-0008d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008d790: 2020 2020 636f 6e73 7420 696e 7433 325f      const int32_
-0008d7a0: 7420 6172 675f 6964 7820 3d20 7074 725f  t arg_idx = ptr_
-0008d7b0: 6172 675f 6964 785b 6a5d 3b0a 0a20 2020  arg_idx[j];..   
-0008d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008d7d0: 2069 6620 2861 7267 5f69 6478 203d 3d20   if (arg_idx == 
-0008d7e0: 2d31 2920 7b0a 2020 2020 2020 2020 2020  -1) {.          
-0008d7f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0008d800: 6e74 696e 7565 3b0a 2020 2020 2020 2020  ntinue;.        
-0008d810: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-0008d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008d830: 2020 2069 6620 2861 7267 5f69 6478 203c     if (arg_idx <
-0008d840: 2047 474d 4c5f 4d41 585f 4e4f 4445 5329   GGML_MAX_NODES)
-0008d850: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008d860: 2020 2020 2020 2020 2020 2061 7267 735b             args[
-0008d870: 6a5d 203d 2072 6573 756c 742e 6c65 6166  j] = result.leaf
-0008d880: 735b 6172 675f 6964 785d 3b0a 2020 2020  s[arg_idx];.    
-0008d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008d8a0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-0008d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008d8c0: 2061 7267 735b 6a5d 203d 2072 6573 756c   args[j] = resul
-0008d8d0: 742e 6e6f 6465 735b 6172 675f 6964 7820  t.nodes[arg_idx 
-0008d8e0: 2d20 4747 4d4c 5f4d 4158 5f4e 4f44 4553  - GGML_MAX_NODES
-0008d8f0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0008d900: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0008d910: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-0008d920: 2020 2020 2020 2020 2020 2020 2f2f 2063              // c
-0008d930: 7265 6174 6520 7468 6520 7465 6e73 6f72  reate the tensor
+0008bfa0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0008bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bfc0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+0008bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bfe0: 6966 2028 6964 7820 3d3d 202d 3129 207b  if (idx == -1) {
+0008bff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c010: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
+0008c020: 2022 2573 3a20 6661 696c 6564 2074 6f20   "%s: failed to 
+0008c030: 6669 6e64 2074 656e 736f 722c 2061 7267  find tensor, arg
+0008c040: 203d 2025 642c 206e 6f64 6520 3d20 2564   = %d, node = %d
+0008c050: 5c6e 222c 205f 5f66 756e 635f 5f2c 206a  \n", __func__, j
+0008c060: 2c20 6929 3b0a 2020 2020 2020 2020 2020  , i);.          
+0008c070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c080: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+0008c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c0a0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0008c0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c0c0: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
+0008c0d0: 2669 6478 2c20 7369 7a65 6f66 2869 6e74  &idx, sizeof(int
+0008c0e0: 3332 5f74 292c 2031 2c20 666f 7574 293b  32_t), 1, fout);
+0008c0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008c100: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+0008c110: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0008c120: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0008c130: 6e73 7420 696e 7433 325f 7420 6e75 6c20  nst int32_t nul 
+0008c140: 3d20 2d31 3b0a 0a20 2020 2020 2020 2020  = -1;..         
+0008c150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c160: 2020 2066 7772 6974 6528 266e 756c 2c20     fwrite(&nul, 
+0008c170: 7369 7a65 6f66 2869 6e74 3332 5f74 292c  sizeof(int32_t),
+0008c180: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
+0008c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c1a0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0008c1b0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0008c1c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0008c1d0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0008c1e0: 2020 207d 0a0a 2020 2020 2020 2020 6663     }..        fc
+0008c1f0: 6c6f 7365 2866 6f75 7429 3b0a 2020 2020  lose(fout);.    
+0008c200: 7d0a 7d0a 0a73 7472 7563 7420 6767 6d6c  }.}..struct ggml
+0008c210: 5f63 6772 6170 6820 6767 6d6c 5f67 7261  _cgraph ggml_gra
+0008c220: 7068 5f69 6d70 6f72 7428 636f 6e73 7420  ph_import(const 
+0008c230: 6368 6172 202a 2066 6e61 6d65 2c20 7374  char * fname, st
+0008c240: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+0008c250: 7420 2a2a 2063 7478 5f64 6174 612c 2073  t ** ctx_data, s
+0008c260: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+0008c270: 7874 202a 2a20 6374 785f 6576 616c 2920  xt ** ctx_eval) 
+0008c280: 7b0a 2020 2020 6173 7365 7274 282a 6374  {.    assert(*ct
+0008c290: 785f 6461 7461 203d 3d20 4e55 4c4c 293b  x_data == NULL);
+0008c2a0: 0a20 2020 2061 7373 6572 7428 2a63 7478  .    assert(*ctx
+0008c2b0: 5f65 7661 6c20 3d3d 204e 554c 4c29 3b0a  _eval == NULL);.
+0008c2c0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+0008c2d0: 5f63 6772 6170 6820 7265 7375 6c74 203d  _cgraph result =
+0008c2e0: 207b 2030 207d 3b0a 0a20 2020 2073 7472   { 0 };..    str
+0008c2f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0008c300: 2a20 6461 7461 203d 204e 554c 4c3b 0a0a  * data = NULL;..
+0008c310: 2020 2020 2f2f 2072 6561 6420 6669 6c65      // read file
+0008c320: 2069 6e74 6f20 6461 7461 0a20 2020 207b   into data.    {
+0008c330: 0a20 2020 2020 2020 2046 494c 4520 2a20  .        FILE * 
+0008c340: 6669 6e20 3d20 666f 7065 6e28 666e 616d  fin = fopen(fnam
+0008c350: 652c 2022 7262 2229 3b0a 2020 2020 2020  e, "rb");.      
+0008c360: 2020 6966 2028 2166 696e 2920 7b0a 2020    if (!fin) {.  
+0008c370: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
+0008c380: 6628 7374 6465 7272 2c20 2225 733a 2066  f(stderr, "%s: f
+0008c390: 6169 6c65 6420 746f 206f 7065 6e20 2573  ailed to open %s
+0008c3a0: 5c6e 222c 205f 5f66 756e 635f 5f2c 2066  \n", __func__, f
+0008c3b0: 6e61 6d65 293b 0a20 2020 2020 2020 2020  name);.         
+0008c3c0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0008c3d0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+0008c3e0: 2020 2020 2073 697a 655f 7420 6673 697a       size_t fsiz
+0008c3f0: 6520 3d20 303b 0a0a 2020 2020 2020 2020  e = 0;..        
+0008c400: 6673 6565 6b28 6669 6e2c 2030 2c20 5345  fseek(fin, 0, SE
+0008c410: 454b 5f45 4e44 293b 0a20 2020 2020 2020  EK_END);.       
+0008c420: 2066 7369 7a65 203d 2066 7465 6c6c 2866   fsize = ftell(f
+0008c430: 696e 293b 0a20 2020 2020 2020 2066 7365  in);.        fse
+0008c440: 656b 2866 696e 2c20 302c 2053 4545 4b5f  ek(fin, 0, SEEK_
+0008c450: 5345 5429 3b0a 0a20 2020 2020 2020 202f  SET);..        /
+0008c460: 2f20 6372 6561 7465 2074 6865 2064 6174  / create the dat
+0008c470: 6120 636f 6e74 6578 740a 2020 2020 2020  a context.      
+0008c480: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0008c490: 636f 6e73 7420 7369 7a65 5f74 206f 7665  const size_t ove
+0008c4a0: 7268 6561 6420 3d20 312a 6767 6d6c 5f74  rhead = 1*ggml_t
+0008c4b0: 656e 736f 725f 6f76 6572 6865 6164 2829  ensor_overhead()
+0008c4c0: 3b0a 0a20 2020 2020 2020 2020 2020 2073  ;..            s
+0008c4d0: 7472 7563 7420 6767 6d6c 5f69 6e69 745f  truct ggml_init_
+0008c4e0: 7061 7261 6d73 2070 6172 616d 7320 3d20  params params = 
+0008c4f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0008c500: 2020 2e6d 656d 5f73 697a 6520 2020 3d20    .mem_size   = 
+0008c510: 6673 697a 6520 2b20 6f76 6572 6865 6164  fsize + overhead
+0008c520: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0008c530: 2020 2e6d 656d 5f62 7566 6665 7220 3d20    .mem_buffer = 
+0008c540: 4e55 4c4c 2c0a 2020 2020 2020 2020 2020  NULL,.          
+0008c550: 2020 2020 2020 2e6e 6f5f 616c 6c6f 6320        .no_alloc 
+0008c560: 2020 3d20 6661 6c73 652c 0a20 2020 2020    = false,.     
+0008c570: 2020 2020 2020 207d 3b0a 0a20 2020 2020         };..     
+0008c580: 2020 2020 2020 202a 6374 785f 6461 7461         *ctx_data
+0008c590: 203d 2067 676d 6c5f 696e 6974 2870 6172   = ggml_init(par
+0008c5a0: 616d 7329 3b0a 0a20 2020 2020 2020 2020  ams);..         
+0008c5b0: 2020 2069 6620 2821 2a63 7478 5f64 6174     if (!*ctx_dat
+0008c5c0: 6129 207b 0a20 2020 2020 2020 2020 2020  a) {.           
+0008c5d0: 2020 2020 2066 7072 696e 7466 2873 7464       fprintf(std
+0008c5e0: 6572 722c 2022 2573 3a20 6661 696c 6564  err, "%s: failed
+0008c5f0: 2074 6f20 6372 6561 7465 2067 676d 6c20   to create ggml 
+0008c600: 636f 6e74 6578 745c 6e22 2c20 5f5f 6675  context\n", __fu
+0008c610: 6e63 5f5f 293b 0a20 2020 2020 2020 2020  nc__);.         
+0008c620: 2020 2020 2020 2066 636c 6f73 6528 6669         fclose(fi
+0008c630: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
+0008c640: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0008c650: 743b 0a20 2020 2020 2020 2020 2020 207d  t;.            }
+0008c660: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0008c670: 2020 2020 6461 7461 203d 2067 676d 6c5f      data = ggml_
+0008c680: 6e65 775f 7465 6e73 6f72 5f31 6428 2a63  new_tensor_1d(*c
+0008c690: 7478 5f64 6174 612c 2047 474d 4c5f 5459  tx_data, GGML_TY
+0008c6a0: 5045 5f49 382c 2066 7369 7a65 293b 0a0a  PE_I8, fsize);..
+0008c6b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0008c6c0: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
+0008c6d0: 5f74 2072 6574 203d 2066 7265 6164 2864  _t ret = fread(d
+0008c6e0: 6174 612d 3e64 6174 612c 2073 697a 656f  ata->data, sizeo
+0008c6f0: 6628 6368 6172 292c 2066 7369 7a65 2c20  f(char), fsize, 
+0008c700: 6669 6e29 3b0a 2020 2020 2020 2020 2020  fin);.          
+0008c710: 2020 6966 2028 7265 7420 213d 2066 7369    if (ret != fsi
+0008c720: 7a65 2920 7b0a 2020 2020 2020 2020 2020  ze) {.          
+0008c730: 2020 2020 2020 6670 7269 6e74 6628 7374        fprintf(st
+0008c740: 6465 7272 2c20 2225 733a 2066 6169 6c65  derr, "%s: faile
+0008c750: 6420 746f 2072 6561 6420 2573 5c6e 222c  d to read %s\n",
+0008c760: 205f 5f66 756e 635f 5f2c 2066 6e61 6d65   __func__, fname
+0008c770: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0008c780: 2020 2066 636c 6f73 6528 6669 6e29 3b0a     fclose(fin);.
+0008c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c7a0: 7265 7475 726e 2072 6573 756c 743b 0a20  return result;. 
+0008c7b0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0008c7c0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0008c7d0: 6663 6c6f 7365 2866 696e 293b 0a20 2020  fclose(fin);.   
+0008c7e0: 207d 0a0a 2020 2020 2f2f 2070 6f70 756c   }..    // popul
+0008c7f0: 6174 6520 7265 7375 6c74 0a20 2020 207b  ate result.    {
+0008c800: 0a20 2020 2020 2020 2063 6861 7220 2a20  .        char * 
+0008c810: 7074 7220 3d20 2863 6861 7220 2a29 2064  ptr = (char *) d
+0008c820: 6174 612d 3e64 6174 613b 0a0a 2020 2020  ata->data;..    
+0008c830: 2020 2020 636f 6e73 7420 7569 6e74 3332      const uint32
+0008c840: 5f74 206d 6167 6963 203d 202a 2863 6f6e  _t magic = *(con
+0008c850: 7374 2075 696e 7433 325f 7420 2a29 2070  st uint32_t *) p
+0008c860: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
+0008c870: 6628 6d61 6769 6329 3b0a 0a20 2020 2020  f(magic);..     
+0008c880: 2020 2069 6620 286d 6167 6963 2021 3d20     if (magic != 
+0008c890: 4747 4d4c 5f46 494c 455f 4d41 4749 4329  GGML_FILE_MAGIC)
+0008c8a0: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+0008c8b0: 7072 696e 7466 2873 7464 6572 722c 2022  printf(stderr, "
+0008c8c0: 2573 3a20 696e 7661 6c69 6420 6d61 6769  %s: invalid magi
+0008c8d0: 6320 6e75 6d62 6572 2c20 676f 7420 2530  c number, got %0
+0008c8e0: 3878 5c6e 222c 205f 5f66 756e 635f 5f2c  8x\n", __func__,
+0008c8f0: 206d 6167 6963 293b 0a20 2020 2020 2020   magic);.       
+0008c900: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+0008c910: 6c74 3b0a 2020 2020 2020 2020 7d0a 0a20  lt;.        }.. 
+0008c920: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+0008c930: 7433 325f 7420 7665 7273 696f 6e20 3d20  t32_t version = 
+0008c940: 2a28 636f 6e73 7420 7569 6e74 3332 5f74  *(const uint32_t
+0008c950: 202a 2920 7074 723b 2070 7472 202b 3d20   *) ptr; ptr += 
+0008c960: 7369 7a65 6f66 2876 6572 7369 6f6e 293b  sizeof(version);
+0008c970: 0a0a 2020 2020 2020 2020 6966 2028 7665  ..        if (ve
+0008c980: 7273 696f 6e20 213d 2047 474d 4c5f 4649  rsion != GGML_FI
+0008c990: 4c45 5f56 4552 5349 4f4e 2920 7b0a 2020  LE_VERSION) {.  
+0008c9a0: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
+0008c9b0: 6628 7374 6465 7272 2c20 2225 733a 2069  f(stderr, "%s: i
+0008c9c0: 6e76 616c 6964 2076 6572 7369 6f6e 206e  nvalid version n
+0008c9d0: 756d 6265 725c 6e22 2c20 5f5f 6675 6e63  umber\n", __func
+0008c9e0: 5f5f 293b 0a20 2020 2020 2020 2020 2020  __);.           
+0008c9f0: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+0008ca00: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0008ca10: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
+0008ca20: 7420 6e5f 6c65 6166 7320 2020 3d20 2a28  t n_leafs   = *(
+0008ca30: 636f 6e73 7420 7569 6e74 3332 5f74 202a  const uint32_t *
+0008ca40: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
+0008ca50: 7a65 6f66 286e 5f6c 6561 6673 293b 0a20  zeof(n_leafs);. 
+0008ca60: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+0008ca70: 7433 325f 7420 6e5f 6e6f 6465 7320 2020  t32_t n_nodes   
+0008ca80: 3d20 2a28 636f 6e73 7420 7569 6e74 3332  = *(const uint32
+0008ca90: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
+0008caa0: 3d20 7369 7a65 6f66 286e 5f6e 6f64 6573  = sizeof(n_nodes
+0008cab0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+0008cac0: 2075 696e 7436 345f 7420 7369 7a65 5f65   uint64_t size_e
+0008cad0: 7661 6c20 3d20 2a28 636f 6e73 7420 7569  val = *(const ui
+0008cae0: 6e74 3634 5f74 202a 2920 7074 723b 2070  nt64_t *) ptr; p
+0008caf0: 7472 202b 3d20 7369 7a65 6f66 2873 697a  tr += sizeof(siz
+0008cb00: 655f 6576 616c 293b 0a0a 2020 2020 2020  e_eval);..      
+0008cb10: 2020 7265 7375 6c74 2e6e 5f6c 6561 6673    result.n_leafs
+0008cb20: 203d 206e 5f6c 6561 6673 3b0a 2020 2020   = n_leafs;.    
+0008cb30: 2020 2020 7265 7375 6c74 2e6e 5f6e 6f64      result.n_nod
+0008cb40: 6573 203d 206e 5f6e 6f64 6573 3b0a 0a20  es = n_nodes;.. 
+0008cb50: 2020 2020 2020 202f 2f20 6372 6561 7465         // create
+0008cb60: 2074 6865 2064 6174 6120 636f 6e74 6578   the data contex
+0008cb70: 740a 2020 2020 2020 2020 7b0a 2020 2020  t.        {.    
+0008cb80: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0008cb90: 7a65 5f74 206f 7665 7268 6561 6420 3d20  ze_t overhead = 
+0008cba0: 286e 5f6c 6561 6673 202b 206e 5f6e 6f64  (n_leafs + n_nod
+0008cbb0: 6573 292a 6767 6d6c 5f74 656e 736f 725f  es)*ggml_tensor_
+0008cbc0: 6f76 6572 6865 6164 2829 3b0a 0a20 2020  overhead();..   
+0008cbd0: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+0008cbe0: 6767 6d6c 5f69 6e69 745f 7061 7261 6d73  ggml_init_params
+0008cbf0: 2070 6172 616d 7320 3d20 7b0a 2020 2020   params = {.    
+0008cc00: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
+0008cc10: 5f73 697a 6520 2020 3d20 7369 7a65 5f65  _size   = size_e
+0008cc20: 7661 6c20 2b20 6f76 6572 6865 6164 2c0a  val + overhead,.
+0008cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008cc40: 2e6d 656d 5f62 7566 6665 7220 3d20 4e55  .mem_buffer = NU
+0008cc50: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
+0008cc60: 2020 2020 2e6e 6f5f 616c 6c6f 6320 2020      .no_alloc   
+0008cc70: 3d20 7472 7565 2c0a 2020 2020 2020 2020  = true,.        
+0008cc80: 2020 2020 7d3b 0a0a 2020 2020 2020 2020      };..        
+0008cc90: 2020 2020 2a63 7478 5f65 7661 6c20 3d20      *ctx_eval = 
+0008cca0: 6767 6d6c 5f69 6e69 7428 7061 7261 6d73  ggml_init(params
+0008ccb0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0008ccc0: 6966 2028 212a 6374 785f 6576 616c 2920  if (!*ctx_eval) 
+0008ccd0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0008cce0: 2020 6670 7269 6e74 6628 7374 6465 7272    fprintf(stderr
+0008ccf0: 2c20 2225 733a 2066 6169 6c65 6420 746f  , "%s: failed to
+0008cd00: 2063 7265 6174 6520 6767 6d6c 2063 6f6e   create ggml con
+0008cd10: 7465 7874 5c6e 222c 205f 5f66 756e 635f  text\n", __func_
+0008cd20: 5f29 3b0a 2020 2020 2020 2020 2020 2020  _);.            
+0008cd30: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0008cd40: 743b 0a20 2020 2020 2020 2020 2020 207d  t;.            }
+0008cd50: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0008cd60: 2020 2020 2f2f 206c 6561 6673 0a20 2020      // leafs.   
+0008cd70: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0008cd80: 2020 2075 696e 7433 325f 7420 7479 7065     uint32_t type
+0008cd90: 3b0a 2020 2020 2020 2020 2020 2020 7569  ;.            ui
+0008cda0: 6e74 3332 5f74 206f 703b 0a20 2020 2020  nt32_t op;.     
+0008cdb0: 2020 2020 2020 2075 696e 7433 325f 7420         uint32_t 
+0008cdc0: 6e5f 6469 6d73 3b0a 0a20 2020 2020 2020  n_dims;..       
+0008cdd0: 2020 2020 2066 6f72 2028 7569 6e74 3332       for (uint32
+0008cde0: 5f74 2069 203d 2030 3b20 6920 3c20 6e5f  _t i = 0; i < n_
+0008cdf0: 6c65 6166 733b 202b 2b69 2920 7b0a 2020  leafs; ++i) {.  
+0008ce00: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+0008ce10: 7065 2020 203d 202a 2863 6f6e 7374 2075  pe   = *(const u
+0008ce20: 696e 7433 325f 7420 2a29 2070 7472 3b20  int32_t *) ptr; 
+0008ce30: 7074 7220 2b3d 2073 697a 656f 6628 7479  ptr += sizeof(ty
+0008ce40: 7065 293b 0a20 2020 2020 2020 2020 2020  pe);.           
+0008ce50: 2020 2020 206f 7020 2020 2020 3d20 2a28       op     = *(
+0008ce60: 636f 6e73 7420 7569 6e74 3332 5f74 202a  const uint32_t *
+0008ce70: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
+0008ce80: 7a65 6f66 286f 7029 3b0a 2020 2020 2020  zeof(op);.      
+0008ce90: 2020 2020 2020 2020 2020 6e5f 6469 6d73            n_dims
+0008cea0: 203d 202a 2863 6f6e 7374 2075 696e 7433   = *(const uint3
+0008ceb0: 325f 7420 2a29 2070 7472 3b20 7074 7220  2_t *) ptr; ptr 
+0008cec0: 2b3d 2073 697a 656f 6628 6e5f 6469 6d73  += sizeof(n_dims
+0008ced0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0008cee0: 2020 2020 696e 7436 345f 7420 6e65 5b47      int64_t ne[G
+0008cef0: 474d 4c5f 4d41 585f 4449 4d53 5d3b 0a20  GML_MAX_DIMS];. 
+0008cf00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0008cf10: 697a 655f 7420 206e 625b 4747 4d4c 5f4d  ize_t  nb[GGML_M
+0008cf20: 4158 5f44 494d 535d 3b0a 0a20 2020 2020  AX_DIMS];..     
+0008cf30: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0008cf40: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
+0008cf50: 474d 4c5f 4d41 585f 4449 4d53 3b20 2b2b  GML_MAX_DIMS; ++
+0008cf60: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
+0008cf70: 2020 2020 2020 2020 2075 696e 7436 345f           uint64_
+0008cf80: 7420 6e65 5f63 7572 3b0a 2020 2020 2020  t ne_cur;.      
+0008cf90: 2020 2020 2020 2020 2020 2020 2020 7569                ui
+0008cfa0: 6e74 3634 5f74 206e 625f 6375 723b 0a0a  nt64_t nb_cur;..
+0008cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008cfc0: 2020 2020 6e65 5f63 7572 203d 202a 2863      ne_cur = *(c
+0008cfd0: 6f6e 7374 2075 696e 7436 345f 7420 2a29  onst uint64_t *)
+0008cfe0: 2070 7472 3b20 7074 7220 2b3d 2073 697a   ptr; ptr += siz
+0008cff0: 656f 6628 6e65 5f63 7572 293b 0a20 2020  eof(ne_cur);.   
+0008d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008d010: 206e 625f 6375 7220 3d20 2a28 636f 6e73   nb_cur = *(cons
+0008d020: 7420 7569 6e74 3634 5f74 202a 2920 7074  t uint64_t *) pt
+0008d030: 723b 2070 7472 202b 3d20 7369 7a65 6f66  r; ptr += sizeof
+0008d040: 286e 625f 6375 7229 3b0a 0a20 2020 2020  (nb_cur);..     
+0008d050: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0008d060: 655b 6a5d 203d 206e 655f 6375 723b 0a20  e[j] = ne_cur;. 
+0008d070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008d080: 2020 206e 625b 6a5d 203d 206e 625f 6375     nb[j] = nb_cu
+0008d090: 723b 0a20 2020 2020 2020 2020 2020 2020  r;.             
+0008d0a0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+0008d0b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008d0c0: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
+0008d0d0: 7220 3d20 6767 6d6c 5f6e 6577 5f74 656e  r = ggml_new_ten
+0008d0e0: 736f 7228 2a63 7478 5f65 7661 6c2c 2028  sor(*ctx_eval, (
+0008d0f0: 656e 756d 2067 676d 6c5f 7479 7065 2920  enum ggml_type) 
+0008d100: 7479 7065 2c20 6e5f 6469 6d73 2c20 6e65  type, n_dims, ne
+0008d110: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0008d120: 2020 2020 7465 6e73 6f72 2d3e 6f70 203d      tensor->op =
+0008d130: 2028 656e 756d 2067 676d 6c5f 6f70 2920   (enum ggml_op) 
+0008d140: 6f70 3b0a 0a20 2020 2020 2020 2020 2020  op;..           
+0008d150: 2020 2020 2075 696e 7436 345f 7420 7074       uint64_t pt
+0008d160: 725f 6375 7220 3d20 2a28 636f 6e73 7420  r_cur = *(const 
+0008d170: 7569 6e74 3634 5f74 202a 2920 7074 723b  uint64_t *) ptr;
+0008d180: 2070 7472 202b 3d20 7369 7a65 6f66 2870   ptr += sizeof(p
+0008d190: 7472 5f63 7572 293b 0a0a 2020 2020 2020  tr_cur);..      
+0008d1a0: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
+0008d1b0: 2874 656e 736f 722d 3e6e 616d 652c 2070  (tensor->name, p
+0008d1c0: 7472 2c20 4747 4d4c 5f4d 4158 5f4e 414d  tr, GGML_MAX_NAM
+0008d1d0: 4529 3b20 7074 7220 2b3d 2047 474d 4c5f  E); ptr += GGML_
+0008d1e0: 4d41 585f 4e41 4d45 3b0a 0a20 2020 2020  MAX_NAME;..     
+0008d1f0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0008d200: 722d 3e64 6174 6120 3d20 2876 6f69 6420  r->data = (void 
+0008d210: 2a29 2070 7472 3b0a 0a20 2020 2020 2020  *) ptr;..       
+0008d220: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0008d230: 7420 6a20 3d20 303b 206a 203c 2047 474d  t j = 0; j < GGM
+0008d240: 4c5f 4d41 585f 4449 4d53 3b20 2b2b 6a29  L_MAX_DIMS; ++j)
+0008d250: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0008d260: 2020 2020 2020 2074 656e 736f 722d 3e6e         tensor->n
+0008d270: 625b 6a5d 203d 206e 625b 6a5d 3b0a 2020  b[j] = nb[j];.  
+0008d280: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0008d290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008d2a0: 2072 6573 756c 742e 6c65 6166 735b 695d   result.leafs[i]
+0008d2b0: 203d 2074 656e 736f 723b 0a0a 2020 2020   = tensor;..    
+0008d2c0: 2020 2020 2020 2020 2020 2020 7074 7220              ptr 
+0008d2d0: 2b3d 2067 676d 6c5f 6e62 7974 6573 2874  += ggml_nbytes(t
+0008d2e0: 656e 736f 7229 3b0a 0a20 2020 2020 2020  ensor);..       
+0008d2f0: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
+0008d300: 2873 7464 6572 722c 2022 2573 3a20 6c6f  (stderr, "%s: lo
+0008d310: 6164 6564 206c 6561 6620 2564 3a20 2725  aded leaf %d: '%
+0008d320: 3136 7327 2c20 2533 6420 6469 6d73 2c20  16s', %3d dims, 
+0008d330: 2539 7a75 2062 7974 6573 5c6e 222c 205f  %9zu bytes\n", _
+0008d340: 5f66 756e 635f 5f2c 2069 2c20 7465 6e73  _func__, i, tens
+0008d350: 6f72 2d3e 6e61 6d65 2c20 6e5f 6469 6d73  or->name, n_dims
+0008d360: 2c20 6767 6d6c 5f6e 6279 7465 7328 7465  , ggml_nbytes(te
+0008d370: 6e73 6f72 2929 3b0a 2020 2020 2020 2020  nsor));.        
+0008d380: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+0008d390: 0a20 2020 2020 2020 2067 676d 6c5f 7365  .        ggml_se
+0008d3a0: 745f 6e6f 5f61 6c6c 6f63 282a 6374 785f  t_no_alloc(*ctx_
+0008d3b0: 6576 616c 2c20 6661 6c73 6529 3b0a 0a20  eval, false);.. 
+0008d3c0: 2020 2020 2020 202f 2f20 6e6f 6465 730a         // nodes.
+0008d3d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0008d3e0: 2020 2020 2020 7569 6e74 3332 5f74 2074        uint32_t t
+0008d3f0: 7970 653b 0a20 2020 2020 2020 2020 2020  ype;.           
+0008d400: 2075 696e 7433 325f 7420 6f70 3b0a 2020   uint32_t op;.  
+0008d410: 2020 2020 2020 2020 2020 7569 6e74 3332            uint32
+0008d420: 5f74 206e 5f64 696d 733b 0a0a 2020 2020  _t n_dims;..    
+0008d430: 2020 2020 2020 2020 666f 7220 2875 696e          for (uin
+0008d440: 7433 325f 7420 6920 3d20 303b 2069 203c  t32_t i = 0; i <
+0008d450: 206e 5f6e 6f64 6573 3b20 2b2b 6929 207b   n_nodes; ++i) {
+0008d460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008d470: 2074 7970 6520 2020 3d20 2a28 636f 6e73   type   = *(cons
+0008d480: 7420 7569 6e74 3332 5f74 202a 2920 7074  t uint32_t *) pt
+0008d490: 723b 2070 7472 202b 3d20 7369 7a65 6f66  r; ptr += sizeof
+0008d4a0: 2874 7970 6529 3b0a 2020 2020 2020 2020  (type);.        
+0008d4b0: 2020 2020 2020 2020 6f70 2020 2020 203d          op     =
+0008d4c0: 202a 2863 6f6e 7374 2075 696e 7433 325f   *(const uint32_
+0008d4d0: 7420 2a29 2070 7472 3b20 7074 7220 2b3d  t *) ptr; ptr +=
+0008d4e0: 2073 697a 656f 6628 6f70 293b 0a20 2020   sizeof(op);.   
+0008d4f0: 2020 2020 2020 2020 2020 2020 206e 5f64               n_d
+0008d500: 696d 7320 3d20 2a28 636f 6e73 7420 7569  ims = *(const ui
+0008d510: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
+0008d520: 7472 202b 3d20 7369 7a65 6f66 286e 5f64  tr += sizeof(n_d
+0008d530: 696d 7329 3b0a 0a20 2020 2020 2020 2020  ims);..         
+0008d540: 2020 2020 2020 2065 6e75 6d20 6767 6d6c         enum ggml
+0008d550: 5f6f 7020 656f 7020 3d20 2865 6e75 6d20  _op eop = (enum 
+0008d560: 6767 6d6c 5f6f 7029 206f 703b 0a0a 2020  ggml_op) op;..  
+0008d570: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0008d580: 7436 345f 7420 6e65 5b47 474d 4c5f 4d41  t64_t ne[GGML_MA
+0008d590: 585f 4449 4d53 5d3b 0a20 2020 2020 2020  X_DIMS];.       
+0008d5a0: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+0008d5b0: 206e 625b 4747 4d4c 5f4d 4158 5f44 494d   nb[GGML_MAX_DIM
+0008d5c0: 535d 3b0a 0a20 2020 2020 2020 2020 2020  S];..           
+0008d5d0: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+0008d5e0: 3d20 303b 206a 203c 2047 474d 4c5f 4d41  = 0; j < GGML_MA
+0008d5f0: 585f 4449 4d53 3b20 2b2b 6a29 207b 0a20  X_DIMS; ++j) {. 
+0008d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008d610: 2020 2075 696e 7436 345f 7420 6e65 5f63     uint64_t ne_c
+0008d620: 7572 3b0a 2020 2020 2020 2020 2020 2020  ur;.            
+0008d630: 2020 2020 2020 2020 7569 6e74 3634 5f74          uint64_t
+0008d640: 206e 625f 6375 723b 0a0a 2020 2020 2020   nb_cur;..      
+0008d650: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+0008d660: 5f63 7572 203d 202a 2863 6f6e 7374 2075  _cur = *(const u
+0008d670: 696e 7436 345f 7420 2a29 2070 7472 3b20  int64_t *) ptr; 
+0008d680: 7074 7220 2b3d 2073 697a 656f 6628 6e65  ptr += sizeof(ne
+0008d690: 5f63 7572 293b 0a20 2020 2020 2020 2020  _cur);.         
+0008d6a0: 2020 2020 2020 2020 2020 206e 625f 6375             nb_cu
+0008d6b0: 7220 3d20 2a28 636f 6e73 7420 7569 6e74  r = *(const uint
+0008d6c0: 3634 5f74 202a 2920 7074 723b 2070 7472  64_t *) ptr; ptr
+0008d6d0: 202b 3d20 7369 7a65 6f66 286e 625f 6375   += sizeof(nb_cu
+0008d6e0: 7229 3b0a 0a20 2020 2020 2020 2020 2020  r);..           
+0008d6f0: 2020 2020 2020 2020 206e 655b 6a5d 203d           ne[j] =
+0008d700: 206e 655f 6375 723b 0a20 2020 2020 2020   ne_cur;.       
+0008d710: 2020 2020 2020 2020 2020 2020 206e 625b               nb[
+0008d720: 6a5d 203d 206e 625f 6375 723b 0a20 2020  j] = nb_cur;.   
+0008d730: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
+0008d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008d750: 7569 6e74 3634 5f74 2070 7472 5f63 7572  uint64_t ptr_cur
+0008d760: 203d 202a 2863 6f6e 7374 2075 696e 7436   = *(const uint6
+0008d770: 345f 7420 2a29 2070 7472 3b20 7074 7220  4_t *) ptr; ptr 
+0008d780: 2b3d 2073 697a 656f 6628 7074 725f 6375  += sizeof(ptr_cu
+0008d790: 7229 3b20 2f2f 2054 4f44 4f3a 206e 6f74  r); // TODO: not
+0008d7a0: 2079 6574 2075 7365 640a 0a20 2020 2020   yet used..     
+0008d7b0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0008d7c0: 2063 6861 7220 2a20 7074 725f 6e61 6d65   char * ptr_name
+0008d7d0: 203d 2070 7472 3b20 7074 7220 2b3d 2047   = ptr; ptr += G
+0008d7e0: 474d 4c5f 4d41 585f 4e41 4d45 3b0a 0a20  GML_MAX_NAME;.. 
+0008d7f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0008d800: 6f6e 7374 2069 6e74 3332 5f74 202a 2070  onst int32_t * p
+0008d810: 7472 5f61 7267 5f69 6478 203d 2028 636f  tr_arg_idx = (co
+0008d820: 6e73 7420 696e 7433 325f 7420 2a29 2070  nst int32_t *) p
+0008d830: 7472 3b20 7074 7220 2b3d 2028 3220 2b20  tr; ptr += (2 + 
+0008d840: 4747 4d4c 5f4d 4158 5f4f 5054 292a 7369  GGML_MAX_OPT)*si
+0008d850: 7a65 6f66 2869 6e74 3332 5f74 293b 0a0a  zeof(int32_t);..
+0008d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008d870: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0008d880: 6f72 202a 2061 7267 735b 3220 2b20 4747  or * args[2 + GG
+0008d890: 4d4c 5f4d 4158 5f4f 5054 5d20 3d20 7b20  ML_MAX_OPT] = { 
+0008d8a0: 4e55 4c4c 207d 3b0a 0a20 2020 2020 2020  NULL };..       
+0008d8b0: 2020 2020 2020 2020 202f 2f20 7061 7273           // pars
+0008d8c0: 6520 6172 6773 0a20 2020 2020 2020 2020  e args.         
+0008d8d0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+0008d8e0: 6a20 3d20 303b 206a 203c 2032 202b 2047  j = 0; j < 2 + G
+0008d8f0: 474d 4c5f 4d41 585f 4f50 543b 202b 2b6a  GML_MAX_OPT; ++j
+0008d900: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008d910: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0008d920: 7433 325f 7420 6172 675f 6964 7820 3d20  t32_t arg_idx = 
+0008d930: 7074 725f 6172 675f 6964 785b 6a5d 3b0a  ptr_arg_idx[j];.
 0008d940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008d950: 202f 2f20 2276 6965 7722 206f 7065 7261   // "view" opera
-0008d960: 7469 6f6e 7320 6172 6520 6861 6e64 6c65  tions are handle
-0008d970: 6420 6469 6666 6572 656e 746c 790a 2020  d differently.  
-0008d980: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0008d990: 2054 4f44 4f3a 2068 616e 646c 6520 696e   TODO: handle in
-0008d9a0: 706c 6163 6520 6f70 7320 2d20 6375 7272  place ops - curr
-0008d9b0: 656e 746c 7920 6120 636f 7079 2069 7320  ently a copy is 
-0008d9c0: 616c 7761 7973 206d 6164 650a 0a20 2020  always made..   
-0008d9d0: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0008d9e0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0008d9f0: 2a20 7465 6e73 6f72 203d 204e 554c 4c3b  * tensor = NULL;
-0008da00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0008da10: 2020 7377 6974 6368 2028 656f 7029 207b    switch (eop) {
-0008da20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008da30: 2020 2020 202f 2f20 544f 444f 3a20 696d       // TODO: im
-0008da40: 706c 656d 656e 7420 6f74 6865 7220 7669  plement other vi
-0008da50: 6577 206f 7073 0a20 2020 2020 2020 2020  ew ops.         
-0008da60: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-0008da70: 4747 4d4c 5f4f 505f 5245 5348 4150 453a  GGML_OP_RESHAPE:
-0008da80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008da90: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0008d950: 2020 2020 2069 6620 2861 7267 5f69 6478       if (arg_idx
+0008d960: 203d 3d20 2d31 2920 7b0a 2020 2020 2020   == -1) {.      
+0008d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008d980: 2020 636f 6e74 696e 7565 3b0a 2020 2020    continue;.    
+0008d990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008d9a0: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+0008d9b0: 2020 2020 2020 2069 6620 2861 7267 5f69         if (arg_i
+0008d9c0: 6478 203c 2047 474d 4c5f 4d41 585f 4e4f  dx < GGML_MAX_NO
+0008d9d0: 4445 5329 207b 0a20 2020 2020 2020 2020  DES) {.         
+0008d9e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0008d9f0: 7267 735b 6a5d 203d 2072 6573 756c 742e  rgs[j] = result.
+0008da00: 6c65 6166 735b 6172 675f 6964 785d 3b0a  leafs[arg_idx];.
+0008da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008da20: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+0008da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008da40: 2020 2020 2061 7267 735b 6a5d 203d 2072       args[j] = r
+0008da50: 6573 756c 742e 6e6f 6465 735b 6172 675f  esult.nodes[arg_
+0008da60: 6964 7820 2d20 4747 4d4c 5f4d 4158 5f4e  idx - GGML_MAX_N
+0008da70: 4f44 4553 5d3b 0a20 2020 2020 2020 2020  ODES];.         
+0008da80: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0008da90: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
 0008daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008dab0: 2020 2020 2020 2074 656e 736f 7220 3d20         tensor = 
-0008dac0: 6767 6d6c 5f72 6573 6861 7065 5f34 6428  ggml_reshape_4d(
-0008dad0: 2a63 7478 5f65 7661 6c2c 2061 7267 735b  *ctx_eval, args[
-0008dae0: 305d 2c20 6e65 5b30 5d2c 206e 655b 315d  0], ne[0], ne[1]
-0008daf0: 2c20 6e65 5b32 5d2c 206e 655b 335d 293b  , ne[2], ne[3]);
-0008db00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008db10: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0008db20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0008db30: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0008db40: 4f50 5f56 4945 573a 0a20 2020 2020 2020  OP_VIEW:.       
-0008db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008db60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008db70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0008db80: 656e 736f 7220 3d20 6767 6d6c 5f76 6965  ensor = ggml_vie
-0008db90: 775f 3464 282a 6374 785f 6576 616c 2c20  w_4d(*ctx_eval, 
-0008dba0: 6172 6773 5b30 5d2c 206e 655b 305d 2c20  args[0], ne[0], 
-0008dbb0: 6e65 5b31 5d2c 206e 655b 325d 2c20 6e65  ne[1], ne[2], ne
-0008dbc0: 5b33 5d2c 2030 2c20 302c 2030 2c20 3029  [3], 0, 0, 0, 0)
-0008dbd0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0008dbe0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0008dbf0: 696e 7436 345f 7420 6f66 6673 3b0a 2020  int64_t offs;.  
-0008dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008dc10: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
-0008dc20: 2826 6f66 6673 2c20 6172 6773 5b32 5d2d  (&offs, args[2]-
-0008dc30: 3e64 6174 612c 2073 697a 656f 6628 6f66  >data, sizeof(of
-0008dc40: 6673 2929 3b0a 0a20 2020 2020 2020 2020  fs));..         
-0008dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008dc60: 2020 2074 656e 736f 722d 3e64 6174 6120     tensor->data 
-0008dc70: 3d20 2828 6368 6172 202a 2920 7465 6e73  = ((char *) tens
-0008dc80: 6f72 2d3e 6461 7461 2920 2b20 6f66 6673  or->data) + offs
-0008dc90: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0008dca0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0008dcb0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-0008dcc0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0008dcd0: 5f4f 505f 5452 414e 5350 4f53 453a 0a20  _OP_TRANSPOSE:. 
-0008dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008dcf0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0008dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008dd10: 2020 2020 2074 656e 736f 7220 3d20 6767       tensor = gg
-0008dd20: 6d6c 5f74 7261 6e73 706f 7365 282a 6374  ml_transpose(*ct
-0008dd30: 785f 6576 616c 2c20 6172 6773 5b30 5d29  x_eval, args[0])
-0008dd40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0008dd50: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0008dd60: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-0008dd70: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0008dd80: 5f4f 505f 5045 524d 5554 453a 0a20 2020  _OP_PERMUTE:.   
-0008dd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008dda0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0008ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ddc0: 2020 2074 656e 736f 7220 3d20 6767 6d6c     tensor = ggml
-0008ddd0: 5f76 6965 775f 3464 282a 6374 785f 6576  _view_4d(*ctx_ev
-0008dde0: 616c 2c20 6172 6773 5b30 5d2c 206e 655b  al, args[0], ne[
-0008ddf0: 305d 2c20 6e65 5b31 5d2c 206e 655b 325d  0], ne[1], ne[2]
-0008de00: 2c20 6e65 5b33 5d2c 2030 2c20 302c 2030  , ne[3], 0, 0, 0
-0008de10: 2c20 3029 3b0a 2020 2020 2020 2020 2020  , 0);.          
+0008dab0: 2f2f 2063 7265 6174 6520 7468 6520 7465  // create the te
+0008dac0: 6e73 6f72 0a20 2020 2020 2020 2020 2020  nsor.           
+0008dad0: 2020 2020 202f 2f20 2276 6965 7722 206f       // "view" o
+0008dae0: 7065 7261 7469 6f6e 7320 6172 6520 6861  perations are ha
+0008daf0: 6e64 6c65 6420 6469 6666 6572 656e 746c  ndled differentl
+0008db00: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0008db10: 2020 2f2f 2054 4f44 4f3a 2068 616e 646c    // TODO: handl
+0008db20: 6520 696e 706c 6163 6520 6f70 7320 2d20  e inplace ops - 
+0008db30: 6375 7272 656e 746c 7920 6120 636f 7079  currently a copy
+0008db40: 2069 7320 616c 7761 7973 206d 6164 650a   is always made.
+0008db50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008db60: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0008db70: 736f 7220 2a20 7465 6e73 6f72 203d 204e  sor * tensor = N
+0008db80: 554c 4c3b 0a0a 2020 2020 2020 2020 2020  ULL;..          
+0008db90: 2020 2020 2020 7377 6974 6368 2028 656f        switch (eo
+0008dba0: 7029 207b 0a20 2020 2020 2020 2020 2020  p) {.           
+0008dbb0: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
+0008dbc0: 3a20 696d 706c 656d 656e 7420 6f74 6865  : implement othe
+0008dbd0: 7220 7669 6577 206f 7073 0a20 2020 2020  r view ops.     
+0008dbe0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0008dbf0: 6173 6520 4747 4d4c 5f4f 505f 5245 5348  ase GGML_OP_RESH
+0008dc00: 4150 453a 0a20 2020 2020 2020 2020 2020  APE:.           
+0008dc10: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+0008dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008dc30: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0008dc40: 7220 3d20 6767 6d6c 5f72 6573 6861 7065  r = ggml_reshape
+0008dc50: 5f34 6428 2a63 7478 5f65 7661 6c2c 2061  _4d(*ctx_eval, a
+0008dc60: 7267 735b 305d 2c20 6e65 5b30 5d2c 206e  rgs[0], ne[0], n
+0008dc70: 655b 315d 2c20 6e65 5b32 5d2c 206e 655b  e[1], ne[2], ne[
+0008dc80: 335d 293b 0a20 2020 2020 2020 2020 2020  3]);.           
+0008dc90: 2020 2020 2020 2020 2020 2020 207d 2062               } b
+0008dca0: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
+0008dcb0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+0008dcc0: 474d 4c5f 4f50 5f56 4945 573a 0a20 2020  GML_OP_VIEW:.   
+0008dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008dce0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0008dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008dd00: 2020 2074 656e 736f 7220 3d20 6767 6d6c     tensor = ggml
+0008dd10: 5f76 6965 775f 3464 282a 6374 785f 6576  _view_4d(*ctx_ev
+0008dd20: 616c 2c20 6172 6773 5b30 5d2c 206e 655b  al, args[0], ne[
+0008dd30: 305d 2c20 6e65 5b31 5d2c 206e 655b 325d  0], ne[1], ne[2]
+0008dd40: 2c20 6e65 5b33 5d2c 2030 2c20 302c 2030  , ne[3], 0, 0, 0
+0008dd50: 2c20 3029 3b0a 0a20 2020 2020 2020 2020  , 0);..         
+0008dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008dd70: 2020 2075 696e 7436 345f 7420 6f66 6673     uint64_t offs
+0008dd80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0008dd90: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+0008dda0: 6d63 7079 2826 6f66 6673 2c20 6172 6773  mcpy(&offs, args
+0008ddb0: 5b32 5d2d 3e64 6174 612c 2073 697a 656f  [2]->data, sizeo
+0008ddc0: 6628 6f66 6673 2929 3b0a 0a20 2020 2020  f(offs));..     
+0008ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008dde0: 2020 2020 2020 2074 656e 736f 722d 3e64         tensor->d
+0008ddf0: 6174 6120 3d20 2828 6368 6172 202a 2920  ata = ((char *) 
+0008de00: 7465 6e73 6f72 2d3e 6461 7461 2920 2b20  tensor->data) + 
+0008de10: 6f66 6673 3b0a 2020 2020 2020 2020 2020  offs;.          
 0008de20: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
 0008de30: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-0008de40: 2020 2020 2020 2020 2020 2064 6566 6175             defau
-0008de50: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
-0008de60: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0008de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008de80: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-0008de90: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
-0008dea0: 6f72 282a 6374 785f 6576 616c 2c20 2865  or(*ctx_eval, (e
-0008deb0: 6e75 6d20 6767 6d6c 5f74 7970 6529 2074  num ggml_type) t
-0008dec0: 7970 652c 206e 5f64 696d 732c 206e 6529  ype, n_dims, ne)
-0008ded0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0008dee0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0008def0: 656e 736f 722d 3e6f 7020 3d20 656f 703b  ensor->op = eop;
-0008df00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008df10: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0008df20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0008df30: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-0008df40: 2020 2020 206d 656d 6370 7928 7465 6e73       memcpy(tens
-0008df50: 6f72 2d3e 6e61 6d65 2c20 7074 725f 6e61  or->name, ptr_na
-0008df60: 6d65 2c20 4747 4d4c 5f4d 4158 5f4e 414d  me, GGML_MAX_NAM
-0008df70: 4529 3b0a 0a20 2020 2020 2020 2020 2020  E);..           
-0008df80: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-0008df90: 3d20 303b 206a 203c 2047 474d 4c5f 4d41  = 0; j < GGML_MA
-0008dfa0: 585f 4449 4d53 3b20 2b2b 6a29 207b 0a20  X_DIMS; ++j) {. 
-0008dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008dfc0: 2020 2074 656e 736f 722d 3e6e 625b 6a5d     tensor->nb[j]
-0008dfd0: 203d 206e 625b 6a5d 3b0a 2020 2020 2020   = nb[j];.      
-0008dfe0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0008dff0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-0008e000: 736f 722d 3e73 7263 3020 3d20 6172 6773  sor->src0 = args
-0008e010: 5b30 5d3b 0a20 2020 2020 2020 2020 2020  [0];.           
-0008e020: 2020 2020 2074 656e 736f 722d 3e73 7263       tensor->src
-0008e030: 3120 3d20 6172 6773 5b31 5d3b 0a0a 2020  1 = args[1];..  
-0008e040: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0008e050: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
-0008e060: 3c20 4747 4d4c 5f4d 4158 5f4f 5054 3b20  < GGML_MAX_OPT; 
-0008e070: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
-0008e080: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0008e090: 722d 3e6f 7074 5b6a 5d20 3d20 6172 6773  r->opt[j] = args
-0008e0a0: 5b32 202b 206a 5d3b 0a20 2020 2020 2020  [2 + j];.       
-0008e0b0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-0008e0c0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-0008e0d0: 6c74 2e6e 6f64 6573 5b69 5d20 3d20 7465  lt.nodes[i] = te
-0008e0e0: 6e73 6f72 3b0a 0a20 2020 2020 2020 2020  nsor;..         
-0008e0f0: 2020 2020 2020 2066 7072 696e 7466 2873         fprintf(s
-0008e100: 7464 6572 722c 2022 2573 3a20 6c6f 6164  tderr, "%s: load
-0008e110: 6564 206e 6f64 6520 2564 3a20 2725 3136  ed node %d: '%16
-0008e120: 7327 2c20 2533 6420 6469 6d73 2c20 2539  s', %3d dims, %9
-0008e130: 7a75 2062 7974 6573 5c6e 222c 205f 5f66  zu bytes\n", __f
-0008e140: 756e 635f 5f2c 2069 2c20 7465 6e73 6f72  unc__, i, tensor
-0008e150: 2d3e 6e61 6d65 2c20 6e5f 6469 6d73 2c20  ->name, n_dims, 
-0008e160: 6767 6d6c 5f6e 6279 7465 7328 7465 6e73  ggml_nbytes(tens
-0008e170: 6f72 2929 3b0a 2020 2020 2020 2020 2020  or));.          
-0008e180: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-0008e190: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-0008e1a0: 7265 7375 6c74 3b0a 7d0a 0a76 6f69 6420  result;.}..void 
-0008e1b0: 6767 6d6c 5f67 7261 7068 5f70 7269 6e74  ggml_graph_print
-0008e1c0: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
-0008e1d0: 6d6c 5f63 6772 6170 6820 2a20 6367 7261  ml_cgraph * cgra
-0008e1e0: 7068 2920 7b0a 2020 2020 696e 7436 345f  ph) {.    int64_
-0008e1f0: 7420 7065 7266 5f74 6f74 616c 5f70 6572  t perf_total_per
-0008e200: 5f6f 705f 7573 5b47 474d 4c5f 4f50 5f43  _op_us[GGML_OP_C
-0008e210: 4f55 4e54 5d20 3d20 7b30 7d3b 0a0a 2020  OUNT] = {0};..  
-0008e220: 2020 4747 4d4c 5f50 5249 4e54 2822 3d3d    GGML_PRINT("==
-0008e230: 3d20 4752 4150 4820 3d3d 3d5c 6e22 293b  = GRAPH ===\n");
-0008e240: 0a0a 2020 2020 4747 4d4c 5f50 5249 4e54  ..    GGML_PRINT
-0008e250: 5f44 4542 5547 2822 6e5f 7468 7265 6164  _DEBUG("n_thread
-0008e260: 7320 2020 2020 2020 3d20 2564 5c6e 222c  s       = %d\n",
-0008e270: 2020 2020 2020 2020 6367 7261 7068 2d3e          cgraph->
-0008e280: 6e5f 7468 7265 6164 7329 3b0a 2020 2020  n_threads);.    
-0008e290: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
-0008e2a0: 2822 746f 7461 6c20 776f 726b 2073 697a  ("total work siz
-0008e2b0: 6520 3d20 257a 7520 6279 7465 735c 6e22  e = %zu bytes\n"
-0008e2c0: 2c20 6367 7261 7068 2d3e 776f 726b 5f73  , cgraph->work_s
-0008e2d0: 697a 6529 3b0a 0a20 2020 2047 474d 4c5f  ize);..    GGML_
-0008e2e0: 5052 494e 5428 226e 5f6e 6f64 6573 203d  PRINT("n_nodes =
-0008e2f0: 2025 645c 6e22 2c20 6367 7261 7068 2d3e   %d\n", cgraph->
-0008e300: 6e5f 6e6f 6465 7329 3b0a 2020 2020 666f  n_nodes);.    fo
-0008e310: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0008e320: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
-0008e330: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-0008e340: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0008e350: 6e73 6f72 202a 206e 6f64 6520 3d20 6367  nsor * node = cg
-0008e360: 7261 7068 2d3e 6e6f 6465 735b 695d 3b0a  raph->nodes[i];.
-0008e370: 0a20 2020 2020 2020 2070 6572 665f 746f  .        perf_to
-0008e380: 7461 6c5f 7065 725f 6f70 5f75 735b 6e6f  tal_per_op_us[no
-0008e390: 6465 2d3e 6f70 5d20 2b3d 204d 4158 2831  de->op] += MAX(1
-0008e3a0: 2c20 6e6f 6465 2d3e 7065 7266 5f74 696d  , node->perf_tim
-0008e3b0: 655f 7573 293b 0a0a 2020 2020 2020 2020  e_us);..        
-0008e3c0: 4747 4d4c 5f50 5249 4e54 2822 202d 2025  GGML_PRINT(" - %
-0008e3d0: 3364 3a20 5b20 2535 2220 5052 4964 3634  3d: [ %5" PRId64
-0008e3e0: 2022 2c20 2535 2220 5052 4964 3634 2022   ", %5" PRId64 "
-0008e3f0: 2c20 2535 2220 5052 4964 3634 2022 5d20  , %5" PRId64 "] 
-0008e400: 2531 3673 2025 7320 2825 3364 2920 6370  %16s %s (%3d) cp
-0008e410: 7520 3d20 2537 2e33 6620 2f20 2537 2e33  u = %7.3f / %7.3
-0008e420: 6620 6d73 2c20 7761 6c6c 203d 2025 372e  f ms, wall = %7.
-0008e430: 3366 202f 2025 372e 3366 206d 735c 6e22  3f / %7.3f ms\n"
-0008e440: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0008e450: 2020 692c 0a20 2020 2020 2020 2020 2020    i,.           
-0008e460: 2020 2020 206e 6f64 652d 3e6e 655b 305d       node->ne[0]
-0008e470: 2c20 6e6f 6465 2d3e 6e65 5b31 5d2c 206e  , node->ne[1], n
-0008e480: 6f64 652d 3e6e 655b 325d 2c0a 2020 2020  ode->ne[2],.    
-0008e490: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0008e4a0: 5f4f 505f 4e41 4d45 5b6e 6f64 652d 3e6f  _OP_NAME[node->o
-0008e4b0: 705d 2c20 6e6f 6465 2d3e 6973 5f70 6172  p], node->is_par
-0008e4c0: 616d 203f 2022 7822 203a 206e 6f64 652d  am ? "x" : node-
-0008e4d0: 3e67 7261 6420 3f20 2267 2220 3a20 2220  >grad ? "g" : " 
-0008e4e0: 222c 206e 6f64 652d 3e70 6572 665f 7275  ", node->perf_ru
-0008e4f0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-0008e500: 2020 2020 2864 6f75 626c 6529 206e 6f64      (double) nod
-0008e510: 652d 3e70 6572 665f 6379 636c 6573 2020  e->perf_cycles  
-0008e520: 2f20 2864 6f75 626c 6529 2067 676d 6c5f  / (double) ggml_
-0008e530: 6379 636c 6573 5f70 6572 5f6d 7328 292c  cycles_per_ms(),
-0008e540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008e550: 2028 646f 7562 6c65 2920 6e6f 6465 2d3e   (double) node->
-0008e560: 7065 7266 5f63 7963 6c65 7320 202f 2028  perf_cycles  / (
-0008e570: 646f 7562 6c65 2920 6767 6d6c 5f63 7963  double) ggml_cyc
-0008e580: 6c65 735f 7065 725f 6d73 2829 202f 2028  les_per_ms() / (
-0008e590: 646f 7562 6c65 2920 6e6f 6465 2d3e 7065  double) node->pe
-0008e5a0: 7266 5f72 756e 732c 0a20 2020 2020 2020  rf_runs,.       
-0008e5b0: 2020 2020 2020 2020 2028 646f 7562 6c65           (double
-0008e5c0: 2920 6e6f 6465 2d3e 7065 7266 5f74 696d  ) node->perf_tim
-0008e5d0: 655f 7573 202f 2031 3030 302e 302c 0a20  e_us / 1000.0,. 
-0008e5e0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0008e5f0: 646f 7562 6c65 2920 6e6f 6465 2d3e 7065  double) node->pe
-0008e600: 7266 5f74 696d 655f 7573 202f 2031 3030  rf_time_us / 100
-0008e610: 302e 3020 2f20 6e6f 6465 2d3e 7065 7266  0.0 / node->perf
-0008e620: 5f72 756e 7329 3b0a 2020 2020 7d0a 0a20  _runs);.    }.. 
-0008e630: 2020 2047 474d 4c5f 5052 494e 5428 226e     GGML_PRINT("n
-0008e640: 5f6c 6561 6673 203d 2025 645c 6e22 2c20  _leafs = %d\n", 
-0008e650: 6367 7261 7068 2d3e 6e5f 6c65 6166 7329  cgraph->n_leafs)
-0008e660: 3b0a 2020 2020 666f 7220 2869 6e74 2069  ;.    for (int i
-0008e670: 203d 2030 3b20 6920 3c20 6367 7261 7068   = 0; i < cgraph
-0008e680: 2d3e 6e5f 6c65 6166 733b 2069 2b2b 2920  ->n_leafs; i++) 
-0008e690: 7b0a 2020 2020 2020 2020 7374 7275 6374  {.        struct
-0008e6a0: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
-0008e6b0: 6f64 6520 3d20 6367 7261 7068 2d3e 6c65  ode = cgraph->le
-0008e6c0: 6166 735b 695d 3b0a 0a20 2020 2020 2020  afs[i];..       
-0008e6d0: 2047 474d 4c5f 5052 494e 5428 2220 2d20   GGML_PRINT(" - 
-0008e6e0: 2533 643a 205b 2025 3522 2050 5249 6436  %3d: [ %5" PRId6
-0008e6f0: 3420 222c 2025 3522 2050 5249 6436 3420  4 ", %5" PRId64 
-0008e700: 225d 2025 3873 5c6e 222c 0a20 2020 2020  "] %8s\n",.     
-0008e710: 2020 2020 2020 2020 2020 2069 2c0a 2020             i,.  
-0008e720: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-0008e730: 6465 2d3e 6e65 5b30 5d2c 206e 6f64 652d  de->ne[0], node-
-0008e740: 3e6e 655b 315d 2c0a 2020 2020 2020 2020  >ne[1],.        
-0008e750: 2020 2020 2020 2020 4747 4d4c 5f4f 505f          GGML_OP_
-0008e760: 4e41 4d45 5b6e 6f64 652d 3e6f 705d 293b  NAME[node->op]);
-0008e770: 0a20 2020 207d 0a0a 2020 2020 666f 7220  .    }..    for 
-0008e780: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-0008e790: 4747 4d4c 5f4f 505f 434f 554e 543b 2069  GGML_OP_COUNT; i
-0008e7a0: 2b2b 2920 7b0a 2020 2020 2020 2020 6966  ++) {.        if
-0008e7b0: 2028 7065 7266 5f74 6f74 616c 5f70 6572   (perf_total_per
-0008e7c0: 5f6f 705f 7573 5b69 5d20 3d3d 2030 2920  _op_us[i] == 0) 
-0008e7d0: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
-0008e7e0: 6e74 696e 7565 3b0a 2020 2020 2020 2020  ntinue;.        
-0008e7f0: 7d0a 0a20 2020 2020 2020 2047 474d 4c5f  }..        GGML_
-0008e800: 5052 494e 5428 2270 6572 665f 746f 7461  PRINT("perf_tota
-0008e810: 6c5f 7065 725f 6f70 5f75 735b 2531 3673  l_per_op_us[%16s
-0008e820: 5d20 3d20 2537 2e33 6620 6d73 5c6e 222c  ] = %7.3f ms\n",
-0008e830: 2047 474d 4c5f 4f50 5f4e 414d 455b 695d   GGML_OP_NAME[i]
-0008e840: 2c20 2864 6f75 626c 6529 2070 6572 665f  , (double) perf_
-0008e850: 746f 7461 6c5f 7065 725f 6f70 5f75 735b  total_per_op_us[
-0008e860: 695d 202f 2031 3030 302e 3029 3b0a 2020  i] / 1000.0);.  
-0008e870: 2020 7d0a 0a20 2020 2047 474d 4c5f 5052    }..    GGML_PR
-0008e880: 494e 5428 223d 3d3d 3d3d 3d3d 3d3d 3d3d  INT("===========
-0008e890: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0008e8a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d5c 6e22  =============\n"
-0008e8b0: 293b 0a7d 0a0a 2f2f 2063 6865 636b 2069  );.}..// check i
-0008e8c0: 6620 6e6f 6465 2069 7320 7061 7274 206f  f node is part o
-0008e8d0: 6620 7468 6520 6772 6170 680a 7374 6174  f the graph.stat
-0008e8e0: 6963 2062 6f6f 6c20 6767 6d6c 5f67 7261  ic bool ggml_gra
-0008e8f0: 7068 5f66 696e 6428 636f 6e73 7420 7374  ph_find(const st
-0008e900: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
-0008e910: 202a 2063 6772 6170 682c 2063 6f6e 7374   * cgraph, const
-0008e920: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0008e930: 736f 7220 2a20 6e6f 6465 2920 7b0a 2020  sor * node) {.  
-0008e940: 2020 6966 2028 6367 7261 7068 203d 3d20    if (cgraph == 
-0008e950: 4e55 4c4c 2920 7b0a 2020 2020 2020 2020  NULL) {.        
-0008e960: 7265 7475 726e 2074 7275 653b 0a20 2020  return true;.   
-0008e970: 207d 0a0a 2020 2020 666f 7220 2869 6e74   }..    for (int
-0008e980: 2069 203d 2030 3b20 6920 3c20 6367 7261   i = 0; i < cgra
-0008e990: 7068 2d3e 6e5f 6e6f 6465 733b 2069 2b2b  ph->n_nodes; i++
-0008e9a0: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
-0008e9b0: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
-0008e9c0: 203d 3d20 6e6f 6465 2920 7b0a 2020 2020   == node) {.    
-0008e9d0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0008e9e0: 7275 653b 0a20 2020 2020 2020 207d 0a20  rue;.        }. 
-0008e9f0: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
-0008ea00: 2066 616c 7365 3b0a 7d0a 0a73 7461 7469   false;.}..stati
-0008ea10: 6320 7374 7275 6374 2067 676d 6c5f 7465  c struct ggml_te
-0008ea20: 6e73 6f72 202a 2067 676d 6c5f 6772 6170  nsor * ggml_grap
-0008ea30: 685f 6765 745f 7061 7265 6e74 2863 6f6e  h_get_parent(con
-0008ea40: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-0008ea50: 6772 6170 6820 2a20 6367 7261 7068 2c20  graph * cgraph, 
-0008ea60: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0008ea70: 6c5f 7465 6e73 6f72 202a 206e 6f64 6529  l_tensor * node)
-0008ea80: 207b 0a20 2020 2066 6f72 2028 696e 7420   {.    for (int 
-0008ea90: 6920 3d20 303b 2069 203c 2063 6772 6170  i = 0; i < cgrap
-0008eaa0: 682d 3e6e 5f6e 6f64 6573 3b20 692b 2b29  h->n_nodes; i++)
-0008eab0: 207b 0a20 2020 2020 2020 2073 7472 7563   {.        struc
-0008eac0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0008ead0: 7061 7265 6e74 203d 2063 6772 6170 682d  parent = cgraph-
-0008eae0: 3e6e 6f64 6573 5b69 5d3b 0a0a 2020 2020  >nodes[i];..    
-0008eaf0: 2020 2020 6966 2028 7061 7265 6e74 2d3e      if (parent->
-0008eb00: 6772 6164 203d 3d20 6e6f 6465 2920 7b0a  grad == node) {.
-0008eb10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0008eb20: 726e 2070 6172 656e 743b 0a20 2020 2020  rn parent;.     
-0008eb30: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
-0008eb40: 7265 7475 726e 204e 554c 4c3b 0a7d 0a0a  return NULL;.}..
-0008eb50: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-0008eb60: 5f67 7261 7068 5f64 756d 705f 646f 745f  _graph_dump_dot_
-0008eb70: 6e6f 6465 5f65 6467 6528 4649 4c45 202a  node_edge(FILE *
-0008eb80: 2066 702c 2063 6f6e 7374 2073 7472 7563   fp, const struc
-0008eb90: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-0008eba0: 6762 2c20 7374 7275 6374 2067 676d 6c5f  gb, struct ggml_
-0008ebb0: 7465 6e73 6f72 202a 206e 6f64 652c 2073  tensor * node, s
-0008ebc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0008ebd0: 7220 2a20 7061 7265 6e74 2c20 636f 6e73  r * parent, cons
-0008ebe0: 7420 6368 6172 202a 206c 6162 656c 2920  t char * label) 
-0008ebf0: 207b 0a20 2020 2073 7472 7563 7420 6767   {.    struct gg
-0008ec00: 6d6c 5f74 656e 736f 7220 2a20 6770 6172  ml_tensor * gpar
-0008ec10: 656e 7420 3d20 6767 6d6c 5f67 7261 7068  ent = ggml_graph
-0008ec20: 5f67 6574 5f70 6172 656e 7428 6762 2c20  _get_parent(gb, 
-0008ec30: 6e6f 6465 293b 0a20 2020 2073 7472 7563  node);.    struc
-0008ec40: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0008ec50: 6770 6172 656e 7430 203d 2067 676d 6c5f  gparent0 = ggml_
-0008ec60: 6772 6170 685f 6765 745f 7061 7265 6e74  graph_get_parent
-0008ec70: 2867 622c 2070 6172 656e 7429 3b0a 2020  (gb, parent);.  
-0008ec80: 2020 6670 7269 6e74 6628 6670 2c20 2220    fprintf(fp, " 
-0008ec90: 205c 2225 705c 223a 2573 202d 3e20 5c22   \"%p\":%s -> \"
-0008eca0: 2570 5c22 3a25 7320 5b20 6172 726f 7768  %p\":%s [ arrowh
-0008ecb0: 6561 6420 3d20 2573 3b20 7374 796c 6520  ead = %s; style 
-0008ecc0: 3d20 2573 3b20 6c61 6265 6c20 3d20 5c22  = %s; label = \"
-0008ecd0: 2573 5c22 3b20 5d5c 6e22 2c0a 2020 2020  %s\"; ]\n",.    
-0008ece0: 2020 2020 2020 2020 6770 6172 656e 7430          gparent0
-0008ecf0: 203f 2028 766f 6964 202a 2920 6770 6172   ? (void *) gpar
-0008ed00: 656e 7430 203a 2028 766f 6964 202a 2920  ent0 : (void *) 
-0008ed10: 7061 7265 6e74 2c0a 2020 2020 2020 2020  parent,.        
-0008ed20: 2020 2020 6770 6172 656e 7430 203f 2022      gparent0 ? "
-0008ed30: 6722 203a 2022 7822 2c0a 2020 2020 2020  g" : "x",.      
-0008ed40: 2020 2020 2020 6770 6172 656e 7420 3f20        gparent ? 
-0008ed50: 2876 6f69 6420 2a29 2067 7061 7265 6e74  (void *) gparent
-0008ed60: 203a 2028 766f 6964 202a 2920 6e6f 6465   : (void *) node
-0008ed70: 2c0a 2020 2020 2020 2020 2020 2020 6770  ,.            gp
-0008ed80: 6172 656e 7420 3f20 2267 2220 3a20 2278  arent ? "g" : "x
-0008ed90: 222c 0a20 2020 2020 2020 2020 2020 2067  ",.            g
-0008eda0: 7061 7265 6e74 203f 2022 656d 7074 7922  parent ? "empty"
-0008edb0: 203a 2022 7665 6522 2c0a 2020 2020 2020   : "vee",.      
-0008edc0: 2020 2020 2020 6770 6172 656e 7420 3f20        gparent ? 
-0008edd0: 2264 6173 6865 6422 203a 2022 736f 6c69  "dashed" : "soli
-0008ede0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-0008edf0: 6c61 6265 6c29 3b0a 7d0a 0a73 7461 7469  label);.}..stati
-0008ee00: 6320 766f 6964 2067 676d 6c5f 6772 6170  c void ggml_grap
-0008ee10: 685f 6475 6d70 5f64 6f74 5f6c 6561 665f  h_dump_dot_leaf_
-0008ee20: 6564 6765 2846 494c 4520 2a20 6670 2c20  edge(FILE * fp, 
-0008ee30: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0008ee40: 6f72 202a 206e 6f64 652c 2073 7472 7563  or * node, struc
-0008ee50: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0008ee60: 7061 7265 6e74 2c20 636f 6e73 7420 6368  parent, const ch
-0008ee70: 6172 202a 206c 6162 656c 2920 207b 0a20  ar * label)  {. 
-0008ee80: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
-0008ee90: 2020 5c22 2570 5c22 3a25 7320 2d3e 205c    \"%p\":%s -> \
-0008eea0: 2225 705c 223a 2573 205b 206c 6162 656c  "%p\":%s [ label
-0008eeb0: 203d 205c 2225 735c 223b 205d 5c6e 222c   = \"%s\"; ]\n",
-0008eec0: 0a20 2020 2020 2020 2020 2020 2028 766f  .            (vo
-0008eed0: 6964 202a 2920 7061 7265 6e74 2c20 2278  id *) parent, "x
-0008eee0: 222c 0a20 2020 2020 2020 2020 2020 2028  ",.            (
-0008eef0: 766f 6964 202a 2920 6e6f 6465 2c20 2278  void *) node, "x
-0008ef00: 222c 0a20 2020 2020 2020 2020 2020 206c  ",.            l
-0008ef10: 6162 656c 293b 0a7d 0a0a 766f 6964 2067  abel);.}..void g
-0008ef20: 676d 6c5f 6772 6170 685f 6475 6d70 5f64  gml_graph_dump_d
-0008ef30: 6f74 2863 6f6e 7374 2073 7472 7563 7420  ot(const struct 
-0008ef40: 6767 6d6c 5f63 6772 6170 6820 2a20 6762  ggml_cgraph * gb
-0008ef50: 2c20 636f 6e73 7420 7374 7275 6374 2067  , const struct g
-0008ef60: 676d 6c5f 6367 7261 7068 202a 2067 662c  gml_cgraph * gf,
-0008ef70: 2063 6f6e 7374 2063 6861 7220 2a20 6669   const char * fi
-0008ef80: 6c65 6e61 6d65 2920 7b0a 2020 2020 6368  lename) {.    ch
-0008ef90: 6172 2063 6f6c 6f72 5b31 365d 3b0a 0a20  ar color[16];.. 
-0008efa0: 2020 2046 494c 4520 2a20 6670 203d 2066     FILE * fp = f
-0008efb0: 6f70 656e 2866 696c 656e 616d 652c 2022  open(filename, "
-0008efc0: 7722 293b 0a20 2020 2047 474d 4c5f 4153  w");.    GGML_AS
-0008efd0: 5345 5254 2866 7029 3b0a 0a20 2020 2066  SERT(fp);..    f
-0008efe0: 7072 696e 7466 2866 702c 2022 6469 6772  printf(fp, "digr
-0008eff0: 6170 6820 4720 7b5c 6e22 293b 0a20 2020  aph G {\n");.   
-0008f000: 2066 7072 696e 7466 2866 702c 2022 2020   fprintf(fp, "  
-0008f010: 6e65 7772 616e 6b20 3d20 7472 7565 3b5c  newrank = true;\
-0008f020: 6e22 293b 0a20 2020 2066 7072 696e 7466  n");.    fprintf
-0008f030: 2866 702c 2022 2020 7261 6e6b 6469 7220  (fp, "  rankdir 
-0008f040: 3d20 4c52 3b5c 6e22 293b 0a0a 2020 2020  = LR;\n");..    
-0008f050: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0008f060: 6920 3c20 6762 2d3e 6e5f 6e6f 6465 733b  i < gb->n_nodes;
-0008f070: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-0008f080: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0008f090: 6f72 202a 206e 6f64 6520 3d20 6762 2d3e  or * node = gb->
-0008f0a0: 6e6f 6465 735b 695d 3b0a 0a20 2020 2020  nodes[i];..     
-0008f0b0: 2020 2069 6620 2867 676d 6c5f 6772 6170     if (ggml_grap
-0008f0c0: 685f 6765 745f 7061 7265 6e74 2867 622c  h_get_parent(gb,
-0008f0d0: 206e 6f64 6529 2021 3d20 4e55 4c4c 2920   node) != NULL) 
-0008f0e0: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
-0008f0f0: 6e74 696e 7565 3b0a 2020 2020 2020 2020  ntinue;.        
-0008f100: 7d0a 0a20 2020 2020 2020 2069 6620 286e  }..        if (n
-0008f110: 6f64 652d 3e69 735f 7061 7261 6d29 207b  ode->is_param) {
-0008f120: 0a20 2020 2020 2020 2020 2020 2073 6e70  .            snp
-0008f130: 7269 6e74 6628 636f 6c6f 722c 2073 697a  rintf(color, siz
-0008f140: 656f 6628 636f 6c6f 7229 2c20 2279 656c  eof(color), "yel
-0008f150: 6c6f 7722 293b 0a20 2020 2020 2020 207d  low");.        }
-0008f160: 2065 6c73 6520 6966 2028 6e6f 6465 2d3e   else if (node->
-0008f170: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0008f180: 2020 2020 6966 2028 6767 6d6c 5f67 7261      if (ggml_gra
-0008f190: 7068 5f66 696e 6428 6766 2c20 6e6f 6465  ph_find(gf, node
-0008f1a0: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
-0008f1b0: 2020 2020 2073 6e70 7269 6e74 6628 636f       snprintf(co
-0008f1c0: 6c6f 722c 2073 697a 656f 6628 636f 6c6f  lor, sizeof(colo
-0008f1d0: 7229 2c20 2267 7265 656e 2229 3b0a 2020  r), "green");.  
-0008f1e0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-0008f1f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008f200: 2020 2073 6e70 7269 6e74 6628 636f 6c6f     snprintf(colo
-0008f210: 722c 2073 697a 656f 6628 636f 6c6f 7229  r, sizeof(color)
-0008f220: 2c20 226c 6967 6874 626c 7565 2229 3b0a  , "lightblue");.
-0008f230: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0008f240: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-0008f250: 2020 2020 2020 2020 2020 2073 6e70 7269             snpri
-0008f260: 6e74 6628 636f 6c6f 722c 2073 697a 656f  ntf(color, sizeo
-0008f270: 6628 636f 6c6f 7229 2c20 2277 6869 7465  f(color), "white
-0008f280: 2229 3b0a 2020 2020 2020 2020 7d0a 0a20  ");.        }.. 
-0008f290: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
-0008f2a0: 702c 2022 2020 5c22 2570 5c22 205b 2022  p, "  \"%p\" [ "
-0008f2b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008f2c0: 2020 2020 2022 7374 796c 6520 3d20 6669       "style = fi
-0008f2d0: 6c6c 6564 3b20 6669 6c6c 636f 6c6f 7220  lled; fillcolor 
-0008f2e0: 3d20 2573 3b20 7368 6170 6520 3d20 7265  = %s; shape = re
-0008f2f0: 636f 7264 3b20 220a 2020 2020 2020 2020  cord; ".        
-0008f300: 2020 2020 2020 2020 2020 2020 226c 6162              "lab
-0008f310: 656c 3d5c 2222 2c0a 2020 2020 2020 2020  el=\"",.        
-0008f320: 2020 2020 2020 2020 2876 6f69 6420 2a29          (void *)
-0008f330: 206e 6f64 652c 2063 6f6c 6f72 293b 0a0a   node, color);..
-0008f340: 2020 2020 2020 2020 6966 2028 7374 726c          if (strl
-0008f350: 656e 286e 6f64 652d 3e6e 616d 6529 203e  en(node->name) >
-0008f360: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
-0008f370: 2020 6670 7269 6e74 6628 6670 2c20 2225    fprintf(fp, "%
-0008f380: 7320 2825 7329 7c22 2c20 6e6f 6465 2d3e  s (%s)|", node->
-0008f390: 6e61 6d65 2c20 6767 6d6c 5f74 7970 655f  name, ggml_type_
-0008f3a0: 6e61 6d65 286e 6f64 652d 3e74 7970 6529  name(node->type)
-0008f3b0: 293b 0a20 2020 2020 2020 207d 2065 6c73  );.        } els
-0008f3c0: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-0008f3d0: 6670 7269 6e74 6628 6670 2c20 2228 2573  fprintf(fp, "(%s
-0008f3e0: 297c 222c 2067 676d 6c5f 7479 7065 5f6e  )|", ggml_type_n
-0008f3f0: 616d 6528 6e6f 6465 2d3e 7479 7065 2929  ame(node->type))
-0008f400: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-0008f410: 2020 2020 2069 6620 286e 6f64 652d 3e6e       if (node->n
-0008f420: 5f64 696d 7320 3d3d 2032 2920 7b0a 2020  _dims == 2) {.  
-0008f430: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
-0008f440: 6628 6670 2c20 2225 6420 5b25 2220 5052  f(fp, "%d [%" PR
-0008f450: 4964 3634 2022 2c20 2522 2050 5249 6436  Id64 ", %" PRId6
-0008f460: 3420 225d 207c 203c 783e 2573 222c 2069  4 "] | <x>%s", i
-0008f470: 2c20 6e6f 6465 2d3e 6e65 5b30 5d2c 206e  , node->ne[0], n
-0008f480: 6f64 652d 3e6e 655b 315d 2c20 4747 4d4c  ode->ne[1], GGML
-0008f490: 5f4f 505f 5359 4d42 4f4c 5b6e 6f64 652d  _OP_SYMBOL[node-
-0008f4a0: 3e6f 705d 293b 0a20 2020 2020 2020 207d  >op]);.        }
-0008f4b0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-0008f4c0: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
-0008f4d0: 2225 6420 5b25 2220 5052 4964 3634 2022  "%d [%" PRId64 "
-0008f4e0: 2c20 2522 2050 5249 6436 3420 222c 2025  , %" PRId64 ", %
-0008f4f0: 2220 5052 4964 3634 2022 5d20 7c20 3c78  " PRId64 "] | <x
-0008f500: 3e25 7322 2c20 692c 206e 6f64 652d 3e6e  >%s", i, node->n
-0008f510: 655b 305d 2c20 6e6f 6465 2d3e 6e65 5b31  e[0], node->ne[1
-0008f520: 5d2c 206e 6f64 652d 3e6e 655b 325d 2c20  ], node->ne[2], 
-0008f530: 4747 4d4c 5f4f 505f 5359 4d42 4f4c 5b6e  GGML_OP_SYMBOL[n
-0008f540: 6f64 652d 3e6f 705d 293b 0a20 2020 2020  ode->op]);.     
-0008f550: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
-0008f560: 2028 6e6f 6465 2d3e 6772 6164 2920 7b0a   (node->grad) {.
-0008f570: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
-0008f580: 6e74 6628 6670 2c20 2220 7c20 3c67 3e25  ntf(fp, " | <g>%
-0008f590: 735c 223b 205d 5c6e 222c 2047 474d 4c5f  s\"; ]\n", GGML_
-0008f5a0: 4f50 5f53 594d 424f 4c5b 6e6f 6465 2d3e  OP_SYMBOL[node->
-0008f5b0: 6772 6164 2d3e 6f70 5d29 3b0a 2020 2020  grad->op]);.    
-0008f5c0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-0008f5d0: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
-0008f5e0: 2866 702c 2022 5c22 3b20 5d5c 6e22 293b  (fp, "\"; ]\n");
-0008f5f0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0008f600: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-0008f610: 203d 2030 3b20 6920 3c20 6762 2d3e 6e5f   = 0; i < gb->n_
-0008f620: 6c65 6166 733b 2069 2b2b 2920 7b0a 2020  leafs; i++) {.  
-0008f630: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0008f640: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
-0008f650: 3d20 6762 2d3e 6c65 6166 735b 695d 3b0a  = gb->leafs[i];.
-0008f660: 0a20 2020 2020 2020 2073 6e70 7269 6e74  .        snprint
-0008f670: 6628 636f 6c6f 722c 2073 697a 656f 6628  f(color, sizeof(
-0008f680: 636f 6c6f 7229 2c20 2270 696e 6b22 293b  color), "pink");
-0008f690: 0a0a 2020 2020 2020 2020 6670 7269 6e74  ..        fprint
-0008f6a0: 6628 6670 2c20 2220 205c 2225 705c 2220  f(fp, "  \"%p\" 
-0008f6b0: 5b20 220a 2020 2020 2020 2020 2020 2020  [ ".            
-0008f6c0: 2020 2020 2020 2020 2273 7479 6c65 203d          "style =
-0008f6d0: 2066 696c 6c65 643b 2066 696c 6c63 6f6c   filled; fillcol
-0008f6e0: 6f72 203d 2025 733b 2073 6861 7065 203d  or = %s; shape =
-0008f6f0: 2072 6563 6f72 643b 2022 0a20 2020 2020   record; ".     
-0008f700: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0008f710: 6c61 6265 6c3d 5c22 3c78 3e22 2c0a 2020  label=\"<x>",.  
-0008f720: 2020 2020 2020 2020 2020 2020 2020 2876                (v
-0008f730: 6f69 6420 2a29 206e 6f64 652c 2063 6f6c  oid *) node, col
-0008f740: 6f72 293b 0a0a 2020 2020 2020 2020 6966  or);..        if
-0008f750: 2028 7374 726c 656e 286e 6f64 652d 3e6e   (strlen(node->n
-0008f760: 616d 6529 203e 2030 2920 7b0a 2020 2020  ame) > 0) {.    
-0008f770: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
-0008f780: 6670 2c20 2225 7320 2825 7329 7c22 2c20  fp, "%s (%s)|", 
-0008f790: 6e6f 6465 2d3e 6e61 6d65 2c20 6767 6d6c  node->name, ggml
-0008f7a0: 5f74 7970 655f 6e61 6d65 286e 6f64 652d  _type_name(node-
-0008f7b0: 3e74 7970 6529 293b 0a20 2020 2020 2020  >type));.       
-0008f7c0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-0008f7d0: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
-0008f7e0: 2c20 2228 2573 297c 222c 2067 676d 6c5f  , "(%s)|", ggml_
-0008f7f0: 7479 7065 5f6e 616d 6528 6e6f 6465 2d3e  type_name(node->
-0008f800: 7479 7065 2929 3b0a 2020 2020 2020 2020  type));.        
-0008f810: 7d0a 0a20 2020 2020 2020 2066 7072 696e  }..        fprin
-0008f820: 7466 2866 702c 2022 434f 4e53 5420 2564  tf(fp, "CONST %d
-0008f830: 205b 2522 2050 5249 6436 3420 222c 2025   [%" PRId64 ", %
-0008f840: 2220 5052 4964 3634 2022 5d22 2c20 692c  " PRId64 "]", i,
-0008f850: 206e 6f64 652d 3e6e 655b 305d 2c20 6e6f   node->ne[0], no
-0008f860: 6465 2d3e 6e65 5b31 5d29 3b0a 2020 2020  de->ne[1]);.    
-0008f870: 2020 2020 6966 2028 6767 6d6c 5f6e 656c      if (ggml_nel
-0008f880: 656d 656e 7473 286e 6f64 6529 203c 2035  ements(node) < 5
-0008f890: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008f8a0: 6670 7269 6e74 6628 6670 2c20 2220 7c20  fprintf(fp, " | 
-0008f8b0: 2822 293b 0a20 2020 2020 2020 2020 2020  (");.           
-0008f8c0: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-0008f8d0: 206a 203c 2067 676d 6c5f 6e65 6c65 6d65   j < ggml_neleme
-0008f8e0: 6e74 7328 6e6f 6465 293b 206a 2b2b 2920  nts(node); j++) 
-0008f8f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0008f900: 2020 6966 2028 6e6f 6465 2d3e 7479 7065    if (node->type
-0008f910: 203d 3d20 4747 4d4c 5f54 5950 455f 4938   == GGML_TYPE_I8
-0008f920: 207c 7c20 6e6f 6465 2d3e 7479 7065 203d   || node->type =
-0008f930: 3d20 4747 4d4c 5f54 5950 455f 4931 3620  = GGML_TYPE_I16 
-0008f940: 7c7c 206e 6f64 652d 3e74 7970 6520 3d3d  || node->type ==
-0008f950: 2047 474d 4c5f 5459 5045 5f49 3332 2920   GGML_TYPE_I32) 
-0008f960: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0008f970: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
-0008f980: 2c20 2225 6422 2c20 6767 6d6c 5f67 6574  , "%d", ggml_get
-0008f990: 5f69 3332 5f31 6428 6e6f 6465 2c20 6a29  _i32_1d(node, j)
-0008f9a0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008f9b0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0008f9c0: 2020 2020 2065 6c73 6520 6966 2028 6e6f       else if (no
-0008f9d0: 6465 2d3e 7479 7065 203d 3d20 4747 4d4c  de->type == GGML
-0008f9e0: 5f54 5950 455f 4633 3220 7c7c 206e 6f64  _TYPE_F32 || nod
-0008f9f0: 652d 3e74 7970 6520 3d3d 2047 474d 4c5f  e->type == GGML_
-0008fa00: 5459 5045 5f46 3136 2920 7b0a 2020 2020  TYPE_F16) {.    
-0008fa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008fa20: 6670 7269 6e74 6628 6670 2c20 2225 2e31  fprintf(fp, "%.1
-0008fa30: 6522 2c20 2864 6f75 626c 6529 6767 6d6c  e", (double)ggml
-0008fa40: 5f67 6574 5f66 3332 5f31 6428 6e6f 6465  _get_f32_1d(node
-0008fa50: 2c20 6a29 293b 0a20 2020 2020 2020 2020  , j));.         
-0008fa60: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0008fa70: 2020 2020 2020 2020 2065 6c73 6520 7b0a           else {.
-0008fa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008fa90: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
-0008faa0: 2223 2229 3b0a 2020 2020 2020 2020 2020  "#");.          
-0008fab0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0008fac0: 2020 2020 2020 2020 6966 2028 6a20 3c20          if (j < 
-0008fad0: 6767 6d6c 5f6e 656c 656d 656e 7473 286e  ggml_nelements(n
-0008fae0: 6f64 6529 202d 2031 2920 7b0a 2020 2020  ode) - 1) {.    
-0008faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008fb00: 6670 7269 6e74 6628 6670 2c20 222c 2022  fprintf(fp, ", "
-0008fb10: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008fb20: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0008fb30: 207d 0a20 2020 2020 2020 2020 2020 2066   }.            f
-0008fb40: 7072 696e 7466 2866 702c 2022 2922 293b  printf(fp, ")");
-0008fb50: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-0008fb60: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
-0008fb70: 5c22 3b20 5d5c 6e22 293b 0a20 2020 207d  \"; ]\n");.    }
-0008fb80: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-0008fb90: 203d 2030 3b20 6920 3c20 6762 2d3e 6e5f   = 0; i < gb->n_
-0008fba0: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
-0008fbb0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0008fbc0: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
-0008fbd0: 3d20 6762 2d3e 6e6f 6465 735b 695d 3b0a  = gb->nodes[i];.
-0008fbe0: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
-0008fbf0: 652d 3e73 7263 3029 207b 0a20 2020 2020  e->src0) {.     
-0008fc00: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
-0008fc10: 685f 6475 6d70 5f64 6f74 5f6e 6f64 655f  h_dump_dot_node_
-0008fc20: 6564 6765 2866 702c 2067 622c 206e 6f64  edge(fp, gb, nod
-0008fc30: 652c 206e 6f64 652d 3e73 7263 302c 2022  e, node->src0, "
-0008fc40: 7822 293b 0a20 2020 2020 2020 207d 0a0a  x");.        }..
-0008fc50: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-0008fc60: 2d3e 7372 6331 2920 7b0a 2020 2020 2020  ->src1) {.      
-0008fc70: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-0008fc80: 5f64 756d 705f 646f 745f 6e6f 6465 5f65  _dump_dot_node_e
-0008fc90: 6467 6528 6670 2c20 6762 2c20 6e6f 6465  dge(fp, gb, node
-0008fca0: 2c20 6e6f 6465 2d3e 7372 6331 2c20 2279  , node->src1, "y
-0008fcb0: 2229 3b0a 2020 2020 2020 2020 7d0a 0a20  ");.        }.. 
-0008fcc0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0008fcd0: 6a20 3d20 303b 206a 203c 2047 474d 4c5f  j = 0; j < GGML_
-0008fce0: 4d41 585f 4f50 543b 206a 2b2b 2920 7b0a  MAX_OPT; j++) {.
-0008fcf0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0008fd00: 6e6f 6465 2d3e 6f70 745b 6a5d 2920 7b0a  node->opt[j]) {.
-0008fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008fd20: 6368 6172 206c 6162 656c 5b31 365d 3b0a  char label[16];.
-0008fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008fd40: 736e 7072 696e 7466 286c 6162 656c 2c20  snprintf(label, 
-0008fd50: 7369 7a65 6f66 286c 6162 656c 292c 2022  sizeof(label), "
-0008fd60: 6f70 7420 2564 222c 206a 293b 0a20 2020  opt %d", j);.   
-0008fd70: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0008fd80: 6c5f 6772 6170 685f 6475 6d70 5f64 6f74  l_graph_dump_dot
-0008fd90: 5f6e 6f64 655f 6564 6765 2866 702c 2067  _node_edge(fp, g
-0008fda0: 622c 206e 6f64 652c 206e 6f64 652d 3e6f  b, node, node->o
-0008fdb0: 7074 5b6a 5d2c 206c 6162 656c 293b 0a20  pt[j], label);. 
-0008fdc0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0008fdd0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-0008fde0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0008fdf0: 3b20 6920 3c20 6762 2d3e 6e5f 6c65 6166  ; i < gb->n_leaf
-0008fe00: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-0008fe10: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0008fe20: 6e73 6f72 202a 206e 6f64 6520 3d20 6762  nsor * node = gb
-0008fe30: 2d3e 6c65 6166 735b 695d 3b0a 0a20 2020  ->leafs[i];..   
-0008fe40: 2020 2020 2069 6620 286e 6f64 652d 3e73       if (node->s
-0008fe50: 7263 3029 207b 0a20 2020 2020 2020 2020  rc0) {.         
-0008fe60: 2020 2067 676d 6c5f 6772 6170 685f 6475     ggml_graph_du
-0008fe70: 6d70 5f64 6f74 5f6c 6561 665f 6564 6765  mp_dot_leaf_edge
-0008fe80: 2866 702c 206e 6f64 652c 206e 6f64 652d  (fp, node, node-
-0008fe90: 3e73 7263 302c 2022 7822 293b 0a20 2020  >src0, "x");.   
-0008fea0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008feb0: 6966 2028 6e6f 6465 2d3e 7372 6331 2920  if (node->src1) 
-0008fec0: 7b0a 2020 2020 2020 2020 2020 2020 6767  {.            gg
-0008fed0: 6d6c 5f67 7261 7068 5f64 756d 705f 646f  ml_graph_dump_do
-0008fee0: 745f 6c65 6166 5f65 6467 6528 6670 2c20  t_leaf_edge(fp, 
-0008fef0: 6e6f 6465 2c20 6e6f 6465 2d3e 7372 6331  node, node->src1
-0008ff00: 2c20 2279 2229 3b0a 2020 2020 2020 2020  , "y");.        
-0008ff10: 7d0a 0a20 2020 2020 2020 2066 6f72 2028  }..        for (
-0008ff20: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
-0008ff30: 474d 4c5f 4d41 585f 4f50 543b 206a 2b2b  GML_MAX_OPT; j++
-0008ff40: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008ff50: 6966 2028 6e6f 6465 2d3e 6f70 745b 6a5d  if (node->opt[j]
-0008ff60: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008ff70: 2020 2020 6368 6172 206c 6162 656c 5b31      char label[1
-0008ff80: 365d 3b0a 2020 2020 2020 2020 2020 2020  6];.            
-0008ff90: 2020 2020 736e 7072 696e 7466 286c 6162      snprintf(lab
-0008ffa0: 656c 2c20 7369 7a65 6f66 286c 6162 656c  el, sizeof(label
-0008ffb0: 292c 2022 6f70 7420 2564 222c 206a 293b  ), "opt %d", j);
-0008ffc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008ffd0: 2067 676d 6c5f 6772 6170 685f 6475 6d70   ggml_graph_dump
-0008ffe0: 5f64 6f74 5f6c 6561 665f 6564 6765 2866  _dot_leaf_edge(f
-0008fff0: 702c 206e 6f64 652c 206e 6f64 652d 3e6f  p, node, node->o
-00090000: 7074 5b6a 5d2c 206c 6162 656c 293b 0a20  pt[j], label);. 
-00090010: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00090020: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-00090030: 2020 6670 7269 6e74 6628 6670 2c20 227d    fprintf(fp, "}
-00090040: 5c6e 2229 3b0a 0a20 2020 2066 636c 6f73  \n");..    fclos
-00090050: 6528 6670 293b 0a0a 2020 2020 4747 4d4c  e(fp);..    GGML
-00090060: 5f50 5249 4e54 2822 2573 3a20 646f 7420  _PRINT("%s: dot 
-00090070: 2d54 706e 6720 2573 202d 6f20 2573 2e70  -Tpng %s -o %s.p
-00090080: 6e67 2026 2620 6f70 656e 2025 732e 706e  ng && open %s.pn
-00090090: 675c 6e22 2c20 5f5f 6675 6e63 5f5f 2c20  g\n", __func__, 
-000900a0: 6669 6c65 6e61 6d65 2c20 6669 6c65 6e61  filename, filena
-000900b0: 6d65 2c20 6669 6c65 6e61 6d65 293b 0a7d  me, filename);.}
-000900c0: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
-000900d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000900e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000900f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00090100: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00090110: 2f2f 0a0a 7374 6174 6963 2076 6f69 6420  //..static void 
-00090120: 6767 6d6c 5f6f 7074 5f73 6574 5f70 6172  ggml_opt_set_par
-00090130: 616d 7328 696e 7420 6e70 2c20 7374 7275  ams(int np, stru
-00090140: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00090150: 2063 6f6e 7374 2070 735b 5d2c 2063 6f6e   const ps[], con
-00090160: 7374 2066 6c6f 6174 202a 2078 2920 7b0a  st float * x) {.
-00090170: 2020 2020 696e 7420 6920 3d20 303b 0a20      int i = 0;. 
-00090180: 2020 2066 6f72 2028 696e 7420 7020 3d20     for (int p = 
-00090190: 303b 2070 203c 206e 703b 202b 2b70 2920  0; p < np; ++p) 
-000901a0: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
-000901b0: 696e 7436 345f 7420 6e65 203d 2067 676d  int64_t ne = ggm
-000901c0: 6c5f 6e65 6c65 6d65 6e74 7328 7073 5b70  l_nelements(ps[p
-000901d0: 5d29 203b 0a20 2020 2020 2020 202f 2f20  ]) ;.        // 
-000901e0: 544f 444f 3a20 6164 6420 6675 6e63 7469  TODO: add functi
-000901f0: 6f6e 2074 6f20 7365 7420 7465 6e73 6f72  on to set tensor
-00090200: 2066 726f 6d20 6172 7261 790a 2020 2020   from array.    
-00090210: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-00090220: 206a 203d 2030 3b20 6a20 3c20 6e65 3b20   j = 0; j < ne; 
-00090230: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
-00090240: 2020 2067 676d 6c5f 7365 745f 6633 325f     ggml_set_f32_
-00090250: 3164 2870 735b 705d 2c20 6a2c 2078 5b69  1d(ps[p], j, x[i
-00090260: 2b2b 5d29 3b0a 2020 2020 2020 2020 7d0a  ++]);.        }.
-00090270: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-00090280: 766f 6964 2067 676d 6c5f 6f70 745f 6765  void ggml_opt_ge
-00090290: 745f 7061 7261 6d73 2869 6e74 206e 702c  t_params(int np,
-000902a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000902b0: 736f 7220 2a20 636f 6e73 7420 7073 5b5d  sor * const ps[]
-000902c0: 2c20 666c 6f61 7420 2a20 7829 207b 0a20  , float * x) {. 
-000902d0: 2020 2069 6e74 2069 203d 2030 3b0a 2020     int i = 0;.  
-000902e0: 2020 666f 7220 2869 6e74 2070 203d 2030    for (int p = 0
-000902f0: 3b20 7020 3c20 6e70 3b20 2b2b 7029 207b  ; p < np; ++p) {
-00090300: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-00090310: 6e74 3634 5f74 206e 6520 3d20 6767 6d6c  nt64_t ne = ggml
-00090320: 5f6e 656c 656d 656e 7473 2870 735b 705d  _nelements(ps[p]
-00090330: 2920 3b0a 2020 2020 2020 2020 2f2f 2054  ) ;.        // T
-00090340: 4f44 4f3a 2061 6464 2066 756e 6374 696f  ODO: add functio
-00090350: 6e20 746f 2067 6574 2061 6c6c 2065 6c65  n to get all ele
-00090360: 6d65 6e74 7320 6174 206f 6e63 650a 2020  ments at once.  
-00090370: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00090380: 5f74 206a 203d 2030 3b20 6a20 3c20 6e65  _t j = 0; j < ne
-00090390: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
-000903a0: 2020 2020 2078 5b69 2b2b 5d20 3d20 6767       x[i++] = gg
-000903b0: 6d6c 5f67 6574 5f66 3332 5f31 6428 7073  ml_get_f32_1d(ps
-000903c0: 5b70 5d2c 206a 293b 0a20 2020 2020 2020  [p], j);.       
-000903d0: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
-000903e0: 6963 2076 6f69 6420 6767 6d6c 5f6f 7074  ic void ggml_opt
-000903f0: 5f67 6574 5f67 7261 6428 696e 7420 6e70  _get_grad(int np
-00090400: 2c20 7374 7275 6374 2067 676d 6c5f 7465  , struct ggml_te
-00090410: 6e73 6f72 202a 2063 6f6e 7374 2070 735b  nsor * const ps[
-00090420: 5d2c 2066 6c6f 6174 202a 2067 2920 7b0a  ], float * g) {.
-00090430: 2020 2020 696e 7420 6920 3d20 303b 0a20      int i = 0;. 
-00090440: 2020 2066 6f72 2028 696e 7420 7020 3d20     for (int p = 
-00090450: 303b 2070 203c 206e 703b 202b 2b70 2920  0; p < np; ++p) 
-00090460: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
-00090470: 696e 7436 345f 7420 6e65 203d 2067 676d  int64_t ne = ggm
-00090480: 6c5f 6e65 6c65 6d65 6e74 7328 7073 5b70  l_nelements(ps[p
-00090490: 5d29 203b 0a20 2020 2020 2020 202f 2f20  ]) ;.        // 
-000904a0: 544f 444f 3a20 6164 6420 6675 6e63 7469  TODO: add functi
-000904b0: 6f6e 2074 6f20 6765 7420 616c 6c20 656c  on to get all el
-000904c0: 656d 656e 7473 2061 7420 6f6e 6365 0a20  ements at once. 
-000904d0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-000904e0: 345f 7420 6a20 3d20 303b 206a 203c 206e  4_t j = 0; j < n
-000904f0: 653b 202b 2b6a 2920 7b0a 2020 2020 2020  e; ++j) {.      
-00090500: 2020 2020 2020 675b 692b 2b5d 203d 2067        g[i++] = g
-00090510: 676d 6c5f 6765 745f 6633 325f 3164 2870  gml_get_f32_1d(p
-00090520: 735b 705d 2d3e 6772 6164 2c20 6a29 3b0a  s[p]->grad, j);.
-00090530: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00090540: 7d0a 0a2f 2f0a 2f2f 2041 4441 4d0a 2f2f  }..//.// ADAM.//
-00090550: 0a2f 2f20 2020 7265 663a 2068 7474 7073  .//   ref: https
-00090560: 3a2f 2f61 7278 6976 2e6f 7267 2f70 6466  ://arxiv.org/pdf
-00090570: 2f31 3431 322e 3639 3830 2e70 6466 0a2f  /1412.6980.pdf./
-00090580: 2f0a 0a73 7461 7469 6320 656e 756d 2067  /..static enum g
-00090590: 676d 6c5f 6f70 745f 7265 7375 6c74 2067  gml_opt_result g
-000905a0: 676d 6c5f 6f70 745f 6164 616d 280a 2020  gml_opt_adam(.  
-000905b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-000905c0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
-000905d0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-000905e0: 6767 6d6c 5f6f 7074 5f63 6f6e 7465 7874  ggml_opt_context
-000905f0: 202a 206f 7074 2c0a 2020 2020 2020 2020   * opt,.        
-00090600: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
-00090610: 7061 7261 6d73 2070 6172 616d 732c 0a20  params params,. 
-00090620: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00090630: 6d6c 5f74 656e 736f 7220 2a20 662c 0a20  ml_tensor * f,. 
-00090640: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00090650: 6d6c 5f63 6772 6170 6820 2a20 6766 2c0a  ml_cgraph * gf,.
-00090660: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00090670: 676d 6c5f 6367 7261 7068 202a 2067 6229  gml_cgraph * gb)
-00090680: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-00090690: 5254 2867 676d 6c5f 6973 5f73 6361 6c61  RT(ggml_is_scala
-000906a0: 7228 6629 293b 0a0a 2020 2020 6766 2d3e  r(f));..    gf->
-000906b0: 6e5f 7468 7265 6164 7320 3d20 7061 7261  n_threads = para
-000906c0: 6d73 2e6e 5f74 6872 6561 6473 3b0a 2020  ms.n_threads;.  
-000906d0: 2020 6762 2d3e 6e5f 7468 7265 6164 7320    gb->n_threads 
-000906e0: 3d20 7061 7261 6d73 2e6e 5f74 6872 6561  = params.n_threa
-000906f0: 6473 3b0a 0a20 2020 202f 2f20 7468 6573  ds;..    // thes
-00090700: 6520 7769 6c6c 2073 746f 7265 2074 6865  e will store the
-00090710: 2070 6172 616d 6574 6572 7320 7765 2077   parameters we w
-00090720: 616e 7420 746f 206f 7074 696d 697a 650a  ant to optimize.
-00090730: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00090740: 7465 6e73 6f72 202a 2070 735b 4747 4d4c  tensor * ps[GGML
-00090750: 5f4d 4158 5f50 4152 414d 535d 3b0a 0a20  _MAX_PARAMS];.. 
-00090760: 2020 2069 6e74 206e 7020 3d20 303b 0a20     int np = 0;. 
-00090770: 2020 2069 6e74 206e 7820 3d20 303b 0a20     int nx = 0;. 
-00090780: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00090790: 303b 2069 203c 2067 662d 3e6e 5f6e 6f64  0; i < gf->n_nod
-000907a0: 6573 3b20 2b2b 6929 207b 0a20 2020 2020  es; ++i) {.     
-000907b0: 2020 2069 6620 2867 662d 3e6e 6f64 6573     if (gf->nodes
-000907c0: 5b69 5d2d 3e69 735f 7061 7261 6d29 207b  [i]->is_param) {
-000907d0: 0a20 2020 2020 2020 2020 2020 2047 474d  .            GGM
-000907e0: 4c5f 5052 494e 545f 4445 4255 4728 2266  L_PRINT_DEBUG("f
-000907f0: 6f75 6e64 2070 6172 616d 2025 643a 2067  ound param %d: g
-00090800: 7261 642d 3e6f 7020 3d20 2564 5c6e 222c  rad->op = %d\n",
-00090810: 206e 702c 2067 662d 3e6e 6f64 6573 5b69   np, gf->nodes[i
-00090820: 5d2d 3e67 7261 642d 3e6f 7029 3b0a 0a20  ]->grad->op);.. 
-00090830: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00090840: 4153 5345 5254 286e 7020 3c20 4747 4d4c  ASSERT(np < GGML
-00090850: 5f4d 4158 5f50 4152 414d 5329 3b0a 0a20  _MAX_PARAMS);.. 
-00090860: 2020 2020 2020 2020 2020 2070 735b 6e70             ps[np
-00090870: 2b2b 5d20 3d20 6766 2d3e 6e6f 6465 735b  ++] = gf->nodes[
-00090880: 695d 3b0a 2020 2020 2020 2020 2020 2020  i];.            
-00090890: 6e78 202b 3d20 6767 6d6c 5f6e 656c 656d  nx += ggml_nelem
-000908a0: 656e 7473 2867 662d 3e6e 6f64 6573 5b69  ents(gf->nodes[i
-000908b0: 5d29 3b0a 2020 2020 2020 2020 7d0a 2020  ]);.        }.  
-000908c0: 2020 7d0a 0a20 2020 2069 6620 2828 6f70    }..    if ((op
-000908d0: 742d 3e70 6172 616d 732e 7479 7065 2021  t->params.type !
-000908e0: 3d20 7061 7261 6d73 2e74 7970 6529 207c  = params.type) |
-000908f0: 7c20 286f 7074 2d3e 6e78 2021 3d20 6e78  | (opt->nx != nx
-00090900: 2920 7c7c 2028 6f70 742d 3e70 6172 616d  ) || (opt->param
-00090910: 732e 7061 7374 2021 3d20 7061 7261 6d73  s.past != params
-00090920: 2e70 6173 7429 2920 7b0a 2020 2020 2020  .past)) {.      
-00090930: 2020 696e 7420 6974 6572 203d 206f 7074    int iter = opt
-00090940: 2d3e 6974 6572 3b0a 2020 2020 2020 2020  ->iter;.        
-00090950: 6767 6d6c 5f6f 7074 5f69 6e69 7428 6f70  ggml_opt_init(op
-00090960: 742d 3e63 7478 2c20 6f70 742c 2070 6172  t->ctx, opt, par
-00090970: 616d 732c 206e 7829 3b0a 2020 2020 2020  ams, nx);.      
-00090980: 2020 6f70 742d 3e69 7465 7220 3d20 6974    opt->iter = it
-00090990: 6572 3b0a 2020 2020 7d0a 0a20 2020 202f  er;.    }..    /
-000909a0: 2f20 636f 6e73 7461 6e74 730a 2020 2020  / constants.    
-000909b0: 636f 6e73 7420 666c 6f61 7420 7363 6865  const float sche
-000909c0: 6420 3d20 7061 7261 6d73 2e61 6461 6d2e  d = params.adam.
-000909d0: 7363 6865 643b 0a20 2020 2063 6f6e 7374  sched;.    const
-000909e0: 2066 6c6f 6174 2064 6563 6179 203d 2070   float decay = p
-000909f0: 6172 616d 732e 6164 616d 2e64 6563 6179  arams.adam.decay
-00090a00: 202a 2073 6368 6564 3b0a 2020 2020 636f   * sched;.    co
-00090a10: 6e73 7420 666c 6f61 7420 616c 7068 6120  nst float alpha 
-00090a20: 3d20 7061 7261 6d73 2e61 6461 6d2e 616c  = params.adam.al
-00090a30: 7068 6120 2a20 7363 6865 643b 0a20 2020  pha * sched;.   
-00090a40: 2063 6f6e 7374 2066 6c6f 6174 2062 6574   const float bet
-00090a50: 6131 203d 2070 6172 616d 732e 6164 616d  a1 = params.adam
-00090a60: 2e62 6574 6131 3b0a 2020 2020 636f 6e73  .beta1;.    cons
-00090a70: 7420 666c 6f61 7420 6265 7461 3220 3d20  t float beta2 = 
-00090a80: 7061 7261 6d73 2e61 6461 6d2e 6265 7461  params.adam.beta
-00090a90: 323b 0a20 2020 2063 6f6e 7374 2066 6c6f  2;.    const flo
-00090aa0: 6174 2065 7073 2020 203d 2070 6172 616d  at eps   = param
-00090ab0: 732e 6164 616d 2e65 7073 3b0a 0a20 2020  s.adam.eps;..   
-00090ac0: 2066 6c6f 6174 202a 2078 2020 3d20 6f70   float * x  = op
-00090ad0: 742d 3e61 6461 6d2e 782d 3e64 6174 613b  t->adam.x->data;
-00090ae0: 2020 2f2f 2076 6965 7720 6f66 2074 6865    // view of the
-00090af0: 2070 6172 616d 6574 6572 730a 2020 2020   parameters.    
-00090b00: 666c 6f61 7420 2a20 6731 203d 206f 7074  float * g1 = opt
-00090b10: 2d3e 6164 616d 2e67 312d 3e64 6174 613b  ->adam.g1->data;
-00090b20: 202f 2f20 6772 6164 6965 6e74 0a20 2020   // gradient.   
-00090b30: 2066 6c6f 6174 202a 2067 3220 3d20 6f70   float * g2 = op
-00090b40: 742d 3e61 6461 6d2e 6732 2d3e 6461 7461  t->adam.g2->data
-00090b50: 3b20 2f2f 2067 7261 6469 656e 7420 7371  ; // gradient sq
-00090b60: 7561 7265 640a 2020 2020 666c 6f61 7420  uared.    float 
-00090b70: 2a20 6d20 203d 206f 7074 2d3e 6164 616d  * m  = opt->adam
-00090b80: 2e6d 2d3e 6461 7461 3b20 202f 2f20 6669  .m->data;  // fi
-00090b90: 7273 7420 6d6f 6d65 6e74 0a20 2020 2066  rst moment.    f
-00090ba0: 6c6f 6174 202a 2076 2020 3d20 6f70 742d  loat * v  = opt-
-00090bb0: 3e61 6461 6d2e 762d 3e64 6174 613b 2020  >adam.v->data;  
-00090bc0: 2f2f 2073 6563 6f6e 6420 6d6f 6d65 6e74  // second moment
-00090bd0: 0a20 2020 2066 6c6f 6174 202a 206d 6820  .    float * mh 
-00090be0: 3d20 6f70 742d 3e61 6461 6d2e 6d68 2d3e  = opt->adam.mh->
-00090bf0: 6461 7461 3b20 2f2f 2066 6972 7374 206d  data; // first m
-00090c00: 6f6d 656e 7420 6861 740a 2020 2020 666c  oment hat.    fl
-00090c10: 6f61 7420 2a20 7668 203d 206f 7074 2d3e  oat * vh = opt->
-00090c20: 6164 616d 2e76 682d 3e64 6174 613b 202f  adam.vh->data; /
-00090c30: 2f20 7365 636f 6e64 206d 6f6d 656e 7420  / second moment 
-00090c40: 6861 740a 0a20 2020 2066 6c6f 6174 202a  hat..    float *
-00090c50: 2070 6620 3d20 7061 7261 6d73 2e70 6173   pf = params.pas
-00090c60: 7420 3e20 3020 3f20 6f70 742d 3e61 6461  t > 0 ? opt->ada
-00090c70: 6d2e 7066 2d3e 6461 7461 203a 204e 554c  m.pf->data : NUL
-00090c80: 4c3b 202f 2f20 7061 7374 2066 756e 6374  L; // past funct
-00090c90: 696f 6e20 7661 6c75 6573 0a0a 2020 2020  ion values..    
-00090ca0: 2f2f 2075 7064 6174 6520 7669 6577 0a20  // update view. 
-00090cb0: 2020 2067 676d 6c5f 6f70 745f 6765 745f     ggml_opt_get_
-00090cc0: 7061 7261 6d73 286e 702c 2070 732c 2078  params(np, ps, x
-00090cd0: 293b 0a0a 2020 2020 2f2f 2063 6f6d 7075  );..    // compu
-00090ce0: 7465 2074 6865 2066 756e 6374 696f 6e20  te the function 
-00090cf0: 7661 6c75 650a 2020 2020 6767 6d6c 5f67  value.    ggml_g
-00090d00: 7261 7068 5f72 6573 6574 2020 2867 6629  raph_reset  (gf)
-00090d10: 3b0a 2020 2020 6767 6d6c 5f73 6574 5f66  ;.    ggml_set_f
-00090d20: 3332 2020 2020 2020 2866 2d3e 6772 6164  32      (f->grad
-00090d30: 2c20 312e 3066 293b 0a20 2020 2067 676d  , 1.0f);.    ggm
-00090d40: 6c5f 6772 6170 685f 636f 6d70 7574 6528  l_graph_compute(
-00090d50: 6374 782c 2067 6229 3b0a 0a20 2020 206f  ctx, gb);..    o
-00090d60: 7074 2d3e 6164 616d 2e66 785f 7072 6576  pt->adam.fx_prev
-00090d70: 203d 2067 676d 6c5f 6765 745f 6633 325f   = ggml_get_f32_
-00090d80: 3164 2866 2c20 3029 3b0a 2020 2020 6f70  1d(f, 0);.    op
-00090d90: 742d 3e61 6461 6d2e 6678 5f62 6573 7420  t->adam.fx_best 
-00090da0: 3d20 6f70 742d 3e61 6461 6d2e 6678 5f70  = opt->adam.fx_p
-00090db0: 7265 763b 0a20 2020 2069 6620 2870 6629  rev;.    if (pf)
-00090dc0: 207b 0a20 2020 2020 2020 2070 665b 6f70   {.        pf[op
-00090dd0: 742d 3e69 7465 7220 2520 7061 7261 6d73  t->iter % params
-00090de0: 2e70 6173 745d 203d 206f 7074 2d3e 6164  .past] = opt->ad
-00090df0: 616d 2e66 785f 7072 6576 3b0a 2020 2020  am.fx_prev;.    
-00090e00: 7d0a 0a20 2020 202f 2f20 696e 6974 6961  }..    // initia
-00090e10: 6c69 7a65 0a20 2020 2069 6620 286f 7074  lize.    if (opt
-00090e20: 2d3e 6a75 7374 5f69 6e69 7469 616c 697a  ->just_initializ
-00090e30: 6564 2920 7b0a 2020 2020 2020 2020 6f70  ed) {.        op
-00090e40: 742d 3e61 6461 6d2e 6e5f 6e6f 5f69 6d70  t->adam.n_no_imp
-00090e50: 726f 7665 6d65 6e74 203d 2030 3b0a 2020  rovement = 0;.  
-00090e60: 2020 2020 2020 6f70 742d 3e6a 7573 745f        opt->just_
-00090e70: 696e 6974 6961 6c69 7a65 6420 3d20 6661  initialized = fa
-00090e80: 6c73 653b 0a20 2020 207d 0a0a 2020 2020  lse;.    }..    
-00090e90: 666c 6f61 7420 2a20 6678 5f62 6573 7420  float * fx_best 
-00090ea0: 3d20 266f 7074 2d3e 6164 616d 2e66 785f  = &opt->adam.fx_
-00090eb0: 6265 7374 3b0a 2020 2020 666c 6f61 7420  best;.    float 
-00090ec0: 2a20 6678 5f70 7265 7620 3d20 266f 7074  * fx_prev = &opt
-00090ed0: 2d3e 6164 616d 2e66 785f 7072 6576 3b0a  ->adam.fx_prev;.
-00090ee0: 2020 2020 696e 7420 2a20 6e5f 6e6f 5f69      int * n_no_i
-00090ef0: 6d70 726f 7665 6d65 6e74 203d 2026 6f70  mprovement = &op
-00090f00: 742d 3e61 6461 6d2e 6e5f 6e6f 5f69 6d70  t->adam.n_no_imp
-00090f10: 726f 7665 6d65 6e74 3b0a 0a20 2020 2069  rovement;..    i
-00090f20: 6e74 2069 7465 7230 203d 206f 7074 2d3e  nt iter0 = opt->
-00090f30: 6974 6572 3b0a 0a20 2020 202f 2f20 7275  iter;..    // ru
-00090f40: 6e20 7468 6520 6f70 7469 6d69 7a65 720a  n the optimizer.
-00090f50: 2020 2020 666f 7220 2869 6e74 2074 203d      for (int t =
-00090f60: 2030 3b20 7420 3c20 7061 7261 6d73 2e61   0; t < params.a
-00090f70: 6461 6d2e 6e5f 6974 6572 3b20 2b2b 7429  dam.n_iter; ++t)
-00090f80: 207b 0a20 2020 2020 2020 206f 7074 2d3e   {.        opt->
-00090f90: 6974 6572 203d 2069 7465 7230 202b 2074  iter = iter0 + t
-00090fa0: 202b 2031 3b0a 2020 2020 2020 2020 4747   + 1;.        GG
-00090fb0: 4d4c 5f50 5249 4e54 5f44 4542 5547 2020  ML_PRINT_DEBUG  
-00090fc0: 2822 3d3d 3d20 6974 6572 2025 6420 3d3d  ("=== iter %d ==
-00090fd0: 3d5c 6e22 2c20 7429 3b0a 0a20 2020 2020  =\n", t);..     
-00090fe0: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
-00090ff0: 4255 4720 2028 2266 2020 2020 2020 3d20  BUG  ("f      = 
-00091000: 2531 302e 3666 5c6e 222c 2067 676d 6c5f  %10.6f\n", ggml_
-00091010: 6765 745f 6633 325f 3164 2866 2c20 3029  get_f32_1d(f, 0)
-00091020: 293b 0a20 2020 2020 2020 2047 474d 4c5f  );.        GGML_
-00091030: 5052 494e 545f 4445 4255 475f 3528 2264  PRINT_DEBUG_5("d
-00091040: 662f 6478 3020 3d20 2531 302e 3666 5c6e  f/dx0 = %10.6f\n
-00091050: 222c 2067 676d 6c5f 6765 745f 6633 325f  ", ggml_get_f32_
-00091060: 3164 2870 735b 305d 2d3e 6772 6164 2c20  1d(ps[0]->grad, 
-00091070: 3029 293b 0a20 2020 2020 2020 2047 474d  0));.        GGM
-00091080: 4c5f 5052 494e 545f 4445 4255 475f 3528  L_PRINT_DEBUG_5(
-00091090: 2264 662f 6478 3120 3d20 2531 302e 3666  "df/dx1 = %10.6f
-000910a0: 5c6e 222c 2067 676d 6c5f 6765 745f 6633  \n", ggml_get_f3
-000910b0: 325f 3164 2870 735b 315d 2d3e 6772 6164  2_1d(ps[1]->grad
-000910c0: 2c20 3029 293b 0a0a 2020 2020 2020 2020  , 0));..        
-000910d0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-000910e0: 6920 3c20 6e70 3b20 2b2b 6929 207b 0a20  i < np; ++i) {. 
-000910f0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00091100: 5052 494e 545f 4445 4255 4728 2270 6172  PRINT_DEBUG("par
-00091110: 616d 2025 643a 2025 3130 2e36 662c 2067  am %d: %10.6f, g
-00091120: 203d 2025 3130 2e36 665c 6e22 2c20 692c   = %10.6f\n", i,
-00091130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00091140: 2020 2020 2067 676d 6c5f 6765 745f 6633       ggml_get_f3
-00091150: 325f 3164 2870 735b 695d 2c20 3029 2c20  2_1d(ps[i], 0), 
-00091160: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
-00091170: 7073 5b69 5d2d 3e67 7261 642c 2030 2929  ps[i]->grad, 0))
-00091180: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-00091190: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-000911a0: 5f74 2074 5f73 7461 7274 5f77 616c 6c20  _t t_start_wall 
-000911b0: 3d20 6767 6d6c 5f74 696d 655f 7573 2829  = ggml_time_us()
-000911c0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-000911d0: 696e 7436 345f 7420 745f 7374 6172 745f  int64_t t_start_
-000911e0: 6370 7520 3d20 6767 6d6c 5f63 7963 6c65  cpu = ggml_cycle
-000911f0: 7328 293b 0a20 2020 2020 2020 2055 4e55  s();.        UNU
-00091200: 5345 4428 745f 7374 6172 745f 7761 6c6c  SED(t_start_wall
-00091210: 293b 0a20 2020 2020 2020 2055 4e55 5345  );.        UNUSE
-00091220: 4428 745f 7374 6172 745f 6370 7529 3b0a  D(t_start_cpu);.
-00091230: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-00091240: 2020 2020 2020 202f 2f20 7570 6461 7465         // update
-00091250: 2074 6865 2067 7261 6469 656e 740a 2020   the gradient.  
-00091260: 2020 2020 2020 2020 2020 6767 6d6c 5f6f            ggml_o
-00091270: 7074 5f67 6574 5f67 7261 6428 6e70 2c20  pt_get_grad(np, 
-00091280: 7073 2c20 6731 293b 0a0a 2020 2020 2020  ps, g1);..      
-00091290: 2020 2020 2020 2f2f 206d 5f74 203d 2062        // m_t = b
-000912a0: 6574 6131 2a6d 5f74 2d31 202b 2028 3120  eta1*m_t-1 + (1 
-000912b0: 2d20 6265 7461 3129 2a67 5f74 0a20 2020  - beta1)*g_t.   
-000912c0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-000912d0: 635f 7363 616c 655f 6633 3228 6e78 2c20  c_scale_f32(nx, 
-000912e0: 6d2c 2062 6574 6131 293b 0a20 2020 2020  m, beta1);.     
-000912f0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00091300: 6d61 645f 6633 3220 2028 6e78 2c20 6d2c  mad_f32  (nx, m,
-00091310: 2067 312c 2031 2e30 6620 2d20 6265 7461   g1, 1.0f - beta
-00091320: 3129 3b0a 0a20 2020 2020 2020 2020 2020  1);..           
-00091330: 202f 2f20 6732 203d 2067 315e 320a 2020   // g2 = g1^2.  
-00091340: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-00091350: 6563 5f73 7172 5f66 3332 2020 286e 782c  ec_sqr_f32  (nx,
-00091360: 2067 322c 2067 3129 3b0a 0a20 2020 2020   g2, g1);..     
-00091370: 2020 2020 2020 202f 2f20 765f 7420 3d20         // v_t = 
-00091380: 6265 7461 322a 765f 742d 3120 2b20 2831  beta2*v_t-1 + (1
-00091390: 202d 2062 6574 6132 292a 675f 745e 320a   - beta2)*g_t^2.
-000913a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000913b0: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
-000913c0: 782c 2076 2c20 6265 7461 3229 3b0a 2020  x, v, beta2);.  
-000913d0: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-000913e0: 6563 5f6d 6164 5f66 3332 2020 286e 782c  ec_mad_f32  (nx,
-000913f0: 2076 2c20 6732 2c20 312e 3066 202d 2062   v, g2, 1.0f - b
-00091400: 6574 6132 293b 0a0a 2020 2020 2020 2020  eta2);..        
-00091410: 2020 2020 2f2f 206d 5e68 6174 203d 206d      // m^hat = m
-00091420: 5f74 202f 2028 3120 2d20 6265 7461 315e  _t / (1 - beta1^
-00091430: 7429 0a20 2020 2020 2020 2020 2020 202f  t).            /
-00091440: 2f20 765e 6861 7420 3d20 765f 7420 2f20  / v^hat = v_t / 
-00091450: 2831 202d 2062 6574 6132 5e74 290a 2020  (1 - beta2^t).  
-00091460: 2020 2020 2020 2020 2020 2f2f 2078 5f74            // x_t
-00091470: 203d 2078 5f74 2d31 202d 2073 6368 6564   = x_t-1 - sched
-00091480: 2a28 616c 7068 612a 6d5e 6861 742f 2873  *(alpha*m^hat/(s
-00091490: 7172 7428 765e 6861 7429 202b 2065 7073  qrt(v^hat) + eps
-000914a0: 2920 2b20 6465 6361 792a 785f 742d 3129  ) + decay*x_t-1)
-000914b0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-000914c0: 785f 7420 3d20 785f 742d 3120 2d20 7363  x_t = x_t-1 - sc
-000914d0: 6865 642a 616c 7068 612a 6d5e 6861 742f  hed*alpha*m^hat/
-000914e0: 2873 7172 7428 765e 6861 7429 202b 2065  (sqrt(v^hat) + e
-000914f0: 7073 2920 2d20 7363 6865 642a 6465 6361  ps) - sched*deca
-00091500: 792a 785f 742d 310a 2020 2020 2020 2020  y*x_t-1.        
-00091510: 2020 2020 2f2f 2078 5f74 203d 2078 5f74      // x_t = x_t
-00091520: 2d31 2a28 312d 7363 6865 642a 6465 6361  -1*(1-sched*deca
-00091530: 7929 202d 2073 6368 6564 2a61 6c70 6861  y) - sched*alpha
-00091540: 2a6d 5e68 6174 2f28 7371 7274 2876 5e68  *m^hat/(sqrt(v^h
-00091550: 6174 2920 2b20 6570 7329 0a20 2020 2020  at) + eps).     
-00091560: 2020 2020 2020 202f 2f20 785f 7420 3d20         // x_t = 
-00091570: 785f 742d 312a 2831 2d73 6368 6564 2a64  x_t-1*(1-sched*d
-00091580: 6563 6179 2920 2b20 7363 6865 642a 6465  ecay) + sched*de
-00091590: 6361 792a 282d 616c 7068 612f 6465 6361  cay*(-alpha/deca
-000915a0: 7929 2a6d 5e68 6174 2f28 7371 7274 2876  y)*m^hat/(sqrt(v
-000915b0: 5e68 6174 2920 2b20 6570 7329 0a20 2020  ^hat) + eps).   
-000915c0: 2020 2020 2020 2020 202f 2f20 785f 7420           // x_t 
-000915d0: 3d20 6d69 7828 785f 742d 312c 2028 2d61  = mix(x_t-1, (-a
-000915e0: 6c70 6861 2f64 6563 6179 292a 6d5e 6861  lpha/decay)*m^ha
-000915f0: 742f 2873 7172 7428 765e 6861 7429 202b  t/(sqrt(v^hat) +
-00091600: 2065 7073 292c 2073 6368 6564 2a64 6563   eps), sched*dec
-00091610: 6179 290a 2020 2020 2020 2020 2020 2020  ay).            
-00091620: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
-00091630: 2020 286e 782c 206d 682c 206d 293b 0a20    (nx, mh, m);. 
-00091640: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00091650: 7665 635f 6370 795f 6633 3220 2028 6e78  vec_cpy_f32  (nx
-00091660: 2c20 7668 2c20 7629 3b0a 0a20 2020 2020  , vh, v);..     
-00091670: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00091680: 7363 616c 655f 6633 3228 6e78 2c20 6d68  scale_f32(nx, mh
-00091690: 2c20 616c 7068 612f 2831 2e30 6620 2d20  , alpha/(1.0f - 
-000916a0: 706f 7766 2862 6574 6131 2c20 6f70 742d  powf(beta1, opt-
-000916b0: 3e69 7465 7229 2929 3b0a 2020 2020 2020  >iter)));.      
-000916c0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-000916d0: 6361 6c65 5f66 3332 286e 782c 2076 682c  cale_f32(nx, vh,
-000916e0: 2020 312e 3066 2f28 312e 3066 202d 2070    1.0f/(1.0f - p
-000916f0: 6f77 6628 6265 7461 322c 206f 7074 2d3e  owf(beta2, opt->
-00091700: 6974 6572 2929 293b 0a0a 2020 2020 2020  iter)));..      
-00091710: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-00091720: 7172 745f 6633 3220 286e 782c 2076 682c  qrt_f32 (nx, vh,
-00091730: 2076 6829 3b0a 2020 2020 2020 2020 2020   vh);.          
-00091740: 2020 6767 6d6c 5f76 6563 5f61 6363 315f    ggml_vec_acc1_
-00091750: 6633 3220 286e 782c 2076 682c 2065 7073  f32 (nx, vh, eps
-00091760: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00091770: 6767 6d6c 5f76 6563 5f64 6976 5f66 3332  ggml_vec_div_f32
-00091780: 2020 286e 782c 206d 682c 206d 682c 2076    (nx, mh, mh, v
-00091790: 6829 3b0a 2020 2020 2020 2020 2020 2020  h);.            
-000917a0: 6767 6d6c 5f76 6563 5f73 6361 6c65 5f66  ggml_vec_scale_f
-000917b0: 3332 286e 782c 2078 2c20 2031 2e30 6620  32(nx, x,  1.0f 
-000917c0: 2d20 6465 6361 7929 3b0a 2020 2020 2020  - decay);.      
-000917d0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-000917e0: 7562 5f66 3332 2020 286e 782c 2078 2c20  ub_f32  (nx, x, 
-000917f0: 2078 2c20 206d 6829 3b0a 0a20 2020 2020   x,  mh);..     
-00091800: 2020 2020 2020 202f 2f20 7570 6461 7465         // update
-00091810: 2074 6865 2070 6172 616d 6574 6572 730a   the parameters.
-00091820: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00091830: 5f6f 7074 5f73 6574 5f70 6172 616d 7328  _opt_set_params(
-00091840: 6e70 2c20 7073 2c20 7829 3b0a 2020 2020  np, ps, x);.    
-00091850: 2020 2020 7d0a 0a20 2020 2020 2020 2067      }..        g
-00091860: 676d 6c5f 6772 6170 685f 7265 7365 7420  gml_graph_reset 
-00091870: 2028 6766 293b 0a20 2020 2020 2020 2067   (gf);.        g
-00091880: 676d 6c5f 7365 745f 6633 3220 2020 2020  gml_set_f32     
-00091890: 2028 662d 3e67 7261 642c 2031 2e30 6629   (f->grad, 1.0f)
-000918a0: 3b0a 2020 2020 2020 2020 6767 6d6c 5f67  ;.        ggml_g
-000918b0: 7261 7068 5f63 6f6d 7075 7465 2863 7478  raph_compute(ctx
-000918c0: 2c20 6762 293b 0a0a 2020 2020 2020 2020  , gb);..        
-000918d0: 636f 6e73 7420 666c 6f61 7420 6678 203d  const float fx =
-000918e0: 2067 676d 6c5f 6765 745f 6633 325f 3164   ggml_get_f32_1d
-000918f0: 2866 2c20 3029 3b0a 0a20 2020 2020 2020  (f, 0);..       
-00091900: 202f 2f20 6368 6563 6b20 636f 6e76 6572   // check conver
-00091910: 6765 6e63 650a 2020 2020 2020 2020 6966  gence.        if
-00091920: 2028 6661 6273 6628 6678 202d 2066 785f   (fabsf(fx - fx_
-00091930: 7072 6576 5b30 5d29 2f66 7820 3c20 7061  prev[0])/fx < pa
-00091940: 7261 6d73 2e61 6461 6d2e 6570 735f 6629  rams.adam.eps_f)
-00091950: 207b 0a20 2020 2020 2020 2020 2020 2047   {.            G
-00091960: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
-00091970: 2263 6f6e 7665 7267 6564 5c6e 2229 3b0a  "converged\n");.
-00091980: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00091990: 7572 6e20 4747 4d4c 5f4f 5054 5f4f 4b3b  urn GGML_OPT_OK;
-000919a0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-000919b0: 2020 2020 2f2f 2064 656c 7461 2d62 6173      // delta-bas
-000919c0: 6564 2063 6f6e 7665 7267 656e 6365 2074  ed convergence t
-000919d0: 6573 740a 2020 2020 2020 2020 6966 2028  est.        if (
-000919e0: 7066 2021 3d20 4e55 4c4c 2920 7b0a 2020  pf != NULL) {.  
-000919f0: 2020 2020 2020 2020 2020 2f2f 206e 6565            // nee
-00091a00: 6420 6174 206c 6561 7374 2070 6172 616d  d at least param
-00091a10: 732e 7061 7374 2069 7465 7261 7469 6f6e  s.past iteration
-00091a20: 7320 746f 2073 7461 7274 2063 6865 636b  s to start check
-00091a30: 696e 6720 666f 7220 636f 6e76 6572 6765  ing for converge
-00091a40: 6e63 650a 2020 2020 2020 2020 2020 2020  nce.            
-00091a50: 6966 2028 7061 7261 6d73 2e70 6173 7420  if (params.past 
-00091a60: 3c3d 2069 7465 7230 202b 2074 2920 7b0a  <= iter0 + t) {.
-00091a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00091a80: 636f 6e73 7420 666c 6f61 7420 7261 7465  const float rate
-00091a90: 203d 2028 7066 5b28 6974 6572 3020 2b20   = (pf[(iter0 + 
-00091aa0: 7429 2570 6172 616d 732e 7061 7374 5d20  t)%params.past] 
-00091ab0: 2d20 6678 292f 6678 3b0a 0a20 2020 2020  - fx)/fx;..     
-00091ac0: 2020 2020 2020 2020 2020 2069 6620 2866             if (f
-00091ad0: 6162 7366 2872 6174 6529 203c 2070 6172  absf(rate) < par
-00091ae0: 616d 732e 6465 6c74 6129 207b 0a20 2020  ams.delta) {.   
-00091af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00091b00: 2072 6574 7572 6e20 4747 4d4c 5f4f 5054   return GGML_OPT
-00091b10: 5f4f 4b3b 0a20 2020 2020 2020 2020 2020  _OK;.           
-00091b20: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00091b30: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00091b40: 2020 7066 5b28 6974 6572 3020 2b20 7429    pf[(iter0 + t)
-00091b50: 2570 6172 616d 732e 7061 7374 5d20 3d20  %params.past] = 
-00091b60: 6678 3b0a 2020 2020 2020 2020 7d0a 0a20  fx;.        }.. 
-00091b70: 2020 2020 2020 202f 2f20 6368 6563 6b20         // check 
-00091b80: 666f 7220 696d 7072 6f76 656d 656e 740a  for improvement.
-00091b90: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
-00091ba0: 6d73 2e6d 6178 5f6e 6f5f 696d 7072 6f76  ms.max_no_improv
-00091bb0: 656d 656e 7420 3e20 3029 207b 0a20 2020  ement > 0) {.   
-00091bc0: 2020 2020 2020 2020 2069 6620 2866 785f           if (fx_
-00091bd0: 6265 7374 5b30 5d20 3e20 6678 2920 7b0a  best[0] > fx) {.
-00091be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00091bf0: 6678 5f62 6573 745b 305d 203d 2066 783b  fx_best[0] = fx;
-00091c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00091c10: 206e 5f6e 6f5f 696d 7072 6f76 656d 656e   n_no_improvemen
-00091c20: 745b 305d 203d 2030 3b0a 2020 2020 2020  t[0] = 0;.      
-00091c30: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-00091c40: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00091c50: 2b6e 5f6e 6f5f 696d 7072 6f76 656d 656e  +n_no_improvemen
-00091c60: 745b 305d 3b0a 0a20 2020 2020 2020 2020  t[0];..         
-00091c70: 2020 2020 2020 2069 6620 286e 5f6e 6f5f         if (n_no_
-00091c80: 696d 7072 6f76 656d 656e 745b 305d 203e  improvement[0] >
-00091c90: 3d20 7061 7261 6d73 2e6d 6178 5f6e 6f5f  = params.max_no_
-00091ca0: 696d 7072 6f76 656d 656e 7429 207b 0a20  improvement) {. 
-00091cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00091cc0: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
-00091cd0: 5054 5f4f 4b3b 0a20 2020 2020 2020 2020  PT_OK;.         
-00091ce0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00091cf0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00091d00: 0a0a 2020 2020 2020 2020 6678 5f70 7265  ..        fx_pre
-00091d10: 765b 305d 203d 2066 783b 0a0a 2020 2020  v[0] = fx;..    
-00091d20: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00091d30: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00091d40: 745f 656e 645f 6370 7520 3d20 6767 6d6c  t_end_cpu = ggml
-00091d50: 5f63 7963 6c65 7328 293b 0a20 2020 2020  _cycles();.     
-00091d60: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-00091d70: 545f 4445 4255 4728 2274 696d 6520 6974  T_DEBUG("time it
-00091d80: 6572 3a20 2020 2020 2025 352e 3366 2073  er:      %5.3f s
-00091d90: 5c6e 222c 2028 2866 6c6f 6174 2928 745f  \n", ((float)(t_
-00091da0: 656e 645f 6370 7520 2d20 745f 7374 6172  end_cpu - t_star
-00091db0: 745f 6370 7529 292f 434c 4f43 4b53 5f50  t_cpu))/CLOCKS_P
-00091dc0: 4552 5f53 4543 293b 0a20 2020 2020 2020  ER_SEC);.       
-00091dd0: 2020 2020 2055 4e55 5345 4428 745f 656e       UNUSED(t_en
-00091de0: 645f 6370 7529 3b0a 0a20 2020 2020 2020  d_cpu);..       
-00091df0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-00091e00: 5f74 2074 5f65 6e64 5f77 616c 6c20 3d20  _t t_end_wall = 
-00091e10: 6767 6d6c 5f74 696d 655f 7573 2829 3b0a  ggml_time_us();.
-00091e20: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00091e30: 5f50 5249 4e54 5f44 4542 5547 2822 7761  _PRINT_DEBUG("wa
-00091e40: 6c6c 2074 696d 6520 6974 6572 3a20 2535  ll time iter: %5
-00091e50: 2e33 6620 735c 6e22 2c20 2874 5f65 6e64  .3f s\n", (t_end
-00091e60: 5f77 616c 6c20 2d20 745f 7374 6172 745f  _wall - t_start_
-00091e70: 7761 6c6c 292f 3165 3629 3b0a 2020 2020  wall)/1e6);.    
-00091e80: 2020 2020 2020 2020 554e 5553 4544 2874          UNUSED(t
-00091e90: 5f65 6e64 5f77 616c 6c29 3b0a 2020 2020  _end_wall);.    
-00091ea0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-00091eb0: 2072 6574 7572 6e20 4747 4d4c 5f4f 5054   return GGML_OPT
-00091ec0: 5f44 4944 5f4e 4f54 5f43 4f4e 5645 5247  _DID_NOT_CONVERG
-00091ed0: 453b 0a7d 0a0a 2f2f 0a2f 2f20 4c2d 4246  E;.}..//.// L-BF
-00091ee0: 4753 0a2f 2f0a 2f2f 2074 6865 204c 2d42  GS.//.// the L-B
-00091ef0: 4647 5320 696d 706c 656d 656e 7461 7469  FGS implementati
-00091f00: 6f6e 2062 656c 6f77 2069 7320 6261 7365  on below is base
-00091f10: 6420 6f6e 2074 6865 2066 6f6c 6c6f 7769  d on the followi
-00091f20: 6e67 2069 6d70 6c65 6d65 6e74 6174 696f  ng implementatio
-00091f30: 6e3a 0a2f 2f0a 2f2f 2020 2068 7474 7073  n:.//.//   https
-00091f40: 3a2f 2f67 6974 6875 622e 636f 6d2f 6368  ://github.com/ch
-00091f50: 6f6b 6b61 6e2f 6c69 626c 6266 6773 0a2f  okkan/liblbfgs./
-00091f60: 2f0a 0a73 7472 7563 7420 6767 6d6c 5f6c  /..struct ggml_l
-00091f70: 6266 6773 5f69 7465 7261 7469 6f6e 5f64  bfgs_iteration_d
-00091f80: 6174 6120 7b0a 2020 2020 666c 6f61 7420  ata {.    float 
-00091f90: 616c 7068 613b 0a20 2020 2066 6c6f 6174  alpha;.    float
-00091fa0: 2079 733b 0a20 2020 2066 6c6f 6174 202a   ys;.    float *
-00091fb0: 2073 3b0a 2020 2020 666c 6f61 7420 2a20   s;.    float * 
-00091fc0: 793b 0a7d 3b0a 0a73 7461 7469 6320 656e  y;.};..static en
-00091fd0: 756d 2067 676d 6c5f 6f70 745f 7265 7375  um ggml_opt_resu
-00091fe0: 6c74 206c 696e 6573 6561 7263 685f 6261  lt linesearch_ba
-00091ff0: 636b 7472 6163 6b69 6e67 280a 2020 2020  cktracking(.    
-00092000: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00092010: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-00092020: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00092030: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
-00092040: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00092050: 2020 2020 2020 696e 7420 6e78 2c0a 2020        int nx,.  
-00092060: 2020 2020 2020 666c 6f61 7420 2a20 782c        float * x,
-00092070: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
-00092080: 2066 782c 0a20 2020 2020 2020 2066 6c6f   fx,.        flo
-00092090: 6174 202a 2067 2c0a 2020 2020 2020 2020  at * g,.        
-000920a0: 666c 6f61 7420 2a20 642c 0a20 2020 2020  float * d,.     
-000920b0: 2020 2066 6c6f 6174 202a 2073 7465 702c     float * step,
-000920c0: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
-000920d0: 6c6f 6174 202a 2078 702c 0a20 2020 2020  loat * xp,.     
-000920e0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-000920f0: 656e 736f 7220 2a20 662c 0a20 2020 2020  ensor * f,.     
-00092100: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00092110: 6772 6170 6820 2a20 6766 2c0a 2020 2020  graph * gf,.    
-00092120: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00092130: 6367 7261 7068 202a 2067 622c 0a20 2020  cgraph * gb,.   
-00092140: 2020 2020 2063 6f6e 7374 2069 6e74 206e       const int n
-00092150: 702c 0a20 2020 2020 2020 2073 7472 7563  p,.        struc
-00092160: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00092170: 7073 5b5d 2920 7b0a 2020 2020 696e 7420  ps[]) {.    int 
-00092180: 636f 756e 7420 3d20 303b 0a0a 2020 2020  count = 0;..    
-00092190: 666c 6f61 7420 7769 6474 6820 203d 2030  float width  = 0
-000921a0: 2e30 663b 0a20 2020 2066 6c6f 6174 2064  .0f;.    float d
-000921b0: 6720 2020 2020 3d20 302e 3066 3b0a 2020  g     = 0.0f;.  
-000921c0: 2020 666c 6f61 7420 6669 6e69 7420 203d    float finit  =
-000921d0: 2030 2e30 663b 0a20 2020 2066 6c6f 6174   0.0f;.    float
-000921e0: 2064 6769 6e69 7420 3d20 302e 3066 3b0a   dginit = 0.0f;.
-000921f0: 2020 2020 666c 6f61 7420 6467 7465 7374      float dgtest
-00092200: 203d 2030 2e30 663b 0a0a 2020 2020 636f   = 0.0f;..    co
-00092210: 6e73 7420 666c 6f61 7420 6465 6320 3d20  nst float dec = 
-00092220: 302e 3566 3b0a 2020 2020 636f 6e73 7420  0.5f;.    const 
-00092230: 666c 6f61 7420 696e 6320 3d20 322e 3166  float inc = 2.1f
-00092240: 3b0a 0a20 2020 2069 6620 282a 7374 6570  ;..    if (*step
-00092250: 203c 3d20 302e 6629 207b 0a20 2020 2020   <= 0.f) {.     
-00092260: 2020 2072 6574 7572 6e20 4747 4d4c 5f4c     return GGML_L
-00092270: 494e 4553 4541 5243 485f 494e 5641 4c49  INESEARCH_INVALI
-00092280: 445f 5041 5241 4d45 5445 5253 3b0a 2020  D_PARAMETERS;.  
-00092290: 2020 7d0a 0a20 2020 202f 2f20 636f 6d70    }..    // comp
-000922a0: 7574 6520 7468 6520 696e 6974 6961 6c20  ute the initial 
-000922b0: 6772 6164 6965 6e74 2069 6e20 7468 6520  gradient in the 
-000922c0: 7365 6172 6368 2064 6972 6563 7469 6f6e  search direction
-000922d0: 0a20 2020 2067 676d 6c5f 7665 635f 646f  .    ggml_vec_do
-000922e0: 745f 6633 3228 6e78 2c20 2664 6769 6e69  t_f32(nx, &dgini
-000922f0: 742c 2067 2c20 6429 3b0a 0a20 2020 202f  t, g, d);..    /
-00092300: 2f20 6d61 6b65 2073 7572 6520 7468 6174  / make sure that
-00092310: 2064 2070 6f69 6e74 7320 746f 2061 2064   d points to a d
-00092320: 6573 6365 6e74 2064 6972 6563 7469 6f6e  escent direction
-00092330: 0a20 2020 2069 6620 2830 203c 2064 6769  .    if (0 < dgi
-00092340: 6e69 7429 207b 0a20 2020 2020 2020 2072  nit) {.        r
-00092350: 6574 7572 6e20 4747 4d4c 5f4c 494e 4553  eturn GGML_LINES
-00092360: 4541 5243 485f 4641 494c 3b0a 2020 2020  EARCH_FAIL;.    
-00092370: 7d0a 0a20 2020 202f 2f20 696e 6974 6961  }..    // initia
-00092380: 6c69 7a65 206c 6f63 616c 2076 6172 6961  lize local varia
-00092390: 626c 6573 0a20 2020 2066 696e 6974 203d  bles.    finit =
-000923a0: 202a 6678 3b0a 2020 2020 6467 7465 7374   *fx;.    dgtest
-000923b0: 203d 2070 6172 616d 732d 3e6c 6266 6773   = params->lbfgs
-000923c0: 2e66 746f 6c2a 6467 696e 6974 3b0a 0a20  .ftol*dginit;.. 
-000923d0: 2020 2077 6869 6c65 2028 7472 7565 2920     while (true) 
-000923e0: 7b0a 2020 2020 2020 2020 6767 6d6c 5f76  {.        ggml_v
-000923f0: 6563 5f63 7079 5f66 3332 286e 782c 2078  ec_cpy_f32(nx, x
-00092400: 2c20 7870 293b 0a20 2020 2020 2020 2067  , xp);.        g
-00092410: 676d 6c5f 7665 635f 6d61 645f 6633 3228  gml_vec_mad_f32(
-00092420: 6e78 2c20 782c 2064 2c20 2a73 7465 7029  nx, x, d, *step)
-00092430: 3b0a 0a20 2020 2020 2020 202f 2f20 6576  ;..        // ev
-00092440: 616c 7561 7465 2074 6865 2066 756e 6374  aluate the funct
-00092450: 696f 6e20 616e 6420 6772 6164 6965 6e74  ion and gradient
-00092460: 2076 616c 7565 730a 2020 2020 2020 2020   values.        
-00092470: 7b0a 2020 2020 2020 2020 2020 2020 6767  {.            gg
-00092480: 6d6c 5f6f 7074 5f73 6574 5f70 6172 616d  ml_opt_set_param
-00092490: 7328 6e70 2c20 7073 2c20 7829 3b0a 0a20  s(np, ps, x);.. 
-000924a0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000924b0: 6772 6170 685f 7265 7365 7420 2028 6766  graph_reset  (gf
-000924c0: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
-000924d0: 676d 6c5f 7365 745f 6633 3220 2020 2020  gml_set_f32     
-000924e0: 2028 662d 3e67 7261 642c 2031 2e30 6629   (f->grad, 1.0f)
-000924f0: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
-00092500: 6d6c 5f67 7261 7068 5f63 6f6d 7075 7465  ml_graph_compute
-00092510: 2863 7478 2c20 6762 293b 0a0a 2020 2020  (ctx, gb);..    
-00092520: 2020 2020 2020 2020 6767 6d6c 5f6f 7074          ggml_opt
-00092530: 5f67 6574 5f67 7261 6428 6e70 2c20 7073  _get_grad(np, ps
-00092540: 2c20 6729 3b0a 0a20 2020 2020 2020 2020  , g);..         
-00092550: 2020 202a 6678 203d 2067 676d 6c5f 6765     *fx = ggml_ge
-00092560: 745f 6633 325f 3164 2866 2c20 3029 3b0a  t_f32_1d(f, 0);.
-00092570: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00092580: 2020 202b 2b63 6f75 6e74 3b0a 0a20 2020     ++count;..   
-00092590: 2020 2020 2069 6620 282a 6678 203e 2066       if (*fx > f
-000925a0: 696e 6974 202b 2028 2a73 7465 7029 2a64  init + (*step)*d
-000925b0: 6774 6573 7429 207b 0a20 2020 2020 2020  gtest) {.       
-000925c0: 2020 2020 2077 6964 7468 203d 2064 6563       width = dec
-000925d0: 3b0a 2020 2020 2020 2020 7d20 656c 7365  ;.        } else
-000925e0: 207b 0a20 2020 2020 2020 2020 2020 202f   {.            /
-000925f0: 2f20 4172 6d69 6a6f 2063 6f6e 6469 7469  / Armijo conditi
-00092600: 6f6e 2069 7320 7361 7469 7366 6965 640a  on is satisfied.
-00092610: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00092620: 7061 7261 6d73 2d3e 6c62 6667 732e 6c69  params->lbfgs.li
-00092630: 6e65 7365 6172 6368 203d 3d20 4747 4d4c  nesearch == GGML
-00092640: 5f4c 494e 4553 4541 5243 485f 4241 434b  _LINESEARCH_BACK
-00092650: 5452 4143 4b49 4e47 5f41 524d 494a 4f29  TRACKING_ARMIJO)
-00092660: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00092670: 2020 2072 6574 7572 6e20 636f 756e 743b     return count;
-00092680: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-00092690: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000926a0: 5f76 6563 5f64 6f74 5f66 3332 286e 782c  _vec_dot_f32(nx,
-000926b0: 2026 6467 2c20 672c 2064 293b 0a0a 2020   &dg, g, d);..  
-000926c0: 2020 2020 2020 2020 2020 2f2f 2063 6865            // che
-000926d0: 636b 2074 6865 2057 6f6c 6665 2063 6f6e  ck the Wolfe con
-000926e0: 6469 7469 6f6e 0a20 2020 2020 2020 2020  dition.         
-000926f0: 2020 2069 6620 2864 6720 3c20 7061 7261     if (dg < para
-00092700: 6d73 2d3e 6c62 6667 732e 776f 6c66 6520  ms->lbfgs.wolfe 
-00092710: 2a20 6467 696e 6974 2920 7b0a 2020 2020  * dginit) {.    
-00092720: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-00092730: 6820 3d20 696e 633b 0a20 2020 2020 2020  h = inc;.       
-00092740: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
-00092750: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00092760: 2870 6172 616d 732d 3e6c 6266 6773 2e6c  (params->lbfgs.l
-00092770: 696e 6573 6561 7263 6820 3d3d 2047 474d  inesearch == GGM
-00092780: 4c5f 4c49 4e45 5345 4152 4348 5f42 4143  L_LINESEARCH_BAC
-00092790: 4b54 5241 434b 494e 475f 574f 4c46 4529  KTRACKING_WOLFE)
-000927a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000927b0: 2020 2020 2020 202f 2f20 7265 6775 6c61         // regula
-000927c0: 7220 576f 6c66 6520 636f 6e64 6974 696f  r Wolfe conditio
-000927d0: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
-000927e0: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
-000927f0: 756e 743b 0a20 2020 2020 2020 2020 2020  unt;.           
-00092800: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00092810: 2020 2020 2020 2020 6966 2864 6720 3e20          if(dg > 
-00092820: 2d70 6172 616d 732d 3e6c 6266 6773 2e77  -params->lbfgs.w
-00092830: 6f6c 6665 2a64 6769 6e69 7429 207b 0a20  olfe*dginit) {. 
-00092840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00092850: 2020 2077 6964 7468 203d 2064 6563 3b0a     width = dec;.
-00092860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00092870: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-00092880: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00092890: 7374 726f 6e67 2057 6f6c 6665 2063 6f6e  strong Wolfe con
-000928a0: 6469 7469 6f6e 2028 4747 4d4c 5f4c 494e  dition (GGML_LIN
-000928b0: 4553 4541 5243 485f 4241 434b 5452 4143  ESEARCH_BACKTRAC
-000928c0: 4b49 4e47 5f53 5452 4f4e 475f 574f 4c46  KING_STRONG_WOLF
-000928d0: 4529 0a20 2020 2020 2020 2020 2020 2020  E).             
-000928e0: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
-000928f0: 756e 743b 0a20 2020 2020 2020 2020 2020  unt;.           
-00092900: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00092910: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
-00092920: 756e 743b 0a20 2020 2020 2020 2020 2020  unt;.           
-00092930: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-00092940: 2020 2020 2020 6966 2028 2a73 7465 7020        if (*step 
-00092950: 3c20 7061 7261 6d73 2d3e 6c62 6667 732e  < params->lbfgs.
-00092960: 6d69 6e5f 7374 6570 2920 7b0a 2020 2020  min_step) {.    
-00092970: 2020 2020 2020 2020 7265 7475 726e 2047          return G
-00092980: 474d 4c5f 4c49 4e45 5345 4152 4348 5f4d  GML_LINESEARCH_M
-00092990: 494e 494d 554d 5f53 5445 503b 0a20 2020  INIMUM_STEP;.   
-000929a0: 2020 2020 207d 0a20 2020 2020 2020 2069       }.        i
-000929b0: 6620 282a 7374 6570 203e 2070 6172 616d  f (*step > param
-000929c0: 732d 3e6c 6266 6773 2e6d 6178 5f73 7465  s->lbfgs.max_ste
-000929d0: 7029 207b 0a20 2020 2020 2020 2020 2020  p) {.           
-000929e0: 2072 6574 7572 6e20 4747 4d4c 5f4c 494e   return GGML_LIN
-000929f0: 4553 4541 5243 485f 4d41 5849 4d55 4d5f  ESEARCH_MAXIMUM_
-00092a00: 5354 4550 3b0a 2020 2020 2020 2020 7d0a  STEP;.        }.
-00092a10: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
-00092a20: 6d73 2d3e 6c62 6667 732e 6d61 785f 6c69  ms->lbfgs.max_li
-00092a30: 6e65 7365 6172 6368 203c 3d20 636f 756e  nesearch <= coun
-00092a40: 7429 207b 0a20 2020 2020 2020 2020 2020  t) {.           
-00092a50: 2072 6574 7572 6e20 4747 4d4c 5f4c 494e   return GGML_LIN
-00092a60: 4553 4541 5243 485f 4d41 5849 4d55 4d5f  ESEARCH_MAXIMUM_
-00092a70: 4954 4552 4154 494f 4e53 3b0a 2020 2020  ITERATIONS;.    
-00092a80: 2020 2020 7d0a 0a20 2020 2020 2020 2028      }..        (
-00092a90: 2a73 7465 7029 202a 3d20 7769 6474 683b  *step) *= width;
-00092aa0: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
-00092ab0: 726e 2047 474d 4c5f 4c49 4e45 5345 4152  rn GGML_LINESEAR
-00092ac0: 4348 5f46 4149 4c3b 0a7d 0a0a 7374 6174  CH_FAIL;.}..stat
-00092ad0: 6963 2065 6e75 6d20 6767 6d6c 5f6f 7074  ic enum ggml_opt
-00092ae0: 5f72 6573 756c 7420 6767 6d6c 5f6f 7074  _result ggml_opt
-00092af0: 5f6c 6266 6773 280a 2020 2020 2020 2020  _lbfgs(.        
-00092b00: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-00092b10: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-00092b20: 2020 2073 7472 7563 7420 6767 6d6c 5f6f     struct ggml_o
-00092b30: 7074 5f63 6f6e 7465 7874 202a 206f 7074  pt_context * opt
-00092b40: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00092b50: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
-00092b60: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00092b70: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00092b80: 736f 7220 2a20 662c 0a20 2020 2020 2020  sor * f,.       
-00092b90: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
-00092ba0: 6170 6820 2a20 6766 2c0a 2020 2020 2020  aph * gf,.      
-00092bb0: 2020 7374 7275 6374 2067 676d 6c5f 6367    struct ggml_cg
-00092bc0: 7261 7068 202a 2067 6229 207b 0a20 2020  raph * gb) {.   
-00092bd0: 2069 6620 2870 6172 616d 732e 6c62 6667   if (params.lbfg
-00092be0: 732e 6c69 6e65 7365 6172 6368 203d 3d20  s.linesearch == 
-00092bf0: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
-00092c00: 4241 434b 5452 4143 4b49 4e47 5f57 4f4c  BACKTRACKING_WOL
-00092c10: 4645 207c 7c0a 2020 2020 2020 2020 7061  FE ||.        pa
-00092c20: 7261 6d73 2e6c 6266 6773 2e6c 696e 6573  rams.lbfgs.lines
-00092c30: 6561 7263 6820 3d3d 2047 474d 4c5f 4c49  earch == GGML_LI
-00092c40: 4e45 5345 4152 4348 5f42 4143 4b54 5241  NESEARCH_BACKTRA
-00092c50: 434b 494e 475f 5354 524f 4e47 5f57 4f4c  CKING_STRONG_WOL
-00092c60: 4645 2920 7b0a 2020 2020 2020 2020 6966  FE) {.        if
-00092c70: 2028 7061 7261 6d73 2e6c 6266 6773 2e77   (params.lbfgs.w
-00092c80: 6f6c 6665 203c 3d20 7061 7261 6d73 2e6c  olfe <= params.l
-00092c90: 6266 6773 2e66 746f 6c20 7c7c 2031 2e66  bfgs.ftol || 1.f
-00092ca0: 203c 3d20 7061 7261 6d73 2e6c 6266 6773   <= params.lbfgs
-00092cb0: 2e77 6f6c 6665 2920 7b0a 2020 2020 2020  .wolfe) {.      
-00092cc0: 2020 2020 2020 7265 7475 726e 2047 474d        return GGM
-00092cd0: 4c5f 4f50 545f 494e 5641 4c49 445f 574f  L_OPT_INVALID_WO
-00092ce0: 4c46 453b 0a20 2020 2020 2020 207d 0a20  LFE;.        }. 
-00092cf0: 2020 207d 0a0a 2020 2020 6766 2d3e 6e5f     }..    gf->n_
-00092d00: 7468 7265 6164 7320 3d20 7061 7261 6d73  threads = params
-00092d10: 2e6e 5f74 6872 6561 6473 3b0a 2020 2020  .n_threads;.    
-00092d20: 6762 2d3e 6e5f 7468 7265 6164 7320 3d20  gb->n_threads = 
-00092d30: 7061 7261 6d73 2e6e 5f74 6872 6561 6473  params.n_threads
-00092d40: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00092d50: 206d 203d 2070 6172 616d 732e 6c62 6667   m = params.lbfg
-00092d60: 732e 6d3b 0a0a 2020 2020 2f2f 2074 6865  s.m;..    // the
-00092d70: 7365 2077 696c 6c20 7374 6f72 6520 7468  se will store th
-00092d80: 6520 7061 7261 6d65 7465 7273 2077 6520  e parameters we 
-00092d90: 7761 6e74 2074 6f20 6f70 7469 6d69 7a65  want to optimize
-00092da0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-00092db0: 5f74 656e 736f 7220 2a20 7073 5b47 474d  _tensor * ps[GGM
-00092dc0: 4c5f 4d41 585f 5041 5241 4d53 5d3b 0a0a  L_MAX_PARAMS];..
-00092dd0: 2020 2020 696e 7420 6e70 203d 2030 3b0a      int np = 0;.
-00092de0: 2020 2020 696e 7420 6e78 203d 2030 3b0a      int nx = 0;.
-00092df0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00092e00: 2030 3b20 6920 3c20 6766 2d3e 6e5f 6e6f   0; i < gf->n_no
-00092e10: 6465 733b 202b 2b69 2920 7b0a 2020 2020  des; ++i) {.    
-00092e20: 2020 2020 6966 2028 6766 2d3e 6e6f 6465      if (gf->node
-00092e30: 735b 695d 2d3e 6973 5f70 6172 616d 2920  s[i]->is_param) 
-00092e40: 7b0a 2020 2020 2020 2020 2020 2020 4747  {.            GG
-00092e50: 4d4c 5f50 5249 4e54 5f44 4542 5547 2822  ML_PRINT_DEBUG("
-00092e60: 666f 756e 6420 7061 7261 6d20 2564 3a20  found param %d: 
-00092e70: 6772 6164 2d3e 6f70 203d 2025 645c 6e22  grad->op = %d\n"
-00092e80: 2c20 6e70 2c20 6766 2d3e 6e6f 6465 735b  , np, gf->nodes[
-00092e90: 695d 2d3e 6772 6164 2d3e 6f70 293b 0a0a  i]->grad->op);..
-00092ea0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00092eb0: 5f41 5353 4552 5428 6e70 203c 2047 474d  _ASSERT(np < GGM
-00092ec0: 4c5f 4d41 585f 5041 5241 4d53 293b 0a0a  L_MAX_PARAMS);..
-00092ed0: 2020 2020 2020 2020 2020 2020 7073 5b6e              ps[n
-00092ee0: 702b 2b5d 203d 2067 662d 3e6e 6f64 6573  p++] = gf->nodes
-00092ef0: 5b69 5d3b 0a20 2020 2020 2020 2020 2020  [i];.           
-00092f00: 206e 7820 2b3d 2067 676d 6c5f 6e65 6c65   nx += ggml_nele
-00092f10: 6d65 6e74 7328 6766 2d3e 6e6f 6465 735b  ments(gf->nodes[
-00092f20: 695d 293b 0a20 2020 2020 2020 207d 0a20  i]);.        }. 
-00092f30: 2020 207d 0a0a 2020 2020 6966 2028 286f     }..    if ((o
-00092f40: 7074 2d3e 7061 7261 6d73 2e74 7970 6520  pt->params.type 
-00092f50: 213d 2070 6172 616d 732e 7479 7065 2920  != params.type) 
-00092f60: 7c7c 2028 6f70 742d 3e6e 7820 213d 206e  || (opt->nx != n
-00092f70: 7829 207c 7c20 286f 7074 2d3e 7061 7261  x) || (opt->para
-00092f80: 6d73 2e70 6173 7420 213d 2070 6172 616d  ms.past != param
-00092f90: 732e 7061 7374 2920 7c7c 2028 6f70 742d  s.past) || (opt-
-00092fa0: 3e70 6172 616d 732e 6c62 6667 732e 6d20  >params.lbfgs.m 
-00092fb0: 213d 2070 6172 616d 732e 6c62 6667 732e  != params.lbfgs.
-00092fc0: 6d29 2920 7b0a 2020 2020 2020 2020 696e  m)) {.        in
-00092fd0: 7420 6974 6572 203d 206f 7074 2d3e 6974  t iter = opt->it
-00092fe0: 6572 3b0a 2020 2020 2020 2020 6767 6d6c  er;.        ggml
-00092ff0: 5f6f 7074 5f69 6e69 7428 6374 782c 206f  _opt_init(ctx, o
-00093000: 7074 2c20 7061 7261 6d73 2c20 6e78 293b  pt, params, nx);
-00093010: 0a20 2020 2020 2020 206f 7074 2d3e 6974  .        opt->it
-00093020: 6572 203d 2069 7465 723b 0a20 2020 207d  er = iter;.    }
-00093030: 0a0a 2020 2020 666c 6f61 7420 2a20 7820  ..    float * x 
-00093040: 203d 206f 7074 2d3e 6c62 6667 732e 782d   = opt->lbfgs.x-
-00093050: 3e64 6174 613b 2020 2f2f 2063 7572 7265  >data;  // curre
-00093060: 6e74 2070 6172 616d 6574 6572 730a 2020  nt parameters.  
-00093070: 2020 666c 6f61 7420 2a20 7870 203d 206f    float * xp = o
-00093080: 7074 2d3e 6c62 6667 732e 7870 2d3e 6461  pt->lbfgs.xp->da
-00093090: 7461 3b20 2f2f 2070 7265 7669 6f75 7320  ta; // previous 
-000930a0: 7061 7261 6d65 7465 7273 0a20 2020 2066  parameters.    f
-000930b0: 6c6f 6174 202a 2067 2020 3d20 6f70 742d  loat * g  = opt-
-000930c0: 3e6c 6266 6773 2e67 2d3e 6461 7461 3b20  >lbfgs.g->data; 
-000930d0: 202f 2f20 6375 7272 656e 7420 6772 6164   // current grad
-000930e0: 6965 6e74 0a20 2020 2066 6c6f 6174 202a  ient.    float *
-000930f0: 2067 7020 3d20 6f70 742d 3e6c 6266 6773   gp = opt->lbfgs
-00093100: 2e67 702d 3e64 6174 613b 202f 2f20 7072  .gp->data; // pr
-00093110: 6576 696f 7573 2067 7261 6469 656e 740a  evious gradient.
-00093120: 2020 2020 666c 6f61 7420 2a20 6420 203d      float * d  =
-00093130: 206f 7074 2d3e 6c62 6667 732e 642d 3e64   opt->lbfgs.d->d
-00093140: 6174 613b 2020 2f2f 2073 6561 7263 6820  ata;  // search 
-00093150: 6469 7265 6374 696f 6e0a 0a20 2020 2066  direction..    f
-00093160: 6c6f 6174 202a 2070 6620 3d20 7061 7261  loat * pf = para
-00093170: 6d73 2e70 6173 7420 3e20 3020 3f20 6f70  ms.past > 0 ? op
-00093180: 742d 3e6c 6266 6773 2e70 662d 3e64 6174  t->lbfgs.pf->dat
-00093190: 6120 3a20 4e55 4c4c 3b20 2f2f 2070 6173  a : NULL; // pas
-000931a0: 7420 6675 6e63 7469 6f6e 2076 616c 7565  t function value
-000931b0: 730a 0a20 2020 2066 6c6f 6174 2066 7820  s..    float fx 
-000931c0: 2020 203d 2030 2e30 663b 202f 2f20 636f     = 0.0f; // co
-000931d0: 7374 2066 756e 6374 696f 6e20 7661 6c75  st function valu
-000931e0: 650a 2020 2020 666c 6f61 7420 786e 6f72  e.    float xnor
-000931f0: 6d20 3d20 302e 3066 3b20 2f2f 207c 7c78  m = 0.0f; // ||x
-00093200: 7c7c 0a20 2020 2066 6c6f 6174 2067 6e6f  ||.    float gno
-00093210: 726d 203d 2030 2e30 663b 202f 2f20 7c7c  rm = 0.0f; // ||
-00093220: 677c 7c0a 0a20 2020 202f 2f20 696e 6974  g||..    // init
-00093230: 6961 6c69 7a65 2078 2066 726f 6d20 7468  ialize x from th
-00093240: 6520 6772 6170 6820 6e6f 6465 730a 2020  e graph nodes.  
-00093250: 2020 6767 6d6c 5f6f 7074 5f67 6574 5f70    ggml_opt_get_p
-00093260: 6172 616d 7328 6e70 2c20 7073 2c20 7829  arams(np, ps, x)
-00093270: 3b0a 0a20 2020 202f 2f20 7468 6520 4c2d  ;..    // the L-
-00093280: 4246 4753 206d 656d 6f72 790a 2020 2020  BFGS memory.    
-00093290: 666c 6f61 7420 2a20 6c6d 5f61 6c70 6861  float * lm_alpha
-000932a0: 203d 206f 7074 2d3e 6c62 6667 732e 6c6d   = opt->lbfgs.lm
-000932b0: 616c 2d3e 6461 7461 3b0a 2020 2020 666c  al->data;.    fl
-000932c0: 6f61 7420 2a20 6c6d 5f79 7320 2020 203d  oat * lm_ys    =
-000932d0: 206f 7074 2d3e 6c62 6667 732e 6c6d 7973   opt->lbfgs.lmys
-000932e0: 2d3e 6461 7461 3b0a 2020 2020 666c 6f61  ->data;.    floa
-000932f0: 7420 2a20 6c6d 5f73 2020 2020 203d 206f  t * lm_s     = o
-00093300: 7074 2d3e 6c62 6667 732e 6c6d 732d 3e64  pt->lbfgs.lms->d
-00093310: 6174 613b 0a20 2020 2066 6c6f 6174 202a  ata;.    float *
-00093320: 206c 6d5f 7920 2020 2020 3d20 6f70 742d   lm_y     = opt-
-00093330: 3e6c 6266 6773 2e6c 6d79 2d3e 6461 7461  >lbfgs.lmy->data
-00093340: 3b0a 0a20 2020 202f 2f20 6576 616c 7561  ;..    // evalua
-00093350: 7465 2074 6865 2066 756e 6374 696f 6e20  te the function 
-00093360: 7661 6c75 6520 616e 6420 6974 7320 6772  value and its gr
-00093370: 6164 6965 6e74 0a20 2020 207b 0a20 2020  adient.    {.   
-00093380: 2020 2020 2067 676d 6c5f 6f70 745f 7365       ggml_opt_se
-00093390: 745f 7061 7261 6d73 286e 702c 2070 732c  t_params(np, ps,
-000933a0: 2078 293b 0a0a 2020 2020 2020 2020 6767   x);..        gg
-000933b0: 6d6c 5f67 7261 7068 5f72 6573 6574 2020  ml_graph_reset  
-000933c0: 2867 6629 3b0a 2020 2020 2020 2020 6767  (gf);.        gg
-000933d0: 6d6c 5f73 6574 5f66 3332 2020 2020 2020  ml_set_f32      
-000933e0: 2866 2d3e 6772 6164 2c20 312e 3066 293b  (f->grad, 1.0f);
-000933f0: 0a20 2020 2020 2020 2067 676d 6c5f 6772  .        ggml_gr
-00093400: 6170 685f 636f 6d70 7574 6528 6374 782c  aph_compute(ctx,
-00093410: 2067 6229 3b0a 0a20 2020 2020 2020 2067   gb);..        g
-00093420: 676d 6c5f 6f70 745f 6765 745f 6772 6164  gml_opt_get_grad
-00093430: 286e 702c 2070 732c 2067 293b 0a0a 2020  (np, ps, g);..  
-00093440: 2020 2020 2020 6678 203d 2067 676d 6c5f        fx = ggml_
-00093450: 6765 745f 6633 325f 3164 2866 2c20 3029  get_f32_1d(f, 0)
-00093460: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
-00093470: 7365 6172 6368 2064 6972 6563 7469 6f6e  search direction
-00093480: 203d 202d 6772 6164 6965 6e74 0a20 2020   = -gradient.   
-00093490: 2067 676d 6c5f 7665 635f 6e65 675f 6633   ggml_vec_neg_f3
-000934a0: 3228 6e78 2c20 642c 2067 293b 0a0a 2020  2(nx, d, g);..  
-000934b0: 2020 2f2f 207c 7c78 7c7c 2c20 7c7c 677c    // ||x||, ||g|
-000934c0: 7c0a 2020 2020 6767 6d6c 5f76 6563 5f6e  |.    ggml_vec_n
-000934d0: 6f72 6d5f 6633 3228 6e78 2c20 2678 6e6f  orm_f32(nx, &xno
-000934e0: 726d 2c20 7829 3b0a 2020 2020 6767 6d6c  rm, x);.    ggml
-000934f0: 5f76 6563 5f6e 6f72 6d5f 6633 3228 6e78  _vec_norm_f32(nx
-00093500: 2c20 2667 6e6f 726d 2c20 6729 3b0a 0a20  , &gnorm, g);.. 
-00093510: 2020 2069 6620 2878 6e6f 726d 203c 2031     if (xnorm < 1
-00093520: 2e30 6629 207b 0a20 2020 2020 2020 2078  .0f) {.        x
-00093530: 6e6f 726d 203d 2031 2e30 663b 0a20 2020  norm = 1.0f;.   
-00093540: 207d 0a0a 2020 2020 2f2f 2061 6c72 6561   }..    // alrea
-00093550: 6479 206f 7074 696d 697a 6564 0a20 2020  dy optimized.   
-00093560: 2069 6620 2867 6e6f 726d 2f78 6e6f 726d   if (gnorm/xnorm
-00093570: 203c 3d20 7061 7261 6d73 2e6c 6266 6773   <= params.lbfgs
-00093580: 2e65 7073 2920 7b0a 2020 2020 2020 2020  .eps) {.        
-00093590: 7265 7475 726e 2047 474d 4c5f 4f50 545f  return GGML_OPT_
-000935a0: 4f4b 3b0a 2020 2020 7d0a 0a20 2020 2069  OK;.    }..    i
-000935b0: 6620 286f 7074 2d3e 6a75 7374 5f69 6e69  f (opt->just_ini
-000935c0: 7469 616c 697a 6564 2920 7b0a 2020 2020  tialized) {.    
-000935d0: 2020 2020 6966 2028 7066 2920 7b0a 2020      if (pf) {.  
-000935e0: 2020 2020 2020 2020 2020 7066 5b30 5d20            pf[0] 
-000935f0: 3d20 6678 3b0a 2020 2020 2020 2020 7d0a  = fx;.        }.
-00093600: 2020 2020 2020 2020 6f70 742d 3e6c 6266          opt->lbf
-00093610: 6773 2e66 785f 6265 7374 203d 2066 783b  gs.fx_best = fx;
-00093620: 0a0a 2020 2020 2020 2020 2f2f 2069 6e69  ..        // ini
-00093630: 7469 616c 2073 7465 700a 2020 2020 2020  tial step.      
-00093640: 2020 6767 6d6c 5f76 6563 5f6e 6f72 6d5f    ggml_vec_norm_
-00093650: 696e 765f 6633 3228 6e78 2c20 266f 7074  inv_f32(nx, &opt
-00093660: 2d3e 6c62 6667 732e 7374 6570 2c20 6429  ->lbfgs.step, d)
-00093670: 3b0a 2020 2020 2020 2020 6f70 742d 3e6c  ;.        opt->l
-00093680: 6266 6773 2e6a 2020 2020 2020 2020 2020  bfgs.j          
-00093690: 2020 2020 2020 3d20 303b 0a20 2020 2020        = 0;.     
-000936a0: 2020 206f 7074 2d3e 6c62 6667 732e 6b20     opt->lbfgs.k 
-000936b0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
-000936c0: 2031 3b0a 2020 2020 2020 2020 6f70 742d   1;.        opt-
-000936d0: 3e6c 6266 6773 2e65 6e64 2020 2020 2020  >lbfgs.end      
-000936e0: 2020 2020 2020 2020 3d20 303b 0a20 2020          = 0;.   
-000936f0: 2020 2020 206f 7074 2d3e 6c62 6667 732e       opt->lbfgs.
-00093700: 6e5f 6e6f 5f69 6d70 726f 7665 6d65 6e74  n_no_improvement
-00093710: 203d 2030 3b0a 2020 2020 2020 2020 6f70   = 0;.        op
-00093720: 742d 3e6a 7573 745f 696e 6974 6961 6c69  t->just_initiali
-00093730: 7a65 6420 2020 2020 2020 3d20 6661 6c73  zed       = fals
-00093740: 653b 0a20 2020 207d 0a0a 2020 2020 666c  e;.    }..    fl
-00093750: 6f61 7420 2a20 6678 5f62 6573 7420 2020  oat * fx_best   
-00093760: 2020 2020 203d 2026 6f70 742d 3e6c 6266       = &opt->lbf
-00093770: 6773 2e66 785f 6265 7374 3b0a 2020 2020  gs.fx_best;.    
-00093780: 666c 6f61 7420 2a20 7374 6570 2020 2020  float * step    
-00093790: 2020 2020 2020 203d 2026 6f70 742d 3e6c         = &opt->l
-000937a0: 6266 6773 2e73 7465 703b 0a20 2020 2069  bfgs.step;.    i
-000937b0: 6e74 202a 206a 2020 2020 2020 2020 2020  nt * j          
-000937c0: 2020 2020 2020 3d20 266f 7074 2d3e 6c62        = &opt->lb
-000937d0: 6667 732e 6a3b 0a20 2020 2069 6e74 202a  fgs.j;.    int *
-000937e0: 206b 2020 2020 2020 2020 2020 2020 2020   k              
-000937f0: 2020 3d20 266f 7074 2d3e 6c62 6667 732e    = &opt->lbfgs.
-00093800: 6b3b 0a20 2020 2069 6e74 202a 2065 6e64  k;.    int * end
-00093810: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
-00093820: 266f 7074 2d3e 6c62 6667 732e 656e 643b  &opt->lbfgs.end;
-00093830: 0a20 2020 2069 6e74 202a 206e 5f6e 6f5f  .    int * n_no_
-00093840: 696d 7072 6f76 656d 656e 7420 3d20 266f  improvement = &o
-00093850: 7074 2d3e 6c62 6667 732e 6e5f 6e6f 5f69  pt->lbfgs.n_no_i
-00093860: 6d70 726f 7665 6d65 6e74 3b0a 0a20 2020  mprovement;..   
-00093870: 2069 6e74 206c 7320 2020 2020 3d20 303b   int ls     = 0;
-00093880: 0a20 2020 2069 6e74 2062 6f75 6e64 2020  .    int bound  
-00093890: 3d20 303b 0a0a 2020 2020 666c 6f61 7420  = 0;..    float 
-000938a0: 7973 2020 203d 2030 2e30 663b 0a20 2020  ys   = 0.0f;.   
-000938b0: 2066 6c6f 6174 2079 7920 2020 3d20 302e   float yy   = 0.
-000938c0: 3066 3b0a 2020 2020 666c 6f61 7420 6265  0f;.    float be
-000938d0: 7461 203d 2030 2e30 663b 0a0a 2020 2020  ta = 0.0f;..    
-000938e0: 696e 7420 6974 203d 2030 3b0a 0a20 2020  int it = 0;..   
-000938f0: 2077 6869 6c65 2028 7472 7565 2920 7b0a   while (true) {.
-00093900: 2020 2020 2020 2020 2f2f 2073 746f 7265          // store
-00093910: 2074 6865 2063 7572 7265 6e74 2070 6f73   the current pos
-00093920: 6974 696f 6e20 616e 6420 6772 6164 6965  ition and gradie
-00093930: 6e74 2076 6563 746f 7273 0a20 2020 2020  nt vectors.     
-00093940: 2020 2067 676d 6c5f 7665 635f 6370 795f     ggml_vec_cpy_
-00093950: 6633 3228 6e78 2c20 7870 2c20 7829 3b0a  f32(nx, xp, x);.
-00093960: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-00093970: 5f63 7079 5f66 3332 286e 782c 2067 702c  _cpy_f32(nx, gp,
-00093980: 2067 293b 0a0a 2020 2020 2020 2020 6c73   g);..        ls
-00093990: 203d 206c 696e 6573 6561 7263 685f 6261   = linesearch_ba
-000939a0: 636b 7472 6163 6b69 6e67 2863 7478 2c20  cktracking(ctx, 
-000939b0: 2670 6172 616d 732c 206e 782c 2078 2c20  &params, nx, x, 
-000939c0: 2666 782c 2067 2c20 642c 2073 7465 702c  &fx, g, d, step,
-000939d0: 2078 702c 2066 2c20 6766 2c20 6762 2c20   xp, f, gf, gb, 
-000939e0: 6e70 2c20 7073 293b 0a0a 2020 2020 2020  np, ps);..      
-000939f0: 2020 6966 2028 6c73 203c 2030 2920 7b0a    if (ls < 0) {.
-00093a00: 2020 2020 2020 2020 2020 2020 2f2f 206c              // l
-00093a10: 696e 6573 6561 7263 6820 6661 696c 6564  inesearch failed
-00093a20: 202d 2067 6f20 6261 636b 2074 6f20 7468   - go back to th
-00093a30: 6520 7072 6576 696f 7573 2070 6f69 6e74  e previous point
-00093a40: 2061 6e64 2072 6574 7572 6e0a 2020 2020   and return.    
-00093a50: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-00093a60: 5f63 7079 5f66 3332 286e 782c 2078 2c20  _cpy_f32(nx, x, 
-00093a70: 7870 293b 0a20 2020 2020 2020 2020 2020  xp);.           
-00093a80: 2067 676d 6c5f 7665 635f 6370 795f 6633   ggml_vec_cpy_f3
-00093a90: 3228 6e78 2c20 672c 2067 7029 3b0a 0a20  2(nx, g, gp);.. 
-00093aa0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00093ab0: 6e20 6c73 3b0a 2020 2020 2020 2020 7d0a  n ls;.        }.
-00093ac0: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-00093ad0: 635f 6e6f 726d 5f66 3332 286e 782c 2026  c_norm_f32(nx, &
-00093ae0: 786e 6f72 6d2c 2078 293b 0a20 2020 2020  xnorm, x);.     
-00093af0: 2020 2067 676d 6c5f 7665 635f 6e6f 726d     ggml_vec_norm
-00093b00: 5f66 3332 286e 782c 2026 676e 6f72 6d2c  _f32(nx, &gnorm,
-00093b10: 2067 293b 0a0a 2020 2020 2020 2020 4747   g);..        GG
-00093b20: 4d4c 5f50 5249 4e54 5f44 4542 5547 2822  ML_PRINT_DEBUG("
-00093b30: 6620 3d20 2531 302e 3666 5c6e 222c 2067  f = %10.6f\n", g
-00093b40: 676d 6c5f 6765 745f 6633 325f 3164 2866  gml_get_f32_1d(f
-00093b50: 2c20 3029 293b 0a0a 2020 2020 2020 2020  , 0));..        
-00093b60: 6966 2028 786e 6f72 6d20 3c20 312e 3066  if (xnorm < 1.0f
-00093b70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00093b80: 786e 6f72 6d20 3d20 312e 3066 3b0a 2020  xnorm = 1.0f;.  
-00093b90: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00093ba0: 6966 2028 676e 6f72 6d2f 786e 6f72 6d20  if (gnorm/xnorm 
-00093bb0: 3c3d 2070 6172 616d 732e 6c62 6667 732e  <= params.lbfgs.
-00093bc0: 6570 7329 207b 0a20 2020 2020 2020 2020  eps) {.         
-00093bd0: 2020 202f 2f20 636f 6e76 6572 6765 640a     // converged.
-00093be0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00093bf0: 726e 2047 474d 4c5f 4f50 545f 4f4b 3b0a  rn GGML_OPT_OK;.
-00093c00: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00093c10: 2020 202f 2f20 6465 6c74 612d 6261 7365     // delta-base
-00093c20: 6420 636f 6e76 6572 6765 6e63 6520 7465  d convergence te
-00093c30: 7374 0a20 2020 2020 2020 2069 6620 2870  st.        if (p
-00093c40: 6620 213d 204e 554c 4c29 207b 0a20 2020  f != NULL) {.   
-00093c50: 2020 2020 2020 2020 202f 2f20 6e65 6564           // need
-00093c60: 2061 7420 6c65 6173 7420 7061 7261 6d73   at least params
-00093c70: 2e70 6173 7420 6974 6572 6174 696f 6e73  .past iterations
-00093c80: 2074 6f20 7374 6172 7420 6368 6563 6b69   to start checki
-00093c90: 6e67 2066 6f72 2063 6f6e 7665 7267 656e  ng for convergen
-00093ca0: 6365 0a20 2020 2020 2020 2020 2020 2069  ce.            i
-00093cb0: 6620 2870 6172 616d 732e 7061 7374 203c  f (params.past <
-00093cc0: 3d20 6b5b 305d 2920 7b0a 2020 2020 2020  = k[0]) {.      
-00093cd0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00093ce0: 666c 6f61 7420 7261 7465 203d 2028 7066  float rate = (pf
-00093cf0: 5b6b 5b30 5d25 7061 7261 6d73 2e70 6173  [k[0]%params.pas
-00093d00: 745d 202d 2066 7829 2f66 783b 0a0a 2020  t] - fx)/fx;..  
-00093d10: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00093d20: 2028 6661 6273 6628 7261 7465 2920 3c20   (fabsf(rate) < 
-00093d30: 7061 7261 6d73 2e64 656c 7461 2920 7b0a  params.delta) {.
-00093d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00093d50: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
-00093d60: 4f50 545f 4f4b 3b0a 2020 2020 2020 2020  OPT_OK;.        
-00093d70: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00093d80: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00093d90: 2020 2020 2070 665b 6b5b 305d 2570 6172       pf[k[0]%par
-00093da0: 616d 732e 7061 7374 5d20 3d20 6678 3b0a  ams.past] = fx;.
-00093db0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00093dc0: 2020 202f 2f20 6368 6563 6b20 666f 7220     // check for 
-00093dd0: 696d 7072 6f76 656d 656e 740a 2020 2020  improvement.    
-00093de0: 2020 2020 6966 2028 7061 7261 6d73 2e6d      if (params.m
-00093df0: 6178 5f6e 6f5f 696d 7072 6f76 656d 656e  ax_no_improvemen
-00093e00: 7420 3e20 3029 207b 0a20 2020 2020 2020  t > 0) {.       
-00093e10: 2020 2020 2069 6620 2866 7820 3c20 6678       if (fx < fx
-00093e20: 5f62 6573 745b 305d 2920 7b0a 2020 2020  _best[0]) {.    
-00093e30: 2020 2020 2020 2020 2020 2020 6678 5f62              fx_b
-00093e40: 6573 745b 305d 203d 2066 783b 0a20 2020  est[0] = fx;.   
-00093e50: 2020 2020 2020 2020 2020 2020 206e 5f6e               n_n
-00093e60: 6f5f 696d 7072 6f76 656d 656e 745b 305d  o_improvement[0]
-00093e70: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
-00093e80: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00093e90: 2020 2020 2020 2020 2020 206e 5f6e 6f5f             n_no_
-00093ea0: 696d 7072 6f76 656d 656e 745b 305d 2b2b  improvement[0]++
-00093eb0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00093ec0: 2020 2069 6620 286e 5f6e 6f5f 696d 7072     if (n_no_impr
-00093ed0: 6f76 656d 656e 745b 305d 203e 3d20 7061  ovement[0] >= pa
-00093ee0: 7261 6d73 2e6d 6178 5f6e 6f5f 696d 7072  rams.max_no_impr
-00093ef0: 6f76 656d 656e 7429 207b 0a20 2020 2020  ovement) {.     
-00093f00: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00093f10: 6574 7572 6e20 4747 4d4c 5f4f 5054 5f4f  eturn GGML_OPT_O
-00093f20: 4b3b 0a20 2020 2020 2020 2020 2020 2020  K;.             
-00093f30: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00093f40: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-00093f50: 2020 2020 2020 6966 2028 7061 7261 6d73        if (params
-00093f60: 2e6c 6266 6773 2e6e 5f69 7465 7220 213d  .lbfgs.n_iter !=
-00093f70: 2030 2026 2620 7061 7261 6d73 2e6c 6266   0 && params.lbf
-00093f80: 6773 2e6e 5f69 7465 7220 3c20 6974 202b  gs.n_iter < it +
-00093f90: 2031 2920 7b0a 2020 2020 2020 2020 2020   1) {.          
-00093fa0: 2020 2f2f 2072 6561 6368 6564 2074 6865    // reached the
-00093fb0: 206d 6178 696d 756d 206e 756d 6265 7220   maximum number 
-00093fc0: 6f66 2069 7465 7261 7469 6f6e 730a 2020  of iterations.  
-00093fd0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00093fe0: 2047 474d 4c5f 4f50 545f 4449 445f 4e4f   GGML_OPT_DID_NO
-00093ff0: 545f 434f 4e56 4552 4745 3b0a 2020 2020  T_CONVERGE;.    
-00094000: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
-00094010: 2f20 7570 6461 7465 2076 6563 746f 7273  / update vectors
-00094020: 2073 2061 6e64 2079 3a0a 2020 2020 2020   s and y:.      
-00094030: 2020 2f2f 2020 2073 5f7b 6b2b 317d 203d    //   s_{k+1} =
-00094040: 2078 5f7b 6b2b 317d 202d 2078 5f7b 6b7d   x_{k+1} - x_{k}
-00094050: 203d 205c 7374 6570 202a 2064 5f7b 6b7d   = \step * d_{k}
-00094060: 2e0a 2020 2020 2020 2020 2f2f 2020 2079  ..        //   y
-00094070: 5f7b 6b2b 317d 203d 2067 5f7b 6b2b 317d  _{k+1} = g_{k+1}
-00094080: 202d 2067 5f7b 6b7d 2e0a 2020 2020 2020   - g_{k}..      
-00094090: 2020 2f2f 0a20 2020 2020 2020 2067 676d    //.        ggm
-000940a0: 6c5f 7665 635f 7375 625f 6633 3228 6e78  l_vec_sub_f32(nx
-000940b0: 2c20 266c 6d5f 735b 656e 645b 305d 2a6e  , &lm_s[end[0]*n
-000940c0: 785d 2c20 782c 2078 7029 3b0a 2020 2020  x], x, xp);.    
-000940d0: 2020 2020 6767 6d6c 5f76 6563 5f73 7562      ggml_vec_sub
-000940e0: 5f66 3332 286e 782c 2026 6c6d 5f79 5b65  _f32(nx, &lm_y[e
-000940f0: 6e64 5b30 5d2a 6e78 5d2c 2067 2c20 6770  nd[0]*nx], g, gp
-00094100: 293b 0a0a 2020 2020 2020 2020 2f2f 2063  );..        // c
-00094110: 6f6d 7075 7465 2073 6361 6c61 7273 2079  ompute scalars y
-00094120: 7320 616e 6420 7979 3a0a 2020 2020 2020  s and yy:.      
-00094130: 2020 2f2f 2020 2020 2079 7320 3d20 795e    //     ys = y^
-00094140: 7420 5c63 646f 7420 7320 2020 202d 3e20  t \cdot s    -> 
-00094150: 3120 2f20 5c72 686f 2e0a 2020 2020 2020  1 / \rho..      
-00094160: 2020 2f2f 2020 2020 2079 7920 3d20 795e    //     yy = y^
-00094170: 7420 5c63 646f 7420 792e 0a20 2020 2020  t \cdot y..     
-00094180: 2020 202f 2f0a 2020 2020 2020 2020 6767     //.        gg
-00094190: 6d6c 5f76 6563 5f64 6f74 5f66 3332 286e  ml_vec_dot_f32(n
-000941a0: 782c 2026 7973 2c20 266c 6d5f 795b 656e  x, &ys, &lm_y[en
-000941b0: 645b 305d 2a6e 785d 2c20 266c 6d5f 735b  d[0]*nx], &lm_s[
-000941c0: 656e 645b 305d 202a 6e78 5d29 3b0a 2020  end[0] *nx]);.  
-000941d0: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
-000941e0: 6f74 5f66 3332 286e 782c 2026 7979 2c20  ot_f32(nx, &yy, 
-000941f0: 266c 6d5f 795b 656e 645b 305d 2a6e 785d  &lm_y[end[0]*nx]
-00094200: 2c20 266c 6d5f 795b 656e 645b 305d 2a6e  , &lm_y[end[0]*n
-00094210: 785d 293b 0a0a 2020 2020 2020 2020 6c6d  x]);..        lm
-00094220: 5f79 735b 656e 645b 305d 5d20 3d20 7973  _ys[end[0]] = ys
-00094230: 3b0a 0a20 2020 2020 2020 202f 2f20 6669  ;..        // fi
-00094240: 6e64 206e 6577 2073 6561 7263 6820 6469  nd new search di
-00094250: 7265 6374 696f 6e0a 2020 2020 2020 2020  rection.        
-00094260: 2f2f 2020 2072 6566 3a20 6874 7470 733a  //   ref: https:
-00094270: 2f2f 656e 2e77 696b 6970 6564 6961 2e6f  //en.wikipedia.o
-00094280: 7267 2f77 696b 692f 4c69 6d69 7465 642d  rg/wiki/Limited-
-00094290: 6d65 6d6f 7279 5f42 4647 530a 0a20 2020  memory_BFGS..   
-000942a0: 2020 2020 2062 6f75 6e64 203d 2028 6d20       bound = (m 
-000942b0: 3c3d 206b 5b30 5d29 203f 206d 203a 206b  <= k[0]) ? m : k
-000942c0: 5b30 5d3b 0a20 2020 2020 2020 206b 5b30  [0];.        k[0
-000942d0: 5d2b 2b3b 0a20 2020 2020 2020 2069 742b  ]++;.        it+
-000942e0: 2b3b 0a20 2020 2020 2020 2065 6e64 5b30  +;.        end[0
-000942f0: 5d20 3d20 2865 6e64 5b30 5d20 2b20 3129  ] = (end[0] + 1)
-00094300: 256d 3b0a 0a20 2020 2020 2020 202f 2f20  %m;..        // 
-00094310: 696e 6974 6961 6c69 7a65 2073 6561 7263  initialize searc
-00094320: 6820 6469 7265 6374 696f 6e20 7769 7468  h direction with
-00094330: 202d 670a 2020 2020 2020 2020 6767 6d6c   -g.        ggml
-00094340: 5f76 6563 5f6e 6567 5f66 3332 286e 782c  _vec_neg_f32(nx,
-00094350: 2064 2c20 6729 3b0a 0a20 2020 2020 2020   d, g);..       
-00094360: 206a 5b30 5d20 3d20 656e 645b 305d 3b0a   j[0] = end[0];.
-00094370: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00094380: 2069 203d 2030 3b20 6920 3c20 626f 756e   i = 0; i < boun
-00094390: 643b 202b 2b69 2920 7b0a 2020 2020 2020  d; ++i) {.      
-000943a0: 2020 2020 2020 6a5b 305d 203d 2028 6a5b        j[0] = (j[
-000943b0: 305d 202b 206d 202d 2031 2920 2520 6d3b  0] + m - 1) % m;
-000943c0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-000943d0: 5c61 6c70 6861 5f7b 6a7d 203d 205c 7268  \alpha_{j} = \rh
-000943e0: 6f5f 7b6a 7d20 735e 7b74 7d5f 7b6a 7d20  o_{j} s^{t}_{j} 
-000943f0: 5c63 646f 7420 715f 7b6b 2b31 7d0a 2020  \cdot q_{k+1}.  
-00094400: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-00094410: 6563 5f64 6f74 5f66 3332 286e 782c 2026  ec_dot_f32(nx, &
-00094420: 6c6d 5f61 6c70 6861 5b6a 5b30 5d5d 2c20  lm_alpha[j[0]], 
-00094430: 266c 6d5f 735b 6a5b 305d 2a6e 785d 2c20  &lm_s[j[0]*nx], 
-00094440: 6429 3b0a 2020 2020 2020 2020 2020 2020  d);.            
-00094450: 6c6d 5f61 6c70 6861 5b6a 5b30 5d5d 202f  lm_alpha[j[0]] /
-00094460: 3d20 6c6d 5f79 735b 6a5b 305d 5d3b 0a20  = lm_ys[j[0]];. 
-00094470: 2020 2020 2020 2020 2020 202f 2f20 715f             // q_
-00094480: 7b69 7d20 3d20 715f 7b69 2b31 7d20 2d20  {i} = q_{i+1} - 
-00094490: 5c61 6c70 6861 5f7b 697d 2079 5f7b 697d  \alpha_{i} y_{i}
-000944a0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-000944b0: 6c5f 7665 635f 6d61 645f 6633 3228 6e78  l_vec_mad_f32(nx
-000944c0: 2c20 642c 2026 6c6d 5f79 5b6a 5b30 5d2a  , d, &lm_y[j[0]*
-000944d0: 6e78 5d2c 202d 6c6d 5f61 6c70 6861 5b6a  nx], -lm_alpha[j
-000944e0: 5b30 5d5d 293b 0a20 2020 2020 2020 207d  [0]]);.        }
-000944f0: 0a0a 2020 2020 2020 2020 6767 6d6c 5f76  ..        ggml_v
-00094500: 6563 5f73 6361 6c65 5f66 3332 286e 782c  ec_scale_f32(nx,
-00094510: 2064 2c20 7973 2f79 7929 3b0a 0a20 2020   d, ys/yy);..   
-00094520: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-00094530: 3d20 303b 2069 203c 2062 6f75 6e64 3b20  = 0; i < bound; 
-00094540: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
-00094550: 2020 202f 2f20 5c62 6574 615f 7b6a 7d20     // \beta_{j} 
-00094560: 3d20 5c72 686f 5f7b 6a7d 2079 5e74 5f7b  = \rho_{j} y^t_{
-00094570: 6a7d 205c 6364 6f74 205c 6761 6d6d 615f  j} \cdot \gamma_
-00094580: 7b69 7d0a 2020 2020 2020 2020 2020 2020  {i}.            
-00094590: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3332  ggml_vec_dot_f32
-000945a0: 286e 782c 2026 6265 7461 2c20 266c 6d5f  (nx, &beta, &lm_
-000945b0: 795b 6a5b 305d 2a6e 785d 2c20 6429 3b0a  y[j[0]*nx], d);.
-000945c0: 2020 2020 2020 2020 2020 2020 6265 7461              beta
-000945d0: 202f 3d20 6c6d 5f79 735b 6a5b 305d 5d3b   /= lm_ys[j[0]];
-000945e0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-000945f0: 5c67 616d 6d61 5f7b 692b 317d 203d 205c  \gamma_{i+1} = \
-00094600: 6761 6d6d 615f 7b69 7d20 2b20 285c 616c  gamma_{i} + (\al
-00094610: 7068 615f 7b6a 7d20 2d20 5c62 6574 615f  pha_{j} - \beta_
-00094620: 7b6a 7d29 2073 5f7b 6a7d 0a20 2020 2020  {j}) s_{j}.     
-00094630: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00094640: 6d61 645f 6633 3228 6e78 2c20 642c 2026  mad_f32(nx, d, &
-00094650: 6c6d 5f73 5b6a 5b30 5d2a 6e78 5d2c 206c  lm_s[j[0]*nx], l
-00094660: 6d5f 616c 7068 615b 6a5b 305d 5d20 2d20  m_alpha[j[0]] - 
-00094670: 6265 7461 293b 0a20 2020 2020 2020 2020  beta);.         
-00094680: 2020 206a 5b30 5d20 3d20 286a 5b30 5d20     j[0] = (j[0] 
-00094690: 2b20 3129 256d 3b0a 2020 2020 2020 2020  + 1)%m;.        
-000946a0: 7d0a 0a20 2020 2020 2020 2073 7465 705b  }..        step[
-000946b0: 305d 203d 2031 2e30 3b0a 2020 2020 7d0a  0] = 1.0;.    }.
-000946c0: 0a20 2020 2072 6574 7572 6e20 4747 4d4c  .    return GGML
-000946d0: 5f4f 5054 5f44 4944 5f4e 4f54 5f43 4f4e  _OPT_DID_NOT_CON
-000946e0: 5645 5247 453b 0a7d 0a0a 7374 7275 6374  VERGE;.}..struct
-000946f0: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
-00094700: 2067 676d 6c5f 6f70 745f 6465 6661 756c   ggml_opt_defaul
-00094710: 745f 7061 7261 6d73 2865 6e75 6d20 6767  t_params(enum gg
-00094720: 6d6c 5f6f 7074 5f74 7970 6520 7479 7065  ml_opt_type type
-00094730: 2920 7b0a 2020 2020 7374 7275 6374 2067  ) {.    struct g
-00094740: 676d 6c5f 6f70 745f 7061 7261 6d73 2072  gml_opt_params r
-00094750: 6573 756c 743b 0a0a 2020 2020 7377 6974  esult;..    swit
-00094760: 6368 2028 7479 7065 2920 7b0a 2020 2020  ch (type) {.    
-00094770: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00094780: 545f 4144 414d 3a0a 2020 2020 2020 2020  T_ADAM:.        
-00094790: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000947a0: 2020 2020 2020 7265 7375 6c74 203d 2028        result = (
-000947b0: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
-000947c0: 7061 7261 6d73 2920 7b0a 2020 2020 2020  params) {.      
-000947d0: 2020 2020 2020 2020 2020 2020 2020 2e74                .t
-000947e0: 7970 6520 2020 2020 203d 2047 474d 4c5f  ype      = GGML_
-000947f0: 4f50 545f 4144 414d 2c0a 2020 2020 2020  OPT_ADAM,.      
-00094800: 2020 2020 2020 2020 2020 2020 2020 2e6e                .n
-00094810: 5f74 6872 6561 6473 203d 2031 2c0a 2020  _threads = 1,.  
-00094820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094830: 2020 2e70 6173 7420 2020 2020 203d 2030    .past      = 0
-00094840: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00094850: 2020 2020 2020 2e64 656c 7461 2020 2020        .delta    
-00094860: 203d 2031 652d 3566 2c0a 0a20 2020 2020   = 1e-5f,..     
-00094870: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-00094880: 6d61 785f 6e6f 5f69 6d70 726f 7665 6d65  max_no_improveme
-00094890: 6e74 203d 2031 3030 2c0a 0a20 2020 2020  nt = 100,..     
-000948a0: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-000948b0: 7072 696e 745f 666f 7277 6172 645f 6772  print_forward_gr
-000948c0: 6170 6820 203d 2074 7275 652c 0a20 2020  aph  = true,.   
-000948d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000948e0: 202e 7072 696e 745f 6261 636b 7761 7264   .print_backward
-000948f0: 5f67 7261 7068 203d 2074 7275 652c 0a0a  _graph = true,..
-00094900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094910: 2020 2020 2e61 6461 6d20 3d20 7b0a 2020      .adam = {.  
-00094920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094930: 2020 2020 2020 2e6e 5f69 7465 7220 3d20        .n_iter = 
-00094940: 3130 3030 302c 0a20 2020 2020 2020 2020  10000,.         
-00094950: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-00094960: 7363 6865 6420 203d 2031 2e30 3030 662c  sched  = 1.000f,
-00094970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00094980: 2020 2020 2020 2020 202e 6465 6361 7920           .decay 
-00094990: 203d 2030 2e30 3031 662c 0a20 2020 2020   = 0.001f,.     
-000949a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000949b0: 2020 202e 616c 7068 6120 203d 2030 2e30     .alpha  = 0.0
-000949c0: 3031 662c 0a20 2020 2020 2020 2020 2020  01f,.           
-000949d0: 2020 2020 2020 2020 2020 2020 202e 6265               .be
-000949e0: 7461 3120 203d 2030 2e39 662c 0a20 2020  ta1  = 0.9f,.   
+0008de40: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+0008de50: 4747 4d4c 5f4f 505f 5452 414e 5350 4f53  GGML_OP_TRANSPOS
+0008de60: 453a 0a20 2020 2020 2020 2020 2020 2020  E:.             
+0008de70: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0008de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008de90: 2020 2020 2020 2020 2074 656e 736f 7220           tensor 
+0008dea0: 3d20 6767 6d6c 5f74 7261 6e73 706f 7365  = ggml_transpose
+0008deb0: 282a 6374 785f 6576 616c 2c20 6172 6773  (*ctx_eval, args
+0008dec0: 5b30 5d29 3b0a 2020 2020 2020 2020 2020  [0]);.          
+0008ded0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+0008dee0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+0008def0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+0008df00: 4747 4d4c 5f4f 505f 5045 524d 5554 453a  GGML_OP_PERMUTE:
+0008df10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008df20: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0008df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008df40: 2020 2020 2020 2074 656e 736f 7220 3d20         tensor = 
+0008df50: 6767 6d6c 5f76 6965 775f 3464 282a 6374  ggml_view_4d(*ct
+0008df60: 785f 6576 616c 2c20 6172 6773 5b30 5d2c  x_eval, args[0],
+0008df70: 206e 655b 305d 2c20 6e65 5b31 5d2c 206e   ne[0], ne[1], n
+0008df80: 655b 325d 2c20 6e65 5b33 5d2c 2030 2c20  e[2], ne[3], 0, 
+0008df90: 302c 2030 2c20 3029 3b0a 2020 2020 2020  0, 0, 0);.      
+0008dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008dfb0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0008dfc0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0008dfd0: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
+0008dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008dff0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0008e000: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0008e010: 6e73 6f72 203d 2067 676d 6c5f 6e65 775f  nsor = ggml_new_
+0008e020: 7465 6e73 6f72 282a 6374 785f 6576 616c  tensor(*ctx_eval
+0008e030: 2c20 2865 6e75 6d20 6767 6d6c 5f74 7970  , (enum ggml_typ
+0008e040: 6529 2074 7970 652c 206e 5f64 696d 732c  e) type, n_dims,
+0008e050: 206e 6529 3b0a 0a20 2020 2020 2020 2020   ne);..         
+0008e060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008e070: 2020 2074 656e 736f 722d 3e6f 7020 3d20     tensor->op = 
+0008e080: 656f 703b 0a20 2020 2020 2020 2020 2020  eop;.           
+0008e090: 2020 2020 2020 2020 2020 2020 207d 2062               } b
+0008e0a0: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
+0008e0b0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0008e0c0: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
+0008e0d0: 7465 6e73 6f72 2d3e 6e61 6d65 2c20 7074  tensor->name, pt
+0008e0e0: 725f 6e61 6d65 2c20 4747 4d4c 5f4d 4158  r_name, GGML_MAX
+0008e0f0: 5f4e 414d 4529 3b0a 0a20 2020 2020 2020  _NAME);..       
+0008e100: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0008e110: 7420 6a20 3d20 303b 206a 203c 2047 474d  t j = 0; j < GGM
+0008e120: 4c5f 4d41 585f 4449 4d53 3b20 2b2b 6a29  L_MAX_DIMS; ++j)
+0008e130: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0008e140: 2020 2020 2020 2074 656e 736f 722d 3e6e         tensor->n
+0008e150: 625b 6a5d 203d 206e 625b 6a5d 3b0a 2020  b[j] = nb[j];.  
+0008e160: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0008e170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008e180: 2074 656e 736f 722d 3e73 7263 3020 3d20   tensor->src0 = 
+0008e190: 6172 6773 5b30 5d3b 0a20 2020 2020 2020  args[0];.       
+0008e1a0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+0008e1b0: 3e73 7263 3120 3d20 6172 6773 5b31 5d3b  >src1 = args[1];
+0008e1c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0008e1d0: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
+0008e1e0: 3b20 6a20 3c20 4747 4d4c 5f4d 4158 5f4f  ; j < GGML_MAX_O
+0008e1f0: 5054 3b20 2b2b 6a29 207b 0a20 2020 2020  PT; ++j) {.     
+0008e200: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0008e210: 656e 736f 722d 3e6f 7074 5b6a 5d20 3d20  ensor->opt[j] = 
+0008e220: 6172 6773 5b32 202b 206a 5d3b 0a20 2020  args[2 + j];.   
+0008e230: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
+0008e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008e250: 7265 7375 6c74 2e6e 6f64 6573 5b69 5d20  result.nodes[i] 
+0008e260: 3d20 7465 6e73 6f72 3b0a 0a20 2020 2020  = tensor;..     
+0008e270: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+0008e280: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
+0008e290: 6c6f 6164 6564 206e 6f64 6520 2564 3a20  loaded node %d: 
+0008e2a0: 2725 3136 7327 2c20 2533 6420 6469 6d73  '%16s', %3d dims
+0008e2b0: 2c20 2539 7a75 2062 7974 6573 5c6e 222c  , %9zu bytes\n",
+0008e2c0: 205f 5f66 756e 635f 5f2c 2069 2c20 7465   __func__, i, te
+0008e2d0: 6e73 6f72 2d3e 6e61 6d65 2c20 6e5f 6469  nsor->name, n_di
+0008e2e0: 6d73 2c20 6767 6d6c 5f6e 6279 7465 7328  ms, ggml_nbytes(
+0008e2f0: 7465 6e73 6f72 2929 3b0a 2020 2020 2020  tensor));.      
+0008e300: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0008e310: 7d0a 2020 2020 7d0a 0a20 2020 2072 6574  }.    }..    ret
+0008e320: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a76  urn result;.}..v
+0008e330: 6f69 6420 6767 6d6c 5f67 7261 7068 5f70  oid ggml_graph_p
+0008e340: 7269 6e74 2863 6f6e 7374 2073 7472 7563  rint(const struc
+0008e350: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+0008e360: 6367 7261 7068 2920 7b0a 2020 2020 696e  cgraph) {.    in
+0008e370: 7436 345f 7420 7065 7266 5f74 6f74 616c  t64_t perf_total
+0008e380: 5f70 6572 5f6f 705f 7573 5b47 474d 4c5f  _per_op_us[GGML_
+0008e390: 4f50 5f43 4f55 4e54 5d20 3d20 7b30 7d3b  OP_COUNT] = {0};
+0008e3a0: 0a0a 2020 2020 4747 4d4c 5f50 5249 4e54  ..    GGML_PRINT
+0008e3b0: 2822 3d3d 3d20 4752 4150 4820 3d3d 3d5c  ("=== GRAPH ===\
+0008e3c0: 6e22 293b 0a0a 2020 2020 4747 4d4c 5f50  n");..    GGML_P
+0008e3d0: 5249 4e54 5f44 4542 5547 2822 6e5f 7468  RINT_DEBUG("n_th
+0008e3e0: 7265 6164 7320 2020 2020 2020 3d20 2564  reads       = %d
+0008e3f0: 5c6e 222c 2020 2020 2020 2020 6367 7261  \n",        cgra
+0008e400: 7068 2d3e 6e5f 7468 7265 6164 7329 3b0a  ph->n_threads);.
+0008e410: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
+0008e420: 4542 5547 2822 746f 7461 6c20 776f 726b  EBUG("total work
+0008e430: 2073 697a 6520 3d20 257a 7520 6279 7465   size = %zu byte
+0008e440: 735c 6e22 2c20 6367 7261 7068 2d3e 776f  s\n", cgraph->wo
+0008e450: 726b 5f73 697a 6529 3b0a 0a20 2020 2047  rk_size);..    G
+0008e460: 474d 4c5f 5052 494e 5428 226e 5f6e 6f64  GML_PRINT("n_nod
+0008e470: 6573 203d 2025 645c 6e22 2c20 6367 7261  es = %d\n", cgra
+0008e480: 7068 2d3e 6e5f 6e6f 6465 7329 3b0a 2020  ph->n_nodes);.  
+0008e490: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0008e4a0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
+0008e4b0: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
+0008e4c0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008e4d0: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
+0008e4e0: 3d20 6367 7261 7068 2d3e 6e6f 6465 735b  = cgraph->nodes[
+0008e4f0: 695d 3b0a 0a20 2020 2020 2020 2070 6572  i];..        per
+0008e500: 665f 746f 7461 6c5f 7065 725f 6f70 5f75  f_total_per_op_u
+0008e510: 735b 6e6f 6465 2d3e 6f70 5d20 2b3d 204d  s[node->op] += M
+0008e520: 4158 2831 2c20 6e6f 6465 2d3e 7065 7266  AX(1, node->perf
+0008e530: 5f74 696d 655f 7573 293b 0a0a 2020 2020  _time_us);..    
+0008e540: 2020 2020 4747 4d4c 5f50 5249 4e54 2822      GGML_PRINT("
+0008e550: 202d 2025 3364 3a20 5b20 2535 2220 5052   - %3d: [ %5" PR
+0008e560: 4964 3634 2022 2c20 2535 2220 5052 4964  Id64 ", %5" PRId
+0008e570: 3634 2022 2c20 2535 2220 5052 4964 3634  64 ", %5" PRId64
+0008e580: 2022 5d20 2531 3673 2025 7320 2825 3364   "] %16s %s (%3d
+0008e590: 2920 6370 7520 3d20 2537 2e33 6620 2f20  ) cpu = %7.3f / 
+0008e5a0: 2537 2e33 6620 6d73 2c20 7761 6c6c 203d  %7.3f ms, wall =
+0008e5b0: 2025 372e 3366 202f 2025 372e 3366 206d   %7.3f / %7.3f m
+0008e5c0: 735c 6e22 2c0a 2020 2020 2020 2020 2020  s\n",.          
+0008e5d0: 2020 2020 2020 692c 0a20 2020 2020 2020        i,.       
+0008e5e0: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
+0008e5f0: 655b 305d 2c20 6e6f 6465 2d3e 6e65 5b31  e[0], node->ne[1
+0008e600: 5d2c 206e 6f64 652d 3e6e 655b 325d 2c0a  ], node->ne[2],.
+0008e610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008e620: 4747 4d4c 5f4f 505f 4e41 4d45 5b6e 6f64  GGML_OP_NAME[nod
+0008e630: 652d 3e6f 705d 2c20 6e6f 6465 2d3e 6973  e->op], node->is
+0008e640: 5f70 6172 616d 203f 2022 7822 203a 206e  _param ? "x" : n
+0008e650: 6f64 652d 3e67 7261 6420 3f20 2267 2220  ode->grad ? "g" 
+0008e660: 3a20 2220 222c 206e 6f64 652d 3e70 6572  : " ", node->per
+0008e670: 665f 7275 6e73 2c0a 2020 2020 2020 2020  f_runs,.        
+0008e680: 2020 2020 2020 2020 2864 6f75 626c 6529          (double)
+0008e690: 206e 6f64 652d 3e70 6572 665f 6379 636c   node->perf_cycl
+0008e6a0: 6573 2020 2f20 2864 6f75 626c 6529 2067  es  / (double) g
+0008e6b0: 676d 6c5f 6379 636c 6573 5f70 6572 5f6d  gml_cycles_per_m
+0008e6c0: 7328 292c 0a20 2020 2020 2020 2020 2020  s(),.           
+0008e6d0: 2020 2020 2028 646f 7562 6c65 2920 6e6f       (double) no
+0008e6e0: 6465 2d3e 7065 7266 5f63 7963 6c65 7320  de->perf_cycles 
+0008e6f0: 202f 2028 646f 7562 6c65 2920 6767 6d6c   / (double) ggml
+0008e700: 5f63 7963 6c65 735f 7065 725f 6d73 2829  _cycles_per_ms()
+0008e710: 202f 2028 646f 7562 6c65 2920 6e6f 6465   / (double) node
+0008e720: 2d3e 7065 7266 5f72 756e 732c 0a20 2020  ->perf_runs,.   
+0008e730: 2020 2020 2020 2020 2020 2020 2028 646f               (do
+0008e740: 7562 6c65 2920 6e6f 6465 2d3e 7065 7266  uble) node->perf
+0008e750: 5f74 696d 655f 7573 202f 2031 3030 302e  _time_us / 1000.
+0008e760: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+0008e770: 2020 2028 646f 7562 6c65 2920 6e6f 6465     (double) node
+0008e780: 2d3e 7065 7266 5f74 696d 655f 7573 202f  ->perf_time_us /
+0008e790: 2031 3030 302e 3020 2f20 6e6f 6465 2d3e   1000.0 / node->
+0008e7a0: 7065 7266 5f72 756e 7329 3b0a 2020 2020  perf_runs);.    
+0008e7b0: 7d0a 0a20 2020 2047 474d 4c5f 5052 494e  }..    GGML_PRIN
+0008e7c0: 5428 226e 5f6c 6561 6673 203d 2025 645c  T("n_leafs = %d\
+0008e7d0: 6e22 2c20 6367 7261 7068 2d3e 6e5f 6c65  n", cgraph->n_le
+0008e7e0: 6166 7329 3b0a 2020 2020 666f 7220 2869  afs);.    for (i
+0008e7f0: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
+0008e800: 7261 7068 2d3e 6e5f 6c65 6166 733b 2069  raph->n_leafs; i
+0008e810: 2b2b 2920 7b0a 2020 2020 2020 2020 7374  ++) {.        st
+0008e820: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0008e830: 202a 206e 6f64 6520 3d20 6367 7261 7068   * node = cgraph
+0008e840: 2d3e 6c65 6166 735b 695d 3b0a 0a20 2020  ->leafs[i];..   
+0008e850: 2020 2020 2047 474d 4c5f 5052 494e 5428       GGML_PRINT(
+0008e860: 2220 2d20 2533 643a 205b 2025 3522 2050  " - %3d: [ %5" P
+0008e870: 5249 6436 3420 222c 2025 3522 2050 5249  RId64 ", %5" PRI
+0008e880: 6436 3420 225d 2025 3873 5c6e 222c 0a20  d64 "] %8s\n",. 
+0008e890: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0008e8a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0008e8b0: 2020 6e6f 6465 2d3e 6e65 5b30 5d2c 206e    node->ne[0], n
+0008e8c0: 6f64 652d 3e6e 655b 315d 2c0a 2020 2020  ode->ne[1],.    
+0008e8d0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0008e8e0: 5f4f 505f 4e41 4d45 5b6e 6f64 652d 3e6f  _OP_NAME[node->o
+0008e8f0: 705d 293b 0a20 2020 207d 0a0a 2020 2020  p]);.    }..    
+0008e900: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+0008e910: 6920 3c20 4747 4d4c 5f4f 505f 434f 554e  i < GGML_OP_COUN
+0008e920: 543b 2069 2b2b 2920 7b0a 2020 2020 2020  T; i++) {.      
+0008e930: 2020 6966 2028 7065 7266 5f74 6f74 616c    if (perf_total
+0008e940: 5f70 6572 5f6f 705f 7573 5b69 5d20 3d3d  _per_op_us[i] ==
+0008e950: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
+0008e960: 2020 636f 6e74 696e 7565 3b0a 2020 2020    continue;.    
+0008e970: 2020 2020 7d0a 0a20 2020 2020 2020 2047      }..        G
+0008e980: 474d 4c5f 5052 494e 5428 2270 6572 665f  GML_PRINT("perf_
+0008e990: 746f 7461 6c5f 7065 725f 6f70 5f75 735b  total_per_op_us[
+0008e9a0: 2531 3673 5d20 3d20 2537 2e33 6620 6d73  %16s] = %7.3f ms
+0008e9b0: 5c6e 222c 2047 474d 4c5f 4f50 5f4e 414d  \n", GGML_OP_NAM
+0008e9c0: 455b 695d 2c20 2864 6f75 626c 6529 2070  E[i], (double) p
+0008e9d0: 6572 665f 746f 7461 6c5f 7065 725f 6f70  erf_total_per_op
+0008e9e0: 5f75 735b 695d 202f 2031 3030 302e 3029  _us[i] / 1000.0)
+0008e9f0: 3b0a 2020 2020 7d0a 0a20 2020 2047 474d  ;.    }..    GGM
+0008ea00: 4c5f 5052 494e 5428 223d 3d3d 3d3d 3d3d  L_PRINT("=======
+0008ea10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0008ea20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0008ea30: 3d5c 6e22 293b 0a7d 0a0a 2f2f 2063 6865  =\n");.}..// che
+0008ea40: 636b 2069 6620 6e6f 6465 2069 7320 7061  ck if node is pa
+0008ea50: 7274 206f 6620 7468 6520 6772 6170 680a  rt of the graph.
+0008ea60: 7374 6174 6963 2062 6f6f 6c20 6767 6d6c  static bool ggml
+0008ea70: 5f67 7261 7068 5f66 696e 6428 636f 6e73  _graph_find(cons
+0008ea80: 7420 7374 7275 6374 2067 676d 6c5f 6367  t struct ggml_cg
+0008ea90: 7261 7068 202a 2063 6772 6170 682c 2063  raph * cgraph, c
+0008eaa0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0008eab0: 5f74 656e 736f 7220 2a20 6e6f 6465 2920  _tensor * node) 
+0008eac0: 7b0a 2020 2020 6966 2028 6367 7261 7068  {.    if (cgraph
+0008ead0: 203d 3d20 4e55 4c4c 2920 7b0a 2020 2020   == NULL) {.    
+0008eae0: 2020 2020 7265 7475 726e 2074 7275 653b      return true;
+0008eaf0: 0a20 2020 207d 0a0a 2020 2020 666f 7220  .    }..    for 
+0008eb00: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+0008eb10: 6367 7261 7068 2d3e 6e5f 6e6f 6465 733b  cgraph->n_nodes;
+0008eb20: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+0008eb30: 6966 2028 6367 7261 7068 2d3e 6e6f 6465  if (cgraph->node
+0008eb40: 735b 695d 203d 3d20 6e6f 6465 2920 7b0a  s[i] == node) {.
+0008eb50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0008eb60: 726e 2074 7275 653b 0a20 2020 2020 2020  rn true;.       
+0008eb70: 207d 0a20 2020 207d 0a0a 2020 2020 7265   }.    }..    re
+0008eb80: 7475 726e 2066 616c 7365 3b0a 7d0a 0a73  turn false;.}..s
+0008eb90: 7461 7469 6320 7374 7275 6374 2067 676d  tatic struct ggm
+0008eba0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+0008ebb0: 6772 6170 685f 6765 745f 7061 7265 6e74  graph_get_parent
+0008ebc0: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
+0008ebd0: 6d6c 5f63 6772 6170 6820 2a20 6367 7261  ml_cgraph * cgra
+0008ebe0: 7068 2c20 636f 6e73 7420 7374 7275 6374  ph, const struct
+0008ebf0: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
+0008ec00: 6f64 6529 207b 0a20 2020 2066 6f72 2028  ode) {.    for (
+0008ec10: 696e 7420 6920 3d20 303b 2069 203c 2063  int i = 0; i < c
+0008ec20: 6772 6170 682d 3e6e 5f6e 6f64 6573 3b20  graph->n_nodes; 
+0008ec30: 692b 2b29 207b 0a20 2020 2020 2020 2073  i++) {.        s
+0008ec40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0008ec50: 7220 2a20 7061 7265 6e74 203d 2063 6772  r * parent = cgr
+0008ec60: 6170 682d 3e6e 6f64 6573 5b69 5d3b 0a0a  aph->nodes[i];..
+0008ec70: 2020 2020 2020 2020 6966 2028 7061 7265          if (pare
+0008ec80: 6e74 2d3e 6772 6164 203d 3d20 6e6f 6465  nt->grad == node
+0008ec90: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008eca0: 7265 7475 726e 2070 6172 656e 743b 0a20  return parent;. 
+0008ecb0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+0008ecc0: 2020 2020 7265 7475 726e 204e 554c 4c3b      return NULL;
+0008ecd0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+0008ece0: 6767 6d6c 5f67 7261 7068 5f64 756d 705f  ggml_graph_dump_
+0008ecf0: 646f 745f 6e6f 6465 5f65 6467 6528 4649  dot_node_edge(FI
+0008ed00: 4c45 202a 2066 702c 2063 6f6e 7374 2073  LE * fp, const s
+0008ed10: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+0008ed20: 6820 2a20 6762 2c20 7374 7275 6374 2067  h * gb, struct g
+0008ed30: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
+0008ed40: 652c 2073 7472 7563 7420 6767 6d6c 5f74  e, struct ggml_t
+0008ed50: 656e 736f 7220 2a20 7061 7265 6e74 2c20  ensor * parent, 
+0008ed60: 636f 6e73 7420 6368 6172 202a 206c 6162  const char * lab
+0008ed70: 656c 2920 207b 0a20 2020 2073 7472 7563  el)  {.    struc
+0008ed80: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0008ed90: 6770 6172 656e 7420 3d20 6767 6d6c 5f67  gparent = ggml_g
+0008eda0: 7261 7068 5f67 6574 5f70 6172 656e 7428  raph_get_parent(
+0008edb0: 6762 2c20 6e6f 6465 293b 0a20 2020 2073  gb, node);.    s
+0008edc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0008edd0: 7220 2a20 6770 6172 656e 7430 203d 2067  r * gparent0 = g
+0008ede0: 676d 6c5f 6772 6170 685f 6765 745f 7061  gml_graph_get_pa
+0008edf0: 7265 6e74 2867 622c 2070 6172 656e 7429  rent(gb, parent)
+0008ee00: 3b0a 2020 2020 6670 7269 6e74 6628 6670  ;.    fprintf(fp
+0008ee10: 2c20 2220 205c 2225 705c 223a 2573 202d  , "  \"%p\":%s -
+0008ee20: 3e20 5c22 2570 5c22 3a25 7320 5b20 6172  > \"%p\":%s [ ar
+0008ee30: 726f 7768 6561 6420 3d20 2573 3b20 7374  rowhead = %s; st
+0008ee40: 796c 6520 3d20 2573 3b20 6c61 6265 6c20  yle = %s; label 
+0008ee50: 3d20 5c22 2573 5c22 3b20 5d5c 6e22 2c0a  = \"%s\"; ]\n",.
+0008ee60: 2020 2020 2020 2020 2020 2020 6770 6172              gpar
+0008ee70: 656e 7430 203f 2028 766f 6964 202a 2920  ent0 ? (void *) 
+0008ee80: 6770 6172 656e 7430 203a 2028 766f 6964  gparent0 : (void
+0008ee90: 202a 2920 7061 7265 6e74 2c0a 2020 2020   *) parent,.    
+0008eea0: 2020 2020 2020 2020 6770 6172 656e 7430          gparent0
+0008eeb0: 203f 2022 6722 203a 2022 7822 2c0a 2020   ? "g" : "x",.  
+0008eec0: 2020 2020 2020 2020 2020 6770 6172 656e            gparen
+0008eed0: 7420 3f20 2876 6f69 6420 2a29 2067 7061  t ? (void *) gpa
+0008eee0: 7265 6e74 203a 2028 766f 6964 202a 2920  rent : (void *) 
+0008eef0: 6e6f 6465 2c0a 2020 2020 2020 2020 2020  node,.          
+0008ef00: 2020 6770 6172 656e 7420 3f20 2267 2220    gparent ? "g" 
+0008ef10: 3a20 2278 222c 0a20 2020 2020 2020 2020  : "x",.         
+0008ef20: 2020 2067 7061 7265 6e74 203f 2022 656d     gparent ? "em
+0008ef30: 7074 7922 203a 2022 7665 6522 2c0a 2020  pty" : "vee",.  
+0008ef40: 2020 2020 2020 2020 2020 6770 6172 656e            gparen
+0008ef50: 7420 3f20 2264 6173 6865 6422 203a 2022  t ? "dashed" : "
+0008ef60: 736f 6c69 6422 2c0a 2020 2020 2020 2020  solid",.        
+0008ef70: 2020 2020 6c61 6265 6c29 3b0a 7d0a 0a73      label);.}..s
+0008ef80: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0008ef90: 6772 6170 685f 6475 6d70 5f64 6f74 5f6c  graph_dump_dot_l
+0008efa0: 6561 665f 6564 6765 2846 494c 4520 2a20  eaf_edge(FILE * 
+0008efb0: 6670 2c20 7374 7275 6374 2067 676d 6c5f  fp, struct ggml_
+0008efc0: 7465 6e73 6f72 202a 206e 6f64 652c 2073  tensor * node, s
+0008efd0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0008efe0: 7220 2a20 7061 7265 6e74 2c20 636f 6e73  r * parent, cons
+0008eff0: 7420 6368 6172 202a 206c 6162 656c 2920  t char * label) 
+0008f000: 207b 0a20 2020 2066 7072 696e 7466 2866   {.    fprintf(f
+0008f010: 702c 2022 2020 5c22 2570 5c22 3a25 7320  p, "  \"%p\":%s 
+0008f020: 2d3e 205c 2225 705c 223a 2573 205b 206c  -> \"%p\":%s [ l
+0008f030: 6162 656c 203d 205c 2225 735c 223b 205d  abel = \"%s\"; ]
+0008f040: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
+0008f050: 2028 766f 6964 202a 2920 7061 7265 6e74   (void *) parent
+0008f060: 2c20 2278 222c 0a20 2020 2020 2020 2020  , "x",.         
+0008f070: 2020 2028 766f 6964 202a 2920 6e6f 6465     (void *) node
+0008f080: 2c20 2278 222c 0a20 2020 2020 2020 2020  , "x",.         
+0008f090: 2020 206c 6162 656c 293b 0a7d 0a0a 766f     label);.}..vo
+0008f0a0: 6964 2067 676d 6c5f 6772 6170 685f 6475  id ggml_graph_du
+0008f0b0: 6d70 5f64 6f74 2863 6f6e 7374 2073 7472  mp_dot(const str
+0008f0c0: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+0008f0d0: 2a20 6762 2c20 636f 6e73 7420 7374 7275  * gb, const stru
+0008f0e0: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
+0008f0f0: 2067 662c 2063 6f6e 7374 2063 6861 7220   gf, const char 
+0008f100: 2a20 6669 6c65 6e61 6d65 2920 7b0a 2020  * filename) {.  
+0008f110: 2020 6368 6172 2063 6f6c 6f72 5b31 365d    char color[16]
+0008f120: 3b0a 0a20 2020 2046 494c 4520 2a20 6670  ;..    FILE * fp
+0008f130: 203d 2066 6f70 656e 2866 696c 656e 616d   = fopen(filenam
+0008f140: 652c 2022 7722 293b 0a20 2020 2047 474d  e, "w");.    GGM
+0008f150: 4c5f 4153 5345 5254 2866 7029 3b0a 0a20  L_ASSERT(fp);.. 
+0008f160: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
+0008f170: 6469 6772 6170 6820 4720 7b5c 6e22 293b  digraph G {\n");
+0008f180: 0a20 2020 2066 7072 696e 7466 2866 702c  .    fprintf(fp,
+0008f190: 2022 2020 6e65 7772 616e 6b20 3d20 7472   "  newrank = tr
+0008f1a0: 7565 3b5c 6e22 293b 0a20 2020 2066 7072  ue;\n");.    fpr
+0008f1b0: 696e 7466 2866 702c 2022 2020 7261 6e6b  intf(fp, "  rank
+0008f1c0: 6469 7220 3d20 4c52 3b5c 6e22 293b 0a0a  dir = LR;\n");..
+0008f1d0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+0008f1e0: 2030 3b20 6920 3c20 6762 2d3e 6e5f 6e6f   0; i < gb->n_no
+0008f1f0: 6465 733b 2069 2b2b 2920 7b0a 2020 2020  des; i++) {.    
+0008f200: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0008f210: 7465 6e73 6f72 202a 206e 6f64 6520 3d20  tensor * node = 
+0008f220: 6762 2d3e 6e6f 6465 735b 695d 3b0a 0a20  gb->nodes[i];.. 
+0008f230: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
+0008f240: 6772 6170 685f 6765 745f 7061 7265 6e74  graph_get_parent
+0008f250: 2867 622c 206e 6f64 6529 2021 3d20 4e55  (gb, node) != NU
+0008f260: 4c4c 2920 7b0a 2020 2020 2020 2020 2020  LL) {.          
+0008f270: 2020 636f 6e74 696e 7565 3b0a 2020 2020    continue;.    
+0008f280: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
+0008f290: 6620 286e 6f64 652d 3e69 735f 7061 7261  f (node->is_para
+0008f2a0: 6d29 207b 0a20 2020 2020 2020 2020 2020  m) {.           
+0008f2b0: 2073 6e70 7269 6e74 6628 636f 6c6f 722c   snprintf(color,
+0008f2c0: 2073 697a 656f 6628 636f 6c6f 7229 2c20   sizeof(color), 
+0008f2d0: 2279 656c 6c6f 7722 293b 0a20 2020 2020  "yellow");.     
+0008f2e0: 2020 207d 2065 6c73 6520 6966 2028 6e6f     } else if (no
+0008f2f0: 6465 2d3e 6772 6164 2920 7b0a 2020 2020  de->grad) {.    
+0008f300: 2020 2020 2020 2020 6966 2028 6767 6d6c          if (ggml
+0008f310: 5f67 7261 7068 5f66 696e 6428 6766 2c20  _graph_find(gf, 
+0008f320: 6e6f 6465 2929 207b 0a20 2020 2020 2020  node)) {.       
+0008f330: 2020 2020 2020 2020 2073 6e70 7269 6e74           snprint
+0008f340: 6628 636f 6c6f 722c 2073 697a 656f 6628  f(color, sizeof(
+0008f350: 636f 6c6f 7229 2c20 2267 7265 656e 2229  color), "green")
+0008f360: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+0008f370: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+0008f380: 2020 2020 2020 2073 6e70 7269 6e74 6628         snprintf(
+0008f390: 636f 6c6f 722c 2073 697a 656f 6628 636f  color, sizeof(co
+0008f3a0: 6c6f 7229 2c20 226c 6967 6874 626c 7565  lor), "lightblue
+0008f3b0: 2229 3b0a 2020 2020 2020 2020 2020 2020  ");.            
+0008f3c0: 7d0a 2020 2020 2020 2020 7d20 656c 7365  }.        } else
+0008f3d0: 207b 0a20 2020 2020 2020 2020 2020 2073   {.            s
+0008f3e0: 6e70 7269 6e74 6628 636f 6c6f 722c 2073  nprintf(color, s
+0008f3f0: 697a 656f 6628 636f 6c6f 7229 2c20 2277  izeof(color), "w
+0008f400: 6869 7465 2229 3b0a 2020 2020 2020 2020  hite");.        
+0008f410: 7d0a 0a20 2020 2020 2020 2066 7072 696e  }..        fprin
+0008f420: 7466 2866 702c 2022 2020 5c22 2570 5c22  tf(fp, "  \"%p\"
+0008f430: 205b 2022 0a20 2020 2020 2020 2020 2020   [ ".           
+0008f440: 2020 2020 2020 2020 2022 7374 796c 6520           "style 
+0008f450: 3d20 6669 6c6c 6564 3b20 6669 6c6c 636f  = filled; fillco
+0008f460: 6c6f 7220 3d20 2573 3b20 7368 6170 6520  lor = %s; shape 
+0008f470: 3d20 7265 636f 7264 3b20 220a 2020 2020  = record; ".    
+0008f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008f490: 226c 6162 656c 3d5c 2222 2c0a 2020 2020  "label=\"",.    
+0008f4a0: 2020 2020 2020 2020 2020 2020 2876 6f69              (voi
+0008f4b0: 6420 2a29 206e 6f64 652c 2063 6f6c 6f72  d *) node, color
+0008f4c0: 293b 0a0a 2020 2020 2020 2020 6966 2028  );..        if (
+0008f4d0: 7374 726c 656e 286e 6f64 652d 3e6e 616d  strlen(node->nam
+0008f4e0: 6529 203e 2030 2920 7b0a 2020 2020 2020  e) > 0) {.      
+0008f4f0: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
+0008f500: 2c20 2225 7320 2825 7329 7c22 2c20 6e6f  , "%s (%s)|", no
+0008f510: 6465 2d3e 6e61 6d65 2c20 6767 6d6c 5f74  de->name, ggml_t
+0008f520: 7970 655f 6e61 6d65 286e 6f64 652d 3e74  ype_name(node->t
+0008f530: 7970 6529 293b 0a20 2020 2020 2020 207d  ype));.        }
+0008f540: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+0008f550: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0008f560: 2228 2573 297c 222c 2067 676d 6c5f 7479  "(%s)|", ggml_ty
+0008f570: 7065 5f6e 616d 6528 6e6f 6465 2d3e 7479  pe_name(node->ty
+0008f580: 7065 2929 3b0a 2020 2020 2020 2020 7d0a  pe));.        }.
+0008f590: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
+0008f5a0: 652d 3e6e 5f64 696d 7320 3d3d 2032 2920  e->n_dims == 2) 
+0008f5b0: 7b0a 2020 2020 2020 2020 2020 2020 6670  {.            fp
+0008f5c0: 7269 6e74 6628 6670 2c20 2225 6420 5b25  rintf(fp, "%d [%
+0008f5d0: 2220 5052 4964 3634 2022 2c20 2522 2050  " PRId64 ", %" P
+0008f5e0: 5249 6436 3420 225d 207c 203c 783e 2573  RId64 "] | <x>%s
+0008f5f0: 222c 2069 2c20 6e6f 6465 2d3e 6e65 5b30  ", i, node->ne[0
+0008f600: 5d2c 206e 6f64 652d 3e6e 655b 315d 2c20  ], node->ne[1], 
+0008f610: 4747 4d4c 5f4f 505f 5359 4d42 4f4c 5b6e  GGML_OP_SYMBOL[n
+0008f620: 6f64 652d 3e6f 705d 293b 0a20 2020 2020  ode->op]);.     
+0008f630: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0008f640: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
+0008f650: 6670 2c20 2225 6420 5b25 2220 5052 4964  fp, "%d [%" PRId
+0008f660: 3634 2022 2c20 2522 2050 5249 6436 3420  64 ", %" PRId64 
+0008f670: 222c 2025 2220 5052 4964 3634 2022 5d20  ", %" PRId64 "] 
+0008f680: 7c20 3c78 3e25 7322 2c20 692c 206e 6f64  | <x>%s", i, nod
+0008f690: 652d 3e6e 655b 305d 2c20 6e6f 6465 2d3e  e->ne[0], node->
+0008f6a0: 6e65 5b31 5d2c 206e 6f64 652d 3e6e 655b  ne[1], node->ne[
+0008f6b0: 325d 2c20 4747 4d4c 5f4f 505f 5359 4d42  2], GGML_OP_SYMB
+0008f6c0: 4f4c 5b6e 6f64 652d 3e6f 705d 293b 0a20  OL[node->op]);. 
+0008f6d0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0008f6e0: 2020 6966 2028 6e6f 6465 2d3e 6772 6164    if (node->grad
+0008f6f0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008f700: 6670 7269 6e74 6628 6670 2c20 2220 7c20  fprintf(fp, " | 
+0008f710: 3c67 3e25 735c 223b 205d 5c6e 222c 2047  <g>%s\"; ]\n", G
+0008f720: 474d 4c5f 4f50 5f53 594d 424f 4c5b 6e6f  GML_OP_SYMBOL[no
+0008f730: 6465 2d3e 6772 6164 2d3e 6f70 5d29 3b0a  de->grad->op]);.
+0008f740: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+0008f750: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
+0008f760: 696e 7466 2866 702c 2022 5c22 3b20 5d5c  intf(fp, "\"; ]\
+0008f770: 6e22 293b 0a20 2020 2020 2020 207d 0a20  n");.        }. 
+0008f780: 2020 207d 0a0a 2020 2020 666f 7220 2869     }..    for (i
+0008f790: 6e74 2069 203d 2030 3b20 6920 3c20 6762  nt i = 0; i < gb
+0008f7a0: 2d3e 6e5f 6c65 6166 733b 2069 2b2b 2920  ->n_leafs; i++) 
+0008f7b0: 7b0a 2020 2020 2020 2020 7374 7275 6374  {.        struct
+0008f7c0: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
+0008f7d0: 6f64 6520 3d20 6762 2d3e 6c65 6166 735b  ode = gb->leafs[
+0008f7e0: 695d 3b0a 0a20 2020 2020 2020 2073 6e70  i];..        snp
+0008f7f0: 7269 6e74 6628 636f 6c6f 722c 2073 697a  rintf(color, siz
+0008f800: 656f 6628 636f 6c6f 7229 2c20 2270 696e  eof(color), "pin
+0008f810: 6b22 293b 0a0a 2020 2020 2020 2020 6670  k");..        fp
+0008f820: 7269 6e74 6628 6670 2c20 2220 205c 2225  rintf(fp, "  \"%
+0008f830: 705c 2220 5b20 220a 2020 2020 2020 2020  p\" [ ".        
+0008f840: 2020 2020 2020 2020 2020 2020 2273 7479              "sty
+0008f850: 6c65 203d 2066 696c 6c65 643b 2066 696c  le = filled; fil
+0008f860: 6c63 6f6c 6f72 203d 2025 733b 2073 6861  lcolor = %s; sha
+0008f870: 7065 203d 2072 6563 6f72 643b 2022 0a20  pe = record; ". 
+0008f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008f890: 2020 2022 6c61 6265 6c3d 5c22 3c78 3e22     "label=\"<x>"
+0008f8a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0008f8b0: 2020 2876 6f69 6420 2a29 206e 6f64 652c    (void *) node,
+0008f8c0: 2063 6f6c 6f72 293b 0a0a 2020 2020 2020   color);..      
+0008f8d0: 2020 6966 2028 7374 726c 656e 286e 6f64    if (strlen(nod
+0008f8e0: 652d 3e6e 616d 6529 203e 2030 2920 7b0a  e->name) > 0) {.
+0008f8f0: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
+0008f900: 6e74 6628 6670 2c20 2225 7320 2825 7329  ntf(fp, "%s (%s)
+0008f910: 7c22 2c20 6e6f 6465 2d3e 6e61 6d65 2c20  |", node->name, 
+0008f920: 6767 6d6c 5f74 7970 655f 6e61 6d65 286e  ggml_type_name(n
+0008f930: 6f64 652d 3e74 7970 6529 293b 0a20 2020  ode->type));.   
+0008f940: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
+0008f950: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
+0008f960: 6628 6670 2c20 2228 2573 297c 222c 2067  f(fp, "(%s)|", g
+0008f970: 676d 6c5f 7479 7065 5f6e 616d 6528 6e6f  gml_type_name(no
+0008f980: 6465 2d3e 7479 7065 2929 3b0a 2020 2020  de->type));.    
+0008f990: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
+0008f9a0: 7072 696e 7466 2866 702c 2022 434f 4e53  printf(fp, "CONS
+0008f9b0: 5420 2564 205b 2522 2050 5249 6436 3420  T %d [%" PRId64 
+0008f9c0: 222c 2025 2220 5052 4964 3634 2022 5d22  ", %" PRId64 "]"
+0008f9d0: 2c20 692c 206e 6f64 652d 3e6e 655b 305d  , i, node->ne[0]
+0008f9e0: 2c20 6e6f 6465 2d3e 6e65 5b31 5d29 3b0a  , node->ne[1]);.
+0008f9f0: 2020 2020 2020 2020 6966 2028 6767 6d6c          if (ggml
+0008fa00: 5f6e 656c 656d 656e 7473 286e 6f64 6529  _nelements(node)
+0008fa10: 203c 2035 2920 7b0a 2020 2020 2020 2020   < 5) {.        
+0008fa20: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0008fa30: 2220 7c20 2822 293b 0a20 2020 2020 2020  " | (");.       
+0008fa40: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+0008fa50: 3d20 303b 206a 203c 2067 676d 6c5f 6e65  = 0; j < ggml_ne
+0008fa60: 6c65 6d65 6e74 7328 6e6f 6465 293b 206a  lements(node); j
+0008fa70: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0008fa80: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
+0008fa90: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+0008faa0: 455f 4938 207c 7c20 6e6f 6465 2d3e 7479  E_I8 || node->ty
+0008fab0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+0008fac0: 4931 3620 7c7c 206e 6f64 652d 3e74 7970  I16 || node->typ
+0008fad0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
+0008fae0: 3332 2920 7b0a 2020 2020 2020 2020 2020  32) {.          
+0008faf0: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
+0008fb00: 6628 6670 2c20 2225 6422 2c20 6767 6d6c  f(fp, "%d", ggml
+0008fb10: 5f67 6574 5f69 3332 5f31 6428 6e6f 6465  _get_i32_1d(node
+0008fb20: 2c20 6a29 293b 0a20 2020 2020 2020 2020  , j));.         
+0008fb30: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0008fb40: 2020 2020 2020 2020 2065 6c73 6520 6966           else if
+0008fb50: 2028 6e6f 6465 2d3e 7479 7065 203d 3d20   (node->type == 
+0008fb60: 4747 4d4c 5f54 5950 455f 4633 3220 7c7c  GGML_TYPE_F32 ||
+0008fb70: 206e 6f64 652d 3e74 7970 6520 3d3d 2047   node->type == G
+0008fb80: 474d 4c5f 5459 5045 5f46 3136 2920 7b0a  GML_TYPE_F16) {.
+0008fb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008fba0: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0008fbb0: 2225 2e31 6522 2c20 2864 6f75 626c 6529  "%.1e", (double)
+0008fbc0: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
+0008fbd0: 6e6f 6465 2c20 6a29 293b 0a20 2020 2020  node, j));.     
+0008fbe0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0008fbf0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0008fc00: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
+0008fc10: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
+0008fc20: 6670 2c20 2223 2229 3b0a 2020 2020 2020  fp, "#");.      
+0008fc30: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0008fc40: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0008fc50: 6a20 3c20 6767 6d6c 5f6e 656c 656d 656e  j < ggml_nelemen
+0008fc60: 7473 286e 6f64 6529 202d 2031 2920 7b0a  ts(node) - 1) {.
+0008fc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008fc80: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0008fc90: 222c 2022 293b 0a20 2020 2020 2020 2020  ", ");.         
+0008fca0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0008fcb0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0008fcc0: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
+0008fcd0: 2922 293b 0a20 2020 2020 2020 207d 0a20  )");.        }. 
+0008fce0: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
+0008fcf0: 702c 2022 5c22 3b20 5d5c 6e22 293b 0a20  p, "\"; ]\n");. 
+0008fd00: 2020 207d 0a0a 2020 2020 666f 7220 2869     }..    for (i
+0008fd10: 6e74 2069 203d 2030 3b20 6920 3c20 6762  nt i = 0; i < gb
+0008fd20: 2d3e 6e5f 6e6f 6465 733b 2069 2b2b 2920  ->n_nodes; i++) 
+0008fd30: 7b0a 2020 2020 2020 2020 7374 7275 6374  {.        struct
+0008fd40: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
+0008fd50: 6f64 6520 3d20 6762 2d3e 6e6f 6465 735b  ode = gb->nodes[
+0008fd60: 695d 3b0a 0a20 2020 2020 2020 2069 6620  i];..        if 
+0008fd70: 286e 6f64 652d 3e73 7263 3029 207b 0a20  (node->src0) {. 
+0008fd80: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0008fd90: 6772 6170 685f 6475 6d70 5f64 6f74 5f6e  graph_dump_dot_n
+0008fda0: 6f64 655f 6564 6765 2866 702c 2067 622c  ode_edge(fp, gb,
+0008fdb0: 206e 6f64 652c 206e 6f64 652d 3e73 7263   node, node->src
+0008fdc0: 302c 2022 7822 293b 0a20 2020 2020 2020  0, "x");.       
+0008fdd0: 207d 0a0a 2020 2020 2020 2020 6966 2028   }..        if (
+0008fde0: 6e6f 6465 2d3e 7372 6331 2920 7b0a 2020  node->src1) {.  
+0008fdf0: 2020 2020 2020 2020 2020 6767 6d6c 5f67            ggml_g
+0008fe00: 7261 7068 5f64 756d 705f 646f 745f 6e6f  raph_dump_dot_no
+0008fe10: 6465 5f65 6467 6528 6670 2c20 6762 2c20  de_edge(fp, gb, 
+0008fe20: 6e6f 6465 2c20 6e6f 6465 2d3e 7372 6331  node, node->src1
+0008fe30: 2c20 2279 2229 3b0a 2020 2020 2020 2020  , "y");.        
+0008fe40: 7d0a 0a20 2020 2020 2020 2066 6f72 2028  }..        for (
+0008fe50: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
+0008fe60: 474d 4c5f 4d41 585f 4f50 543b 206a 2b2b  GML_MAX_OPT; j++
+0008fe70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008fe80: 6966 2028 6e6f 6465 2d3e 6f70 745b 6a5d  if (node->opt[j]
+0008fe90: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008fea0: 2020 2020 6368 6172 206c 6162 656c 5b31      char label[1
+0008feb0: 365d 3b0a 2020 2020 2020 2020 2020 2020  6];.            
+0008fec0: 2020 2020 736e 7072 696e 7466 286c 6162      snprintf(lab
+0008fed0: 656c 2c20 7369 7a65 6f66 286c 6162 656c  el, sizeof(label
+0008fee0: 292c 2022 6f70 7420 2564 222c 206a 293b  ), "opt %d", j);
+0008fef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008ff00: 2067 676d 6c5f 6772 6170 685f 6475 6d70   ggml_graph_dump
+0008ff10: 5f64 6f74 5f6e 6f64 655f 6564 6765 2866  _dot_node_edge(f
+0008ff20: 702c 2067 622c 206e 6f64 652c 206e 6f64  p, gb, node, nod
+0008ff30: 652d 3e6f 7074 5b6a 5d2c 206c 6162 656c  e->opt[j], label
+0008ff40: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0008ff50: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+0008ff60: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+0008ff70: 203d 2030 3b20 6920 3c20 6762 2d3e 6e5f   = 0; i < gb->n_
+0008ff80: 6c65 6166 733b 2069 2b2b 2920 7b0a 2020  leafs; i++) {.  
+0008ff90: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008ffa0: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
+0008ffb0: 3d20 6762 2d3e 6c65 6166 735b 695d 3b0a  = gb->leafs[i];.
+0008ffc0: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
+0008ffd0: 652d 3e73 7263 3029 207b 0a20 2020 2020  e->src0) {.     
+0008ffe0: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
+0008fff0: 685f 6475 6d70 5f64 6f74 5f6c 6561 665f  h_dump_dot_leaf_
+00090000: 6564 6765 2866 702c 206e 6f64 652c 206e  edge(fp, node, n
+00090010: 6f64 652d 3e73 7263 302c 2022 7822 293b  ode->src0, "x");
+00090020: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00090030: 2020 2020 6966 2028 6e6f 6465 2d3e 7372      if (node->sr
+00090040: 6331 2920 7b0a 2020 2020 2020 2020 2020  c1) {.          
+00090050: 2020 6767 6d6c 5f67 7261 7068 5f64 756d    ggml_graph_dum
+00090060: 705f 646f 745f 6c65 6166 5f65 6467 6528  p_dot_leaf_edge(
+00090070: 6670 2c20 6e6f 6465 2c20 6e6f 6465 2d3e  fp, node, node->
+00090080: 7372 6331 2c20 2279 2229 3b0a 2020 2020  src1, "y");.    
+00090090: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
+000900a0: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
+000900b0: 203c 2047 474d 4c5f 4d41 585f 4f50 543b   < GGML_MAX_OPT;
+000900c0: 206a 2b2b 2920 7b0a 2020 2020 2020 2020   j++) {.        
+000900d0: 2020 2020 6966 2028 6e6f 6465 2d3e 6f70      if (node->op
+000900e0: 745b 6a5d 2920 7b0a 2020 2020 2020 2020  t[j]) {.        
+000900f0: 2020 2020 2020 2020 6368 6172 206c 6162          char lab
+00090100: 656c 5b31 365d 3b0a 2020 2020 2020 2020  el[16];.        
+00090110: 2020 2020 2020 2020 736e 7072 696e 7466          snprintf
+00090120: 286c 6162 656c 2c20 7369 7a65 6f66 286c  (label, sizeof(l
+00090130: 6162 656c 292c 2022 6f70 7420 2564 222c  abel), "opt %d",
+00090140: 206a 293b 0a20 2020 2020 2020 2020 2020   j);.           
+00090150: 2020 2020 2067 676d 6c5f 6772 6170 685f       ggml_graph_
+00090160: 6475 6d70 5f64 6f74 5f6c 6561 665f 6564  dump_dot_leaf_ed
+00090170: 6765 2866 702c 206e 6f64 652c 206e 6f64  ge(fp, node, nod
+00090180: 652d 3e6f 7074 5b6a 5d2c 206c 6162 656c  e->opt[j], label
+00090190: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000901a0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+000901b0: 0a0a 2020 2020 6670 7269 6e74 6628 6670  ..    fprintf(fp
+000901c0: 2c20 227d 5c6e 2229 3b0a 0a20 2020 2066  , "}\n");..    f
+000901d0: 636c 6f73 6528 6670 293b 0a0a 2020 2020  close(fp);..    
+000901e0: 4747 4d4c 5f50 5249 4e54 2822 2573 3a20  GGML_PRINT("%s: 
+000901f0: 646f 7420 2d54 706e 6720 2573 202d 6f20  dot -Tpng %s -o 
+00090200: 2573 2e70 6e67 2026 2620 6f70 656e 2025  %s.png && open %
+00090210: 732e 706e 675c 6e22 2c20 5f5f 6675 6e63  s.png\n", __func
+00090220: 5f5f 2c20 6669 6c65 6e61 6d65 2c20 6669  __, filename, fi
+00090230: 6c65 6e61 6d65 2c20 6669 6c65 6e61 6d65  lename, filename
+00090240: 293b 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f  );.}..//////////
+00090250: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00090260: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00090270: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00090280: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00090290: 2f2f 2f2f 2f2f 0a0a 7374 6174 6963 2076  //////..static v
+000902a0: 6f69 6420 6767 6d6c 5f6f 7074 5f73 6574  oid ggml_opt_set
+000902b0: 5f70 6172 616d 7328 696e 7420 6e70 2c20  _params(int np, 
+000902c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000902d0: 6f72 202a 2063 6f6e 7374 2070 735b 5d2c  or * const ps[],
+000902e0: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
+000902f0: 2920 7b0a 2020 2020 696e 7420 6920 3d20  ) {.    int i = 
+00090300: 303b 0a20 2020 2066 6f72 2028 696e 7420  0;.    for (int 
+00090310: 7020 3d20 303b 2070 203c 206e 703b 202b  p = 0; p < np; +
+00090320: 2b70 2920 7b0a 2020 2020 2020 2020 636f  +p) {.        co
+00090330: 6e73 7420 696e 7436 345f 7420 6e65 203d  nst int64_t ne =
+00090340: 2067 676d 6c5f 6e65 6c65 6d65 6e74 7328   ggml_nelements(
+00090350: 7073 5b70 5d29 203b 0a20 2020 2020 2020  ps[p]) ;.       
+00090360: 202f 2f20 544f 444f 3a20 6164 6420 6675   // TODO: add fu
+00090370: 6e63 7469 6f6e 2074 6f20 7365 7420 7465  nction to set te
+00090380: 6e73 6f72 2066 726f 6d20 6172 7261 790a  nsor from array.
+00090390: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+000903a0: 3634 5f74 206a 203d 2030 3b20 6a20 3c20  64_t j = 0; j < 
+000903b0: 6e65 3b20 2b2b 6a29 207b 0a20 2020 2020  ne; ++j) {.     
+000903c0: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
+000903d0: 6633 325f 3164 2870 735b 705d 2c20 6a2c  f32_1d(ps[p], j,
+000903e0: 2078 5b69 2b2b 5d29 3b0a 2020 2020 2020   x[i++]);.      
+000903f0: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
+00090400: 7469 6320 766f 6964 2067 676d 6c5f 6f70  tic void ggml_op
+00090410: 745f 6765 745f 7061 7261 6d73 2869 6e74  t_get_params(int
+00090420: 206e 702c 2073 7472 7563 7420 6767 6d6c   np, struct ggml
+00090430: 5f74 656e 736f 7220 2a20 636f 6e73 7420  _tensor * const 
+00090440: 7073 5b5d 2c20 666c 6f61 7420 2a20 7829  ps[], float * x)
+00090450: 207b 0a20 2020 2069 6e74 2069 203d 2030   {.    int i = 0
+00090460: 3b0a 2020 2020 666f 7220 2869 6e74 2070  ;.    for (int p
+00090470: 203d 2030 3b20 7020 3c20 6e70 3b20 2b2b   = 0; p < np; ++
+00090480: 7029 207b 0a20 2020 2020 2020 2063 6f6e  p) {.        con
+00090490: 7374 2069 6e74 3634 5f74 206e 6520 3d20  st int64_t ne = 
+000904a0: 6767 6d6c 5f6e 656c 656d 656e 7473 2870  ggml_nelements(p
+000904b0: 735b 705d 2920 3b0a 2020 2020 2020 2020  s[p]) ;.        
+000904c0: 2f2f 2054 4f44 4f3a 2061 6464 2066 756e  // TODO: add fun
+000904d0: 6374 696f 6e20 746f 2067 6574 2061 6c6c  ction to get all
+000904e0: 2065 6c65 6d65 6e74 7320 6174 206f 6e63   elements at onc
+000904f0: 650a 2020 2020 2020 2020 666f 7220 2869  e.        for (i
+00090500: 6e74 3634 5f74 206a 203d 2030 3b20 6a20  nt64_t j = 0; j 
+00090510: 3c20 6e65 3b20 2b2b 6a29 207b 0a20 2020  < ne; ++j) {.   
+00090520: 2020 2020 2020 2020 2078 5b69 2b2b 5d20           x[i++] 
+00090530: 3d20 6767 6d6c 5f67 6574 5f66 3332 5f31  = ggml_get_f32_1
+00090540: 6428 7073 5b70 5d2c 206a 293b 0a20 2020  d(ps[p], j);.   
+00090550: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+00090560: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00090570: 5f6f 7074 5f67 6574 5f67 7261 6428 696e  _opt_get_grad(in
+00090580: 7420 6e70 2c20 7374 7275 6374 2067 676d  t np, struct ggm
+00090590: 6c5f 7465 6e73 6f72 202a 2063 6f6e 7374  l_tensor * const
+000905a0: 2070 735b 5d2c 2066 6c6f 6174 202a 2067   ps[], float * g
+000905b0: 2920 7b0a 2020 2020 696e 7420 6920 3d20  ) {.    int i = 
+000905c0: 303b 0a20 2020 2066 6f72 2028 696e 7420  0;.    for (int 
+000905d0: 7020 3d20 303b 2070 203c 206e 703b 202b  p = 0; p < np; +
+000905e0: 2b70 2920 7b0a 2020 2020 2020 2020 636f  +p) {.        co
+000905f0: 6e73 7420 696e 7436 345f 7420 6e65 203d  nst int64_t ne =
+00090600: 2067 676d 6c5f 6e65 6c65 6d65 6e74 7328   ggml_nelements(
+00090610: 7073 5b70 5d29 203b 0a20 2020 2020 2020  ps[p]) ;.       
+00090620: 202f 2f20 544f 444f 3a20 6164 6420 6675   // TODO: add fu
+00090630: 6e63 7469 6f6e 2074 6f20 6765 7420 616c  nction to get al
+00090640: 6c20 656c 656d 656e 7473 2061 7420 6f6e  l elements at on
+00090650: 6365 0a20 2020 2020 2020 2066 6f72 2028  ce.        for (
+00090660: 696e 7436 345f 7420 6a20 3d20 303b 206a  int64_t j = 0; j
+00090670: 203c 206e 653b 202b 2b6a 2920 7b0a 2020   < ne; ++j) {.  
+00090680: 2020 2020 2020 2020 2020 675b 692b 2b5d            g[i++]
+00090690: 203d 2067 676d 6c5f 6765 745f 6633 325f   = ggml_get_f32_
+000906a0: 3164 2870 735b 705d 2d3e 6772 6164 2c20  1d(ps[p]->grad, 
+000906b0: 6a29 3b0a 2020 2020 2020 2020 7d0a 2020  j);.        }.  
+000906c0: 2020 7d0a 7d0a 0a2f 2f0a 2f2f 2041 4441    }.}..//.// ADA
+000906d0: 4d0a 2f2f 0a2f 2f20 2020 7265 663a 2068  M.//.//   ref: h
+000906e0: 7474 7073 3a2f 2f61 7278 6976 2e6f 7267  ttps://arxiv.org
+000906f0: 2f70 6466 2f31 3431 322e 3639 3830 2e70  /pdf/1412.6980.p
+00090700: 6466 0a2f 2f0a 0a73 7461 7469 6320 656e  df.//..static en
+00090710: 756d 2067 676d 6c5f 6f70 745f 7265 7375  um ggml_opt_resu
+00090720: 6c74 2067 676d 6c5f 6f70 745f 6164 616d  lt ggml_opt_adam
+00090730: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+00090740: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00090750: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+00090760: 7563 7420 6767 6d6c 5f6f 7074 5f63 6f6e  uct ggml_opt_con
+00090770: 7465 7874 202a 206f 7074 2c0a 2020 2020  text * opt,.    
+00090780: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00090790: 6f70 745f 7061 7261 6d73 2070 6172 616d  opt_params param
+000907a0: 732c 0a20 2020 2020 2020 2073 7472 7563  s,.        struc
+000907b0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000907c0: 662c 0a20 2020 2020 2020 2073 7472 7563  f,.        struc
+000907d0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+000907e0: 6766 2c0a 2020 2020 2020 2020 7374 7275  gf,.        stru
+000907f0: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
+00090800: 2067 6229 207b 0a20 2020 2047 474d 4c5f   gb) {.    GGML_
+00090810: 4153 5345 5254 2867 676d 6c5f 6973 5f73  ASSERT(ggml_is_s
+00090820: 6361 6c61 7228 6629 293b 0a0a 2020 2020  calar(f));..    
+00090830: 6766 2d3e 6e5f 7468 7265 6164 7320 3d20  gf->n_threads = 
+00090840: 7061 7261 6d73 2e6e 5f74 6872 6561 6473  params.n_threads
+00090850: 3b0a 2020 2020 6762 2d3e 6e5f 7468 7265  ;.    gb->n_thre
+00090860: 6164 7320 3d20 7061 7261 6d73 2e6e 5f74  ads = params.n_t
+00090870: 6872 6561 6473 3b0a 0a20 2020 202f 2f20  hreads;..    // 
+00090880: 7468 6573 6520 7769 6c6c 2073 746f 7265  these will store
+00090890: 2074 6865 2070 6172 616d 6574 6572 7320   the parameters 
+000908a0: 7765 2077 616e 7420 746f 206f 7074 696d  we want to optim
+000908b0: 697a 650a 2020 2020 7374 7275 6374 2067  ize.    struct g
+000908c0: 676d 6c5f 7465 6e73 6f72 202a 2070 735b  gml_tensor * ps[
+000908d0: 4747 4d4c 5f4d 4158 5f50 4152 414d 535d  GGML_MAX_PARAMS]
+000908e0: 3b0a 0a20 2020 2069 6e74 206e 7020 3d20  ;..    int np = 
+000908f0: 303b 0a20 2020 2069 6e74 206e 7820 3d20  0;.    int nx = 
+00090900: 303b 0a20 2020 2066 6f72 2028 696e 7420  0;.    for (int 
+00090910: 6920 3d20 303b 2069 203c 2067 662d 3e6e  i = 0; i < gf->n
+00090920: 5f6e 6f64 6573 3b20 2b2b 6929 207b 0a20  _nodes; ++i) {. 
+00090930: 2020 2020 2020 2069 6620 2867 662d 3e6e         if (gf->n
+00090940: 6f64 6573 5b69 5d2d 3e69 735f 7061 7261  odes[i]->is_para
+00090950: 6d29 207b 0a20 2020 2020 2020 2020 2020  m) {.           
+00090960: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+00090970: 4728 2266 6f75 6e64 2070 6172 616d 2025  G("found param %
+00090980: 643a 2067 7261 642d 3e6f 7020 3d20 2564  d: grad->op = %d
+00090990: 5c6e 222c 206e 702c 2067 662d 3e6e 6f64  \n", np, gf->nod
+000909a0: 6573 5b69 5d2d 3e67 7261 642d 3e6f 7029  es[i]->grad->op)
+000909b0: 3b0a 0a20 2020 2020 2020 2020 2020 2047  ;..            G
+000909c0: 474d 4c5f 4153 5345 5254 286e 7020 3c20  GML_ASSERT(np < 
+000909d0: 4747 4d4c 5f4d 4158 5f50 4152 414d 5329  GGML_MAX_PARAMS)
+000909e0: 3b0a 0a20 2020 2020 2020 2020 2020 2070  ;..            p
+000909f0: 735b 6e70 2b2b 5d20 3d20 6766 2d3e 6e6f  s[np++] = gf->no
+00090a00: 6465 735b 695d 3b0a 2020 2020 2020 2020  des[i];.        
+00090a10: 2020 2020 6e78 202b 3d20 6767 6d6c 5f6e      nx += ggml_n
+00090a20: 656c 656d 656e 7473 2867 662d 3e6e 6f64  elements(gf->nod
+00090a30: 6573 5b69 5d29 3b0a 2020 2020 2020 2020  es[i]);.        
+00090a40: 7d0a 2020 2020 7d0a 0a20 2020 2069 6620  }.    }..    if 
+00090a50: 2828 6f70 742d 3e70 6172 616d 732e 7479  ((opt->params.ty
+00090a60: 7065 2021 3d20 7061 7261 6d73 2e74 7970  pe != params.typ
+00090a70: 6529 207c 7c20 286f 7074 2d3e 6e78 2021  e) || (opt->nx !
+00090a80: 3d20 6e78 2920 7c7c 2028 6f70 742d 3e70  = nx) || (opt->p
+00090a90: 6172 616d 732e 7061 7374 2021 3d20 7061  arams.past != pa
+00090aa0: 7261 6d73 2e70 6173 7429 2920 7b0a 2020  rams.past)) {.  
+00090ab0: 2020 2020 2020 696e 7420 6974 6572 203d        int iter =
+00090ac0: 206f 7074 2d3e 6974 6572 3b0a 2020 2020   opt->iter;.    
+00090ad0: 2020 2020 6767 6d6c 5f6f 7074 5f69 6e69      ggml_opt_ini
+00090ae0: 7428 6f70 742d 3e63 7478 2c20 6f70 742c  t(opt->ctx, opt,
+00090af0: 2070 6172 616d 732c 206e 7829 3b0a 2020   params, nx);.  
+00090b00: 2020 2020 2020 6f70 742d 3e69 7465 7220        opt->iter 
+00090b10: 3d20 6974 6572 3b0a 2020 2020 7d0a 0a20  = iter;.    }.. 
+00090b20: 2020 202f 2f20 636f 6e73 7461 6e74 730a     // constants.
+00090b30: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00090b40: 7363 6865 6420 3d20 7061 7261 6d73 2e61  sched = params.a
+00090b50: 6461 6d2e 7363 6865 643b 0a20 2020 2063  dam.sched;.    c
+00090b60: 6f6e 7374 2066 6c6f 6174 2064 6563 6179  onst float decay
+00090b70: 203d 2070 6172 616d 732e 6164 616d 2e64   = params.adam.d
+00090b80: 6563 6179 202a 2073 6368 6564 3b0a 2020  ecay * sched;.  
+00090b90: 2020 636f 6e73 7420 666c 6f61 7420 616c    const float al
+00090ba0: 7068 6120 3d20 7061 7261 6d73 2e61 6461  pha = params.ada
+00090bb0: 6d2e 616c 7068 6120 2a20 7363 6865 643b  m.alpha * sched;
+00090bc0: 0a20 2020 2063 6f6e 7374 2066 6c6f 6174  .    const float
+00090bd0: 2062 6574 6131 203d 2070 6172 616d 732e   beta1 = params.
+00090be0: 6164 616d 2e62 6574 6131 3b0a 2020 2020  adam.beta1;.    
+00090bf0: 636f 6e73 7420 666c 6f61 7420 6265 7461  const float beta
+00090c00: 3220 3d20 7061 7261 6d73 2e61 6461 6d2e  2 = params.adam.
+00090c10: 6265 7461 323b 0a20 2020 2063 6f6e 7374  beta2;.    const
+00090c20: 2066 6c6f 6174 2065 7073 2020 203d 2070   float eps   = p
+00090c30: 6172 616d 732e 6164 616d 2e65 7073 3b0a  arams.adam.eps;.
+00090c40: 0a20 2020 2066 6c6f 6174 202a 2078 2020  .    float * x  
+00090c50: 3d20 6f70 742d 3e61 6461 6d2e 782d 3e64  = opt->adam.x->d
+00090c60: 6174 613b 2020 2f2f 2076 6965 7720 6f66  ata;  // view of
+00090c70: 2074 6865 2070 6172 616d 6574 6572 730a   the parameters.
+00090c80: 2020 2020 666c 6f61 7420 2a20 6731 203d      float * g1 =
+00090c90: 206f 7074 2d3e 6164 616d 2e67 312d 3e64   opt->adam.g1->d
+00090ca0: 6174 613b 202f 2f20 6772 6164 6965 6e74  ata; // gradient
+00090cb0: 0a20 2020 2066 6c6f 6174 202a 2067 3220  .    float * g2 
+00090cc0: 3d20 6f70 742d 3e61 6461 6d2e 6732 2d3e  = opt->adam.g2->
+00090cd0: 6461 7461 3b20 2f2f 2067 7261 6469 656e  data; // gradien
+00090ce0: 7420 7371 7561 7265 640a 2020 2020 666c  t squared.    fl
+00090cf0: 6f61 7420 2a20 6d20 203d 206f 7074 2d3e  oat * m  = opt->
+00090d00: 6164 616d 2e6d 2d3e 6461 7461 3b20 202f  adam.m->data;  /
+00090d10: 2f20 6669 7273 7420 6d6f 6d65 6e74 0a20  / first moment. 
+00090d20: 2020 2066 6c6f 6174 202a 2076 2020 3d20     float * v  = 
+00090d30: 6f70 742d 3e61 6461 6d2e 762d 3e64 6174  opt->adam.v->dat
+00090d40: 613b 2020 2f2f 2073 6563 6f6e 6420 6d6f  a;  // second mo
+00090d50: 6d65 6e74 0a20 2020 2066 6c6f 6174 202a  ment.    float *
+00090d60: 206d 6820 3d20 6f70 742d 3e61 6461 6d2e   mh = opt->adam.
+00090d70: 6d68 2d3e 6461 7461 3b20 2f2f 2066 6972  mh->data; // fir
+00090d80: 7374 206d 6f6d 656e 7420 6861 740a 2020  st moment hat.  
+00090d90: 2020 666c 6f61 7420 2a20 7668 203d 206f    float * vh = o
+00090da0: 7074 2d3e 6164 616d 2e76 682d 3e64 6174  pt->adam.vh->dat
+00090db0: 613b 202f 2f20 7365 636f 6e64 206d 6f6d  a; // second mom
+00090dc0: 656e 7420 6861 740a 0a20 2020 2066 6c6f  ent hat..    flo
+00090dd0: 6174 202a 2070 6620 3d20 7061 7261 6d73  at * pf = params
+00090de0: 2e70 6173 7420 3e20 3020 3f20 6f70 742d  .past > 0 ? opt-
+00090df0: 3e61 6461 6d2e 7066 2d3e 6461 7461 203a  >adam.pf->data :
+00090e00: 204e 554c 4c3b 202f 2f20 7061 7374 2066   NULL; // past f
+00090e10: 756e 6374 696f 6e20 7661 6c75 6573 0a0a  unction values..
+00090e20: 2020 2020 2f2f 2075 7064 6174 6520 7669      // update vi
+00090e30: 6577 0a20 2020 2067 676d 6c5f 6f70 745f  ew.    ggml_opt_
+00090e40: 6765 745f 7061 7261 6d73 286e 702c 2070  get_params(np, p
+00090e50: 732c 2078 293b 0a0a 2020 2020 2f2f 2063  s, x);..    // c
+00090e60: 6f6d 7075 7465 2074 6865 2066 756e 6374  ompute the funct
+00090e70: 696f 6e20 7661 6c75 650a 2020 2020 6767  ion value.    gg
+00090e80: 6d6c 5f67 7261 7068 5f72 6573 6574 2020  ml_graph_reset  
+00090e90: 2867 6629 3b0a 2020 2020 6767 6d6c 5f73  (gf);.    ggml_s
+00090ea0: 6574 5f66 3332 2020 2020 2020 2866 2d3e  et_f32      (f->
+00090eb0: 6772 6164 2c20 312e 3066 293b 0a20 2020  grad, 1.0f);.   
+00090ec0: 2067 676d 6c5f 6772 6170 685f 636f 6d70   ggml_graph_comp
+00090ed0: 7574 6528 6374 782c 2067 6229 3b0a 0a20  ute(ctx, gb);.. 
+00090ee0: 2020 206f 7074 2d3e 6164 616d 2e66 785f     opt->adam.fx_
+00090ef0: 7072 6576 203d 2067 676d 6c5f 6765 745f  prev = ggml_get_
+00090f00: 6633 325f 3164 2866 2c20 3029 3b0a 2020  f32_1d(f, 0);.  
+00090f10: 2020 6f70 742d 3e61 6461 6d2e 6678 5f62    opt->adam.fx_b
+00090f20: 6573 7420 3d20 6f70 742d 3e61 6461 6d2e  est = opt->adam.
+00090f30: 6678 5f70 7265 763b 0a20 2020 2069 6620  fx_prev;.    if 
+00090f40: 2870 6629 207b 0a20 2020 2020 2020 2070  (pf) {.        p
+00090f50: 665b 6f70 742d 3e69 7465 7220 2520 7061  f[opt->iter % pa
+00090f60: 7261 6d73 2e70 6173 745d 203d 206f 7074  rams.past] = opt
+00090f70: 2d3e 6164 616d 2e66 785f 7072 6576 3b0a  ->adam.fx_prev;.
+00090f80: 2020 2020 7d0a 0a20 2020 202f 2f20 696e      }..    // in
+00090f90: 6974 6961 6c69 7a65 0a20 2020 2069 6620  itialize.    if 
+00090fa0: 286f 7074 2d3e 6a75 7374 5f69 6e69 7469  (opt->just_initi
+00090fb0: 616c 697a 6564 2920 7b0a 2020 2020 2020  alized) {.      
+00090fc0: 2020 6f70 742d 3e61 6461 6d2e 6e5f 6e6f    opt->adam.n_no
+00090fd0: 5f69 6d70 726f 7665 6d65 6e74 203d 2030  _improvement = 0
+00090fe0: 3b0a 2020 2020 2020 2020 6f70 742d 3e6a  ;.        opt->j
+00090ff0: 7573 745f 696e 6974 6961 6c69 7a65 6420  ust_initialized 
+00091000: 3d20 6661 6c73 653b 0a20 2020 207d 0a0a  = false;.    }..
+00091010: 2020 2020 666c 6f61 7420 2a20 6678 5f62      float * fx_b
+00091020: 6573 7420 3d20 266f 7074 2d3e 6164 616d  est = &opt->adam
+00091030: 2e66 785f 6265 7374 3b0a 2020 2020 666c  .fx_best;.    fl
+00091040: 6f61 7420 2a20 6678 5f70 7265 7620 3d20  oat * fx_prev = 
+00091050: 266f 7074 2d3e 6164 616d 2e66 785f 7072  &opt->adam.fx_pr
+00091060: 6576 3b0a 2020 2020 696e 7420 2a20 6e5f  ev;.    int * n_
+00091070: 6e6f 5f69 6d70 726f 7665 6d65 6e74 203d  no_improvement =
+00091080: 2026 6f70 742d 3e61 6461 6d2e 6e5f 6e6f   &opt->adam.n_no
+00091090: 5f69 6d70 726f 7665 6d65 6e74 3b0a 0a20  _improvement;.. 
+000910a0: 2020 2069 6e74 2069 7465 7230 203d 206f     int iter0 = o
+000910b0: 7074 2d3e 6974 6572 3b0a 0a20 2020 202f  pt->iter;..    /
+000910c0: 2f20 7275 6e20 7468 6520 6f70 7469 6d69  / run the optimi
+000910d0: 7a65 720a 2020 2020 666f 7220 2869 6e74  zer.    for (int
+000910e0: 2074 203d 2030 3b20 7420 3c20 7061 7261   t = 0; t < para
+000910f0: 6d73 2e61 6461 6d2e 6e5f 6974 6572 3b20  ms.adam.n_iter; 
+00091100: 2b2b 7429 207b 0a20 2020 2020 2020 206f  ++t) {.        o
+00091110: 7074 2d3e 6974 6572 203d 2069 7465 7230  pt->iter = iter0
+00091120: 202b 2074 202b 2031 3b0a 2020 2020 2020   + t + 1;.      
+00091130: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
+00091140: 5547 2020 2822 3d3d 3d20 6974 6572 2025  UG  ("=== iter %
+00091150: 6420 3d3d 3d5c 6e22 2c20 7429 3b0a 0a20  d ===\n", t);.. 
+00091160: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
+00091170: 545f 4445 4255 4720 2028 2266 2020 2020  T_DEBUG  ("f    
+00091180: 2020 3d20 2531 302e 3666 5c6e 222c 2067    = %10.6f\n", g
+00091190: 676d 6c5f 6765 745f 6633 325f 3164 2866  gml_get_f32_1d(f
+000911a0: 2c20 3029 293b 0a20 2020 2020 2020 2047  , 0));.        G
+000911b0: 474d 4c5f 5052 494e 545f 4445 4255 475f  GML_PRINT_DEBUG_
+000911c0: 3528 2264 662f 6478 3020 3d20 2531 302e  5("df/dx0 = %10.
+000911d0: 3666 5c6e 222c 2067 676d 6c5f 6765 745f  6f\n", ggml_get_
+000911e0: 6633 325f 3164 2870 735b 305d 2d3e 6772  f32_1d(ps[0]->gr
+000911f0: 6164 2c20 3029 293b 0a20 2020 2020 2020  ad, 0));.       
+00091200: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+00091210: 475f 3528 2264 662f 6478 3120 3d20 2531  G_5("df/dx1 = %1
+00091220: 302e 3666 5c6e 222c 2067 676d 6c5f 6765  0.6f\n", ggml_ge
+00091230: 745f 6633 325f 3164 2870 735b 315d 2d3e  t_f32_1d(ps[1]->
+00091240: 6772 6164 2c20 3029 293b 0a0a 2020 2020  grad, 0));..    
+00091250: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00091260: 2030 3b20 6920 3c20 6e70 3b20 2b2b 6929   0; i < np; ++i)
+00091270: 207b 0a20 2020 2020 2020 2020 2020 2047   {.            G
+00091280: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
+00091290: 2270 6172 616d 2025 643a 2025 3130 2e36  "param %d: %10.6
+000912a0: 662c 2067 203d 2025 3130 2e36 665c 6e22  f, g = %10.6f\n"
+000912b0: 2c20 692c 0a20 2020 2020 2020 2020 2020  , i,.           
+000912c0: 2020 2020 2020 2020 2067 676d 6c5f 6765           ggml_ge
+000912d0: 745f 6633 325f 3164 2870 735b 695d 2c20  t_f32_1d(ps[i], 
+000912e0: 3029 2c20 6767 6d6c 5f67 6574 5f66 3332  0), ggml_get_f32
+000912f0: 5f31 6428 7073 5b69 5d2d 3e67 7261 642c  _1d(ps[i]->grad,
+00091300: 2030 2929 3b0a 2020 2020 2020 2020 7d0a   0));.        }.
+00091310: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+00091320: 6e74 3634 5f74 2074 5f73 7461 7274 5f77  nt64_t t_start_w
+00091330: 616c 6c20 3d20 6767 6d6c 5f74 696d 655f  all = ggml_time_
+00091340: 7573 2829 3b0a 2020 2020 2020 2020 636f  us();.        co
+00091350: 6e73 7420 696e 7436 345f 7420 745f 7374  nst int64_t t_st
+00091360: 6172 745f 6370 7520 3d20 6767 6d6c 5f63  art_cpu = ggml_c
+00091370: 7963 6c65 7328 293b 0a20 2020 2020 2020  ycles();.       
+00091380: 2055 4e55 5345 4428 745f 7374 6172 745f   UNUSED(t_start_
+00091390: 7761 6c6c 293b 0a20 2020 2020 2020 2055  wall);.        U
+000913a0: 4e55 5345 4428 745f 7374 6172 745f 6370  NUSED(t_start_cp
+000913b0: 7529 3b0a 0a20 2020 2020 2020 207b 0a20  u);..        {. 
+000913c0: 2020 2020 2020 2020 2020 202f 2f20 7570             // up
+000913d0: 6461 7465 2074 6865 2067 7261 6469 656e  date the gradien
+000913e0: 740a 2020 2020 2020 2020 2020 2020 6767  t.            gg
+000913f0: 6d6c 5f6f 7074 5f67 6574 5f67 7261 6428  ml_opt_get_grad(
+00091400: 6e70 2c20 7073 2c20 6731 293b 0a0a 2020  np, ps, g1);..  
+00091410: 2020 2020 2020 2020 2020 2f2f 206d 5f74            // m_t
+00091420: 203d 2062 6574 6131 2a6d 5f74 2d31 202b   = beta1*m_t-1 +
+00091430: 2028 3120 2d20 6265 7461 3129 2a67 5f74   (1 - beta1)*g_t
+00091440: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+00091450: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
+00091460: 6e78 2c20 6d2c 2062 6574 6131 293b 0a20  nx, m, beta1);. 
+00091470: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00091480: 7665 635f 6d61 645f 6633 3220 2028 6e78  vec_mad_f32  (nx
+00091490: 2c20 6d2c 2067 312c 2031 2e30 6620 2d20  , m, g1, 1.0f - 
+000914a0: 6265 7461 3129 3b0a 0a20 2020 2020 2020  beta1);..       
+000914b0: 2020 2020 202f 2f20 6732 203d 2067 315e       // g2 = g1^
+000914c0: 320a 2020 2020 2020 2020 2020 2020 6767  2.            gg
+000914d0: 6d6c 5f76 6563 5f73 7172 5f66 3332 2020  ml_vec_sqr_f32  
+000914e0: 286e 782c 2067 322c 2067 3129 3b0a 0a20  (nx, g2, g1);.. 
+000914f0: 2020 2020 2020 2020 2020 202f 2f20 765f             // v_
+00091500: 7420 3d20 6265 7461 322a 765f 742d 3120  t = beta2*v_t-1 
+00091510: 2b20 2831 202d 2062 6574 6132 292a 675f  + (1 - beta2)*g_
+00091520: 745e 320a 2020 2020 2020 2020 2020 2020  t^2.            
+00091530: 6767 6d6c 5f76 6563 5f73 6361 6c65 5f66  ggml_vec_scale_f
+00091540: 3332 286e 782c 2076 2c20 6265 7461 3229  32(nx, v, beta2)
+00091550: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
+00091560: 6d6c 5f76 6563 5f6d 6164 5f66 3332 2020  ml_vec_mad_f32  
+00091570: 286e 782c 2076 2c20 6732 2c20 312e 3066  (nx, v, g2, 1.0f
+00091580: 202d 2062 6574 6132 293b 0a0a 2020 2020   - beta2);..    
+00091590: 2020 2020 2020 2020 2f2f 206d 5e68 6174          // m^hat
+000915a0: 203d 206d 5f74 202f 2028 3120 2d20 6265   = m_t / (1 - be
+000915b0: 7461 315e 7429 0a20 2020 2020 2020 2020  ta1^t).         
+000915c0: 2020 202f 2f20 765e 6861 7420 3d20 765f     // v^hat = v_
+000915d0: 7420 2f20 2831 202d 2062 6574 6132 5e74  t / (1 - beta2^t
+000915e0: 290a 2020 2020 2020 2020 2020 2020 2f2f  ).            //
+000915f0: 2078 5f74 203d 2078 5f74 2d31 202d 2073   x_t = x_t-1 - s
+00091600: 6368 6564 2a28 616c 7068 612a 6d5e 6861  ched*(alpha*m^ha
+00091610: 742f 2873 7172 7428 765e 6861 7429 202b  t/(sqrt(v^hat) +
+00091620: 2065 7073 2920 2b20 6465 6361 792a 785f   eps) + decay*x_
+00091630: 742d 3129 0a20 2020 2020 2020 2020 2020  t-1).           
+00091640: 202f 2f20 785f 7420 3d20 785f 742d 3120   // x_t = x_t-1 
+00091650: 2d20 7363 6865 642a 616c 7068 612a 6d5e  - sched*alpha*m^
+00091660: 6861 742f 2873 7172 7428 765e 6861 7429  hat/(sqrt(v^hat)
+00091670: 202b 2065 7073 2920 2d20 7363 6865 642a   + eps) - sched*
+00091680: 6465 6361 792a 785f 742d 310a 2020 2020  decay*x_t-1.    
+00091690: 2020 2020 2020 2020 2f2f 2078 5f74 203d          // x_t =
+000916a0: 2078 5f74 2d31 2a28 312d 7363 6865 642a   x_t-1*(1-sched*
+000916b0: 6465 6361 7929 202d 2073 6368 6564 2a61  decay) - sched*a
+000916c0: 6c70 6861 2a6d 5e68 6174 2f28 7371 7274  lpha*m^hat/(sqrt
+000916d0: 2876 5e68 6174 2920 2b20 6570 7329 0a20  (v^hat) + eps). 
+000916e0: 2020 2020 2020 2020 2020 202f 2f20 785f             // x_
+000916f0: 7420 3d20 785f 742d 312a 2831 2d73 6368  t = x_t-1*(1-sch
+00091700: 6564 2a64 6563 6179 2920 2b20 7363 6865  ed*decay) + sche
+00091710: 642a 6465 6361 792a 282d 616c 7068 612f  d*decay*(-alpha/
+00091720: 6465 6361 7929 2a6d 5e68 6174 2f28 7371  decay)*m^hat/(sq
+00091730: 7274 2876 5e68 6174 2920 2b20 6570 7329  rt(v^hat) + eps)
+00091740: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+00091750: 785f 7420 3d20 6d69 7828 785f 742d 312c  x_t = mix(x_t-1,
+00091760: 2028 2d61 6c70 6861 2f64 6563 6179 292a   (-alpha/decay)*
+00091770: 6d5e 6861 742f 2873 7172 7428 765e 6861  m^hat/(sqrt(v^ha
+00091780: 7429 202b 2065 7073 292c 2073 6368 6564  t) + eps), sched
+00091790: 2a64 6563 6179 290a 2020 2020 2020 2020  *decay).        
+000917a0: 2020 2020 6767 6d6c 5f76 6563 5f63 7079      ggml_vec_cpy
+000917b0: 5f66 3332 2020 286e 782c 206d 682c 206d  _f32  (nx, mh, m
+000917c0: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
+000917d0: 676d 6c5f 7665 635f 6370 795f 6633 3220  gml_vec_cpy_f32 
+000917e0: 2028 6e78 2c20 7668 2c20 7629 3b0a 0a20   (nx, vh, v);.. 
+000917f0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00091800: 7665 635f 7363 616c 655f 6633 3228 6e78  vec_scale_f32(nx
+00091810: 2c20 6d68 2c20 616c 7068 612f 2831 2e30  , mh, alpha/(1.0
+00091820: 6620 2d20 706f 7766 2862 6574 6131 2c20  f - powf(beta1, 
+00091830: 6f70 742d 3e69 7465 7229 2929 3b0a 2020  opt->iter)));.  
+00091840: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+00091850: 6563 5f73 6361 6c65 5f66 3332 286e 782c  ec_scale_f32(nx,
+00091860: 2076 682c 2020 312e 3066 2f28 312e 3066   vh,  1.0f/(1.0f
+00091870: 202d 2070 6f77 6628 6265 7461 322c 206f   - powf(beta2, o
+00091880: 7074 2d3e 6974 6572 2929 293b 0a0a 2020  pt->iter)));..  
+00091890: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+000918a0: 6563 5f73 7172 745f 6633 3220 286e 782c  ec_sqrt_f32 (nx,
+000918b0: 2076 682c 2076 6829 3b0a 2020 2020 2020   vh, vh);.      
+000918c0: 2020 2020 2020 6767 6d6c 5f76 6563 5f61        ggml_vec_a
+000918d0: 6363 315f 6633 3220 286e 782c 2076 682c  cc1_f32 (nx, vh,
+000918e0: 2065 7073 293b 0a0a 2020 2020 2020 2020   eps);..        
+000918f0: 2020 2020 6767 6d6c 5f76 6563 5f64 6976      ggml_vec_div
+00091900: 5f66 3332 2020 286e 782c 206d 682c 206d  _f32  (nx, mh, m
+00091910: 682c 2076 6829 3b0a 2020 2020 2020 2020  h, vh);.        
+00091920: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
+00091930: 6c65 5f66 3332 286e 782c 2078 2c20 2031  le_f32(nx, x,  1
+00091940: 2e30 6620 2d20 6465 6361 7929 3b0a 2020  .0f - decay);.  
+00091950: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+00091960: 6563 5f73 7562 5f66 3332 2020 286e 782c  ec_sub_f32  (nx,
+00091970: 2078 2c20 2078 2c20 206d 6829 3b0a 0a20   x,  x,  mh);.. 
+00091980: 2020 2020 2020 2020 2020 202f 2f20 7570             // up
+00091990: 6461 7465 2074 6865 2070 6172 616d 6574  date the paramet
+000919a0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+000919b0: 6767 6d6c 5f6f 7074 5f73 6574 5f70 6172  ggml_opt_set_par
+000919c0: 616d 7328 6e70 2c20 7073 2c20 7829 3b0a  ams(np, ps, x);.
+000919d0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000919e0: 2020 2067 676d 6c5f 6772 6170 685f 7265     ggml_graph_re
+000919f0: 7365 7420 2028 6766 293b 0a20 2020 2020  set  (gf);.     
+00091a00: 2020 2067 676d 6c5f 7365 745f 6633 3220     ggml_set_f32 
+00091a10: 2020 2020 2028 662d 3e67 7261 642c 2031       (f->grad, 1
+00091a20: 2e30 6629 3b0a 2020 2020 2020 2020 6767  .0f);.        gg
+00091a30: 6d6c 5f67 7261 7068 5f63 6f6d 7075 7465  ml_graph_compute
+00091a40: 2863 7478 2c20 6762 293b 0a0a 2020 2020  (ctx, gb);..    
+00091a50: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00091a60: 6678 203d 2067 676d 6c5f 6765 745f 6633  fx = ggml_get_f3
+00091a70: 325f 3164 2866 2c20 3029 3b0a 0a20 2020  2_1d(f, 0);..   
+00091a80: 2020 2020 202f 2f20 6368 6563 6b20 636f       // check co
+00091a90: 6e76 6572 6765 6e63 650a 2020 2020 2020  nvergence.      
+00091aa0: 2020 6966 2028 6661 6273 6628 6678 202d    if (fabsf(fx -
+00091ab0: 2066 785f 7072 6576 5b30 5d29 2f66 7820   fx_prev[0])/fx 
+00091ac0: 3c20 7061 7261 6d73 2e61 6461 6d2e 6570  < params.adam.ep
+00091ad0: 735f 6629 207b 0a20 2020 2020 2020 2020  s_f) {.         
+00091ae0: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
+00091af0: 4255 4728 2263 6f6e 7665 7267 6564 5c6e  BUG("converged\n
+00091b00: 2229 3b0a 0a20 2020 2020 2020 2020 2020  ");..           
+00091b10: 2072 6574 7572 6e20 4747 4d4c 5f4f 5054   return GGML_OPT
+00091b20: 5f4f 4b3b 0a20 2020 2020 2020 207d 0a0a  _OK;.        }..
+00091b30: 2020 2020 2020 2020 2f2f 2064 656c 7461          // delta
+00091b40: 2d62 6173 6564 2063 6f6e 7665 7267 656e  -based convergen
+00091b50: 6365 2074 6573 740a 2020 2020 2020 2020  ce test.        
+00091b60: 6966 2028 7066 2021 3d20 4e55 4c4c 2920  if (pf != NULL) 
+00091b70: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
+00091b80: 206e 6565 6420 6174 206c 6561 7374 2070   need at least p
+00091b90: 6172 616d 732e 7061 7374 2069 7465 7261  arams.past itera
+00091ba0: 7469 6f6e 7320 746f 2073 7461 7274 2063  tions to start c
+00091bb0: 6865 636b 696e 6720 666f 7220 636f 6e76  hecking for conv
+00091bc0: 6572 6765 6e63 650a 2020 2020 2020 2020  ergence.        
+00091bd0: 2020 2020 6966 2028 7061 7261 6d73 2e70      if (params.p
+00091be0: 6173 7420 3c3d 2069 7465 7230 202b 2074  ast <= iter0 + t
+00091bf0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00091c00: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00091c10: 7261 7465 203d 2028 7066 5b28 6974 6572  rate = (pf[(iter
+00091c20: 3020 2b20 7429 2570 6172 616d 732e 7061  0 + t)%params.pa
+00091c30: 7374 5d20 2d20 6678 292f 6678 3b0a 0a20  st] - fx)/fx;.. 
+00091c40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00091c50: 6620 2866 6162 7366 2872 6174 6529 203c  f (fabsf(rate) <
+00091c60: 2070 6172 616d 732e 6465 6c74 6129 207b   params.delta) {
+00091c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00091c80: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+00091c90: 5f4f 5054 5f4f 4b3b 0a20 2020 2020 2020  _OPT_OK;.       
+00091ca0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00091cb0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00091cc0: 2020 2020 2020 7066 5b28 6974 6572 3020        pf[(iter0 
+00091cd0: 2b20 7429 2570 6172 616d 732e 7061 7374  + t)%params.past
+00091ce0: 5d20 3d20 6678 3b0a 2020 2020 2020 2020  ] = fx;.        
+00091cf0: 7d0a 0a20 2020 2020 2020 202f 2f20 6368  }..        // ch
+00091d00: 6563 6b20 666f 7220 696d 7072 6f76 656d  eck for improvem
+00091d10: 656e 740a 2020 2020 2020 2020 6966 2028  ent.        if (
+00091d20: 7061 7261 6d73 2e6d 6178 5f6e 6f5f 696d  params.max_no_im
+00091d30: 7072 6f76 656d 656e 7420 3e20 3029 207b  provement > 0) {
+00091d40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00091d50: 2866 785f 6265 7374 5b30 5d20 3e20 6678  (fx_best[0] > fx
+00091d60: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00091d70: 2020 2020 6678 5f62 6573 745b 305d 203d      fx_best[0] =
+00091d80: 2066 783b 0a20 2020 2020 2020 2020 2020   fx;.           
+00091d90: 2020 2020 206e 5f6e 6f5f 696d 7072 6f76       n_no_improv
+00091da0: 656d 656e 745b 305d 203d 2030 3b0a 2020  ement[0] = 0;.  
+00091db0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+00091dc0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00091dd0: 2020 202b 2b6e 5f6e 6f5f 696d 7072 6f76     ++n_no_improv
+00091de0: 656d 656e 745b 305d 3b0a 0a20 2020 2020  ement[0];..     
+00091df0: 2020 2020 2020 2020 2020 2069 6620 286e             if (n
+00091e00: 5f6e 6f5f 696d 7072 6f76 656d 656e 745b  _no_improvement[
+00091e10: 305d 203e 3d20 7061 7261 6d73 2e6d 6178  0] >= params.max
+00091e20: 5f6e 6f5f 696d 7072 6f76 656d 656e 7429  _no_improvement)
+00091e30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00091e40: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
+00091e50: 4d4c 5f4f 5054 5f4f 4b3b 0a20 2020 2020  ML_OPT_OK;.     
+00091e60: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00091e70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00091e80: 2020 207d 0a0a 2020 2020 2020 2020 6678     }..        fx
+00091e90: 5f70 7265 765b 305d 203d 2066 783b 0a0a  _prev[0] = fx;..
+00091ea0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00091eb0: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00091ec0: 345f 7420 745f 656e 645f 6370 7520 3d20  4_t t_end_cpu = 
+00091ed0: 6767 6d6c 5f63 7963 6c65 7328 293b 0a20  ggml_cycles();. 
+00091ee0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00091ef0: 5052 494e 545f 4445 4255 4728 2274 696d  PRINT_DEBUG("tim
+00091f00: 6520 6974 6572 3a20 2020 2020 2025 352e  e iter:      %5.
+00091f10: 3366 2073 5c6e 222c 2028 2866 6c6f 6174  3f s\n", ((float
+00091f20: 2928 745f 656e 645f 6370 7520 2d20 745f  )(t_end_cpu - t_
+00091f30: 7374 6172 745f 6370 7529 292f 434c 4f43  start_cpu))/CLOC
+00091f40: 4b53 5f50 4552 5f53 4543 293b 0a20 2020  KS_PER_SEC);.   
+00091f50: 2020 2020 2020 2020 2055 4e55 5345 4428           UNUSED(
+00091f60: 745f 656e 645f 6370 7529 3b0a 0a20 2020  t_end_cpu);..   
+00091f70: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+00091f80: 6e74 3634 5f74 2074 5f65 6e64 5f77 616c  nt64_t t_end_wal
+00091f90: 6c20 3d20 6767 6d6c 5f74 696d 655f 7573  l = ggml_time_us
+00091fa0: 2829 3b0a 2020 2020 2020 2020 2020 2020  ();.            
+00091fb0: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+00091fc0: 2822 7761 6c6c 2074 696d 6520 6974 6572  ("wall time iter
+00091fd0: 3a20 2535 2e33 6620 735c 6e22 2c20 2874  : %5.3f s\n", (t
+00091fe0: 5f65 6e64 5f77 616c 6c20 2d20 745f 7374  _end_wall - t_st
+00091ff0: 6172 745f 7761 6c6c 292f 3165 3629 3b0a  art_wall)/1e6);.
+00092000: 2020 2020 2020 2020 2020 2020 554e 5553              UNUS
+00092010: 4544 2874 5f65 6e64 5f77 616c 6c29 3b0a  ED(t_end_wall);.
+00092020: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+00092030: 0a20 2020 2072 6574 7572 6e20 4747 4d4c  .    return GGML
+00092040: 5f4f 5054 5f44 4944 5f4e 4f54 5f43 4f4e  _OPT_DID_NOT_CON
+00092050: 5645 5247 453b 0a7d 0a0a 2f2f 0a2f 2f20  VERGE;.}..//.// 
+00092060: 4c2d 4246 4753 0a2f 2f0a 2f2f 2074 6865  L-BFGS.//.// the
+00092070: 204c 2d42 4647 5320 696d 706c 656d 656e   L-BFGS implemen
+00092080: 7461 7469 6f6e 2062 656c 6f77 2069 7320  tation below is 
+00092090: 6261 7365 6420 6f6e 2074 6865 2066 6f6c  based on the fol
+000920a0: 6c6f 7769 6e67 2069 6d70 6c65 6d65 6e74  lowing implement
+000920b0: 6174 696f 6e3a 0a2f 2f0a 2f2f 2020 2068  ation:.//.//   h
+000920c0: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+000920d0: 6d2f 6368 6f6b 6b61 6e2f 6c69 626c 6266  m/chokkan/liblbf
+000920e0: 6773 0a2f 2f0a 0a73 7472 7563 7420 6767  gs.//..struct gg
+000920f0: 6d6c 5f6c 6266 6773 5f69 7465 7261 7469  ml_lbfgs_iterati
+00092100: 6f6e 5f64 6174 6120 7b0a 2020 2020 666c  on_data {.    fl
+00092110: 6f61 7420 616c 7068 613b 0a20 2020 2066  oat alpha;.    f
+00092120: 6c6f 6174 2079 733b 0a20 2020 2066 6c6f  loat ys;.    flo
+00092130: 6174 202a 2073 3b0a 2020 2020 666c 6f61  at * s;.    floa
+00092140: 7420 2a20 793b 0a7d 3b0a 0a73 7461 7469  t * y;.};..stati
+00092150: 6320 656e 756d 2067 676d 6c5f 6f70 745f  c enum ggml_opt_
+00092160: 7265 7375 6c74 206c 696e 6573 6561 7263  result linesearc
+00092170: 685f 6261 636b 7472 6163 6b69 6e67 280a  h_backtracking(.
+00092180: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00092190: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+000921a0: 782c 0a20 2020 2020 2020 2063 6f6e 7374  x,.        const
+000921b0: 2073 7472 7563 7420 6767 6d6c 5f6f 7074   struct ggml_opt
+000921c0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+000921d0: 2c0a 2020 2020 2020 2020 696e 7420 6e78  ,.        int nx
+000921e0: 2c0a 2020 2020 2020 2020 666c 6f61 7420  ,.        float 
+000921f0: 2a20 782c 0a20 2020 2020 2020 2066 6c6f  * x,.        flo
+00092200: 6174 202a 2066 782c 0a20 2020 2020 2020  at * fx,.       
+00092210: 2066 6c6f 6174 202a 2067 2c0a 2020 2020   float * g,.    
+00092220: 2020 2020 666c 6f61 7420 2a20 642c 0a20      float * d,. 
+00092230: 2020 2020 2020 2066 6c6f 6174 202a 2073         float * s
+00092240: 7465 702c 0a20 2020 2020 2020 2063 6f6e  tep,.        con
+00092250: 7374 2066 6c6f 6174 202a 2078 702c 0a20  st float * xp,. 
+00092260: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00092270: 6d6c 5f74 656e 736f 7220 2a20 662c 0a20  ml_tensor * f,. 
+00092280: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00092290: 6d6c 5f63 6772 6170 6820 2a20 6766 2c0a  ml_cgraph * gf,.
+000922a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+000922b0: 676d 6c5f 6367 7261 7068 202a 2067 622c  gml_cgraph * gb,
+000922c0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+000922d0: 6e74 206e 702c 0a20 2020 2020 2020 2073  nt np,.        s
+000922e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000922f0: 7220 2a20 7073 5b5d 2920 7b0a 2020 2020  r * ps[]) {.    
+00092300: 696e 7420 636f 756e 7420 3d20 303b 0a0a  int count = 0;..
+00092310: 2020 2020 666c 6f61 7420 7769 6474 6820      float width 
+00092320: 203d 2030 2e30 663b 0a20 2020 2066 6c6f   = 0.0f;.    flo
+00092330: 6174 2064 6720 2020 2020 3d20 302e 3066  at dg     = 0.0f
+00092340: 3b0a 2020 2020 666c 6f61 7420 6669 6e69  ;.    float fini
+00092350: 7420 203d 2030 2e30 663b 0a20 2020 2066  t  = 0.0f;.    f
+00092360: 6c6f 6174 2064 6769 6e69 7420 3d20 302e  loat dginit = 0.
+00092370: 3066 3b0a 2020 2020 666c 6f61 7420 6467  0f;.    float dg
+00092380: 7465 7374 203d 2030 2e30 663b 0a0a 2020  test = 0.0f;..  
+00092390: 2020 636f 6e73 7420 666c 6f61 7420 6465    const float de
+000923a0: 6320 3d20 302e 3566 3b0a 2020 2020 636f  c = 0.5f;.    co
+000923b0: 6e73 7420 666c 6f61 7420 696e 6320 3d20  nst float inc = 
+000923c0: 322e 3166 3b0a 0a20 2020 2069 6620 282a  2.1f;..    if (*
+000923d0: 7374 6570 203c 3d20 302e 6629 207b 0a20  step <= 0.f) {. 
+000923e0: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
+000923f0: 4d4c 5f4c 494e 4553 4541 5243 485f 494e  ML_LINESEARCH_IN
+00092400: 5641 4c49 445f 5041 5241 4d45 5445 5253  VALID_PARAMETERS
+00092410: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+00092420: 636f 6d70 7574 6520 7468 6520 696e 6974  compute the init
+00092430: 6961 6c20 6772 6164 6965 6e74 2069 6e20  ial gradient in 
+00092440: 7468 6520 7365 6172 6368 2064 6972 6563  the search direc
+00092450: 7469 6f6e 0a20 2020 2067 676d 6c5f 7665  tion.    ggml_ve
+00092460: 635f 646f 745f 6633 3228 6e78 2c20 2664  c_dot_f32(nx, &d
+00092470: 6769 6e69 742c 2067 2c20 6429 3b0a 0a20  ginit, g, d);.. 
+00092480: 2020 202f 2f20 6d61 6b65 2073 7572 6520     // make sure 
+00092490: 7468 6174 2064 2070 6f69 6e74 7320 746f  that d points to
+000924a0: 2061 2064 6573 6365 6e74 2064 6972 6563   a descent direc
+000924b0: 7469 6f6e 0a20 2020 2069 6620 2830 203c  tion.    if (0 <
+000924c0: 2064 6769 6e69 7429 207b 0a20 2020 2020   dginit) {.     
+000924d0: 2020 2072 6574 7572 6e20 4747 4d4c 5f4c     return GGML_L
+000924e0: 494e 4553 4541 5243 485f 4641 494c 3b0a  INESEARCH_FAIL;.
+000924f0: 2020 2020 7d0a 0a20 2020 202f 2f20 696e      }..    // in
+00092500: 6974 6961 6c69 7a65 206c 6f63 616c 2076  itialize local v
+00092510: 6172 6961 626c 6573 0a20 2020 2066 696e  ariables.    fin
+00092520: 6974 203d 202a 6678 3b0a 2020 2020 6467  it = *fx;.    dg
+00092530: 7465 7374 203d 2070 6172 616d 732d 3e6c  test = params->l
+00092540: 6266 6773 2e66 746f 6c2a 6467 696e 6974  bfgs.ftol*dginit
+00092550: 3b0a 0a20 2020 2077 6869 6c65 2028 7472  ;..    while (tr
+00092560: 7565 2920 7b0a 2020 2020 2020 2020 6767  ue) {.        gg
+00092570: 6d6c 5f76 6563 5f63 7079 5f66 3332 286e  ml_vec_cpy_f32(n
+00092580: 782c 2078 2c20 7870 293b 0a20 2020 2020  x, x, xp);.     
+00092590: 2020 2067 676d 6c5f 7665 635f 6d61 645f     ggml_vec_mad_
+000925a0: 6633 3228 6e78 2c20 782c 2064 2c20 2a73  f32(nx, x, d, *s
+000925b0: 7465 7029 3b0a 0a20 2020 2020 2020 202f  tep);..        /
+000925c0: 2f20 6576 616c 7561 7465 2074 6865 2066  / evaluate the f
+000925d0: 756e 6374 696f 6e20 616e 6420 6772 6164  unction and grad
+000925e0: 6965 6e74 2076 616c 7565 730a 2020 2020  ient values.    
+000925f0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00092600: 2020 6767 6d6c 5f6f 7074 5f73 6574 5f70    ggml_opt_set_p
+00092610: 6172 616d 7328 6e70 2c20 7073 2c20 7829  arams(np, ps, x)
+00092620: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
+00092630: 676d 6c5f 6772 6170 685f 7265 7365 7420  gml_graph_reset 
+00092640: 2028 6766 293b 0a20 2020 2020 2020 2020   (gf);.         
+00092650: 2020 2067 676d 6c5f 7365 745f 6633 3220     ggml_set_f32 
+00092660: 2020 2020 2028 662d 3e67 7261 642c 2031       (f->grad, 1
+00092670: 2e30 6629 3b0a 2020 2020 2020 2020 2020  .0f);.          
+00092680: 2020 6767 6d6c 5f67 7261 7068 5f63 6f6d    ggml_graph_com
+00092690: 7075 7465 2863 7478 2c20 6762 293b 0a0a  pute(ctx, gb);..
+000926a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000926b0: 5f6f 7074 5f67 6574 5f67 7261 6428 6e70  _opt_get_grad(np
+000926c0: 2c20 7073 2c20 6729 3b0a 0a20 2020 2020  , ps, g);..     
+000926d0: 2020 2020 2020 202a 6678 203d 2067 676d         *fx = ggm
+000926e0: 6c5f 6765 745f 6633 325f 3164 2866 2c20  l_get_f32_1d(f, 
+000926f0: 3029 3b0a 2020 2020 2020 2020 7d0a 0a20  0);.        }.. 
+00092700: 2020 2020 2020 202b 2b63 6f75 6e74 3b0a         ++count;.
+00092710: 0a20 2020 2020 2020 2069 6620 282a 6678  .        if (*fx
+00092720: 203e 2066 696e 6974 202b 2028 2a73 7465   > finit + (*ste
+00092730: 7029 2a64 6774 6573 7429 207b 0a20 2020  p)*dgtest) {.   
+00092740: 2020 2020 2020 2020 2077 6964 7468 203d           width =
+00092750: 2064 6563 3b0a 2020 2020 2020 2020 7d20   dec;.        } 
+00092760: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+00092770: 2020 202f 2f20 4172 6d69 6a6f 2063 6f6e     // Armijo con
+00092780: 6469 7469 6f6e 2069 7320 7361 7469 7366  dition is satisf
+00092790: 6965 640a 2020 2020 2020 2020 2020 2020  ied.            
+000927a0: 6966 2028 7061 7261 6d73 2d3e 6c62 6667  if (params->lbfg
+000927b0: 732e 6c69 6e65 7365 6172 6368 203d 3d20  s.linesearch == 
+000927c0: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
+000927d0: 4241 434b 5452 4143 4b49 4e47 5f41 524d  BACKTRACKING_ARM
+000927e0: 494a 4f29 207b 0a20 2020 2020 2020 2020  IJO) {.         
+000927f0: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
+00092800: 756e 743b 0a20 2020 2020 2020 2020 2020  unt;.           
+00092810: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00092820: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3332  ggml_vec_dot_f32
+00092830: 286e 782c 2026 6467 2c20 672c 2064 293b  (nx, &dg, g, d);
+00092840: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
+00092850: 2063 6865 636b 2074 6865 2057 6f6c 6665   check the Wolfe
+00092860: 2063 6f6e 6469 7469 6f6e 0a20 2020 2020   condition.     
+00092870: 2020 2020 2020 2069 6620 2864 6720 3c20         if (dg < 
+00092880: 7061 7261 6d73 2d3e 6c62 6667 732e 776f  params->lbfgs.wo
+00092890: 6c66 6520 2a20 6467 696e 6974 2920 7b0a  lfe * dginit) {.
+000928a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000928b0: 7769 6474 6820 3d20 696e 633b 0a20 2020  width = inc;.   
+000928c0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+000928d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000928e0: 2020 6966 2870 6172 616d 732d 3e6c 6266    if(params->lbf
+000928f0: 6773 2e6c 696e 6573 6561 7263 6820 3d3d  gs.linesearch ==
+00092900: 2047 474d 4c5f 4c49 4e45 5345 4152 4348   GGML_LINESEARCH
+00092910: 5f42 4143 4b54 5241 434b 494e 475f 574f  _BACKTRACKING_WO
+00092920: 4c46 4529 207b 0a20 2020 2020 2020 2020  LFE) {.         
+00092930: 2020 2020 2020 2020 2020 202f 2f20 7265             // re
+00092940: 6775 6c61 7220 576f 6c66 6520 636f 6e64  gular Wolfe cond
+00092950: 6974 696f 6e73 0a20 2020 2020 2020 2020  itions.         
+00092960: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00092970: 6e20 636f 756e 743b 0a20 2020 2020 2020  n count;.       
+00092980: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00092990: 2020 2020 2020 2020 2020 2020 6966 2864              if(d
+000929a0: 6720 3e20 2d70 6172 616d 732d 3e6c 6266  g > -params->lbf
+000929b0: 6773 2e77 6f6c 6665 2a64 6769 6e69 7429  gs.wolfe*dginit)
+000929c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000929d0: 2020 2020 2020 2077 6964 7468 203d 2064         width = d
+000929e0: 6563 3b0a 2020 2020 2020 2020 2020 2020  ec;.            
+000929f0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+00092a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00092a10: 202f 2f20 7374 726f 6e67 2057 6f6c 6665   // strong Wolfe
+00092a20: 2063 6f6e 6469 7469 6f6e 2028 4747 4d4c   condition (GGML
+00092a30: 5f4c 494e 4553 4541 5243 485f 4241 434b  _LINESEARCH_BACK
+00092a40: 5452 4143 4b49 4e47 5f53 5452 4f4e 475f  TRACKING_STRONG_
+00092a50: 574f 4c46 4529 0a20 2020 2020 2020 2020  WOLFE).         
+00092a60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00092a70: 6e20 636f 756e 743b 0a20 2020 2020 2020  n count;.       
+00092a80: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00092a90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00092aa0: 6e20 636f 756e 743b 0a20 2020 2020 2020  n count;.       
+00092ab0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00092ac0: 0a0a 2020 2020 2020 2020 6966 2028 2a73  ..        if (*s
+00092ad0: 7465 7020 3c20 7061 7261 6d73 2d3e 6c62  tep < params->lb
+00092ae0: 6667 732e 6d69 6e5f 7374 6570 2920 7b0a  fgs.min_step) {.
+00092af0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00092b00: 726e 2047 474d 4c5f 4c49 4e45 5345 4152  rn GGML_LINESEAR
+00092b10: 4348 5f4d 494e 494d 554d 5f53 5445 503b  CH_MINIMUM_STEP;
+00092b20: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00092b30: 2020 2069 6620 282a 7374 6570 203e 2070     if (*step > p
+00092b40: 6172 616d 732d 3e6c 6266 6773 2e6d 6178  arams->lbfgs.max
+00092b50: 5f73 7465 7029 207b 0a20 2020 2020 2020  _step) {.       
+00092b60: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+00092b70: 5f4c 494e 4553 4541 5243 485f 4d41 5849  _LINESEARCH_MAXI
+00092b80: 4d55 4d5f 5354 4550 3b0a 2020 2020 2020  MUM_STEP;.      
+00092b90: 2020 7d0a 2020 2020 2020 2020 6966 2028    }.        if (
+00092ba0: 7061 7261 6d73 2d3e 6c62 6667 732e 6d61  params->lbfgs.ma
+00092bb0: 785f 6c69 6e65 7365 6172 6368 203c 3d20  x_linesearch <= 
+00092bc0: 636f 756e 7429 207b 0a20 2020 2020 2020  count) {.       
+00092bd0: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+00092be0: 5f4c 494e 4553 4541 5243 485f 4d41 5849  _LINESEARCH_MAXI
+00092bf0: 4d55 4d5f 4954 4552 4154 494f 4e53 3b0a  MUM_ITERATIONS;.
+00092c00: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00092c10: 2020 2028 2a73 7465 7029 202a 3d20 7769     (*step) *= wi
+00092c20: 6474 683b 0a20 2020 207d 0a0a 2020 2020  dth;.    }..    
+00092c30: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
+00092c40: 5345 4152 4348 5f46 4149 4c3b 0a7d 0a0a  SEARCH_FAIL;.}..
+00092c50: 7374 6174 6963 2065 6e75 6d20 6767 6d6c  static enum ggml
+00092c60: 5f6f 7074 5f72 6573 756c 7420 6767 6d6c  _opt_result ggml
+00092c70: 5f6f 7074 5f6c 6266 6773 280a 2020 2020  _opt_lbfgs(.    
+00092c80: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00092c90: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+00092ca0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00092cb0: 6d6c 5f6f 7074 5f63 6f6e 7465 7874 202a  ml_opt_context *
+00092cc0: 206f 7074 2c0a 2020 2020 2020 2020 7374   opt,.        st
+00092cd0: 7275 6374 2067 676d 6c5f 6f70 745f 7061  ruct ggml_opt_pa
+00092ce0: 7261 6d73 2070 6172 616d 732c 0a20 2020  rams params,.   
+00092cf0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00092d00: 5f74 656e 736f 7220 2a20 662c 0a20 2020  _tensor * f,.   
+00092d10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00092d20: 5f63 6772 6170 6820 2a20 6766 2c0a 2020  _cgraph * gf,.  
+00092d30: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00092d40: 6c5f 6367 7261 7068 202a 2067 6229 207b  l_cgraph * gb) {
+00092d50: 0a20 2020 2069 6620 2870 6172 616d 732e  .    if (params.
+00092d60: 6c62 6667 732e 6c69 6e65 7365 6172 6368  lbfgs.linesearch
+00092d70: 203d 3d20 4747 4d4c 5f4c 494e 4553 4541   == GGML_LINESEA
+00092d80: 5243 485f 4241 434b 5452 4143 4b49 4e47  RCH_BACKTRACKING
+00092d90: 5f57 4f4c 4645 207c 7c0a 2020 2020 2020  _WOLFE ||.      
+00092da0: 2020 7061 7261 6d73 2e6c 6266 6773 2e6c    params.lbfgs.l
+00092db0: 696e 6573 6561 7263 6820 3d3d 2047 474d  inesearch == GGM
+00092dc0: 4c5f 4c49 4e45 5345 4152 4348 5f42 4143  L_LINESEARCH_BAC
+00092dd0: 4b54 5241 434b 494e 475f 5354 524f 4e47  KTRACKING_STRONG
+00092de0: 5f57 4f4c 4645 2920 7b0a 2020 2020 2020  _WOLFE) {.      
+00092df0: 2020 6966 2028 7061 7261 6d73 2e6c 6266    if (params.lbf
+00092e00: 6773 2e77 6f6c 6665 203c 3d20 7061 7261  gs.wolfe <= para
+00092e10: 6d73 2e6c 6266 6773 2e66 746f 6c20 7c7c  ms.lbfgs.ftol ||
+00092e20: 2031 2e66 203c 3d20 7061 7261 6d73 2e6c   1.f <= params.l
+00092e30: 6266 6773 2e77 6f6c 6665 2920 7b0a 2020  bfgs.wolfe) {.  
+00092e40: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00092e50: 2047 474d 4c5f 4f50 545f 494e 5641 4c49   GGML_OPT_INVALI
+00092e60: 445f 574f 4c46 453b 0a20 2020 2020 2020  D_WOLFE;.       
+00092e70: 207d 0a20 2020 207d 0a0a 2020 2020 6766   }.    }..    gf
+00092e80: 2d3e 6e5f 7468 7265 6164 7320 3d20 7061  ->n_threads = pa
+00092e90: 7261 6d73 2e6e 5f74 6872 6561 6473 3b0a  rams.n_threads;.
+00092ea0: 2020 2020 6762 2d3e 6e5f 7468 7265 6164      gb->n_thread
+00092eb0: 7320 3d20 7061 7261 6d73 2e6e 5f74 6872  s = params.n_thr
+00092ec0: 6561 6473 3b0a 0a20 2020 2063 6f6e 7374  eads;..    const
+00092ed0: 2069 6e74 206d 203d 2070 6172 616d 732e   int m = params.
+00092ee0: 6c62 6667 732e 6d3b 0a0a 2020 2020 2f2f  lbfgs.m;..    //
+00092ef0: 2074 6865 7365 2077 696c 6c20 7374 6f72   these will stor
+00092f00: 6520 7468 6520 7061 7261 6d65 7465 7273  e the parameters
+00092f10: 2077 6520 7761 6e74 2074 6f20 6f70 7469   we want to opti
+00092f20: 6d69 7a65 0a20 2020 2073 7472 7563 7420  mize.    struct 
+00092f30: 6767 6d6c 5f74 656e 736f 7220 2a20 7073  ggml_tensor * ps
+00092f40: 5b47 474d 4c5f 4d41 585f 5041 5241 4d53  [GGML_MAX_PARAMS
+00092f50: 5d3b 0a0a 2020 2020 696e 7420 6e70 203d  ];..    int np =
+00092f60: 2030 3b0a 2020 2020 696e 7420 6e78 203d   0;.    int nx =
+00092f70: 2030 3b0a 2020 2020 666f 7220 2869 6e74   0;.    for (int
+00092f80: 2069 203d 2030 3b20 6920 3c20 6766 2d3e   i = 0; i < gf->
+00092f90: 6e5f 6e6f 6465 733b 202b 2b69 2920 7b0a  n_nodes; ++i) {.
+00092fa0: 2020 2020 2020 2020 6966 2028 6766 2d3e          if (gf->
+00092fb0: 6e6f 6465 735b 695d 2d3e 6973 5f70 6172  nodes[i]->is_par
+00092fc0: 616d 2920 7b0a 2020 2020 2020 2020 2020  am) {.          
+00092fd0: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
+00092fe0: 5547 2822 666f 756e 6420 7061 7261 6d20  UG("found param 
+00092ff0: 2564 3a20 6772 6164 2d3e 6f70 203d 2025  %d: grad->op = %
+00093000: 645c 6e22 2c20 6e70 2c20 6766 2d3e 6e6f  d\n", np, gf->no
+00093010: 6465 735b 695d 2d3e 6772 6164 2d3e 6f70  des[i]->grad->op
+00093020: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00093030: 4747 4d4c 5f41 5353 4552 5428 6e70 203c  GGML_ASSERT(np <
+00093040: 2047 474d 4c5f 4d41 585f 5041 5241 4d53   GGML_MAX_PARAMS
+00093050: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00093060: 7073 5b6e 702b 2b5d 203d 2067 662d 3e6e  ps[np++] = gf->n
+00093070: 6f64 6573 5b69 5d3b 0a20 2020 2020 2020  odes[i];.       
+00093080: 2020 2020 206e 7820 2b3d 2067 676d 6c5f       nx += ggml_
+00093090: 6e65 6c65 6d65 6e74 7328 6766 2d3e 6e6f  nelements(gf->no
+000930a0: 6465 735b 695d 293b 0a20 2020 2020 2020  des[i]);.       
+000930b0: 207d 0a20 2020 207d 0a0a 2020 2020 6966   }.    }..    if
+000930c0: 2028 286f 7074 2d3e 7061 7261 6d73 2e74   ((opt->params.t
+000930d0: 7970 6520 213d 2070 6172 616d 732e 7479  ype != params.ty
+000930e0: 7065 2920 7c7c 2028 6f70 742d 3e6e 7820  pe) || (opt->nx 
+000930f0: 213d 206e 7829 207c 7c20 286f 7074 2d3e  != nx) || (opt->
+00093100: 7061 7261 6d73 2e70 6173 7420 213d 2070  params.past != p
+00093110: 6172 616d 732e 7061 7374 2920 7c7c 2028  arams.past) || (
+00093120: 6f70 742d 3e70 6172 616d 732e 6c62 6667  opt->params.lbfg
+00093130: 732e 6d20 213d 2070 6172 616d 732e 6c62  s.m != params.lb
+00093140: 6667 732e 6d29 2920 7b0a 2020 2020 2020  fgs.m)) {.      
+00093150: 2020 696e 7420 6974 6572 203d 206f 7074    int iter = opt
+00093160: 2d3e 6974 6572 3b0a 2020 2020 2020 2020  ->iter;.        
+00093170: 6767 6d6c 5f6f 7074 5f69 6e69 7428 6374  ggml_opt_init(ct
+00093180: 782c 206f 7074 2c20 7061 7261 6d73 2c20  x, opt, params, 
+00093190: 6e78 293b 0a20 2020 2020 2020 206f 7074  nx);.        opt
+000931a0: 2d3e 6974 6572 203d 2069 7465 723b 0a20  ->iter = iter;. 
+000931b0: 2020 207d 0a0a 2020 2020 666c 6f61 7420     }..    float 
+000931c0: 2a20 7820 203d 206f 7074 2d3e 6c62 6667  * x  = opt->lbfg
+000931d0: 732e 782d 3e64 6174 613b 2020 2f2f 2063  s.x->data;  // c
+000931e0: 7572 7265 6e74 2070 6172 616d 6574 6572  urrent parameter
+000931f0: 730a 2020 2020 666c 6f61 7420 2a20 7870  s.    float * xp
+00093200: 203d 206f 7074 2d3e 6c62 6667 732e 7870   = opt->lbfgs.xp
+00093210: 2d3e 6461 7461 3b20 2f2f 2070 7265 7669  ->data; // previ
+00093220: 6f75 7320 7061 7261 6d65 7465 7273 0a20  ous parameters. 
+00093230: 2020 2066 6c6f 6174 202a 2067 2020 3d20     float * g  = 
+00093240: 6f70 742d 3e6c 6266 6773 2e67 2d3e 6461  opt->lbfgs.g->da
+00093250: 7461 3b20 202f 2f20 6375 7272 656e 7420  ta;  // current 
+00093260: 6772 6164 6965 6e74 0a20 2020 2066 6c6f  gradient.    flo
+00093270: 6174 202a 2067 7020 3d20 6f70 742d 3e6c  at * gp = opt->l
+00093280: 6266 6773 2e67 702d 3e64 6174 613b 202f  bfgs.gp->data; /
+00093290: 2f20 7072 6576 696f 7573 2067 7261 6469  / previous gradi
+000932a0: 656e 740a 2020 2020 666c 6f61 7420 2a20  ent.    float * 
+000932b0: 6420 203d 206f 7074 2d3e 6c62 6667 732e  d  = opt->lbfgs.
+000932c0: 642d 3e64 6174 613b 2020 2f2f 2073 6561  d->data;  // sea
+000932d0: 7263 6820 6469 7265 6374 696f 6e0a 0a20  rch direction.. 
+000932e0: 2020 2066 6c6f 6174 202a 2070 6620 3d20     float * pf = 
+000932f0: 7061 7261 6d73 2e70 6173 7420 3e20 3020  params.past > 0 
+00093300: 3f20 6f70 742d 3e6c 6266 6773 2e70 662d  ? opt->lbfgs.pf-
+00093310: 3e64 6174 6120 3a20 4e55 4c4c 3b20 2f2f  >data : NULL; //
+00093320: 2070 6173 7420 6675 6e63 7469 6f6e 2076   past function v
+00093330: 616c 7565 730a 0a20 2020 2066 6c6f 6174  alues..    float
+00093340: 2066 7820 2020 203d 2030 2e30 663b 202f   fx    = 0.0f; /
+00093350: 2f20 636f 7374 2066 756e 6374 696f 6e20  / cost function 
+00093360: 7661 6c75 650a 2020 2020 666c 6f61 7420  value.    float 
+00093370: 786e 6f72 6d20 3d20 302e 3066 3b20 2f2f  xnorm = 0.0f; //
+00093380: 207c 7c78 7c7c 0a20 2020 2066 6c6f 6174   ||x||.    float
+00093390: 2067 6e6f 726d 203d 2030 2e30 663b 202f   gnorm = 0.0f; /
+000933a0: 2f20 7c7c 677c 7c0a 0a20 2020 202f 2f20  / ||g||..    // 
+000933b0: 696e 6974 6961 6c69 7a65 2078 2066 726f  initialize x fro
+000933c0: 6d20 7468 6520 6772 6170 6820 6e6f 6465  m the graph node
+000933d0: 730a 2020 2020 6767 6d6c 5f6f 7074 5f67  s.    ggml_opt_g
+000933e0: 6574 5f70 6172 616d 7328 6e70 2c20 7073  et_params(np, ps
+000933f0: 2c20 7829 3b0a 0a20 2020 202f 2f20 7468  , x);..    // th
+00093400: 6520 4c2d 4246 4753 206d 656d 6f72 790a  e L-BFGS memory.
+00093410: 2020 2020 666c 6f61 7420 2a20 6c6d 5f61      float * lm_a
+00093420: 6c70 6861 203d 206f 7074 2d3e 6c62 6667  lpha = opt->lbfg
+00093430: 732e 6c6d 616c 2d3e 6461 7461 3b0a 2020  s.lmal->data;.  
+00093440: 2020 666c 6f61 7420 2a20 6c6d 5f79 7320    float * lm_ys 
+00093450: 2020 203d 206f 7074 2d3e 6c62 6667 732e     = opt->lbfgs.
+00093460: 6c6d 7973 2d3e 6461 7461 3b0a 2020 2020  lmys->data;.    
+00093470: 666c 6f61 7420 2a20 6c6d 5f73 2020 2020  float * lm_s    
+00093480: 203d 206f 7074 2d3e 6c62 6667 732e 6c6d   = opt->lbfgs.lm
+00093490: 732d 3e64 6174 613b 0a20 2020 2066 6c6f  s->data;.    flo
+000934a0: 6174 202a 206c 6d5f 7920 2020 2020 3d20  at * lm_y     = 
+000934b0: 6f70 742d 3e6c 6266 6773 2e6c 6d79 2d3e  opt->lbfgs.lmy->
+000934c0: 6461 7461 3b0a 0a20 2020 202f 2f20 6576  data;..    // ev
+000934d0: 616c 7561 7465 2074 6865 2066 756e 6374  aluate the funct
+000934e0: 696f 6e20 7661 6c75 6520 616e 6420 6974  ion value and it
+000934f0: 7320 6772 6164 6965 6e74 0a20 2020 207b  s gradient.    {
+00093500: 0a20 2020 2020 2020 2067 676d 6c5f 6f70  .        ggml_op
+00093510: 745f 7365 745f 7061 7261 6d73 286e 702c  t_set_params(np,
+00093520: 2070 732c 2078 293b 0a0a 2020 2020 2020   ps, x);..      
+00093530: 2020 6767 6d6c 5f67 7261 7068 5f72 6573    ggml_graph_res
+00093540: 6574 2020 2867 6629 3b0a 2020 2020 2020  et  (gf);.      
+00093550: 2020 6767 6d6c 5f73 6574 5f66 3332 2020    ggml_set_f32  
+00093560: 2020 2020 2866 2d3e 6772 6164 2c20 312e      (f->grad, 1.
+00093570: 3066 293b 0a20 2020 2020 2020 2067 676d  0f);.        ggm
+00093580: 6c5f 6772 6170 685f 636f 6d70 7574 6528  l_graph_compute(
+00093590: 6374 782c 2067 6229 3b0a 0a20 2020 2020  ctx, gb);..     
+000935a0: 2020 2067 676d 6c5f 6f70 745f 6765 745f     ggml_opt_get_
+000935b0: 6772 6164 286e 702c 2070 732c 2067 293b  grad(np, ps, g);
+000935c0: 0a0a 2020 2020 2020 2020 6678 203d 2067  ..        fx = g
+000935d0: 676d 6c5f 6765 745f 6633 325f 3164 2866  gml_get_f32_1d(f
+000935e0: 2c20 3029 3b0a 2020 2020 7d0a 0a20 2020  , 0);.    }..   
+000935f0: 202f 2f20 7365 6172 6368 2064 6972 6563   // search direc
+00093600: 7469 6f6e 203d 202d 6772 6164 6965 6e74  tion = -gradient
+00093610: 0a20 2020 2067 676d 6c5f 7665 635f 6e65  .    ggml_vec_ne
+00093620: 675f 6633 3228 6e78 2c20 642c 2067 293b  g_f32(nx, d, g);
+00093630: 0a0a 2020 2020 2f2f 207c 7c78 7c7c 2c20  ..    // ||x||, 
+00093640: 7c7c 677c 7c0a 2020 2020 6767 6d6c 5f76  ||g||.    ggml_v
+00093650: 6563 5f6e 6f72 6d5f 6633 3228 6e78 2c20  ec_norm_f32(nx, 
+00093660: 2678 6e6f 726d 2c20 7829 3b0a 2020 2020  &xnorm, x);.    
+00093670: 6767 6d6c 5f76 6563 5f6e 6f72 6d5f 6633  ggml_vec_norm_f3
+00093680: 3228 6e78 2c20 2667 6e6f 726d 2c20 6729  2(nx, &gnorm, g)
+00093690: 3b0a 0a20 2020 2069 6620 2878 6e6f 726d  ;..    if (xnorm
+000936a0: 203c 2031 2e30 6629 207b 0a20 2020 2020   < 1.0f) {.     
+000936b0: 2020 2078 6e6f 726d 203d 2031 2e30 663b     xnorm = 1.0f;
+000936c0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2061  .    }..    // a
+000936d0: 6c72 6561 6479 206f 7074 696d 697a 6564  lready optimized
+000936e0: 0a20 2020 2069 6620 2867 6e6f 726d 2f78  .    if (gnorm/x
+000936f0: 6e6f 726d 203c 3d20 7061 7261 6d73 2e6c  norm <= params.l
+00093700: 6266 6773 2e65 7073 2920 7b0a 2020 2020  bfgs.eps) {.    
+00093710: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
+00093720: 4f50 545f 4f4b 3b0a 2020 2020 7d0a 0a20  OPT_OK;.    }.. 
+00093730: 2020 2069 6620 286f 7074 2d3e 6a75 7374     if (opt->just
+00093740: 5f69 6e69 7469 616c 697a 6564 2920 7b0a  _initialized) {.
+00093750: 2020 2020 2020 2020 6966 2028 7066 2920          if (pf) 
+00093760: 7b0a 2020 2020 2020 2020 2020 2020 7066  {.            pf
+00093770: 5b30 5d20 3d20 6678 3b0a 2020 2020 2020  [0] = fx;.      
+00093780: 2020 7d0a 2020 2020 2020 2020 6f70 742d    }.        opt-
+00093790: 3e6c 6266 6773 2e66 785f 6265 7374 203d  >lbfgs.fx_best =
+000937a0: 2066 783b 0a0a 2020 2020 2020 2020 2f2f   fx;..        //
+000937b0: 2069 6e69 7469 616c 2073 7465 700a 2020   initial step.  
+000937c0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6e        ggml_vec_n
+000937d0: 6f72 6d5f 696e 765f 6633 3228 6e78 2c20  orm_inv_f32(nx, 
+000937e0: 266f 7074 2d3e 6c62 6667 732e 7374 6570  &opt->lbfgs.step
+000937f0: 2c20 6429 3b0a 2020 2020 2020 2020 6f70  , d);.        op
+00093800: 742d 3e6c 6266 6773 2e6a 2020 2020 2020  t->lbfgs.j      
+00093810: 2020 2020 2020 2020 2020 3d20 303b 0a20            = 0;. 
+00093820: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
+00093830: 732e 6b20 2020 2020 2020 2020 2020 2020  s.k             
+00093840: 2020 203d 2031 3b0a 2020 2020 2020 2020     = 1;.        
+00093850: 6f70 742d 3e6c 6266 6773 2e65 6e64 2020  opt->lbfgs.end  
+00093860: 2020 2020 2020 2020 2020 2020 3d20 303b              = 0;
+00093870: 0a20 2020 2020 2020 206f 7074 2d3e 6c62  .        opt->lb
+00093880: 6667 732e 6e5f 6e6f 5f69 6d70 726f 7665  fgs.n_no_improve
+00093890: 6d65 6e74 203d 2030 3b0a 2020 2020 2020  ment = 0;.      
+000938a0: 2020 6f70 742d 3e6a 7573 745f 696e 6974    opt->just_init
+000938b0: 6961 6c69 7a65 6420 2020 2020 2020 3d20  ialized       = 
+000938c0: 6661 6c73 653b 0a20 2020 207d 0a0a 2020  false;.    }..  
+000938d0: 2020 666c 6f61 7420 2a20 6678 5f62 6573    float * fx_bes
+000938e0: 7420 2020 2020 2020 203d 2026 6f70 742d  t        = &opt-
+000938f0: 3e6c 6266 6773 2e66 785f 6265 7374 3b0a  >lbfgs.fx_best;.
+00093900: 2020 2020 666c 6f61 7420 2a20 7374 6570      float * step
+00093910: 2020 2020 2020 2020 2020 203d 2026 6f70             = &op
+00093920: 742d 3e6c 6266 6773 2e73 7465 703b 0a20  t->lbfgs.step;. 
+00093930: 2020 2069 6e74 202a 206a 2020 2020 2020     int * j      
+00093940: 2020 2020 2020 2020 2020 3d20 266f 7074            = &opt
+00093950: 2d3e 6c62 6667 732e 6a3b 0a20 2020 2069  ->lbfgs.j;.    i
+00093960: 6e74 202a 206b 2020 2020 2020 2020 2020  nt * k          
+00093970: 2020 2020 2020 3d20 266f 7074 2d3e 6c62        = &opt->lb
+00093980: 6667 732e 6b3b 0a20 2020 2069 6e74 202a  fgs.k;.    int *
+00093990: 2065 6e64 2020 2020 2020 2020 2020 2020   end            
+000939a0: 2020 3d20 266f 7074 2d3e 6c62 6667 732e    = &opt->lbfgs.
+000939b0: 656e 643b 0a20 2020 2069 6e74 202a 206e  end;.    int * n
+000939c0: 5f6e 6f5f 696d 7072 6f76 656d 656e 7420  _no_improvement 
+000939d0: 3d20 266f 7074 2d3e 6c62 6667 732e 6e5f  = &opt->lbfgs.n_
+000939e0: 6e6f 5f69 6d70 726f 7665 6d65 6e74 3b0a  no_improvement;.
+000939f0: 0a20 2020 2069 6e74 206c 7320 2020 2020  .    int ls     
+00093a00: 3d20 303b 0a20 2020 2069 6e74 2062 6f75  = 0;.    int bou
+00093a10: 6e64 2020 3d20 303b 0a0a 2020 2020 666c  nd  = 0;..    fl
+00093a20: 6f61 7420 7973 2020 203d 2030 2e30 663b  oat ys   = 0.0f;
+00093a30: 0a20 2020 2066 6c6f 6174 2079 7920 2020  .    float yy   
+00093a40: 3d20 302e 3066 3b0a 2020 2020 666c 6f61  = 0.0f;.    floa
+00093a50: 7420 6265 7461 203d 2030 2e30 663b 0a0a  t beta = 0.0f;..
+00093a60: 2020 2020 696e 7420 6974 203d 2030 3b0a      int it = 0;.
+00093a70: 0a20 2020 2077 6869 6c65 2028 7472 7565  .    while (true
+00093a80: 2920 7b0a 2020 2020 2020 2020 2f2f 2073  ) {.        // s
+00093a90: 746f 7265 2074 6865 2063 7572 7265 6e74  tore the current
+00093aa0: 2070 6f73 6974 696f 6e20 616e 6420 6772   position and gr
+00093ab0: 6164 6965 6e74 2076 6563 746f 7273 0a20  adient vectors. 
+00093ac0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00093ad0: 6370 795f 6633 3228 6e78 2c20 7870 2c20  cpy_f32(nx, xp, 
+00093ae0: 7829 3b0a 2020 2020 2020 2020 6767 6d6c  x);.        ggml
+00093af0: 5f76 6563 5f63 7079 5f66 3332 286e 782c  _vec_cpy_f32(nx,
+00093b00: 2067 702c 2067 293b 0a0a 2020 2020 2020   gp, g);..      
+00093b10: 2020 6c73 203d 206c 696e 6573 6561 7263    ls = linesearc
+00093b20: 685f 6261 636b 7472 6163 6b69 6e67 2863  h_backtracking(c
+00093b30: 7478 2c20 2670 6172 616d 732c 206e 782c  tx, &params, nx,
+00093b40: 2078 2c20 2666 782c 2067 2c20 642c 2073   x, &fx, g, d, s
+00093b50: 7465 702c 2078 702c 2066 2c20 6766 2c20  tep, xp, f, gf, 
+00093b60: 6762 2c20 6e70 2c20 7073 293b 0a0a 2020  gb, np, ps);..  
+00093b70: 2020 2020 2020 6966 2028 6c73 203c 2030        if (ls < 0
+00093b80: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00093b90: 2f2f 206c 696e 6573 6561 7263 6820 6661  // linesearch fa
+00093ba0: 696c 6564 202d 2067 6f20 6261 636b 2074  iled - go back t
+00093bb0: 6f20 7468 6520 7072 6576 696f 7573 2070  o the previous p
+00093bc0: 6f69 6e74 2061 6e64 2072 6574 7572 6e0a  oint and return.
+00093bd0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00093be0: 5f76 6563 5f63 7079 5f66 3332 286e 782c  _vec_cpy_f32(nx,
+00093bf0: 2078 2c20 7870 293b 0a20 2020 2020 2020   x, xp);.       
+00093c00: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
+00093c10: 795f 6633 3228 6e78 2c20 672c 2067 7029  y_f32(nx, g, gp)
+00093c20: 3b0a 0a20 2020 2020 2020 2020 2020 2072  ;..            r
+00093c30: 6574 7572 6e20 6c73 3b0a 2020 2020 2020  eturn ls;.      
+00093c40: 2020 7d0a 0a20 2020 2020 2020 2067 676d    }..        ggm
+00093c50: 6c5f 7665 635f 6e6f 726d 5f66 3332 286e  l_vec_norm_f32(n
+00093c60: 782c 2026 786e 6f72 6d2c 2078 293b 0a20  x, &xnorm, x);. 
+00093c70: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00093c80: 6e6f 726d 5f66 3332 286e 782c 2026 676e  norm_f32(nx, &gn
+00093c90: 6f72 6d2c 2067 293b 0a0a 2020 2020 2020  orm, g);..      
+00093ca0: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
+00093cb0: 5547 2822 6620 3d20 2531 302e 3666 5c6e  UG("f = %10.6f\n
+00093cc0: 222c 2067 676d 6c5f 6765 745f 6633 325f  ", ggml_get_f32_
+00093cd0: 3164 2866 2c20 3029 293b 0a0a 2020 2020  1d(f, 0));..    
+00093ce0: 2020 2020 6966 2028 786e 6f72 6d20 3c20      if (xnorm < 
+00093cf0: 312e 3066 2920 7b0a 2020 2020 2020 2020  1.0f) {.        
+00093d00: 2020 2020 786e 6f72 6d20 3d20 312e 3066      xnorm = 1.0f
+00093d10: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+00093d20: 2020 2020 6966 2028 676e 6f72 6d2f 786e      if (gnorm/xn
+00093d30: 6f72 6d20 3c3d 2070 6172 616d 732e 6c62  orm <= params.lb
+00093d40: 6667 732e 6570 7329 207b 0a20 2020 2020  fgs.eps) {.     
+00093d50: 2020 2020 2020 202f 2f20 636f 6e76 6572         // conver
+00093d60: 6765 640a 2020 2020 2020 2020 2020 2020  ged.            
+00093d70: 7265 7475 726e 2047 474d 4c5f 4f50 545f  return GGML_OPT_
+00093d80: 4f4b 3b0a 2020 2020 2020 2020 7d0a 0a20  OK;.        }.. 
+00093d90: 2020 2020 2020 202f 2f20 6465 6c74 612d         // delta-
+00093da0: 6261 7365 6420 636f 6e76 6572 6765 6e63  based convergenc
+00093db0: 6520 7465 7374 0a20 2020 2020 2020 2069  e test.        i
+00093dc0: 6620 2870 6620 213d 204e 554c 4c29 207b  f (pf != NULL) {
+00093dd0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+00093de0: 6e65 6564 2061 7420 6c65 6173 7420 7061  need at least pa
+00093df0: 7261 6d73 2e70 6173 7420 6974 6572 6174  rams.past iterat
+00093e00: 696f 6e73 2074 6f20 7374 6172 7420 6368  ions to start ch
+00093e10: 6563 6b69 6e67 2066 6f72 2063 6f6e 7665  ecking for conve
+00093e20: 7267 656e 6365 0a20 2020 2020 2020 2020  rgence.         
+00093e30: 2020 2069 6620 2870 6172 616d 732e 7061     if (params.pa
+00093e40: 7374 203c 3d20 6b5b 305d 2920 7b0a 2020  st <= k[0]) {.  
+00093e50: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00093e60: 6e73 7420 666c 6f61 7420 7261 7465 203d  nst float rate =
+00093e70: 2028 7066 5b6b 5b30 5d25 7061 7261 6d73   (pf[k[0]%params
+00093e80: 2e70 6173 745d 202d 2066 7829 2f66 783b  .past] - fx)/fx;
+00093e90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00093ea0: 2020 6966 2028 6661 6273 6628 7261 7465    if (fabsf(rate
+00093eb0: 2920 3c20 7061 7261 6d73 2e64 656c 7461  ) < params.delta
+00093ec0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00093ed0: 2020 2020 2020 2020 7265 7475 726e 2047          return G
+00093ee0: 474d 4c5f 4f50 545f 4f4b 3b0a 2020 2020  GML_OPT_OK;.    
+00093ef0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00093f00: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00093f10: 2020 2020 2020 2020 2070 665b 6b5b 305d           pf[k[0]
+00093f20: 2570 6172 616d 732e 7061 7374 5d20 3d20  %params.past] = 
+00093f30: 6678 3b0a 2020 2020 2020 2020 7d0a 0a20  fx;.        }.. 
+00093f40: 2020 2020 2020 202f 2f20 6368 6563 6b20         // check 
+00093f50: 666f 7220 696d 7072 6f76 656d 656e 740a  for improvement.
+00093f60: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
+00093f70: 6d73 2e6d 6178 5f6e 6f5f 696d 7072 6f76  ms.max_no_improv
+00093f80: 656d 656e 7420 3e20 3029 207b 0a20 2020  ement > 0) {.   
+00093f90: 2020 2020 2020 2020 2069 6620 2866 7820           if (fx 
+00093fa0: 3c20 6678 5f62 6573 745b 305d 2920 7b0a  < fx_best[0]) {.
+00093fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00093fc0: 6678 5f62 6573 745b 305d 203d 2066 783b  fx_best[0] = fx;
+00093fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00093fe0: 206e 5f6e 6f5f 696d 7072 6f76 656d 656e   n_no_improvemen
+00093ff0: 745b 305d 203d 2030 3b0a 2020 2020 2020  t[0] = 0;.      
+00094000: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
+00094010: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00094020: 5f6e 6f5f 696d 7072 6f76 656d 656e 745b  _no_improvement[
+00094030: 305d 2b2b 3b0a 0a20 2020 2020 2020 2020  0]++;..         
+00094040: 2020 2020 2020 2069 6620 286e 5f6e 6f5f         if (n_no_
+00094050: 696d 7072 6f76 656d 656e 745b 305d 203e  improvement[0] >
+00094060: 3d20 7061 7261 6d73 2e6d 6178 5f6e 6f5f  = params.max_no_
+00094070: 696d 7072 6f76 656d 656e 7429 207b 0a20  improvement) {. 
+00094080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094090: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
+000940a0: 5054 5f4f 4b3b 0a20 2020 2020 2020 2020  PT_OK;.         
+000940b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000940c0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+000940d0: 0a0a 2020 2020 2020 2020 6966 2028 7061  ..        if (pa
+000940e0: 7261 6d73 2e6c 6266 6773 2e6e 5f69 7465  rams.lbfgs.n_ite
+000940f0: 7220 213d 2030 2026 2620 7061 7261 6d73  r != 0 && params
+00094100: 2e6c 6266 6773 2e6e 5f69 7465 7220 3c20  .lbfgs.n_iter < 
+00094110: 6974 202b 2031 2920 7b0a 2020 2020 2020  it + 1) {.      
+00094120: 2020 2020 2020 2f2f 2072 6561 6368 6564        // reached
+00094130: 2074 6865 206d 6178 696d 756d 206e 756d   the maximum num
+00094140: 6265 7220 6f66 2069 7465 7261 7469 6f6e  ber of iteration
+00094150: 730a 2020 2020 2020 2020 2020 2020 7265  s.            re
+00094160: 7475 726e 2047 474d 4c5f 4f50 545f 4449  turn GGML_OPT_DI
+00094170: 445f 4e4f 545f 434f 4e56 4552 4745 3b0a  D_NOT_CONVERGE;.
+00094180: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00094190: 2020 202f 2f20 7570 6461 7465 2076 6563     // update vec
+000941a0: 746f 7273 2073 2061 6e64 2079 3a0a 2020  tors s and y:.  
+000941b0: 2020 2020 2020 2f2f 2020 2073 5f7b 6b2b        //   s_{k+
+000941c0: 317d 203d 2078 5f7b 6b2b 317d 202d 2078  1} = x_{k+1} - x
+000941d0: 5f7b 6b7d 203d 205c 7374 6570 202a 2064  _{k} = \step * d
+000941e0: 5f7b 6b7d 2e0a 2020 2020 2020 2020 2f2f  _{k}..        //
+000941f0: 2020 2079 5f7b 6b2b 317d 203d 2067 5f7b     y_{k+1} = g_{
+00094200: 6b2b 317d 202d 2067 5f7b 6b7d 2e0a 2020  k+1} - g_{k}..  
+00094210: 2020 2020 2020 2f2f 0a20 2020 2020 2020        //.       
+00094220: 2067 676d 6c5f 7665 635f 7375 625f 6633   ggml_vec_sub_f3
+00094230: 3228 6e78 2c20 266c 6d5f 735b 656e 645b  2(nx, &lm_s[end[
+00094240: 305d 2a6e 785d 2c20 782c 2078 7029 3b0a  0]*nx], x, xp);.
+00094250: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00094260: 5f73 7562 5f66 3332 286e 782c 2026 6c6d  _sub_f32(nx, &lm
+00094270: 5f79 5b65 6e64 5b30 5d2a 6e78 5d2c 2067  _y[end[0]*nx], g
+00094280: 2c20 6770 293b 0a0a 2020 2020 2020 2020  , gp);..        
+00094290: 2f2f 2063 6f6d 7075 7465 2073 6361 6c61  // compute scala
+000942a0: 7273 2079 7320 616e 6420 7979 3a0a 2020  rs ys and yy:.  
+000942b0: 2020 2020 2020 2f2f 2020 2020 2079 7320        //     ys 
+000942c0: 3d20 795e 7420 5c63 646f 7420 7320 2020  = y^t \cdot s   
+000942d0: 202d 3e20 3120 2f20 5c72 686f 2e0a 2020   -> 1 / \rho..  
+000942e0: 2020 2020 2020 2f2f 2020 2020 2079 7920        //     yy 
+000942f0: 3d20 795e 7420 5c63 646f 7420 792e 0a20  = y^t \cdot y.. 
+00094300: 2020 2020 2020 202f 2f0a 2020 2020 2020         //.      
+00094310: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
+00094320: 3332 286e 782c 2026 7973 2c20 266c 6d5f  32(nx, &ys, &lm_
+00094330: 795b 656e 645b 305d 2a6e 785d 2c20 266c  y[end[0]*nx], &l
+00094340: 6d5f 735b 656e 645b 305d 202a 6e78 5d29  m_s[end[0] *nx])
+00094350: 3b0a 2020 2020 2020 2020 6767 6d6c 5f76  ;.        ggml_v
+00094360: 6563 5f64 6f74 5f66 3332 286e 782c 2026  ec_dot_f32(nx, &
+00094370: 7979 2c20 266c 6d5f 795b 656e 645b 305d  yy, &lm_y[end[0]
+00094380: 2a6e 785d 2c20 266c 6d5f 795b 656e 645b  *nx], &lm_y[end[
+00094390: 305d 2a6e 785d 293b 0a0a 2020 2020 2020  0]*nx]);..      
+000943a0: 2020 6c6d 5f79 735b 656e 645b 305d 5d20    lm_ys[end[0]] 
+000943b0: 3d20 7973 3b0a 0a20 2020 2020 2020 202f  = ys;..        /
+000943c0: 2f20 6669 6e64 206e 6577 2073 6561 7263  / find new searc
+000943d0: 6820 6469 7265 6374 696f 6e0a 2020 2020  h direction.    
+000943e0: 2020 2020 2f2f 2020 2072 6566 3a20 6874      //   ref: ht
+000943f0: 7470 733a 2f2f 656e 2e77 696b 6970 6564  tps://en.wikiped
+00094400: 6961 2e6f 7267 2f77 696b 692f 4c69 6d69  ia.org/wiki/Limi
+00094410: 7465 642d 6d65 6d6f 7279 5f42 4647 530a  ted-memory_BFGS.
+00094420: 0a20 2020 2020 2020 2062 6f75 6e64 203d  .        bound =
+00094430: 2028 6d20 3c3d 206b 5b30 5d29 203f 206d   (m <= k[0]) ? m
+00094440: 203a 206b 5b30 5d3b 0a20 2020 2020 2020   : k[0];.       
+00094450: 206b 5b30 5d2b 2b3b 0a20 2020 2020 2020   k[0]++;.       
+00094460: 2069 742b 2b3b 0a20 2020 2020 2020 2065   it++;.        e
+00094470: 6e64 5b30 5d20 3d20 2865 6e64 5b30 5d20  nd[0] = (end[0] 
+00094480: 2b20 3129 256d 3b0a 0a20 2020 2020 2020  + 1)%m;..       
+00094490: 202f 2f20 696e 6974 6961 6c69 7a65 2073   // initialize s
+000944a0: 6561 7263 6820 6469 7265 6374 696f 6e20  earch direction 
+000944b0: 7769 7468 202d 670a 2020 2020 2020 2020  with -g.        
+000944c0: 6767 6d6c 5f76 6563 5f6e 6567 5f66 3332  ggml_vec_neg_f32
+000944d0: 286e 782c 2064 2c20 6729 3b0a 0a20 2020  (nx, d, g);..   
+000944e0: 2020 2020 206a 5b30 5d20 3d20 656e 645b       j[0] = end[
+000944f0: 305d 3b0a 2020 2020 2020 2020 666f 7220  0];.        for 
+00094500: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+00094510: 626f 756e 643b 202b 2b69 2920 7b0a 2020  bound; ++i) {.  
+00094520: 2020 2020 2020 2020 2020 6a5b 305d 203d            j[0] =
+00094530: 2028 6a5b 305d 202b 206d 202d 2031 2920   (j[0] + m - 1) 
+00094540: 2520 6d3b 0a20 2020 2020 2020 2020 2020  % m;.           
+00094550: 202f 2f20 5c61 6c70 6861 5f7b 6a7d 203d   // \alpha_{j} =
+00094560: 205c 7268 6f5f 7b6a 7d20 735e 7b74 7d5f   \rho_{j} s^{t}_
+00094570: 7b6a 7d20 5c63 646f 7420 715f 7b6b 2b31  {j} \cdot q_{k+1
+00094580: 7d0a 2020 2020 2020 2020 2020 2020 6767  }.            gg
+00094590: 6d6c 5f76 6563 5f64 6f74 5f66 3332 286e  ml_vec_dot_f32(n
+000945a0: 782c 2026 6c6d 5f61 6c70 6861 5b6a 5b30  x, &lm_alpha[j[0
+000945b0: 5d5d 2c20 266c 6d5f 735b 6a5b 305d 2a6e  ]], &lm_s[j[0]*n
+000945c0: 785d 2c20 6429 3b0a 2020 2020 2020 2020  x], d);.        
+000945d0: 2020 2020 6c6d 5f61 6c70 6861 5b6a 5b30      lm_alpha[j[0
+000945e0: 5d5d 202f 3d20 6c6d 5f79 735b 6a5b 305d  ]] /= lm_ys[j[0]
+000945f0: 5d3b 0a20 2020 2020 2020 2020 2020 202f  ];.            /
+00094600: 2f20 715f 7b69 7d20 3d20 715f 7b69 2b31  / q_{i} = q_{i+1
+00094610: 7d20 2d20 5c61 6c70 6861 5f7b 697d 2079  } - \alpha_{i} y
+00094620: 5f7b 697d 0a20 2020 2020 2020 2020 2020  _{i}.           
+00094630: 2067 676d 6c5f 7665 635f 6d61 645f 6633   ggml_vec_mad_f3
+00094640: 3228 6e78 2c20 642c 2026 6c6d 5f79 5b6a  2(nx, d, &lm_y[j
+00094650: 5b30 5d2a 6e78 5d2c 202d 6c6d 5f61 6c70  [0]*nx], -lm_alp
+00094660: 6861 5b6a 5b30 5d5d 293b 0a20 2020 2020  ha[j[0]]);.     
+00094670: 2020 207d 0a0a 2020 2020 2020 2020 6767     }..        gg
+00094680: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
+00094690: 286e 782c 2064 2c20 7973 2f79 7929 3b0a  (nx, d, ys/yy);.
+000946a0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+000946b0: 7420 6920 3d20 303b 2069 203c 2062 6f75  t i = 0; i < bou
+000946c0: 6e64 3b20 2b2b 6929 207b 0a20 2020 2020  nd; ++i) {.     
+000946d0: 2020 2020 2020 202f 2f20 5c62 6574 615f         // \beta_
+000946e0: 7b6a 7d20 3d20 5c72 686f 5f7b 6a7d 2079  {j} = \rho_{j} y
+000946f0: 5e74 5f7b 6a7d 205c 6364 6f74 205c 6761  ^t_{j} \cdot \ga
+00094700: 6d6d 615f 7b69 7d0a 2020 2020 2020 2020  mma_{i}.        
+00094710: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+00094720: 5f66 3332 286e 782c 2026 6265 7461 2c20  _f32(nx, &beta, 
+00094730: 266c 6d5f 795b 6a5b 305d 2a6e 785d 2c20  &lm_y[j[0]*nx], 
+00094740: 6429 3b0a 2020 2020 2020 2020 2020 2020  d);.            
+00094750: 6265 7461 202f 3d20 6c6d 5f79 735b 6a5b  beta /= lm_ys[j[
+00094760: 305d 5d3b 0a20 2020 2020 2020 2020 2020  0]];.           
+00094770: 202f 2f20 5c67 616d 6d61 5f7b 692b 317d   // \gamma_{i+1}
+00094780: 203d 205c 6761 6d6d 615f 7b69 7d20 2b20   = \gamma_{i} + 
+00094790: 285c 616c 7068 615f 7b6a 7d20 2d20 5c62  (\alpha_{j} - \b
+000947a0: 6574 615f 7b6a 7d29 2073 5f7b 6a7d 0a20  eta_{j}) s_{j}. 
+000947b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000947c0: 7665 635f 6d61 645f 6633 3228 6e78 2c20  vec_mad_f32(nx, 
+000947d0: 642c 2026 6c6d 5f73 5b6a 5b30 5d2a 6e78  d, &lm_s[j[0]*nx
+000947e0: 5d2c 206c 6d5f 616c 7068 615b 6a5b 305d  ], lm_alpha[j[0]
+000947f0: 5d20 2d20 6265 7461 293b 0a20 2020 2020  ] - beta);.     
+00094800: 2020 2020 2020 206a 5b30 5d20 3d20 286a         j[0] = (j
+00094810: 5b30 5d20 2b20 3129 256d 3b0a 2020 2020  [0] + 1)%m;.    
+00094820: 2020 2020 7d0a 0a20 2020 2020 2020 2073      }..        s
+00094830: 7465 705b 305d 203d 2031 2e30 3b0a 2020  tep[0] = 1.0;.  
+00094840: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
+00094850: 4747 4d4c 5f4f 5054 5f44 4944 5f4e 4f54  GGML_OPT_DID_NOT
+00094860: 5f43 4f4e 5645 5247 453b 0a7d 0a0a 7374  _CONVERGE;.}..st
+00094870: 7275 6374 2067 676d 6c5f 6f70 745f 7061  ruct ggml_opt_pa
+00094880: 7261 6d73 2067 676d 6c5f 6f70 745f 6465  rams ggml_opt_de
+00094890: 6661 756c 745f 7061 7261 6d73 2865 6e75  fault_params(enu
+000948a0: 6d20 6767 6d6c 5f6f 7074 5f74 7970 6520  m ggml_opt_type 
+000948b0: 7479 7065 2920 7b0a 2020 2020 7374 7275  type) {.    stru
+000948c0: 6374 2067 676d 6c5f 6f70 745f 7061 7261  ct ggml_opt_para
+000948d0: 6d73 2072 6573 756c 743b 0a0a 2020 2020  ms result;..    
+000948e0: 7377 6974 6368 2028 7479 7065 2920 7b0a  switch (type) {.
+000948f0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00094900: 4c5f 4f50 545f 4144 414d 3a0a 2020 2020  L_OPT_ADAM:.    
+00094910: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00094920: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00094930: 203d 2028 7374 7275 6374 2067 676d 6c5f   = (struct ggml_
+00094940: 6f70 745f 7061 7261 6d73 2920 7b0a 2020  opt_params) {.  
+00094950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094960: 2020 2e74 7970 6520 2020 2020 203d 2047    .type      = G
+00094970: 474d 4c5f 4f50 545f 4144 414d 2c0a 2020  GML_OPT_ADAM,.  
+00094980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094990: 2020 2e6e 5f74 6872 6561 6473 203d 2031    .n_threads = 1
+000949a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000949b0: 2020 2020 2020 2e70 6173 7420 2020 2020        .past     
+000949c0: 203d 2030 2c0a 2020 2020 2020 2020 2020   = 0,.          
+000949d0: 2020 2020 2020 2020 2020 2e64 656c 7461            .delta
+000949e0: 2020 2020 203d 2031 652d 3566 2c0a 0a20       = 1e-5f,.. 
 000949f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094a00: 2020 2020 202e 6265 7461 3220 203d 2030       .beta2  = 0
-00094a10: 2e39 3939 662c 0a20 2020 2020 2020 2020  .999f,.         
-00094a20: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-00094a30: 6570 7320 2020 203d 2031 652d 3866 2c0a  eps    = 1e-8f,.
-00094a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094a50: 2020 2020 2020 2020 2e65 7073 5f66 2020          .eps_f  
-00094a60: 3d20 3165 2d35 662c 0a20 2020 2020 2020  = 1e-5f,.       
-00094a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094a80: 202e 6570 735f 6720 203d 2031 652d 3366   .eps_g  = 1e-3f
-00094a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00094aa0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00094ab0: 2020 2020 2020 2020 207d 3b0a 2020 2020           };.    
-00094ac0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00094ad0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00094ae0: 4d4c 5f4f 5054 5f4c 4246 4753 3a0a 2020  ML_OPT_LBFGS:.  
-00094af0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00094b00: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00094b10: 6c74 203d 2028 7374 7275 6374 2067 676d  lt = (struct ggm
-00094b20: 6c5f 6f70 745f 7061 7261 6d73 2920 7b0a  l_opt_params) {.
-00094b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094b40: 2020 2020 2e74 7970 6520 2020 2020 203d      .type      =
-00094b50: 2047 474d 4c5f 4f50 545f 4c42 4647 532c   GGML_OPT_LBFGS,
-00094b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00094b70: 2020 2020 202e 6e5f 7468 7265 6164 7320       .n_threads 
-00094b80: 3d20 312c 0a20 2020 2020 2020 2020 2020  = 1,.           
-00094b90: 2020 2020 2020 2020 202e 7061 7374 2020           .past  
-00094ba0: 2020 2020 3d20 302c 0a20 2020 2020 2020      = 0,.       
-00094bb0: 2020 2020 2020 2020 2020 2020 202e 6465               .de
-00094bc0: 6c74 6120 2020 2020 3d20 3165 2d35 662c  lta     = 1e-5f,
-00094bd0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00094be0: 2020 2020 2020 2e6d 6178 5f6e 6f5f 696d        .max_no_im
-00094bf0: 7072 6f76 656d 656e 7420 3d20 302c 0a0a  provement = 0,..
-00094c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094c10: 2020 2020 2e70 7269 6e74 5f66 6f72 7761      .print_forwa
-00094c20: 7264 5f67 7261 7068 2020 3d20 7472 7565  rd_graph  = true
-00094c30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00094c40: 2020 2020 2020 2e70 7269 6e74 5f62 6163        .print_bac
-00094c50: 6b77 6172 645f 6772 6170 6820 3d20 7472  kward_graph = tr
-00094c60: 7565 2c0a 0a20 2020 2020 2020 2020 2020  ue,..           
-00094c70: 2020 2020 2020 2020 202e 6c62 6667 7320           .lbfgs 
-00094c80: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00094c90: 2020 2020 2020 2020 2020 2020 2e6d 2020              .m  
-00094ca0: 2020 2020 2020 2020 2020 2020 3d20 362c              = 6,
-00094cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00094cc0: 2020 2020 2020 2020 202e 6e5f 6974 6572           .n_iter
-00094cd0: 2020 2020 2020 2020 203d 2031 3030 2c0a           = 100,.
-00094ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094cf0: 2020 2020 2020 2020 2e6d 6178 5f6c 696e          .max_lin
-00094d00: 6573 6561 7263 6820 3d20 3230 2c0a 0a20  esearch = 20,.. 
-00094d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094d20: 2020 2020 2020 202e 6570 7320 2020 2020         .eps     
-00094d30: 203d 2031 652d 3566 2c0a 2020 2020 2020   = 1e-5f,.      
-00094d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094d50: 2020 2e66 746f 6c20 2020 2020 3d20 3165    .ftol     = 1e
-00094d60: 2d34 662c 0a20 2020 2020 2020 2020 2020  -4f,.           
-00094d70: 2020 2020 2020 2020 2020 2020 202e 776f               .wo
-00094d80: 6c66 6520 2020 203d 2030 2e39 662c 0a20  lfe    = 0.9f,. 
-00094d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094da0: 2020 2020 2020 202e 6d69 6e5f 7374 6570         .min_step
-00094db0: 203d 2031 652d 3230 662c 0a20 2020 2020   = 1e-20f,.     
-00094dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094dd0: 2020 202e 6d61 785f 7374 6570 203d 2031     .max_step = 1
-00094de0: 652b 3230 662c 0a0a 2020 2020 2020 2020  e+20f,..        
-00094df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00094e00: 2e6c 696e 6573 6561 7263 6820 3d20 4747  .linesearch = GG
-00094e10: 4d4c 5f4c 494e 4553 4541 5243 485f 4445  ML_LINESEARCH_DE
-00094e20: 4641 554c 542c 0a20 2020 2020 2020 2020  FAULT,.         
-00094e30: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00094e40: 2020 2020 2020 2020 2020 2020 2020 7d3b                };
-00094e50: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00094e60: 7265 616b 3b0a 2020 2020 7d0a 0a20 2020  reak;.    }..   
-00094e70: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-00094e80: 7d0a 0a47 474d 4c5f 4150 4920 766f 6964  }..GGML_API void
-00094e90: 2067 676d 6c5f 6f70 745f 696e 6974 280a   ggml_opt_init(.
-00094ea0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00094eb0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00094ec0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-00094ed0: 7420 6767 6d6c 5f6f 7074 5f63 6f6e 7465  t ggml_opt_conte
-00094ee0: 7874 202a 206f 7074 2c0a 2020 2020 2020  xt * opt,.      
-00094ef0: 2020 7374 7275 6374 2067 676d 6c5f 6f70    struct ggml_op
-00094f00: 745f 7061 7261 6d73 2070 6172 616d 732c  t_params params,
-00094f10: 0a20 2020 2020 2020 2069 6e74 3634 5f74  .        int64_t
-00094f20: 206e 7829 207b 0a20 2020 206f 7074 2d3e   nx) {.    opt->
-00094f30: 6374 7820 3d20 6374 783b 0a20 2020 206f  ctx = ctx;.    o
-00094f40: 7074 2d3e 7061 7261 6d73 203d 2070 6172  pt->params = par
-00094f50: 616d 733b 0a20 2020 206f 7074 2d3e 6974  ams;.    opt->it
-00094f60: 6572 203d 2030 3b0a 2020 2020 6f70 742d  er = 0;.    opt-
-00094f70: 3e6e 7820 3d20 6e78 3b0a 2020 2020 6f70  >nx = nx;.    op
-00094f80: 742d 3e6a 7573 745f 696e 6974 6961 6c69  t->just_initiali
-00094f90: 7a65 6420 3d20 7472 7565 3b0a 2020 2020  zed = true;.    
-00094fa0: 7377 6974 6368 2028 6f70 742d 3e70 6172  switch (opt->par
-00094fb0: 616d 732e 7479 7065 2920 7b0a 2020 2020  ams.type) {.    
-00094fc0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00094fd0: 545f 4144 414d 3a0a 2020 2020 2020 2020  T_ADAM:.        
-00094fe0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00094ff0: 2020 2020 2020 6f70 742d 3e61 6461 6d2e        opt->adam.
-00095000: 7820 203d 2067 676d 6c5f 6e65 775f 7465  x  = ggml_new_te
-00095010: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
-00095020: 4c5f 5459 5045 5f46 3332 2c20 6e78 293b  L_TYPE_F32, nx);
-00095030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00095040: 206f 7074 2d3e 6164 616d 2e67 3120 3d20   opt->adam.g1 = 
-00095050: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-00095060: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
-00095070: 455f 4633 322c 206e 7829 3b0a 2020 2020  E_F32, nx);.    
-00095080: 2020 2020 2020 2020 2020 2020 6f70 742d              opt-
-00095090: 3e61 6461 6d2e 6732 203d 2067 676d 6c5f  >adam.g2 = ggml_
-000950a0: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-000950b0: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-000950c0: 2c20 6e78 293b 0a20 2020 2020 2020 2020  , nx);.         
-000950d0: 2020 2020 2020 206f 7074 2d3e 6164 616d         opt->adam
-000950e0: 2e6d 2020 3d20 6767 6d6c 5f6e 6577 5f74  .m  = ggml_new_t
-000950f0: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
-00095100: 4d4c 5f54 5950 455f 4633 322c 206e 7829  ML_TYPE_F32, nx)
-00095110: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00095120: 2020 6f70 742d 3e61 6461 6d2e 7620 203d    opt->adam.v  =
-00095130: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-00095140: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
-00095150: 5045 5f46 3332 2c20 6e78 293b 0a20 2020  PE_F32, nx);.   
-00095160: 2020 2020 2020 2020 2020 2020 206f 7074               opt
-00095170: 2d3e 6164 616d 2e6d 6820 3d20 6767 6d6c  ->adam.mh = ggml
-00095180: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
-00095190: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
-000951a0: 322c 206e 7829 3b0a 2020 2020 2020 2020  2, nx);.        
-000951b0: 2020 2020 2020 2020 6f70 742d 3e61 6461          opt->ada
-000951c0: 6d2e 7668 203d 2067 676d 6c5f 6e65 775f  m.vh = ggml_new_
-000951d0: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-000951e0: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
-000951f0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00095200: 2020 206f 7074 2d3e 6164 616d 2e70 6620     opt->adam.pf 
-00095210: 3d20 7061 7261 6d73 2e70 6173 7420 3e20  = params.past > 
-00095220: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00095230: 2020 2020 2020 3f20 6767 6d6c 5f6e 6577        ? ggml_new
-00095240: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
-00095250: 4747 4d4c 5f54 5950 455f 4633 322c 2070  GGML_TYPE_F32, p
-00095260: 6172 616d 732e 7061 7374 290a 2020 2020  arams.past).    
-00095270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00095280: 3a20 4e55 4c4c 3b0a 2020 2020 2020 2020  : NULL;.        
-00095290: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
-000952a0: 5f7a 6572 6f28 6f70 742d 3e61 6461 6d2e  _zero(opt->adam.
-000952b0: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
-000952c0: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
-000952d0: 6f28 6f70 742d 3e61 6461 6d2e 6731 293b  o(opt->adam.g1);
+00094a00: 2020 202e 6d61 785f 6e6f 5f69 6d70 726f     .max_no_impro
+00094a10: 7665 6d65 6e74 203d 2031 3030 2c0a 0a20  vement = 100,.. 
+00094a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094a30: 2020 202e 7072 696e 745f 666f 7277 6172     .print_forwar
+00094a40: 645f 6772 6170 6820 203d 2074 7275 652c  d_graph  = true,
+00094a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00094a60: 2020 2020 202e 7072 696e 745f 6261 636b       .print_back
+00094a70: 7761 7264 5f67 7261 7068 203d 2074 7275  ward_graph = tru
+00094a80: 652c 0a0a 2020 2020 2020 2020 2020 2020  e,..            
+00094a90: 2020 2020 2020 2020 2e61 6461 6d20 3d20          .adam = 
+00094aa0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00094ab0: 2020 2020 2020 2020 2020 2e6e 5f69 7465            .n_ite
+00094ac0: 7220 3d20 3130 3030 302c 0a20 2020 2020  r = 10000,.     
+00094ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094ae0: 2020 202e 7363 6865 6420 203d 2031 2e30     .sched  = 1.0
+00094af0: 3030 662c 0a20 2020 2020 2020 2020 2020  00f,.           
+00094b00: 2020 2020 2020 2020 2020 2020 202e 6465               .de
+00094b10: 6361 7920 203d 2030 2e30 3031 662c 0a20  cay  = 0.001f,. 
+00094b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094b30: 2020 2020 2020 202e 616c 7068 6120 203d         .alpha  =
+00094b40: 2030 2e30 3031 662c 0a20 2020 2020 2020   0.001f,.       
+00094b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094b60: 202e 6265 7461 3120 203d 2030 2e39 662c   .beta1  = 0.9f,
+00094b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00094b80: 2020 2020 2020 2020 202e 6265 7461 3220           .beta2 
+00094b90: 203d 2030 2e39 3939 662c 0a20 2020 2020   = 0.999f,.     
+00094ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094bb0: 2020 202e 6570 7320 2020 203d 2031 652d     .eps    = 1e-
+00094bc0: 3866 2c0a 2020 2020 2020 2020 2020 2020  8f,.            
+00094bd0: 2020 2020 2020 2020 2020 2020 2e65 7073              .eps
+00094be0: 5f66 2020 3d20 3165 2d35 662c 0a20 2020  _f  = 1e-5f,.   
+00094bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094c00: 2020 2020 202e 6570 735f 6720 203d 2031       .eps_g  = 1
+00094c10: 652d 3366 2c0a 2020 2020 2020 2020 2020  e-3f,.          
+00094c20: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00094c30: 2020 2020 2020 2020 2020 2020 207d 3b0a               };.
+00094c40: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00094c50: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00094c60: 6520 4747 4d4c 5f4f 5054 5f4c 4246 4753  e GGML_OPT_LBFGS
+00094c70: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00094c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094c90: 7265 7375 6c74 203d 2028 7374 7275 6374  result = (struct
+00094ca0: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
+00094cb0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00094cc0: 2020 2020 2020 2020 2e74 7970 6520 2020          .type   
+00094cd0: 2020 203d 2047 474d 4c5f 4f50 545f 4c42     = GGML_OPT_LB
+00094ce0: 4647 532c 0a20 2020 2020 2020 2020 2020  FGS,.           
+00094cf0: 2020 2020 2020 2020 202e 6e5f 7468 7265           .n_thre
+00094d00: 6164 7320 3d20 312c 0a20 2020 2020 2020  ads = 1,.       
+00094d10: 2020 2020 2020 2020 2020 2020 202e 7061               .pa
+00094d20: 7374 2020 2020 2020 3d20 302c 0a20 2020  st      = 0,.   
+00094d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094d40: 202e 6465 6c74 6120 2020 2020 3d20 3165   .delta     = 1e
+00094d50: 2d35 662c 0a0a 2020 2020 2020 2020 2020  -5f,..          
+00094d60: 2020 2020 2020 2020 2020 2e6d 6178 5f6e            .max_n
+00094d70: 6f5f 696d 7072 6f76 656d 656e 7420 3d20  o_improvement = 
+00094d80: 302c 0a0a 2020 2020 2020 2020 2020 2020  0,..            
+00094d90: 2020 2020 2020 2020 2e70 7269 6e74 5f66          .print_f
+00094da0: 6f72 7761 7264 5f67 7261 7068 2020 3d20  orward_graph  = 
+00094db0: 7472 7565 2c0a 2020 2020 2020 2020 2020  true,.          
+00094dc0: 2020 2020 2020 2020 2020 2e70 7269 6e74            .print
+00094dd0: 5f62 6163 6b77 6172 645f 6772 6170 6820  _backward_graph 
+00094de0: 3d20 7472 7565 2c0a 0a20 2020 2020 2020  = true,..       
+00094df0: 2020 2020 2020 2020 2020 2020 202e 6c62               .lb
+00094e00: 6667 7320 3d20 7b0a 2020 2020 2020 2020  fgs = {.        
+00094e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094e20: 2e6d 2020 2020 2020 2020 2020 2020 2020  .m              
+00094e30: 3d20 362c 0a20 2020 2020 2020 2020 2020  = 6,.           
+00094e40: 2020 2020 2020 2020 2020 2020 202e 6e5f               .n_
+00094e50: 6974 6572 2020 2020 2020 2020 203d 2031  iter         = 1
+00094e60: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+00094e70: 2020 2020 2020 2020 2020 2020 2e6d 6178              .max
+00094e80: 5f6c 696e 6573 6561 7263 6820 3d20 3230  _linesearch = 20
+00094e90: 2c0a 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00094ea0: 2020 2020 2020 2020 2020 202e 6570 7320             .eps 
+00094eb0: 2020 2020 203d 2031 652d 3566 2c0a 2020       = 1e-5f,.  
+00094ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094ed0: 2020 2020 2020 2e66 746f 6c20 2020 2020        .ftol     
+00094ee0: 3d20 3165 2d34 662c 0a20 2020 2020 2020  = 1e-4f,.       
+00094ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094f00: 202e 776f 6c66 6520 2020 203d 2030 2e39   .wolfe    = 0.9
+00094f10: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
+00094f20: 2020 2020 2020 2020 2020 202e 6d69 6e5f             .min_
+00094f30: 7374 6570 203d 2031 652d 3230 662c 0a20  step = 1e-20f,. 
+00094f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094f50: 2020 2020 2020 202e 6d61 785f 7374 6570         .max_step
+00094f60: 203d 2031 652b 3230 662c 0a0a 2020 2020   = 1e+20f,..    
+00094f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094f80: 2020 2020 2e6c 696e 6573 6561 7263 6820      .linesearch 
+00094f90: 3d20 4747 4d4c 5f4c 494e 4553 4541 5243  = GGML_LINESEARC
+00094fa0: 485f 4445 4641 554c 542c 0a20 2020 2020  H_DEFAULT,.     
+00094fb0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00094fc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00094fd0: 2020 7d3b 0a20 2020 2020 2020 2020 2020    };.           
+00094fe0: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+00094ff0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+00095000: 6c74 3b0a 7d0a 0a47 474d 4c5f 4150 4920  lt;.}..GGML_API 
+00095010: 766f 6964 2067 676d 6c5f 6f70 745f 696e  void ggml_opt_in
+00095020: 6974 280a 2020 2020 2020 2020 7374 7275  it(.        stru
+00095030: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+00095040: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+00095050: 7472 7563 7420 6767 6d6c 5f6f 7074 5f63  truct ggml_opt_c
+00095060: 6f6e 7465 7874 202a 206f 7074 2c0a 2020  ontext * opt,.  
+00095070: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00095080: 6c5f 6f70 745f 7061 7261 6d73 2070 6172  l_opt_params par
+00095090: 616d 732c 0a20 2020 2020 2020 2069 6e74  ams,.        int
+000950a0: 3634 5f74 206e 7829 207b 0a20 2020 206f  64_t nx) {.    o
+000950b0: 7074 2d3e 6374 7820 3d20 6374 783b 0a20  pt->ctx = ctx;. 
+000950c0: 2020 206f 7074 2d3e 7061 7261 6d73 203d     opt->params =
+000950d0: 2070 6172 616d 733b 0a20 2020 206f 7074   params;.    opt
+000950e0: 2d3e 6974 6572 203d 2030 3b0a 2020 2020  ->iter = 0;.    
+000950f0: 6f70 742d 3e6e 7820 3d20 6e78 3b0a 2020  opt->nx = nx;.  
+00095100: 2020 6f70 742d 3e6a 7573 745f 696e 6974    opt->just_init
+00095110: 6961 6c69 7a65 6420 3d20 7472 7565 3b0a  ialized = true;.
+00095120: 2020 2020 7377 6974 6368 2028 6f70 742d      switch (opt-
+00095130: 3e70 6172 616d 732e 7479 7065 2920 7b0a  >params.type) {.
+00095140: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00095150: 4c5f 4f50 545f 4144 414d 3a0a 2020 2020  L_OPT_ADAM:.    
+00095160: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00095170: 2020 2020 2020 2020 2020 6f70 742d 3e61            opt->a
+00095180: 6461 6d2e 7820 203d 2067 676d 6c5f 6e65  dam.x  = ggml_ne
+00095190: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
+000951a0: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+000951b0: 6e78 293b 0a20 2020 2020 2020 2020 2020  nx);.           
+000951c0: 2020 2020 206f 7074 2d3e 6164 616d 2e67       opt->adam.g
+000951d0: 3120 3d20 6767 6d6c 5f6e 6577 5f74 656e  1 = ggml_new_ten
+000951e0: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+000951f0: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
+00095200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00095210: 6f70 742d 3e61 6461 6d2e 6732 203d 2067  opt->adam.g2 = g
+00095220: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
+00095230: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
+00095240: 5f46 3332 2c20 6e78 293b 0a20 2020 2020  _F32, nx);.     
+00095250: 2020 2020 2020 2020 2020 206f 7074 2d3e             opt->
+00095260: 6164 616d 2e6d 2020 3d20 6767 6d6c 5f6e  adam.m  = ggml_n
+00095270: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
+00095280: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
+00095290: 206e 7829 3b0a 2020 2020 2020 2020 2020   nx);.          
+000952a0: 2020 2020 2020 6f70 742d 3e61 6461 6d2e        opt->adam.
+000952b0: 7620 203d 2067 676d 6c5f 6e65 775f 7465  v  = ggml_new_te
+000952c0: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+000952d0: 4c5f 5459 5045 5f46 3332 2c20 6e78 293b  L_TYPE_F32, nx);
 000952e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000952f0: 2067 676d 6c5f 7365 745f 7a65 726f 286f   ggml_set_zero(o
-00095300: 7074 2d3e 6164 616d 2e67 3229 3b0a 2020  pt->adam.g2);.  
-00095310: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00095320: 6d6c 5f73 6574 5f7a 6572 6f28 6f70 742d  ml_set_zero(opt-
-00095330: 3e61 6461 6d2e 6d29 3b0a 2020 2020 2020  >adam.m);.      
-00095340: 2020 2020 2020 2020 2020 6767 6d6c 5f73            ggml_s
-00095350: 6574 5f7a 6572 6f28 6f70 742d 3e61 6461  et_zero(opt->ada
-00095360: 6d2e 7629 3b0a 2020 2020 2020 2020 2020  m.v);.          
-00095370: 2020 2020 2020 6767 6d6c 5f73 6574 5f7a        ggml_set_z
-00095380: 6572 6f28 6f70 742d 3e61 6461 6d2e 6d68  ero(opt->adam.mh
-00095390: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000953a0: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
-000953b0: 286f 7074 2d3e 6164 616d 2e76 6829 3b0a  (opt->adam.vh);.
-000953c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000953d0: 6966 2028 6f70 742d 3e61 6461 6d2e 7066  if (opt->adam.pf
-000953e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000953f0: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
-00095400: 5f7a 6572 6f28 6f70 742d 3e61 6461 6d2e  _zero(opt->adam.
-00095410: 7066 293b 0a20 2020 2020 2020 2020 2020  pf);.           
-00095420: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00095430: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00095440: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00095450: 545f 4c42 4647 533a 0a20 2020 2020 2020  T_LBFGS:.       
-00095460: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00095470: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
-00095480: 732e 7820 203d 2067 676d 6c5f 6e65 775f  s.x  = ggml_new_
-00095490: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-000954a0: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
-000954b0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000954c0: 2020 206f 7074 2d3e 6c62 6667 732e 7870     opt->lbfgs.xp
-000954d0: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
-000954e0: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
-000954f0: 5459 5045 5f46 3332 2c20 6e78 293b 0a20  TYPE_F32, nx);. 
-00095500: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00095510: 7074 2d3e 6c62 6667 732e 6720 203d 2067  pt->lbfgs.g  = g
-00095520: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
-00095530: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
-00095540: 5f46 3332 2c20 6e78 293b 0a20 2020 2020  _F32, nx);.     
-00095550: 2020 2020 2020 2020 2020 206f 7074 2d3e             opt->
-00095560: 6c62 6667 732e 6770 203d 2067 676d 6c5f  lbfgs.gp = ggml_
-00095570: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-00095580: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-00095590: 2c20 6e78 293b 0a20 2020 2020 2020 2020  , nx);.         
-000955a0: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
-000955b0: 732e 6420 203d 2067 676d 6c5f 6e65 775f  s.d  = ggml_new_
-000955c0: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-000955d0: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
-000955e0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000955f0: 2020 206f 7074 2d3e 6c62 6667 732e 7066     opt->lbfgs.pf
-00095600: 203d 2070 6172 616d 732e 7061 7374 203e   = params.past >
-00095610: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00095620: 2020 2020 2020 203f 2067 676d 6c5f 6e65         ? ggml_ne
-00095630: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-00095640: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
-00095650: 7061 7261 6d73 2e70 6173 7429 0a20 2020  params.past).   
-00095660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00095670: 203a 204e 554c 4c3b 0a20 2020 2020 2020   : NULL;.       
-00095680: 2020 2020 2020 2020 206f 7074 2d3e 6c62           opt->lb
-00095690: 6667 732e 6c6d 616c 203d 2067 676d 6c5f  fgs.lmal = ggml_
-000956a0: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-000956b0: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-000956c0: 2c20 7061 7261 6d73 2e6c 6266 6773 2e6d  , params.lbfgs.m
-000956d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000956e0: 2020 206f 7074 2d3e 6c62 6667 732e 6c6d     opt->lbfgs.lm
-000956f0: 7973 203d 2067 676d 6c5f 6e65 775f 7465  ys = ggml_new_te
-00095700: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
-00095710: 4c5f 5459 5045 5f46 3332 2c20 7061 7261  L_TYPE_F32, para
-00095720: 6d73 2e6c 6266 6773 2e6d 293b 0a20 2020  ms.lbfgs.m);.   
-00095730: 2020 2020 2020 2020 2020 2020 206f 7074               opt
-00095740: 2d3e 6c62 6667 732e 6c6d 7320 203d 2067  ->lbfgs.lms  = g
-00095750: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f32  gml_new_tensor_2
-00095760: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
-00095770: 5f46 3332 2c20 6e78 2c20 7061 7261 6d73  _F32, nx, params
-00095780: 2e6c 6266 6773 2e6d 293b 0a20 2020 2020  .lbfgs.m);.     
-00095790: 2020 2020 2020 2020 2020 206f 7074 2d3e             opt->
-000957a0: 6c62 6667 732e 6c6d 7920 203d 2067 676d  lbfgs.lmy  = ggm
-000957b0: 6c5f 6e65 775f 7465 6e73 6f72 5f32 6428  l_new_tensor_2d(
+000952f0: 206f 7074 2d3e 6164 616d 2e6d 6820 3d20   opt->adam.mh = 
+00095300: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
+00095310: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
+00095320: 455f 4633 322c 206e 7829 3b0a 2020 2020  E_F32, nx);.    
+00095330: 2020 2020 2020 2020 2020 2020 6f70 742d              opt-
+00095340: 3e61 6461 6d2e 7668 203d 2067 676d 6c5f  >adam.vh = ggml_
+00095350: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+00095360: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
+00095370: 2c20 6e78 293b 0a20 2020 2020 2020 2020  , nx);.         
+00095380: 2020 2020 2020 206f 7074 2d3e 6164 616d         opt->adam
+00095390: 2e70 6620 3d20 7061 7261 6d73 2e70 6173  .pf = params.pas
+000953a0: 7420 3e20 300a 2020 2020 2020 2020 2020  t > 0.          
+000953b0: 2020 2020 2020 2020 2020 3f20 6767 6d6c            ? ggml
+000953c0: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
+000953d0: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
+000953e0: 322c 2070 6172 616d 732e 7061 7374 290a  2, params.past).
+000953f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00095400: 2020 2020 3a20 4e55 4c4c 3b0a 2020 2020      : NULL;.    
+00095410: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00095420: 5f73 6574 5f7a 6572 6f28 6f70 742d 3e61  _set_zero(opt->a
+00095430: 6461 6d2e 7829 3b0a 2020 2020 2020 2020  dam.x);.        
+00095440: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
+00095450: 5f7a 6572 6f28 6f70 742d 3e61 6461 6d2e  _zero(opt->adam.
+00095460: 6731 293b 0a20 2020 2020 2020 2020 2020  g1);.           
+00095470: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
+00095480: 726f 286f 7074 2d3e 6164 616d 2e67 3229  ro(opt->adam.g2)
+00095490: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000954a0: 2020 6767 6d6c 5f73 6574 5f7a 6572 6f28    ggml_set_zero(
+000954b0: 6f70 742d 3e61 6461 6d2e 6d29 3b0a 2020  opt->adam.m);.  
+000954c0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000954d0: 6d6c 5f73 6574 5f7a 6572 6f28 6f70 742d  ml_set_zero(opt-
+000954e0: 3e61 6461 6d2e 7629 3b0a 2020 2020 2020  >adam.v);.      
+000954f0: 2020 2020 2020 2020 2020 6767 6d6c 5f73            ggml_s
+00095500: 6574 5f7a 6572 6f28 6f70 742d 3e61 6461  et_zero(opt->ada
+00095510: 6d2e 6d68 293b 0a20 2020 2020 2020 2020  m.mh);.         
+00095520: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
+00095530: 7a65 726f 286f 7074 2d3e 6164 616d 2e76  zero(opt->adam.v
+00095540: 6829 3b0a 2020 2020 2020 2020 2020 2020  h);.            
+00095550: 2020 2020 6966 2028 6f70 742d 3e61 6461      if (opt->ada
+00095560: 6d2e 7066 2920 7b0a 2020 2020 2020 2020  m.pf) {.        
+00095570: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00095580: 5f73 6574 5f7a 6572 6f28 6f70 742d 3e61  _set_zero(opt->a
+00095590: 6461 6d2e 7066 293b 0a20 2020 2020 2020  dam.pf);.       
+000955a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000955b0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000955c0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000955d0: 4c5f 4f50 545f 4c42 4647 533a 0a20 2020  L_OPT_LBFGS:.   
+000955e0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000955f0: 2020 2020 2020 2020 2020 206f 7074 2d3e             opt->
+00095600: 6c62 6667 732e 7820 203d 2067 676d 6c5f  lbfgs.x  = ggml_
+00095610: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+00095620: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
+00095630: 2c20 6e78 293b 0a20 2020 2020 2020 2020  , nx);.         
+00095640: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
+00095650: 732e 7870 203d 2067 676d 6c5f 6e65 775f  s.xp = ggml_new_
+00095660: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
+00095670: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
+00095680: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00095690: 2020 206f 7074 2d3e 6c62 6667 732e 6720     opt->lbfgs.g 
+000956a0: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+000956b0: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+000956c0: 5459 5045 5f46 3332 2c20 6e78 293b 0a20  TYPE_F32, nx);. 
+000956d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000956e0: 7074 2d3e 6c62 6667 732e 6770 203d 2067  pt->lbfgs.gp = g
+000956f0: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
+00095700: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
+00095710: 5f46 3332 2c20 6e78 293b 0a20 2020 2020  _F32, nx);.     
+00095720: 2020 2020 2020 2020 2020 206f 7074 2d3e             opt->
+00095730: 6c62 6667 732e 6420 203d 2067 676d 6c5f  lbfgs.d  = ggml_
+00095740: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+00095750: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
+00095760: 2c20 6e78 293b 0a20 2020 2020 2020 2020  , nx);.         
+00095770: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
+00095780: 732e 7066 203d 2070 6172 616d 732e 7061  s.pf = params.pa
+00095790: 7374 203e 2030 0a20 2020 2020 2020 2020  st > 0.         
+000957a0: 2020 2020 2020 2020 2020 203f 2067 676d             ? ggm
+000957b0: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
 000957c0: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
-000957d0: 3332 2c20 6e78 2c20 7061 7261 6d73 2e6c  32, nx, params.l
-000957e0: 6266 6773 2e6d 293b 0a20 2020 2020 2020  bfgs.m);.       
-000957f0: 2020 2020 2020 2020 2067 676d 6c5f 7365           ggml_se
-00095800: 745f 7a65 726f 286f 7074 2d3e 6c62 6667  t_zero(opt->lbfg
-00095810: 732e 7829 3b0a 2020 2020 2020 2020 2020  s.x);.          
-00095820: 2020 2020 2020 6767 6d6c 5f73 6574 5f7a        ggml_set_z
-00095830: 6572 6f28 6f70 742d 3e6c 6266 6773 2e78  ero(opt->lbfgs.x
-00095840: 7029 3b0a 2020 2020 2020 2020 2020 2020  p);.            
-00095850: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
-00095860: 6f28 6f70 742d 3e6c 6266 6773 2e67 293b  o(opt->lbfgs.g);
-00095870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00095880: 2067 676d 6c5f 7365 745f 7a65 726f 286f   ggml_set_zero(o
-00095890: 7074 2d3e 6c62 6667 732e 6770 293b 0a20  pt->lbfgs.gp);. 
-000958a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000958b0: 676d 6c5f 7365 745f 7a65 726f 286f 7074  gml_set_zero(opt
-000958c0: 2d3e 6c62 6667 732e 6429 3b0a 2020 2020  ->lbfgs.d);.    
-000958d0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000958e0: 6f70 742d 3e6c 6266 6773 2e70 6629 207b  opt->lbfgs.pf) {
-000958f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00095900: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
-00095910: 726f 286f 7074 2d3e 6c62 6667 732e 7066  ro(opt->lbfgs.pf
-00095920: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00095930: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00095940: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
-00095950: 726f 286f 7074 2d3e 6c62 6667 732e 6c6d  ro(opt->lbfgs.lm
-00095960: 616c 293b 0a20 2020 2020 2020 2020 2020  al);.           
-00095970: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
-00095980: 726f 286f 7074 2d3e 6c62 6667 732e 6c6d  ro(opt->lbfgs.lm
-00095990: 7973 293b 0a20 2020 2020 2020 2020 2020  ys);.           
-000959a0: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
-000959b0: 726f 286f 7074 2d3e 6c62 6667 732e 6c6d  ro(opt->lbfgs.lm
-000959c0: 7329 3b0a 2020 2020 2020 2020 2020 2020  s);.            
-000959d0: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
-000959e0: 6f28 6f70 742d 3e6c 6266 6773 2e6c 6d79  o(opt->lbfgs.lmy
-000959f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00095a00: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-00095a10: 0a65 6e75 6d20 6767 6d6c 5f6f 7074 5f72  .enum ggml_opt_r
-00095a20: 6573 756c 7420 6767 6d6c 5f6f 7074 280a  esult ggml_opt(.
-00095a30: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00095a40: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00095a50: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-00095a60: 7420 6767 6d6c 5f6f 7074 5f70 6172 616d  t ggml_opt_param
-00095a70: 7320 7061 7261 6d73 2c0a 2020 2020 2020  s params,.      
-00095a80: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00095a90: 6e73 6f72 202a 2066 2920 7b0a 2020 2020  nsor * f) {.    
-00095aa0: 626f 6f6c 2066 7265 655f 6374 7820 3d20  bool free_ctx = 
-00095ab0: 6661 6c73 653b 0a20 2020 2069 6620 2863  false;.    if (c
-00095ac0: 7478 203d 3d20 4e55 4c4c 2920 7b0a 2020  tx == NULL) {.  
-00095ad0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00095ae0: 6c5f 696e 6974 5f70 6172 616d 7320 7061  l_init_params pa
-00095af0: 7261 6d73 5f63 7478 203d 207b 0a20 2020  rams_ctx = {.   
-00095b00: 2020 2020 2020 2020 202e 6d65 6d5f 7369           .mem_si
-00095b10: 7a65 2020 203d 2031 362a 3130 3234 2a31  ze   = 16*1024*1
-00095b20: 3032 342c 0a20 2020 2020 2020 2020 2020  024,.           
-00095b30: 202e 6d65 6d5f 6275 6666 6572 203d 204e   .mem_buffer = N
-00095b40: 554c 4c2c 0a20 2020 2020 2020 2020 2020  ULL,.           
-00095b50: 202e 6e6f 5f61 6c6c 6f63 2020 203d 2066   .no_alloc   = f
-00095b60: 616c 7365 2c0a 2020 2020 2020 2020 7d3b  alse,.        };
-00095b70: 0a0a 2020 2020 2020 2020 6374 7820 3d20  ..        ctx = 
-00095b80: 6767 6d6c 5f69 6e69 7428 7061 7261 6d73  ggml_init(params
-00095b90: 5f63 7478 293b 0a20 2020 2020 2020 2069  _ctx);.        i
-00095ba0: 6620 2863 7478 203d 3d20 4e55 4c4c 2920  f (ctx == NULL) 
-00095bb0: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
-00095bc0: 7475 726e 2047 474d 4c5f 4f50 545f 4e4f  turn GGML_OPT_NO
-00095bd0: 5f43 4f4e 5445 5854 3b0a 2020 2020 2020  _CONTEXT;.      
-00095be0: 2020 7d0a 0a20 2020 2020 2020 2066 7265    }..        fre
-00095bf0: 655f 6374 7820 3d20 7472 7565 3b0a 2020  e_ctx = true;.  
-00095c00: 2020 7d0a 0a20 2020 2065 6e75 6d20 6767    }..    enum gg
-00095c10: 6d6c 5f6f 7074 5f72 6573 756c 7420 7265  ml_opt_result re
-00095c20: 7375 6c74 203d 2047 474d 4c5f 4f50 545f  sult = GGML_OPT_
-00095c30: 4f4b 3b0a 0a20 2020 2073 7472 7563 7420  OK;..    struct 
-00095c40: 6767 6d6c 5f6f 7074 5f63 6f6e 7465 7874  ggml_opt_context
-00095c50: 202a 206f 7074 203d 2028 7374 7275 6374   * opt = (struct
-00095c60: 2067 676d 6c5f 6f70 745f 636f 6e74 6578   ggml_opt_contex
-00095c70: 7420 2a29 2061 6c6c 6f63 6128 7369 7a65  t *) alloca(size
-00095c80: 6f66 2873 7472 7563 7420 6767 6d6c 5f6f  of(struct ggml_o
-00095c90: 7074 5f63 6f6e 7465 7874 2929 3b0a 0a20  pt_context));.. 
-00095ca0: 2020 2067 676d 6c5f 6f70 745f 696e 6974     ggml_opt_init
-00095cb0: 2863 7478 2c20 6f70 742c 2070 6172 616d  (ctx, opt, param
-00095cc0: 732c 2030 293b 0a20 2020 2072 6573 756c  s, 0);.    resul
-00095cd0: 7420 3d20 6767 6d6c 5f6f 7074 5f72 6573  t = ggml_opt_res
-00095ce0: 756d 6528 6374 782c 206f 7074 2c20 6629  ume(ctx, opt, f)
-00095cf0: 3b0a 0a20 2020 2069 6620 2866 7265 655f  ;..    if (free_
-00095d00: 6374 7829 207b 0a20 2020 2020 2020 2067  ctx) {.        g
-00095d10: 676d 6c5f 6672 6565 2863 7478 293b 0a20  gml_free(ctx);. 
-00095d20: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
-00095d30: 2072 6573 756c 743b 0a7d 0a0a 656e 756d   result;.}..enum
-00095d40: 2067 676d 6c5f 6f70 745f 7265 7375 6c74   ggml_opt_result
-00095d50: 2067 676d 6c5f 6f70 745f 7265 7375 6d65   ggml_opt_resume
-00095d60: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-00095d70: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00095d80: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-00095d90: 7563 7420 6767 6d6c 5f6f 7074 5f63 6f6e  uct ggml_opt_con
-00095da0: 7465 7874 202a 206f 7074 2c0a 2020 2020  text * opt,.    
-00095db0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00095dc0: 7465 6e73 6f72 202a 2066 2920 7b0a 0a20  tensor * f) {.. 
-00095dd0: 2020 202f 2f20 6275 696c 6420 666f 7277     // build forw
-00095de0: 6172 6420 2b20 6261 636b 7761 7264 2063  ard + backward c
-00095df0: 6f6d 7075 7465 2067 7261 7068 730a 2020  ompute graphs.  
-00095e00: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00095e10: 6e73 6f72 202a 2067 6662 7566 203d 2067  nsor * gfbuf = g
-00095e20: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
-00095e30: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
-00095e40: 5f49 3332 2c20 7369 7a65 6f66 2873 7472  _I32, sizeof(str
-00095e50: 7563 7420 6767 6d6c 5f63 6772 6170 6829  uct ggml_cgraph)
-00095e60: 202f 2047 474d 4c5f 5459 5045 5f53 495a   / GGML_TYPE_SIZ
-00095e70: 455b 4747 4d4c 5f54 5950 455f 4933 325d  E[GGML_TYPE_I32]
-00095e80: 2b20 2873 697a 656f 6628 7374 7275 6374  + (sizeof(struct
-00095e90: 2067 676d 6c5f 6367 7261 7068 2920 2520   ggml_cgraph) % 
-00095ea0: 4747 4d4c 5f54 5950 455f 5349 5a45 5b47  GGML_TYPE_SIZE[G
-00095eb0: 474d 4c5f 5459 5045 5f49 3332 5d20 3f20  GML_TYPE_I32] ? 
-00095ec0: 3120 3a20 3029 293b 0a20 2020 2073 7472  1 : 0));.    str
-00095ed0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00095ee0: 2a20 6762 6275 6620 3d20 6767 6d6c 5f6e  * gbbuf = ggml_n
-00095ef0: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-00095f00: 2c20 4747 4d4c 5f54 5950 455f 4933 322c  , GGML_TYPE_I32,
-00095f10: 2073 697a 656f 6628 7374 7275 6374 2067   sizeof(struct g
-00095f20: 676d 6c5f 6367 7261 7068 2920 2f20 4747  gml_cgraph) / GG
-00095f30: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
-00095f40: 4c5f 5459 5045 5f49 3332 5d2b 2028 7369  L_TYPE_I32]+ (si
-00095f50: 7a65 6f66 2873 7472 7563 7420 6767 6d6c  zeof(struct ggml
-00095f60: 5f63 6772 6170 6829 2025 2047 474d 4c5f  _cgraph) % GGML_
-00095f70: 5459 5045 5f53 495a 455b 4747 4d4c 5f54  TYPE_SIZE[GGML_T
-00095f80: 5950 455f 4933 325d 203f 2031 203a 2030  YPE_I32] ? 1 : 0
-00095f90: 2929 3b0a 0a20 2020 2073 7472 7563 7420  ));..    struct 
-00095fa0: 6767 6d6c 5f63 6772 6170 6820 2a20 6766  ggml_cgraph * gf
-00095fb0: 203d 2028 7374 7275 6374 2067 676d 6c5f   = (struct ggml_
-00095fc0: 6367 7261 7068 202a 2920 6766 6275 662d  cgraph *) gfbuf-
-00095fd0: 3e64 6174 613b 0a20 2020 2073 7472 7563  >data;.    struc
-00095fe0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-00095ff0: 6762 203d 2028 7374 7275 6374 2067 676d  gb = (struct ggm
-00096000: 6c5f 6367 7261 7068 202a 2920 6762 6275  l_cgraph *) gbbu
-00096010: 662d 3e64 6174 613b 0a0a 2020 2020 2a67  f->data;..    *g
-00096020: 6620 3d20 6767 6d6c 5f62 7569 6c64 5f66  f = ggml_build_f
-00096030: 6f72 7761 7264 2028 6629 3b0a 2020 2020  orward (f);.    
-00096040: 2a67 6220 3d20 6767 6d6c 5f62 7569 6c64  *gb = ggml_build
-00096050: 5f62 6163 6b77 6172 6428 6374 782c 2067  _backward(ctx, g
-00096060: 662c 2074 7275 6529 3b0a 0a20 2020 2072  f, true);..    r
-00096070: 6574 7572 6e20 6767 6d6c 5f6f 7074 5f72  eturn ggml_opt_r
-00096080: 6573 756d 655f 6728 6374 782c 206f 7074  esume_g(ctx, opt
-00096090: 2c20 662c 2067 662c 2067 6229 3b0a 7d0a  , f, gf, gb);.}.
-000960a0: 0a65 6e75 6d20 6767 6d6c 5f6f 7074 5f72  .enum ggml_opt_r
-000960b0: 6573 756c 7420 6767 6d6c 5f6f 7074 5f72  esult ggml_opt_r
-000960c0: 6573 756d 655f 6728 0a20 2020 2020 2020  esume_g(.       
-000960d0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-000960e0: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-000960f0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00096100: 6f70 745f 636f 6e74 6578 7420 2a20 6f70  opt_context * op
-00096110: 742c 0a20 2020 2020 2020 2073 7472 7563  t,.        struc
-00096120: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00096130: 662c 0a20 2020 2020 2020 2073 7472 7563  f,.        struc
-00096140: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-00096150: 6766 2c0a 2020 2020 2020 2020 7374 7275  gf,.        stru
-00096160: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
-00096170: 2067 6229 207b 0a0a 2020 2020 2f2f 2062   gb) {..    // b
-00096180: 7569 6c64 2066 6f72 7761 7264 202b 2062  uild forward + b
-00096190: 6163 6b77 6172 6420 636f 6d70 7574 6520  ackward compute 
-000961a0: 6772 6170 6873 0a20 2020 2065 6e75 6d20  graphs.    enum 
-000961b0: 6767 6d6c 5f6f 7074 5f72 6573 756c 7420  ggml_opt_result 
-000961c0: 7265 7375 6c74 203d 2047 474d 4c5f 4f50  result = GGML_OP
-000961d0: 545f 4f4b 3b0a 0a20 2020 2073 7769 7463  T_OK;..    switc
-000961e0: 6820 286f 7074 2d3e 7061 7261 6d73 2e74  h (opt->params.t
-000961f0: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-00096200: 6173 6520 4747 4d4c 5f4f 5054 5f41 4441  ase GGML_OPT_ADA
-00096210: 4d3a 0a20 2020 2020 2020 2020 2020 207b  M:.            {
-00096220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00096230: 2072 6573 756c 7420 3d20 6767 6d6c 5f6f   result = ggml_o
-00096240: 7074 5f61 6461 6d28 6374 782c 206f 7074  pt_adam(ctx, opt
-00096250: 2c20 6f70 742d 3e70 6172 616d 732c 2066  , opt->params, f
-00096260: 2c20 6766 2c20 6762 293b 0a20 2020 2020  , gf, gb);.     
-00096270: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00096280: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00096290: 4c5f 4f50 545f 4c42 4647 533a 0a20 2020  L_OPT_LBFGS:.   
-000962a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000962b0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-000962c0: 7420 3d20 6767 6d6c 5f6f 7074 5f6c 6266  t = ggml_opt_lbf
-000962d0: 6773 2863 7478 2c20 6f70 742c 206f 7074  gs(ctx, opt, opt
-000962e0: 2d3e 7061 7261 6d73 2c20 662c 2067 662c  ->params, f, gf,
-000962f0: 2067 6229 3b0a 2020 2020 2020 2020 2020   gb);.          
-00096300: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
-00096310: 0a0a 2020 2020 6966 2028 6f70 742d 3e70  ..    if (opt->p
-00096320: 6172 616d 732e 7072 696e 745f 666f 7277  arams.print_forw
-00096330: 6172 645f 6772 6170 6829 207b 0a20 2020  ard_graph) {.   
-00096340: 2020 2020 2067 676d 6c5f 6772 6170 685f       ggml_graph_
-00096350: 7072 696e 7420 2020 2867 6629 3b0a 2020  print   (gf);.  
-00096360: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-00096370: 5f64 756d 705f 646f 7428 6766 2c20 4e55  _dump_dot(gf, NU
-00096380: 4c4c 2c20 226f 7074 2d66 6f72 7761 7264  LL, "opt-forward
-00096390: 2e64 6f74 2229 3b0a 2020 2020 7d0a 0a20  .dot");.    }.. 
-000963a0: 2020 2069 6620 286f 7074 2d3e 7061 7261     if (opt->para
-000963b0: 6d73 2e70 7269 6e74 5f62 6163 6b77 6172  ms.print_backwar
-000963c0: 645f 6772 6170 6829 207b 0a20 2020 2020  d_graph) {.     
-000963d0: 2020 2067 676d 6c5f 6772 6170 685f 7072     ggml_graph_pr
-000963e0: 696e 7420 2020 2867 6229 3b0a 2020 2020  int   (gb);.    
-000963f0: 2020 2020 6767 6d6c 5f67 7261 7068 5f64      ggml_graph_d
-00096400: 756d 705f 646f 7428 6762 2c20 6766 2c20  ump_dot(gb, gf, 
-00096410: 226f 7074 2d62 6163 6b77 6172 642e 646f  "opt-backward.do
-00096420: 7422 293b 0a20 2020 207d 0a0a 2020 2020  t");.    }..    
-00096430: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-00096440: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
-00096450: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00096460: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00096470: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00096480: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00096490: 2f2f 0a0a 7369 7a65 5f74 2067 676d 6c5f  //..size_t ggml_
-000964a0: 7175 616e 7469 7a65 5f71 345f 3028 636f  quantize_q4_0(co
-000964b0: 6e73 7420 666c 6f61 7420 2a20 7372 632c  nst float * src,
-000964c0: 2076 6f69 6420 2a20 6473 742c 2069 6e74   void * dst, int
-000964d0: 206e 2c20 696e 7420 6b2c 2069 6e74 3634   n, int k, int64
-000964e0: 5f74 202a 2068 6973 7429 207b 0a20 2020  _t * hist) {.   
-000964f0: 2061 7373 6572 7428 6b20 2520 514b 345f   assert(k % QK4_
-00096500: 3020 3d3d 2030 293b 0a20 2020 2063 6f6e  0 == 0);.    con
-00096510: 7374 2069 6e74 206e 6220 3d20 6b20 2f20  st int nb = k / 
-00096520: 514b 345f 303b 0a0a 2020 2020 666f 7220  QK4_0;..    for 
-00096530: 2869 6e74 2062 203d 2030 3b20 6220 3c20  (int b = 0; b < 
-00096540: 6e3b 2062 202b 3d20 6b29 207b 0a20 2020  n; b += k) {.   
-00096550: 2020 2020 2062 6c6f 636b 5f71 345f 3020       block_q4_0 
-00096560: 2a20 7265 7374 7269 6374 2079 203d 2028  * restrict y = (
-00096570: 626c 6f63 6b5f 7134 5f30 202a 2920 6473  block_q4_0 *) ds
-00096580: 7420 2b20 622f 514b 345f 303b 0a0a 2020  t + b/QK4_0;..  
-00096590: 2020 2020 2020 7175 616e 7469 7a65 5f72        quantize_r
-000965a0: 6f77 5f71 345f 305f 7265 6665 7265 6e63  ow_q4_0_referenc
-000965b0: 6528 7372 6320 2b20 622c 2079 2c20 6b29  e(src + b, y, k)
-000965c0: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
-000965d0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-000965e0: 623b 2069 2b2b 2920 7b0a 2020 2020 2020  b; i++) {.      
-000965f0: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-00096600: 203d 2030 3b20 6a20 3c20 514b 345f 303b   = 0; j < QK4_0;
-00096610: 206a 202b 3d20 3229 207b 0a20 2020 2020   j += 2) {.     
-00096620: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00096630: 2075 696e 7438 5f74 2076 6930 203d 2079   uint8_t vi0 = y
-00096640: 5b69 5d2e 7173 5b6a 2f32 5d20 2620 3078  [i].qs[j/2] & 0x
-00096650: 3046 3b0a 2020 2020 2020 2020 2020 2020  0F;.            
-00096660: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
-00096670: 7420 7669 3120 3d20 795b 695d 2e71 735b  t vi1 = y[i].qs[
-00096680: 6a2f 325d 203e 3e20 343b 0a0a 2020 2020  j/2] >> 4;..    
-00096690: 2020 2020 2020 2020 2020 2020 6869 7374              hist
-000966a0: 5b76 6930 5d2b 2b3b 0a20 2020 2020 2020  [vi0]++;.       
-000966b0: 2020 2020 2020 2020 2068 6973 745b 7669           hist[vi
-000966c0: 315d 2b2b 3b0a 2020 2020 2020 2020 2020  1]++;.          
-000966d0: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-000966e0: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-000966f0: 286e 2f51 4b34 5f30 2a73 697a 656f 6628  (n/QK4_0*sizeof(
-00096700: 626c 6f63 6b5f 7134 5f30 2929 3b0a 7d0a  block_q4_0));.}.
-00096710: 0a73 697a 655f 7420 6767 6d6c 5f71 7561  .size_t ggml_qua
-00096720: 6e74 697a 655f 7134 5f31 2863 6f6e 7374  ntize_q4_1(const
-00096730: 2066 6c6f 6174 202a 2073 7263 2c20 766f   float * src, vo
-00096740: 6964 202a 2064 7374 2c20 696e 7420 6e2c  id * dst, int n,
-00096750: 2069 6e74 206b 2c20 696e 7436 345f 7420   int k, int64_t 
-00096760: 2a20 6869 7374 2920 7b0a 2020 2020 6173  * hist) {.    as
-00096770: 7365 7274 286b 2025 2051 4b34 5f31 203d  sert(k % QK4_1 =
-00096780: 3d20 3029 3b0a 2020 2020 636f 6e73 7420  = 0);.    const 
-00096790: 696e 7420 6e62 203d 206b 202f 2051 4b34  int nb = k / QK4
-000967a0: 5f31 3b0a 0a20 2020 2066 6f72 2028 696e  _1;..    for (in
-000967b0: 7420 6220 3d20 303b 2062 203c 206e 3b20  t b = 0; b < n; 
-000967c0: 6220 2b3d 206b 2920 7b0a 2020 2020 2020  b += k) {.      
-000967d0: 2020 626c 6f63 6b5f 7134 5f31 202a 2072    block_q4_1 * r
-000967e0: 6573 7472 6963 7420 7920 3d20 2862 6c6f  estrict y = (blo
-000967f0: 636b 5f71 345f 3120 2a29 2064 7374 202b  ck_q4_1 *) dst +
-00096800: 2062 2f51 4b34 5f31 3b0a 0a20 2020 2020   b/QK4_1;..     
-00096810: 2020 2071 7561 6e74 697a 655f 726f 775f     quantize_row_
-00096820: 7134 5f31 5f72 6566 6572 656e 6365 2873  q4_1_reference(s
-00096830: 7263 202b 2062 2c20 792c 206b 293b 0a0a  rc + b, y, k);..
-00096840: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00096850: 2069 203d 2030 3b20 6920 3c20 6e62 3b20   i = 0; i < nb; 
-00096860: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
-00096870: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-00096880: 303b 206a 203c 2051 4b34 5f31 3b20 6a20  0; j < QK4_1; j 
-00096890: 2b3d 2032 2920 7b0a 2020 2020 2020 2020  += 2) {.        
-000968a0: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-000968b0: 6e74 385f 7420 7669 3020 3d20 795b 695d  nt8_t vi0 = y[i]
-000968c0: 2e71 735b 6a2f 325d 2026 2030 7830 463b  .qs[j/2] & 0x0F;
-000968d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000968e0: 2063 6f6e 7374 2075 696e 7438 5f74 2076   const uint8_t v
-000968f0: 6931 203d 2079 5b69 5d2e 7173 5b6a 2f32  i1 = y[i].qs[j/2
-00096900: 5d20 3e3e 2034 3b0a 0a20 2020 2020 2020  ] >> 4;..       
-00096910: 2020 2020 2020 2020 2068 6973 745b 7669           hist[vi
-00096920: 305d 2b2b 3b0a 2020 2020 2020 2020 2020  0]++;.          
-00096930: 2020 2020 2020 6869 7374 5b76 6931 5d2b        hist[vi1]+
-00096940: 2b3b 0a20 2020 2020 2020 2020 2020 207d  +;.            }
-00096950: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-00096960: 0a0a 2020 2020 7265 7475 726e 2028 6e2f  ..    return (n/
-00096970: 514b 345f 312a 7369 7a65 6f66 2862 6c6f  QK4_1*sizeof(blo
-00096980: 636b 5f71 345f 3129 293b 0a7d 0a0a 7369  ck_q4_1));.}..si
-00096990: 7a65 5f74 2067 676d 6c5f 7175 616e 7469  ze_t ggml_quanti
-000969a0: 7a65 5f71 355f 3028 636f 6e73 7420 666c  ze_q5_0(const fl
-000969b0: 6f61 7420 2a20 7372 632c 2076 6f69 6420  oat * src, void 
-000969c0: 2a20 6473 742c 2069 6e74 206e 2c20 696e  * dst, int n, in
-000969d0: 7420 6b2c 2069 6e74 3634 5f74 202a 2068  t k, int64_t * h
-000969e0: 6973 7429 207b 0a20 2020 2061 7373 6572  ist) {.    asser
-000969f0: 7428 6b20 2520 514b 355f 3020 3d3d 2030  t(k % QK5_0 == 0
-00096a00: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
-00096a10: 206e 6220 3d20 6b20 2f20 514b 355f 303b   nb = k / QK5_0;
-00096a20: 0a0a 2020 2020 666f 7220 2869 6e74 2062  ..    for (int b
-00096a30: 203d 2030 3b20 6220 3c20 6e3b 2062 202b   = 0; b < n; b +
-00096a40: 3d20 6b29 207b 0a20 2020 2020 2020 2062  = k) {.        b
-00096a50: 6c6f 636b 5f71 355f 3020 2a20 7265 7374  lock_q5_0 * rest
-00096a60: 7269 6374 2079 203d 2028 626c 6f63 6b5f  rict y = (block_
-00096a70: 7135 5f30 202a 2964 7374 202b 2062 2f51  q5_0 *)dst + b/Q
-00096a80: 4b35 5f30 3b0a 0a20 2020 2020 2020 2071  K5_0;..        q
-00096a90: 7561 6e74 697a 655f 726f 775f 7135 5f30  uantize_row_q5_0
-00096aa0: 5f72 6566 6572 656e 6365 2873 7263 202b  _reference(src +
-00096ab0: 2062 2c20 792c 206b 293b 0a0a 2020 2020   b, y, k);..    
-00096ac0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00096ad0: 2030 3b20 6920 3c20 6e62 3b20 692b 2b29   0; i < nb; i++)
-00096ae0: 207b 0a20 2020 2020 2020 2020 2020 2075   {.            u
-00096af0: 696e 7433 325f 7420 7168 3b0a 2020 2020  int32_t qh;.    
-00096b00: 2020 2020 2020 2020 6d65 6d63 7079 2826          memcpy(&
-00096b10: 7168 2c20 2679 5b69 5d2e 7168 2c20 7369  qh, &y[i].qh, si
-00096b20: 7a65 6f66 2871 6829 293b 0a0a 2020 2020  zeof(qh));..    
-00096b30: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00096b40: 206a 203d 2030 3b20 6a20 3c20 514b 355f   j = 0; j < QK5_
-00096b50: 303b 206a 202b 3d20 3229 207b 0a20 2020  0; j += 2) {.   
-00096b60: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00096b70: 7374 2075 696e 7438 5f74 2076 6830 203d  st uint8_t vh0 =
-00096b80: 2028 2871 6820 2620 2831 7520 3c3c 2028   ((qh & (1u << (
-00096b90: 6a20 2b20 3020 2929 2920 3e3e 2028 6a20  j + 0 ))) >> (j 
-00096ba0: 2b20 3020 2929 203c 3c20 343b 0a20 2020  + 0 )) << 4;.   
-00096bb0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00096bc0: 7374 2075 696e 7438 5f74 2076 6831 203d  st uint8_t vh1 =
-00096bd0: 2028 2871 6820 2620 2831 7520 3c3c 2028   ((qh & (1u << (
-00096be0: 6a20 2b20 3136 2929 2920 3e3e 2028 6a20  j + 16))) >> (j 
-00096bf0: 2b20 3132 2929 3b0a 0a20 2020 2020 2020  + 12));..       
-00096c00: 2020 2020 2020 2020 202f 2f20 6361 7374           // cast
-00096c10: 2074 6f20 3136 2062 696e 730a 2020 2020   to 16 bins.    
-00096c20: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00096c30: 7420 7569 6e74 385f 7420 7669 3020 3d20  t uint8_t vi0 = 
-00096c40: 2828 795b 695d 2e71 735b 6a2f 325d 2026  ((y[i].qs[j/2] &
-00096c50: 2030 7830 4629 207c 2076 6830 2920 2f20   0x0F) | vh0) / 
-00096c60: 323b 0a20 2020 2020 2020 2020 2020 2020  2;.             
-00096c70: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
-00096c80: 2076 6931 203d 2028 2879 5b69 5d2e 7173   vi1 = ((y[i].qs
-00096c90: 5b6a 2f32 5d20 3e3e 2020 2034 2920 7c20  [j/2] >>   4) | 
-00096ca0: 7668 3129 202f 2032 3b0a 0a20 2020 2020  vh1) / 2;..     
-00096cb0: 2020 2020 2020 2020 2020 2068 6973 745b             hist[
-00096cc0: 7669 305d 2b2b 3b0a 2020 2020 2020 2020  vi0]++;.        
-00096cd0: 2020 2020 2020 2020 6869 7374 5b76 6931          hist[vi1
-00096ce0: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
-00096cf0: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
-00096d00: 207d 0a0a 2020 2020 7265 7475 726e 2028   }..    return (
-00096d10: 6e2f 514b 355f 302a 7369 7a65 6f66 2862  n/QK5_0*sizeof(b
-00096d20: 6c6f 636b 5f71 355f 3029 293b 0a7d 0a0a  lock_q5_0));.}..
-00096d30: 7369 7a65 5f74 2067 676d 6c5f 7175 616e  size_t ggml_quan
-00096d40: 7469 7a65 5f71 355f 3128 636f 6e73 7420  tize_q5_1(const 
-00096d50: 666c 6f61 7420 2a20 7372 632c 2076 6f69  float * src, voi
-00096d60: 6420 2a20 6473 742c 2069 6e74 206e 2c20  d * dst, int n, 
-00096d70: 696e 7420 6b2c 2069 6e74 3634 5f74 202a  int k, int64_t *
-00096d80: 2068 6973 7429 207b 0a20 2020 2061 7373   hist) {.    ass
-00096d90: 6572 7428 6b20 2520 514b 355f 3120 3d3d  ert(k % QK5_1 ==
-00096da0: 2030 293b 0a20 2020 2063 6f6e 7374 2069   0);.    const i
-00096db0: 6e74 206e 6220 3d20 6b20 2f20 514b 355f  nt nb = k / QK5_
-00096dc0: 313b 0a0a 2020 2020 666f 7220 2869 6e74  1;..    for (int
-00096dd0: 2062 203d 2030 3b20 6220 3c20 6e3b 2062   b = 0; b < n; b
-00096de0: 202b 3d20 6b29 207b 0a20 2020 2020 2020   += k) {.       
-00096df0: 2062 6c6f 636b 5f71 355f 3120 2a20 7265   block_q5_1 * re
-00096e00: 7374 7269 6374 2079 203d 2028 626c 6f63  strict y = (bloc
-00096e10: 6b5f 7135 5f31 202a 2964 7374 202b 2062  k_q5_1 *)dst + b
-00096e20: 2f51 4b35 5f31 3b0a 0a20 2020 2020 2020  /QK5_1;..       
-00096e30: 2071 7561 6e74 697a 655f 726f 775f 7135   quantize_row_q5
-00096e40: 5f31 5f72 6566 6572 656e 6365 2873 7263  _1_reference(src
-00096e50: 202b 2062 2c20 792c 206b 293b 0a0a 2020   + b, y, k);..  
-00096e60: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-00096e70: 203d 2030 3b20 6920 3c20 6e62 3b20 692b   = 0; i < nb; i+
-00096e80: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00096e90: 2075 696e 7433 325f 7420 7168 3b0a 2020   uint32_t qh;.  
-00096ea0: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
-00096eb0: 2826 7168 2c20 2679 5b69 5d2e 7168 2c20  (&qh, &y[i].qh, 
-00096ec0: 7369 7a65 6f66 2871 6829 293b 0a0a 2020  sizeof(qh));..  
-00096ed0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00096ee0: 6e74 206a 203d 2030 3b20 6a20 3c20 514b  nt j = 0; j < QK
-00096ef0: 355f 313b 206a 202b 3d20 3229 207b 0a20  5_1; j += 2) {. 
-00096f00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00096f10: 6f6e 7374 2075 696e 7438 5f74 2076 6830  onst uint8_t vh0
-00096f20: 203d 2028 2871 6820 2620 2831 7520 3c3c   = ((qh & (1u <<
-00096f30: 2028 6a20 2b20 3020 2929 2920 3e3e 2028   (j + 0 ))) >> (
-00096f40: 6a20 2b20 3020 2929 203c 3c20 343b 0a20  j + 0 )) << 4;. 
-00096f50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00096f60: 6f6e 7374 2075 696e 7438 5f74 2076 6831  onst uint8_t vh1
-00096f70: 203d 2028 2871 6820 2620 2831 7520 3c3c   = ((qh & (1u <<
-00096f80: 2028 6a20 2b20 3136 2929 2920 3e3e 2028   (j + 16))) >> (
-00096f90: 6a20 2b20 3132 2929 3b0a 0a20 2020 2020  j + 12));..     
-00096fa0: 2020 2020 2020 2020 2020 202f 2f20 6361             // ca
-00096fb0: 7374 2074 6f20 3136 2062 696e 730a 2020  st to 16 bins.  
-00096fc0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00096fd0: 6e73 7420 7569 6e74 385f 7420 7669 3020  nst uint8_t vi0 
-00096fe0: 3d20 2828 795b 695d 2e71 735b 6a2f 325d  = ((y[i].qs[j/2]
-00096ff0: 2026 2030 7830 4629 207c 2076 6830 2920   & 0x0F) | vh0) 
-00097000: 2f20 323b 0a20 2020 2020 2020 2020 2020  / 2;.           
-00097010: 2020 2020 2063 6f6e 7374 2075 696e 7438       const uint8
-00097020: 5f74 2076 6931 203d 2028 2879 5b69 5d2e  _t vi1 = ((y[i].
-00097030: 7173 5b6a 2f32 5d20 3e3e 2020 2034 2920  qs[j/2] >>   4) 
-00097040: 7c20 7668 3129 202f 2032 3b0a 0a20 2020  | vh1) / 2;..   
-00097050: 2020 2020 2020 2020 2020 2020 2068 6973               his
-00097060: 745b 7669 305d 2b2b 3b0a 2020 2020 2020  t[vi0]++;.      
-00097070: 2020 2020 2020 2020 2020 6869 7374 5b76            hist[v
-00097080: 6931 5d2b 2b3b 0a20 2020 2020 2020 2020  i1]++;.         
-00097090: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-000970a0: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
-000970b0: 2028 6e2f 514b 355f 312a 7369 7a65 6f66   (n/QK5_1*sizeof
-000970c0: 2862 6c6f 636b 5f71 355f 3129 293b 0a7d  (block_q5_1));.}
-000970d0: 0a0a 7369 7a65 5f74 2067 676d 6c5f 7175  ..size_t ggml_qu
-000970e0: 616e 7469 7a65 5f71 385f 3028 636f 6e73  antize_q8_0(cons
-000970f0: 7420 666c 6f61 7420 2a20 7372 632c 2076  t float * src, v
-00097100: 6f69 6420 2a20 6473 742c 2069 6e74 206e  oid * dst, int n
-00097110: 2c20 696e 7420 6b2c 2069 6e74 3634 5f74  , int k, int64_t
-00097120: 202a 2068 6973 7429 207b 0a20 2020 2061   * hist) {.    a
-00097130: 7373 6572 7428 6b20 2520 514b 385f 3020  ssert(k % QK8_0 
-00097140: 3d3d 2030 293b 0a20 2020 2063 6f6e 7374  == 0);.    const
-00097150: 2069 6e74 206e 6220 3d20 6b20 2f20 514b   int nb = k / QK
-00097160: 385f 303b 0a0a 2020 2020 666f 7220 2869  8_0;..    for (i
-00097170: 6e74 2062 203d 2030 3b20 6220 3c20 6e3b  nt b = 0; b < n;
-00097180: 2062 202b 3d20 6b29 207b 0a20 2020 2020   b += k) {.     
-00097190: 2020 2062 6c6f 636b 5f71 385f 3020 2a20     block_q8_0 * 
-000971a0: 7265 7374 7269 6374 2079 203d 2028 626c  restrict y = (bl
-000971b0: 6f63 6b5f 7138 5f30 202a 2964 7374 202b  ock_q8_0 *)dst +
-000971c0: 2062 2f51 4b38 5f30 3b0a 0a20 2020 2020   b/QK8_0;..     
-000971d0: 2020 2071 7561 6e74 697a 655f 726f 775f     quantize_row_
-000971e0: 7138 5f30 5f72 6566 6572 656e 6365 2873  q8_0_reference(s
-000971f0: 7263 202b 2062 2c20 792c 206b 293b 0a0a  rc + b, y, k);..
-00097200: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00097210: 2069 203d 2030 3b20 6920 3c20 6e62 3b20   i = 0; i < nb; 
-00097220: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
-00097230: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-00097240: 303b 206a 203c 2051 4b38 5f30 3b20 2b2b  0; j < QK8_0; ++
-00097250: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
-00097260: 2020 2020 2063 6f6e 7374 2069 6e74 385f       const int8_
-00097270: 7420 7669 203d 2079 5b69 5d2e 7173 5b6a  t vi = y[i].qs[j
-00097280: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
-00097290: 2020 2020 6869 7374 5b76 692f 3136 202b      hist[vi/16 +
-000972a0: 2038 5d2b 2b3b 0a20 2020 2020 2020 2020   8]++;.         
-000972b0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-000972c0: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
-000972d0: 2028 6e2f 514b 385f 302a 7369 7a65 6f66   (n/QK8_0*sizeof
-000972e0: 2862 6c6f 636b 5f71 385f 3029 293b 0a7d  (block_q8_0));.}
-000972f0: 0a0a 7369 7a65 5f74 2067 676d 6c5f 7175  ..size_t ggml_qu
-00097300: 616e 7469 7a65 5f63 6875 6e6b 2865 6e75  antize_chunk(enu
-00097310: 6d20 6767 6d6c 5f74 7970 6520 7479 7065  m ggml_type type
-00097320: 2c20 636f 6e73 7420 666c 6f61 7420 2a20  , const float * 
-00097330: 7372 632c 2076 6f69 6420 2a20 6473 742c  src, void * dst,
-00097340: 2069 6e74 2073 7461 7274 2c20 696e 7420   int start, int 
-00097350: 6e2c 2069 6e74 3634 5f74 202a 2068 6973  n, int64_t * his
-00097360: 7429 207b 0a20 2020 2073 697a 655f 7420  t) {.    size_t 
-00097370: 7265 7375 6c74 203d 2030 3b0a 2020 2020  result = 0;.    
-00097380: 7377 6974 6368 2028 7479 7065 2920 7b0a  switch (type) {.
-00097390: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000973a0: 4c5f 5459 5045 5f51 345f 303a 0a20 2020  L_TYPE_Q4_0:.   
-000973b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000973c0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-000973d0: 4153 5345 5254 2873 7461 7274 2025 2051  ASSERT(start % Q
-000973e0: 4b34 5f30 203d 3d20 3029 3b0a 2020 2020  K4_0 == 0);.    
-000973f0: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-00097400: 6b5f 7134 5f30 202a 2062 6c6f 636b 203d  k_q4_0 * block =
-00097410: 2028 626c 6f63 6b5f 7134 5f30 2a29 6473   (block_q4_0*)ds
-00097420: 7420 2b20 7374 6172 7420 2f20 514b 345f  t + start / QK4_
-00097430: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00097440: 2020 2072 6573 756c 7420 3d20 6767 6d6c     result = ggml
-00097450: 5f71 7561 6e74 697a 655f 7134 5f30 2873  _quantize_q4_0(s
-00097460: 7263 202b 2073 7461 7274 2c20 626c 6f63  rc + start, bloc
-00097470: 6b2c 206e 2c20 6e2c 2068 6973 7429 3b0a  k, n, n, hist);.
-00097480: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00097490: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000974a0: 6520 4747 4d4c 5f54 5950 455f 5134 5f31  e GGML_TYPE_Q4_1
-000974b0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000974c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000974d0: 4747 4d4c 5f41 5353 4552 5428 7374 6172  GGML_ASSERT(star
-000974e0: 7420 2520 514b 345f 3120 3d3d 2030 293b  t % QK4_1 == 0);
-000974f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00097500: 2062 6c6f 636b 5f71 345f 3120 2a20 626c   block_q4_1 * bl
-00097510: 6f63 6b20 3d20 2862 6c6f 636b 5f71 345f  ock = (block_q4_
-00097520: 312a 2964 7374 202b 2073 7461 7274 202f  1*)dst + start /
-00097530: 2051 4b34 5f31 3b0a 2020 2020 2020 2020   QK4_1;.        
-00097540: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00097550: 2067 676d 6c5f 7175 616e 7469 7a65 5f71   ggml_quantize_q
-00097560: 345f 3128 7372 6320 2b20 7374 6172 742c  4_1(src + start,
-00097570: 2062 6c6f 636b 2c20 6e2c 206e 2c20 6869   block, n, n, hi
-00097580: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00097590: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000975a0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000975b0: 5f51 355f 303a 0a20 2020 2020 2020 2020  _Q5_0:.         
-000975c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000975d0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-000975e0: 2873 7461 7274 2025 2051 4b35 5f30 203d  (start % QK5_0 =
-000975f0: 3d20 3029 3b0a 2020 2020 2020 2020 2020  = 0);.          
-00097600: 2020 2020 2020 626c 6f63 6b5f 7135 5f30        block_q5_0
-00097610: 202a 2062 6c6f 636b 203d 2028 626c 6f63   * block = (bloc
-00097620: 6b5f 7135 5f30 2a29 6473 7420 2b20 7374  k_q5_0*)dst + st
-00097630: 6172 7420 2f20 514b 355f 303b 0a20 2020  art / QK5_0;.   
-00097640: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00097650: 756c 7420 3d20 6767 6d6c 5f71 7561 6e74  ult = ggml_quant
-00097660: 697a 655f 7135 5f30 2873 7263 202b 2073  ize_q5_0(src + s
-00097670: 7461 7274 2c20 626c 6f63 6b2c 206e 2c20  tart, block, n, 
-00097680: 6e2c 2068 6973 7429 3b0a 2020 2020 2020  n, hist);.      
-00097690: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000976a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000976b0: 5f54 5950 455f 5135 5f31 3a0a 2020 2020  _TYPE_Q5_1:.    
-000976c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000976d0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-000976e0: 5353 4552 5428 7374 6172 7420 2520 514b  SSERT(start % QK
-000976f0: 355f 3120 3d3d 2030 293b 0a20 2020 2020  5_1 == 0);.     
-00097700: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-00097710: 5f71 355f 3120 2a20 626c 6f63 6b20 3d20  _q5_1 * block = 
-00097720: 2862 6c6f 636b 5f71 355f 312a 2964 7374  (block_q5_1*)dst
-00097730: 202b 2073 7461 7274 202f 2051 4b35 5f31   + start / QK5_1
-00097740: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00097750: 2020 7265 7375 6c74 203d 2067 676d 6c5f    result = ggml_
-00097760: 7175 616e 7469 7a65 5f71 355f 3128 7372  quantize_q5_1(sr
-00097770: 6320 2b20 7374 6172 742c 2062 6c6f 636b  c + start, block
-00097780: 2c20 6e2c 206e 2c20 6869 7374 293b 0a20  , n, n, hist);. 
-00097790: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000977a0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-000977b0: 2047 474d 4c5f 5459 5045 5f51 385f 303a   GGML_TYPE_Q8_0:
-000977c0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000977d0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-000977e0: 474d 4c5f 4153 5345 5254 2873 7461 7274  GML_ASSERT(start
-000977f0: 2025 2051 4b38 5f30 203d 3d20 3029 3b0a   % QK8_0 == 0);.
-00097800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00097810: 626c 6f63 6b5f 7138 5f30 202a 2062 6c6f  block_q8_0 * blo
-00097820: 636b 203d 2028 626c 6f63 6b5f 7138 5f30  ck = (block_q8_0
-00097830: 2a29 6473 7420 2b20 7374 6172 7420 2f20  *)dst + start / 
-00097840: 514b 385f 303b 0a20 2020 2020 2020 2020  QK8_0;.         
-00097850: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00097860: 6767 6d6c 5f71 7561 6e74 697a 655f 7138  ggml_quantize_q8
-00097870: 5f30 2873 7263 202b 2073 7461 7274 2c20  _0(src + start, 
-00097880: 626c 6f63 6b2c 206e 2c20 6e2c 2068 6973  block, n, n, his
-00097890: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-000978a0: 7d20 6272 6561 6b3b 0a23 6966 6465 6620  } break;.#ifdef 
-000978b0: 4747 4d4c 5f55 5345 5f4b 5f51 5541 4e54  GGML_USE_K_QUANT
-000978c0: 530a 2020 2020 2020 2020 6361 7365 2047  S.        case G
-000978d0: 474d 4c5f 5459 5045 5f51 325f 4b3a 0a20  GML_TYPE_Q2_K:. 
-000978e0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000978f0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00097900: 4c5f 4153 5345 5254 2873 7461 7274 2025  L_ASSERT(start %
-00097910: 2051 4b5f 4b20 3d3d 2030 293b 0a20 2020   QK_K == 0);.   
-00097920: 2020 2020 2020 2020 2020 2020 2062 6c6f               blo
-00097930: 636b 5f71 325f 4b20 2a20 626c 6f63 6b20  ck_q2_K * block 
-00097940: 3d20 2862 6c6f 636b 5f71 325f 4b2a 2964  = (block_q2_K*)d
-00097950: 7374 202b 2073 7461 7274 202f 2051 4b5f  st + start / QK_
-00097960: 4b3b 0a20 2020 2020 2020 2020 2020 2020  K;.             
-00097970: 2020 2072 6573 756c 7420 3d20 6767 6d6c     result = ggml
-00097980: 5f71 7561 6e74 697a 655f 7132 5f4b 2873  _quantize_q2_K(s
-00097990: 7263 202b 2073 7461 7274 2c20 626c 6f63  rc + start, bloc
-000979a0: 6b2c 206e 2c20 6e2c 2068 6973 7429 3b0a  k, n, n, hist);.
-000979b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000979c0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000979d0: 6520 4747 4d4c 5f54 5950 455f 5133 5f4b  e GGML_TYPE_Q3_K
-000979e0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000979f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00097a00: 4747 4d4c 5f41 5353 4552 5428 7374 6172  GGML_ASSERT(star
-00097a10: 7420 2520 514b 5f4b 203d 3d20 3029 3b0a  t % QK_K == 0);.
-00097a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00097a30: 626c 6f63 6b5f 7133 5f4b 202a 2062 6c6f  block_q3_K * blo
-00097a40: 636b 203d 2028 626c 6f63 6b5f 7133 5f4b  ck = (block_q3_K
-00097a50: 2a29 6473 7420 2b20 7374 6172 7420 2f20  *)dst + start / 
-00097a60: 514b 5f4b 3b0a 2020 2020 2020 2020 2020  QK_K;.          
-00097a70: 2020 2020 2020 7265 7375 6c74 203d 2067        result = g
-00097a80: 676d 6c5f 7175 616e 7469 7a65 5f71 335f  gml_quantize_q3_
-00097a90: 4b28 7372 6320 2b20 7374 6172 742c 2062  K(src + start, b
-00097aa0: 6c6f 636b 2c20 6e2c 206e 2c20 6869 7374  lock, n, n, hist
-00097ab0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00097ac0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00097ad0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00097ae0: 345f 4b3a 0a20 2020 2020 2020 2020 2020  4_K:.           
-00097af0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00097b00: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
-00097b10: 7461 7274 2025 2051 4b5f 4b20 3d3d 2030  tart % QK_K == 0
-00097b20: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00097b30: 2020 2062 6c6f 636b 5f71 345f 4b20 2a20     block_q4_K * 
-00097b40: 626c 6f63 6b20 3d20 2862 6c6f 636b 5f71  block = (block_q
-00097b50: 345f 4b2a 2964 7374 202b 2073 7461 7274  4_K*)dst + start
-00097b60: 202f 2051 4b5f 4b3b 0a20 2020 2020 2020   / QK_K;.       
-00097b70: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00097b80: 3d20 6767 6d6c 5f71 7561 6e74 697a 655f  = ggml_quantize_
-00097b90: 7134 5f4b 2873 7263 202b 2073 7461 7274  q4_K(src + start
-00097ba0: 2c20 626c 6f63 6b2c 206e 2c20 6e2c 2068  , block, n, n, h
-00097bb0: 6973 7429 3b0a 2020 2020 2020 2020 2020  ist);.          
-00097bc0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00097bd0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00097be0: 455f 5135 5f4b 3a0a 2020 2020 2020 2020  E_Q5_K:.        
-00097bf0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00097c00: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00097c10: 5428 7374 6172 7420 2520 514b 5f4b 203d  T(start % QK_K =
-00097c20: 3d20 3029 3b0a 2020 2020 2020 2020 2020  = 0);.          
-00097c30: 2020 2020 2020 626c 6f63 6b5f 7135 5f4b        block_q5_K
-00097c40: 202a 2062 6c6f 636b 203d 2028 626c 6f63   * block = (bloc
-00097c50: 6b5f 7135 5f4b 2a29 6473 7420 2b20 7374  k_q5_K*)dst + st
-00097c60: 6172 7420 2f20 514b 5f4b 3b0a 2020 2020  art / QK_K;.    
-00097c70: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00097c80: 6c74 203d 2067 676d 6c5f 7175 616e 7469  lt = ggml_quanti
-00097c90: 7a65 5f71 355f 4b28 7372 6320 2b20 7374  ze_q5_K(src + st
-00097ca0: 6172 742c 2062 6c6f 636b 2c20 6e2c 206e  art, block, n, n
-00097cb0: 2c20 6869 7374 293b 0a20 2020 2020 2020  , hist);.       
-00097cc0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00097cd0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00097ce0: 5459 5045 5f51 365f 4b3a 0a20 2020 2020  TYPE_Q6_K:.     
-00097cf0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00097d00: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00097d10: 5345 5254 2873 7461 7274 2025 2051 4b5f  SERT(start % QK_
-00097d20: 4b20 3d3d 2030 293b 0a20 2020 2020 2020  K == 0);.       
-00097d30: 2020 2020 2020 2020 2062 6c6f 636b 5f71           block_q
-00097d40: 365f 4b20 2a20 626c 6f63 6b20 3d20 2862  6_K * block = (b
-00097d50: 6c6f 636b 5f71 365f 4b2a 2964 7374 202b  lock_q6_K*)dst +
-00097d60: 2073 7461 7274 202f 2051 4b5f 4b3b 0a20   start / QK_K;. 
-00097d70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00097d80: 6573 756c 7420 3d20 6767 6d6c 5f71 7561  esult = ggml_qua
-00097d90: 6e74 697a 655f 7136 5f4b 2873 7263 202b  ntize_q6_K(src +
-00097da0: 2073 7461 7274 2c20 626c 6f63 6b2c 206e   start, block, n
-00097db0: 2c20 6e2c 2068 6973 7429 3b0a 2020 2020  , n, hist);.    
-00097dc0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00097dd0: 0a23 656e 6469 660a 2020 2020 2020 2020  .#endif.        
-00097de0: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00097df0: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
-00097e00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00097e10: 2020 696e 7420 656c 656d 7369 7a65 203d    int elemsize =
-00097e20: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
-00097e30: 365f 7429 3b0a 2020 2020 2020 2020 2020  6_t);.          
-00097e40: 2020 2020 2020 6767 6d6c 5f66 7033 325f        ggml_fp32_
-00097e50: 746f 5f66 7031 365f 726f 7728 7372 6320  to_fp16_row(src 
-00097e60: 2b20 7374 6172 742c 2028 6767 6d6c 5f66  + start, (ggml_f
-00097e70: 7031 365f 7420 2a29 6473 7420 2b20 7374  p16_t *)dst + st
-00097e80: 6172 742c 206e 293b 0a20 2020 2020 2020  art, n);.       
-00097e90: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00097ea0: 3d20 6e20 2a20 656c 656d 7369 7a65 3b0a  = n * elemsize;.
-00097eb0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00097ec0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00097ed0: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
-00097ee0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00097ef0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00097f00: 6e74 2065 6c65 6d73 697a 6520 3d20 7369  nt elemsize = si
-00097f10: 7a65 6f66 2866 6c6f 6174 293b 0a20 2020  zeof(float);.   
-00097f20: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00097f30: 756c 7420 3d20 6e20 2a20 656c 656d 7369  ult = n * elemsi
-00097f40: 7a65 3b0a 2020 2020 2020 2020 2020 2020  ze;.            
-00097f50: 2020 2020 6d65 6d63 7079 2828 7569 6e74      memcpy((uint
-00097f60: 385f 7420 2a29 6473 7420 2b20 7374 6172  8_t *)dst + star
-00097f70: 7420 2a20 656c 656d 7369 7a65 2c20 7372  t * elemsize, sr
-00097f80: 6320 2b20 7374 6172 742c 2072 6573 756c  c + start, resul
-00097f90: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-00097fa0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00097fb0: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
-00097fc0: 2020 2020 2020 6173 7365 7274 2866 616c        assert(fal
-00097fd0: 7365 293b 0a20 2020 207d 0a20 2020 2072  se);.    }.    r
-00097fe0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-00097ff0: 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .///////////////
-00098000: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00098010: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00098020: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00098030: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00098040: 2f0a 0a69 6e74 2067 676d 6c5f 6370 755f  /..int ggml_cpu_
-00098050: 6861 735f 6176 7828 766f 6964 2920 7b0a  has_avx(void) {.
-00098060: 2369 6620 6465 6669 6e65 6428 5f5f 4156  #if defined(__AV
-00098070: 585f 5f29 0a20 2020 2072 6574 7572 6e20  X__).    return 
-00098080: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
-00098090: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
-000980a0: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
-000980b0: 735f 6176 7832 2876 6f69 6429 207b 0a23  s_avx2(void) {.#
-000980c0: 6966 2064 6566 696e 6564 285f 5f41 5658  if defined(__AVX
-000980d0: 325f 5f29 0a20 2020 2072 6574 7572 6e20  2__).    return 
-000980e0: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
-000980f0: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
-00098100: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
-00098110: 735f 6176 7835 3132 2876 6f69 6429 207b  s_avx512(void) {
-00098120: 0a23 6966 2064 6566 696e 6564 285f 5f41  .#if defined(__A
-00098130: 5658 3531 3246 5f5f 290a 2020 2020 7265  VX512F__).    re
-00098140: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
-00098150: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
-00098160: 6966 0a7d 0a0a 696e 7420 6767 6d6c 5f63  if.}..int ggml_c
-00098170: 7075 5f68 6173 5f61 7678 3531 325f 7662  pu_has_avx512_vb
-00098180: 6d69 2876 6f69 6429 207b 0a23 6966 2064  mi(void) {.#if d
-00098190: 6566 696e 6564 285f 5f41 5658 3531 3256  efined(__AVX512V
-000981a0: 424d 495f 5f29 0a20 2020 2072 6574 7572  BMI__).    retur
-000981b0: 6e20 313b 0a23 656c 7365 0a20 2020 2072  n 1;.#else.    r
-000981c0: 6574 7572 6e20 303b 0a23 656e 6469 660a  eturn 0;.#endif.
-000981d0: 7d0a 0a69 6e74 2067 676d 6c5f 6370 755f  }..int ggml_cpu_
-000981e0: 6861 735f 6176 7835 3132 5f76 6e6e 6928  has_avx512_vnni(
-000981f0: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
-00098200: 6e65 6428 5f5f 4156 5835 3132 564e 4e49  ned(__AVX512VNNI
-00098210: 5f5f 290a 2020 2020 7265 7475 726e 2031  __).    return 1
-00098220: 3b0a 2365 6c73 650a 2020 2020 7265 7475  ;.#else.    retu
-00098230: 726e 2030 3b0a 2365 6e64 6966 0a7d 0a0a  rn 0;.#endif.}..
-00098240: 696e 7420 6767 6d6c 5f63 7075 5f68 6173  int ggml_cpu_has
-00098250: 5f66 6d61 2876 6f69 6429 207b 0a23 6966  _fma(void) {.#if
-00098260: 2064 6566 696e 6564 285f 5f46 4d41 5f5f   defined(__FMA__
-00098270: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
-00098280: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
-00098290: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
-000982a0: 7420 6767 6d6c 5f63 7075 5f68 6173 5f6e  t ggml_cpu_has_n
-000982b0: 656f 6e28 766f 6964 2920 7b0a 2369 6620  eon(void) {.#if 
-000982c0: 6465 6669 6e65 6428 5f5f 4152 4d5f 4e45  defined(__ARM_NE
-000982d0: 4f4e 290a 2020 2020 7265 7475 726e 2031  ON).    return 1
-000982e0: 3b0a 2365 6c73 650a 2020 2020 7265 7475  ;.#else.    retu
-000982f0: 726e 2030 3b0a 2365 6e64 6966 0a7d 0a0a  rn 0;.#endif.}..
-00098300: 696e 7420 6767 6d6c 5f63 7075 5f68 6173  int ggml_cpu_has
-00098310: 5f61 726d 5f66 6d61 2876 6f69 6429 207b  _arm_fma(void) {
-00098320: 0a23 6966 2064 6566 696e 6564 285f 5f41  .#if defined(__A
-00098330: 524d 5f46 4541 5455 5245 5f46 4d41 290a  RM_FEATURE_FMA).
-00098340: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
-00098350: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
-00098360: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
-00098370: 6767 6d6c 5f63 7075 5f68 6173 5f66 3136  ggml_cpu_has_f16
-00098380: 6328 766f 6964 2920 7b0a 2369 6620 6465  c(void) {.#if de
-00098390: 6669 6e65 6428 5f5f 4631 3643 5f5f 290a  fined(__F16C__).
-000983a0: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
-000983b0: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
-000983c0: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
-000983d0: 6767 6d6c 5f63 7075 5f68 6173 5f66 7031  ggml_cpu_has_fp1
-000983e0: 365f 7661 2876 6f69 6429 207b 0a23 6966  6_va(void) {.#if
-000983f0: 2064 6566 696e 6564 285f 5f41 524d 5f46   defined(__ARM_F
-00098400: 4541 5455 5245 5f46 5031 365f 5645 4354  EATURE_FP16_VECT
-00098410: 4f52 5f41 5249 5448 4d45 5449 4329 0a20  OR_ARITHMETIC). 
-00098420: 2020 2072 6574 7572 6e20 313b 0a23 656c     return 1;.#el
-00098430: 7365 0a20 2020 2072 6574 7572 6e20 303b  se.    return 0;
-00098440: 0a23 656e 6469 660a 7d0a 0a69 6e74 2067  .#endif.}..int g
-00098450: 676d 6c5f 6370 755f 6861 735f 7761 736d  gml_cpu_has_wasm
-00098460: 5f73 696d 6428 766f 6964 2920 7b0a 2369  _simd(void) {.#i
-00098470: 6620 6465 6669 6e65 6428 5f5f 7761 736d  f defined(__wasm
-00098480: 5f73 696d 6431 3238 5f5f 290a 2020 2020  _simd128__).    
-00098490: 7265 7475 726e 2031 3b0a 2365 6c73 650a  return 1;.#else.
-000984a0: 2020 2020 7265 7475 726e 2030 3b0a 2365      return 0;.#e
-000984b0: 6e64 6966 0a7d 0a0a 696e 7420 6767 6d6c  ndif.}..int ggml
-000984c0: 5f63 7075 5f68 6173 5f62 6c61 7328 766f  _cpu_has_blas(vo
-000984d0: 6964 2920 7b0a 2369 6620 6465 6669 6e65  id) {.#if define
-000984e0: 6428 4747 4d4c 5f55 5345 5f41 4343 454c  d(GGML_USE_ACCEL
-000984f0: 4552 4154 4529 207c 7c20 6465 6669 6e65  ERATE) || define
-00098500: 6428 4747 4d4c 5f55 5345 5f4f 5045 4e42  d(GGML_USE_OPENB
-00098510: 4c41 5329 207c 7c20 6465 6669 6e65 6428  LAS) || defined(
-00098520: 4747 4d4c 5f55 5345 5f43 5542 4c41 5329  GGML_USE_CUBLAS)
-00098530: 207c 7c20 6465 6669 6e65 6428 4747 4d4c   || defined(GGML
-00098540: 5f55 5345 5f43 4c42 4c41 5354 290a 2020  _USE_CLBLAST).  
-00098550: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
-00098560: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
-00098570: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
-00098580: 6d6c 5f63 7075 5f68 6173 5f63 7562 6c61  ml_cpu_has_cubla
-00098590: 7328 766f 6964 2920 7b0a 2369 6620 6465  s(void) {.#if de
-000985a0: 6669 6e65 6428 4747 4d4c 5f55 5345 5f43  fined(GGML_USE_C
-000985b0: 5542 4c41 5329 0a20 2020 2072 6574 7572  UBLAS).    retur
-000985c0: 6e20 313b 0a23 656c 7365 0a20 2020 2072  n 1;.#else.    r
-000985d0: 6574 7572 6e20 303b 0a23 656e 6469 660a  eturn 0;.#endif.
-000985e0: 7d0a 0a69 6e74 2067 676d 6c5f 6370 755f  }..int ggml_cpu_
-000985f0: 6861 735f 636c 626c 6173 7428 766f 6964  has_clblast(void
-00098600: 2920 7b0a 2369 6620 6465 6669 6e65 6428  ) {.#if defined(
-00098610: 4747 4d4c 5f55 5345 5f43 4c42 4c41 5354  GGML_USE_CLBLAST
-00098620: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
-00098630: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
-00098640: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
-00098650: 7420 6767 6d6c 5f63 7075 5f68 6173 5f67  t ggml_cpu_has_g
-00098660: 7075 626c 6173 2876 6f69 6429 207b 0a20  publas(void) {. 
-00098670: 2020 2072 6574 7572 6e20 6767 6d6c 5f63     return ggml_c
-00098680: 7075 5f68 6173 5f63 7562 6c61 7328 2920  pu_has_cublas() 
-00098690: 7c7c 2067 676d 6c5f 6370 755f 6861 735f  || ggml_cpu_has_
-000986a0: 636c 626c 6173 7428 293b 0a7d 0a0a 696e  clblast();.}..in
-000986b0: 7420 6767 6d6c 5f63 7075 5f68 6173 5f73  t ggml_cpu_has_s
-000986c0: 7365 3328 766f 6964 2920 7b0a 2369 6620  se3(void) {.#if 
-000986d0: 6465 6669 6e65 6428 5f5f 5353 4533 5f5f  defined(__SSE3__
-000986e0: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
-000986f0: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
-00098700: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
-00098710: 7420 6767 6d6c 5f63 7075 5f68 6173 5f76  t ggml_cpu_has_v
-00098720: 7378 2876 6f69 6429 207b 0a23 6966 2064  sx(void) {.#if d
-00098730: 6566 696e 6564 285f 5f50 4f57 4552 395f  efined(__POWER9_
-00098740: 5645 4354 4f52 5f5f 290a 2020 2020 7265  VECTOR__).    re
-00098750: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
-00098760: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
-00098770: 6966 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f  if.}..//////////
-00098780: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00098790: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000987a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000987b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000987c0: 2f2f 2f2f 2f2f 0a                        //////.
+000957d0: 3332 2c20 7061 7261 6d73 2e70 6173 7429  32, params.past)
+000957e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000957f0: 2020 2020 203a 204e 554c 4c3b 0a20 2020       : NULL;.   
+00095800: 2020 2020 2020 2020 2020 2020 206f 7074               opt
+00095810: 2d3e 6c62 6667 732e 6c6d 616c 203d 2067  ->lbfgs.lmal = g
+00095820: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
+00095830: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
+00095840: 5f46 3332 2c20 7061 7261 6d73 2e6c 6266  _F32, params.lbf
+00095850: 6773 2e6d 293b 0a20 2020 2020 2020 2020  gs.m);.         
+00095860: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
+00095870: 732e 6c6d 7973 203d 2067 676d 6c5f 6e65  s.lmys = ggml_ne
+00095880: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
+00095890: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+000958a0: 7061 7261 6d73 2e6c 6266 6773 2e6d 293b  params.lbfgs.m);
+000958b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000958c0: 206f 7074 2d3e 6c62 6667 732e 6c6d 7320   opt->lbfgs.lms 
+000958d0: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+000958e0: 6f72 5f32 6428 6374 782c 2047 474d 4c5f  or_2d(ctx, GGML_
+000958f0: 5459 5045 5f46 3332 2c20 6e78 2c20 7061  TYPE_F32, nx, pa
+00095900: 7261 6d73 2e6c 6266 6773 2e6d 293b 0a20  rams.lbfgs.m);. 
+00095910: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00095920: 7074 2d3e 6c62 6667 732e 6c6d 7920 203d  pt->lbfgs.lmy  =
+00095930: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+00095940: 5f32 6428 6374 782c 2047 474d 4c5f 5459  _2d(ctx, GGML_TY
+00095950: 5045 5f46 3332 2c20 6e78 2c20 7061 7261  PE_F32, nx, para
+00095960: 6d73 2e6c 6266 6773 2e6d 293b 0a20 2020  ms.lbfgs.m);.   
+00095970: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00095980: 6c5f 7365 745f 7a65 726f 286f 7074 2d3e  l_set_zero(opt->
+00095990: 6c62 6667 732e 7829 3b0a 2020 2020 2020  lbfgs.x);.      
+000959a0: 2020 2020 2020 2020 2020 6767 6d6c 5f73            ggml_s
+000959b0: 6574 5f7a 6572 6f28 6f70 742d 3e6c 6266  et_zero(opt->lbf
+000959c0: 6773 2e78 7029 3b0a 2020 2020 2020 2020  gs.xp);.        
+000959d0: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
+000959e0: 5f7a 6572 6f28 6f70 742d 3e6c 6266 6773  _zero(opt->lbfgs
+000959f0: 2e67 293b 0a20 2020 2020 2020 2020 2020  .g);.           
+00095a00: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
+00095a10: 726f 286f 7074 2d3e 6c62 6667 732e 6770  ro(opt->lbfgs.gp
+00095a20: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00095a30: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
+00095a40: 286f 7074 2d3e 6c62 6667 732e 6429 3b0a  (opt->lbfgs.d);.
+00095a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00095a60: 6966 2028 6f70 742d 3e6c 6266 6773 2e70  if (opt->lbfgs.p
+00095a70: 6629 207b 0a20 2020 2020 2020 2020 2020  f) {.           
+00095a80: 2020 2020 2020 2020 2067 676d 6c5f 7365           ggml_se
+00095a90: 745f 7a65 726f 286f 7074 2d3e 6c62 6667  t_zero(opt->lbfg
+00095aa0: 732e 7066 293b 0a20 2020 2020 2020 2020  s.pf);.         
+00095ab0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00095ac0: 2020 2020 2020 2020 2067 676d 6c5f 7365           ggml_se
+00095ad0: 745f 7a65 726f 286f 7074 2d3e 6c62 6667  t_zero(opt->lbfg
+00095ae0: 732e 6c6d 616c 293b 0a20 2020 2020 2020  s.lmal);.       
+00095af0: 2020 2020 2020 2020 2067 676d 6c5f 7365           ggml_se
+00095b00: 745f 7a65 726f 286f 7074 2d3e 6c62 6667  t_zero(opt->lbfg
+00095b10: 732e 6c6d 7973 293b 0a20 2020 2020 2020  s.lmys);.       
+00095b20: 2020 2020 2020 2020 2067 676d 6c5f 7365           ggml_se
+00095b30: 745f 7a65 726f 286f 7074 2d3e 6c62 6667  t_zero(opt->lbfg
+00095b40: 732e 6c6d 7329 3b0a 2020 2020 2020 2020  s.lms);.        
+00095b50: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
+00095b60: 5f7a 6572 6f28 6f70 742d 3e6c 6266 6773  _zero(opt->lbfgs
+00095b70: 2e6c 6d79 293b 0a20 2020 2020 2020 2020  .lmy);.         
+00095b80: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00095b90: 7d0a 7d0a 0a65 6e75 6d20 6767 6d6c 5f6f  }.}..enum ggml_o
+00095ba0: 7074 5f72 6573 756c 7420 6767 6d6c 5f6f  pt_result ggml_o
+00095bb0: 7074 280a 2020 2020 2020 2020 7374 7275  pt(.        stru
+00095bc0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+00095bd0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+00095be0: 7472 7563 7420 6767 6d6c 5f6f 7074 5f70  truct ggml_opt_p
+00095bf0: 6172 616d 7320 7061 7261 6d73 2c0a 2020  arams params,.  
+00095c00: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00095c10: 6c5f 7465 6e73 6f72 202a 2066 2920 7b0a  l_tensor * f) {.
+00095c20: 2020 2020 626f 6f6c 2066 7265 655f 6374      bool free_ct
+00095c30: 7820 3d20 6661 6c73 653b 0a20 2020 2069  x = false;.    i
+00095c40: 6620 2863 7478 203d 3d20 4e55 4c4c 2920  f (ctx == NULL) 
+00095c50: 7b0a 2020 2020 2020 2020 7374 7275 6374  {.        struct
+00095c60: 2067 676d 6c5f 696e 6974 5f70 6172 616d   ggml_init_param
+00095c70: 7320 7061 7261 6d73 5f63 7478 203d 207b  s params_ctx = {
+00095c80: 0a20 2020 2020 2020 2020 2020 202e 6d65  .            .me
+00095c90: 6d5f 7369 7a65 2020 203d 2031 362a 3130  m_size   = 16*10
+00095ca0: 3234 2a31 3032 342c 0a20 2020 2020 2020  24*1024,.       
+00095cb0: 2020 2020 202e 6d65 6d5f 6275 6666 6572       .mem_buffer
+00095cc0: 203d 204e 554c 4c2c 0a20 2020 2020 2020   = NULL,.       
+00095cd0: 2020 2020 202e 6e6f 5f61 6c6c 6f63 2020       .no_alloc  
+00095ce0: 203d 2066 616c 7365 2c0a 2020 2020 2020   = false,.      
+00095cf0: 2020 7d3b 0a0a 2020 2020 2020 2020 6374    };..        ct
+00095d00: 7820 3d20 6767 6d6c 5f69 6e69 7428 7061  x = ggml_init(pa
+00095d10: 7261 6d73 5f63 7478 293b 0a20 2020 2020  rams_ctx);.     
+00095d20: 2020 2069 6620 2863 7478 203d 3d20 4e55     if (ctx == NU
+00095d30: 4c4c 2920 7b0a 2020 2020 2020 2020 2020  LL) {.          
+00095d40: 2020 7265 7475 726e 2047 474d 4c5f 4f50    return GGML_OP
+00095d50: 545f 4e4f 5f43 4f4e 5445 5854 3b0a 2020  T_NO_CONTEXT;.  
+00095d60: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00095d70: 2066 7265 655f 6374 7820 3d20 7472 7565   free_ctx = true
+00095d80: 3b0a 2020 2020 7d0a 0a20 2020 2065 6e75  ;.    }..    enu
+00095d90: 6d20 6767 6d6c 5f6f 7074 5f72 6573 756c  m ggml_opt_resul
+00095da0: 7420 7265 7375 6c74 203d 2047 474d 4c5f  t result = GGML_
+00095db0: 4f50 545f 4f4b 3b0a 0a20 2020 2073 7472  OPT_OK;..    str
+00095dc0: 7563 7420 6767 6d6c 5f6f 7074 5f63 6f6e  uct ggml_opt_con
+00095dd0: 7465 7874 202a 206f 7074 203d 2028 7374  text * opt = (st
+00095de0: 7275 6374 2067 676d 6c5f 6f70 745f 636f  ruct ggml_opt_co
+00095df0: 6e74 6578 7420 2a29 2061 6c6c 6f63 6128  ntext *) alloca(
+00095e00: 7369 7a65 6f66 2873 7472 7563 7420 6767  sizeof(struct gg
+00095e10: 6d6c 5f6f 7074 5f63 6f6e 7465 7874 2929  ml_opt_context))
+00095e20: 3b0a 0a20 2020 2067 676d 6c5f 6f70 745f  ;..    ggml_opt_
+00095e30: 696e 6974 2863 7478 2c20 6f70 742c 2070  init(ctx, opt, p
+00095e40: 6172 616d 732c 2030 293b 0a20 2020 2072  arams, 0);.    r
+00095e50: 6573 756c 7420 3d20 6767 6d6c 5f6f 7074  esult = ggml_opt
+00095e60: 5f72 6573 756d 6528 6374 782c 206f 7074  _resume(ctx, opt
+00095e70: 2c20 6629 3b0a 0a20 2020 2069 6620 2866  , f);..    if (f
+00095e80: 7265 655f 6374 7829 207b 0a20 2020 2020  ree_ctx) {.     
+00095e90: 2020 2067 676d 6c5f 6672 6565 2863 7478     ggml_free(ctx
+00095ea0: 293b 0a20 2020 207d 0a0a 2020 2020 7265  );.    }..    re
+00095eb0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+00095ec0: 656e 756d 2067 676d 6c5f 6f70 745f 7265  enum ggml_opt_re
+00095ed0: 7375 6c74 2067 676d 6c5f 6f70 745f 7265  sult ggml_opt_re
+00095ee0: 7375 6d65 280a 2020 2020 2020 2020 7374  sume(.        st
+00095ef0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+00095f00: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+00095f10: 2073 7472 7563 7420 6767 6d6c 5f6f 7074   struct ggml_opt
+00095f20: 5f63 6f6e 7465 7874 202a 206f 7074 2c0a  _context * opt,.
+00095f30: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00095f40: 676d 6c5f 7465 6e73 6f72 202a 2066 2920  gml_tensor * f) 
+00095f50: 7b0a 0a20 2020 202f 2f20 6275 696c 6420  {..    // build 
+00095f60: 666f 7277 6172 6420 2b20 6261 636b 7761  forward + backwa
+00095f70: 7264 2063 6f6d 7075 7465 2067 7261 7068  rd compute graph
+00095f80: 730a 2020 2020 7374 7275 6374 2067 676d  s.    struct ggm
+00095f90: 6c5f 7465 6e73 6f72 202a 2067 6662 7566  l_tensor * gfbuf
+00095fa0: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+00095fb0: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+00095fc0: 5459 5045 5f49 3332 2c20 7369 7a65 6f66  TYPE_I32, sizeof
+00095fd0: 2873 7472 7563 7420 6767 6d6c 5f63 6772  (struct ggml_cgr
+00095fe0: 6170 6829 202f 2047 474d 4c5f 5459 5045  aph) / GGML_TYPE
+00095ff0: 5f53 495a 455b 4747 4d4c 5f54 5950 455f  _SIZE[GGML_TYPE_
+00096000: 4933 325d 2b20 2873 697a 656f 6628 7374  I32]+ (sizeof(st
+00096010: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
+00096020: 2920 2520 4747 4d4c 5f54 5950 455f 5349  ) % GGML_TYPE_SI
+00096030: 5a45 5b47 474d 4c5f 5459 5045 5f49 3332  ZE[GGML_TYPE_I32
+00096040: 5d20 3f20 3120 3a20 3029 293b 0a20 2020  ] ? 1 : 0));.   
+00096050: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00096060: 736f 7220 2a20 6762 6275 6620 3d20 6767  sor * gbbuf = gg
+00096070: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
+00096080: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
+00096090: 4933 322c 2073 697a 656f 6628 7374 7275  I32, sizeof(stru
+000960a0: 6374 2067 676d 6c5f 6367 7261 7068 2920  ct ggml_cgraph) 
+000960b0: 2f20 4747 4d4c 5f54 5950 455f 5349 5a45  / GGML_TYPE_SIZE
+000960c0: 5b47 474d 4c5f 5459 5045 5f49 3332 5d2b  [GGML_TYPE_I32]+
+000960d0: 2028 7369 7a65 6f66 2873 7472 7563 7420   (sizeof(struct 
+000960e0: 6767 6d6c 5f63 6772 6170 6829 2025 2047  ggml_cgraph) % G
+000960f0: 474d 4c5f 5459 5045 5f53 495a 455b 4747  GML_TYPE_SIZE[GG
+00096100: 4d4c 5f54 5950 455f 4933 325d 203f 2031  ML_TYPE_I32] ? 1
+00096110: 203a 2030 2929 3b0a 0a20 2020 2073 7472   : 0));..    str
+00096120: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+00096130: 2a20 6766 203d 2028 7374 7275 6374 2067  * gf = (struct g
+00096140: 676d 6c5f 6367 7261 7068 202a 2920 6766  gml_cgraph *) gf
+00096150: 6275 662d 3e64 6174 613b 0a20 2020 2073  buf->data;.    s
+00096160: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+00096170: 6820 2a20 6762 203d 2028 7374 7275 6374  h * gb = (struct
+00096180: 2067 676d 6c5f 6367 7261 7068 202a 2920   ggml_cgraph *) 
+00096190: 6762 6275 662d 3e64 6174 613b 0a0a 2020  gbbuf->data;..  
+000961a0: 2020 2a67 6620 3d20 6767 6d6c 5f62 7569    *gf = ggml_bui
+000961b0: 6c64 5f66 6f72 7761 7264 2028 6629 3b0a  ld_forward (f);.
+000961c0: 2020 2020 2a67 6220 3d20 6767 6d6c 5f62      *gb = ggml_b
+000961d0: 7569 6c64 5f62 6163 6b77 6172 6428 6374  uild_backward(ct
+000961e0: 782c 2067 662c 2074 7275 6529 3b0a 0a20  x, gf, true);.. 
+000961f0: 2020 2072 6574 7572 6e20 6767 6d6c 5f6f     return ggml_o
+00096200: 7074 5f72 6573 756d 655f 6728 6374 782c  pt_resume_g(ctx,
+00096210: 206f 7074 2c20 662c 2067 662c 2067 6229   opt, f, gf, gb)
+00096220: 3b0a 7d0a 0a65 6e75 6d20 6767 6d6c 5f6f  ;.}..enum ggml_o
+00096230: 7074 5f72 6573 756c 7420 6767 6d6c 5f6f  pt_result ggml_o
+00096240: 7074 5f72 6573 756d 655f 6728 0a20 2020  pt_resume_g(.   
+00096250: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00096260: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+00096270: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00096280: 676d 6c5f 6f70 745f 636f 6e74 6578 7420  gml_opt_context 
+00096290: 2a20 6f70 742c 0a20 2020 2020 2020 2073  * opt,.        s
+000962a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000962b0: 7220 2a20 662c 0a20 2020 2020 2020 2073  r * f,.        s
+000962c0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+000962d0: 6820 2a20 6766 2c0a 2020 2020 2020 2020  h * gf,.        
+000962e0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+000962f0: 7068 202a 2067 6229 207b 0a0a 2020 2020  ph * gb) {..    
+00096300: 2f2f 2062 7569 6c64 2066 6f72 7761 7264  // build forward
+00096310: 202b 2062 6163 6b77 6172 6420 636f 6d70   + backward comp
+00096320: 7574 6520 6772 6170 6873 0a20 2020 2065  ute graphs.    e
+00096330: 6e75 6d20 6767 6d6c 5f6f 7074 5f72 6573  num ggml_opt_res
+00096340: 756c 7420 7265 7375 6c74 203d 2047 474d  ult result = GGM
+00096350: 4c5f 4f50 545f 4f4b 3b0a 0a20 2020 2073  L_OPT_OK;..    s
+00096360: 7769 7463 6820 286f 7074 2d3e 7061 7261  witch (opt->para
+00096370: 6d73 2e74 7970 6529 207b 0a20 2020 2020  ms.type) {.     
+00096380: 2020 2063 6173 6520 4747 4d4c 5f4f 5054     case GGML_OPT
+00096390: 5f41 4441 4d3a 0a20 2020 2020 2020 2020  _ADAM:.         
+000963a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000963b0: 2020 2020 2072 6573 756c 7420 3d20 6767       result = gg
+000963c0: 6d6c 5f6f 7074 5f61 6461 6d28 6374 782c  ml_opt_adam(ctx,
+000963d0: 206f 7074 2c20 6f70 742d 3e70 6172 616d   opt, opt->param
+000963e0: 732c 2066 2c20 6766 2c20 6762 293b 0a20  s, f, gf, gb);. 
+000963f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00096400: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00096410: 2047 474d 4c5f 4f50 545f 4c42 4647 533a   GGML_OPT_LBFGS:
+00096420: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00096430: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00096440: 6573 756c 7420 3d20 6767 6d6c 5f6f 7074  esult = ggml_opt
+00096450: 5f6c 6266 6773 2863 7478 2c20 6f70 742c  _lbfgs(ctx, opt,
+00096460: 206f 7074 2d3e 7061 7261 6d73 2c20 662c   opt->params, f,
+00096470: 2067 662c 2067 6229 3b0a 2020 2020 2020   gf, gb);.      
+00096480: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00096490: 2020 207d 0a0a 2020 2020 6966 2028 6f70     }..    if (op
+000964a0: 742d 3e70 6172 616d 732e 7072 696e 745f  t->params.print_
+000964b0: 666f 7277 6172 645f 6772 6170 6829 207b  forward_graph) {
+000964c0: 0a20 2020 2020 2020 2067 676d 6c5f 6772  .        ggml_gr
+000964d0: 6170 685f 7072 696e 7420 2020 2867 6629  aph_print   (gf)
+000964e0: 3b0a 2020 2020 2020 2020 6767 6d6c 5f67  ;.        ggml_g
+000964f0: 7261 7068 5f64 756d 705f 646f 7428 6766  raph_dump_dot(gf
+00096500: 2c20 4e55 4c4c 2c20 226f 7074 2d66 6f72  , NULL, "opt-for
+00096510: 7761 7264 2e64 6f74 2229 3b0a 2020 2020  ward.dot");.    
+00096520: 7d0a 0a20 2020 2069 6620 286f 7074 2d3e  }..    if (opt->
+00096530: 7061 7261 6d73 2e70 7269 6e74 5f62 6163  params.print_bac
+00096540: 6b77 6172 645f 6772 6170 6829 207b 0a20  kward_graph) {. 
+00096550: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
+00096560: 685f 7072 696e 7420 2020 2867 6229 3b0a  h_print   (gb);.
+00096570: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
+00096580: 7068 5f64 756d 705f 646f 7428 6762 2c20  ph_dump_dot(gb, 
+00096590: 6766 2c20 226f 7074 2d62 6163 6b77 6172  gf, "opt-backwar
+000965a0: 642e 646f 7422 293b 0a20 2020 207d 0a0a  d.dot");.    }..
+000965b0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+000965c0: 743b 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f  t;.}..//////////
+000965d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000965e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000965f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00096600: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00096610: 2f2f 2f2f 2f2f 0a0a 7369 7a65 5f74 2067  //////..size_t g
+00096620: 676d 6c5f 7175 616e 7469 7a65 5f71 345f  gml_quantize_q4_
+00096630: 3028 636f 6e73 7420 666c 6f61 7420 2a20  0(const float * 
+00096640: 7372 632c 2076 6f69 6420 2a20 6473 742c  src, void * dst,
+00096650: 2069 6e74 206e 2c20 696e 7420 6b2c 2069   int n, int k, i
+00096660: 6e74 3634 5f74 202a 2068 6973 7429 207b  nt64_t * hist) {
+00096670: 0a20 2020 2061 7373 6572 7428 6b20 2520  .    assert(k % 
+00096680: 514b 345f 3020 3d3d 2030 293b 0a20 2020  QK4_0 == 0);.   
+00096690: 2063 6f6e 7374 2069 6e74 206e 6220 3d20   const int nb = 
+000966a0: 6b20 2f20 514b 345f 303b 0a0a 2020 2020  k / QK4_0;..    
+000966b0: 666f 7220 2869 6e74 2062 203d 2030 3b20  for (int b = 0; 
+000966c0: 6220 3c20 6e3b 2062 202b 3d20 6b29 207b  b < n; b += k) {
+000966d0: 0a20 2020 2020 2020 2062 6c6f 636b 5f71  .        block_q
+000966e0: 345f 3020 2a20 7265 7374 7269 6374 2079  4_0 * restrict y
+000966f0: 203d 2028 626c 6f63 6b5f 7134 5f30 202a   = (block_q4_0 *
+00096700: 2920 6473 7420 2b20 622f 514b 345f 303b  ) dst + b/QK4_0;
+00096710: 0a0a 2020 2020 2020 2020 7175 616e 7469  ..        quanti
+00096720: 7a65 5f72 6f77 5f71 345f 305f 7265 6665  ze_row_q4_0_refe
+00096730: 7265 6e63 6528 7372 6320 2b20 622c 2079  rence(src + b, y
+00096740: 2c20 6b29 3b0a 0a20 2020 2020 2020 2066  , k);..        f
+00096750: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00096760: 203c 206e 623b 2069 2b2b 2920 7b0a 2020   < nb; i++) {.  
+00096770: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00096780: 6e74 206a 203d 2030 3b20 6a20 3c20 514b  nt j = 0; j < QK
+00096790: 345f 303b 206a 202b 3d20 3229 207b 0a20  4_0; j += 2) {. 
+000967a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000967b0: 6f6e 7374 2075 696e 7438 5f74 2076 6930  onst uint8_t vi0
+000967c0: 203d 2079 5b69 5d2e 7173 5b6a 2f32 5d20   = y[i].qs[j/2] 
+000967d0: 2620 3078 3046 3b0a 2020 2020 2020 2020  & 0x0F;.        
+000967e0: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+000967f0: 6e74 385f 7420 7669 3120 3d20 795b 695d  nt8_t vi1 = y[i]
+00096800: 2e71 735b 6a2f 325d 203e 3e20 343b 0a0a  .qs[j/2] >> 4;..
+00096810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00096820: 6869 7374 5b76 6930 5d2b 2b3b 0a20 2020  hist[vi0]++;.   
+00096830: 2020 2020 2020 2020 2020 2020 2068 6973               his
+00096840: 745b 7669 315d 2b2b 3b0a 2020 2020 2020  t[vi1]++;.      
+00096850: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00096860: 7d0a 2020 2020 7d0a 0a20 2020 2072 6574  }.    }..    ret
+00096870: 7572 6e20 286e 2f51 4b34 5f30 2a73 697a  urn (n/QK4_0*siz
+00096880: 656f 6628 626c 6f63 6b5f 7134 5f30 2929  eof(block_q4_0))
+00096890: 3b0a 7d0a 0a73 697a 655f 7420 6767 6d6c  ;.}..size_t ggml
+000968a0: 5f71 7561 6e74 697a 655f 7134 5f31 2863  _quantize_q4_1(c
+000968b0: 6f6e 7374 2066 6c6f 6174 202a 2073 7263  onst float * src
+000968c0: 2c20 766f 6964 202a 2064 7374 2c20 696e  , void * dst, in
+000968d0: 7420 6e2c 2069 6e74 206b 2c20 696e 7436  t n, int k, int6
+000968e0: 345f 7420 2a20 6869 7374 2920 7b0a 2020  4_t * hist) {.  
+000968f0: 2020 6173 7365 7274 286b 2025 2051 4b34    assert(k % QK4
+00096900: 5f31 203d 3d20 3029 3b0a 2020 2020 636f  _1 == 0);.    co
+00096910: 6e73 7420 696e 7420 6e62 203d 206b 202f  nst int nb = k /
+00096920: 2051 4b34 5f31 3b0a 0a20 2020 2066 6f72   QK4_1;..    for
+00096930: 2028 696e 7420 6220 3d20 303b 2062 203c   (int b = 0; b <
+00096940: 206e 3b20 6220 2b3d 206b 2920 7b0a 2020   n; b += k) {.  
+00096950: 2020 2020 2020 626c 6f63 6b5f 7134 5f31        block_q4_1
+00096960: 202a 2072 6573 7472 6963 7420 7920 3d20   * restrict y = 
+00096970: 2862 6c6f 636b 5f71 345f 3120 2a29 2064  (block_q4_1 *) d
+00096980: 7374 202b 2062 2f51 4b34 5f31 3b0a 0a20  st + b/QK4_1;.. 
+00096990: 2020 2020 2020 2071 7561 6e74 697a 655f         quantize_
+000969a0: 726f 775f 7134 5f31 5f72 6566 6572 656e  row_q4_1_referen
+000969b0: 6365 2873 7263 202b 2062 2c20 792c 206b  ce(src + b, y, k
+000969c0: 293b 0a0a 2020 2020 2020 2020 666f 7220  );..        for 
+000969d0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+000969e0: 6e62 3b20 692b 2b29 207b 0a20 2020 2020  nb; i++) {.     
+000969f0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00096a00: 6a20 3d20 303b 206a 203c 2051 4b34 5f31  j = 0; j < QK4_1
+00096a10: 3b20 6a20 2b3d 2032 2920 7b0a 2020 2020  ; j += 2) {.    
+00096a20: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00096a30: 7420 7569 6e74 385f 7420 7669 3020 3d20  t uint8_t vi0 = 
+00096a40: 795b 695d 2e71 735b 6a2f 325d 2026 2030  y[i].qs[j/2] & 0
+00096a50: 7830 463b 0a20 2020 2020 2020 2020 2020  x0F;.           
+00096a60: 2020 2020 2063 6f6e 7374 2075 696e 7438       const uint8
+00096a70: 5f74 2076 6931 203d 2079 5b69 5d2e 7173  _t vi1 = y[i].qs
+00096a80: 5b6a 2f32 5d20 3e3e 2034 3b0a 0a20 2020  [j/2] >> 4;..   
+00096a90: 2020 2020 2020 2020 2020 2020 2068 6973               his
+00096aa0: 745b 7669 305d 2b2b 3b0a 2020 2020 2020  t[vi0]++;.      
+00096ab0: 2020 2020 2020 2020 2020 6869 7374 5b76            hist[v
+00096ac0: 6931 5d2b 2b3b 0a20 2020 2020 2020 2020  i1]++;.         
+00096ad0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
+00096ae0: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
+00096af0: 2028 6e2f 514b 345f 312a 7369 7a65 6f66   (n/QK4_1*sizeof
+00096b00: 2862 6c6f 636b 5f71 345f 3129 293b 0a7d  (block_q4_1));.}
+00096b10: 0a0a 7369 7a65 5f74 2067 676d 6c5f 7175  ..size_t ggml_qu
+00096b20: 616e 7469 7a65 5f71 355f 3028 636f 6e73  antize_q5_0(cons
+00096b30: 7420 666c 6f61 7420 2a20 7372 632c 2076  t float * src, v
+00096b40: 6f69 6420 2a20 6473 742c 2069 6e74 206e  oid * dst, int n
+00096b50: 2c20 696e 7420 6b2c 2069 6e74 3634 5f74  , int k, int64_t
+00096b60: 202a 2068 6973 7429 207b 0a20 2020 2061   * hist) {.    a
+00096b70: 7373 6572 7428 6b20 2520 514b 355f 3020  ssert(k % QK5_0 
+00096b80: 3d3d 2030 293b 0a20 2020 2063 6f6e 7374  == 0);.    const
+00096b90: 2069 6e74 206e 6220 3d20 6b20 2f20 514b   int nb = k / QK
+00096ba0: 355f 303b 0a0a 2020 2020 666f 7220 2869  5_0;..    for (i
+00096bb0: 6e74 2062 203d 2030 3b20 6220 3c20 6e3b  nt b = 0; b < n;
+00096bc0: 2062 202b 3d20 6b29 207b 0a20 2020 2020   b += k) {.     
+00096bd0: 2020 2062 6c6f 636b 5f71 355f 3020 2a20     block_q5_0 * 
+00096be0: 7265 7374 7269 6374 2079 203d 2028 626c  restrict y = (bl
+00096bf0: 6f63 6b5f 7135 5f30 202a 2964 7374 202b  ock_q5_0 *)dst +
+00096c00: 2062 2f51 4b35 5f30 3b0a 0a20 2020 2020   b/QK5_0;..     
+00096c10: 2020 2071 7561 6e74 697a 655f 726f 775f     quantize_row_
+00096c20: 7135 5f30 5f72 6566 6572 656e 6365 2873  q5_0_reference(s
+00096c30: 7263 202b 2062 2c20 792c 206b 293b 0a0a  rc + b, y, k);..
+00096c40: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00096c50: 2069 203d 2030 3b20 6920 3c20 6e62 3b20   i = 0; i < nb; 
+00096c60: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
+00096c70: 2020 2075 696e 7433 325f 7420 7168 3b0a     uint32_t qh;.
+00096c80: 2020 2020 2020 2020 2020 2020 6d65 6d63              memc
+00096c90: 7079 2826 7168 2c20 2679 5b69 5d2e 7168  py(&qh, &y[i].qh
+00096ca0: 2c20 7369 7a65 6f66 2871 6829 293b 0a0a  , sizeof(qh));..
+00096cb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00096cc0: 2869 6e74 206a 203d 2030 3b20 6a20 3c20  (int j = 0; j < 
+00096cd0: 514b 355f 303b 206a 202b 3d20 3229 207b  QK5_0; j += 2) {
+00096ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00096cf0: 2063 6f6e 7374 2075 696e 7438 5f74 2076   const uint8_t v
+00096d00: 6830 203d 2028 2871 6820 2620 2831 7520  h0 = ((qh & (1u 
+00096d10: 3c3c 2028 6a20 2b20 3020 2929 2920 3e3e  << (j + 0 ))) >>
+00096d20: 2028 6a20 2b20 3020 2929 203c 3c20 343b   (j + 0 )) << 4;
+00096d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00096d40: 2063 6f6e 7374 2075 696e 7438 5f74 2076   const uint8_t v
+00096d50: 6831 203d 2028 2871 6820 2620 2831 7520  h1 = ((qh & (1u 
+00096d60: 3c3c 2028 6a20 2b20 3136 2929 2920 3e3e  << (j + 16))) >>
+00096d70: 2028 6a20 2b20 3132 2929 3b0a 0a20 2020   (j + 12));..   
+00096d80: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00096d90: 6361 7374 2074 6f20 3136 2062 696e 730a  cast to 16 bins.
+00096da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00096db0: 636f 6e73 7420 7569 6e74 385f 7420 7669  const uint8_t vi
+00096dc0: 3020 3d20 2828 795b 695d 2e71 735b 6a2f  0 = ((y[i].qs[j/
+00096dd0: 325d 2026 2030 7830 4629 207c 2076 6830  2] & 0x0F) | vh0
+00096de0: 2920 2f20 323b 0a20 2020 2020 2020 2020  ) / 2;.         
+00096df0: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+00096e00: 7438 5f74 2076 6931 203d 2028 2879 5b69  t8_t vi1 = ((y[i
+00096e10: 5d2e 7173 5b6a 2f32 5d20 3e3e 2020 2034  ].qs[j/2] >>   4
+00096e20: 2920 7c20 7668 3129 202f 2032 3b0a 0a20  ) | vh1) / 2;.. 
+00096e30: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00096e40: 6973 745b 7669 305d 2b2b 3b0a 2020 2020  ist[vi0]++;.    
+00096e50: 2020 2020 2020 2020 2020 2020 6869 7374              hist
+00096e60: 5b76 6931 5d2b 2b3b 0a20 2020 2020 2020  [vi1]++;.       
+00096e70: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00096e80: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
+00096e90: 726e 2028 6e2f 514b 355f 302a 7369 7a65  rn (n/QK5_0*size
+00096ea0: 6f66 2862 6c6f 636b 5f71 355f 3029 293b  of(block_q5_0));
+00096eb0: 0a7d 0a0a 7369 7a65 5f74 2067 676d 6c5f  .}..size_t ggml_
+00096ec0: 7175 616e 7469 7a65 5f71 355f 3128 636f  quantize_q5_1(co
+00096ed0: 6e73 7420 666c 6f61 7420 2a20 7372 632c  nst float * src,
+00096ee0: 2076 6f69 6420 2a20 6473 742c 2069 6e74   void * dst, int
+00096ef0: 206e 2c20 696e 7420 6b2c 2069 6e74 3634   n, int k, int64
+00096f00: 5f74 202a 2068 6973 7429 207b 0a20 2020  _t * hist) {.   
+00096f10: 2061 7373 6572 7428 6b20 2520 514b 355f   assert(k % QK5_
+00096f20: 3120 3d3d 2030 293b 0a20 2020 2063 6f6e  1 == 0);.    con
+00096f30: 7374 2069 6e74 206e 6220 3d20 6b20 2f20  st int nb = k / 
+00096f40: 514b 355f 313b 0a0a 2020 2020 666f 7220  QK5_1;..    for 
+00096f50: 2869 6e74 2062 203d 2030 3b20 6220 3c20  (int b = 0; b < 
+00096f60: 6e3b 2062 202b 3d20 6b29 207b 0a20 2020  n; b += k) {.   
+00096f70: 2020 2020 2062 6c6f 636b 5f71 355f 3120       block_q5_1 
+00096f80: 2a20 7265 7374 7269 6374 2079 203d 2028  * restrict y = (
+00096f90: 626c 6f63 6b5f 7135 5f31 202a 2964 7374  block_q5_1 *)dst
+00096fa0: 202b 2062 2f51 4b35 5f31 3b0a 0a20 2020   + b/QK5_1;..   
+00096fb0: 2020 2020 2071 7561 6e74 697a 655f 726f       quantize_ro
+00096fc0: 775f 7135 5f31 5f72 6566 6572 656e 6365  w_q5_1_reference
+00096fd0: 2873 7263 202b 2062 2c20 792c 206b 293b  (src + b, y, k);
+00096fe0: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
+00096ff0: 6e74 2069 203d 2030 3b20 6920 3c20 6e62  nt i = 0; i < nb
+00097000: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+00097010: 2020 2020 2075 696e 7433 325f 7420 7168       uint32_t qh
+00097020: 3b0a 2020 2020 2020 2020 2020 2020 6d65  ;.            me
+00097030: 6d63 7079 2826 7168 2c20 2679 5b69 5d2e  mcpy(&qh, &y[i].
+00097040: 7168 2c20 7369 7a65 6f66 2871 6829 293b  qh, sizeof(qh));
+00097050: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00097060: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+00097070: 3c20 514b 355f 313b 206a 202b 3d20 3229  < QK5_1; j += 2)
+00097080: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00097090: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
+000970a0: 2076 6830 203d 2028 2871 6820 2620 2831   vh0 = ((qh & (1
+000970b0: 7520 3c3c 2028 6a20 2b20 3020 2929 2920  u << (j + 0 ))) 
+000970c0: 3e3e 2028 6a20 2b20 3020 2929 203c 3c20  >> (j + 0 )) << 
+000970d0: 343b 0a20 2020 2020 2020 2020 2020 2020  4;.             
+000970e0: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
+000970f0: 2076 6831 203d 2028 2871 6820 2620 2831   vh1 = ((qh & (1
+00097100: 7520 3c3c 2028 6a20 2b20 3136 2929 2920  u << (j + 16))) 
+00097110: 3e3e 2028 6a20 2b20 3132 2929 3b0a 0a20  >> (j + 12));.. 
+00097120: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00097130: 2f20 6361 7374 2074 6f20 3136 2062 696e  / cast to 16 bin
+00097140: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00097150: 2020 636f 6e73 7420 7569 6e74 385f 7420    const uint8_t 
+00097160: 7669 3020 3d20 2828 795b 695d 2e71 735b  vi0 = ((y[i].qs[
+00097170: 6a2f 325d 2026 2030 7830 4629 207c 2076  j/2] & 0x0F) | v
+00097180: 6830 2920 2f20 323b 0a20 2020 2020 2020  h0) / 2;.       
+00097190: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+000971a0: 696e 7438 5f74 2076 6931 203d 2028 2879  int8_t vi1 = ((y
+000971b0: 5b69 5d2e 7173 5b6a 2f32 5d20 3e3e 2020  [i].qs[j/2] >>  
+000971c0: 2034 2920 7c20 7668 3129 202f 2032 3b0a   4) | vh1) / 2;.
+000971d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000971e0: 2068 6973 745b 7669 305d 2b2b 3b0a 2020   hist[vi0]++;.  
+000971f0: 2020 2020 2020 2020 2020 2020 2020 6869                hi
+00097200: 7374 5b76 6931 5d2b 2b3b 0a20 2020 2020  st[vi1]++;.     
+00097210: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00097220: 207d 0a20 2020 207d 0a0a 2020 2020 7265   }.    }..    re
+00097230: 7475 726e 2028 6e2f 514b 355f 312a 7369  turn (n/QK5_1*si
+00097240: 7a65 6f66 2862 6c6f 636b 5f71 355f 3129  zeof(block_q5_1)
+00097250: 293b 0a7d 0a0a 7369 7a65 5f74 2067 676d  );.}..size_t ggm
+00097260: 6c5f 7175 616e 7469 7a65 5f71 385f 3028  l_quantize_q8_0(
+00097270: 636f 6e73 7420 666c 6f61 7420 2a20 7372  const float * sr
+00097280: 632c 2076 6f69 6420 2a20 6473 742c 2069  c, void * dst, i
+00097290: 6e74 206e 2c20 696e 7420 6b2c 2069 6e74  nt n, int k, int
+000972a0: 3634 5f74 202a 2068 6973 7429 207b 0a20  64_t * hist) {. 
+000972b0: 2020 2061 7373 6572 7428 6b20 2520 514b     assert(k % QK
+000972c0: 385f 3020 3d3d 2030 293b 0a20 2020 2063  8_0 == 0);.    c
+000972d0: 6f6e 7374 2069 6e74 206e 6220 3d20 6b20  onst int nb = k 
+000972e0: 2f20 514b 385f 303b 0a0a 2020 2020 666f  / QK8_0;..    fo
+000972f0: 7220 2869 6e74 2062 203d 2030 3b20 6220  r (int b = 0; b 
+00097300: 3c20 6e3b 2062 202b 3d20 6b29 207b 0a20  < n; b += k) {. 
+00097310: 2020 2020 2020 2062 6c6f 636b 5f71 385f         block_q8_
+00097320: 3020 2a20 7265 7374 7269 6374 2079 203d  0 * restrict y =
+00097330: 2028 626c 6f63 6b5f 7138 5f30 202a 2964   (block_q8_0 *)d
+00097340: 7374 202b 2062 2f51 4b38 5f30 3b0a 0a20  st + b/QK8_0;.. 
+00097350: 2020 2020 2020 2071 7561 6e74 697a 655f         quantize_
+00097360: 726f 775f 7138 5f30 5f72 6566 6572 656e  row_q8_0_referen
+00097370: 6365 2873 7263 202b 2062 2c20 792c 206b  ce(src + b, y, k
+00097380: 293b 0a0a 2020 2020 2020 2020 666f 7220  );..        for 
+00097390: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+000973a0: 6e62 3b20 692b 2b29 207b 0a20 2020 2020  nb; i++) {.     
+000973b0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+000973c0: 6a20 3d20 303b 206a 203c 2051 4b38 5f30  j = 0; j < QK8_0
+000973d0: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
+000973e0: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+000973f0: 6e74 385f 7420 7669 203d 2079 5b69 5d2e  nt8_t vi = y[i].
+00097400: 7173 5b6a 5d3b 0a0a 2020 2020 2020 2020  qs[j];..        
+00097410: 2020 2020 2020 2020 6869 7374 5b76 692f          hist[vi/
+00097420: 3136 202b 2038 5d2b 2b3b 0a20 2020 2020  16 + 8]++;.     
+00097430: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00097440: 207d 0a20 2020 207d 0a0a 2020 2020 7265   }.    }..    re
+00097450: 7475 726e 2028 6e2f 514b 385f 302a 7369  turn (n/QK8_0*si
+00097460: 7a65 6f66 2862 6c6f 636b 5f71 385f 3029  zeof(block_q8_0)
+00097470: 293b 0a7d 0a0a 7369 7a65 5f74 2067 676d  );.}..size_t ggm
+00097480: 6c5f 7175 616e 7469 7a65 5f63 6875 6e6b  l_quantize_chunk
+00097490: 2865 6e75 6d20 6767 6d6c 5f74 7970 6520  (enum ggml_type 
+000974a0: 7479 7065 2c20 636f 6e73 7420 666c 6f61  type, const floa
+000974b0: 7420 2a20 7372 632c 2076 6f69 6420 2a20  t * src, void * 
+000974c0: 6473 742c 2069 6e74 2073 7461 7274 2c20  dst, int start, 
+000974d0: 696e 7420 6e2c 2069 6e74 3634 5f74 202a  int n, int64_t *
+000974e0: 2068 6973 7429 207b 0a20 2020 2073 697a   hist) {.    siz
+000974f0: 655f 7420 7265 7375 6c74 203d 2030 3b0a  e_t result = 0;.
+00097500: 2020 2020 7377 6974 6368 2028 7479 7065      switch (type
+00097510: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+00097520: 2047 474d 4c5f 5459 5045 5f51 345f 303a   GGML_TYPE_Q4_0:
+00097530: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00097540: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00097550: 474d 4c5f 4153 5345 5254 2873 7461 7274  GML_ASSERT(start
+00097560: 2025 2051 4b34 5f30 203d 3d20 3029 3b0a   % QK4_0 == 0);.
+00097570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00097580: 626c 6f63 6b5f 7134 5f30 202a 2062 6c6f  block_q4_0 * blo
+00097590: 636b 203d 2028 626c 6f63 6b5f 7134 5f30  ck = (block_q4_0
+000975a0: 2a29 6473 7420 2b20 7374 6172 7420 2f20  *)dst + start / 
+000975b0: 514b 345f 303b 0a20 2020 2020 2020 2020  QK4_0;.         
+000975c0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+000975d0: 6767 6d6c 5f71 7561 6e74 697a 655f 7134  ggml_quantize_q4
+000975e0: 5f30 2873 7263 202b 2073 7461 7274 2c20  _0(src + start, 
+000975f0: 626c 6f63 6b2c 206e 2c20 6e2c 2068 6973  block, n, n, his
+00097600: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00097610: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00097620: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00097630: 5134 5f31 3a0a 2020 2020 2020 2020 2020  Q4_1:.          
+00097640: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00097650: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00097660: 7374 6172 7420 2520 514b 345f 3120 3d3d  start % QK4_1 ==
+00097670: 2030 293b 0a20 2020 2020 2020 2020 2020   0);.           
+00097680: 2020 2020 2062 6c6f 636b 5f71 345f 3120       block_q4_1 
+00097690: 2a20 626c 6f63 6b20 3d20 2862 6c6f 636b  * block = (block
+000976a0: 5f71 345f 312a 2964 7374 202b 2073 7461  _q4_1*)dst + sta
+000976b0: 7274 202f 2051 4b34 5f31 3b0a 2020 2020  rt / QK4_1;.    
+000976c0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+000976d0: 6c74 203d 2067 676d 6c5f 7175 616e 7469  lt = ggml_quanti
+000976e0: 7a65 5f71 345f 3128 7372 6320 2b20 7374  ze_q4_1(src + st
+000976f0: 6172 742c 2062 6c6f 636b 2c20 6e2c 206e  art, block, n, n
+00097700: 2c20 6869 7374 293b 0a20 2020 2020 2020  , hist);.       
+00097710: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00097720: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00097730: 5459 5045 5f51 355f 303a 0a20 2020 2020  TYPE_Q5_0:.     
+00097740: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00097750: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00097760: 5345 5254 2873 7461 7274 2025 2051 4b35  SERT(start % QK5
+00097770: 5f30 203d 3d20 3029 3b0a 2020 2020 2020  _0 == 0);.      
+00097780: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
+00097790: 7135 5f30 202a 2062 6c6f 636b 203d 2028  q5_0 * block = (
+000977a0: 626c 6f63 6b5f 7135 5f30 2a29 6473 7420  block_q5_0*)dst 
+000977b0: 2b20 7374 6172 7420 2f20 514b 355f 303b  + start / QK5_0;
+000977c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000977d0: 2072 6573 756c 7420 3d20 6767 6d6c 5f71   result = ggml_q
+000977e0: 7561 6e74 697a 655f 7135 5f30 2873 7263  uantize_q5_0(src
+000977f0: 202b 2073 7461 7274 2c20 626c 6f63 6b2c   + start, block,
+00097800: 206e 2c20 6e2c 2068 6973 7429 3b0a 2020   n, n, hist);.  
+00097810: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00097820: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00097830: 4747 4d4c 5f54 5950 455f 5135 5f31 3a0a  GGML_TYPE_Q5_1:.
+00097840: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00097850: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00097860: 4d4c 5f41 5353 4552 5428 7374 6172 7420  ML_ASSERT(start 
+00097870: 2520 514b 355f 3120 3d3d 2030 293b 0a20  % QK5_1 == 0);. 
+00097880: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00097890: 6c6f 636b 5f71 355f 3120 2a20 626c 6f63  lock_q5_1 * bloc
+000978a0: 6b20 3d20 2862 6c6f 636b 5f71 355f 312a  k = (block_q5_1*
+000978b0: 2964 7374 202b 2073 7461 7274 202f 2051  )dst + start / Q
+000978c0: 4b35 5f31 3b0a 2020 2020 2020 2020 2020  K5_1;.          
+000978d0: 2020 2020 2020 7265 7375 6c74 203d 2067        result = g
+000978e0: 676d 6c5f 7175 616e 7469 7a65 5f71 355f  gml_quantize_q5_
+000978f0: 3128 7372 6320 2b20 7374 6172 742c 2062  1(src + start, b
+00097900: 6c6f 636b 2c20 6e2c 206e 2c20 6869 7374  lock, n, n, hist
+00097910: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00097920: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00097930: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+00097940: 385f 303a 0a20 2020 2020 2020 2020 2020  8_0:.           
+00097950: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00097960: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
+00097970: 7461 7274 2025 2051 4b38 5f30 203d 3d20  tart % QK8_0 == 
+00097980: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
+00097990: 2020 2020 626c 6f63 6b5f 7138 5f30 202a      block_q8_0 *
+000979a0: 2062 6c6f 636b 203d 2028 626c 6f63 6b5f   block = (block_
+000979b0: 7138 5f30 2a29 6473 7420 2b20 7374 6172  q8_0*)dst + star
+000979c0: 7420 2f20 514b 385f 303b 0a20 2020 2020  t / QK8_0;.     
+000979d0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+000979e0: 7420 3d20 6767 6d6c 5f71 7561 6e74 697a  t = ggml_quantiz
+000979f0: 655f 7138 5f30 2873 7263 202b 2073 7461  e_q8_0(src + sta
+00097a00: 7274 2c20 626c 6f63 6b2c 206e 2c20 6e2c  rt, block, n, n,
+00097a10: 2068 6973 7429 3b0a 2020 2020 2020 2020   hist);.        
+00097a20: 2020 2020 7d20 6272 6561 6b3b 0a23 6966      } break;.#if
+00097a30: 6465 6620 4747 4d4c 5f55 5345 5f4b 5f51  def GGML_USE_K_Q
+00097a40: 5541 4e54 530a 2020 2020 2020 2020 6361  UANTS.        ca
+00097a50: 7365 2047 474d 4c5f 5459 5045 5f51 325f  se GGML_TYPE_Q2_
+00097a60: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
+00097a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00097a80: 2047 474d 4c5f 4153 5345 5254 2873 7461   GGML_ASSERT(sta
+00097a90: 7274 2025 2051 4b5f 4b20 3d3d 2030 293b  rt % QK_K == 0);
+00097aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00097ab0: 2062 6c6f 636b 5f71 325f 4b20 2a20 626c   block_q2_K * bl
+00097ac0: 6f63 6b20 3d20 2862 6c6f 636b 5f71 325f  ock = (block_q2_
+00097ad0: 4b2a 2964 7374 202b 2073 7461 7274 202f  K*)dst + start /
+00097ae0: 2051 4b5f 4b3b 0a20 2020 2020 2020 2020   QK_K;.         
+00097af0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00097b00: 6767 6d6c 5f71 7561 6e74 697a 655f 7132  ggml_quantize_q2
+00097b10: 5f4b 2873 7263 202b 2073 7461 7274 2c20  _K(src + start, 
+00097b20: 626c 6f63 6b2c 206e 2c20 6e2c 2068 6973  block, n, n, his
+00097b30: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00097b40: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00097b50: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00097b60: 5133 5f4b 3a0a 2020 2020 2020 2020 2020  Q3_K:.          
+00097b70: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00097b80: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00097b90: 7374 6172 7420 2520 514b 5f4b 203d 3d20  start % QK_K == 
+00097ba0: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
+00097bb0: 2020 2020 626c 6f63 6b5f 7133 5f4b 202a      block_q3_K *
+00097bc0: 2062 6c6f 636b 203d 2028 626c 6f63 6b5f   block = (block_
+00097bd0: 7133 5f4b 2a29 6473 7420 2b20 7374 6172  q3_K*)dst + star
+00097be0: 7420 2f20 514b 5f4b 3b0a 2020 2020 2020  t / QK_K;.      
+00097bf0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00097c00: 203d 2067 676d 6c5f 7175 616e 7469 7a65   = ggml_quantize
+00097c10: 5f71 335f 4b28 7372 6320 2b20 7374 6172  _q3_K(src + star
+00097c20: 742c 2062 6c6f 636b 2c20 6e2c 206e 2c20  t, block, n, n, 
+00097c30: 6869 7374 293b 0a20 2020 2020 2020 2020  hist);.         
+00097c40: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00097c50: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00097c60: 5045 5f51 345f 4b3a 0a20 2020 2020 2020  PE_Q4_K:.       
+00097c70: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00097c80: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00097c90: 5254 2873 7461 7274 2025 2051 4b5f 4b20  RT(start % QK_K 
+00097ca0: 3d3d 2030 293b 0a20 2020 2020 2020 2020  == 0);.         
+00097cb0: 2020 2020 2020 2062 6c6f 636b 5f71 345f         block_q4_
+00097cc0: 4b20 2a20 626c 6f63 6b20 3d20 2862 6c6f  K * block = (blo
+00097cd0: 636b 5f71 345f 4b2a 2964 7374 202b 2073  ck_q4_K*)dst + s
+00097ce0: 7461 7274 202f 2051 4b5f 4b3b 0a20 2020  tart / QK_K;.   
+00097cf0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00097d00: 756c 7420 3d20 6767 6d6c 5f71 7561 6e74  ult = ggml_quant
+00097d10: 697a 655f 7134 5f4b 2873 7263 202b 2073  ize_q4_K(src + s
+00097d20: 7461 7274 2c20 626c 6f63 6b2c 206e 2c20  tart, block, n, 
+00097d30: 6e2c 2068 6973 7429 3b0a 2020 2020 2020  n, hist);.      
+00097d40: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00097d50: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00097d60: 5f54 5950 455f 5135 5f4b 3a0a 2020 2020  _TYPE_Q5_K:.    
+00097d70: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00097d80: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00097d90: 5353 4552 5428 7374 6172 7420 2520 514b  SSERT(start % QK
+00097da0: 5f4b 203d 3d20 3029 3b0a 2020 2020 2020  _K == 0);.      
+00097db0: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
+00097dc0: 7135 5f4b 202a 2062 6c6f 636b 203d 2028  q5_K * block = (
+00097dd0: 626c 6f63 6b5f 7135 5f4b 2a29 6473 7420  block_q5_K*)dst 
+00097de0: 2b20 7374 6172 7420 2f20 514b 5f4b 3b0a  + start / QK_K;.
+00097df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00097e00: 7265 7375 6c74 203d 2067 676d 6c5f 7175  result = ggml_qu
+00097e10: 616e 7469 7a65 5f71 355f 4b28 7372 6320  antize_q5_K(src 
+00097e20: 2b20 7374 6172 742c 2062 6c6f 636b 2c20  + start, block, 
+00097e30: 6e2c 206e 2c20 6869 7374 293b 0a20 2020  n, n, hist);.   
+00097e40: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00097e50: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00097e60: 474d 4c5f 5459 5045 5f51 365f 4b3a 0a20  GML_TYPE_Q6_K:. 
+00097e70: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00097e80: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00097e90: 4c5f 4153 5345 5254 2873 7461 7274 2025  L_ASSERT(start %
+00097ea0: 2051 4b5f 4b20 3d3d 2030 293b 0a20 2020   QK_K == 0);.   
+00097eb0: 2020 2020 2020 2020 2020 2020 2062 6c6f               blo
+00097ec0: 636b 5f71 365f 4b20 2a20 626c 6f63 6b20  ck_q6_K * block 
+00097ed0: 3d20 2862 6c6f 636b 5f71 365f 4b2a 2964  = (block_q6_K*)d
+00097ee0: 7374 202b 2073 7461 7274 202f 2051 4b5f  st + start / QK_
+00097ef0: 4b3b 0a20 2020 2020 2020 2020 2020 2020  K;.             
+00097f00: 2020 2072 6573 756c 7420 3d20 6767 6d6c     result = ggml
+00097f10: 5f71 7561 6e74 697a 655f 7136 5f4b 2873  _quantize_q6_K(s
+00097f20: 7263 202b 2073 7461 7274 2c20 626c 6f63  rc + start, bloc
+00097f30: 6b2c 206e 2c20 6e2c 2068 6973 7429 3b0a  k, n, n, hist);.
+00097f40: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00097f50: 6561 6b3b 0a23 656e 6469 660a 2020 2020  eak;.#endif.    
+00097f60: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00097f70: 5045 5f46 3136 3a0a 2020 2020 2020 2020  PE_F16:.        
+00097f80: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00097f90: 2020 2020 2020 696e 7420 656c 656d 7369        int elemsi
+00097fa0: 7a65 203d 2073 697a 656f 6628 6767 6d6c  ze = sizeof(ggml
+00097fb0: 5f66 7031 365f 7429 3b0a 2020 2020 2020  _fp16_t);.      
+00097fc0: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
+00097fd0: 7033 325f 746f 5f66 7031 365f 726f 7728  p32_to_fp16_row(
+00097fe0: 7372 6320 2b20 7374 6172 742c 2028 6767  src + start, (gg
+00097ff0: 6d6c 5f66 7031 365f 7420 2a29 6473 7420  ml_fp16_t *)dst 
+00098000: 2b20 7374 6172 742c 206e 293b 0a20 2020  + start, n);.   
+00098010: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00098020: 756c 7420 3d20 6e20 2a20 656c 656d 7369  ult = n * elemsi
+00098030: 7a65 3b0a 2020 2020 2020 2020 2020 2020  ze;.            
+00098040: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00098050: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00098060: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
+00098070: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00098080: 2020 2069 6e74 2065 6c65 6d73 697a 6520     int elemsize 
+00098090: 3d20 7369 7a65 6f66 2866 6c6f 6174 293b  = sizeof(float);
+000980a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000980b0: 2072 6573 756c 7420 3d20 6e20 2a20 656c   result = n * el
+000980c0: 656d 7369 7a65 3b0a 2020 2020 2020 2020  emsize;.        
+000980d0: 2020 2020 2020 2020 6d65 6d63 7079 2828          memcpy((
+000980e0: 7569 6e74 385f 7420 2a29 6473 7420 2b20  uint8_t *)dst + 
+000980f0: 7374 6172 7420 2a20 656c 656d 7369 7a65  start * elemsize
+00098100: 2c20 7372 6320 2b20 7374 6172 742c 2072  , src + start, r
+00098110: 6573 756c 7429 3b0a 2020 2020 2020 2020  esult);.        
+00098120: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00098130: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
+00098140: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00098150: 2866 616c 7365 293b 0a20 2020 207d 0a20  (false);.    }. 
+00098160: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00098170: 3b0a 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f  ;.}..///////////
+00098180: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00098190: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000981a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000981b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000981c0: 2f2f 2f2f 2f0a 0a69 6e74 2067 676d 6c5f  /////..int ggml_
+000981d0: 6370 755f 6861 735f 6176 7828 766f 6964  cpu_has_avx(void
+000981e0: 2920 7b0a 2369 6620 6465 6669 6e65 6428  ) {.#if defined(
+000981f0: 5f5f 4156 585f 5f29 0a20 2020 2072 6574  __AVX__).    ret
+00098200: 7572 6e20 313b 0a23 656c 7365 0a20 2020  urn 1;.#else.   
+00098210: 2072 6574 7572 6e20 303b 0a23 656e 6469   return 0;.#endi
+00098220: 660a 7d0a 0a69 6e74 2067 676d 6c5f 6370  f.}..int ggml_cp
+00098230: 755f 6861 735f 6176 7832 2876 6f69 6429  u_has_avx2(void)
+00098240: 207b 0a23 6966 2064 6566 696e 6564 285f   {.#if defined(_
+00098250: 5f41 5658 325f 5f29 0a20 2020 2072 6574  _AVX2__).    ret
+00098260: 7572 6e20 313b 0a23 656c 7365 0a20 2020  urn 1;.#else.   
+00098270: 2072 6574 7572 6e20 303b 0a23 656e 6469   return 0;.#endi
+00098280: 660a 7d0a 0a69 6e74 2067 676d 6c5f 6370  f.}..int ggml_cp
+00098290: 755f 6861 735f 6176 7835 3132 2876 6f69  u_has_avx512(voi
+000982a0: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
+000982b0: 285f 5f41 5658 3531 3246 5f5f 290a 2020  (__AVX512F__).  
+000982c0: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
+000982d0: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
+000982e0: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
+000982f0: 6d6c 5f63 7075 5f68 6173 5f61 7678 3531  ml_cpu_has_avx51
+00098300: 325f 7662 6d69 2876 6f69 6429 207b 0a23  2_vbmi(void) {.#
+00098310: 6966 2064 6566 696e 6564 285f 5f41 5658  if defined(__AVX
+00098320: 3531 3256 424d 495f 5f29 0a20 2020 2072  512VBMI__).    r
+00098330: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
+00098340: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
+00098350: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
+00098360: 6370 755f 6861 735f 6176 7835 3132 5f76  cpu_has_avx512_v
+00098370: 6e6e 6928 766f 6964 2920 7b0a 2369 6620  nni(void) {.#if 
+00098380: 6465 6669 6e65 6428 5f5f 4156 5835 3132  defined(__AVX512
+00098390: 564e 4e49 5f5f 290a 2020 2020 7265 7475  VNNI__).    retu
+000983a0: 726e 2031 3b0a 2365 6c73 650a 2020 2020  rn 1;.#else.    
+000983b0: 7265 7475 726e 2030 3b0a 2365 6e64 6966  return 0;.#endif
+000983c0: 0a7d 0a0a 696e 7420 6767 6d6c 5f63 7075  .}..int ggml_cpu
+000983d0: 5f68 6173 5f66 6d61 2876 6f69 6429 207b  _has_fma(void) {
+000983e0: 0a23 6966 2064 6566 696e 6564 285f 5f46  .#if defined(__F
+000983f0: 4d41 5f5f 290a 2020 2020 7265 7475 726e  MA__).    return
+00098400: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
+00098410: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
+00098420: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
+00098430: 6173 5f6e 656f 6e28 766f 6964 2920 7b0a  as_neon(void) {.
+00098440: 2369 6620 6465 6669 6e65 6428 5f5f 4152  #if defined(__AR
+00098450: 4d5f 4e45 4f4e 290a 2020 2020 7265 7475  M_NEON).    retu
+00098460: 726e 2031 3b0a 2365 6c73 650a 2020 2020  rn 1;.#else.    
+00098470: 7265 7475 726e 2030 3b0a 2365 6e64 6966  return 0;.#endif
+00098480: 0a7d 0a0a 696e 7420 6767 6d6c 5f63 7075  .}..int ggml_cpu
+00098490: 5f68 6173 5f61 726d 5f66 6d61 2876 6f69  _has_arm_fma(voi
+000984a0: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
+000984b0: 285f 5f41 524d 5f46 4541 5455 5245 5f46  (__ARM_FEATURE_F
+000984c0: 4d41 290a 2020 2020 7265 7475 726e 2031  MA).    return 1
+000984d0: 3b0a 2365 6c73 650a 2020 2020 7265 7475  ;.#else.    retu
+000984e0: 726e 2030 3b0a 2365 6e64 6966 0a7d 0a0a  rn 0;.#endif.}..
+000984f0: 696e 7420 6767 6d6c 5f63 7075 5f68 6173  int ggml_cpu_has
+00098500: 5f66 3136 6328 766f 6964 2920 7b0a 2369  _f16c(void) {.#i
+00098510: 6620 6465 6669 6e65 6428 5f5f 4631 3643  f defined(__F16C
+00098520: 5f5f 290a 2020 2020 7265 7475 726e 2031  __).    return 1
+00098530: 3b0a 2365 6c73 650a 2020 2020 7265 7475  ;.#else.    retu
+00098540: 726e 2030 3b0a 2365 6e64 6966 0a7d 0a0a  rn 0;.#endif.}..
+00098550: 696e 7420 6767 6d6c 5f63 7075 5f68 6173  int ggml_cpu_has
+00098560: 5f66 7031 365f 7661 2876 6f69 6429 207b  _fp16_va(void) {
+00098570: 0a23 6966 2064 6566 696e 6564 285f 5f41  .#if defined(__A
+00098580: 524d 5f46 4541 5455 5245 5f46 5031 365f  RM_FEATURE_FP16_
+00098590: 5645 4354 4f52 5f41 5249 5448 4d45 5449  VECTOR_ARITHMETI
+000985a0: 4329 0a20 2020 2072 6574 7572 6e20 313b  C).    return 1;
+000985b0: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
+000985c0: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
+000985d0: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+000985e0: 7761 736d 5f73 696d 6428 766f 6964 2920  wasm_simd(void) 
+000985f0: 7b0a 2369 6620 6465 6669 6e65 6428 5f5f  {.#if defined(__
+00098600: 7761 736d 5f73 696d 6431 3238 5f5f 290a  wasm_simd128__).
+00098610: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
+00098620: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
+00098630: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
+00098640: 6767 6d6c 5f63 7075 5f68 6173 5f62 6c61  ggml_cpu_has_bla
+00098650: 7328 766f 6964 2920 7b0a 2369 6620 6465  s(void) {.#if de
+00098660: 6669 6e65 6428 4747 4d4c 5f55 5345 5f41  fined(GGML_USE_A
+00098670: 4343 454c 4552 4154 4529 207c 7c20 6465  CCELERATE) || de
+00098680: 6669 6e65 6428 4747 4d4c 5f55 5345 5f4f  fined(GGML_USE_O
+00098690: 5045 4e42 4c41 5329 207c 7c20 6465 6669  PENBLAS) || defi
+000986a0: 6e65 6428 4747 4d4c 5f55 5345 5f43 5542  ned(GGML_USE_CUB
+000986b0: 4c41 5329 207c 7c20 6465 6669 6e65 6428  LAS) || defined(
+000986c0: 4747 4d4c 5f55 5345 5f43 4c42 4c41 5354  GGML_USE_CLBLAST
+000986d0: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
+000986e0: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
+000986f0: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
+00098700: 7420 6767 6d6c 5f63 7075 5f68 6173 5f63  t ggml_cpu_has_c
+00098710: 7562 6c61 7328 766f 6964 2920 7b0a 2369  ublas(void) {.#i
+00098720: 6620 6465 6669 6e65 6428 4747 4d4c 5f55  f defined(GGML_U
+00098730: 5345 5f43 5542 4c41 5329 0a20 2020 2072  SE_CUBLAS).    r
+00098740: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
+00098750: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
+00098760: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
+00098770: 6370 755f 6861 735f 636c 626c 6173 7428  cpu_has_clblast(
+00098780: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
+00098790: 6e65 6428 4747 4d4c 5f55 5345 5f43 4c42  ned(GGML_USE_CLB
+000987a0: 4c41 5354 290a 2020 2020 7265 7475 726e  LAST).    return
+000987b0: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
+000987c0: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
+000987d0: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
+000987e0: 6173 5f67 7075 626c 6173 2876 6f69 6429  as_gpublas(void)
+000987f0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
+00098800: 6d6c 5f63 7075 5f68 6173 5f63 7562 6c61  ml_cpu_has_cubla
+00098810: 7328 2920 7c7c 2067 676d 6c5f 6370 755f  s() || ggml_cpu_
+00098820: 6861 735f 636c 626c 6173 7428 293b 0a7d  has_clblast();.}
+00098830: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
+00098840: 6173 5f73 7365 3328 766f 6964 2920 7b0a  as_sse3(void) {.
+00098850: 2369 6620 6465 6669 6e65 6428 5f5f 5353  #if defined(__SS
+00098860: 4533 5f5f 290a 2020 2020 7265 7475 726e  E3__).    return
+00098870: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
+00098880: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
+00098890: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
+000988a0: 6173 5f76 7378 2876 6f69 6429 207b 0a23  as_vsx(void) {.#
+000988b0: 6966 2064 6566 696e 6564 285f 5f50 4f57  if defined(__POW
+000988c0: 4552 395f 5645 4354 4f52 5f5f 290a 2020  ER9_VECTOR__).  
+000988d0: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
+000988e0: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
+000988f0: 2365 6e64 6966 0a7d 0a0a 2f2f 2f2f 2f2f  #endif.}..//////
+00098900: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00098910: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00098920: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00098930: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00098940: 2f2f 2f2f 2f2f 2f2f 2f2f 0a              //////////.
```

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/CMakeLists.txt` & `ggml-python-0.0.8/vendor/ggml-cpy/tests/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-blas0.c` & `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-blas0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-grad0.c` & `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-grad0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-mul-mat0.c` & `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-mul-mat1.c` & `ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-mul-mat2.c` & `ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-opt.c` & `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-opt.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-svd0.c` & `ggml-python-0.0.8/vendor/ggml/tests/test-svd0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-vec0.c` & `ggml-python-0.0.8/vendor/ggml/tests/test-vec0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-vec1.c` & `ggml-python-0.0.8/vendor/ggml/tests/test-vec1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test-vec2.c` & `ggml-python-0.0.8/vendor/ggml/tests/test-vec2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test0.c` & `ggml-python-0.0.8/vendor/ggml/tests/test0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test0.zig` & `ggml-python-0.0.8/vendor/ggml-cpy/tests/test0.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test1.c` & `ggml-python-0.0.8/vendor/ggml-cpy/tests/test1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test1.zig` & `ggml-python-0.0.8/vendor/ggml-cpy/tests/test1.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test2.c` & `ggml-python-0.0.8/vendor/ggml/tests/test2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/vendor/ggml/tests/test3.c` & `ggml-python-0.0.8/vendor/ggml/tests/test3.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.7/PKG-INFO` & `ggml-python-0.0.8/PKG-INFO`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ggml-python
-Version: 0.0.7
+Version: 0.0.8
 Summary: Python bindings for ggml
 Author-Email: Andrei Betlen <abetlen@gmail.com>
 License: MIT
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
@@ -15,14 +15,16 @@
 Requires-Python: >=3.7
 Requires-Dist: numpy>=1.20.0
 Requires-Dist: typing_extensions>=4.6.3
 Requires-Dist: pytest; extra == "test"
 Requires-Dist: mkdocs; extra == "docs"
 Requires-Dist: mkdocstrings[python]; extra == "docs"
 Requires-Dist: mkdocs-material; extra == "docs"
+Requires-Dist: pillow; extra == "docs"
+Requires-Dist: cairosvg; extra == "docs"
 Requires-Dist: accelerate==0.19.0; extra == "convert"
 Requires-Dist: numpy==1.24.3; extra == "convert"
 Requires-Dist: sentencepiece==0.1.98; extra == "convert"
 Requires-Dist: torch==2.0.1; extra == "convert"
 Requires-Dist: torchaudio==2.0.2; extra == "convert"
 Requires-Dist: torchvision==0.15.2; extra == "convert"
 Requires-Dist: transformers==4.29.2; extra == "convert"
@@ -41,14 +43,20 @@
 [![PyPI - Downloads](https://img.shields.io/pypi/dm/ggml-python)](https://pypi.org/project/ggml-python/)
 
 
 Python bindings for the [`ggml`](https://github.com/ggerganov/ggml) tensor library for machine learning.
 
 > **⚠️ This project is in a very early state and currently only offers the basic low-level bindings to ggml**
 
+# Documentation
+
+- [Getting Started](https://ggml-python.readthedocs.io/en/latest/)
+- [API Reference](https://ggml-python.readthedocs.io/en/latest/api-reference/)
+- [Examples](https://github.com/abetlen/ggml-python/tree/main/examples)
+
 # Installation
 
 
 Requirements
 - Python 3.7+
 - C compiler (gcc, clang, msvc, etc)
```

